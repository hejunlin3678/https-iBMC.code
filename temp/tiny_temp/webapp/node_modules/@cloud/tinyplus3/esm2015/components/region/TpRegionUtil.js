import { TiLocale, Util } from '@cloud/tiny3';
import { CfUtil } from '../../cfutils/CfUtil';
/**
 * 提供了转化数据的方法，可以将特定的不可用的数据转化为[TpRegionComponent]{@link ../components/TpRegionComponent.html}的可用数据
 */
export class TpRegionUtil {
    static getRegionList(regionArr) {
        let result = [];
        if (!Util.isArray(regionArr)) {
            return result;
        }
        const isSmallItem = TiLocale.getLocaleWords().tpRegionSmallItem;
        result = isSmallItem ? this.processCTCData(regionArr) : TpRegionUtil.processHWSData(regionArr);
        return result;
    }
    /**
     * 在对象数组中，查找某一个对象，可以模糊匹配，返回其索引
     */
    static findIndex(arr, target) {
        if (!Util.isArray(arr)) {
            return -1;
        }
        let result;
        for (const item of arr) {
            const itemKey = Object.keys(item);
            const targetKey = Object.keys(target);
            let flag = true;
            for (const key of targetKey) {
                if (itemKey.indexOf(key) === -1 || target[key] !== item[key]) {
                    flag = false;
                }
            }
            if (flag) {
                result = arr.indexOf(item);
                break;
            }
        }
        if (result === undefined) {
            result = -1;
        }
        return result;
    }
    /**
     * 类似于findIndex，返回最后一个模糊匹配元素的索引
     */
    static findLastIndex(arr, item) {
        if (!Util.isArray(arr)) {
            return -1;
        }
        const originalArr = arr;
        const reservedArr = arr.reverse();
        const index = TpRegionUtil.findIndex(reservedArr, item);
        if (index === -1) {
            return -1;
        }
        else {
            return originalArr.indexOf(reservedArr[index]);
        }
    }
    static processHWSData(regionArr) {
        let result = [];
        for (let region of regionArr) {
            // 过滤掉属性isAlliance 或 isSelfDevelop为true的region
            if (region.isAlliance || region.isSelfDevelop) {
                continue;
            }
            const index = TpRegionUtil.findLastIndex(result, { displayName: region.geoCategory }); // 判断已处理数据中有无该大区
            const key = region.geoArea === '31' ? 'special' : 'regions'; // 当geoArea为31时，则表示当前项属于亚太区下需要做特殊处理
            // result中没有该大区时：大区名称和id都取geoCategory；存放各区域的属性为special/regions，为数组类型，直接将当前项push到该数组中
            if (index === -1) {
                let itemObj = {
                    displayName: region.geoCategory
                };
                itemObj[key] = [];
                itemObj[key].push(region);
                result.push(itemObj);
                continue;
            }
            // result中有该大区时：判断存放当前项的属性为special/regions是否存在，如果不存在则令该属性为空数组，存在直接将当前项push到该数组中
            if (Util.isUndefined(result[index][key])) {
                result[index][key] = [];
            }
            result[index][key].push(region);
            CfUtil.getUser()
                .then((user) => {
                const isNonsupportRegionFn = CfUtil.isNonsupportRegion();
                if (typeof isNonsupportRegionFn === 'function') {
                    region.disabled = isNonsupportRegionFn(user.nonsupportRegions, region.regionId, user.supportRegions);
                }
            });
        }
        return result;
    }
    static processCTCData(regionArr) {
        // ctc下的数据，由组件装配成A-G, H-K, L-S, T-Z四个大区，先定义四个大区对象，循环传入参数，装入四个对象
        let result = [
            { displayName: 'A-G', regions: [] },
            { displayName: 'H-K', regions: [] },
            { displayName: 'L-S', regions: [] },
            { displayName: 'T-Z', regions: [] }
        ];
        regionArr.forEach((region) => {
            if (!region.shortName) {
                return;
            }
            if (region.shortName.charCodeAt(0) >= 65 && region.shortName.charCodeAt(0) <= 71
                || region.shortName.charCodeAt(0) >= 97 && region.shortName.charCodeAt(0) <= 103) {
                TpRegionUtil.pushRegion(result[0].regions, region);
            }
            else if (region.shortName.charCodeAt(0) >= 72 && region.shortName.charCodeAt(0) <= 75
                || region.shortName.charCodeAt(0) >= 104 && region.shortName.charCodeAt(0) <= 107) {
                TpRegionUtil.pushRegion(result[1].regions, region);
            }
            else if (region.shortName.charCodeAt(0) >= 76 && region.shortName.charCodeAt(0) <= 83
                || region.shortName.charCodeAt(0) >= 108 && region.shortName.charCodeAt(0) <= 115) {
                TpRegionUtil.pushRegion(result[2].regions, region);
            }
            else if (region.shortName.charCodeAt(0) >= 84 && region.shortName.charCodeAt(0) <= 90
                || region.shortName.charCodeAt(0) >= 116 && region.shortName.charCodeAt(0) <= 122) {
                TpRegionUtil.pushRegion(result[3].regions, region);
            }
        });
        return result;
    }
    static pushRegion(regions, region) {
        const index = regions.findIndex((item) => item.displayName === region.ascription);
        if (index > -1) {
            regions[index].project.push(region);
        }
        else {
            const regionObj = {
                displayName: region.ascription,
                project: [region]
            };
            regions.push(regionObj);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBSZWdpb25VdGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnlwbHVzMy9jb21wb25lbnRzL3JlZ2lvbi9UcFJlZ2lvblV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFOUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRzlDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLFlBQVk7SUFDZCxNQUFNLENBQUMsYUFBYSxDQUFDLFNBQXFCO1FBQzdDLElBQUksTUFBTSxHQUF3QixFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDMUIsT0FBTyxNQUFNLENBQUM7U0FDakI7UUFDRCxNQUFNLFdBQVcsR0FBWSxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsaUJBQWlCLENBQUM7UUFDekUsTUFBTSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUUvRixPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBQ0Q7O09BRUc7SUFDSyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQWUsRUFBRSxNQUFXO1FBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3BCLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDYjtRQUNELElBQUksTUFBVyxDQUFDO1FBQ2hCLEtBQUssTUFBTSxJQUFJLElBQUksR0FBRyxFQUFFO1lBQ3BCLE1BQU0sT0FBTyxHQUFrQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2pELE1BQU0sU0FBUyxHQUFrQixN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QyxDQUFDLENBQUMsSUFBSSxHQUFHLEVBQUU7Z0JBQ25GLFlBQVksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQzthQUN0RDtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVPLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBNEIsRUFBRSxNQUFXO1FBQy9ELE1BQU0sS0FBSyxHQUFXLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFrQixFQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxLQUFLLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNqSCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsRUFBRTtZQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZDO2FBQU07WUFDSCxNQUFNLFNBQVMsR0FBaUI7Z0JBQzVCLFdBQVcsRUFBRSxNQUFNLENBQUMsVUFBVTtnQkFDOUIsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDO2FBQ3BCLENBQUM7WUFDRixPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQzNCO0lBQ0wsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGlMb2NhbGUsIFV0aWwgfSBmcm9tICdAY2xvdWQvdGlueTMnO1xyXG5cclxuaW1wb3J0IHsgQ2ZVdGlsIH0gZnJvbSAnLi4vLi4vY2Z1dGlscy9DZlV0aWwnO1xyXG5cclxuaW1wb3J0IHsgVHBSZWdpb25JdGVtIH0gZnJvbSAnLi9UcFJlZ2lvbkNvbXBvbmVudCc7XHJcbi8qKlxyXG4gKiDmj5DkvpvkuobovazljJbmlbDmja7nmoTmlrnms5XvvIzlj6/ku6XlsIbnibnlrprnmoTkuI3lj6/nlKjnmoTmlbDmja7ovazljJbkuLpbVHBSZWdpb25Db21wb25lbnRde0BsaW5rIC4uL2NvbXBvbmVudHMvVHBSZWdpb25Db21wb25lbnQuaHRtbH3nmoTlj6/nlKjmlbDmja5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBUcFJlZ2lvblV0aWwge1xyXG4gICAgcHVibGljIHN0YXRpYyBnZXRSZWdpb25MaXN0KHJlZ2lvbkFycjogQXJyYXk8YW55Pik6IEFycmF5PFRwUmVnaW9uSXRlbT4ge1xyXG4gICAgICAgIGxldCByZXN1bHQ6IEFycmF5PFRwUmVnaW9uSXRlbT4gPSBbXTtcclxuICAgICAgICBpZiAoIVV0aWwuaXNBcnJheShyZWdpb25BcnIpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGlzU21hbGxJdGVtOiBib29sZWFuID0gVGlMb2NhbGUuZ2V0TG9jYWxlV29yZHMoKS50cFJlZ2lvblNtYWxsSXRlbTtcclxuICAgICAgICByZXN1bHQgPSBpc1NtYWxsSXRlbSA/IHRoaXMucHJvY2Vzc0NUQ0RhdGEocmVnaW9uQXJyKSA6IFRwUmVnaW9uVXRpbC5wcm9jZXNzSFdTRGF0YShyZWdpb25BcnIpO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDlnKjlr7nosaHmlbDnu4TkuK3vvIzmn6Xmib7mn5DkuIDkuKrlr7nosaHvvIzlj6/ku6XmqKHns4rljLnphY3vvIzov5Tlm57lhbbntKLlvJVcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZmluZEluZGV4KGFycjogQXJyYXk8YW55PiwgdGFyZ2V0OiBhbnkpOiBudW1iZXIge1xyXG4gICAgICAgIGlmICghVXRpbC5pc0FycmF5KGFycikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcmVzdWx0OiBhbnk7XHJcbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGFycikge1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtS2V5OiBBcnJheTxzdHJpbmc+ID0gT2JqZWN0LmtleXMoaXRlbSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldEtleTogQXJyYXk8c3RyaW5nPiA9IE9iamVjdC5rZXlzKHRhcmdldCk7XHJcbiAgICAgICAgICAgIGxldCBmbGFnOiBib29sZWFuID0gdHJ1ZTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgdGFyZ2V0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbUtleS5pbmRleE9mKGtleSkgPT09IC0xIHx8IHRhcmdldFtrZXldICE9PSBpdGVtW2tleV0pIHtcclxuICAgICAgICAgICAgICAgICAgICBmbGFnID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGZsYWcpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGFyci5pbmRleE9mKGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXN1bHQgPSAtMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOexu+S8vOS6jmZpbmRJbmRleO+8jOi/lOWbnuacgOWQjuS4gOS4quaooeeziuWMuemFjeWFg+e0oOeahOe0ouW8lVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyBmaW5kTGFzdEluZGV4KGFycjogYW55LCBpdGVtOiBhbnkpIHtcclxuICAgICAgICBpZiAoIVV0aWwuaXNBcnJheShhcnIpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxBcnI6IEFycmF5PGFueT4gPSBhcnI7XHJcbiAgICAgICAgY29uc3QgcmVzZXJ2ZWRBcnI6IEFycmF5PGFueT4gPSBhcnIucmV2ZXJzZSgpO1xyXG4gICAgICAgIGNvbnN0IGluZGV4OiBudW1iZXIgPSBUcFJlZ2lvblV0aWwuZmluZEluZGV4KHJlc2VydmVkQXJyLCBpdGVtKTtcclxuICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxBcnIuaW5kZXhPZihyZXNlcnZlZEFycltpbmRleF0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHN0YXRpYyBwcm9jZXNzSFdTRGF0YShyZWdpb25BcnIpOiBBcnJheTxUcFJlZ2lvbkl0ZW0+IHtcclxuICAgICAgICBsZXQgcmVzdWx0OiBBcnJheTxUcFJlZ2lvbkl0ZW0+ID0gW107XHJcblxyXG4gICAgICAgIGZvciAobGV0IHJlZ2lvbiBvZiByZWdpb25BcnIpIHtcclxuICAgICAgICAgICAgLy8g6L+H5ruk5o6J5bGe5oCnaXNBbGxpYW5jZSDmiJYgaXNTZWxmRGV2ZWxvcOS4unRydWXnmoRyZWdpb25cclxuICAgICAgICAgICAgaWYgKHJlZ2lvbi5pc0FsbGlhbmNlIHx8IHJlZ2lvbi5pc1NlbGZEZXZlbG9wKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBpbmRleDogbnVtYmVyID0gVHBSZWdpb25VdGlsLmZpbmRMYXN0SW5kZXgocmVzdWx0LCB7ZGlzcGxheU5hbWU6IHJlZ2lvbi5nZW9DYXRlZ29yeX0pOyAvLyDliKTmlq3lt7LlpITnkIbmlbDmja7kuK3mnInml6Dor6XlpKfljLpcclxuICAgICAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSByZWdpb24uZ2VvQXJlYSA9PT0gJzMxJyA/ICdzcGVjaWFsJyA6ICdyZWdpb25zJzsgLy8g5b2TZ2VvQXJlYeS4ujMx5pe277yM5YiZ6KGo56S65b2T5YmN6aG55bGe5LqO5Lqa5aSq5Yy65LiL6ZyA6KaB5YGa54m55q6K5aSE55CGXHJcblxyXG4gICAgICAgICAgICAvLyByZXN1bHTkuK3msqHmnInor6XlpKfljLrml7bvvJrlpKfljLrlkI3np7DlkoxpZOmDveWPlmdlb0NhdGVnb3J577yb5a2Y5pS+5ZCE5Yy65Z+f55qE5bGe5oCn5Li6c3BlY2lhbC9yZWdpb25z77yM5Li65pWw57uE57G75Z6L77yM55u05o6l5bCG5b2T5YmN6aG5cHVzaOWIsOivpeaVsOe7hOS4rVxyXG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaXRlbU9iajogVHBSZWdpb25JdGVtID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiByZWdpb24uZ2VvQ2F0ZWdvcnlcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBpdGVtT2JqW2tleV0gPSBbXTtcclxuICAgICAgICAgICAgICAgIGl0ZW1PYmpba2V5XS5wdXNoKHJlZ2lvbik7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtT2JqKTtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyByZXN1bHTkuK3mnInor6XlpKfljLrml7bvvJrliKTmlq3lrZjmlL7lvZPliY3pobnnmoTlsZ7mgKfkuLpzcGVjaWFsL3JlZ2lvbnPmmK/lkKblrZjlnKjvvIzlpoLmnpzkuI3lrZjlnKjliJnku6Tor6XlsZ7mgKfkuLrnqbrmlbDnu4TvvIzlrZjlnKjnm7TmjqXlsIblvZPliY3poblwdXNo5Yiw6K+l5pWw57uE5LitXHJcbiAgICAgICAgICAgIGlmIChVdGlsLmlzVW5kZWZpbmVkKHJlc3VsdFtpbmRleF1ba2V5XSkpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdFtpbmRleF1ba2V5XSA9IFtdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXN1bHRbaW5kZXhdW2tleV0ucHVzaChyZWdpb24pO1xyXG5cclxuICAgICAgICAgICAgQ2ZVdGlsLmdldFVzZXIoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHVzZXI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaXNOb25zdXBwb3J0UmVnaW9uRm46IChub25zdXBwb3J0UmVnaW9uczogYW55LCByZWdpb25JZDogYW55LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdXBwb3J0UmVnaW9uczogYW55KSA9PiBib29sZWFuID0gQ2ZVdGlsLmlzTm9uc3VwcG9ydFJlZ2lvbigpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpc05vbnN1cHBvcnRSZWdpb25GbiA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlZ2lvbi5kaXNhYmxlZCA9IGlzTm9uc3VwcG9ydFJlZ2lvbkZuKHVzZXIubm9uc3VwcG9ydFJlZ2lvbnMsIHJlZ2lvbi5yZWdpb25JZCwgdXNlci5zdXBwb3J0UmVnaW9ucyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBwcm9jZXNzQ1RDRGF0YShyZWdpb25BcnIpOiBBcnJheTxUcFJlZ2lvbkl0ZW0+IHtcclxuICAgICAgICAvLyBjdGPkuIvnmoTmlbDmja7vvIznlLHnu4Tku7boo4XphY3miJBBLUcsIEgtSywgTC1TLCBULVrlm5vkuKrlpKfljLrvvIzlhYjlrprkuYnlm5vkuKrlpKfljLrlr7nosaHvvIzlvqrnjq/kvKDlhaXlj4LmlbDvvIzoo4XlhaXlm5vkuKrlr7nosaFcclxuICAgICAgICBsZXQgcmVzdWx0OiBBcnJheTxUcFJlZ2lvbkl0ZW0+ID0gW1xyXG4gICAgICAgICAgICB7ZGlzcGxheU5hbWU6ICdBLUcnLCByZWdpb25zOiBbXX0sXHJcbiAgICAgICAgICAgIHtkaXNwbGF5TmFtZTogJ0gtSycsIHJlZ2lvbnM6IFtdfSxcclxuICAgICAgICAgICAge2Rpc3BsYXlOYW1lOiAnTC1TJywgcmVnaW9uczogW119LFxyXG4gICAgICAgICAgICB7ZGlzcGxheU5hbWU6ICdULVonLCByZWdpb25zOiBbXX1cclxuICAgICAgICBdO1xyXG5cclxuICAgICAgICByZWdpb25BcnIuZm9yRWFjaCgocmVnaW9uOiB7c2hvcnROYW1lOiBzdHJpbmd9KTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIGlmICghcmVnaW9uLnNob3J0TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChyZWdpb24uc2hvcnROYW1lLmNoYXJDb2RlQXQoMCkgPj0gNjUgJiYgcmVnaW9uLnNob3J0TmFtZS5jaGFyQ29kZUF0KDApIDw9IDcxXHJcbiAgICAgICAgICAgICAgICB8fCByZWdpb24uc2hvcnROYW1lLmNoYXJDb2RlQXQoMCkgPj0gOTcgJiYgcmVnaW9uLnNob3J0TmFtZS5jaGFyQ29kZUF0KDApIDw9IDEwMykge1xyXG4gICAgICAgICAgICAgICAgICAgIFRwUmVnaW9uVXRpbC5wdXNoUmVnaW9uKHJlc3VsdFswXS5yZWdpb25zLCByZWdpb24pO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlZ2lvbi5zaG9ydE5hbWUuY2hhckNvZGVBdCgwKSA+PSA3MiAmJiByZWdpb24uc2hvcnROYW1lLmNoYXJDb2RlQXQoMCkgPD0gNzVcclxuICAgICAgICAgICAgICAgIHx8IHJlZ2lvbi5zaG9ydE5hbWUuY2hhckNvZGVBdCgwKSA+PSAxMDQgJiYgcmVnaW9uLnNob3J0TmFtZS5jaGFyQ29kZUF0KDApIDw9IDEwNykge1xyXG4gICAgICAgICAgICAgICAgVHBSZWdpb25VdGlsLnB1c2hSZWdpb24ocmVzdWx0WzFdLnJlZ2lvbnMsIHJlZ2lvbik7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVnaW9uLnNob3J0TmFtZS5jaGFyQ29kZUF0KDApID49IDc2ICYmIHJlZ2lvbi5zaG9ydE5hbWUuY2hhckNvZGVBdCgwKSA8PSA4M1xyXG4gICAgICAgICAgICAgICAgfHwgcmVnaW9uLnNob3J0TmFtZS5jaGFyQ29kZUF0KDApID49IDEwOCAmJiByZWdpb24uc2hvcnROYW1lLmNoYXJDb2RlQXQoMCkgPD0gMTE1KSB7XHJcbiAgICAgICAgICAgICAgICBUcFJlZ2lvblV0aWwucHVzaFJlZ2lvbihyZXN1bHRbMl0ucmVnaW9ucywgcmVnaW9uKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChyZWdpb24uc2hvcnROYW1lLmNoYXJDb2RlQXQoMCkgPj0gODQgJiYgcmVnaW9uLnNob3J0TmFtZS5jaGFyQ29kZUF0KDApIDw9IDkwXHJcbiAgICAgICAgICAgICAgICB8fCByZWdpb24uc2hvcnROYW1lLmNoYXJDb2RlQXQoMCkgPj0gMTE2ICYmIHJlZ2lvbi5zaG9ydE5hbWUuY2hhckNvZGVBdCgwKSA8PSAxMjIpIHtcclxuICAgICAgICAgICAgICAgIFRwUmVnaW9uVXRpbC5wdXNoUmVnaW9uKHJlc3VsdFszXS5yZWdpb25zLCByZWdpb24pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcHVzaFJlZ2lvbihyZWdpb25zOiBBcnJheTxUcFJlZ2lvbkl0ZW0+LCByZWdpb246IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGluZGV4OiBudW1iZXIgPSByZWdpb25zLmZpbmRJbmRleCgoaXRlbTogVHBSZWdpb25JdGVtKTogYm9vbGVhbiA9PiBpdGVtLmRpc3BsYXlOYW1lID09PSByZWdpb24uYXNjcmlwdGlvbik7XHJcbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcclxuICAgICAgICAgICAgcmVnaW9uc1tpbmRleF0ucHJvamVjdC5wdXNoKHJlZ2lvbik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgcmVnaW9uT2JqOiBUcFJlZ2lvbkl0ZW0gPSB7XHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogcmVnaW9uLmFzY3JpcHRpb24sXHJcbiAgICAgICAgICAgICAgICBwcm9qZWN0OiBbcmVnaW9uXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByZWdpb25zLnB1c2gocmVnaW9uT2JqKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==