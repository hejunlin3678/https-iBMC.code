import { Component, ContentChild, ElementRef, EventEmitter, Input, NgZone, Output, Renderer2, TemplateRef } from '@angular/core';
import { TiBaseComponent, TiLocale, TiPopupService, TiPosition, TiValidators } from '@cloud/tiny3';
import { TpRenameModalContainerComponent } from './TpRenameModalContainerComponent';
import { TpRenameModalComponent } from './TpRenameModalComponent';
/**
 * 名称编辑组件
 *
 * <example-url>../tinyplus3demo/#/rename/rename-all</example-url>
 */
export class TpRenameComponent extends TiBaseComponent {
    constructor(hostRef, renderer2, tiPopup, zone) {
        super(hostRef, renderer2);
        this.hostRef = hostRef;
        this.renderer2 = renderer2;
        this.tiPopup = tiPopup;
        this.zone = zone;
        /**
         * 标识该行数据是否为new
         */
        this.isNew = false;
        /**
         * 组件是否可用
         */
        this.disabled = false;
        /**
         * @ignore
         * 铅笔图标的tip提示信息方位，10.0.1版本起该接口隐藏
         */
        this.iconTipPosition = 'top';
        /**
         * 10.0.1新增
         *
         * 图标的title属性，用于说明图标的作用
         */
        this.iconTitle = TiLocale.getLocaleWords().tpRename.tip;
        /**
         * 10.0.3新增
         *
         * 是否通过组件显示被编辑的内容，组件以文本的形式显示，默认显示
         */
        this.showValue = true;
        /**
         * 确认/OK按钮点击事件，参数：输入框的内容
         */
        this.confirm = new EventEmitter();
        /**
         * 确认/OK按钮点击事件，为开发者提供关闭弹窗的时机
         *
         * 参数：弹窗实例[TpRenameModalRef]{@link ../interfaces/TpRenameModalRef.html}
         */
        this.beforeClose = new EventEmitter();
        this.hostSpace = 5; // 弹窗距rename的距离
        this.DeterminePosition = (layout) => {
            if (layout.avilableLayout.bottom >= layout.targetLayout.height + this.hostSpace) {
                return 'bottom-left';
            }
            else {
                return 'top-left';
            }
        };
        this.findClosestTD = (ele) => {
            if (ele.nodeName === 'HTML') {
                return undefined;
            }
            else if (ele.parentNode.nodeName === 'TD') {
                return ele.parentNode;
            }
            else {
                return this.findClosestTD(ele.parentNode);
            }
        };
        this.defaultModalHeader = TiLocale.getLocaleWords().tpRename.modalHeader;
    }
    ngOnInit() {
        super.ngOnInit();
        this.iconTitle = this.iconTip ? '' : this.iconTitle;
    }
    /**
     * @ignore
     */
    onClick() {
        if (this.disabled) {
            return;
        }
        // 初始create一次即可，多次点击编辑图标避免重复生成的逻辑，在popupService内部已有处理
        if (!this.renameModal) {
            this.renameModal = this.tiPopup.create(TpRenameModalContainerComponent);
        }
        // open modal
        this.TpRenameModalComponentRef = this.renameModal.show({
            content: this.customModal || TpRenameModalComponent,
            contentContext: this.customModal ?
                {
                    renameModal: this.renameModal,
                    value: this.value
                } : {
                value: this.value,
                id: this.id + '_renameModal',
                modalHeader: this.modalHeader || this.defaultModalHeader,
                close: (form) => {
                    // 因为非常明确该组件只有一个表单元素 校验结果定义为error而不是errors，直接通过input获取校验失败的元素
                    const error = TiValidators.check(form);
                    if (error) {
                        this.TpRenameModalComponentRef.location.nativeElement.querySelector('input')
                            .focus();
                    }
                    else {
                        this.beforeClose.emit(this.renameModal);
                        this.confirm.emit(this.TpRenameModalComponentRef.location.nativeElement.querySelector('input').value);
                        // tslint:disable-next-line: no-unused-expression
                        this.destroyRenameModal();
                    }
                },
                dismiss: () => {
                    this.destroyRenameModal();
                }
            },
            container: 'body'
        });
        const modal = this.TpRenameModalComponentRef.location.nativeElement;
        this.renderer2.setStyle(modal, 'left', '-9999px');
        this.renderer2.setStyle(modal, 'top', '-9999px');
        const td = this.findClosestTD(this.hostRef.nativeElement);
        TiPosition.setPosition({
            targetEle: modal,
            hostEle: this.hostRef.nativeElement,
            hostEleX: td || this.hostRef.nativeElement,
            hOffset: td ? 10 : 0,
            hostSpace: this.hostSpace,
            fixMaxHeight: true,
            determinPositionFn: this.DeterminePosition
        });
        this.addDocumentClickEvent();
    }
    addDocumentClickEvent() {
        this.zone.runOutsideAngular(() => {
            this.unlistenDocumentClick = this.renderer2.listen(document, 'click', (event) => {
                // 编辑图标被点击，触发其绑定的click事件，这里不做处理。
                if (this.hostRef.nativeElement.contains(event.target)) {
                    return;
                }
                if (this.TpRenameModalComponentRef) {
                    const tpRenameModalHostElement = this.TpRenameModalComponentRef.location.nativeElement;
                    // renameModal之外的元素被点击，销毁renameModal
                    if (!(tpRenameModalHostElement && tpRenameModalHostElement.contains(event.target))) {
                        this.zone.run(() => {
                            this.destroyRenameModal();
                        });
                    }
                }
            });
        });
    }
    // 销毁弹窗、取消document的click事件
    destroyRenameModal() {
        // tslint:disable-next-line: no-unused-expression
        this.renameModal && this.renameModal.hide();
        if (this.unlistenDocumentClick) {
            this.unlistenDocumentClick();
        }
    }
    // tslint:disable-next-line: use-life-cycle-interface
    ngOnDestroy() {
        super.ngOnDestroy();
        this.destroyRenameModal();
    }
}
TpRenameComponent.decorators = [
    { type: Component, args: [{
                selector: 'tp-rename',
                template: "<ti-cell-text [id]=\"appendId('value')\" *ngIf=\"showValue\">{{value}}</ti-cell-text>\r\n<ti-cell-icons class=\"tp-rename-icon-container\"\r\n    [ngClass]=\"{'tp-rename-icon-container-isnew': isNew}\">\r\n    <tp-icon local\r\n        name=\"cloud-action-edit\"\r\n        class=\"editor-icon\"\r\n        [ngClass]=\"{'tp-rename-icon-disabled': disabled}\"\r\n        [tiTip]=\"iconTip\"\r\n        [tiTipPosition]=\"iconTipPosition\"\r\n        [title]=\"iconTitle\"\r\n        (click)=\"onClick()\"\r\n        [id]=\"appendId('editor')\"></tp-icon>\r\n    <tp-icon *ngIf=\"isNew\" local name=\"cloud-message-new\" class=\"new-icon\"></tp-icon>\r\n</ti-cell-icons>",
                styles: [".tp-rename-icon-container{line-height:1;padding-left:8px;padding-left:var(--ti-common-space-2x);position:relative;vertical-align:bottom}.tp-rename-icon-container .editor-icon{color:var(--ti-common-color-text-primary);display:inline-block;font-size:16px;width:16px}.tp-rename-icon-container .editor-icon.tp-rename-icon-disabled{color:var(--ti-common-color-icon-disabled);cursor:not-allowed}.tp-rename-icon-container .editor-icon:hover:not(.tp-rename-icon-disabled){color:var(--ti-common-color-icon-hover);cursor:pointer}.tp-rename-icon-container .new-icon{color:var(--ti-common-color-warn);font-size:12px;left:var(--ti-common-space-2x);position:absolute;top:0}ti-table tr :host .tp-rename-icon-container .editor-icon{visibility:hidden}ti-table tr:hover :host .tp-rename-icon-container .editor-icon{visibility:visible}ti-table tr:hover :host .tp-rename-icon-container-isnew .new-icon{visibility:hidden}:host ::ng-deep .ti3-cell-text-container .ti3-cell-text{vertical-align:bottom}"]
            },] }
];
TpRenameComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: TiPopupService },
    { type: NgZone }
];
TpRenameComponent.propDecorators = {
    value: [{ type: Input }],
    isNew: [{ type: Input }],
    disabled: [{ type: Input }],
    modalHeader: [{ type: Input }],
    iconTip: [{ type: Input }],
    iconTipPosition: [{ type: Input }],
    iconTitle: [{ type: Input }],
    showValue: [{ type: Input }],
    confirm: [{ type: Output }],
    beforeClose: [{ type: Output }],
    customModal: [{ type: ContentChild, args: ['renameModal', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBSZW5hbWVDb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueXBsdXMzL2NvbXBvbmVudHMvcmVuYW1lL1RwUmVuYW1lQ29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFHLE1BQU0sRUFBRyxNQUFNLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuSSxPQUFPLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBYyxjQUFjLEVBQUUsVUFBVSxFQUFrQixZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFL0gsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDcEYsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFXbEU7Ozs7R0FJRztBQU9ILE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxlQUFlO0lBQ2xELFlBQ2MsT0FBbUIsRUFDbkIsU0FBb0IsRUFDdEIsT0FBNEIsRUFDNUIsSUFBWTtRQUVwQixLQUFLLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBTGhCLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFDbkIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUN0QixZQUFPLEdBQVAsT0FBTyxDQUFxQjtRQUM1QixTQUFJLEdBQUosSUFBSSxDQUFRO1FBU3hCOztXQUVHO1FBQ00sVUFBSyxHQUFZLEtBQUssQ0FBQztRQUNoQzs7V0FFRztRQUNNLGFBQVEsR0FBWSxLQUFLLENBQUM7UUFZbkM7OztXQUdHO1FBQ00sb0JBQWUsR0FBbUIsS0FBSyxDQUFDO1FBQ2pEOzs7O1dBSUc7UUFDTSxjQUFTLEdBQVcsUUFBUSxDQUFDLGNBQWMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7UUFDcEU7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QUNQLFFBQVEsRUFBRSxXQUFXO2dCQUNyQix1cUJBQTRCOzthQUUvQjs7O1lBekJpQyxVQUFVO1lBQXlDLFNBQVM7WUFFOUMsY0FBYztZQUZNLE1BQU07OztvQkF3Q3JFLEtBQUs7b0JBSUwsS0FBSzt1QkFJTCxLQUFLOzBCQUlMLEtBQUs7c0JBT0wsS0FBSzs4QkFLTCxLQUFLO3dCQU1MLEtBQUs7d0JBTUwsS0FBSztzQkFJTCxNQUFNOzBCQU1OLE1BQU07MEJBS04sWUFBWSxTQUFDLGFBQWEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENvbnRlbnRDaGlsZCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgIE5nWm9uZSwgIE91dHB1dCwgUmVuZGVyZXIyLCBUZW1wbGF0ZVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGb3JtR3JvdXAsIFZhbGlkYXRpb25FcnJvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IFRpQmFzZUNvbXBvbmVudCwgVGlMb2NhbGUsIFRpUG9wVXBSZWYsIFRpUG9wdXBTZXJ2aWNlLCBUaVBvc2l0aW9uLCBUaVBvc2l0aW9uVHlwZSwgVGlWYWxpZGF0b3JzIH0gZnJvbSAnQGNsb3VkL3RpbnkzJztcclxuXHJcbmltcG9ydCB7IFRwUmVuYW1lTW9kYWxDb250YWluZXJDb21wb25lbnQgfSBmcm9tICcuL1RwUmVuYW1lTW9kYWxDb250YWluZXJDb21wb25lbnQnO1xyXG5pbXBvcnQgeyBUcFJlbmFtZU1vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi9UcFJlbmFtZU1vZGFsQ29tcG9uZW50JztcclxuXHJcbi8qKlxyXG4gKiByZW5hbWXnu4Tku7bnlJ/kuqfnmoTlvLnnqpflrp7kvovvvIzmj5DkvptoaWRlKCnmlrnms5XvvIznlKjkuo7lhbPpl63lvLnnqpdcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHBSZW5hbWVNb2RhbFJlZiB7XHJcbiAgICAvKipcclxuICAgICAqIOWFs+mXreW8ueeql+eahOaWueazlVxyXG4gICAgICovXHJcbiAgICBoaWRlKCk6IHZvaWQ7XHJcbn1cclxuLyoqXHJcbiAqIOWQjeensOe8lui+kee7hOS7tlxyXG4gKlxyXG4gKiA8ZXhhbXBsZS11cmw+Li4vdGlueXBsdXMzZGVtby8jL3JlbmFtZS9yZW5hbWUtYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICd0cC1yZW5hbWUnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL3JlbmFtZS5odG1sJyxcclxuICAgIHN0eWxlVXJsczogWycuL3JlbmFtZS5sZXNzJ11cclxufSlcclxuXHJcbmV4cG9ydCBjbGFzcyBUcFJlbmFtZUNvbXBvbmVudCBleHRlbmRzIFRpQmFzZUNvbXBvbmVudCB7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcm90ZWN0ZWQgaG9zdFJlZjogRWxlbWVudFJlZixcclxuICAgICAgICBwcm90ZWN0ZWQgcmVuZGVyZXIyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgcHJpdmF0ZSB0aVBvcHVwOiBUaVBvcHVwU2VydmljZTxhbnk+LFxyXG4gICAgICAgIHByaXZhdGUgem9uZTogTmdab25lXHJcbiAgICApIHtcclxuICAgICAgICBzdXBlcihob3N0UmVmLCByZW5kZXJlcjIpO1xyXG4gICAgICAgIHRoaXMuZGVmYXVsdE1vZGFsSGVhZGVyID0gVGlMb2NhbGUuZ2V0TG9jYWxlV29yZHMoKS50cFJlbmFtZS5tb2RhbEhlYWRlcjtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5b6F57yW6L6R55qE5YaF5a65XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIHZhbHVlOiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIOagh+ivhuivpeihjOaVsOaNruaYr+WQpuS4um5ld1xyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBpc05ldzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgLyoqXHJcbiAgICAgKiDnu4Tku7bmmK/lkKblj6/nlKhcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgZGlzYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIC8qKlxyXG4gICAgICog5by556qX5qCH6aKYXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIG1vZGFsSGVhZGVyOiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOmTheeslOWbvuagh+eahHRpcOaPkOekuuS/oeaBr1xyXG4gICAgICpcclxuICAgICAqIOagueaNruWNjuS4uuS6kTQuMOinhOiMg+WPmOabtO+8jOS9v+eUqOWOn+eUn3RpdGxl5Luj5pu/dGlw6Kej6YeK5Zu+5qCH55qE5L2c55So77yMMTAuMC4x54mI5pys6LW36K+l5o6l5Y+j6ZqQ6JeP77yM5bm25Y+W5raI57y655yB5YC877yI57yW6L6RL0VkaXTvvIjlm73pmYXljJbvvInvvIlcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgaWNvblRpcDogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDpk4XnrJTlm77moIfnmoR0aXDmj5DnpLrkv6Hmga/mlrnkvY3vvIwxMC4wLjHniYjmnKzotbfor6XmjqXlj6PpmpDol49cclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgaWNvblRpcFBvc2l0aW9uOiBUaVBvc2l0aW9uVHlwZSA9ICd0b3AnO1xyXG4gICAgLyoqXHJcbiAgICAgKiAxMC4wLjHmlrDlop5cclxuICAgICAqXHJcbiAgICAgKiDlm77moIfnmoR0aXRsZeWxnuaAp++8jOeUqOS6juivtOaYjuWbvuagh+eahOS9nOeUqFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBpY29uVGl0bGU6IHN0cmluZyA9IFRpTG9jYWxlLmdldExvY2FsZVdvcmRzKCkudHBSZW5hbWUudGlwO1xyXG4gICAgLyoqXHJcbiAgICAgKiAxMC4wLjPmlrDlop5cclxuICAgICAqXHJcbiAgICAgKiDmmK/lkKbpgJrov4fnu4Tku7bmmL7npLrooqvnvJbovpHnmoTlhoXlrrnvvIznu4Tku7bku6XmlofmnKznmoTlvaLlvI/mmL7npLrvvIzpu5jorqTmmL7npLpcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgc2hvd1ZhbHVlOiBib29sZWFuID0gdHJ1ZTtcclxuICAgIC8qKlxyXG4gICAgICog56Gu6K6kL09L5oyJ6ZKu54K55Ye75LqL5Lu277yM5Y+C5pWw77ya6L6T5YWl5qGG55qE5YaF5a65XHJcbiAgICAgKi9cclxuICAgIEBPdXRwdXQoKSByZWFkb25seSBjb25maXJtOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gICAgLyoqXHJcbiAgICAgKiDnoa7orqQvT0vmjInpkq7ngrnlh7vkuovku7bvvIzkuLrlvIDlj5HogIXmj5DkvpvlhbPpl63lvLnnqpfnmoTml7bmnLpcclxuICAgICAqXHJcbiAgICAgKiDlj4LmlbDvvJrlvLnnqpflrp7kvotbVHBSZW5hbWVNb2RhbFJlZl17QGxpbmsgLi4vaW50ZXJmYWNlcy9UcFJlbmFtZU1vZGFsUmVmLmh0bWx9XHJcbiAgICAgKi9cclxuICAgIEBPdXRwdXQoKSByZWFkb25seSBiZWZvcmVDbG9zZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog6Ieq5a6a5LmJ5by556qX5qih5p2/XHJcbiAgICAgKi9cclxuICAgIEBDb250ZW50Q2hpbGQoJ3JlbmFtZU1vZGFsJywgeyBzdGF0aWM6IHRydWUgfSkgY3VzdG9tTW9kYWw6IFRlbXBsYXRlUmVmPGFueT47XHJcblxyXG4gICAgcHJpdmF0ZSBob3N0U3BhY2U6IG51bWJlciA9IDU7IC8vIOW8ueeql+i3nXJlbmFtZeeahOi3neemu1xyXG5cclxuICAgIHByaXZhdGUgZGVmYXVsdE1vZGFsSGVhZGVyOiBzdHJpbmc7XHJcblxyXG4gICAgcHJpdmF0ZSB1bmxpc3RlbkRvY3VtZW50Q2xpY2s6ICgpID0+IHZvaWQ7XHJcblxyXG4gICAgcHJpdmF0ZSByZW5hbWVNb2RhbDogVGlQb3BVcFJlZjtcclxuXHJcbiAgICBwcml2YXRlIFRwUmVuYW1lTW9kYWxDb21wb25lbnRSZWY6IGFueTtcclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG4gICAgICAgIHRoaXMuaWNvblRpdGxlID0gdGhpcy5pY29uVGlwID8gJycgOiB0aGlzLmljb25UaXRsZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9uQ2xpY2soKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDliJ3lp4tjcmVhdGXkuIDmrKHljbPlj6/vvIzlpJrmrKHngrnlh7vnvJbovpHlm77moIfpgb/lhY3ph43lpI3nlJ/miJDnmoTpgLvovpHvvIzlnKhwb3B1cFNlcnZpY2XlhoXpg6jlt7LmnInlpITnkIZcclxuICAgICAgICBpZiAoIXRoaXMucmVuYW1lTW9kYWwpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5hbWVNb2RhbCA9IHRoaXMudGlQb3B1cC5jcmVhdGUoVHBSZW5hbWVNb2RhbENvbnRhaW5lckNvbXBvbmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIG9wZW4gbW9kYWxcclxuICAgICAgICB0aGlzLlRwUmVuYW1lTW9kYWxDb21wb25lbnRSZWYgPSAgdGhpcy5yZW5hbWVNb2RhbC5zaG93KHtcclxuICAgICAgICAgICAgY29udGVudDogdGhpcy5jdXN0b21Nb2RhbCB8fCBUcFJlbmFtZU1vZGFsQ29tcG9uZW50LFxyXG4gICAgICAgICAgICBjb250ZW50Q29udGV4dDogdGhpcy5jdXN0b21Nb2RhbCA/XHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVuYW1lTW9kYWw6IHRoaXMucmVuYW1lTW9kYWwsXHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMudmFsdWVcclxuICAgICAgICAgICAgICAgIH0gOiB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy52YWx1ZSxcclxuICAgICAgICAgICAgICAgIGlkOiB0aGlzLmlkICsgJ19yZW5hbWVNb2RhbCcsXHJcbiAgICAgICAgICAgICAgICBtb2RhbEhlYWRlcjogdGhpcy5tb2RhbEhlYWRlciB8fCB0aGlzLmRlZmF1bHRNb2RhbEhlYWRlcixcclxuICAgICAgICAgICAgICAgIGNsb3NlOiAoZm9ybTogRm9ybUdyb3VwKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5Zug5Li66Z2e5bi45piO56Gu6K+l57uE5Lu25Y+q5pyJ5LiA5Liq6KGo5Y2V5YWD57SgIOagoemqjOe7k+aenOWumuS5ieS4umVycm9y6ICM5LiN5pivZXJyb3Jz77yM55u05o6l6YCa6L+HaW5wdXTojrflj5bmoKHpqozlpLHotKXnmoTlhYPntKBcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvcjogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwgPSBUaVZhbGlkYXRvcnMuY2hlY2soZm9ybSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuVHBSZW5hbWVNb2RhbENvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0JylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmVmb3JlQ2xvc2UuZW1pdCh0aGlzLnJlbmFtZU1vZGFsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25maXJtLmVtaXQodGhpcy5UcFJlbmFtZU1vZGFsQ29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignaW5wdXQnKS52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdW51c2VkLWV4cHJlc3Npb25cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95UmVuYW1lTW9kYWwoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZGlzbWlzczogKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJveVJlbmFtZU1vZGFsKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGNvbnRhaW5lcjogJ2JvZHknXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgbW9kYWw6IEVsZW1lbnRSZWYgPSB0aGlzLlRwUmVuYW1lTW9kYWxDb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyMi5zZXRTdHlsZShtb2RhbCwgJ2xlZnQnLCAnLTk5OTlweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIyLnNldFN0eWxlKG1vZGFsLCAndG9wJywgJy05OTk5cHgnKTtcclxuXHJcbiAgICAgICAgY29uc3QgdGQ6IEVsZW1lbnRSZWYgPSB0aGlzLmZpbmRDbG9zZXN0VEQodGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgIFRpUG9zaXRpb24uc2V0UG9zaXRpb24oe1xyXG4gICAgICAgICAgICB0YXJnZXRFbGU6IG1vZGFsLFxyXG4gICAgICAgICAgICBob3N0RWxlOiB0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgaG9zdEVsZVg6IHRkIHx8IHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgICAgICBoT2Zmc2V0OiB0ZCA/IDEwIDogMCxcclxuICAgICAgICAgICAgaG9zdFNwYWNlOiB0aGlzLmhvc3RTcGFjZSxcclxuICAgICAgICAgICAgZml4TWF4SGVpZ2h0OiB0cnVlLFxyXG4gICAgICAgICAgICBkZXRlcm1pblBvc2l0aW9uRm46IHRoaXMuRGV0ZXJtaW5lUG9zaXRpb25cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGREb2N1bWVudENsaWNrRXZlbnQoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIERldGVybWluZVBvc2l0aW9uOiAobGF5b3V0OiBhbnkpID0+IHN0cmluZyA9IChsYXlvdXQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChsYXlvdXQuYXZpbGFibGVMYXlvdXQuYm90dG9tID49IGxheW91dC50YXJnZXRMYXlvdXQuaGVpZ2h0ICsgdGhpcy5ob3N0U3BhY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuICdib3R0b20tbGVmdCc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuICd0b3AtbGVmdCc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZmluZENsb3Nlc3RURDogKGVsZTogYW55KSA9PiBFbGVtZW50UmVmID0gKGVsZTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGVsZS5ub2RlTmFtZSA9PT0gJ0hUTUwnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSBlbHNlIGlmIChlbGUucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ1REJykge1xyXG4gICAgICAgICAgICByZXR1cm4gZWxlLnBhcmVudE5vZGU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmluZENsb3Nlc3RURChlbGUucGFyZW50Tm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWRkRG9jdW1lbnRDbGlja0V2ZW50KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMudW5saXN0ZW5Eb2N1bWVudENsaWNrID0gdGhpcy5yZW5kZXJlcjIubGlzdGVuKGRvY3VtZW50LCAnY2xpY2snLCAoZXZlbnQ6IE1vdXNlRXZlbnQpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIOe8lui+keWbvuagh+iiq+eCueWHu++8jOinpuWPkeWFtue7keWumueahGNsaWNr5LqL5Lu277yM6L+Z6YeM5LiN5YGa5aSE55CG44CCXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLlRwUmVuYW1lTW9kYWxDb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0cFJlbmFtZU1vZGFsSG9zdEVsZW1lbnQ6IGFueSA9IHRoaXMuVHBSZW5hbWVNb2RhbENvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHJlbmFtZU1vZGFs5LmL5aSW55qE5YWD57Sg6KKr54K55Ye777yM6ZSA5q+BcmVuYW1lTW9kYWxcclxuICAgICAgICAgICAgICAgICAgICBpZiAoISh0cFJlbmFtZU1vZGFsSG9zdEVsZW1lbnQgJiYgdHBSZW5hbWVNb2RhbEhvc3RFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95UmVuYW1lTW9kYWwoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6ZSA5q+B5by556qX44CB5Y+W5raIZG9jdW1lbnTnmoRjbGlja+S6i+S7tlxyXG4gICAgcHJpdmF0ZSBkZXN0cm95UmVuYW1lTW9kYWwoKTogdm9pZCB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11bnVzZWQtZXhwcmVzc2lvblxyXG4gICAgICAgIHRoaXMucmVuYW1lTW9kYWwgJiYgdGhpcy5yZW5hbWVNb2RhbC5oaWRlKCk7XHJcbiAgICAgICAgaWYgKHRoaXMudW5saXN0ZW5Eb2N1bWVudENsaWNrKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5saXN0ZW5Eb2N1bWVudENsaWNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdXNlLWxpZmUtY3ljbGUtaW50ZXJmYWNlXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uRGVzdHJveSgpO1xyXG4gICAgICAgIHRoaXMuZGVzdHJveVJlbmFtZU1vZGFsKCk7XHJcbiAgICB9XHJcbn1cclxuIl19