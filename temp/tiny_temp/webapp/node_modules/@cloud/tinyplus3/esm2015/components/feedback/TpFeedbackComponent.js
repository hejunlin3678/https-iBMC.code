import { Component, Input, ViewChild } from '@angular/core';
import { TiBaseComponent, TiLocale, Util } from '@cloud/tiny3';
import { CfUtil } from '../../cfutils/CfUtil';
import { TpHalfmodalComponent } from '../halfmodal/TpHalfmodalModule';
import { TpFeedbackContentComponent } from './TpFeedbackContentComponent';
import { TpUtil } from './../../utils/TpUtil';
/**
 * 问卷调查组件 feedback
 *
 * 该组件支持服务去自定义题目，但是题目的类型要求是单选题目，并且会关联出两个多选题目。如果多选题目中有其它原因这个选项，要求这个选项放在最后。
 *
 * 使用该组件需注意以下几点：
 *
 * 1.该组件与console相关，需要使用到@cloud/cfdata;<br>
 * 2.options.allQuestion和options.customQuestion两个接口互斥。customQuestion是在默认的题目中去新增题目，allQuestion是由服务去定制所有的问卷内容（适用于CBC、客服、IAM等服务）；<br>
 * 3.本地调试确保端口是<b>8888</b>，目前NPS后台已经将http://localhost:8888 放开；<br>
 * 4.同一个用户数据提交之后，90（10.1.0 版本规范变更，由31变更为90）天内组件不显示。如果调测需要，可自行修改源码中阈值MILLISECONDS_PER_MONTH(含义：N毫秒之后可以显示)；<br>
 * 5.用户提交的数据下发到NPS后台，如需查看数据，请联系NPS后台同事孙正东 30009929"；<br>
 * 6.华为云各服务可根据http://csbi.huawei.com/#/home 查找对应编号或英文简称设置<b>serviceId</b>；
 *
 * <example-url>../tinyplus3demo/#/feedback/feedback-all</example-url>
 */
export class TpFeedbackComponent extends TiBaseComponent {
    constructor() {
        super(...arguments);
        // 常量配置
        this.CONST_ANT = {
            MILLISECONDS_PER_MONTH: 90 * 24 * 60 * 60 * 1000 // 90天对应的毫秒数
        };
        /**
         * @ignore
         * 是否显示问卷入口
         */
        this.showFeedBack = false;
        /**
         * @ignore
         * 是否显示弹出框
         */
        this.openModalAlert = false;
        this.useId = '';
    }
    ngOnInit() {
        super.ngOnInit();
        CfUtil.getUser()
            .then((user) => {
            const root = user;
            const camel = CfUtil.getHttpService();
            const msgService = CfUtil.getMessage();
            if (!camel || !Util.isFunction(camel.get) || !root || !msgService || !Util.isFunction(msgService.showSuccess)) {
                return;
            }
            this.alertLinkText = Util.formatEntry(TiLocale.getLocaleWords().tpFeedback.open_halfModal.click, [this.options.serviceName]);
            const useId = root.domainId;
            const url = `${TpFeedbackContentComponent.config.backend}/api/get/commit/date?surveyId={survey_id}&userId={user_id}&serviceId={service_id}`;
            this.useId = useId;
            if (this.useId) {
                camel.get({
                    url: {
                        s: url,
                        o: {
                            survey_id: TpFeedbackContentComponent.config.surveyId,
                            user_id: this.useId,
                            service_id: this.options.serviceId
                        }
                    }
                })
                    .then((response) => {
                    // 后台返回的日期格式yyyy-MM-dd，在IE下Date.parse为NaN，需要转成yyyy/mm/dd
                    const submitDate = Date.parse(response.data.replace(/-/g, '/'));
                    // 如果是非法日期，或者没有提交为''，则重新赋值为0.否则会出现NaN，组件展示不出来。
                    const milliSeconds = isNaN(submitDate) ? 0 : submitDate;
                    // 查询上次提交的日期，如果小于90天则不显示。否则，看之前用户是否点击关闭按钮
                    if (new Date().getTime() - milliSeconds > this.CONST_ANT.MILLISECONDS_PER_MONTH) {
                        const tinyVocValue = Util.isUndefined(TpUtil.getCookie('tinyVoc')) ? '' : TpUtil.getCookie('tinyVoc');
                        if (tinyVocValue.indexOf(`${this.options.serviceId}${this.useId}`) === -1) {
                            this.showFeedBack = true;
                            this.openModalAlert = true;
                        }
                    }
                }, () => {
                    // 数据请求失败，不出现该组件。如果出现错误提示，会给用户带来困扰。
                });
            }
        });
    }
    /**
     * @ignore
     * 关闭弹出框
     */
    closeModalAlert() {
        const serverlist = Util.isUndefined(TpUtil.getCookie('tinyVoc')) ? '' : TpUtil.getCookie('tinyVoc');
        TpUtil.setCookie('tinyVoc', `${serverlist}${this.options.serviceId}${this.useId},`);
        this.showFeedBack = false;
    }
    /**
     * @ignore
     * 提交问卷
     */
    onSubmit() {
        this.halfmodalCom.hide(); // 弹窗关闭
        this.openModalAlert = false; // 入口关闭
        this.showFeedBack = false;
    }
}
TpFeedbackComponent.decorators = [
    { type: Component, args: [{
                selector: 'tp-feedback',
                template: "<!-- \u63D0\u793A\u9762\u677F alert -->\r\n<ti-alert [(open)]=\"openModalAlert\" style=\"width: 100%\" [type]=\"'prompt'\" (openChange)=\"closeModalAlert()\" [id]=\"appendId('feedback_alert')\">\r\n    <span>{{ 'tpFeedback.open_halfModal.text1' | tiTranslate }}<span\r\n        class=\"tp-feedback-openModal\" tiOutline [tabindex]=\"0\" (keydown.enter)=\"halfModal.show($event.target)\"\r\n        (click)=\"halfModal.show($event.target)\" [id]=\"appendId('open_modal')\">{{ alertLinkText }}</span>{{'tpFeedback.open_halfModal.text2' | tiTranslate}}</span>\r\n</ti-alert>\r\n\r\n<!-- \u534A\u5C4F\u5F39\u7A97 halfmodal -->\r\n<tp-halfmodal #halfModal width=\"560px\" [id]=\"appendId('halfmodal')\">\r\n    <!-- \u95EE\u5377\u8C03\u67E5\u5185\u5BB9 -->\r\n    <tp-feedback-content [options]=\"options\" [id]=\"appendId('content')\" (submit)=\"onSubmit()\">\r\n        <ng-content></ng-content>\r\n    </tp-feedback-content>\r\n</tp-halfmodal>",
                host: {
                    '[hidden]': '!showFeedBack'
                },
                styles: [":host{display:block}.tp-feedback-openModal{color:var(--ti-common-color-text-link);cursor:pointer;font-size:var(--ti-common-font-size-base);text-decoration:none}.tp-feedback-openModal:hover{color:var(--ti-common-color-text-link-hover)}:host tp-halfmodal{padding-bottom:0}"]
            },] }
];
TpFeedbackComponent.propDecorators = {
    options: [{ type: Input }],
    halfmodalCom: [{ type: ViewChild, args: ['halfModal', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBGZWVkYmFja0NvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55cGx1czMvY29tcG9uZW50cy9mZWVkYmFjay9UcEZlZWRiYWNrQ29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFL0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRXRFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRTFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUM5Qzs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFXSCxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsZUFBZTtJQVR4RDs7UUFtQkksT0FBTztRQUNDLGNBQVMsR0FBUTtZQUNyQixzQkFBc0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVk7U0FDaEUsQ0FBQztRQUVGOzs7V0FHRztRQUNJLGlCQUFZLEdBQVksS0FBSyxDQUFDO1FBRXJDOzs7V0FHRztRQUNJLG1CQUFjLEdBQVksS0FBSyxDQUFDO1FBTy9CLFVBQUssR0FBVyxFQUFFLENBQUM7SUF3RS9CLENBQUM7SUF0RUcsUUFBUTtRQUNKLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNqQixNQUFNLENBQUMsT0FBTyxFQUFFO2FBQ1gsSUFBSSxDQUFDLENBQUMsSUFBUyxFQUFFLEVBQUU7WUFDaEIsTUFBTSxJQUFJLEdBQVEsSUFBSSxDQUFDO1lBQ3ZC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R0FBRyxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDcEYsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUVEOzs7T0FHRztJQUNILFFBQVE7UUFDSixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTztRQUNqQyxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxDQUFDLE9BQU87UUFDcEMsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7SUFDOUIsQ0FBQzs7O1lBaEhKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsYUFBYTtnQkFDdkIseTdCQUE4QjtnQkFFOUIsSUFBSSxFQUFFO29CQUNGLFVBQVUsRUFBRSxlQUFlO2lCQUM5Qjs7YUFDSjs7O3NCQU1JLEtBQUs7MkJBSUwsU0FBUyxTQUFDLFdBQVcsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVGlCYXNlQ29tcG9uZW50LCBUaUxvY2FsZSwgVXRpbCB9IGZyb20gJ0BjbG91ZC90aW55Myc7XHJcblxyXG5pbXBvcnQgeyBDZlV0aWwgfSBmcm9tICcuLi8uLi9jZnV0aWxzL0NmVXRpbCc7XHJcbmltcG9ydCB7IFRwSGFsZm1vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi4vaGFsZm1vZGFsL1RwSGFsZm1vZGFsTW9kdWxlJztcclxuXHJcbmltcG9ydCB7IFRwRmVlZGJhY2tDb250ZW50Q29tcG9uZW50IH0gZnJvbSAnLi9UcEZlZWRiYWNrQ29udGVudENvbXBvbmVudCc7XHJcbmltcG9ydCB7IFRwRmVlZGJhY2tPcHRpb25zIH0gZnJvbSAnLi9UcEZlZWRiYWNrSW50ZXJmYWNlJztcclxuaW1wb3J0IHsgVHBVdGlsIH0gZnJvbSAnLi8uLi8uLi91dGlscy9UcFV0aWwnO1xyXG4vKipcclxuICog6Zeu5Y236LCD5p+l57uE5Lu2IGZlZWRiYWNrXHJcbiAqXHJcbiAqIOivpee7hOS7tuaUr+aMgeacjeWKoeWOu+iHquWumuS5iemimOebru+8jOS9huaYr+mimOebrueahOexu+Wei+imgeaxguaYr+WNlemAiemimOebru+8jOW5tuS4lOS8muWFs+iBlOWHuuS4pOS4quWkmumAiemimOebruOAguWmguaenOWkmumAiemimOebruS4reacieWFtuWug+WOn+WboOi/meS4qumAiemhue+8jOimgeaxgui/meS4qumAiemhueaUvuWcqOacgOWQjuOAglxyXG4gKlxyXG4gKiDkvb/nlKjor6Xnu4Tku7bpnIDms6jmhI/ku6XkuIvlh6DngrnvvJpcclxuICpcclxuICogMS7or6Xnu4Tku7bkuI5jb25zb2xl55u45YWz77yM6ZyA6KaB5L2/55So5YiwQGNsb3VkL2NmZGF0YTs8YnI+XHJcbiAqIDIub3B0aW9ucy5hbGxRdWVzdGlvbuWSjG9wdGlvbnMuY3VzdG9tUXVlc3Rpb27kuKTkuKrmjqXlj6PkupLmlqXjgIJjdXN0b21RdWVzdGlvbuaYr+WcqOm7mOiupOeahOmimOebruS4reWOu+aWsOWinumimOebru+8jGFsbFF1ZXN0aW9u5piv55Sx5pyN5Yqh5Y675a6a5Yi25omA5pyJ55qE6Zeu5Y235YaF5a6577yI6YCC55So5LqOQ0JD44CB5a6i5pyN44CBSUFN562J5pyN5Yqh77yJ77ybPGJyPlxyXG4gKiAzLuacrOWcsOiwg+ivleehruS/neerr+WPo+aYrzxiPjg4ODg8L2I+77yM55uu5YmNTlBT5ZCO5Y+w5bey57uP5bCGaHR0cDovL2xvY2FsaG9zdDo4ODg4IOaUvuW8gO+8mzxicj5cclxuICogNC7lkIzkuIDkuKrnlKjmiLfmlbDmja7mj5DkuqTkuYvlkI7vvIw5MO+8iDEwLjEuMCDniYjmnKzop4TojIPlj5jmm7TvvIznlLEzMeWPmOabtOS4ujkw77yJ5aSp5YaF57uE5Lu25LiN5pi+56S644CC5aaC5p6c6LCD5rWL6ZyA6KaB77yM5Y+v6Ieq6KGM5L+u5pS55rqQ56CB5Lit6ZiI5YC8TUlMTElTRUNPTkRTX1BFUl9NT05USCjlkKvkuYnvvJpO5q+r56eS5LmL5ZCO5Y+v5Lul5pi+56S6Ke+8mzxicj5cclxuICogNS7nlKjmiLfmj5DkuqTnmoTmlbDmja7kuIvlj5HliLBOUFPlkI7lj7DvvIzlpoLpnIDmn6XnnIvmlbDmja7vvIzor7fogZTns7tOUFPlkI7lj7DlkIzkuovlrZnmraPkuJwgMzAwMDk5MjlcIu+8mzxicj5cclxuICogNi7ljY7kuLrkupHlkITmnI3liqHlj6/moLnmja5odHRwOi8vY3NiaS5odWF3ZWkuY29tLyMvaG9tZSDmn6Xmib7lr7nlupTnvJblj7fmiJboi7HmlofnroDnp7Dorr7nva48Yj5zZXJ2aWNlSWQ8L2I+77ybXHJcbiAqXHJcbiAqIDxleGFtcGxlLXVybD4uLi90aW55cGx1czNkZW1vLyMvZmVlZGJhY2svZmVlZGJhY2stYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAndHAtZmVlZGJhY2snLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL2ZlZWRiYWNrLmh0bWwnLFxyXG4gICAgc3R5bGVVcmxzOiBbJy4vZmVlZGJhY2subGVzcyddLFxyXG4gICAgaG9zdDoge1xyXG4gICAgICAgICdbaGlkZGVuXSc6ICchc2hvd0ZlZWRCYWNrJ1xyXG4gICAgfVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIFRwRmVlZGJhY2tDb21wb25lbnQgZXh0ZW5kcyBUaUJhc2VDb21wb25lbnQge1xyXG4gICAgLyoqXHJcbiAgICAgKiDnu4Tku7bmlbDmja5cclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgb3B0aW9uczogVHBGZWVkYmFja09wdGlvbnM7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgQFZpZXdDaGlsZCgnaGFsZk1vZGFsJywgeyBzdGF0aWM6IHRydWUgfSkgaGFsZm1vZGFsQ29tOiBUcEhhbGZtb2RhbENvbXBvbmVudDtcclxuXHJcbiAgICAvLyDluLjph4/phY3nva5cclxuICAgIHByaXZhdGUgQ09OU1RfQU5UOiBhbnkgPSB7XHJcbiAgICAgICAgTUlMTElTRUNPTkRTX1BFUl9NT05USDogOTAgKiAyNCAqIDYwICogNjAgKiAxMDAwIC8vIDkw5aSp5a+55bqU55qE5q+r56eS5pWwXHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5piv5ZCm5pi+56S66Zeu5Y235YWl5Y+jXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzaG93RmVlZEJhY2s6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaYr+WQpuaYvuekuuW8ueWHuuahhlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb3Blbk1vZGFsQWxlcnQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaJk+W8gOW8ueeql+mTvuaOpeaWh+acrFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYWxlcnRMaW5rVGV4dDogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSB1c2VJZDogc3RyaW5nID0gJyc7XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgICAgICBDZlV0aWwuZ2V0VXNlcigpXHJcbiAgICAgICAgICAgIC50aGVuKCh1c2VyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJvb3Q6IGFueSA9IHVzZXI7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjYW1lbDogYW55ID0gQ2ZVdGlsLmdldEh0dHBTZXJ2aWNlKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtc2dTZXJ2aWNlOiBhbnkgPSBDZlV0aWwuZ2V0TWVzc2FnZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghY2FtZWwgfHwgIVV0aWwuaXNGdW5jdGlvbihjYW1lbC5nZXQpIHx8ICFyb290IHx8ICFtc2dTZXJ2aWNlIHx8ICFVdGlsLmlzRnVuY3Rpb24obXNnU2VydmljZS5zaG93U3VjY2VzcykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5hbGVydExpbmtUZXh0ID0gVXRpbC5mb3JtYXRFbnRyeShcclxuICAgICAgICAgICAgICAgICAgICBUaUxvY2FsZS5nZXRMb2NhbGVXb3JkcygpLnRwRmVlZGJhY2sub3Blbl9oYWxmTW9kYWwuY2xpY2ssIFt0aGlzLm9wdGlvbnMuc2VydmljZU5hbWVdKTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VJZDogc3RyaW5nID0gcm9vdC5kb21haW5JZDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHVybDogc3RyaW5nID0gYCR7VHBGZWVkYmFja0NvbnRlbnRDb21wb25lbnQuY29uZmlnLmJhY2tlbmR9L2FwaS9nZXQvY29tbWl0L2RhdGU/c3VydmV5SWQ9e3N1cnZleV9pZH0mdXNlcklkPXt1c2VyX2lkfSZzZXJ2aWNlSWQ9e3NlcnZpY2VfaWR9YDtcclxuICAgICAgICAgICAgICAgIHRoaXMudXNlSWQgPSB1c2VJZDtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnVzZUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FtZWwuZ2V0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzOiB1cmwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VydmV5X2lkOiBUcEZlZWRiYWNrQ29udGVudENvbXBvbmVudC5jb25maWcuc3VydmV5SWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9pZDogdGhpcy51c2VJZCwgLy8g5q2k5aSE5Y+W5YC85a6e6ZmF5pivZG9tYWluSWTogIzkuI3mmK91c2VySWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlX2lkOiB0aGlzLm9wdGlvbnMuc2VydmljZUlkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g5ZCO5Y+w6L+U5Zue55qE5pel5pyf5qC85byPeXl5eS1NTS1kZO+8jOWcqElF5LiLRGF0ZS5wYXJzZeS4uk5hTu+8jOmcgOimgei9rOaIkHl5eXkvbW0vZGRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1Ym1pdERhdGU6IG51bWJlciA9IERhdGUucGFyc2UocmVzcG9uc2UuZGF0YS5yZXBsYWNlKC8tL2csICcvJykpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOaYr+mdnuazleaXpeacn++8jOaIluiAheayoeacieaPkOS6pOS4uicn77yM5YiZ6YeN5paw6LWL5YC85Li6MC7lkKbliJnkvJrlh7rnjrBOYU7vvIznu4Tku7blsZXnpLrkuI3lh7rmnaXjgIJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pbGxpU2Vjb25kczogbnVtYmVyID0gaXNOYU4oc3VibWl0RGF0ZSkgPyAwIDogc3VibWl0RGF0ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyDmn6Xor6LkuIrmrKHmj5DkuqTnmoTml6XmnJ/vvIzlpoLmnpzlsI/kuo45MOWkqeWImeS4jeaYvuekuuOAguWQpuWIme+8jOeci+S5i+WJjeeUqOaIt+aYr+WQpueCueWHu+WFs+mXreaMiemSrlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbWlsbGlTZWNvbmRzID4gdGhpcy5DT05TVF9BTlQuTUlMTElTRUNPTkRTX1BFUl9NT05USCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpbnlWb2NWYWx1ZTogc3RyaW5nID0gVXRpbC5pc1VuZGVmaW5lZChUcFV0aWwuZ2V0Q29va2llKCd0aW55Vm9jJykpID8gJycgOiBUcFV0aWwuZ2V0Q29va2llKCd0aW55Vm9jJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpbnlWb2NWYWx1ZS5pbmRleE9mKGAke3RoaXMub3B0aW9ucy5zZXJ2aWNlSWR9JHt0aGlzLnVzZUlkfWApID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dGZWVkQmFjayA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3Blbk1vZGFsQWxlcnQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g5pWw5o2u6K+35rGC5aSx6LSl77yM5LiN5Ye6546w6K+l57uE5Lu244CC5aaC5p6c5Ye6546w6ZSZ6K+v5o+Q56S677yM5Lya57uZ55So5oi35bim5p2l5Zuw5omw44CCXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOWFs+mXreW8ueWHuuahhlxyXG4gICAgICovXHJcbiAgICBjbG9zZU1vZGFsQWxlcnQoKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3Qgc2VydmVybGlzdDogc3RyaW5nID0gVXRpbC5pc1VuZGVmaW5lZChUcFV0aWwuZ2V0Q29va2llKCd0aW55Vm9jJykpID8gJycgOiBUcFV0aWwuZ2V0Q29va2llKCd0aW55Vm9jJyk7XHJcbiAgICAgICAgVHBVdGlsLnNldENvb2tpZSgndGlueVZvYycsIGAke3NlcnZlcmxpc3R9JHt0aGlzLm9wdGlvbnMuc2VydmljZUlkfSR7dGhpcy51c2VJZH0sYCk7XHJcbiAgICAgICAgdGhpcy5zaG93RmVlZEJhY2sgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaPkOS6pOmXruWNt1xyXG4gICAgICovXHJcbiAgICBvblN1Ym1pdCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmhhbGZtb2RhbENvbS5oaWRlKCk7IC8vIOW8ueeql+WFs+mXrVxyXG4gICAgICAgIHRoaXMub3Blbk1vZGFsQWxlcnQgPSBmYWxzZTsgLy8g5YWl5Y+j5YWz6ZetXHJcbiAgICAgICAgdGhpcy5zaG93RmVlZEJhY2sgPSBmYWxzZTtcclxuICAgIH1cclxufVxyXG4iXX0=