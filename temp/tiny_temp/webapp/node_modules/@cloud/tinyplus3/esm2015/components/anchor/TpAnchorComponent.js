import { Component, ContentChild, ElementRef, EventEmitter, Input, NgZone, Output, Renderer2, TemplateRef } from '@angular/core';
import { TiBaseComponent } from '@cloud/tiny3';
/**
 * 定位导航组件
 *
 * <example-url>../tinyplus3demo/#/anchor/anchor-all</example-url>
 */
export class TpAnchorComponent extends TiBaseComponent {
    constructor(element, renderer2, zone) {
        super(element, renderer2);
        this.element = element;
        this.renderer2 = renderer2;
        this.zone = zone;
        /**
         * 设置锚点对应Dom元素距窗口顶部距离，点击切换锚点时，页面滑动在到达该值时，切换到对应锚点
         *
         * <b>注：</b>通过滚轮滚动时，当顶部距离小于设置的offsetTop值，切换到对应锚点
         */
        this.offsetTop = 50;
        /**
         * 设置用户点击锚点时，页面滑动速度，其单位为ms
         */
        this.speed = 300;
        /**
         * 跳转到该锚点时，触发事件
         */
        this.select = new EventEmitter();
        /**
         * 锚点id改变事件，用于实现锚点id双向绑定，也可单独使用
         *
         * 10.0.4/9.0.8新增接口
         */
        this.anchorIdChange = new EventEmitter();
        this.hasGoanchor = false;
        this.hasAnimation = false; // 初始化及数据更新时，无需平滑滚动
    }
    ngOnChanges(changes) {
        super.ngOnChanges(changes);
        const anchorIdObj = changes['anchorId'];
        const itemsObj = changes['items'];
        if (anchorIdObj && anchorIdObj.currentValue && !anchorIdObj.isFirstChange() && this.anchorId !== this.currentId) {
            this.hasGoanchor = false;
            this.hasAnimation = true;
        }
        if (itemsObj && itemsObj.currentValue && !itemsObj.isFirstChange()) {
            this.hasGoanchor = false;
        }
    }
    ngOnInit() {
        super.ngOnInit();
        // 监听滚轮事件
        this.zone.runOutsideAngular(() => {
            this.unlistenScroll = this.renderer2.listen(window, 'scroll', () => {
                this.onWindowScroll();
            });
        });
    }
    ngAfterViewChecked() {
        super.ngAfterViewChecked();
        // 数据更新anchorId有值时，需要滚动页面到指定位置，只触发一次
        if (!this.hasGoanchor) {
            this.hasGoanchor = true;
            this.goToAnchor(this.anchorId || this.items && this.items[0] && this.items[0].id);
        }
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        if (this.unlistenScroll) {
            this.unlistenScroll();
        }
    }
    // 页面滚动时，相应锚点高亮
    onWindowScroll() {
        if (this.isInnerScrolling) {
            return;
        }
        const scrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
        const itemLength = this.items && this.items.length;
        // 页面滚动时，锚点对应Dom元素距浏览器窗口顶部高度小于等于所配置的顶部偏移量，则应是当前锚点
        for (let i = itemLength - 1; i >= 0; i--) {
            const anchorEle = document.getElementById(this.items[i].id);
            // 判断有无当前激活锚点，使用户点击时，只当前锚点高亮；而滚动时，相对应锚点都高亮
            if (anchorEle && anchorEle.offsetTop) {
                const clientY = anchorEle.offsetTop - scrollTop - this.offsetTop;
                const id = this.anchorId;
                if (clientY <= this.offsetTop) {
                    this.zone.run(() => {
                        this.anchorId = this.currentId = this.items[i].id;
                        // 锚点改变时，仅向外通知一次
                        if (this.anchorId !== id) {
                            this.select.emit(this.items[i]);
                            this.anchorIdChange.emit(this.items[i].id);
                        }
                    });
                    break;
                }
            }
        }
    }
    /**
     * @ignore
     */
    onClick(item) {
        this.hasAnimation = true;
        this.goToAnchor(item.id);
    }
    /**
     * 页面滚动到目标锚点对应位置
     * @param anchorId 锚点id
     */
    goToAnchor(anchorId) {
        this.isInnerScrolling = true;
        const targetEle = document.getElementById(anchorId);
        const scrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
        const scollPosition = targetEle && targetEle.offsetTop - this.offsetTop;
        /**
         * 初始化及数据更新时，页面直接滚动到定位位置；
         * 点击锚点切换及用户动态改变当前锚点id时，滚动条平滑运动。
         */
        if (this.hasAnimation) {
            this.scrollAnimation(scrollTop, scollPosition, anchorId, this.speed);
        }
        else {
            // 修改了当前高亮锚点，使用setTimeout，消除ExpressionChangedAfterItHasBeenCheckedError报错
            setTimeout(() => {
                this.scrollToView(scollPosition, anchorId);
            }, 0);
        }
    }
    // 滚动条平滑运动
    scrollAnimation(currentY, targetY, anchorId, speed) {
        const direction = targetY - currentY > 0 ? 1 : -1;
        let distance = Math.abs(targetY - currentY); // 滚动条需要滚动的距离
        const stepTimes = speed / (1000 / 60); // 一般浏览器刷新频率是60HZ，时间间隔为1000ms/60，总帧数
        let stepDist = distance / stepTimes; // 每帧滚动条滚动距离
        if (targetY !== currentY) {
            stepDist *= direction;
            // 定时器，1000/60ms时间间隔 执行一次
            let positionY = currentY;
            let timer = setInterval(() => {
                positionY = positionY + stepDist;
                distance -= Math.abs(stepDist);
                if (distance <= 0) {
                    clearInterval(timer);
                    timer = undefined;
                    this.scrollToView(targetY, anchorId);
                    this.hasAnimation = false; // 更新hasAnimation
                }
                else {
                    window.scrollTo(0, positionY);
                }
            }, 1000 / 60);
        }
    }
    // 页面定位到指定位置，无滚动效果
    scrollToView(target, anchorId) {
        window.scrollTo(0, target); // 横向坐标不移动
        this.getCurrentAnchor(anchorId);
        this.isInnerScrolling = false;
    }
    // 页面滚动到指定位置之后，向外通知当前锚点数据
    getCurrentAnchor(anchorId) {
        this.anchorId = this.currentId = anchorId;
        for (const item of this.items) {
            if (item.id === anchorId) {
                this.select.emit(item);
                this.anchorIdChange.emit(item.id);
            }
        }
    }
}
TpAnchorComponent.decorators = [
    { type: Component, args: [{
                selector: 'tp-anchor',
                template: "<ul [id]=\"appendId('list')\">\r\n    <li class=\"tp-anchor-link\"\r\n        *ngFor=\"let item of items index as i\"\r\n        [ngClass]=\"{'tp-anchor-link-active': item.id === currentId}\">\r\n        <a href=\"javascript:void(0);\"\r\n            oncontextmenu=\"return false\"\r\n            class=\"tp-anchor-link-title\"\r\n            (click)=\"onClick(item)\"\r\n            [id]=\"appendId('title_' + item.id)\">\r\n            <ng-container *ngIf=\"itemTemplete else defaultTemplete\">\r\n               <ng-container *ngTemplateOutlet=\"itemTemplete; context: {$implicit: item,index: i}\"></ng-container>\r\n            </ng-container>\r\n            <ng-template #defaultTemplete>\r\n                <span>{{item.title}}</span>\r\n            </ng-template>\r\n        </a>\r\n    </li>\r\n</ul>\r\n",
                host: {
                    '[class.tp-anchor-container]': 'true'
                },
                styles: [".ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}::ng-deep :root{--tp-anchor-link-badge-height:var(--tp-anchor-link-badge-width);--tp-anchor-link-badge-width:8px;--tp-anchor-link-line-width:1px;--tp-anchor-link-padding:0 0 var(--ti-common-space-5x) 0;--tp-anchor-link-title-lineHeight:calc(var(--ti-common-font-size-base)*var(--ti-common-line-height-number));--tp-anchor-link-title-padding-left:calc(20px + var(--ti-common-space-3x) + var(--tp-anchor-link-badge-width));--tp-anchor-padding:30px 2px;--tp-anchor-width:160px}:host.tp-anchor-container{-ms-box-sizing:border-box;box-sizing:border-box;display:inline-block;overflow:hidden;padding:var(--tp-anchor-padding);width:var(--tp-anchor-width)}.tp-anchor-link{padding:var(--tp-anchor-link-padding);position:relative}.tp-anchor-link:after{background-color:var(--tp-anchor-link-line-color);content:\"\";height:calc(100% - var(--tp-anchor-link-badge-width));left:calc(var(--ti-common-space-5x) + (var(--tp-anchor-link-badge-width) - var(--tp-anchor-link-line-width))/2);position:absolute;top:calc((var(--tp-anchor-link-title-lineHeight) + var(--tp-anchor-link-badge-width))/2);width:var(--tp-anchor-link-line-width)}.tp-anchor-link:last-child{padding-bottom:0}.tp-anchor-link:last-child:after{display:none}.tp-anchor-link-title{color:var(--tp-anchor-link-title-color);display:block;line-height:var(--tp-anchor-link-title-lineHeight);padding:0 var(--ti-common-space-5x) 0 var(--tp-anchor-link-title-padding-left);position:relative;text-decoration:none;word-wrap:break-word}.tp-anchor-link-title:before{background-color:var(--tp-anchor-link-line-color);border-radius:50%;box-sizing:border-box;content:\"\";height:var(--tp-anchor-link-badge-height);left:var(--ti-common-space-5x);position:absolute;top:calc((var(--tp-anchor-link-title-lineHeight) - var(--tp-anchor-link-badge-height))/2);width:var(--tp-anchor-link-badge-width)}.tp-anchor-link-title:hover{color:var(--tp-anchor-link-title-color-hover)}.tp-anchor-link-active .tp-anchor-link-title{color:var(--tp-anchor-link-title-color-selected)}.tp-anchor-link-active .tp-anchor-link-title:before{background-color:var(--ti-common-color-bg-emphasize)}"]
            },] }
];
TpAnchorComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: NgZone }
];
TpAnchorComponent.propDecorators = {
    items: [{ type: Input }],
    anchorId: [{ type: Input }],
    offsetTop: [{ type: Input }],
    speed: [{ type: Input }],
    select: [{ type: Output }],
    anchorIdChange: [{ type: Output }],
    itemTemplete: [{ type: ContentChild, args: ['item', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBBbmNob3JDb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueXBsdXMzL2NvbXBvbmVudHMvYW5jaG9yL1RwQW5jaG9yQ29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUErQixXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUosT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQWlCL0M7Ozs7R0FJRztBQVVILE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxlQUFlO0lBOENsRCxZQUFvQixPQUFtQixFQUFVLFNBQW9CLEVBQVUsSUFBWTtRQUN2RixLQUFLLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRFYsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFRO1FBckMzRjs7OztXQUlHO1FBQ00sY0FBUyxHQUFXLEVBQUUsQ0FBQztRQUNoQzs7V0FFRztRQUNNLFVBQUssR0FBVyxHQUFHLENBQUM7UUFDN0I7O1dBRUc7UUFDZ0IsV0FBTSxHQUErQixJQUFJLFlBQVksRUFBZ0IsQ0FBQztRQUN6Rjs7OztXQUlHO1FBQ2dCLG1CQUFjLEdBQXlCLElBQUksWUFBWSxFQUFVLENBQUM7UUFnQjdFLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGlCQUFZLEdBQVksS0FBSyxDQUFDLENBQUMsbUJBQW1CO0lBRzFELENBQUM7SUFFRCxXQUFXLENBQUMsT0FBc0I7UUFDOUIsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMzQixNQUFNLFdBQVcsR0FBaUIsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFD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aW1wb3J0IHsgQ29tcG9uZW50LCBDb250ZW50Q2hpbGQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE5nWm9uZSwgT3V0cHV0LCBSZW5kZXJlcjIsIFNpbXBsZUNoYW5nZSwgU2ltcGxlQ2hhbmdlcywgVGVtcGxhdGVSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVGlCYXNlQ29tcG9uZW50IH0gZnJvbSAnQGNsb3VkL3RpbnkzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHBBbmNob3JJdGVtIHtcclxuICAgIC8qIHRzbGludDpkaXNhYmxlOm5vLXJlZHVuZGFudC1qc2RvYyAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva5pZO+8jOWvueW6lOmhtemdouS4reiBlOWKqOeahERPTeWFg+e0oGlkO1xyXG4gICAgICovXHJcbiAgICBpZDogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7mlofmnKw7XHJcbiAgICAgKi9cclxuICAgIHRpdGxlPzogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiDlhYHorrjmnInlpJrkvZnnmoTlsZ7mgKflrZfmrrVcclxuICAgICAqL1xyXG4gICAgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnk7XHJcbn1cclxuLyoqXHJcbiAqIOWumuS9jeWvvOiIque7hOS7tlxyXG4gKlxyXG4gKiA8ZXhhbXBsZS11cmw+Li4vdGlueXBsdXMzZGVtby8jL2FuY2hvci9hbmNob3ItYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICd0cC1hbmNob3InLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL2FuY2hvci5odG1sJyxcclxuICAgIHN0eWxlVXJsczogWycuL2FuY2hvci5sZXNzJ10sXHJcbiAgICBob3N0OiB7XHJcbiAgICAgICAgJ1tjbGFzcy50cC1hbmNob3ItY29udGFpbmVyXSc6ICd0cnVlJ1xyXG4gICAgfVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIFRwQW5jaG9yQ29tcG9uZW50IGV4dGVuZHMgVGlCYXNlQ29tcG9uZW50IHtcclxuICAgIC8qKlxyXG4gICAgICog57uE5Lu25pWw5o2uXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGl0ZW1zOiBBcnJheTxUcEFuY2hvckl0ZW0+O1xyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7opoHot7PovazliLDnmoTnm67moIfplJrngrnlhYPntKBpZO+8jOWvueW6lOmhtemdouS4reiBlOWKqOeahERPTeWFg+e0oGlkXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGFuY2hvcklkOiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIOiuvue9rumUmueCueWvueW6lERvbeWFg+e0oOi3neeql+WPo+mhtumDqOi3neemu++8jOeCueWHu+WIh+aNoumUmueCueaXtu+8jOmhtemdoua7keWKqOWcqOWIsOi+vuivpeWAvOaXtu+8jOWIh+aNouWIsOWvueW6lOmUmueCuVxyXG4gICAgICpcclxuICAgICAqIDxiPuazqO+8mjwvYj7pgJrov4fmu5rova7mu5rliqjml7bvvIzlvZPpobbpg6jot53nprvlsI/kuo7orr7nva7nmoRvZmZzZXRUb3DlgLzvvIzliIfmjaLliLDlr7nlupTplJrngrlcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgb2Zmc2V0VG9wOiBudW1iZXIgPSA1MDtcclxuICAgIC8qKlxyXG4gICAgICog6K6+572u55So5oi354K55Ye76ZSa54K55pe277yM6aG16Z2i5ruR5Yqo6YCf5bqm77yM5YW25Y2V5L2N5Li6bXNcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgc3BlZWQ6IG51bWJlciA9IDMwMDtcclxuICAgIC8qKlxyXG4gICAgICog6Lez6L2s5Yiw6K+l6ZSa54K55pe277yM6Kem5Y+R5LqL5Lu2XHJcbiAgICAgKi9cclxuICAgIEBPdXRwdXQoKSByZWFkb25seSBzZWxlY3Q6IEV2ZW50RW1pdHRlcjxUcEFuY2hvckl0ZW0+ID0gbmV3IEV2ZW50RW1pdHRlcjxUcEFuY2hvckl0ZW0+KCk7XHJcbiAgICAvKipcclxuICAgICAqIOmUmueCuWlk5pS55Y+Y5LqL5Lu277yM55So5LqO5a6e546w6ZSa54K5aWTlj4zlkJHnu5HlrprvvIzkuZ/lj6/ljZXni6zkvb/nlKhcclxuICAgICAqXHJcbiAgICAgKiAxMC4wLjQvOS4wLjjmlrDlop7mjqXlj6NcclxuICAgICAqL1xyXG4gICAgQE91dHB1dCgpIHJlYWRvbmx5IGFuY2hvcklkQ2hhbmdlOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDojrflj5bliLDnlKjmiLfoh6rlrprkuYnnmoTmqKHmnb9cclxuICAgICAqL1xyXG4gICAgQENvbnRlbnRDaGlsZCgnaXRlbScsIHsgc3RhdGljOiB0cnVlIH0pIGl0ZW1UZW1wbGV0ZTogVGVtcGxhdGVSZWY8YW55PjtcclxuICAgIHByaXZhdGUgdW5saXN0ZW5TY3JvbGw6ICgpID0+IHZvaWQ7XHJcbiAgICAvKipcclxuICAgICAqIOaYr+WQpue7hOS7tuWGhemDqOinpuWPkXNjcm9sbOS6i+S7tlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGlzSW5uZXJTY3JvbGxpbmc6IGJvb2xlYW47XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOS/neWtmOe7hOS7tuWGhemDqOabtOaUueWQjueahOmUmueCuWlkXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBjdXJyZW50SWQ6IHN0cmluZztcclxuICAgIHByaXZhdGUgaGFzR29hbmNob3I6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgaGFzQW5pbWF0aW9uOiBib29sZWFuID0gZmFsc2U7IC8vIOWIneWni+WMluWPiuaVsOaNruabtOaWsOaXtu+8jOaXoOmcgOW5s+a7kea7muWKqFxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBlbGVtZW50OiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcmVyMjogUmVuZGVyZXIyLCBwcml2YXRlIHpvbmU6IE5nWm9uZSkge1xyXG4gICAgICAgIHN1cGVyKGVsZW1lbnQsIHJlbmRlcmVyMik7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIHN1cGVyLm5nT25DaGFuZ2VzKGNoYW5nZXMpO1xyXG4gICAgICAgIGNvbnN0IGFuY2hvcklkT2JqOiBTaW1wbGVDaGFuZ2UgPSBjaGFuZ2VzWydhbmNob3JJZCddO1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zT2JqOiBTaW1wbGVDaGFuZ2UgPSBjaGFuZ2VzWydpdGVtcyddO1xyXG4gICAgICAgIGlmIChhbmNob3JJZE9iaiAmJiBhbmNob3JJZE9iai5jdXJyZW50VmFsdWUgJiYgIWFuY2hvcklkT2JqLmlzRmlyc3RDaGFuZ2UoKSAmJiB0aGlzLmFuY2hvcklkICE9PSB0aGlzLmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgICB0aGlzLmhhc0dvYW5jaG9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMuaGFzQW5pbWF0aW9uID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGl0ZW1zT2JqICYmIGl0ZW1zT2JqLmN1cnJlbnRWYWx1ZSAmJiAhaXRlbXNPYmouaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGFzR29hbmNob3IgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgICAgICAvLyDnm5HlkKzmu5rova7kuovku7ZcclxuICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnVubGlzdGVuU2Nyb2xsID0gdGhpcy5yZW5kZXJlcjIubGlzdGVuKHdpbmRvdywgJ3Njcm9sbCcsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25XaW5kb3dTY3JvbGwoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdDaGVja2VkKCk6IHZvaWQge1xyXG4gICAgICAgIHN1cGVyLm5nQWZ0ZXJWaWV3Q2hlY2tlZCgpO1xyXG4gICAgICAgIC8vIOaVsOaNruabtOaWsGFuY2hvcklk5pyJ5YC85pe277yM6ZyA6KaB5rua5Yqo6aG16Z2i5Yiw5oyH5a6a5L2N572u77yM5Y+q6Kem5Y+R5LiA5qyhXHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc0dvYW5jaG9yKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGFzR29hbmNob3IgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmdvVG9BbmNob3IodGhpcy5hbmNob3JJZCB8fCB0aGlzLml0ZW1zICYmIHRoaXMuaXRlbXNbMF0gJiYgdGhpcy5pdGVtc1swXS5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIHN1cGVyLm5nT25EZXN0cm95KCk7XHJcbiAgICAgICAgaWYgKHRoaXMudW5saXN0ZW5TY3JvbGwpIHtcclxuICAgICAgICAgICAgdGhpcy51bmxpc3RlblNjcm9sbCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDpobXpnaLmu5rliqjml7bvvIznm7jlupTplJrngrnpq5jkuq5cclxuICAgIHByaXZhdGUgb25XaW5kb3dTY3JvbGwoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNJbm5lclNjcm9sbGluZykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcDogbnVtYmVyID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7XHJcbiAgICAgICAgY29uc3QgaXRlbUxlbmd0aDogbnVtYmVyID0gdGhpcy5pdGVtcyAmJiB0aGlzLml0ZW1zLmxlbmd0aDtcclxuICAgICAgICAvLyDpobXpnaLmu5rliqjml7bvvIzplJrngrnlr7nlupREb23lhYPntKDot53mtY/op4jlmajnqpflj6Ppobbpg6jpq5jluqblsI/kuo7nrYnkuo7miYDphY3nva7nmoTpobbpg6jlgY/np7vph4/vvIzliJnlupTmmK/lvZPliY3plJrngrlcclxuICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSBpdGVtTGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICAgICAgY29uc3QgYW5jaG9yRWxlOiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaXRlbXNbaV0uaWQpO1xyXG4gICAgICAgICAgICAvLyDliKTmlq3mnInml6DlvZPliY3mv4DmtLvplJrngrnvvIzkvb/nlKjmiLfngrnlh7vml7bvvIzlj6rlvZPliY3plJrngrnpq5jkuq7vvJvogIzmu5rliqjml7bvvIznm7jlr7nlupTplJrngrnpg73pq5jkuq5cclxuICAgICAgICAgICAgaWYgKGFuY2hvckVsZSAmJiBhbmNob3JFbGUub2Zmc2V0VG9wKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjbGllbnRZOiBudW1iZXIgPSBhbmNob3JFbGUub2Zmc2V0VG9wIC0gc2Nyb2xsVG9wIC0gdGhpcy5vZmZzZXRUb3A7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZDogc3RyaW5nID0gdGhpcy5hbmNob3JJZDtcclxuICAgICAgICAgICAgICAgIGlmIChjbGllbnRZIDw9IHRoaXMub2Zmc2V0VG9wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYW5jaG9ySWQgPSB0aGlzLmN1cnJlbnRJZCA9IHRoaXMuaXRlbXNbaV0uaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOmUmueCueaUueWPmOaXtu+8jOS7heWQkeWklumAmuefpeS4gOasoVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5hbmNob3JJZCAhPT0gaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0LmVtaXQodGhpcy5pdGVtc1tpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFuY2hvcklkQ2hhbmdlLmVtaXQodGhpcy5pdGVtc1tpXS5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9uQ2xpY2soaXRlbTogVHBBbmNob3JJdGVtKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5oYXNBbmltYXRpb24gPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuZ29Ub0FuY2hvcihpdGVtLmlkKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOmhtemdoua7muWKqOWIsOebruagh+mUmueCueWvueW6lOS9jee9rlxyXG4gICAgICogQHBhcmFtIGFuY2hvcklkIOmUmueCuWlkXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgZ29Ub0FuY2hvcihhbmNob3JJZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5pc0lubmVyU2Nyb2xsaW5nID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCB0YXJnZXRFbGU6IEhUTUxFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYW5jaG9ySWQpO1xyXG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcDogbnVtYmVyID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7XHJcbiAgICAgICAgY29uc3Qgc2NvbGxQb3NpdGlvbjogbnVtYmVyID0gdGFyZ2V0RWxlICYmIHRhcmdldEVsZS5vZmZzZXRUb3AgLSB0aGlzLm9mZnNldFRvcDtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5Yid5aeL5YyW5Y+K5pWw5o2u5pu05paw5pe277yM6aG16Z2i55u05o6l5rua5Yqo5Yiw5a6a5L2N5L2N572u77ybXHJcbiAgICAgICAgICog54K55Ye76ZSa54K55YiH5o2i5Y+K55So5oi35Yqo5oCB5pS55Y+Y5b2T5YmN6ZSa54K5aWTml7bvvIzmu5rliqjmnaHlubPmu5Hov5DliqjjgIJcclxuICAgICAgICAgKi9cclxuICAgICAgICBpZiAodGhpcy5oYXNBbmltYXRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5zY3JvbGxBbmltYXRpb24oc2Nyb2xsVG9wLCBzY29sbFBvc2l0aW9uLCBhbmNob3JJZCwgdGhpcy5zcGVlZCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8g5L+u5pS55LqG5b2T5YmN6auY5Lqu6ZSa54K577yM5L2/55Soc2V0VGltZW91dO+8jOa2iOmZpEV4cHJlc3Npb25DaGFuZ2VkQWZ0ZXJJdEhhc0JlZW5DaGVja2VkRXJyb3LmiqXplJlcclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvVmlldyhzY29sbFBvc2l0aW9uLCBhbmNob3JJZCk7XHJcbiAgICAgICAgICAgIH0sIDApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDmu5rliqjmnaHlubPmu5Hov5DliqhcclxuICAgIHByaXZhdGUgc2Nyb2xsQW5pbWF0aW9uKGN1cnJlbnRZOiBudW1iZXIsIHRhcmdldFk6IG51bWJlciwgYW5jaG9ySWQ6IHN0cmluZywgc3BlZWQ/OiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBkaXJlY3Rpb246IG51bWJlciA9IHRhcmdldFkgLSBjdXJyZW50WSA+IDAgPyAxIDogLTE7XHJcbiAgICAgICAgbGV0IGRpc3RhbmNlOiBudW1iZXIgPSBNYXRoLmFicyh0YXJnZXRZIC0gY3VycmVudFkpOyAgLy8g5rua5Yqo5p2h6ZyA6KaB5rua5Yqo55qE6Led56a7XHJcbiAgICAgICAgY29uc3Qgc3RlcFRpbWVzOiBudW1iZXIgPSBzcGVlZCAvICgxMDAwIC8gNjApOyAvLyDkuIDoiKzmtY/op4jlmajliLfmlrDpopHnjofmmK82MEha77yM5pe26Ze06Ze06ZqU5Li6MTAwMG1zLzYw77yM5oC75bin5pWwXHJcbiAgICAgICAgbGV0IHN0ZXBEaXN0OiBudW1iZXIgPSBkaXN0YW5jZSAvIHN0ZXBUaW1lczsgLy8g5q+P5bin5rua5Yqo5p2h5rua5Yqo6Led56a7XHJcblxyXG4gICAgICAgIGlmICh0YXJnZXRZICE9PSBjdXJyZW50WSkge1xyXG4gICAgICAgICAgICBzdGVwRGlzdCAqPSBkaXJlY3Rpb247XHJcbiAgICAgICAgICAgIC8vIOWumuaXtuWZqO+8jDEwMDAvNjBtc+aXtumXtOmXtOmalCDmiafooYzkuIDmrKFcclxuICAgICAgICAgICAgbGV0IHBvc2l0aW9uWTogbnVtYmVyID0gY3VycmVudFk7XHJcbiAgICAgICAgICAgIGxldCB0aW1lcjogYW55ID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcG9zaXRpb25ZID0gcG9zaXRpb25ZICsgc3RlcERpc3Q7XHJcbiAgICAgICAgICAgICAgICBkaXN0YW5jZSAtPSBNYXRoLmFicyhzdGVwRGlzdCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPD0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGltZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRpbWVyID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9WaWV3KHRhcmdldFksIGFuY2hvcklkKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhc0FuaW1hdGlvbiA9IGZhbHNlOyAvLyDmm7TmlrBoYXNBbmltYXRpb25cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIHBvc2l0aW9uWSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDEwMDAgLyA2MCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOmhtemdouWumuS9jeWIsOaMh+WumuS9jee9ru+8jOaXoOa7muWKqOaViOaenFxyXG4gICAgcHJpdmF0ZSBzY3JvbGxUb1ZpZXcodGFyZ2V0OiBudW1iZXIsIGFuY2hvcklkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgdGFyZ2V0KTsgLy8g5qiq5ZCR5Z2Q5qCH5LiN56e75YqoXHJcbiAgICAgICAgdGhpcy5nZXRDdXJyZW50QW5jaG9yKGFuY2hvcklkKTtcclxuICAgICAgICB0aGlzLmlzSW5uZXJTY3JvbGxpbmcgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDpobXpnaLmu5rliqjliLDmjIflrprkvY3nva7kuYvlkI7vvIzlkJHlpJbpgJrnn6XlvZPliY3plJrngrnmlbDmja5cclxuICAgIHByaXZhdGUgZ2V0Q3VycmVudEFuY2hvcihhbmNob3JJZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5hbmNob3JJZCA9IHRoaXMuY3VycmVudElkID0gYW5jaG9ySWQ7XHJcbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHRoaXMuaXRlbXMpIHtcclxuICAgICAgICAgICAgaWYgKGl0ZW0uaWQgPT09IGFuY2hvcklkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdC5lbWl0KGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hbmNob3JJZENoYW5nZS5lbWl0KGl0ZW0uaWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==