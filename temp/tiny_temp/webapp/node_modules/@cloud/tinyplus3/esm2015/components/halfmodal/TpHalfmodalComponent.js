import { Component, ElementRef, EventEmitter, Input, Output, Renderer2 } from '@angular/core';
import { TiBaseComponent, Util, TiKeymap } from '@cloud/tiny3';
/**
 * 右侧半屏弹窗组件
 *
 * 半屏弹窗分为两种，1.不带灰色背景层，点击弹窗外会关闭弹窗；2.带灰色背景层，点击弹窗外不能关闭弹窗。
 *
 * 两种弹窗都可以通过点击右上角“X”图标或者hide()方法关闭弹窗
 *
 * 注：第一类弹窗，点击弹窗外关闭的原理是在document上注册点击事件触发`TpHalfmodalComponent.hide()`，如果不想关闭弹窗可以阻止事件冒泡。
 *
 * <example-url>../tinyplus3demo/#/halfmodal/halfmodal-all</example-url>
 */
export class TpHalfmodalComponent extends TiBaseComponent {
    constructor(elementRef, renderer2) {
        super(elementRef, renderer2);
        this.elementRef = elementRef;
        this.renderer2 = renderer2;
        /**
         * 10.0.2新增
         *
         * 是否含有遮罩层，默认没有遮罩层；
         */
        this.backdrop = false;
        /**
         * 10.1.3新增
         * 弹窗顶部距窗口顶部的距离
         */
        this.clientRectTop = '50px';
        /**
         * 10.1.3新增
         * 是否显示关闭图标
         */
        this.closeIcon = true;
        /**
         * 10.1.3新增
         * 关闭前的事件接口，如果监听beforeHide，则由业务关闭弹窗
         */
        this.beforeHide = new EventEmitter();
        /**
         * @ignore
         */
        this.isShow = false;
        this.isWantShow = false;
        // 可聚焦元素
        this.focusableElementsString = `a[href], area[href], input:not([disabled]):not([tabindex=\'-1\']),
    button:not([disabled]):not([tabindex=\'-1\']),select:not([disabled]):not([tabindex=\'-1\']),
    textarea:not([disabled]):not([tabindex=\'-1\']),
    iframe, object, embed, *[tabindex]:not([tabindex=\'-1\']), *[contenteditable=true]`;
    }
    /**
     * @description 向上查找最近的指定祖先元素
     * @param ele 子元素
     * @param parentNode 祖先元素标签名
     * @return 找到的祖先元素或者undefined
     */
    static findClosest(ele, parentNodeName) {
        if (ele.nodeName === 'HTML' || Util.isNull(ele.parentNode)) {
            return undefined;
        }
        else if (ele.parentNode.nodeName === parentNodeName) {
            return ele.parentNode;
        }
        else {
            return this.findClosest(ele.parentNode, parentNodeName);
        }
    }
    /**
     * 弹窗显示事件
     * @param element 通过事件触发halfModal显示的元素
     *
     * 10.1.3版本前，如果完全是通过JS调用打开半屏弹窗，则不需该参数，点击弹窗外任意位置会关闭弹窗
     * 10.1.3及以上不需要参数
     */
    show(element) {
        this.isShow = true;
        this.isWantShow = true;
        this.renderer2.addClass(this.nativeElement, 'tp-halfmodal-animation');
        if (this.backdrop && !this.backdropEle) {
            this.backdropEle = this.renderer2.createElement('div');
            this.renderer2.addClass(this.backdropEle, 'tp-halfmodal-backdrop');
            this.renderer2.appendChild(document.body, this.backdropEle);
            // 防止多次打开半屏弹窗的时候，事件注册多次。
            if (!this.unListenDocumentKeydown) {
                this.unListenDocumentKeydown = this.renderer2.listen(document, 'keydown', (event) => {
                    switch (event.which) {
                        case TiKeymap.KEY_TAB: // tab键用于处理在提示框内循环获取焦点
                            this.clickTab(event);
                            break;
                        default:
                            break;
                    }
                });
            }
        }
        else {
            if (!this.unlistenClick) {
                this.unlistenClick = this.renderer2.listen(document, 'click', ($event) => {
                    if (element && element.contains($event.target) || this.isWantShow) {
                        this.isWantShow = false;
                        return;
                    }
                    if (TpHalfmodalComponent.findClosest($event.target, 'TI-MESSAGE') || TpHalfmodalComponent.findClosest($event.target, 'TI-MODAL-WRAPPER')) {
                        return;
                    }
                    // 判断鼠标是否在弹窗范围内
                    if (document.documentElement.clientWidth - $event.clientX > this.nativeElement.offsetWidth
                        || document.documentElement.clientHeight - $event.clientY > this.nativeElement.offsetHeight) {
                        this.wantHide();
                    }
                });
            }
        }
    }
    clickTab(event) {
        const introModal = document.querySelector('.tp-halfmodal-animation');
        const focusableElements = introModal === null || introModal === void 0 ? void 0 : introModal.querySelectorAll(this.focusableElementsString);
        Util.focusInDialogOnTabchange(event, focusableElements);
    }
    /**
     * @ignore
     * 即将关闭，如果监听beforeHide，则由业务关闭弹窗
     */
    wantHide() {
        if (this.beforeHide.observers.length > 0) {
            this.beforeHide.emit(this);
        }
        else {
            this.hide();
        }
    }
    /**
     * 10.0.2对外提供
     *
     * 弹窗隐藏事件
     */
    hide() {
        this.hideBackdrop();
        this.isShow = false;
        if (this.unlistenClick) {
            this.unlistenClick();
            this.unlistenClick = undefined;
        }
    }
    hideBackdrop() {
        if (this.backdropEle) {
            this.renderer2.removeChild(document.body, this.backdropEle);
            this.backdropEle = undefined;
        }
    }
    ngOnDestroy() {
        this.hideBackdrop();
        if (this.unlistenClick) {
            this.unlistenClick();
            this.unlistenClick = undefined;
        }
        if (this.unListenDocumentKeydown) {
            this.unListenDocumentKeydown();
            this.unListenDocumentKeydown = undefined;
        }
    }
}
TpHalfmodalComponent.decorators = [
    { type: Component, args: [{
                selector: 'tp-halfmodal',
                template: "\r\n<div *ngIf=\"isShow\" style=\"height: 100%\">\r\n    <tp-icon local tiOutline name=\"cloud-close\"\r\n        *ngIf=\"closeIcon\"\r\n        class=\"tp-halfmodal-close\"\r\n        (click)=\"wantHide()\" [id]=\"appendId('halfmodal_close')\" [attr.tabindex]=\"0\" (keydown.enter)=\"hide()\"></tp-icon>\r\n    <div class=\"tp-halfmodal-cotent\">\r\n        <ng-content></ng-content>\r\n    </div>\r\n</div>",
                host: {
                    '[style.width]': 'width',
                    '[style.top]': 'clientRectTop',
                    '[style.right]': 'width ? "-" + width : "-600px"',
                    '[hidden]': '!isShow'
                },
                styles: [".ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}::ng-deep :root{--tp-halfmodal-content-space:var(--ti-common-space-2x);--tp-halfmodal-space:var(--ti-common-space-8x);--tp-halfmodal-width:600px}:host{-ms-box-sizing:border-box;background-color:var(--ti-common-color-bg-white-normal);bottom:0;box-shadow:var(--ti-common-shadow-4-left);box-sizing:border-box;overflow-y:auto;padding:var(--tp-halfmodal-space);position:fixed;width:var(--tp-halfmodal-width);z-index:999}:host .tp-halfmodal-close{cursor:pointer;position:absolute;right:20px;top:20px}:host .tp-halfmodal-close:hover{color:var(--ti-common-color-icon-hover)}:host .tp-halfmodal-cotent{height:100%;padding-right:var(--tp-halfmodal-content-space)}::ng-deep.tp-halfmodal-backdrop{background-color:var(--ti-modal-backdrop-bg-color);bottom:0;box-sizing:border-box;left:0;opacity:.2;position:fixed;right:0;top:0;z-index:998}::ng-deep.tp-halfmodal-animation{animation:show .25s forwards}@keyframes show{to{right:0}}"]
            },] }
];
TpHalfmodalComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
TpHalfmodalComponent.propDecorators = {
    width: [{ type: Input }],
    backdrop: [{ type: Input }],
    clientRectTop: [{ type: Input }],
    closeIcon: [{ type: Input }],
    beforeHide: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBIYWxmbW9kYWxDb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueXBsdXMzL2NvbXBvbmVudHMvaGFsZm1vZGFsL1RwSGFsZm1vZGFsQ29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5RixPQUFPLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDL0Q7Ozs7Ozs7Ozs7R0FVRztBQWFILE1BQU0sT0FBTyxvQkFBcUIsU0FBUSxlQUFlO0lBQ3JELFlBQXNCLFVBQXNCLEVBQVksU0FBb0I7UUFDeEUsS0FBSyxDQUFDLFVBQVUsRUFBRSxTQUFTLENBQUMsQ0FBQztRQURYLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBWSxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBTzVFOzs7O1dBSUc7UUFDTSxhQUFRLEdBQVksS0FBSyxDQUFDO1FBQ25DOzs7V0FHRztRQUNNLGtCQUFhLEdBQVcsTUFBTSxDQUFDO1FBQ3hDOzs7V0FHRztRQUNNLGNBQVMsR0FBWSxJQUFJLENBQUM7UUFDbkM7OztXQUdHO1FBQ2dCLGVBQVUsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUMzRTs7V0FFRztRQUNJLFdBQU0sR0FBWSxLQUFLLENBQUM7UUFFdkIsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUtwQyxRQUFRO1FBQ0EsNEJBQXVCLEdBQVc7Ozt1RkFHeUMsQ0FBQztJQXhDcEYsQ0FBQztJQTJDRDs7Ozs7T0FLRztJQUNLLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBUSxFQUFFLGNBQXNCO1FBQ3ZELElBQUksR0FBRyxDQUFDLFFBQVEsS0FBSyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FB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Q0FBQyx1QkFBdUIsRUFBRSxDQUFDO1lBQy9CLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxTQUFTLENBQUM7U0FDNUM7SUFDTCxDQUFDOzs7WUF6S0osU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxjQUFjO2dCQUN4QixvYUFBK0I7Z0JBRS9CLElBQUksRUFBRTtvQkFDRixlQUFlLEVBQUUsT0FBTztvQkFDeEIsYUFBYSxFQUFFLGVBQWU7b0JBQzlCLGVBQWUsRUFBRSxnQ0FBZ0M7b0JBQ2pELFVBQVUsRUFBRSxTQUFTO2lCQUN4Qjs7YUFDSjs7O1lBdkJtQixVQUFVO1lBQStCLFNBQVM7OztvQkFnQ2pFLEtBQUs7dUJBTUwsS0FBSzs0QkFLTCxLQUFLO3dCQUtMLEtBQUs7eUJBS0wsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0LCBSZW5kZXJlcjIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVGlCYXNlQ29tcG9uZW50LCBVdGlsLCBUaUtleW1hcCB9IGZyb20gJ0BjbG91ZC90aW55Myc7XHJcbi8qKlxyXG4gKiDlj7PkvqfljYrlsY/lvLnnqpfnu4Tku7ZcclxuICpcclxuICog5Y2K5bGP5by556qX5YiG5Li65Lik56eN77yMMS7kuI3luKbngbDoibLog4zmma/lsYLvvIzngrnlh7vlvLnnqpflpJbkvJrlhbPpl63lvLnnqpfvvJsyLuW4pueBsOiJsuiDjOaZr+Wxgu+8jOeCueWHu+W8ueeql+WkluS4jeiDveWFs+mXreW8ueeql+OAglxyXG4gKlxyXG4gKiDkuKTnp43lvLnnqpfpg73lj6/ku6XpgJrov4fngrnlh7vlj7PkuIrop5LigJxY4oCd5Zu+5qCH5oiW6ICFaGlkZSgp5pa55rOV5YWz6Zet5by556qXXHJcbiAqXHJcbiAqIOazqO+8muesrOS4gOexu+W8ueeql++8jOeCueWHu+W8ueeql+WkluWFs+mXreeahOWOn+eQhuaYr+WcqGRvY3VtZW505LiK5rOo5YaM54K55Ye75LqL5Lu26Kem5Y+RYFRwSGFsZm1vZGFsQ29tcG9uZW50LmhpZGUoKWDvvIzlpoLmnpzkuI3mg7PlhbPpl63lvLnnqpflj6/ku6XpmLvmraLkuovku7blhpLms6HjgIJcclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnlwbHVzM2RlbW8vIy9oYWxmbW9kYWwvaGFsZm1vZGFsLWFsbDwvZXhhbXBsZS11cmw+XHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAndHAtaGFsZm1vZGFsJyxcclxuICAgIHRlbXBsYXRlVXJsOiAnLi9oYWxmbW9kYWwuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi9oYWxmbW9kYWwubGVzcyddLFxyXG4gICAgaG9zdDoge1xyXG4gICAgICAgICdbc3R5bGUud2lkdGhdJzogJ3dpZHRoJyxcclxuICAgICAgICAnW3N0eWxlLnRvcF0nOiAnY2xpZW50UmVjdFRvcCcsXHJcbiAgICAgICAgJ1tzdHlsZS5yaWdodF0nOiAnd2lkdGggPyBcIi1cIiArIHdpZHRoIDogXCItNjAwcHhcIicsXHJcbiAgICAgICAgJ1toaWRkZW5dJzogJyFpc1Nob3cnXHJcbiAgICB9XHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgVHBIYWxmbW9kYWxDb21wb25lbnQgZXh0ZW5kcyBUaUJhc2VDb21wb25lbnQge1xyXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByb3RlY3RlZCByZW5kZXJlcjI6IFJlbmRlcmVyMikge1xyXG4gICAgICAgIHN1cGVyKGVsZW1lbnRSZWYsIHJlbmRlcmVyMik7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruW8ueeql+WuveW6plxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSB3aWR0aDogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiAxMC4wLjLmlrDlop5cclxuICAgICAqXHJcbiAgICAgKiDmmK/lkKblkKvmnInpga7nvanlsYLvvIzpu5jorqTmsqHmnInpga7nvanlsYLvvJtcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgYmFja2Ryb3A6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIC8qKlxyXG4gICAgICogMTAuMS4z5paw5aKeXHJcbiAgICAgKiDlvLnnqpfpobbpg6jot53nqpflj6Ppobbpg6jnmoTot53nprtcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgY2xpZW50UmVjdFRvcDogc3RyaW5nID0gJzUwcHgnO1xyXG4gICAgLyoqXHJcbiAgICAgKiAxMC4xLjPmlrDlop5cclxuICAgICAqIOaYr+WQpuaYvuekuuWFs+mXreWbvuagh1xyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBjbG9zZUljb246IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgLyoqXHJcbiAgICAgKiAxMC4xLjPmlrDlop5cclxuICAgICAqIOWFs+mXreWJjeeahOS6i+S7tuaOpeWPo++8jOWmguaenOebkeWQrGJlZm9yZUhpZGXvvIzliJnnlLHkuJrliqHlhbPpl63lvLnnqpdcclxuICAgICAqL1xyXG4gICAgQE91dHB1dCgpIHJlYWRvbmx5IGJlZm9yZUhpZGU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGlzU2hvdzogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIHByaXZhdGUgaXNXYW50U2hvdzogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIHByaXZhdGUgdW5saXN0ZW5DbGljazogKCkgPT4gdm9pZDtcclxuICAgIC8vIOiDjOaZr+mBrue9qeWxguWFg+e0oFxyXG4gICAgcHJpdmF0ZSBiYWNrZHJvcEVsZTogRWxlbWVudDtcclxuICAgIC8vIOWPr+iBmueEpuWFg+e0oFxyXG4gICAgcHJpdmF0ZSBmb2N1c2FibGVFbGVtZW50c1N0cmluZzogc3RyaW5nID0gYGFbaHJlZl0sIGFyZWFbaHJlZl0sIGlucHV0Om5vdChbZGlzYWJsZWRdKTpub3QoW3RhYmluZGV4PVxcJy0xXFwnXSksXHJcbiAgICBidXR0b246bm90KFtkaXNhYmxlZF0pOm5vdChbdGFiaW5kZXg9XFwnLTFcXCddKSxzZWxlY3Q6bm90KFtkaXNhYmxlZF0pOm5vdChbdGFiaW5kZXg9XFwnLTFcXCddKSxcclxuICAgIHRleHRhcmVhOm5vdChbZGlzYWJsZWRdKTpub3QoW3RhYmluZGV4PVxcJy0xXFwnXSksXHJcbiAgICBpZnJhbWUsIG9iamVjdCwgZW1iZWQsICpbdGFiaW5kZXhdOm5vdChbdGFiaW5kZXg9XFwnLTFcXCddKSwgKltjb250ZW50ZWRpdGFibGU9dHJ1ZV1gO1xyXG4gICAgcHJpdmF0ZSB1bkxpc3RlbkRvY3VtZW50S2V5ZG93bjogKCkgPT4gdm9pZDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEBkZXNjcmlwdGlvbiDlkJHkuIrmn6Xmib7mnIDov5HnmoTmjIflrprnpZblhYjlhYPntKBcclxuICAgICAqIEBwYXJhbSBlbGUg5a2Q5YWD57SgXHJcbiAgICAgKiBAcGFyYW0gcGFyZW50Tm9kZSDnpZblhYjlhYPntKDmoIfnrb7lkI1cclxuICAgICAqIEByZXR1cm4g5om+5Yiw55qE56WW5YWI5YWD57Sg5oiW6ICFdW5kZWZpbmVkXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIGZpbmRDbG9zZXN0KGVsZTogYW55LCBwYXJlbnROb2RlTmFtZTogc3RyaW5nKTogRWxlbWVudCB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgaWYgKGVsZS5ub2RlTmFtZSA9PT0gJ0hUTUwnIHx8IFV0aWwuaXNOdWxsKGVsZS5wYXJlbnROb2RlKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZWxlLnBhcmVudE5vZGUubm9kZU5hbWUgPT09IHBhcmVudE5vZGVOYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBlbGUucGFyZW50Tm9kZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maW5kQ2xvc2VzdChlbGUucGFyZW50Tm9kZSwgcGFyZW50Tm9kZU5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOW8ueeql+aYvuekuuS6i+S7tlxyXG4gICAgICogQHBhcmFtIGVsZW1lbnQg6YCa6L+H5LqL5Lu26Kem5Y+RaGFsZk1vZGFs5pi+56S655qE5YWD57SgXHJcbiAgICAgKlxyXG4gICAgICogMTAuMS4z54mI5pys5YmN77yM5aaC5p6c5a6M5YWo5piv6YCa6L+HSlPosIPnlKjmiZPlvIDljYrlsY/lvLnnqpfvvIzliJnkuI3pnIDor6Xlj4LmlbDvvIzngrnlh7vlvLnnqpflpJbku7vmhI/kvY3nva7kvJrlhbPpl63lvLnnqpdcclxuICAgICAqIDEwLjEuM+WPiuS7peS4iuS4jemcgOimgeWPguaVsFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2hvdyhlbGVtZW50PzogRWxlbWVudCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaXNTaG93ID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmlzV2FudFNob3cgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIyLmFkZENsYXNzKHRoaXMubmF0aXZlRWxlbWVudCwgJ3RwLWhhbGZtb2RhbC1hbmltYXRpb24nKTtcclxuICAgICAgICBpZiAodGhpcy5iYWNrZHJvcCAmJiAhdGhpcy5iYWNrZHJvcEVsZSkge1xyXG4gICAgICAgICAgICB0aGlzLmJhY2tkcm9wRWxlID0gdGhpcy5yZW5kZXJlcjIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIyLmFkZENsYXNzKHRoaXMuYmFja2Ryb3BFbGUsICd0cC1oYWxmbW9kYWwtYmFja2Ryb3AnKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlcjIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuYm9keSwgdGhpcy5iYWNrZHJvcEVsZSk7XHJcbiAgICAgICAgICAgIC8vIOmYsuatouWkmuasoeaJk+W8gOWNiuWxj+W8ueeql+eahOaXtuWAme+8jOS6i+S7tuazqOWGjOWkmuasoeOAglxyXG4gICAgICAgICAgICBpZiAoIXRoaXMudW5MaXN0ZW5Eb2N1bWVudEtleWRvd24pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudW5MaXN0ZW5Eb2N1bWVudEtleWRvd24gPSB0aGlzLnJlbmRlcmVyMi5saXN0ZW4oZG9jdW1lbnQsICdrZXlkb3duJywgKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChldmVudC53aGljaCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFRpS2V5bWFwLktFWV9UQUI6IC8vIHRhYumUrueUqOS6juWkhOeQhuWcqOaPkOekuuahhuWGheW+queOr+iOt+WPlueEpueCuVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGlja1RhYihldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLnVubGlzdGVuQ2xpY2spIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudW5saXN0ZW5DbGljayA9IHRoaXMucmVuZGVyZXIyLmxpc3Rlbihkb2N1bWVudCwgJ2NsaWNrJywgKCRldmVudDogTW91c2VFdmVudCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuY29udGFpbnMoJGV2ZW50LnRhcmdldCBhcyBOb2RlKSB8fCB0aGlzLmlzV2FudFNob3cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1dhbnRTaG93ID0gZmFsc2U7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChUcEhhbGZtb2RhbENvbXBvbmVudC5maW5kQ2xvc2VzdCgkZXZlbnQudGFyZ2V0LCAnVEktTUVTU0FHRScpIHx8IFRwSGFsZm1vZGFsQ29tcG9uZW50LmZpbmRDbG9zZXN0KCRldmVudC50YXJnZXQsICdUSS1NT0RBTC1XUkFQUEVSJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyDliKTmlq3pvKDmoIfmmK/lkKblnKjlvLnnqpfojIPlm7TlhoVcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoIC0gJGV2ZW50LmNsaWVudFggPiB0aGlzLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGhcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCAtICRldmVudC5jbGllbnRZID4gdGhpcy5uYXRpdmVFbGVtZW50Lm9mZnNldEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53YW50SGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgICBwcml2YXRlIGNsaWNrVGFiKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgaW50cm9Nb2RhbDogSFRNTEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcudHAtaGFsZm1vZGFsLWFuaW1hdGlvbicpO1xyXG4gICAgICAgIGNvbnN0IGZvY3VzYWJsZUVsZW1lbnRzOiBOb2RlTGlzdCA9IGludHJvTW9kYWw/LnF1ZXJ5U2VsZWN0b3JBbGwodGhpcy5mb2N1c2FibGVFbGVtZW50c1N0cmluZyk7XHJcbiAgICAgICAgVXRpbC5mb2N1c0luRGlhbG9nT25UYWJjaGFuZ2UoZXZlbnQsIGZvY3VzYWJsZUVsZW1lbnRzKTtcclxuICAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOWNs+WwhuWFs+mXre+8jOWmguaenOebkeWQrGJlZm9yZUhpZGXvvIzliJnnlLHkuJrliqHlhbPpl63lvLnnqpdcclxuICAgICAqL1xyXG4gICAgcHVibGljIHdhbnRIaWRlKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmJlZm9yZUhpZGUub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5iZWZvcmVIaWRlLmVtaXQodGhpcyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiAxMC4wLjLlr7nlpJbmj5DkvptcclxuICAgICAqXHJcbiAgICAgKiDlvLnnqpfpmpDol4/kuovku7ZcclxuICAgICAqL1xyXG4gICAgcHVibGljIGhpZGUoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5oaWRlQmFja2Ryb3AoKTtcclxuXHJcbiAgICAgICAgdGhpcy5pc1Nob3cgPSBmYWxzZTtcclxuICAgICAgICBpZiAodGhpcy51bmxpc3RlbkNsaWNrKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5saXN0ZW5DbGljaygpO1xyXG4gICAgICAgICAgICB0aGlzLnVubGlzdGVuQ2xpY2sgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGlkZUJhY2tkcm9wKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmJhY2tkcm9wRWxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIyLnJlbW92ZUNoaWxkKGRvY3VtZW50LmJvZHksIHRoaXMuYmFja2Ryb3BFbGUpO1xyXG4gICAgICAgICAgICB0aGlzLmJhY2tkcm9wRWxlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmhpZGVCYWNrZHJvcCgpO1xyXG4gICAgICAgIGlmICh0aGlzLnVubGlzdGVuQ2xpY2spIHtcclxuICAgICAgICAgICAgdGhpcy51bmxpc3RlbkNsaWNrKCk7XHJcbiAgICAgICAgICAgIHRoaXMudW5saXN0ZW5DbGljayA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMudW5MaXN0ZW5Eb2N1bWVudEtleWRvd24pIHtcclxuICAgICAgICAgICAgdGhpcy51bkxpc3RlbkRvY3VtZW50S2V5ZG93bigpO1xyXG4gICAgICAgICAgICB0aGlzLnVuTGlzdGVuRG9jdW1lbnRLZXlkb3duID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=