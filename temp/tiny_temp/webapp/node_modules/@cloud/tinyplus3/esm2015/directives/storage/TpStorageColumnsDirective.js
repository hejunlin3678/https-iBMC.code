import { Directive } from '@angular/core';
import { TiTableComponent, Util } from '@cloud/tiny3';
import { CfUtil } from '../../cfutils/CfUtil';
/**
 * 表格记忆列切换指令
 *
 * 10.0.4 新增
 *
 *
 * <example-url>../tinyplus3demo/#/storage/storage-all</example-url>
 */
export class TpStorageColumnsDirective {
    constructor(tableCom) {
        this.tableCom = tableCom;
    }
    ngOnInit() {
        if (this.shouldStorageColumnsToggle()) {
            this.httpService = CfUtil.getHttpService();
            CfUtil.getUser()
                .then((user) => {
                this.user = user;
                this.getColumns();
                this.updateColumnsSubscription = this.tableCom.updateColumnsSubject.subscribe(() => {
                    this.postColumns();
                });
            }).catch(error => {
                console.log(error);
            });
        }
    }
    ngOnDestroy() {
        if (this.updateColumnsSubscription) {
            this.updateColumnsSubscription.unsubscribe();
        }
    }
    getColumns() {
        if (!this.user && !this.httpService) {
            return;
        }
        const userid = this.user.userId;
        const storageId = this.tableCom.storageId;
        this.httpService.get({
            url: {
                s: TpStorageColumnsDirective.GET_URL,
                o: {
                    userid: userid,
                    category: storageId
                }
            }
        }).then((data) => {
            this.tableCom.columns.forEach((column, index) => {
                if (!Util.isNull(data[index])) {
                    column.show = data[index];
                }
                ;
            });
        }).catch(error => {
            console.log(error);
        });
    }
    postColumns() {
        if (!this.user && !this.httpService) {
            return;
        }
        const columns = this.tableCom.columns.map((column) => {
            return column.show;
        });
        const userid = this.user.userId;
        const storageId = this.tableCom.storageId;
        this.httpService.post({
            url: {
                s: TpStorageColumnsDirective.POST_URL,
                o: {
                    userid: userid
                }
            },
            params: {
                ategory: storageId,
                setting: JSON.stringify(columns),
                lastModifiedDateLong: new Date().getTime()
            }
        }).then((data) => {
            // 成功后不做处理
        }).catch((error) => {
            console.log(error);
        });
    }
    shouldStorageColumnsToggle() {
        return !!(this.tableCom && this.tableCom.storageId);
    }
}
/**
 * @ignore
 */
TpStorageColumnsDirective.GET_URL = './rest/silvan/rest/v1.0/setting/{userid}/{category}/update.json';
/**
 * @ignore
 */
TpStorageColumnsDirective.POST_URL = './rest/silvan/rest/v1.0/setting/{userid}/update.json';
TpStorageColumnsDirective.decorators = [
    { type: Directive, args: [{
                selector: 'ti-table[tpStorageColumns]'
            },] }
];
TpStorageColumnsDirective.ctorParameters = () => [
    { type: TiTableComponent }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBTdG9yYWdlQ29sdW1uc0RpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55cGx1czMvZGlyZWN0aXZlcy9zdG9yYWdlL1RwU3RvcmFnZUNvbHVtbnNEaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUNILFNBQVMsRUFHWixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWtCLGdCQUFnQixFQUFFLElBQUksRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUV0RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFHN0M7Ozs7Ozs7R0FPRztBQUlILE1BQU0sT0FBTyx5QkFBeUI7SUFhbEMsWUFBWSxRQUEwQjtRQUNsQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBQ0QsUUFBUTtRQUNKLElBQUksSUFBSSxDQUFDLDBCQUEwQixFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDM0MsTUFBTSxDQUFDLE9BQU8sRUFBRTtpQkFDWCxJQUFJLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtnQkFDbkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUE7Z0JBQ2hCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDbEIsSUFBSSxDQUFDLHlCQUF5QixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtvQkFDL0UsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUN2QixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDYixPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLENBQUMsQ0FBQyxDQUFDO1NB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QUFzRCxDQUFDOztZQVhwRyxTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLDRCQUE0QjthQUN6Qzs7O1lBZndCLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5cclxuaW1wb3J0IHtcclxuICAgIERpcmVjdGl2ZSxcclxuICAgIE9uRGVzdHJveSxcclxuICAgIE9uSW5pdFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaVRhYmxlQ29sdW1ucywgVGlUYWJsZUNvbXBvbmVudCwgVXRpbCB9IGZyb20gJ0BjbG91ZC90aW55Myc7XHJcbmltcG9ydCB7IENmVXNlciB9IGZyb20gJ0BjbG91ZC9jZmRhdGEnO1xyXG5pbXBvcnQgeyBDZlV0aWwgfSBmcm9tICcuLi8uLi9jZnV0aWxzL0NmVXRpbCdcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcblxyXG4vKipcclxuICog6KGo5qC86K6w5b+G5YiX5YiH5o2i5oyH5LukXHJcbiAqXHJcbiAqIDEwLjAuNCDmlrDlop5cclxuICpcclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnlwbHVzM2RlbW8vIy9zdG9yYWdlL3N0b3JhZ2UtYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICd0aS10YWJsZVt0cFN0b3JhZ2VDb2x1bW5zXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIFRwU3RvcmFnZUNvbHVtbnNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBHRVRfVVJMOiBzdHJpbmcgPSAnLi9yZXN0L3NpbHZhbi9yZXN0L3YxLjAvc2V0dGluZy97dXNlcmlkfS97Y2F0ZWdvcnl9L3VwZGF0ZS5qc29uJztcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFBPU1RfVVJMOiBzdHJpbmcgPSAnLi9yZXN0L3NpbHZhbi9yZXN0L3YxLjAvc2V0dGluZy97dXNlcmlkfS91cGRhdGUuanNvbic7XHJcbiAgICBwcml2YXRlIHRhYmxlQ29tOiBUaVRhYmxlQ29tcG9uZW50O1xyXG4gICAgcHJpdmF0ZSBodHRwU2VydmljZTogYW55O1xyXG4gICAgcHJpdmF0ZSB1c2VyOiBDZlVzZXI7XHJcbiAgICBwcml2YXRlIHVwZGF0ZUNvbHVtbnNTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICAgIGNvbnN0cnVjdG9yKHRhYmxlQ29tOiBUaVRhYmxlQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy50YWJsZUNvbSA9IHRhYmxlQ29tO1xyXG4gICAgfVxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuc2hvdWxkU3RvcmFnZUNvbHVtbnNUb2dnbGUoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmh0dHBTZXJ2aWNlID0gQ2ZVdGlsLmdldEh0dHBTZXJ2aWNlKCk7XHJcbiAgICAgICAgICAgIENmVXRpbC5nZXRVc2VyKClcclxuICAgICAgICAgICAgICAgIC50aGVuKCh1c2VyOiBDZlVzZXIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnVzZXIgPSB1c2VyXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRDb2x1bW5zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5zU3Vic2NyaXB0aW9uID0gdGhpcy50YWJsZUNvbS51cGRhdGVDb2x1bW5zU3ViamVjdC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc3RDb2x1bW5zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMudXBkYXRlQ29sdW1uc1N1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUNvbHVtbnNTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldENvbHVtbnMoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnVzZXIgJiYgIXRoaXMuaHR0cFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB1c2VyaWQgPSB0aGlzLnVzZXIudXNlcklkO1xyXG4gICAgICAgIGNvbnN0IHN0b3JhZ2VJZCA9IHRoaXMudGFibGVDb20uc3RvcmFnZUlkO1xyXG4gICAgICAgIHRoaXMuaHR0cFNlcnZpY2UuZ2V0KHtcclxuICAgICAgICAgICAgdXJsOiB7XHJcbiAgICAgICAgICAgICAgICBzOiBUcFN0b3JhZ2VDb2x1bW5zRGlyZWN0aXZlLkdFVF9VUkwsXHJcbiAgICAgICAgICAgICAgICBvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlcmlkOiB1c2VyaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IHN0b3JhZ2VJZFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkudGhlbigoZGF0YTogQXJyYXk8YW55PikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnRhYmxlQ29tLmNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBUaVRhYmxlQ29sdW1ucywgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFVdGlsLmlzTnVsbChkYXRhW2luZGV4XSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb2x1bW4uc2hvdyA9IGRhdGFbaW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgcG9zdENvbHVtbnMoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnVzZXIgJiYgIXRoaXMuaHR0cFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IHRoaXMudGFibGVDb20uY29sdW1ucy5tYXAoKGNvbHVtbjogVGlUYWJsZUNvbHVtbnMpOiBib29sZWFuID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbHVtbi5zaG93O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IHVzZXJpZCA9IHRoaXMudXNlci51c2VySWQ7XHJcbiAgICAgICAgY29uc3Qgc3RvcmFnZUlkID0gdGhpcy50YWJsZUNvbS5zdG9yYWdlSWQ7XHJcbiAgICAgICAgdGhpcy5odHRwU2VydmljZS5wb3N0KHtcclxuICAgICAgICAgICAgdXJsOiB7XHJcbiAgICAgICAgICAgICAgICBzOiBUcFN0b3JhZ2VDb2x1bW5zRGlyZWN0aXZlLlBPU1RfVVJMLFxyXG4gICAgICAgICAgICAgICAgbzoge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJpZDogdXNlcmlkXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHBhcmFtczoge1xyXG4gICAgICAgICAgICAgICAgYXRlZ29yeTogc3RvcmFnZUlkLFxyXG4gICAgICAgICAgICAgICAgc2V0dGluZzogSlNPTi5zdHJpbmdpZnkoY29sdW1ucyksXHJcbiAgICAgICAgICAgICAgICBsYXN0TW9kaWZpZWREYXRlTG9uZzogbmV3IERhdGUoKS5nZXRUaW1lKClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pLnRoZW4oKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAvLyDmiJDlip/lkI7kuI3lgZrlpITnkIZcclxuICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBzaG91bGRTdG9yYWdlQ29sdW1uc1RvZ2dsZSgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gISEodGhpcy50YWJsZUNvbSAmJiB0aGlzLnRhYmxlQ29tLnN0b3JhZ2VJZCk7XHJcbiAgICB9XHJcbn1cclxuIl19