import { Injectable } from '@angular/core';
import { TiLocale, TiModalService } from '@cloud/tiny3';
import { TpIdentityauthModule } from './TpIdentityauthModule';
import { TpIdentityauthModalComponent } from './TpIdentityauthmodalComponent';
import { CfUtil } from '../../cfutils/CfUtil';
import * as i0 from "@angular/core";
import * as i1 from "@cloud/tiny3";
import * as i2 from "./TpIdentityauthModule";
/**
 * 二次认证组件
 *
 * <example-url>../tinyplus3demo/#/identityauth/identityauth-all</example-url>
 */
export class TpIdentityauthService {
    constructor(tiModal) {
        this.tiModal = tiModal;
    }
    queryIsOpen() {
        this.mask.show();
        this.camel.get({
            url: {
                s: `${this.appWebPath}/rest/v3-ext/users/op-mfa/{user_id}`,
                o: {
                    user_id: this.userId
                }
            },
            timeout: 30000
        })
            .then((res) => {
            this.mask.hide();
            if (res.mfa_support === 'false') {
                this.successFn();
                return;
            }
            // 判断是否已开启敏感操作保护，如开启则进行验证，否则直接进行业务处理
            if (res.ops_switch === 'true') {
                this.checkCerifyCode();
            }
            else {
                this.successFn();
            }
        }, () => {
            this.mask.hide();
            this.msgService.showError(TiLocale.getLocaleWords().tpBinding.confirm_system_busy);
        });
    }
    checkCerifyCode() {
        // 获取cookie中cloud_verify_ticket  查询校验码合法性
        const storage = CfUtil.getStorageService();
        let cloud_verify_ticket;
        if (storage && storage.cookieStorage && storage.cookieStorage.getItem) {
            cloud_verify_ticket = storage.cookieStorage.getItem('cloud_verify_ticket');
        }
        if (cloud_verify_ticket) {
            this.mask.show();
            // 查询验证码合法性
            this.camel.post({
                url: {
                    s: `${this.appWebPath}/rest/v3-ext/users/op-mfa/{user_id}`,
                    o: {
                        user_id: this.userId
                    }
                },
                timeout: 30000,
                params: {
                    cloudVerifyTicket: cloud_verify_ticket
                }
            })
                .then((res) => {
                this.mask.hide();
                // 验证码合法、直接进行业务处理
                if (res.id) {
                    this.successFn();
                }
            }, () => {
                this.mask.hide();
                this.identityAuth();
            });
        }
        else {
            this.identityAuth();
        }
    }
    identityAuth() {
        // 需查询用户信息(绑定状态)。
        this.mask.show();
        const getUserInfoPromise = this.camel.get({
            url: {
                s: `${this.appWebPath}/rest/v3.0/OS-MFA/userinfo/{user_id}`,
                o: {
                    user_id: this.userId
                }
            },
            timeout: 30000
        });
        const getRoleInfoPromise = this.camel.get({
            url: {
                s: `${this.appWebPath}/rest/global/token`,
                o: {}
            },
            timeout: 30000
        });
        const getServiceEndpointList = () => {
            // 如果为了本地测试，open方法传入了config.serviceEndpointList，则需要特殊处理
            if (this.serviceEndpointList) {
                return new Promise((resolve) => {
                    resolve(this.serviceEndpointList);
                });
            }
            else {
                return CfUtil.getEndpoints()
                    .then((endpoints) => endpoints.serviceEndpointList);
            }
        };
        Promise.all([getUserInfoPromise, getRoleInfoPromise, getServiceEndpointList()])
            .then((response) => {
            const userInfoRes = response[0];
            const roleInfoRes = response[1];
            this.mask.hide();
            this.tiModal.open(TpIdentityauthModalComponent, {
                id: 'tp-identityauth',
                modalClass: 'tp-identityauth-modal',
                context: {
                    userInfoRes,
                    roleInfoRes,
                    userId: this.userId,
                    serviceEndpointList: response[2],
                    mask: this.mask,
                    camel: this.camel,
                    successFn: this.successFn,
                    appWebPath: this.appWebPath
                }
            });
        }, () => {
            this.mask.hide();
            this.msgService.showError(TiLocale.getLocaleWords().tpBinding.confirm_system_busy);
        });
    }
    /**
     * 开启二次认证
     *
     * @param successFn 二次认证通过或不需要认证时的回调函数
     *
     * @param config 组件本地测试需要的参数，开发者实际场景中不需要
     */
    open(successFn, config) {
        this.successFn = successFn;
        this.appWebPath = CfUtil.getAppWebPath();
        if (config) {
            this.camel = config.camel;
            this.msgService = config.msg;
            this.mask = config.mask;
            this.userId = config.userId;
            this.serviceEndpointList = config.serviceEndpointList;
            this.queryIsOpen();
        }
        else {
            CfUtil.getUser()
                .then((user) => {
                this.camel = CfUtil.getHttpService();
                if (user.userId && this.camel) {
                    this.userId = user.userId;
                    this.msgService = CfUtil.getMessage();
                    this.mask = CfUtil.getMask();
                    this.queryIsOpen();
                }
            });
        }
    }
}
TpIdentityauthService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TpIdentityauthService_Factory() { return new TpIdentityauthService(i0.ɵɵinject(i1.TiModalService)); }, token: TpIdentityauthService, providedIn: i2.TpIdentityauthModule });
TpIdentityauthService.decorators = [
    { type: Injectable, args: [{
                providedIn: TpIdentityauthModule
            },] }
];
TpIdentityauthService.ctorParameters = () => [
    { type: TiModalService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBJZGVudGl0eWF1dGhTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnlwbHVzMy9zZXJ2aWNlcy9pZGVudGl0eWF1dGgvVHBJZGVudGl0eWF1dGhTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQVEsTUFBTSxjQUFjLENBQUM7QUFFOUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFOUQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDOUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7O0FBRTlDOzs7O0dBSUc7QUFLSCxNQUFNLE9BQU8scUJBQXFCO0lBQzlCLFlBQW9CLE9BQXVCO1FBQXZCLFlBQU8sR0FBUCxPQUFPLENBQWdCO0lBQUksQ0FBQztJQTJCeEMsV0FBVztRQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7WUFDWCxHQUFHLEVBQUU7Z0JBQ0QsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUscUNBQXFDO2dCQUMxRCxDQUFDLEVBQUU7b0JBQ0MsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNO2lCQUN2QjthQUNKO1lBQ0QsT0FBTyxFQUFFLEtBQUs7U0FDakIsQ0FBQzthQUNHLElBQUksQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFO1lBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNqQixJQUFJLEdBQUcsQ0FBQyxXQUFXLEtBQUssT0FBTyxFQUFFO2dCQUM3QixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBRWpCLE9BQU87YUFD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QUFVLEVBQUUsb0JBQW9CO2FBQ25DOzs7WUFka0IsY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IFRpTG9jYWxlLCBUaU1vZGFsU2VydmljZSwgVXRpbCB9IGZyb20gJ0BjbG91ZC90aW55Myc7XHJcblxyXG5pbXBvcnQgeyBUcElkZW50aXR5YXV0aE1vZHVsZSB9IGZyb20gJy4vVHBJZGVudGl0eWF1dGhNb2R1bGUnO1xyXG5cclxuaW1wb3J0IHsgVHBJZGVudGl0eWF1dGhNb2RhbENvbXBvbmVudCB9IGZyb20gJy4vVHBJZGVudGl0eWF1dGhtb2RhbENvbXBvbmVudCc7XHJcbmltcG9ydCB7IENmVXRpbCB9IGZyb20gJy4uLy4uL2NmdXRpbHMvQ2ZVdGlsJztcclxuXHJcbi8qKlxyXG4gKiDkuozmrKHorqTor4Hnu4Tku7ZcclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnlwbHVzM2RlbW8vIy9pZGVudGl0eWF1dGgvaWRlbnRpdHlhdXRoLWFsbDwvZXhhbXBsZS11cmw+XHJcbiAqL1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiBUcElkZW50aXR5YXV0aE1vZHVsZVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIFRwSWRlbnRpdHlhdXRoU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRpTW9kYWw6IFRpTW9kYWxTZXJ2aWNlKSB7IH1cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgY2FtZWw6IGFueTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgbWFzazogYW55O1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBtc2dTZXJ2aWNlOiBhbnk7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIHVzZXJJZDogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZXJ2aWNlRW5kcG9pbnRMaXN0OiBBcnJheTxhbnk+O1xyXG4gICAgcHJpdmF0ZSBhcHBXZWJQYXRoOiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIHN1Y2Nlc3NGbjogKCkgPT4gdm9pZDtcclxuXHJcbiAgICBwcml2YXRlIHF1ZXJ5SXNPcGVuKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubWFzay5zaG93KCk7XHJcbiAgICAgICAgdGhpcy5jYW1lbC5nZXQoe1xyXG4gICAgICAgICAgICB1cmw6IHtcclxuICAgICAgICAgICAgICAgIHM6IGAke3RoaXMuYXBwV2ViUGF0aH0vcmVzdC92My1leHQvdXNlcnMvb3AtbWZhL3t1c2VyX2lkfWAsXHJcbiAgICAgICAgICAgICAgICBvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZDogdGhpcy51c2VySWRcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdGltZW91dDogMzAwMDBcclxuICAgICAgICB9KVxyXG4gICAgICAgICAgICAudGhlbigocmVzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWFzay5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLm1mYV9zdXBwb3J0ID09PSAnZmFsc2UnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWNjZXNzRm4oKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8g5Yik5pat5piv5ZCm5bey5byA5ZCv5pWP5oSf5pON5L2c5L+d5oqk77yM5aaC5byA5ZCv5YiZ6L+b6KGM6aqM6K+B77yM5ZCm5YiZ55u05o6l6L+b6KGM5Lia5Yqh5aSE55CGXHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLm9wc19zd2l0Y2ggPT09ICd0cnVlJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tDZXJpZnlDb2RlKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzc0ZuKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWFzay5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1zZ1NlcnZpY2Uuc2hvd0Vycm9yKFRpTG9jYWxlLmdldExvY2FsZVdvcmRzKCkudHBCaW5kaW5nLmNvbmZpcm1fc3lzdGVtX2J1c3kpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrQ2VyaWZ5Q29kZSgpOiB2b2lkIHtcclxuICAgICAgICAvLyDojrflj5Zjb29raWXkuK1jbG91ZF92ZXJpZnlfdGlja2V0ICDmn6Xor6LmoKHpqoznoIHlkIjms5XmgKdcclxuICAgICAgICBjb25zdCBzdG9yYWdlOiBhbnkgPSBDZlV0aWwuZ2V0U3RvcmFnZVNlcnZpY2UoKTtcclxuICAgICAgICBsZXQgY2xvdWRfdmVyaWZ5X3RpY2tldDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChzdG9yYWdlICYmIHN0b3JhZ2UuY29va2llU3RvcmFnZSAmJiBzdG9yYWdlLmNvb2tpZVN0b3JhZ2UuZ2V0SXRlbSkge1xyXG4gICAgICAgICAgICBjbG91ZF92ZXJpZnlfdGlja2V0ID0gc3RvcmFnZS5jb29raWVTdG9yYWdlLmdldEl0ZW0oJ2Nsb3VkX3ZlcmlmeV90aWNrZXQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNsb3VkX3ZlcmlmeV90aWNrZXQpIHtcclxuICAgICAgICAgICAgdGhpcy5tYXNrLnNob3coKTtcclxuICAgICAgICAgICAgLy8g5p+l6K+i6aqM6K+B56CB5ZCI5rOV5oCnXHJcbiAgICAgICAgICAgIHRoaXMuY2FtZWwucG9zdCh7XHJcbiAgICAgICAgICAgICAgICB1cmw6IHtcclxuICAgICAgICAgICAgICAgICAgICBzOiBgJHt0aGlzLmFwcFdlYlBhdGh9L3Jlc3QvdjMtZXh0L3VzZXJzL29wLW1mYS97dXNlcl9pZH1gLFxyXG4gICAgICAgICAgICAgICAgICAgIG86IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9pZDogdGhpcy51c2VySWRcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgdGltZW91dDogMzAwMDAsXHJcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHtcclxuICAgICAgICAgICAgICAgICAgICBjbG91ZFZlcmlmeVRpY2tldDogY2xvdWRfdmVyaWZ5X3RpY2tldFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXNrLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyDpqozor4HnoIHlkIjms5XjgIHnm7TmjqXov5vooYzkuJrliqHlpITnkIZcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzc0ZuKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWFzay5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pZGVudGl0eUF1dGgoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuaWRlbnRpdHlBdXRoKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaWRlbnRpdHlBdXRoKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOmcgOafpeivoueUqOaIt+S/oeaBryjnu5HlrprnirbmgIEp44CCXHJcbiAgICAgICAgdGhpcy5tYXNrLnNob3coKTtcclxuICAgICAgICBjb25zdCBnZXRVc2VySW5mb1Byb21pc2U6IFByb21pc2U8YW55PiA9IHRoaXMuY2FtZWwuZ2V0KHtcclxuICAgICAgICAgICAgdXJsOiB7XHJcbiAgICAgICAgICAgICAgICBzOiBgJHt0aGlzLmFwcFdlYlBhdGh9L3Jlc3QvdjMuMC9PUy1NRkEvdXNlcmluZm8ve3VzZXJfaWR9YCxcclxuICAgICAgICAgICAgICAgIG86IHtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyX2lkOiB0aGlzLnVzZXJJZFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB0aW1lb3V0OiAzMDAwMFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGdldFJvbGVJbmZvUHJvbWlzZTogUHJvbWlzZTxhbnk+ID0gdGhpcy5jYW1lbC5nZXQoe1xyXG4gICAgICAgICAgICB1cmw6IHtcclxuICAgICAgICAgICAgICAgIHM6IGAke3RoaXMuYXBwV2ViUGF0aH0vcmVzdC9nbG9iYWwvdG9rZW5gLFxyXG4gICAgICAgICAgICAgICAgbzoge31cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdGltZW91dDogMzAwMDBcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2V0U2VydmljZUVuZHBvaW50TGlzdDogKCkgPT4gUHJvbWlzZTxhbnk+ID0gKCk6IFByb21pc2U8YW55PiA9PiB7XHJcbiAgICAgICAgICAgIC8vIOWmguaenOS4uuS6huacrOWcsOa1i+ivle+8jG9wZW7mlrnms5XkvKDlhaXkuoZjb25maWcuc2VydmljZUVuZHBvaW50TGlzdO+8jOWImemcgOimgeeJueauiuWkhOeQhlxyXG4gICAgICAgICAgICBpZiAodGhpcy5zZXJ2aWNlRW5kcG9pbnRMaXN0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmU6IGFueSk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5zZXJ2aWNlRW5kcG9pbnRMaXN0KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIENmVXRpbC5nZXRFbmRwb2ludHMoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGVuZHBvaW50czogYW55KSA9PiBlbmRwb2ludHMuc2VydmljZUVuZHBvaW50TGlzdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBQcm9taXNlLmFsbChbZ2V0VXNlckluZm9Qcm9taXNlLCBnZXRSb2xlSW5mb1Byb21pc2UsIGdldFNlcnZpY2VFbmRwb2ludExpc3QoKV0pXHJcbiAgICAgICAgICAgIC50aGVuKChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VySW5mb1JlczogYW55ID0gcmVzcG9uc2VbMF07XHJcbiAgICAgICAgICAgICAgICBjb25zdCByb2xlSW5mb1JlczogYW55ID0gcmVzcG9uc2VbMV07XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1hc2suaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy50aU1vZGFsLm9wZW4oVHBJZGVudGl0eWF1dGhNb2RhbENvbXBvbmVudCwge1xyXG4gICAgICAgICAgICAgICAgICAgIGlkOiAndHAtaWRlbnRpdHlhdXRoJyxcclxuICAgICAgICAgICAgICAgICAgICBtb2RhbENsYXNzOiAndHAtaWRlbnRpdHlhdXRoLW1vZGFsJyxcclxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJJbmZvUmVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByb2xlSW5mb1JlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcklkOiB0aGlzLnVzZXJJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VydmljZUVuZHBvaW50TGlzdDogcmVzcG9uc2VbMl0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hc2s6IHRoaXMubWFzayxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FtZWw6IHRoaXMuY2FtZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3NGbjogdGhpcy5zdWNjZXNzRm4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcFdlYlBhdGg6IHRoaXMuYXBwV2ViUGF0aFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1hc2suaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLnNob3dFcnJvcihUaUxvY2FsZS5nZXRMb2NhbGVXb3JkcygpLnRwQmluZGluZy5jb25maXJtX3N5c3RlbV9idXN5KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOW8gOWQr+S6jOasoeiupOivgVxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSBzdWNjZXNzRm4g5LqM5qyh6K6k6K+B6YCa6L+H5oiW5LiN6ZyA6KaB6K6k6K+B5pe255qE5Zue6LCD5Ye95pWwXHJcbiAgICAgKlxyXG4gICAgICogQHBhcmFtIGNvbmZpZyDnu4Tku7bmnKzlnLDmtYvor5XpnIDopoHnmoTlj4LmlbDvvIzlvIDlj5HogIXlrp7pmYXlnLrmma/kuK3kuI3pnIDopoFcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9wZW4oc3VjY2Vzc0ZuOiAoKSA9PiB2b2lkLCBjb25maWc/OiBhbnkpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnN1Y2Nlc3NGbiA9IHN1Y2Nlc3NGbjtcclxuICAgICAgICB0aGlzLmFwcFdlYlBhdGggPSBDZlV0aWwuZ2V0QXBwV2ViUGF0aCgpO1xyXG4gICAgICAgIGlmIChjb25maWcpIHtcclxuICAgICAgICAgICAgdGhpcy5jYW1lbCA9IGNvbmZpZy5jYW1lbDtcclxuICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlID0gY29uZmlnLm1zZztcclxuICAgICAgICAgICAgdGhpcy5tYXNrID0gY29uZmlnLm1hc2s7XHJcbiAgICAgICAgICAgIHRoaXMudXNlcklkID0gY29uZmlnLnVzZXJJZDtcclxuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlRW5kcG9pbnRMaXN0ID0gY29uZmlnLnNlcnZpY2VFbmRwb2ludExpc3Q7XHJcbiAgICAgICAgICAgIHRoaXMucXVlcnlJc09wZW4oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBDZlV0aWwuZ2V0VXNlcigpXHJcbiAgICAgICAgICAgICAgICAudGhlbigodXNlcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNhbWVsID0gQ2ZVdGlsLmdldEh0dHBTZXJ2aWNlKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodXNlci51c2VySWQgJiYgdGhpcy5jYW1lbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXNlcklkID0gdXNlci51c2VySWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlID0gQ2ZVdGlsLmdldE1lc3NhZ2UoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1hc2sgPSBDZlV0aWwuZ2V0TWFzaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnlJc09wZW4oKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==