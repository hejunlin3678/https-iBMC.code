/* eslint-disable no-param-reassign */
/**
 * 该类提供一个服务，用于管理弹出类组件的创建和销毁
 * 服务中提供三个方法:
 * create(componentType) 生成一个popup实例并返回对象，
 *   componentType：包裹内容的父容器元素类
 * 返回的实例对象中提供方法:
 * {
 *  show({ // 生成元素并在指定容器中显示
 *   content:弹出组件内容
 *   context:弹出组件上下文
 *   container:弹出组件最终放置的容器位置
 * }) : componentRef // 返回生成的组件实例
 *  hide():隐藏并销毁元素
 * }
 */
import { ApplicationRef, ComponentFactoryResolver, ElementRef, Injectable, Injector, RendererFactory2, SecurityContext, TemplateRef, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { DomSanitizer } from '@angular/platform-browser';
import { TiPopupModule } from './TiPopupModule';
import { Util } from '../../utils/Util';
import * as i0 from "@angular/core";
import * as i1 from "@angular/platform-browser";
import * as i2 from "@angular/common";
import * as i3 from "./TiPopupModule";
/**
 * @ignore
 */
class ContentRef {
    constructor(nodes, viewRef, componentRef) {
        this.nodes = nodes;
        this.viewRef = viewRef;
        this.componentRef = componentRef;
    }
}
/**
 * @ignore
 */
export class TiPopupService {
    constructor(injector, rendererFactory, componentFactoryResolver, applicationRef, domSanitizer, document) {
        this.injector = injector;
        this.componentFactoryResolver = componentFactoryResolver;
        this.applicationRef = applicationRef;
        this.domSanitizer = domSanitizer;
        this.document = document;
        this.getContentRef = (content, context) => {
            // ng-template形式
            if (content instanceof TemplateRef) {
                // 将template实例化为内嵌视图,并将其放在可运行环境中进行解析
                const embeddedViewRef = content.createEmbeddedView({ context });
                this.applicationRef.attachView(embeddedViewRef); // 不做此处处理，ng-template中的标签不会解析
                return new ContentRef([embeddedViewRef.rootNodes], embeddedViewRef);
            }
            // 组件形式
            if (typeof content === 'function') {
                // 根据传入的component类（即content）创建组件引用
                const componentRef = this.createCompoentRef({
                    componentType: content,
                    context,
                    notDetectChanges: true
                });
                return new ContentRef([[componentRef.location.nativeElement]], componentRef.hostView, componentRef);
            }
            // element Dom形式
            if (content instanceof HTMLElement) {
                return new ContentRef([[content]]);
            }
            // string形式 或 SafeHtml(object类型) 形式，
            if (typeof content === 'string' || typeof content === 'object') {
                const wrapEle = this.renderer.createElement('div');
                wrapEle.innerHTML = this.domSanitizer.sanitize(SecurityContext.HTML, content);
                return new ContentRef([wrapEle.childNodes]);
            }
            return new ContentRef([]);
        };
        /* tslint:disable:no-null-keyword */
        this.renderer = rendererFactory.createRenderer(null, null);
    }
    getParentEle(containerOpt) {
        if (containerOpt instanceof ElementRef) { // 父元素为正常element元素情况下
            return containerOpt.nativeElement;
        }
        else if (containerOpt === 'body') { // 父容器为body元素情况下
            return this.document.body;
        }
    }
    // 销毁组件相关内容
    static destroyComponentRef(_componentRef) {
        if (!_componentRef) {
            return;
        }
        // 销毁组件实例
        _componentRef.destroy();
        _componentRef = null;
    }
    // 销毁弹出内容相关内容
    static destroyContentRef(contentRef) {
        // 弹出内容如果有组件实例对象时，销毁组件实例
        if (contentRef.componentRef) {
            contentRef.componentRef.destroy();
        }
        // 销毁页面视图实例
        if (contentRef.viewRef) {
            contentRef.viewRef.destroy();
        }
        // 销毁内容实例
        contentRef = null;
    }
    create(componentType) {
        let _contentRef; // 弹出内容实例
        let _componentRef; // 生成的组件实例对象
        return {
            show: (options) => {
                // component已生成情况下，不再重复生成
                if (_componentRef) {
                    return _componentRef;
                }
                // 获取内容相关信息,包括：组件节点信息、组件实例信息、组件最小视图信息
                _contentRef = this.getContentRef(options && options.content, options && options.contentContext);
                // 创建组件实例：为内容本身再包一层父容器组件，用于控制组件（componentType）
                _componentRef = this.createCompoentRef({
                    componentType,
                    nodes: _contentRef.nodes,
                    context: options && options.context
                });
                // 将元素放置在指定容器中
                const parentEle = this.getParentEle(options && options.container);
                if (parentEle) {
                    parentEle.appendChild(_componentRef.location.nativeElement);
                }
                // 这时弹出内容已经append,可以对弹出内容进行解析了。
                // 弹出内容中某些元素会在初始化时需要获取自身DOM宽高等，所以要保证弹出内容先append，然后再解析。
                // 解析ng-template形式的弹出内容实例
                if (options.content instanceof TemplateRef) {
                    // 确保数据变化均可以被检测到
                    _contentRef.viewRef.markForCheck();
                    // 执行一次变化检测
                    _contentRef.viewRef.detectChanges();
                }
                // 解析component形式的弹出内容实例
                if (typeof options.content === 'function') {
                    // 在组件的 metadata 中如果设置了OnPush 条件，那么变化检测不会再次执行,
                    // 但是调用该方法，可以确保数据变化被检测到
                    _contentRef.componentRef.changeDetectorRef.markForCheck();
                    // 从该组件到其子组件执行一次变化检测
                    _contentRef.componentRef.changeDetectorRef.detectChanges();
                }
                _componentRef.tiContentRef = _contentRef;
                return _componentRef;
            },
            hide: () => {
                if (!_componentRef) {
                    return;
                }
                TiPopupService.destroyComponentRef(_componentRef);
                TiPopupService.destroyContentRef(_contentRef);
                // 由于该变量在destroyComponentRef函数中赋为null不会改变外部值的改变，导致下次show时判断错误，因此此处需要做处理
                _componentRef = null;
            }
        };
    }
    /**
     * 创建组件实例
     * options {
     *   componentType: 组件类
     *   nodes：组件中的可注入节点
     *   context: 组件属性配置,inputs属性均可在此配置
     * }
     */
    createCompoentRef(options) {
        // 1. 根据component类创建组件引用
        const componentRef = this.componentFactoryResolver
            .resolveComponentFactory(options.componentType)
            .create(this.injector, options.nodes);
        // 2. 将组件绑定在ng component树上，不做绑定情况下，内容中的指令无法解析
        this.applicationRef.attachView(componentRef.hostView);
        // 3. 绑定组件上下文定义
        Object.assign(componentRef.instance, options.context);
        // outputs事件绑定
        if (options.context && !Util.isUndefined(options.context.outputs)) {
            for (const key in options.context.outputs) {
                if (options.context.outputs.hasOwnProperty(key)) {
                    componentRef.instance[key].subscribe(options.context.outputs[key]);
                }
            }
        }
        // 4. 确保组件视图根据数据能实时刷新上。
        // 通过该处理可以确保组件及子组件都完成解析
        if (!options.notDetectChanges) {
            // 在组件的 metadata 中如果设置了OnPush 条件，那么变化检测不会再次执行,
            // 但是调用该方法，可以确保数据变化被检测到
            componentRef.changeDetectorRef.markForCheck();
            // 从该组件到其子组件执行一次变化检测
            componentRef.changeDetectorRef.detectChanges();
        }
        return componentRef;
    }
}
TiPopupService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TiPopupService_Factory() { return new TiPopupService(i0.ɵɵinject(i0.INJECTOR), i0.ɵɵinject(i0.RendererFactory2), i0.ɵɵinject(i0.ComponentFactoryResolver), i0.ɵɵinject(i0.ApplicationRef), i0.ɵɵinject(i1.DomSanitizer), i0.ɵɵinject(i2.DOCUMENT)); }, token: TiPopupService, providedIn: i3.TiPopupModule });
TiPopupService.decorators = [
    { type: Injectable, args: [{
                providedIn: TiPopupModule
            },] }
];
TiPopupService.ctorParameters = () => [
    { type: Injector },
    { type: RendererFactory2 },
    { type: ComponentFactoryResolver },
    { type: ApplicationRef },
    { type: DomSanitizer },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlQb3B1cFNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueTMvc2VydmljZXMvcG9wdXAvVGlQb3B1cFNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsc0NBQXNDO0FBQ3RDOzs7Ozs7Ozs7Ozs7OztHQWNHO0FBQ0gsT0FBTyxFQUFFLGNBQWMsRUFBRSx3QkFBd0IsRUFBZ0IsVUFBVSxFQUN0RCxVQUFVLEVBQUUsUUFBUSxFQUMxQixnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsV0FBVyxFQUFXLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN0RyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXpELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7O0FBd0J4Qzs7R0FFRztBQUNILE1BQU0sVUFBVTtJQUNaLFlBQW1CLEtBQWlCLEVBQVMsT0FBaUIsRUFDM0MsWUFBZ0M7UUFEaEMsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUFTLFlBQU8sR0FBUCxPQUFPLENBQVU7UUFDM0MsaUJBQVksR0FBWixZQUFZLENBQW9CO0lBQ25ELENBQUM7Q0FDSjtBQUNEOztHQUVHO0FBSUgsTUFBTSxPQUFPLGNBQWM7SUFRdkIsWUFBb0IsUUFBa0IsRUFBRSxlQUFpQyxFQUNyRCx3QkFBa0QsRUFDbEQsY0FBOEIsRUFDOUIsWUFBMEIsRUFDUixRQUFRO1FBSjFCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQUNsRCxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDUixhQUFRLEdBQVIsUUFBUSxD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T0FBTyxDQUFDLEVBQUU7WUFDL0QsS0FBSyxNQUFNLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtnQkFDdkMsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQzdDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7aUJBQ3RFO2FBQ0o7U0FDSjtRQUVELHVCQUF1QjtRQUN2Qix1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRTtZQUMzQiw4Q0FBOEM7WUFDOUMsdUJBQXVCO1lBQ3ZCLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUM5QyxvQkFBb0I7WUFDcEIsWUFBWSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ2xEO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDeEIsQ0FBQzs7OztZQWxNSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLGFBQWE7YUFDNUI7OztZQTNDZ0MsUUFBUTtZQUMxQixnQkFBZ0I7WUFGTix3QkFBd0I7WUFBeEMsY0FBYztZQUlkLFlBQVk7NENBcURKLE1BQU0sU0FBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cclxuLyoqXHJcbiAqIOivpeexu+aPkOS+m+S4gOS4quacjeWKoe+8jOeUqOS6jueuoeeQhuW8ueWHuuexu+e7hOS7tueahOWIm+W7uuWSjOmUgOavgVxyXG4gKiDmnI3liqHkuK3mj5DkvpvkuInkuKrmlrnms5U6XHJcbiAqIGNyZWF0ZShjb21wb25lbnRUeXBlKSDnlJ/miJDkuIDkuKpwb3B1cOWunuS+i+W5tui/lOWbnuWvueixoe+8jFxyXG4gKiAgIGNvbXBvbmVudFR5cGXvvJrljIXoo7nlhoXlrrnnmoTniLblrrnlmajlhYPntKDnsbtcclxuICog6L+U5Zue55qE5a6e5L6L5a+56LGh5Lit5o+Q5L6b5pa55rOVOlxyXG4gKiB7XHJcbiAqICBzaG93KHsgLy8g55Sf5oiQ5YWD57Sg5bm25Zyo5oyH5a6a5a655Zmo5Lit5pi+56S6XHJcbiAqICAgY29udGVudDrlvLnlh7rnu4Tku7blhoXlrrlcclxuICogICBjb250ZXh0OuW8ueWHuue7hOS7tuS4iuS4i+aWh1xyXG4gKiAgIGNvbnRhaW5lcjrlvLnlh7rnu4Tku7bmnIDnu4jmlL7nva7nmoTlrrnlmajkvY3nva5cclxuICogfSkgOiBjb21wb25lbnRSZWYgLy8g6L+U5Zue55Sf5oiQ55qE57uE5Lu25a6e5L6LXHJcbiAqICBoaWRlKCk66ZqQ6JeP5bm26ZSA5q+B5YWD57SgXHJcbiAqIH1cclxuICovXHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRWxlbWVudFJlZixcclxuICAgIEVtYmVkZGVkVmlld1JlZiwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsXHJcbiAgICBSZW5kZXJlcjIsIFJlbmRlcmVyRmFjdG9yeTIsIFNlY3VyaXR5Q29udGV4dCwgVGVtcGxhdGVSZWYsIFZpZXdSZWYsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IERvbVNhbml0aXplciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xyXG5cclxuaW1wb3J0IHsgVGlQb3B1cE1vZHVsZSB9IGZyb20gJy4vVGlQb3B1cE1vZHVsZSc7XHJcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi91dGlscy9VdGlsJztcclxuLyoqXHJcbiAqIEBpZ25vcmVcclxuICog57G75Z6L5LitYW555Luj6KGo57uE5Lu25b2i5byPXHJcbiAqL1xyXG5leHBvcnQgdHlwZSBUaUNvbnRlbnRUeXBlID0gc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiB8IGFueTtcclxuLyoqXHJcbiAqIEBpZ25vcmVcclxuICogcG9wdXAgc2hvd+aWueazlemFjee9rlxyXG4gKi9cclxuaW50ZXJmYWNlIFRpUG9wVXBTaG93Q29uZmlnIHtcclxuICAgIGNvbnRlbnQ/OiBUaUNvbnRlbnRUeXBlOyAvLyDlvLnlh7rnu4Tku7blhoXlrrlcclxuICAgIGNvbnRleHQ/OiBhbnk7IC8vIOW8ueWHuue7hOS7tuS4iuS4i+aWh1xyXG4gICAgY29udGVudENvbnRleHQ/OiBhbnk7IC8vIOWGheWuuemDqOWIhueahOe7hOS7tuS4iuS4i+aWh1xyXG4gICAgY29udGFpbmVyPzogYW55OyAvLyDlvLnlh7rnu4Tku7bmnIDnu4jmlL7nva7nmoTlrrnlmajkvY3nva5cclxufVxyXG4vKipcclxuICogQGlnbm9yZVxyXG4gKiBwb3B1cCBjcmVhdGXov5Tlm57lgLxcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgVGlQb3BVcFJlZiB7XHJcbiAgICBzaG93KGNvbmZpZzogVGlQb3BVcFNob3dDb25maWcgfCB7fSk6IENvbXBvbmVudFJlZjxhbnk+O1xyXG4gICAgaGlkZSgpOiB2b2lkO1xyXG59XHJcbi8qKlxyXG4gKiBAaWdub3JlXHJcbiAqL1xyXG5jbGFzcyBDb250ZW50UmVmIHtcclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBub2RlczogQXJyYXk8YW55PiwgcHVibGljIHZpZXdSZWY/OiBWaWV3UmVmLFxyXG4gICAgICAgICAgICAgICAgcHVibGljIGNvbXBvbmVudFJlZj86IENvbXBvbmVudFJlZjxhbnk+KSB7XHJcbiAgICB9XHJcbn1cclxuLyoqXHJcbiAqIEBpZ25vcmVcclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46IFRpUG9wdXBNb2R1bGVcclxufSlcclxuZXhwb3J0IGNsYXNzIFRpUG9wdXBTZXJ2aWNlPFQ+IHtcclxuICAgIC8qKlxyXG4gICAgICog55Sx5LqO6K+l5pyN5Yqh5Y+v6IO96KKr5YW25LuW5pyN5Yqh5L2/55So5Yiw77yM5bm25Lul5pyN5Yqh55qE5b2i5byP5o+Q5L6b57uZ5aSW6YOo77ybXHJcbiAgICAgKiDogIxSZW5kZXJlcjLmnKzouqvkuI3og73ohLHnprvkuo5jb21wb25lbnTkuYvlpJblrprkuYnmiJbkvp3otZbvvIzmiYDku6Xkvb/nlKhSZW5kZXJlckZhY3Rvcnky5pa55byP5a6e5L6L5YyW6L+b6KGM5aSE55CGXHJcbiAgICAgKiDlhbfkvZPor7TmmI7op4HlpoLkuIvvvJpcclxuICAgICAqIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzQzMDcwMzA4L3VzaW5nLXJlbmRlcmVyLWluLWFuZ3VsYXItNFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjI7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcmVuZGVyZXJGYWN0b3J5OiBSZW5kZXJlckZhY3RvcnkyLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXBwbGljYXRpb25SZWY6IEFwcGxpY2F0aW9uUmVmLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkb21TYW5pdGl6ZXI6IERvbVNhbml0aXplcixcclxuICAgICAgICAgICAgICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQpIHtcclxuICAgICAgICAgICAgLyogdHNsaW50OmRpc2FibGU6bm8tbnVsbC1rZXl3b3JkICovXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRQYXJlbnRFbGUoY29udGFpbmVyT3B0OiBzdHJpbmcgfCBFbGVtZW50UmVmKTogRWxlbWVudCB7XHJcbiAgICAgICAgaWYgKGNvbnRhaW5lck9wdCBpbnN0YW5jZW9mIEVsZW1lbnRSZWYpIHsvLyDniLblhYPntKDkuLrmraPluLhlbGVtZW505YWD57Sg5oOF5Ya15LiLXHJcbiAgICAgICAgICAgIHJldHVybiBjb250YWluZXJPcHQubmF0aXZlRWxlbWVudDtcclxuICAgICAgICB9IGVsc2UgaWYgKGNvbnRhaW5lck9wdCA9PT0gJ2JvZHknKSB7Ly8g54i25a655Zmo5Li6Ym9keeWFg+e0oOaDheWGteS4i1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5ib2R5O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDplIDmr4Hnu4Tku7bnm7jlhbPlhoXlrrlcclxuICAgIHByaXZhdGUgc3RhdGljIGRlc3Ryb3lDb21wb25lbnRSZWYoX2NvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPGFueT4pOiB2b2lkIHtcclxuICAgICAgICBpZiAoIV9jb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDplIDmr4Hnu4Tku7blrp7kvotcclxuICAgICAgICBfY29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICBfY29tcG9uZW50UmVmID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvLyDplIDmr4HlvLnlh7rlhoXlrrnnm7jlhbPlhoXlrrlcclxuICAgIHByaXZhdGUgc3RhdGljIGRlc3Ryb3lDb250ZW50UmVmKGNvbnRlbnRSZWY6IENvbnRlbnRSZWYpOiB2b2lkIHtcclxuICAgICAgICAvLyDlvLnlh7rlhoXlrrnlpoLmnpzmnInnu4Tku7blrp7kvovlr7nosaHml7bvvIzplIDmr4Hnu4Tku7blrp7kvotcclxuICAgICAgICBpZiAoY29udGVudFJlZi5jb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgY29udGVudFJlZi5jb21wb25lbnRSZWYuZGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDplIDmr4HpobXpnaLop4blm77lrp7kvotcclxuICAgICAgICBpZiAoY29udGVudFJlZi52aWV3UmVmKSB7XHJcbiAgICAgICAgICAgIGNvbnRlbnRSZWYudmlld1JlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOmUgOavgeWGheWuueWunuS+i1xyXG4gICAgICAgIGNvbnRlbnRSZWYgPSBudWxsO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGNyZWF0ZShjb21wb25lbnRUeXBlOiBhbnkpOiBUaVBvcFVwUmVmIHtcclxuICAgICAgICBsZXQgX2NvbnRlbnRSZWY6IENvbnRlbnRSZWY7IC8vIOW8ueWHuuWGheWuueWunuS+i1xyXG4gICAgICAgIGxldCBfY29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8VD4gfCBhbnk7IC8vIOeUn+aIkOeahOe7hOS7tuWunuS+i+WvueixoVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBzaG93OiAob3B0aW9ucz86IFRpUG9wVXBTaG93Q29uZmlnKTogQ29tcG9uZW50UmVmPFQ+ID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIGNvbXBvbmVudOW3sueUn+aIkOaDheWGteS4i++8jOS4jeWGjemHjeWkjeeUn+aIkFxyXG4gICAgICAgICAgICAgICAgaWYgKF9jb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbXBvbmVudFJlZjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIOiOt+WPluWGheWuueebuOWFs+S/oeaBryzljIXmi6zvvJrnu4Tku7boioLngrnkv6Hmga/jgIHnu4Tku7blrp7kvovkv6Hmga/jgIHnu4Tku7bmnIDlsI/op4blm77kv6Hmga9cclxuICAgICAgICAgICAgICAgIF9jb250ZW50UmVmID0gdGhpcy5nZXRDb250ZW50UmVmKG9wdGlvbnMgJiYgb3B0aW9ucy5jb250ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgJiYgb3B0aW9ucy5jb250ZW50Q29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8g5Yib5bu657uE5Lu25a6e5L6L77ya5Li65YaF5a655pys6Lqr5YaN5YyF5LiA5bGC54i25a655Zmo57uE5Lu277yM55So5LqO5o6n5Yi257uE5Lu277yIY29tcG9uZW50VHlwZe+8iVxyXG4gICAgICAgICAgICAgICAgX2NvbXBvbmVudFJlZiA9IHRoaXMuY3JlYXRlQ29tcG9lbnRSZWYoe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudFR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZXM6IF9jb250ZW50UmVmLm5vZGVzLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5jb250ZXh0XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyDlsIblhYPntKDmlL7nva7lnKjmjIflrprlrrnlmajkuK1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudEVsZTogRWxlbWVudCA9IHRoaXMuZ2V0UGFyZW50RWxlKG9wdGlvbnMgJiYgb3B0aW9ucy5jb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudEVsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudEVsZS5hcHBlbmRDaGlsZChfY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIOi/meaXtuW8ueWHuuWGheWuueW3sue7j2FwcGVuZCzlj6/ku6Xlr7nlvLnlh7rlhoXlrrnov5vooYzop6PmnpDkuobjgIJcclxuICAgICAgICAgICAgICAgIC8vIOW8ueWHuuWGheWuueS4reafkOS6m+WFg+e0oOS8muWcqOWIneWni+WMluaXtumcgOimgeiOt+WPluiHqui6q0RPTeWuvemrmOetie+8jOaJgOS7peimgeS/neivgeW8ueWHuuWGheWuueWFiGFwcGVuZO+8jOeEtuWQjuWGjeino+aekOOAglxyXG4gICAgICAgICAgICAgICAgLy8g6Kej5p6QbmctdGVtcGxhdGXlvaLlvI/nmoTlvLnlh7rlhoXlrrnlrp7kvotcclxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRlbnQgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOehruS/neaVsOaNruWPmOWMluWdh+WPr+S7peiiq+ajgOa1i+WIsFxyXG4gICAgICAgICAgICAgICAgICAgIF9jb250ZW50UmVmLnZpZXdSZWYubWFya0ZvckNoZWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5omn6KGM5LiA5qyh5Y+Y5YyW5qOA5rWLXHJcbiAgICAgICAgICAgICAgICAgICAgX2NvbnRlbnRSZWYudmlld1JlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyDop6PmnpBjb21wb25lbnTlvaLlvI/nmoTlvLnlh7rlhoXlrrnlrp7kvotcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5jb250ZW50ID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5Zyo57uE5Lu255qEIG1ldGFkYXRhIOS4reWmguaenOiuvue9ruS6hk9uUHVzaCDmnaHku7bvvIzpgqPkuYjlj5jljJbmo4DmtYvkuI3kvJrlho3mrKHmiafooYwsXHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5L2G5piv6LCD55So6K+l5pa55rOV77yM5Y+v5Lul56Gu5L+d5pWw5o2u5Y+Y5YyW6KKr5qOA5rWL5YiwXHJcbiAgICAgICAgICAgICAgICAgICAgX2NvbnRlbnRSZWYuY29tcG9uZW50UmVmLmNoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOS7juivpee7hOS7tuWIsOWFtuWtkOe7hOS7tuaJp+ihjOS4gOasoeWPmOWMluajgOa1i1xyXG4gICAgICAgICAgICAgICAgICAgIF9jb250ZW50UmVmLmNvbXBvbmVudFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgX2NvbXBvbmVudFJlZi50aUNvbnRlbnRSZWYgPSBfY29udGVudFJlZjtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbXBvbmVudFJlZjtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgaGlkZTogKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFfY29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgVGlQb3B1cFNlcnZpY2UuZGVzdHJveUNvbXBvbmVudFJlZihfY29tcG9uZW50UmVmKTtcclxuICAgICAgICAgICAgICAgIFRpUG9wdXBTZXJ2aWNlLmRlc3Ryb3lDb250ZW50UmVmKF9jb250ZW50UmVmKTtcclxuICAgICAgICAgICAgICAgIC8vIOeUseS6juivpeWPmOmHj+WcqGRlc3Ryb3lDb21wb25lbnRSZWblh73mlbDkuK3otYvkuLpudWxs5LiN5Lya5pS55Y+Y5aSW6YOo5YC855qE5pS55Y+Y77yM5a+86Ie05LiL5qyhc2hvd+aXtuWIpOaWremUmeivr++8jOWboOatpOatpOWkhOmcgOimgeWBmuWkhOeQhlxyXG4gICAgICAgICAgICAgICAgX2NvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0Q29udGVudFJlZiA9IChjb250ZW50OiBUaUNvbnRlbnRUeXBlLCBjb250ZXh0PzogYW55KTogQ29udGVudFJlZiA9PiB7XHJcbiAgICAgICAgLy8gbmctdGVtcGxhdGXlvaLlvI9cclxuICAgICAgICBpZiAoY29udGVudCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSB7XHJcbiAgICAgICAgICAgIC8vIOWwhnRlbXBsYXRl5a6e5L6L5YyW5Li65YaF5bWM6KeG5Zu+LOW5tuWwhuWFtuaUvuWcqOWPr+i/kOihjOeOr+Wig+S4rei/m+ihjOino+aekFxyXG4gICAgICAgICAgICBjb25zdCBlbWJlZGRlZFZpZXdSZWY6IEVtYmVkZGVkVmlld1JlZjxhbnk+ID0gY29udGVudC5jcmVhdGVFbWJlZGRlZFZpZXcoe2NvbnRleHR9KTtcclxuICAgICAgICAgICAgdGhpcy5hcHBsaWNhdGlvblJlZi5hdHRhY2hWaWV3KGVtYmVkZGVkVmlld1JlZik7IC8vIOS4jeWBmuatpOWkhOWkhOeQhu+8jG5nLXRlbXBsYXRl5Lit55qE5qCH562+5LiN5Lya6Kej5p6QXHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbmV3IENvbnRlbnRSZWYoW2VtYmVkZGVkVmlld1JlZi5yb290Tm9kZXNdLCBlbWJlZGRlZFZpZXdSZWYpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDnu4Tku7blvaLlvI9cclxuICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgLy8g5qC55o2u5Lyg5YWl55qEY29tcG9uZW5057G777yI5Y2zY29udGVudO+8ieWIm+W7uue7hOS7tuW8leeUqFxyXG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxhbnk+ID0gdGhpcy5jcmVhdGVDb21wb2VudFJlZih7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnRUeXBlOiBjb250ZW50LFxyXG4gICAgICAgICAgICAgICAgY29udGV4dCxcclxuICAgICAgICAgICAgICAgIG5vdERldGVjdENoYW5nZXM6IHRydWV9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ29udGVudFJlZihcclxuICAgICAgICAgICAgICAgIFtbY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnRdXSxcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudFJlZi5ob3N0VmlldyxcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudFJlZlxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBlbGVtZW50IERvbeW9ouW8j1xyXG4gICAgICAgIGlmIChjb250ZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBDb250ZW50UmVmKFtbY29udGVudF1dKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHN0cmluZ+W9ouW8jyDmiJYgU2FmZUh0bWwob2JqZWN057G75Z6LKSDlvaLlvI/vvIxcclxuICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBjb250ZW50ID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICBjb25zdCB3cmFwRWxlOiBFbGVtZW50ID0gdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgd3JhcEVsZS5pbm5lckhUTUwgPSB0aGlzLmRvbVNhbml0aXplci5zYW5pdGl6ZShTZWN1cml0eUNvbnRleHQuSFRNTCwgY29udGVudClcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ29udGVudFJlZihbd3JhcEVsZS5jaGlsZE5vZGVzXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3IENvbnRlbnRSZWYoW10pO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7rnu4Tku7blrp7kvotcclxuICAgICAqIG9wdGlvbnMge1xyXG4gICAgICogICBjb21wb25lbnRUeXBlOiDnu4Tku7bnsbtcclxuICAgICAqICAgbm9kZXPvvJrnu4Tku7bkuK3nmoTlj6/ms6jlhaXoioLngrlcclxuICAgICAqICAgY29udGV4dDog57uE5Lu25bGe5oCn6YWN572uLGlucHV0c+WxnuaAp+Wdh+WPr+WcqOatpOmFjee9rlxyXG4gICAgICogfVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgY3JlYXRlQ29tcG9lbnRSZWYob3B0aW9uczoge1xyXG4gICAgICAgIGNvbXBvbmVudFR5cGU/OiBhbnksXHJcbiAgICAgICAgbm9kZXM/OiBBcnJheTxhbnk+LFxyXG4gICAgICAgIGNvbnRleHQ/OiB7IG91dHB1dHM/OiBPYmplY3QsIFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0sXHJcbiAgICAgICAgbm90RGV0ZWN0Q2hhbmdlcz86IGJvb2xlYW5cclxuICAgIH0pOiBDb21wb25lbnRSZWY8YW55PiB7XHJcbiAgICAgICAgLy8gMS4g5qC55o2uY29tcG9uZW5057G75Yib5bu657uE5Lu25byV55SoXHJcbiAgICAgICAgY29uc3QgY29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8YW55PiA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyXHJcbiAgICAgICAgICAgIC5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShvcHRpb25zLmNvbXBvbmVudFR5cGUpXHJcbiAgICAgICAgICAgIC5jcmVhdGUodGhpcy5pbmplY3Rvciwgb3B0aW9ucy5ub2Rlcyk7XHJcblxyXG4gICAgICAgIC8vIDIuIOWwhue7hOS7tue7keWumuWcqG5nIGNvbXBvbmVudOagkeS4iu+8jOS4jeWBmue7keWumuaDheWGteS4i++8jOWGheWuueS4reeahOaMh+S7pOaXoOazleino+aekFxyXG4gICAgICAgIHRoaXMuYXBwbGljYXRpb25SZWYuYXR0YWNoVmlldyhjb21wb25lbnRSZWYuaG9zdFZpZXcpO1xyXG5cclxuICAgICAgICAvLyAzLiDnu5Hlrprnu4Tku7bkuIrkuIvmloflrprkuYlcclxuICAgICAgICBPYmplY3QuYXNzaWduKGNvbXBvbmVudFJlZi5pbnN0YW5jZSwgb3B0aW9ucy5jb250ZXh0KTtcclxuICAgICAgICAvLyBvdXRwdXRz5LqL5Lu257uR5a6aXHJcbiAgICAgICAgaWYgKG9wdGlvbnMuY29udGV4dCAmJiAhVXRpbC5pc1VuZGVmaW5lZChvcHRpb25zLmNvbnRleHQub3V0cHV0cykpIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gb3B0aW9ucy5jb250ZXh0Lm91dHB1dHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRleHQub3V0cHV0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlW2tleV0uc3Vic2NyaWJlKG9wdGlvbnMuY29udGV4dC5vdXRwdXRzW2tleV0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyA0LiDnoa7kv53nu4Tku7bop4blm77moLnmja7mlbDmja7og73lrp7ml7bliLfmlrDkuIrjgIJcclxuICAgICAgICAvLyDpgJrov4for6XlpITnkIblj6/ku6Xnoa7kv53nu4Tku7blj4rlrZDnu4Tku7bpg73lrozmiJDop6PmnpBcclxuICAgICAgICBpZiAoIW9wdGlvbnMubm90RGV0ZWN0Q2hhbmdlcykge1xyXG4gICAgICAgICAgICAvLyDlnKjnu4Tku7bnmoQgbWV0YWRhdGEg5Lit5aaC5p6c6K6+572u5LqGT25QdXNoIOadoeS7tu+8jOmCo+S5iOWPmOWMluajgOa1i+S4jeS8muWGjeasoeaJp+ihjCxcclxuICAgICAgICAgICAgLy8g5L2G5piv6LCD55So6K+l5pa55rOV77yM5Y+v5Lul56Gu5L+d5pWw5o2u5Y+Y5YyW6KKr5qOA5rWL5YiwXHJcbiAgICAgICAgICAgIGNvbXBvbmVudFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcclxuICAgICAgICAgICAgLy8g5LuO6K+l57uE5Lu25Yiw5YW25a2Q57uE5Lu25omn6KGM5LiA5qyh5Y+Y5YyW5qOA5rWLXHJcbiAgICAgICAgICAgIGNvbXBvbmVudFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY29tcG9uZW50UmVmO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==