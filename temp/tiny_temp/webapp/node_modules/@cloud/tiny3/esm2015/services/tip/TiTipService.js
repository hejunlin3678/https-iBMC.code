/* eslint-disable no-eq-null */
/* eslint-disable eqeqeq */
/**
 * 该类提供服务，用于管理Tip组件的创建和销毁
 * 服务中提供三个方法:
 * create(hostEle, config) 生成一个tip实例并返回对象，
 *   hostEle:宿主元素
 *   config:{
 *      position：tip元素位置
 *      maxWidth：最大宽度
 *      hasArrow：是否带箭头
 *      theme：tip色系 'black'/default
 *  }
 * 返回的实例对象中提供方法:
 * {
 *  show({ // 显示Tip组件
 *   content:弹出组件内容
 *   context:弹出组件上下文
 * })
 *  hide():隐藏并销毁Tip
 * }
 */
import { Injectable, NgZone, RendererFactory2, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { TiPopupService } from '../popup/TiPopupService';
import { Position } from '../../utils/Position';
import { Util } from '../../utils/Util';
import { TiRenderer } from '../renderer/TiRenderer';
import { TiTipContainerComponent } from './TiTipContainerComponent';
import { TiTipServiceModule } from './TiTipServiceModule';
import * as i0 from "@angular/core";
import * as i1 from "../popup/TiPopupService";
import * as i2 from "../renderer/TiRenderer";
import * as i3 from "@angular/common";
import * as i4 from "./TiTipServiceModule";
/**
 * tip提供了两种使用方式:
 *
 * 1.服务方式（见如下说明），使用该服务时需要引入模块TiTipServiceModule
 *
 * 2.指令方式：[TiTipDirective]{@link ../directives/TiTipDirective.html}
 *
 * <example-url>../tiny3demo/#/tip/tip-all</example-url>
 */
export class TiTipService {
    constructor(popService, rendererFactory, tiRenderer, zone, document) {
        this.popService = popService;
        this.tiRenderer = tiRenderer;
        this.zone = zone;
        this.document = document;
        /* tslint:disable:no-null-keyword */
        this.render = rendererFactory.createRenderer(null, null);
    }
    /**
     * 页面激活窗口改变事件处理，此处获取事件名称，该事件后续会在tip显示时注册，隐藏时销毁
     * 添加该事件用于解决的问题现象是：tip带链接，并且点击链接跳转至新开页面，因此，当返回先前页面时，tip不消失（因为未触发任何tip消失的事件），
     * 且移入其他出tip的元素，会出现页面有多个tip的现象
     */
    getVisibleChangeEventName() {
        const hiddenProperty = 'hidden' in this.document ? 'hidden' :
            'webkitHidden' in this.document ? 'webkitHidden' :
                'mozHidden' in this.document ? 'mozHidden' :
                    '';
        return hiddenProperty.replace(/hidden/i, 'visibilitychange');
    }
    create(hostEle, config) {
        // 宿主元素不存在情况下，不做处理
        if (!Util.isElement(hostEle)) {
            return;
        }
        const tipInstance = this.createTip(hostEle, config);
        this.addTriggerEvent(hostEle, config, tipInstance);
        return tipInstance;
    }
    /**
     * 创建Tip实例
     *
     * @param hostEle tip生成所依附的宿主元素
     *
     * @param config tip属性配置
     *
     * @returns 生成的Tip实例对象如下：
     *
     * ```
     * {
     *      // 显示tip方法
     *      // @param content {string | TemplateRef<any> | any} tip显示内容，可为字符串/ng-template/component，具体用法见示例
     *      // @param context {any} tip显示内容对应的上下文，content类型为templateRef或Component形式时会用到该参数
     *      show: (content: string | TemplateRef<any> | any, context?: any) => void;
     *
     *      // 隐藏tip方法
     *      hide: () => void;
     * }
     * ```
     */
    createTip(hostEle, config) {
        const popInstance = this.popService.create(TiTipContainerComponent); // tip弹出服务实例，可通过调用show/hide方法切换组件的显示状态
        let tipComponentRef; // 生成好的 tip 组件实例对象componentRef
        const visibilityChangeEvent = this.getVisibleChangeEventName();
        let visibleChangeEvtHandle;
        // 组件添加全局事件销毁相关处理
        let eventHandles = []; // 用于存储事件句柄，事件句柄在事件取消时需要用到
        // 隐藏处理函数
        const hideFn = () => {
            if (tipComponentRef != null) {
                // 销毁弹出元素
                popInstance.hide();
                // 通过执行事件返回句柄方法解绑事件
                Position.removePosChangeEvts(eventHandles);
                if (config.registerVisibilityChangeEvent !== false) {
                    visibleChangeEvtHandle();
                }
                tipComponentRef = null;
            }
        };
        return {
            show: (content, context) => {
                if (Util.isUndefined(content) || content === '') {
                    return;
                }
                // 显示Tip元素
                tipComponentRef = this.showTip({
                    popInstance,
                    hostEle,
                    content,
                    context,
                    config
                });
                // 添加全局事件，用于控制特殊情况下宿主位置改变时Tip的隐藏
                eventHandles = Position.addPosChangeEvts(hideFn, this.render);
                if (config.registerVisibilityChangeEvent !== false) {
                    visibleChangeEvtHandle = this.render.listen(this.document, visibilityChangeEvent, hideFn);
                }
                return tipComponentRef;
            },
            hide: () => {
                hideFn();
            },
            // 销毁tip
            destroy: () => {
                // 销毁tip前先隐藏
                hideFn();
            }
        };
    }
    // 根据trigger配置为宿主元素添加事件，该事件用于控制tip的显示/隐藏
    addTriggerEvent(hostEle, config, tipInstance) {
        // 非mouse情况下，不用做事件处理
        if (config.trigger !== 'mouse') {
            return;
        }
        let tipComponentRef = null;
        // 默认情况下，使用mouse进行tip显示和隐藏控制（只对指令形式有效）
        this.zone.runOutsideAngular(() => {
            const unlistenMouseenterFn = this.render.listen(hostEle, 'mouseenter', () => {
                if (typeof config.showFn !== 'function') {
                    return;
                }
                const showInfo = config.showFn();
                if (!showInfo) {
                    return;
                }
                this.zone.run(() => {
                    tipComponentRef = tipInstance.show(showInfo.content, showInfo.context);
                    if (!tipComponentRef) {
                        return;
                    }
                    // 根据trigger配置添加tip元素本身事件，此处事件用于支持移出tip元素时tip消失
                    const targetEle = tipComponentRef.location.nativeElement;
                    // eslint-disable-next-line max-nested-callbacks
                    this.render.listen(targetEle, 'mouseleave', (event) => {
                        /**
                         * 此处处理是为了解决Chrome高版本下，连续点击tip区域情况下，导致tip消失的问题
                         * 【问题原因】chrome高版本（chrome60以上版本）下，连续的click事件会触发tipEle的mouseleave事件,
                         * 从而导致tip消失
                         * 【解决方案】如mouseleve事件是由tip元素本身点击触发的，则event.relatedTarget为null，则通过该
                         * 方式进行特殊情况排除
                         */
                        if (event.relatedTarget === null) {
                            return;
                        }
                        tipInstance.hide();
                        tipComponentRef = null;
                    });
                });
            });
            const unlistenMouseleaveFn = this.render.listen(hostEle, 'mouseleave', (event) => {
                // 鼠标移入tip时，tip不消失
                if (tipComponentRef && !tipComponentRef.location.nativeElement.contains(event.relatedTarget)) {
                    this.zone.run(() => {
                        tipInstance.hide();
                        tipComponentRef = null;
                    });
                }
            });
            // 给实例添加销毁方法
            tipInstance.destroy = () => {
                // 先隐藏tip示例再取消监听事件
                tipInstance.hide();
                unlistenMouseenterFn();
                unlistenMouseleaveFn();
            };
        });
    }
    showTip(options) {
        const tipComponentRef = options.popInstance.show({
            content: options.content,
            contentContext: options.context,
            container: 'body'
        });
        const targetEle = tipComponentRef.location.nativeElement;
        this.tiRenderer.setStyles(targetEle, {
            left: '-9999px',
            top: '-9999px'
        });
        this.setTipTheme(targetEle, options.config);
        // 计算元素宽高时，需要确保元素已生成
        this.setTipWidth(targetEle, options.config);
        this.setPosition(options.hostEle, targetEle, options.config);
        return tipComponentRef;
    }
    setTipTheme(ele, config) {
        if (!config || !config.theme) {
            return;
        }
        if (config.theme === 'black') {
            this.render.addClass(ele, 'ti3-tip-black-theme');
        }
        else if (config.theme === 'white') {
            this.render.addClass(ele, 'ti3-tip-white-theme');
        }
    }
    setTipWidth(ele, config) {
        const maxWidth = parseInt((config && config.maxWidth) || TiTipService.DEFAULT_WIDTH, 10);
        // 修复SSR错误：ERROR TypeError: ele.getBoundingClientRect is not a function
        if (typeof ele.getBoundingClientRect !== 'function') {
            return;
        }
        const targetWidth = ele.getBoundingClientRect().width;
        if (targetWidth > maxWidth) {
            // 如果宽度超过最大值，重新设置当前tip的内容宽度
            this.render.setStyle(ele, 'width', `${maxWidth}px`);
        }
    }
    setPosition(hostEle, targetEle, config) {
        const result = Position.setPosition({
            targetEle,
            hostEle,
            hostEleX: config.hostEleX,
            position: config && config.position || 'auto',
            hostSpace: TiTipService.SPACE,
            fixMaxHeight: true,
            hasOffsetFix: true
        });
        const position = result.position;
        if (!config || config.hasArrow !== false) { // 未定义或定义为false情况下都需要加该样式类控制三角样式
            this.render.addClass(targetEle, `ti3-tooltip-${position}`);
        }
        // 设置该样式类是为了支持鼠标移入Tip不消失：使用该样式类用于确保tip和宿主元素连接处的DOM在tip范围内
        this.render.addClass(targetEle.querySelector('.ti3-tooltip-sqr'), `ti3-tooltip-${position}-sqr`);
        // 设置当前tip的内容最大高度，超出显示滚动条
        this.tiRenderer.setStyles(targetEle.querySelector('.ti3-tooltip-content'), {
            maxHeight: result.avilableHeight
        });
    }
}
TiTipService.DEFAULT_WIDTH = 276; // tip换行宽度
TiTipService.SPACE = 6.5 + 5; // tip框与元素本身的距离 = 三角宽高 + tip三角到触发tip的内容区域的距离
TiTipService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TiTipService_Factory() { return new TiTipService(i0.ɵɵinject(i1.TiPopupService), i0.ɵɵinject(i0.RendererFactory2), i0.ɵɵinject(i2.TiRenderer), i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i3.DOCUMENT)); }, token: TiTipService, providedIn: i4.TiTipServiceModule });
TiTipService.decorators = [
    { type: Injectable, args: [{
                providedIn: TiTipServiceModule
            },] }
];
TiTipService.ctorParameters = () => [
    { type: TiPopupService },
    { type: RendererFactory2 },
    { type: TiRenderer },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlUaXBTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL3NlcnZpY2VzL3RpcC9UaVRpcFNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsK0JBQStCO0FBQy9CLDJCQUEyQjtBQUMzQjs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUNILE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sRUFBYSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTNDLE9BQU8sRUFBNkIsY0FBYyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDcEYsT0FBTyxFQUFFLFFBQVEsRUFBb0MsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXBELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7Ozs7QUFZMUQ7Ozs7Ozs7O0dBUUc7QUFJSCxNQUFNLE9BQU8sWUFBWTtJQUlyQixZQUFvQixVQUFtRCxFQUMzRCxlQUFpQyxFQUFVLFVBQXNCLEVBQVUsSUFBWSxFQUMzRCxRQUFRO1FBRjVCLGVBQVUsR0FBVixVQUFVLENBQXlDO1FBQ2hCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQzNELGFBQVEsR0FBUixRQUFRLENBQUE7UUFDeEMsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUNEOzs7O09B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T3VCLDBCQUFhLEdBQVcsR0FBRyxDQUFDLENBQUMsVUFBVTtBQUN2QyxrQkFBSyxHQUFXLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyw0Q0FBNEM7OztZQUxoRyxVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLGtCQUFrQjthQUNqQzs7O1lBN0JtQyxjQUFjO1lBSEksZ0JBQWdCO1lBTTdELFVBQVU7WUFOZ0IsTUFBTTs0Q0F1Q3RCLE1BQU0sU0FBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tZXEtbnVsbCAqL1xyXG4vKiBlc2xpbnQtZGlzYWJsZSBlcWVxZXEgKi9cclxuLyoqXHJcbiAqIOivpeexu+aPkOS+m+acjeWKoe+8jOeUqOS6jueuoeeQhlRpcOe7hOS7tueahOWIm+W7uuWSjOmUgOavgVxyXG4gKiDmnI3liqHkuK3mj5DkvpvkuInkuKrmlrnms5U6XHJcbiAqIGNyZWF0ZShob3N0RWxlLCBjb25maWcpIOeUn+aIkOS4gOS4qnRpcOWunuS+i+W5tui/lOWbnuWvueixoe+8jFxyXG4gKiAgIGhvc3RFbGU65a6/5Li75YWD57SgXHJcbiAqICAgY29uZmlnOntcclxuICogICAgICBwb3NpdGlvbu+8mnRpcOWFg+e0oOS9jee9rlxyXG4gKiAgICAgIG1heFdpZHRo77ya5pyA5aSn5a695bqmXHJcbiAqICAgICAgaGFzQXJyb3fvvJrmmK/lkKbluKbnrq3lpLRcclxuICogICAgICB0aGVtZe+8mnRpcOiJsuezuyAnYmxhY2snL2RlZmF1bHRcclxuICogIH1cclxuICog6L+U5Zue55qE5a6e5L6L5a+56LGh5Lit5o+Q5L6b5pa55rOVOlxyXG4gKiB7XHJcbiAqICBzaG93KHsgLy8g5pi+56S6VGlw57uE5Lu2XHJcbiAqICAgY29udGVudDrlvLnlh7rnu4Tku7blhoXlrrlcclxuICogICBjb250ZXh0OuW8ueWHuue7hOS7tuS4iuS4i+aWh1xyXG4gKiB9KVxyXG4gKiAgaGlkZSgpOumakOiXj+W5tumUgOavgVRpcFxyXG4gKiB9XHJcbiAqL1xyXG5pbXBvcnQgeyBDb21wb25lbnRSZWYsIEluamVjdGFibGUsIE5nWm9uZSwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5cclxuaW1wb3J0IHsgVGlDb250ZW50VHlwZSwgVGlQb3BVcFJlZiwgVGlQb3B1cFNlcnZpY2UgfSBmcm9tICcuLi9wb3B1cC9UaVBvcHVwU2VydmljZSc7XHJcbmltcG9ydCB7IFBvc2l0aW9uLCBUaVBvc2l0aW9uUmVzdWx0LCBUaVBvc2l0aW9uVHlwZSB9IGZyb20gJy4uLy4uL3V0aWxzL1Bvc2l0aW9uJztcclxuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uLy4uL3V0aWxzL1V0aWwnO1xyXG5pbXBvcnQgeyBUaVJlbmRlcmVyIH0gZnJvbSAnLi4vcmVuZGVyZXIvVGlSZW5kZXJlcic7XHJcblxyXG5pbXBvcnQgeyBUaVRpcENvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4vVGlUaXBDb250YWluZXJDb21wb25lbnQnO1xyXG5pbXBvcnQgeyBUaVRpcFNlcnZpY2VNb2R1bGUgfSBmcm9tICcuL1RpVGlwU2VydmljZU1vZHVsZSc7XHJcbmltcG9ydCB7IFRpVGlwQ29uZmlnLCBUaVRpcFJlZiwgVGlUaXBTaG93SW5mbyB9IGZyb20gJy4vVGlUaXBJbnRlcmZhY2UnO1xyXG4vKipcclxuICogQGlnbm9yZVxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBUaVRpcFNob3dDb25maWcge1xyXG4gICAgcG9wSW5zdGFuY2U6IFRpUG9wVXBSZWY7XHJcbiAgICBob3N0RWxlOiBFbGVtZW50O1xyXG4gICAgY29udGVudDogVGlDb250ZW50VHlwZTtcclxuICAgIGNvbnRleHQ6IGFueTtcclxuICAgIGNvbmZpZzogVGlUaXBDb25maWc7XHJcbn1cclxuLyoqXHJcbiAqIHRpcOaPkOS+m+S6huS4pOenjeS9v+eUqOaWueW8jzpcclxuICpcclxuICogMS7mnI3liqHmlrnlvI/vvIjop4HlpoLkuIvor7TmmI7vvInvvIzkvb/nlKjor6XmnI3liqHml7bpnIDopoHlvJXlhaXmqKHlnZdUaVRpcFNlcnZpY2VNb2R1bGVcclxuICpcclxuICogMi7mjIfku6TmlrnlvI/vvJpbVGlUaXBEaXJlY3RpdmVde0BsaW5rIC4uL2RpcmVjdGl2ZXMvVGlUaXBEaXJlY3RpdmUuaHRtbH1cclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnkzZGVtby8jL3RpcC90aXAtYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46IFRpVGlwU2VydmljZU1vZHVsZVxyXG59KVxyXG5leHBvcnQgY2xhc3MgVGlUaXBTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfV0lEVEg6IG51bWJlciA9IDI3NjsgLy8gdGlw5o2i6KGM5a695bqmXHJcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBTUEFDRTogbnVtYmVyID0gNi41ICsgNTsgLy8gdGlw5qGG5LiO5YWD57Sg5pys6Lqr55qE6Led56a7ID0g5LiJ6KeS5a696auYICsgdGlw5LiJ6KeS5Yiw6Kem5Y+RdGlw55qE5YaF5a655Yy65Z+f55qE6Led56a7XHJcbiAgICBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwb3BTZXJ2aWNlOiBUaVBvcHVwU2VydmljZTxUaVRpcENvbnRhaW5lckNvbXBvbmVudD4sXHJcbiAgICAgICAgICAgICAgICByZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeTIsIHByaXZhdGUgdGlSZW5kZXJlcjogVGlSZW5kZXJlciwgcHJpdmF0ZSB6b25lOiBOZ1pvbmVcclxuICAgICAgICAgICAgICAgICwgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudCkge1xyXG4gICAgICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZTpuby1udWxsLWtleXdvcmQgKi9cclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIgPSByZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOmhtemdoua/gOa0u+eql+WPo+aUueWPmOS6i+S7tuWkhOeQhu+8jOatpOWkhOiOt+WPluS6i+S7tuWQjeensO+8jOivpeS6i+S7tuWQjue7reS8muWcqHRpcOaYvuekuuaXtuazqOWGjO+8jOmakOiXj+aXtumUgOavgVxyXG4gICAgICog5re75Yqg6K+l5LqL5Lu255So5LqO6Kej5Yaz55qE6Zeu6aKY546w6LGh5piv77yadGlw5bim6ZO+5o6l77yM5bm25LiU54K55Ye76ZO+5o6l6Lez6L2s6Iez5paw5byA6aG16Z2i77yM5Zug5q2k77yM5b2T6L+U5Zue5YWI5YmN6aG16Z2i5pe277yMdGlw5LiN5raI5aSx77yI5Zug5Li65pyq6Kem5Y+R5Lu75L2VdGlw5raI5aSx55qE5LqL5Lu277yJ77yMXHJcbiAgICAgKiDkuJTnp7vlhaXlhbbku5blh7p0aXDnmoTlhYPntKDvvIzkvJrlh7rnjrDpobXpnaLmnInlpJrkuKp0aXDnmoTnjrDosaFcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBnZXRWaXNpYmxlQ2hhbmdlRXZlbnROYW1lKCk6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgaGlkZGVuUHJvcGVydHk6IHN0cmluZyA9ICdoaWRkZW4nIGluIHRoaXMuZG9jdW1lbnQgPyAnaGlkZGVuJyA6XHJcbiAgICAgICAgICAgICd3ZWJraXRIaWRkZW4nIGluIHRoaXMuZG9jdW1lbnQgPyAnd2Via2l0SGlkZGVuJyA6XHJcbiAgICAgICAgICAgICAgICAnbW96SGlkZGVuJyBpbiB0aGlzLmRvY3VtZW50ID8gJ21vekhpZGRlbicgOlxyXG4gICAgICAgICAgICAgICAgICAgICcnO1xyXG5cclxuICAgICAgICByZXR1cm4gaGlkZGVuUHJvcGVydHkucmVwbGFjZSgvaGlkZGVuL2ksICd2aXNpYmlsaXR5Y2hhbmdlJyk7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgY3JlYXRlKGhvc3RFbGU6IEVsZW1lbnQsIGNvbmZpZz86IFRpVGlwQ29uZmlnKTogVGlUaXBSZWYge1xyXG4gICAgICAgIC8vIOWuv+S4u+WFg+e0oOS4jeWtmOWcqOaDheWGteS4i++8jOS4jeWBmuWkhOeQhlxyXG4gICAgICAgIGlmICghVXRpbC5pc0VsZW1lbnQoaG9zdEVsZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0aXBJbnN0YW5jZTogVGlUaXBSZWYgPSB0aGlzLmNyZWF0ZVRpcChob3N0RWxlLCBjb25maWcpO1xyXG4gICAgICAgIHRoaXMuYWRkVHJpZ2dlckV2ZW50KGhvc3RFbGUsIGNvbmZpZywgdGlwSW5zdGFuY2UpO1xyXG5cclxuICAgICAgICByZXR1cm4gdGlwSW5zdGFuY2U7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7ulRpcOWunuS+i1xyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSBob3N0RWxlIHRpcOeUn+aIkOaJgOS+nemZhOeahOWuv+S4u+WFg+e0oFxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSBjb25maWcgdGlw5bGe5oCn6YWN572uXHJcbiAgICAgKlxyXG4gICAgICogQHJldHVybnMg55Sf5oiQ55qEVGlw5a6e5L6L5a+56LGh5aaC5LiL77yaXHJcbiAgICAgKlxyXG4gICAgICogYGBgXHJcbiAgICAgKiB7XHJcbiAgICAgKiAgICAgIC8vIOaYvuekunRpcOaWueazlVxyXG4gICAgICogICAgICAvLyBAcGFyYW0gY29udGVudCB7c3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PiB8IGFueX0gdGlw5pi+56S65YaF5a6577yM5Y+v5Li65a2X56ym5LiyL25nLXRlbXBsYXRlL2NvbXBvbmVudO+8jOWFt+S9k+eUqOazleingeekuuS+i1xyXG4gICAgICogICAgICAvLyBAcGFyYW0gY29udGV4dCB7YW55fSB0aXDmmL7npLrlhoXlrrnlr7nlupTnmoTkuIrkuIvmlofvvIxjb250ZW5057G75Z6L5Li6dGVtcGxhdGVSZWbmiJZDb21wb25lbnTlvaLlvI/ml7bkvJrnlKjliLDor6Xlj4LmlbBcclxuICAgICAqICAgICAgc2hvdzogKGNvbnRlbnQ6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4gfCBhbnksIGNvbnRleHQ/OiBhbnkpID0+IHZvaWQ7XHJcbiAgICAgKlxyXG4gICAgICogICAgICAvLyDpmpDol490aXDmlrnms5VcclxuICAgICAqICAgICAgaGlkZTogKCkgPT4gdm9pZDtcclxuICAgICAqIH1cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGNyZWF0ZVRpcChob3N0RWxlOiBFbGVtZW50LCBjb25maWc/OiBUaVRpcENvbmZpZyk6IFRpVGlwUmVmIHtcclxuICAgICAgICBjb25zdCBwb3BJbnN0YW5jZTogVGlQb3BVcFJlZiA9IHRoaXMucG9wU2VydmljZS5jcmVhdGUoVGlUaXBDb250YWluZXJDb21wb25lbnQpOyAvLyB0aXDlvLnlh7rmnI3liqHlrp7kvovvvIzlj6/pgJrov4fosIPnlKhzaG93L2hpZGXmlrnms5XliIfmjaLnu4Tku7bnmoTmmL7npLrnirbmgIFcclxuICAgICAgICBsZXQgdGlwQ29tcG9uZW50UmVmOiBhbnk7IC8vIOeUn+aIkOWlveeahCB0aXAg57uE5Lu25a6e5L6L5a+56LGhY29tcG9uZW50UmVmXHJcbiAgICAgICAgY29uc3QgdmlzaWJpbGl0eUNoYW5nZUV2ZW50OiBzdHJpbmcgPSB0aGlzLmdldFZpc2libGVDaGFuZ2VFdmVudE5hbWUoKTtcclxuICAgICAgICBsZXQgdmlzaWJsZUNoYW5nZUV2dEhhbmRsZTogKCkgPT4gdm9pZDtcclxuXHJcbiAgICAgICAgLy8g57uE5Lu25re75Yqg5YWo5bGA5LqL5Lu26ZSA5q+B55u45YWz5aSE55CGXHJcbiAgICAgICAgbGV0IGV2ZW50SGFuZGxlczogQXJyYXk8KCkgPT4gdm9pZD4gPSBbXTsgLy8g55So5LqO5a2Y5YKo5LqL5Lu25Y+l5p+E77yM5LqL5Lu25Y+l5p+E5Zyo5LqL5Lu25Y+W5raI5pe26ZyA6KaB55So5YiwXHJcblxyXG4gICAgICAgIC8vIOmakOiXj+WkhOeQhuWHveaVsFxyXG4gICAgICAgIGNvbnN0IGhpZGVGbjogKCkgPT4gdm9pZCA9XHJcbiAgICAgICAgICAgKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGlwQ29tcG9uZW50UmVmICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIC8vIOmUgOavgeW8ueWHuuWFg+e0oFxyXG4gICAgICAgICAgICAgICAgcG9wSW5zdGFuY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgLy8g6YCa6L+H5omn6KGM5LqL5Lu26L+U5Zue5Y+l5p+E5pa55rOV6Kej57uR5LqL5Lu2XHJcbiAgICAgICAgICAgICAgICBQb3NpdGlvbi5yZW1vdmVQb3NDaGFuZ2VFdnRzKGV2ZW50SGFuZGxlcyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29uZmlnLnJlZ2lzdGVyVmlzaWJpbGl0eUNoYW5nZUV2ZW50ICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZpc2libGVDaGFuZ2VFdnRIYW5kbGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRpcENvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBzaG93OiAoY29udGVudDogc3RyaW5nLCBjb250ZXh0PzogYW55KTogQ29tcG9uZW50UmVmPGFueT4gfCB1bmRlZmluZWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKFV0aWwuaXNVbmRlZmluZWQoY29udGVudCkgfHwgY29udGVudCA9PT0gJycpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyDmmL7npLpUaXDlhYPntKBcclxuICAgICAgICAgICAgICAgIHRpcENvbXBvbmVudFJlZiA9IHRoaXMuc2hvd1RpcCh7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9wSW5zdGFuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgaG9zdEVsZSxcclxuICAgICAgICAgICAgICAgICAgICBjb250ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIC8vIOa3u+WKoOWFqOWxgOS6i+S7tu+8jOeUqOS6juaOp+WItueJueauiuaDheWGteS4i+Wuv+S4u+S9jee9ruaUueWPmOaXtlRpcOeahOmakOiXj1xyXG4gICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVzID0gUG9zaXRpb24uYWRkUG9zQ2hhbmdlRXZ0cyhoaWRlRm4sIHRoaXMucmVuZGVyKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb25maWcucmVnaXN0ZXJWaXNpYmlsaXR5Q2hhbmdlRXZlbnQgIT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZUNoYW5nZUV2dEhhbmRsZSA9IHRoaXMucmVuZGVyLmxpc3Rlbih0aGlzLmRvY3VtZW50LCB2aXNpYmlsaXR5Q2hhbmdlRXZlbnQsIGhpZGVGbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRpcENvbXBvbmVudFJlZjtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgaGlkZTogKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgaGlkZUZuKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIC8vIOmUgOavgXRpcFxyXG4gICAgICAgICAgICBkZXN0cm95OiAoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyDplIDmr4F0aXDliY3lhYjpmpDol49cclxuICAgICAgICAgICAgICAgIGhpZGVGbigpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5qC55o2udHJpZ2dlcumFjee9ruS4uuWuv+S4u+WFg+e0oOa3u+WKoOS6i+S7tu+8jOivpeS6i+S7tueUqOS6juaOp+WItnRpcOeahOaYvuekui/pmpDol49cclxuICAgIHByaXZhdGUgYWRkVHJpZ2dlckV2ZW50KGhvc3RFbGU6IEVsZW1lbnQsIGNvbmZpZzogVGlUaXBDb25maWcsIHRpcEluc3RhbmNlOiBUaVRpcFJlZik6IHZvaWQge1xyXG4gICAgICAgIC8vIOmdnm1vdXNl5oOF5Ya15LiL77yM5LiN55So5YGa5LqL5Lu25aSE55CGXHJcbiAgICAgICAgaWYgKGNvbmZpZy50cmlnZ2VyICE9PSAnbW91c2UnKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHRpcENvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPGFueT4gPSBudWxsO1xyXG4gICAgICAgIC8vIOm7mOiupOaDheWGteS4i++8jOS9v+eUqG1vdXNl6L+b6KGMdGlw5pi+56S65ZKM6ZqQ6JeP5o6n5Yi277yI5Y+q5a+55oyH5Luk5b2i5byP5pyJ5pWI77yJXHJcbiAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdW5saXN0ZW5Nb3VzZWVudGVyRm46ICgpID0+IHZvaWQgPSB0aGlzLnJlbmRlci5saXN0ZW4oaG9zdEVsZSwgJ21vdXNlZW50ZXInLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5zaG93Rm4gIT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaG93SW5mbzogVGlUaXBTaG93SW5mbyA9IGNvbmZpZy5zaG93Rm4oKTtcclxuICAgICAgICAgICAgICAgIGlmICghc2hvd0luZm8pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aXBDb21wb25lbnRSZWYgPSB0aXBJbnN0YW5jZS5zaG93KHNob3dJbmZvLmNvbnRlbnQsIHNob3dJbmZvLmNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGlwQ29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5qC55o2udHJpZ2dlcumFjee9rua3u+WKoHRpcOWFg+e0oOacrOi6q+S6i+S7tu+8jOatpOWkhOS6i+S7tueUqOS6juaUr+aMgeenu+WHunRpcOWFg+e0oOaXtnRpcOa2iOWksVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEVsZTogRWxlbWVudCA9IHRpcENvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbmVzdGVkLWNhbGxiYWNrc1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLmxpc3Rlbih0YXJnZXRFbGUsICdtb3VzZWxlYXZlJywgKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgKiDmraTlpITlpITnkIbmmK/kuLrkuobop6PlhrNDaHJvbWXpq5jniYjmnKzkuIvvvIzov57nu63ngrnlh7t0aXDljLrln5/mg4XlhrXkuIvvvIzlr7zoh7R0aXDmtojlpLHnmoTpl67pophcclxuICAgICAgICAgICAgICAgICAgICAgICAgICog44CQ6Zeu6aKY5Y6f5Zug44CRY2hyb21l6auY54mI5pys77yIY2hyb21lNjDku6XkuIrniYjmnKzvvInkuIvvvIzov57nu63nmoRjbGlja+S6i+S7tuS8muinpuWPkXRpcEVsZeeahG1vdXNlbGVhdmXkuovku7YsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAqIOS7juiAjOWvvOiHtHRpcOa2iOWksVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgKiDjgJDop6PlhrPmlrnmoYjjgJHlpoJtb3VzZWxldmXkuovku7bmmK/nlLF0aXDlhYPntKDmnKzouqvngrnlh7vop6blj5HnmoTvvIzliJlldmVudC5yZWxhdGVkVGFyZ2V05Li6bnVsbO+8jOWImemAmui/h+ivpVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgKiDmlrnlvI/ov5vooYznibnmrormg4XlhrXmjpLpmaRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5yZWxhdGVkVGFyZ2V0ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGlwSW5zdGFuY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXBDb21wb25lbnRSZWYgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBjb25zdCB1bmxpc3Rlbk1vdXNlbGVhdmVGbjogKCkgPT4gdm9pZCA9IHRoaXMucmVuZGVyLmxpc3Rlbihob3N0RWxlLCAnbW91c2VsZWF2ZScsIChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8g6byg5qCH56e75YWldGlw5pe277yMdGlw5LiN5raI5aSxXHJcbiAgICAgICAgICAgICAgICBpZiAodGlwQ29tcG9uZW50UmVmICYmICF0aXBDb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5jb250YWlucyhldmVudC5yZWxhdGVkVGFyZ2V0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXBJbnN0YW5jZS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpcENvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyDnu5nlrp7kvovmt7vliqDplIDmr4Hmlrnms5VcclxuICAgICAgICAgICAgdGlwSW5zdGFuY2UuZGVzdHJveSA9ICgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIOWFiOmakOiXj3RpcOekuuS+i+WGjeWPlua2iOebkeWQrOS6i+S7tlxyXG4gICAgICAgICAgICAgICAgdGlwSW5zdGFuY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgdW5saXN0ZW5Nb3VzZWVudGVyRm4oKTtcclxuICAgICAgICAgICAgICAgIHVubGlzdGVuTW91c2VsZWF2ZUZuKCk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzaG93VGlwKG9wdGlvbnM6IFRpVGlwU2hvd0NvbmZpZyk6IENvbXBvbmVudFJlZjxhbnk+IHtcclxuICAgICAgICBjb25zdCB0aXBDb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxhbnk+ID0gb3B0aW9ucy5wb3BJbnN0YW5jZS5zaG93KHtcclxuICAgICAgICAgICAgY29udGVudDogb3B0aW9ucy5jb250ZW50LFxyXG4gICAgICAgICAgICBjb250ZW50Q29udGV4dDogb3B0aW9ucy5jb250ZXh0LFxyXG4gICAgICAgICAgICBjb250YWluZXI6ICdib2R5J1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IHRhcmdldEVsZTogRWxlbWVudCA9IHRpcENvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgIHRoaXMudGlSZW5kZXJlci5zZXRTdHlsZXModGFyZ2V0RWxlLCB7XHJcbiAgICAgICAgICAgIGxlZnQ6ICctOTk5OXB4JyxcclxuICAgICAgICAgICAgdG9wOiAnLTk5OTlweCdcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNldFRpcFRoZW1lKHRhcmdldEVsZSwgb3B0aW9ucy5jb25maWcpO1xyXG4gICAgICAgIC8vIOiuoeeul+WFg+e0oOWuvemrmOaXtu+8jOmcgOimgeehruS/neWFg+e0oOW3sueUn+aIkFxyXG4gICAgICAgIHRoaXMuc2V0VGlwV2lkdGgodGFyZ2V0RWxlLCBvcHRpb25zLmNvbmZpZyk7XHJcbiAgICAgICAgdGhpcy5zZXRQb3NpdGlvbihvcHRpb25zLmhvc3RFbGUsIHRhcmdldEVsZSwgb3B0aW9ucy5jb25maWcpO1xyXG5cclxuICAgICAgICByZXR1cm4gdGlwQ29tcG9uZW50UmVmO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0VGlwVGhlbWUoZWxlOiBFbGVtZW50LCBjb25maWc6IFRpVGlwQ29uZmlnKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCFjb25maWcgfHwgIWNvbmZpZy50aGVtZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb25maWcudGhlbWUgPT09ICdibGFjaycpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIuYWRkQ2xhc3MoZWxlLCAndGkzLXRpcC1ibGFjay10aGVtZScpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnRoZW1lID09PSAnd2hpdGUnKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKGVsZSwgJ3RpMy10aXAtd2hpdGUtdGhlbWUnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRUaXBXaWR0aChlbGU6IEVsZW1lbnQsIGNvbmZpZzogVGlUaXBDb25maWcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBtYXhXaWR0aDogbnVtYmVyID0gcGFyc2VJbnQoKGNvbmZpZyAmJiBjb25maWcubWF4V2lkdGgpIHx8IFRpVGlwU2VydmljZS5ERUZBVUxUX1dJRFRIIGFzIGFueSwgMTApO1xyXG4gICAgICAgIC8vIOS/ruWkjVNTUumUmeivr++8mkVSUk9SIFR5cGVFcnJvcjogZWxlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBub3QgYSBmdW5jdGlvblxyXG4gICAgICAgIGlmICh0eXBlb2YgZWxlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRhcmdldFdpZHRoOiBudW1iZXIgPSBlbGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGg7XHJcbiAgICAgICAgaWYgKHRhcmdldFdpZHRoID4gbWF4V2lkdGgpIHtcclxuICAgICAgICAgICAgLy8g5aaC5p6c5a695bqm6LaF6L+H5pyA5aSn5YC877yM6YeN5paw6K6+572u5b2T5YmNdGlw55qE5YaF5a655a695bqmXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGVsZSwgJ3dpZHRoJywgYCR7bWF4V2lkdGh9cHhgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRQb3NpdGlvbihob3N0RWxlOiBFbGVtZW50LCB0YXJnZXRFbGU6IEVsZW1lbnQsIGNvbmZpZzogVGlUaXBDb25maWcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCByZXN1bHQ6IFRpUG9zaXRpb25SZXN1bHQgPSBQb3NpdGlvbi5zZXRQb3NpdGlvbih7XHJcbiAgICAgICAgICAgIHRhcmdldEVsZSxcclxuICAgICAgICAgICAgaG9zdEVsZSxcclxuICAgICAgICAgICAgaG9zdEVsZVg6IGNvbmZpZy5ob3N0RWxlWCxcclxuICAgICAgICAgICAgcG9zaXRpb246IGNvbmZpZyAmJiBjb25maWcucG9zaXRpb24gfHwgJ2F1dG8nLFxyXG4gICAgICAgICAgICBob3N0U3BhY2U6IFRpVGlwU2VydmljZS5TUEFDRSxcclxuICAgICAgICAgICAgZml4TWF4SGVpZ2h0OiB0cnVlLFxyXG4gICAgICAgICAgICBoYXNPZmZzZXRGaXg6IHRydWVcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBwb3NpdGlvbjogVGlQb3NpdGlvblR5cGUgPSByZXN1bHQucG9zaXRpb247XHJcbiAgICAgICAgaWYgKCFjb25maWcgfHwgY29uZmlnLmhhc0Fycm93ICE9PSBmYWxzZSkgey8vIOacquWumuS5ieaIluWumuS5ieS4umZhbHNl5oOF5Ya15LiL6YO96ZyA6KaB5Yqg6K+l5qC35byP57G75o6n5Yi25LiJ6KeS5qC35byPXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKHRhcmdldEVsZSwgYHRpMy10b29sdGlwLSR7cG9zaXRpb259YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOiuvue9ruivpeagt+W8j+exu+aYr+S4uuS6huaUr+aMgem8oOagh+enu+WFpVRpcOS4jea2iOWkse+8muS9v+eUqOivpeagt+W8j+exu+eUqOS6juehruS/nXRpcOWSjOWuv+S4u+WFg+e0oOi/nuaOpeWkhOeahERPTeWcqHRpcOiMg+WbtOWGhVxyXG4gICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKHRhcmdldEVsZS5xdWVyeVNlbGVjdG9yKCcudGkzLXRvb2x0aXAtc3FyJyksIGB0aTMtdG9vbHRpcC0ke3Bvc2l0aW9ufS1zcXJgKTtcclxuICAgICAgICAvLyDorr7nva7lvZPliY10aXDnmoTlhoXlrrnmnIDlpKfpq5jluqbvvIzotoXlh7rmmL7npLrmu5rliqjmnaFcclxuICAgICAgICB0aGlzLnRpUmVuZGVyZXIuc2V0U3R5bGVzKHRhcmdldEVsZS5xdWVyeVNlbGVjdG9yKCcudGkzLXRvb2x0aXAtY29udGVudCcpLCB7XHJcbiAgICAgICAgICAgIG1heEhlaWdodDogcmVzdWx0LmF2aWxhYmxlSGVpZ2h0XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuIl19