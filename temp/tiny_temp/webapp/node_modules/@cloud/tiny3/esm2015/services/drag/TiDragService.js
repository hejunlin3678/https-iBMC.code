import { Injectable, RendererFactory2 } from '@angular/core';
import { TiRenderer } from '../renderer/TiRenderer';
import { Util } from '../../utils/Util';
import { TiDragServiceModule } from './TiDragServiceModule';
import * as i0 from "@angular/core";
import * as i1 from "../renderer/TiRenderer";
import * as i2 from "./TiDragServiceModule";
/**
 * 拖拽服务，适用于可拖拽元素不在html模板中显示声明的情况，除服务方式外，还提供了指令生成方式[TiDraggableDirective]{@link ../directives/TiDraggableDirective.html}，
 * 使用该服务时需要引入模块TiDragServiceModule
 *
 * <example-url>../tiny3demo/#/drag/drag-all</example-url>
 */
export class TiDragService {
    constructor(rendererFactory, tiRenderer) {
        this.tiRenderer = tiRenderer;
        /* tslint:disable:no-null-keyword */
        this.renderer = rendererFactory.createRenderer(null, null);
    }
    /**
     * 创建拖拽对象
     *
     * 函数返回值为
     * {
     * destroy: () => void
     * }
     */
    create(options) {
        const helper = options.helper; // 可拖拽元素，原生HTML类型
        const handle = options.handle || helper; // 拖拽生效元素,未定义情况下，默认为helper元素
        // 标志位，用于记录是否是拖拽引起的事件触发,在mousedown和mouseup中分别进行了置位
        let mouseStart = false;
        // 记录初始位置信息
        let originalPagePos;
        let originalPos;
        // 设置给helper元素的位置信息，用于位置设置及事件中参数传递
        let position;
        // 非定位元素情况下设置left/top无效，因此需先将其设置为relative定位
        // 修复SSR错误：ERROR ReferenceError: getComputedStyle is not defined
        const pos = typeof getComputedStyle !== 'undefined' ? getComputedStyle(helper).position : '';
        if (!/(fixed|absolute|relative)/.test(pos)) {
            this.renderer.setStyle(helper, 'position', 'relative');
        }
        // 拖拽时需要用到的mouse事件句柄记录
        let mouseMoveEvt;
        let mouseUpEvt;
        this.renderer.listen(handle, 'mousedown', (event) => {
            if (options.disabled) { // 灰化情况下不做处理
                return;
            }
            event.preventDefault(); // 阻止拖拽过程中文本的选中处理等操作
            mouseStart = true;
            // 初始拖拽时鼠标距离页面边距位置（包含滚动条在内）
            originalPagePos = {
                pageX: event.pageX,
                pageY: event.pageY
            };
            // 拖拽元素初始位置,由于获取到的位置为'xxpx',因此此处需要转化为数字
            originalPos = position = {
                left: parseInt(getComputedStyle(helper).left, 10) || 0,
                top: parseInt(getComputedStyle(helper).top, 10) || 0
            };
            // 触发初始拖拽事件
            triggerEvt('start');
            mouseMoveEvt = this.renderer.listen(document, 'mousemove', (evt) => {
                onMouseMove(evt);
            });
            mouseUpEvt = this.renderer.listen(document, 'mouseup', (evt) => {
                onMouseUp(evt);
            });
        });
        const onMouseMove = (evt) => {
            // 防止非拖拽触发的mousemove事件
            if (!mouseStart) {
                return;
            }
            evt.preventDefault(); // 阻止拖拽过程中的选中处理等操作
            const topPos = (options.axis === 'x')
                ? originalPos.top
                : (evt.pageY - originalPagePos.pageY + originalPos.top - document.body.scrollTop);
            const leftPos = (options.axis === 'y')
                ? originalPos.left
                : (evt.pageX - originalPagePos.pageX + originalPos.left - document.body.scrollLeft);
            position = {
                left: leftPos,
                top: topPos
            };
            // 触发拖拽时间，该事件中处理拖拽过程中的位置纠正
            triggerEvt('drag');
            this.tiRenderer.setStyles(helper, {
                left: `${position.left}px`,
                top: `${position.top}px`
            });
        };
        const onMouseUp = (evt) => {
            mouseStart = false;
            evt.preventDefault();
            triggerEvt('stop');
            // 拖拽停止后，解绑document上的相关事件
            mouseMoveEvt();
            mouseUpEvt();
        };
        const triggerEvt = (evtType) => {
            if (options[evtType]) {
                const ret = options[evtType]({ position, helper });
                if (typeof ret === 'object') {
                    position = Object.assign(Object.assign({}, ret), position);
                }
            }
        };
        return {
            destroy: () => {
                if (!Util.isUndefined(mouseMoveEvt)) {
                    mouseMoveEvt();
                }
                if (!Util.isUndefined(mouseUpEvt)) {
                    mouseUpEvt();
                }
            }
        };
    }
}
TiDragService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TiDragService_Factory() { return new TiDragService(i0.ɵɵinject(i0.RendererFactory2), i0.ɵɵinject(i1.TiRenderer)); }, token: TiDragService, providedIn: i2.TiDragServiceModule });
TiDragService.decorators = [
    { type: Injectable, args: [{
                providedIn: TiDragServiceModule
            },] }
];
TiDragService.ctorParameters = () => [
    { type: RendererFactory2 },
    { type: TiRenderer }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlEcmFnU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9zZXJ2aWNlcy9kcmFnL1RpRHJhZ1NlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxnQkFBZ0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDOzs7O0FBcUM1RDs7Ozs7R0FLRztBQUlILE1BQU0sT0FBTyxhQUFhO0lBRXRCLFlBQVksZUFBaUMsRUFBVSxVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3pFLG9DQUFvQztRQUNwQyxJQUFJLENBQUMsUUFBUSxHQUFHLGVBQWUsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFDRDs7Ozs7OztPQU9HO0lBQ0gsTUFBTSxDQUFDLE9BQTBCO1FBRzdCLE1BQU0sTUFBTSxHQUFZLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxpQkFBaUI7UUFDekQsTUFBTSxNQUFNLEdBQVksT0FBTyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsQ0FBQyw0QkFBNEI7UUFDOUUsa0RBQWtEO1FBQ2xELElBQUksVUFBVSxHQUFZLEtBQUssQ0FBQztRQUNoQyxXQUFXO1FBQ1gsSUFBSSxlQUdILENBQUM7UUFDRixJQUFJLFdBR0gsQ0FBQztRQUNGLGtDQUFrQztRQUNsQyxJQUFJLFFBR0gsQ0FBQztRQUNGLDJDQUEyQztRQUMzQyxnRUFBZ0U7UUFDaEUsTUFBTSxHQUFHLEdBQVcsT0FBTyxnQkFBZ0IsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFD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cG9ydCB7IEluamVjdGFibGUsIFJlbmRlcmVyMiwgUmVuZGVyZXJGYWN0b3J5MiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaVJlbmRlcmVyIH0gZnJvbSAnLi4vcmVuZGVyZXIvVGlSZW5kZXJlcic7XHJcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi91dGlscy9VdGlsJztcclxuaW1wb3J0IHsgVGlEcmFnU2VydmljZU1vZHVsZSB9IGZyb20gJy4vVGlEcmFnU2VydmljZU1vZHVsZSc7XHJcbi8vIFJlbmRlcmVyMuazqOWFpei/kOihjOaXtuaKpemUmeOAguS4tOaXtuaUueazle+8jOWPquS4uumAmui/h+e8luivke+8muaUueS4ulJlbmRlcmVyRmFjdG9yeTLms6jlhaVcclxuLy8g5pyN5Yqh55qE6K6+6K6h55uu5qCH77yM5bm25LiN5raJ5Y+K5Yiw5riy5p+T44CCXHJcbi8vIGh0dHBzOi8vaHVuY29kZS5jb20vdXNpbmctcmVuZGVyZXIyLWluc2lkZS1zZXJ2aWNlcy1pbi1hbmd1bGFyL1xyXG4vKipcclxuICog5ouW5ou96YWN572u6aG55Y+C5pWw6K6+572u5o6l5Y+jXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFRpRHJhZ2dhYmxlQ29uZmlnIHtcclxuICAgIC8qKlxyXG4gICAgICog5Y+v5ouW5ou95YWD57Sg77yM5LuF55So5LqO5pyN5Yqh55Sf5oiQ5pa55byP55qE6YWN572uXHJcbiAgICAgKi9cclxuICAgICBoZWxwZXI/OiBFbGVtZW50O1xyXG4gICAgIC8qKlxyXG4gICAgICAqIOaLluaLveeUn+aViOWFg+e0oO+8jOWNs+WPquacieW9k+m8oOagh+aMieS4i+ivpeWFg+e0oOaXtuaJjeWPr+W8gOWni+aLluaLvVxyXG4gICAgICAqL1xyXG4gICAgIGhhbmRsZT86IEVsZW1lbnQ7XHJcbiAgICAgLyoqXHJcbiAgICAgICog5Y+v5ouW5ou95Z2Q5qCH6L2077yM5Y+v5a6a5LmJ5Li6eC9577yM5Y2z5Y+q5Y+v5ZyoeOWSjFnmlrnlkJHmi5bmi71cclxuICAgICAgKi9cclxuICAgICBheGlzPzogJ3gnIHwgJ3knIHwgbnVsbDtcclxuICAgICAvKipcclxuICAgICAgKiDmmK/lkKblj6/mi5bmi73vvIzku4XnlKjkuo7mnI3liqHnlJ/miJDmlrnlvI/nmoTphY3nva5cclxuICAgICAgKi9cclxuICAgICBkaXNhYmxlZD86IGJvb2xlYW47XHJcbiAgICAgLyoqXHJcbiAgICAgICog5ouW5ou95byA5aeL5LqL5Lu2XHJcbiAgICAgICovXHJcbiAgICAgc3RhcnQ/KCk6IHZvaWQ7XHJcbiAgICAgLyoqXHJcbiAgICAgICog5ouW5ou95Lit5LqL5Lu2XHJcbiAgICAgICovXHJcbiAgICAgZHJhZz8oKTogdm9pZDtcclxuICAgICAvKipcclxuICAgICAgKiDmi5bmi73nu5PmnZ/kuovku7ZcclxuICAgICAgKi9cclxuICAgICBzdG9wPygpOiB2b2lkO1xyXG59XHJcbi8qKlxyXG4gKiDmi5bmi73mnI3liqHvvIzpgILnlKjkuo7lj6/mi5bmi73lhYPntKDkuI3lnKhodG1s5qih5p2/5Lit5pi+56S65aOw5piO55qE5oOF5Ya177yM6Zmk5pyN5Yqh5pa55byP5aSW77yM6L+Y5o+Q5L6b5LqG5oyH5Luk55Sf5oiQ5pa55byPW1RpRHJhZ2dhYmxlRGlyZWN0aXZlXXtAbGluayAuLi9kaXJlY3RpdmVzL1RpRHJhZ2dhYmxlRGlyZWN0aXZlLmh0bWx977yMXHJcbiAqIOS9v+eUqOivpeacjeWKoeaXtumcgOimgeW8leWFpeaooeWdl1RpRHJhZ1NlcnZpY2VNb2R1bGVcclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnkzZGVtby8jL2RyYWcvZHJhZy1hbGw8L2V4YW1wbGUtdXJsPlxyXG4gKi9cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogVGlEcmFnU2VydmljZU1vZHVsZVxyXG4gIH0pXHJcbmV4cG9ydCBjbGFzcyBUaURyYWdTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMjtcclxuICAgIGNvbnN0cnVjdG9yKHJlbmRlcmVyRmFjdG9yeTogUmVuZGVyZXJGYWN0b3J5MiwgcHJpdmF0ZSB0aVJlbmRlcmVyOiBUaVJlbmRlcmVyKSB7XHJcbiAgICAgICAgLyogdHNsaW50OmRpc2FibGU6bm8tbnVsbC1rZXl3b3JkICovXHJcbiAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyRmFjdG9yeS5jcmVhdGVSZW5kZXJlcihudWxsLCBudWxsKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu65ouW5ou95a+56LGhXHJcbiAgICAgKlxyXG4gICAgICog5Ye95pWw6L+U5Zue5YC85Li6XHJcbiAgICAgKiB7XHJcbiAgICAgKiBkZXN0cm95OiAoKSA9PiB2b2lkXHJcbiAgICAgKiB9XHJcbiAgICAgKi9cclxuICAgIGNyZWF0ZShvcHRpb25zOiBUaURyYWdnYWJsZUNvbmZpZyk6IHtcclxuICAgICAgICBkZXN0cm95KCk6IHZvaWRcclxuICAgIH0ge1xyXG4gICAgICAgIGNvbnN0IGhlbHBlcjogRWxlbWVudCA9IG9wdGlvbnMuaGVscGVyOyAvLyDlj6/mi5bmi73lhYPntKDvvIzljp/nlJ9IVE1M57G75Z6LXHJcbiAgICAgICAgY29uc3QgaGFuZGxlOiBFbGVtZW50ID0gb3B0aW9ucy5oYW5kbGUgfHwgaGVscGVyOyAvLyDmi5bmi73nlJ/mlYjlhYPntKAs5pyq5a6a5LmJ5oOF5Ya15LiL77yM6buY6K6k5Li6aGVscGVy5YWD57SgXHJcbiAgICAgICAgLy8g5qCH5b+X5L2N77yM55So5LqO6K6w5b2V5piv5ZCm5piv5ouW5ou95byV6LW355qE5LqL5Lu26Kem5Y+RLOWcqG1vdXNlZG93buWSjG1vdXNldXDkuK3liIbliKvov5vooYzkuobnva7kvY1cclxuICAgICAgICBsZXQgbW91c2VTdGFydDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgICAgIC8vIOiusOW9leWIneWni+S9jee9ruS/oeaBr1xyXG4gICAgICAgIGxldCBvcmlnaW5hbFBhZ2VQb3M6IHtcclxuICAgICAgICAgICAgcGFnZVg6IG51bWJlcixcclxuICAgICAgICAgICAgcGFnZVk6IG51bWJlclxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IG9yaWdpbmFsUG9zOiB7XHJcbiAgICAgICAgICAgIGxlZnQ6IG51bWJlclxyXG4gICAgICAgICAgICB0b3A6IG51bWJlclxyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8g6K6+572u57uZaGVscGVy5YWD57Sg55qE5L2N572u5L+h5oGv77yM55So5LqO5L2N572u6K6+572u5Y+K5LqL5Lu25Lit5Y+C5pWw5Lyg6YCSXHJcbiAgICAgICAgbGV0IHBvc2l0aW9uOiB7XHJcbiAgICAgICAgICAgIGxlZnQ6IG51bWJlclxyXG4gICAgICAgICAgICB0b3A6IG51bWJlclxyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8g6Z2e5a6a5L2N5YWD57Sg5oOF5Ya15LiL6K6+572ubGVmdC90b3Dml6DmlYjvvIzlm6DmraTpnIDlhYjlsIblhbborr7nva7kuLpyZWxhdGl2ZeWumuS9jVxyXG4gICAgICAgIC8vIOS/ruWkjVNTUumUmeivr++8mkVSUk9SIFJlZmVyZW5jZUVycm9yOiBnZXRDb21wdXRlZFN0eWxlIGlzIG5vdCBkZWZpbmVkXHJcbiAgICAgICAgY29uc3QgcG9zOiBzdHJpbmcgPSB0eXBlb2YgZ2V0Q29tcHV0ZWRTdHlsZSAhPT0gJ3VuZGVmaW5lZCcgPyBnZXRDb21wdXRlZFN0eWxlKGhlbHBlcikucG9zaXRpb24gOiAnJztcclxuICAgICAgICBpZiAoIS8oZml4ZWR8YWJzb2x1dGV8cmVsYXRpdmUpLy50ZXN0KHBvcykpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShoZWxwZXIsICdwb3NpdGlvbicsICdyZWxhdGl2ZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmi5bmi73ml7bpnIDopoHnlKjliLDnmoRtb3VzZeS6i+S7tuWPpeafhOiusOW9lVxyXG4gICAgICAgIGxldCBtb3VzZU1vdmVFdnQ6IEZ1bmN0aW9uO1xyXG4gICAgICAgIGxldCBtb3VzZVVwRXZ0OiBGdW5jdGlvbjtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLmxpc3RlbihoYW5kbGUsICdtb3VzZWRvd24nLCAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGlzYWJsZWQpIHsvLyDngbDljJbmg4XlhrXkuIvkuI3lgZrlpITnkIZcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyDpmLvmraLmi5bmi73ov4fnqIvkuK3mlofmnKznmoTpgInkuK3lpITnkIbnrYnmk43kvZxcclxuICAgICAgICAgICAgbW91c2VTdGFydCA9IHRydWU7XHJcbiAgICAgICAgICAgIC8vIOWIneWni+aLluaLveaXtum8oOagh+i3neemu+mhtemdoui+uei3neS9jee9ru+8iOWMheWQq+a7muWKqOadoeWcqOWGhe+8iVxyXG4gICAgICAgICAgICBvcmlnaW5hbFBhZ2VQb3MgPSB7XHJcbiAgICAgICAgICAgICAgICBwYWdlWDogZXZlbnQucGFnZVgsXHJcbiAgICAgICAgICAgICAgICBwYWdlWTogZXZlbnQucGFnZVlcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLy8g5ouW5ou95YWD57Sg5Yid5aeL5L2N572uLOeUseS6juiOt+WPluWIsOeahOS9jee9ruS4uid4eHB4Jyzlm6DmraTmraTlpITpnIDopoHovazljJbkuLrmlbDlrZdcclxuICAgICAgICAgICAgb3JpZ2luYWxQb3MgPSBwb3NpdGlvbiA9IHtcclxuICAgICAgICAgICAgICAgIGxlZnQ6IHBhcnNlSW50KGdldENvbXB1dGVkU3R5bGUoaGVscGVyKS5sZWZ0LCAxMCkgfHwgMCxcclxuICAgICAgICAgICAgICAgIHRvcDogcGFyc2VJbnQoZ2V0Q29tcHV0ZWRTdHlsZShoZWxwZXIpLnRvcCwgMTApIHx8IDBcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLy8g6Kem5Y+R5Yid5aeL5ouW5ou95LqL5Lu2XHJcbiAgICAgICAgICAgIHRyaWdnZXJFdnQoJ3N0YXJ0Jyk7XHJcbiAgICAgICAgICAgIG1vdXNlTW92ZUV2dCA9IHRoaXMucmVuZGVyZXIubGlzdGVuKGRvY3VtZW50LCAnbW91c2Vtb3ZlJywgKGV2dDogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgb25Nb3VzZU1vdmUoZXZ0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIG1vdXNlVXBFdnQgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbihkb2N1bWVudCwgJ21vdXNldXAnLCAoZXZ0OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBvbk1vdXNlVXAoZXZ0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3Qgb25Nb3VzZU1vdmU6IChldnQ6IE1vdXNlRXZlbnQpID0+IHZvaWQgPSAoZXZ0OiBNb3VzZUV2ZW50KTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIC8vIOmYsuatoumdnuaLluaLveinpuWPkeeahG1vdXNlbW92ZeS6i+S7tlxyXG4gICAgICAgICAgICBpZiAoIW1vdXNlU3RhcnQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsgLy8g6Zi75q2i5ouW5ou96L+H56iL5Lit55qE6YCJ5Lit5aSE55CG562J5pON5L2cXHJcbiAgICAgICAgICAgIGNvbnN0IHRvcFBvczogbnVtYmVyID0gKG9wdGlvbnMuYXhpcyA9PT0gJ3gnKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gb3JpZ2luYWxQb3MudG9wXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAoZXZ0LnBhZ2VZIC0gb3JpZ2luYWxQYWdlUG9zLnBhZ2VZICsgb3JpZ2luYWxQb3MudG9wIC0gZG9jdW1lbnQuYm9keS5zY3JvbGxUb3ApO1xyXG4gICAgICAgICAgICBjb25zdCBsZWZ0UG9zOiBudW1iZXIgPSAob3B0aW9ucy5heGlzID09PSAneScpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gb3JpZ2luYWxQb3MubGVmdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IChldnQucGFnZVggLSBvcmlnaW5hbFBhZ2VQb3MucGFnZVggKyBvcmlnaW5hbFBvcy5sZWZ0IC0gZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0KTtcclxuICAgICAgICAgICAgcG9zaXRpb24gPSB7XHJcbiAgICAgICAgICAgICAgICBsZWZ0OiBsZWZ0UG9zLFxyXG4gICAgICAgICAgICAgICAgdG9wOiB0b3BQb3NcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLy8g6Kem5Y+R5ouW5ou95pe26Ze077yM6K+l5LqL5Lu25Lit5aSE55CG5ouW5ou96L+H56iL5Lit55qE5L2N572u57qg5q2jXHJcbiAgICAgICAgICAgIHRyaWdnZXJFdnQoJ2RyYWcnKTtcclxuICAgICAgICAgICAgdGhpcy50aVJlbmRlcmVyLnNldFN0eWxlcyhoZWxwZXIsIHtcclxuICAgICAgICAgICAgICAgIGxlZnQ6IGAke3Bvc2l0aW9uLmxlZnR9cHhgLFxyXG4gICAgICAgICAgICAgICAgdG9wOiBgJHtwb3NpdGlvbi50b3B9cHhgXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3Qgb25Nb3VzZVVwOiAoZXZ0OiBNb3VzZUV2ZW50KSA9PiB2b2lkID0gKGV2dDogTW91c2VFdmVudCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBtb3VzZVN0YXJ0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICB0cmlnZ2VyRXZ0KCdzdG9wJyk7XHJcbiAgICAgICAgICAgIC8vIOaLluaLveWBnOatouWQju+8jOino+e7kWRvY3VtZW505LiK55qE55u45YWz5LqL5Lu2XHJcbiAgICAgICAgICAgIG1vdXNlTW92ZUV2dCgpO1xyXG4gICAgICAgICAgICBtb3VzZVVwRXZ0KCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCB0cmlnZ2VyRXZ0OiAoZXZ0VHlwZTogc3RyaW5nKSA9PiB2b2lkID0gKGV2dFR5cGU6IHN0cmluZyk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBpZiAob3B0aW9uc1tldnRUeXBlXSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmV0OiBvYmplY3QgPSBvcHRpb25zW2V2dFR5cGVdKHtwb3NpdGlvbiwgaGVscGVyfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldCA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHsuLi5yZXQsIC4uLnBvc2l0aW9ufTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGRlc3Ryb3k6ICgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghVXRpbC5pc1VuZGVmaW5lZChtb3VzZU1vdmVFdnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbW91c2VNb3ZlRXZ0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIVV0aWwuaXNVbmRlZmluZWQobW91c2VVcEV2dCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBtb3VzZVVwRXZ0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcbiJdfQ==