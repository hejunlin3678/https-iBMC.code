import { Injectable } from '@angular/core';
import { Util } from '../../utils/Util';
import { TiFileItemUtil } from './TiFileItemUtil';
import { TiUploadUtil } from './TiUploadUtil';
import { TiUploadServiceModule } from './TiUploadServiceModule';
import * as i0 from "@angular/core";
import * as i1 from "./TiUploadServiceModule";
// 文件上传服务封装，一个实例对应一个上传文件队列
// @dynamic
/**
 * 文件上传服务，通过该服务生成上传文件实例对象，一个实例对应一个上传文件队列
 *
 * 该服务适用于自定义文件上传实例方式，使用该服务时需要引入模块TiUploadServiceModule，与[tiFileSelect]{@link ../directives/TiFileSelectDirective.html}配合使用
 *
 * 除自定义使用方式外，Tiny还提供了两种已设计的上传样式供业务使用，具体见[TiUploadComponent]{@link ../components/TiUploadComponent.html}
 *
 * <example-url>../tiny3demo/#/upload/upload-all</example-url>
 */
export class TiUploadService {
    /**
     * 对单选进行过滤条件重置，单选去除maxCount条件，函数返回过滤后的生效规则
     */
    static initFilter(rules, isSingleFile) {
        if (isSingleFile) { // 单文件情况下去除maxCount设置
            return rules.filter((rule) => {
                return rule.name !== 'maxCount';
            });
        }
        // 多文件情况下 filter不做处理
        return rules || [];
    }
    /**
     * 根据用户配置的maxCount过滤条件，判断文件是否为单文件上传
     * 用户配置的过滤条件
     * 是否为单文件上传
     */
    static isSingleFileFn(filters) {
        if (!filters || !filters.length) { // 不设置filter情况下，为多文件上传
            return false;
        }
        const maxCountIndex = filters.findIndex((item) => {
            return item.name === 'maxCount';
        });
        // 存在maxCount规则，并且其参数不为1的情况下，为多文件上传
        if (maxCountIndex === -1 || (filters[maxCountIndex].params && filters[maxCountIndex].params[0] !== 1)) {
            return false;
        }
        return true;
    }
    /**
     * 批量上传文件
     *   {Array} 上传文件items数组
     * 返回 无
     */
    static uploadItems(items) {
        if (!items.length) {
            return;
        }
        // 设置上传文件标志位,文件逐个上传情况下,会根据该标志位决定下个上传文件
        items.forEach((item) => {
            item.isReady = true;
        });
        // 开始上传文件
        if (items[0].batchSend) {
            TiUploadUtil.uploadItems(items);
        }
        else { // 上传单个文件，在upload方法中会依据isReady的设置进行其他文件的串行上传
            TiUploadUtil.uploadItems([items[0]]);
        }
    }
    /**
     * 批量取消上传文件
     * 返回 无
     */
    static cancelItems(items) {
        if (!items.length) {
            return;
        }
        if (items[0].batchSend) { // 一个链接上传情况下，一次取消多个items，仅触发一次事件
            TiUploadUtil.cancelItems(items);
        }
        else { // 逐个链接上传情况下，一次仅取消一个items，触发多次事件
            items.forEach((item) => {
                item.cancel();
            });
        }
    }
    /**
     * 批量删除文件,只涉及上传队列的文件删除，具体的后台删除还需要产品向后台发送文件删除请求实现
     *   {Array} 上传文件items数组
     * 返回 无
     */
    static removeItems(items) {
        if (!items.length) {
            return;
        }
        if (items[0].batchSend) { // 一个链接上传情况下，一次删除多个items，仅触发一次事件
            TiUploadUtil.removeItems(items);
        }
        else { // 逐个链接上传情况下，一次仅删除一个items，触发多次事件
            items.forEach((item) => {
                item.remove();
            });
        }
    }
    /**
     * 单个文件的有效性校验
     * 返回 {Array} 由不符合的规则name组成的数组
     */
    static getInvalidRules(tifileObject, filtersRules, fileQueue) {
        // 无效判断
        const filterLen = filtersRules.length;
        if (filterLen === 0) {
            return [];
        }
        // 逐条规则校验，并返回结果数组
        const invalidRetArr = []; // 校验返回结果数组，该数组中返回的是不符合的校验规则name
        for (let i = 0; i < filterLen; i++) {
            const filterConfig = filtersRules[i]; // 单条校验规则配置
            // 根据配置寻找规则函数（规则分为默认规则 和 自定义规则）
            const filterName = filterConfig.name; // 配置规则名称
            let ruleFn; // 规则函数
            if (typeof filterConfig.fn === 'function') {
                ruleFn = filterConfig.fn;
            }
            else if (TiUploadService.filterRules[filterName]) { // 未定义fn的情况下，从默认规则中找
                ruleFn = TiUploadService.filterRules[filterName];
            }
            // 调用规则函数，判断文件有效性
            if ((typeof ruleFn === 'function') &&
                !ruleFn(tifileObject, filterConfig.params, fileQueue)) {
                invalidRetArr.push(filterName);
            }
        }
        return invalidRetArr;
    }
    /**
     * 获取未上传文件队列
     */
    static getNotUploadedItems(fileQueue) {
        return fileQueue.filter((item) => {
            return !item.isUploaded;
        });
    }
    /**
     * 获取待上传文件，该方法用于文件批量上传时获取上传文件队列
     * 返回 {Array} 返回待上传文件，且文件队列返回值是根据文件点选次序排列
     */
    static getReadyItems(fileQueue) {
        return fileQueue.filter((item) => {
            return item.isReady && !item.isUploading;
        })
            .sort((item1, item2) => {
            return item1.index - item2.index;
        });
    }
    /**
     * 获取上传失败文件，该方法用于文件批量上传时获取上传失败文件队列
     * 返回 {Array} 返回上传失败文件，且文件队列返回值是根据文件点选次序排列
     */
    static getErrorItems(fileQueue) {
        return fileQueue.filter((item) => {
            return item.isError;
        })
            .sort((item1, item2) => {
            return item1.index - item2.index;
        });
    }
    /**
     * 重新上传列表中所有先前上传错误文件
     * 返回 无
     */
    static reloadAllError(fileQueue) {
        TiUploadService.uploadItems(TiUploadService.getErrorItems(fileQueue));
    }
    /**
     * 重新上传列表中所有文件
     * 返回 无
     */
    static reloadAll(fileQueue) {
        TiUploadService.uploadItems(fileQueue);
    }
    /**
     * 上传列表中所有未上传过的文件
     * 返回 无
     */
    static uploadAll(fileQueue) {
        const items = this.getNotUploadedItems(fileQueue)
            .filter((item) => {
            return !item.isUploading;
        });
        TiUploadService.uploadItems(items);
    }
    /**
     * 判断是否有未上传的
     * 返回 boolean
     */
    static isUploadedAll(fileQueue) {
        const items = this.getNotUploadedItems(fileQueue)
            .filter((item) => {
            return !item.isUploading;
        });
        return items.length === 0;
    }
    /**
     * 删除所有队列中的文件
     */
    static removeAll(fileQueue) {
        while (fileQueue.length !== 0) {
            fileQueue[0].remove();
        }
    }
    /**
     * 取消所有队列中的文件(未上传和待上传文件)
     */
    static cancelAll(fileQueue) {
        const items = this.getNotUploadedItems(fileQueue);
        TiUploadService.cancelItems(items);
    }
    /**
     * 创建文件上传实例
     */
    create(config) {
        const isSingleFile = TiUploadService.isSingleFileFn(config.filters); // 文件是否为单文件设置
        const filters = TiUploadService.initFilter(config.filters, isSingleFile); // 文件校验过滤规则
        let uploader;
        const fileQueue = []; // 文件队列列表，一个实例对应一个文件列表
        let fileIndex = 0; // 文件次序定义，用作文件索引
        /**
         * 将选择的文件进行有效验证后加入到队列中,外部调用该方法时,认为该队列中的文件和当前uploader的配置项一致
         *   files {FileList|FileInput} 文件对象
         * 返回 {Array} 已添加文件数组
         */
        const addToQueue = (files) => {
            // 循环列表添加文件
            const addedItems = []; // 用于记录本次选择文件列表
            if (files && !Util.isUndefined(files.length)) { // H5方式
                for (let i = 0; i < files.length; i++) {
                    addItem(files[i], addedItems);
                }
            }
            else {
                addItem(files, addedItems);
            }
            return addedItems;
        };
        const addItem = (fileOrInput, addedItems) => {
            // 文件对象，该对象包含文件的基本信息，统一了浏览器的差异性，会在文件过滤失败回调中作为参数传递给外部
            const tifileObject = TiFileItemUtil.createFileObject(fileOrInput);
            // 校验单个文件的有效性，并根据校验结果进行文件操作
            const invalidArr = TiUploadService.getInvalidRules(tifileObject, filters, fileQueue); // 校验结果数组，数组中定义校验错误规则的name
            let isValid = !invalidArr.length; // 校验结果返回数组为空时有效
            // 单文件情况下，需要覆盖原有有效文件
            if (isSingleFile) {
                if (fileQueue[0]) {
                    fileQueue[0].remove(); // 删除先前队列中的文件
                }
                if (invalidArr.length === 0) {
                    isValid = true; // 置位校验结果值
                }
            }
            if (isValid) { // 校验成功情况下，将文件加入到上传队列中，并触发
                // 上传文件对象,该对象中包含文件及状态信息等,在回调中传递
                const fileItem = TiFileItemUtil.createFileItem(tifileObject, fileOrInput, config, uploader);
                addedItems.push(fileItem);
                fileQueue.push(fileItem);
                fileItem.index = ++fileIndex; // 文件序列数增加，确保整个文件队列中该值唯一
                if (typeof config.onAddItemSuccess === 'function') {
                    config.onAddItemSuccess(fileItem);
                }
            }
            else if (typeof config.onAddItemFailed === 'function') {
                config.onAddItemFailed(tifileObject, invalidArr);
            }
        };
        uploader = {
            queue: fileQueue,
            isSingleFile,
            config,
            _addToQueue: addToQueue,
            getNotUploadedItems() {
                return TiUploadService.getNotUploadedItems(fileQueue);
            },
            getReadyItems() {
                return TiUploadService.getReadyItems(fileQueue);
            },
            uploadAll() {
                TiUploadService.uploadAll(fileQueue);
            },
            isUploadedAll() {
                return TiUploadService.isUploadedAll(fileQueue);
            },
            removeAll() {
                TiUploadService.removeAll(fileQueue);
            },
            cancelAll() {
                TiUploadService.cancelAll(fileQueue);
            },
            reloadAll() {
                TiUploadService.reloadAll(fileQueue);
            },
            reloadAllError() {
                TiUploadService.reloadAllError(fileQueue);
            },
            uploadItems: TiUploadService.uploadItems,
            removeItems: TiUploadService.removeItems,
            cancelItems: TiUploadService.cancelItems // 取消队列中某几项文件
        };
        return uploader;
    }
}
// 文件校验规则定义
TiUploadService.filterRules = {
    maxSize: (fileObj, params) => {
        const size = fileObj.size;
        if (!Util.isNumber(size)) { // 文件大小获取不到情况下，忽略该条校验规则
            return true;
        }
        return !(size > params[0]);
    },
    minSize: (fileObj, params) => {
        const size = fileObj.size;
        if (!Util.isNumber(size)) { // 文件大小获取不到情况下，忽略该条校验规则
            return true;
        }
        return !(size < params[0]);
    },
    type: (fileObj, params) => {
        // param参数需使用文件扩展名分开，为了确保各浏览器的一致性，文件类型使用扩展名判断，如果产品需要在选择时限制，请在input上设置accept属性
        let isValidType = false;
        params[0].split(',')
            .forEach((type) => {
            if (fileObj.name.match(new RegExp(`.(${type.replace(/\./g, '\\.')})$`, 'i')) !== null) {
                isValidType = true;
            }
        });
        return isValidType;
    },
    maxCount: (fileObj, params, fileQueue) => {
        return !(fileQueue.length >= params[0]);
    }
};
TiUploadService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TiUploadService_Factory() { return new TiUploadService(); }, token: TiUploadService, providedIn: i1.TiUploadServiceModule });
TiUploadService.decorators = [
    { type: Injectable, args: [{
                providedIn: TiUploadServiceModule
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlVcGxvYWRTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL3NlcnZpY2VzL3VwbG9hZC9UaVVwbG9hZFNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQzs7O0FBR2hFLDBCQUEwQjtBQUMxQixXQUFXO0FBQ1g7Ozs7Ozs7O0dBUUc7QUFJSCxNQUFNLE9BQU8sZUFBZTtJQW9DeEI7O09BRUc7SUFDSyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQXNCLEVBQUUsWUFBcUI7UUFDbkUsSUFBSSxZQUFZLEVBQUUsRUFBRSxxQkFBcUI7WUFDckMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBYyxFQUFFLEVBQUU7Z0JBQ25DLE9BQU8sSUFBSSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUM7WUFDcEMsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUVELG9CQUFvQjtRQUNwQixPQUFPLEtBQUssSUFBSSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQXdCO1FBQ2xELElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsc0JBQXNCO1lBQ3JELE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsTUFBTSxhQUFhLEdBQVcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQWMsRUFBVyxFQUFFO1lBQ3hFLE9B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QyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUU7Z0JBQ25GLFdBQVcsR0FBRyxJQUFJLENBQUM7YUFDdEI7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sV0FBVyxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxRQUFRLEVBQUUsQ0FBQyxPQUFtQixFQUFFLE1BQWtCLEVBQUUsU0FBNEIsRUFBWSxFQUFFO1FBQzFGLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUMsQ0FBQztDQUNKLENBQUM7OztZQXJDTCxVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLHFCQUFxQjthQUNwQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uLy4uL3V0aWxzL1V0aWwnO1xyXG5pbXBvcnQgeyBUaUZpbGVJdGVtVXRpbCB9IGZyb20gJy4vVGlGaWxlSXRlbVV0aWwnO1xyXG5pbXBvcnQgeyBUaVVwbG9hZFV0aWwgfSBmcm9tICcuL1RpVXBsb2FkVXRpbCc7XHJcbmltcG9ydCB7IFRpVXBsb2FkU2VydmljZU1vZHVsZSB9IGZyb20gJy4vVGlVcGxvYWRTZXJ2aWNlTW9kdWxlJztcclxuaW1wb3J0IHsgVGlGaWxlSW5mbywgVGlGaWxlSXRlbSwgVGlGaWx0ZXIsIFRpVXBsb2FkQ29uZmlnLCBUaVVwbG9hZFJlZiB9IGZyb20gJy4vVGlGaWxlSW50ZXJmYWNlJztcclxuXHJcbi8vIOaWh+S7tuS4iuS8oOacjeWKoeWwgeijhe+8jOS4gOS4quWunuS+i+WvueW6lOS4gOS4quS4iuS8oOaWh+S7tumYn+WIl1xyXG4vLyBAZHluYW1pY1xyXG4vKipcclxuICog5paH5Lu25LiK5Lyg5pyN5Yqh77yM6YCa6L+H6K+l5pyN5Yqh55Sf5oiQ5LiK5Lyg5paH5Lu25a6e5L6L5a+56LGh77yM5LiA5Liq5a6e5L6L5a+55bqU5LiA5Liq5LiK5Lyg5paH5Lu26Zif5YiXXHJcbiAqXHJcbiAqIOivpeacjeWKoemAgueUqOS6juiHquWumuS5ieaWh+S7tuS4iuS8oOWunuS+i+aWueW8j++8jOS9v+eUqOivpeacjeWKoeaXtumcgOimgeW8leWFpeaooeWdl1RpVXBsb2FkU2VydmljZU1vZHVsZe+8jOS4jlt0aUZpbGVTZWxlY3Rde0BsaW5rIC4uL2RpcmVjdGl2ZXMvVGlGaWxlU2VsZWN0RGlyZWN0aXZlLmh0bWx96YWN5ZCI5L2/55SoXHJcbiAqXHJcbiAqIOmZpOiHquWumuS5ieS9v+eUqOaWueW8j+Wklu+8jFRpbnnov5jmj5DkvpvkuobkuKTnp43lt7Lorr7orqHnmoTkuIrkvKDmoLflvI/kvpvkuJrliqHkvb/nlKjvvIzlhbfkvZPop4FbVGlVcGxvYWRDb21wb25lbnRde0BsaW5rIC4uL2NvbXBvbmVudHMvVGlVcGxvYWRDb21wb25lbnQuaHRtbH1cclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnkzZGVtby8jL3VwbG9hZC91cGxvYWQtYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46IFRpVXBsb2FkU2VydmljZU1vZHVsZVxyXG59KVxyXG5leHBvcnQgY2xhc3MgVGlVcGxvYWRTZXJ2aWNlIHtcclxuICAgIC8vIOaWh+S7tuagoemqjOinhOWImeWumuS5iVxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgZmlsdGVyUnVsZXM6IGFueSA9IHtcclxuICAgICAgICBtYXhTaXplOiAoZmlsZU9iajogVGlGaWxlSW5mbywgcGFyYW1zOiBBcnJheTxhbnk+KTogYm9vbGVhbiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNpemU6IG51bWJlciA9IGZpbGVPYmouc2l6ZTtcclxuICAgICAgICAgICAgaWYgKCFVdGlsLmlzTnVtYmVyKHNpemUpKSB7IC8vIOaWh+S7tuWkp+Wwj+iOt+WPluS4jeWIsOaDheWGteS4i++8jOW/veeVpeivpeadoeagoemqjOinhOWImVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiAhKHNpemUgPiBwYXJhbXNbMF0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbWluU2l6ZTogKGZpbGVPYmo6IFRpRmlsZUluZm8sIHBhcmFtczogQXJyYXk8YW55Pik6IGJvb2xlYW4gPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzaXplOiBudW1iZXIgPSBmaWxlT2JqLnNpemU7XHJcbiAgICAgICAgICAgIGlmICghVXRpbC5pc051bWJlcihzaXplKSkgeyAvLyDmlofku7blpKflsI/ojrflj5bkuI3liLDmg4XlhrXkuIvvvIzlv73nlaXor6XmnaHmoKHpqozop4TliJlcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gIShzaXplIDwgcGFyYW1zWzBdKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHR5cGU6IChmaWxlT2JqOiBUaUZpbGVJbmZvLCBwYXJhbXM6IEFycmF5PGFueT4pOiBib29sZWFuID0+IHtcclxuICAgICAgICAgICAgLy8gcGFyYW3lj4LmlbDpnIDkvb/nlKjmlofku7bmianlsZXlkI3liIblvIDvvIzkuLrkuobnoa7kv53lkITmtY/op4jlmajnmoTkuIDoh7TmgKfvvIzmlofku7bnsbvlnovkvb/nlKjmianlsZXlkI3liKTmlq3vvIzlpoLmnpzkuqflk4HpnIDopoHlnKjpgInmi6nml7bpmZDliLbvvIzor7flnKhpbnB1dOS4iuiuvue9rmFjY2VwdOWxnuaAp1xyXG4gICAgICAgICAgICBsZXQgaXNWYWxpZFR5cGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgcGFyYW1zWzBdLnNwbGl0KCcsJylcclxuICAgICAgICAgICAgICAgIC5mb3JFYWNoKCh0eXBlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChmaWxlT2JqLm5hbWUubWF0Y2gobmV3IFJlZ0V4cChgLigke3R5cGUucmVwbGFjZSgvXFwuL2csICdcXFxcLicpfSkkYCwgJ2knKSkgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc1ZhbGlkVHlwZSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWRUeXBlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbWF4Q291bnQ6IChmaWxlT2JqOiBUaUZpbGVJbmZvLCBwYXJhbXM6IEFycmF5PGFueT4sIGZpbGVRdWV1ZTogQXJyYXk8VGlGaWxlSXRlbT4pOiBib29sZWFuICA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiAhKGZpbGVRdWV1ZS5sZW5ndGggPj0gcGFyYW1zWzBdKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5a+55Y2V6YCJ6L+b6KGM6L+H5ruk5p2h5Lu26YeN572u77yM5Y2V6YCJ5Y676ZmkbWF4Q291bnTmnaHku7bvvIzlh73mlbDov5Tlm57ov4fmu6TlkI7nmoTnlJ/mlYjop4TliJlcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5pdEZpbHRlcihydWxlczogQXJyYXk8VGlGaWx0ZXI+LCBpc1NpbmdsZUZpbGU6IGJvb2xlYW4pOiBBcnJheTxUaUZpbHRlcj4ge1xyXG4gICAgICAgIGlmIChpc1NpbmdsZUZpbGUpIHsgLy8g5Y2V5paH5Lu25oOF5Ya15LiL5Y676ZmkbWF4Q291bnTorr7nva5cclxuICAgICAgICAgICAgcmV0dXJuIHJ1bGVzLmZpbHRlcigocnVsZTogVGlGaWx0ZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBydWxlLm5hbWUgIT09ICdtYXhDb3VudCc7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5aSa5paH5Lu25oOF5Ya15LiLIGZpbHRlcuS4jeWBmuWkhOeQhlxyXG4gICAgICAgIHJldHVybiBydWxlcyB8fCBbXTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5qC55o2u55So5oi36YWN572u55qEbWF4Q291bnTov4fmu6TmnaHku7bvvIzliKTmlq3mlofku7bmmK/lkKbkuLrljZXmlofku7bkuIrkvKBcclxuICAgICAqIOeUqOaIt+mFjee9rueahOi/h+a7pOadoeS7tlxyXG4gICAgICog5piv5ZCm5Li65Y2V5paH5Lu25LiK5LygXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIGlzU2luZ2xlRmlsZUZuKGZpbHRlcnM6IEFycmF5PFRpRmlsdGVyPik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghZmlsdGVycyB8fCAhZmlsdGVycy5sZW5ndGgpIHsgLy8g5LiN6K6+572uZmlsdGVy5oOF5Ya15LiL77yM5Li65aSa5paH5Lu25LiK5LygXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbWF4Q291bnRJbmRleDogbnVtYmVyID0gZmlsdGVycy5maW5kSW5kZXgoKGl0ZW06IFRpRmlsdGVyKTogYm9vbGVhbiA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBpdGVtLm5hbWUgPT09ICdtYXhDb3VudCc7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8g5a2Y5ZyobWF4Q291bnTop4TliJnvvIzlubbkuJTlhbblj4LmlbDkuI3kuLox55qE5oOF5Ya15LiL77yM5Li65aSa5paH5Lu25LiK5LygXHJcbiAgICAgICAgaWYgKG1heENvdW50SW5kZXggPT09IC0xIHx8IChmaWx0ZXJzW21heENvdW50SW5kZXhdLnBhcmFtcyAmJiBmaWx0ZXJzW21heENvdW50SW5kZXhdLnBhcmFtc1swXSAhPT0gMSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmibnph4/kuIrkvKDmlofku7ZcclxuICAgICAqICAge0FycmF5fSDkuIrkvKDmlofku7ZpdGVtc+aVsOe7hFxyXG4gICAgICog6L+U5ZueIOaXoFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyB1cGxvYWRJdGVtcyhpdGVtczogQXJyYXk8VGlGaWxlSXRlbT4pOiB2b2lkIHtcclxuICAgICAgICBpZiAoIWl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOiuvue9ruS4iuS8oOaWh+S7tuagh+W/l+S9jSzmlofku7bpgJDkuKrkuIrkvKDmg4XlhrXkuIss5Lya5qC55o2u6K+l5qCH5b+X5L2N5Yaz5a6a5LiL5Liq5LiK5Lyg5paH5Lu2XHJcbiAgICAgICAgaXRlbXMuZm9yRWFjaCgoaXRlbTogVGlGaWxlSXRlbSkgPT4ge1xyXG4gICAgICAgICAgICBpdGVtLmlzUmVhZHkgPSB0cnVlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDlvIDlp4vkuIrkvKDmlofku7ZcclxuICAgICAgICBpZiAoaXRlbXNbMF0uYmF0Y2hTZW5kKSB7XHJcbiAgICAgICAgICAgIFRpVXBsb2FkVXRpbC51cGxvYWRJdGVtcyhpdGVtcyk7XHJcbiAgICAgICAgfSBlbHNlIHsgLy8g5LiK5Lyg5Y2V5Liq5paH5Lu277yM5ZyodXBsb2Fk5pa55rOV5Lit5Lya5L6d5o2uaXNSZWFkeeeahOiuvue9rui/m+ihjOWFtuS7luaWh+S7tueahOS4suihjOS4iuS8oFxyXG4gICAgICAgICAgICBUaVVwbG9hZFV0aWwudXBsb2FkSXRlbXMoW2l0ZW1zWzBdXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5om56YeP5Y+W5raI5LiK5Lyg5paH5Lu2XHJcbiAgICAgKiDov5Tlm54g5pegXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIGNhbmNlbEl0ZW1zKGl0ZW1zOiBBcnJheTxUaUZpbGVJdGVtPik6IHZvaWQge1xyXG4gICAgICAgIGlmICghaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGl0ZW1zWzBdLmJhdGNoU2VuZCkgeyAvLyDkuIDkuKrpk77mjqXkuIrkvKDmg4XlhrXkuIvvvIzkuIDmrKHlj5bmtojlpJrkuKppdGVtc++8jOS7heinpuWPkeS4gOasoeS6i+S7tlxyXG4gICAgICAgICAgICBUaVVwbG9hZFV0aWwuY2FuY2VsSXRlbXMoaXRlbXMpO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIOmAkOS4qumTvuaOpeS4iuS8oOaDheWGteS4i++8jOS4gOasoeS7heWPlua2iOS4gOS4qml0ZW1z77yM6Kem5Y+R5aSa5qyh5LqL5Lu2XHJcbiAgICAgICAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW06IFRpRmlsZUl0ZW0pID0+IHtcclxuICAgICAgICAgICAgICAgIGl0ZW0uY2FuY2VsKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOaJuemHj+WIoOmZpOaWh+S7tizlj6rmtonlj4rkuIrkvKDpmJ/liJfnmoTmlofku7bliKDpmaTvvIzlhbfkvZPnmoTlkI7lj7DliKDpmaTov5jpnIDopoHkuqflk4HlkJHlkI7lj7Dlj5HpgIHmlofku7bliKDpmaTor7fmsYLlrp7njrBcclxuICAgICAqICAge0FycmF5fSDkuIrkvKDmlofku7ZpdGVtc+aVsOe7hFxyXG4gICAgICog6L+U5ZueIOaXoFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyByZW1vdmVJdGVtcyhpdGVtczogQXJyYXk8VGlGaWxlSXRlbT4pOiB2b2lkIHtcclxuICAgICAgICBpZiAoIWl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpdGVtc1swXS5iYXRjaFNlbmQpIHsgLy8g5LiA5Liq6ZO+5o6l5LiK5Lyg5oOF5Ya15LiL77yM5LiA5qyh5Yig6Zmk5aSa5LiqaXRlbXPvvIzku4Xop6blj5HkuIDmrKHkuovku7ZcclxuICAgICAgICAgICAgVGlVcGxvYWRVdGlsLnJlbW92ZUl0ZW1zKGl0ZW1zKTtcclxuICAgICAgICB9IGVsc2UgeyAvLyDpgJDkuKrpk77mjqXkuIrkvKDmg4XlhrXkuIvvvIzkuIDmrKHku4XliKDpmaTkuIDkuKppdGVtc++8jOinpuWPkeWkmuasoeS6i+S7tlxyXG4gICAgICAgICAgICBpdGVtcy5mb3JFYWNoKChpdGVtOiBUaUZpbGVJdGVtKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpdGVtLnJlbW92ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDljZXkuKrmlofku7bnmoTmnInmlYjmgKfmoKHpqoxcclxuICAgICAqIOi/lOWbniB7QXJyYXl9IOeUseS4jeespuWQiOeahOinhOWImW5hbWXnu4TmiJDnmoTmlbDnu4RcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0SW52YWxpZFJ1bGVzKHRpZmlsZU9iamVjdDogVGlGaWxlSW5mbywgZmlsdGVyc1J1bGVzOiBBcnJheTxUaUZpbHRlcj4sIGZpbGVRdWV1ZTogQXJyYXk8VGlGaWxlSXRlbT4pOiBBcnJheTxzdHJpbmc+IHtcclxuICAgICAgICAvLyDml6DmlYjliKTmlq1cclxuICAgICAgICBjb25zdCBmaWx0ZXJMZW46IG51bWJlciA9IGZpbHRlcnNSdWxlcy5sZW5ndGg7XHJcbiAgICAgICAgaWYgKGZpbHRlckxlbiA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDpgJDmnaHop4TliJnmoKHpqozvvIzlubbov5Tlm57nu5PmnpzmlbDnu4RcclxuICAgICAgICBjb25zdCBpbnZhbGlkUmV0QXJyOiBBcnJheTxzdHJpbmc+ID0gW107IC8vIOagoemqjOi/lOWbnue7k+aenOaVsOe7hO+8jOivpeaVsOe7hOS4rei/lOWbnueahOaYr+S4jeespuWQiOeahOagoemqjOinhOWImW5hbWVcclxuICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgZmlsdGVyTGVuOyBpKyspIHtcclxuICAgICAgICAgICAgY29uc3QgZmlsdGVyQ29uZmlnOiBUaUZpbHRlciA9IGZpbHRlcnNSdWxlc1tpXTsgLy8g5Y2V5p2h5qCh6aqM6KeE5YiZ6YWN572uXHJcblxyXG4gICAgICAgICAgICAvLyDmoLnmja7phY3nva7lr7vmib7op4TliJnlh73mlbDvvIjop4TliJnliIbkuLrpu5jorqTop4TliJkg5ZKMIOiHquWumuS5ieinhOWIme+8iVxyXG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJOYW1lOiBzdHJpbmcgPSBmaWx0ZXJDb25maWcubmFtZTsgLy8g6YWN572u6KeE5YiZ5ZCN56ewXHJcbiAgICAgICAgICAgIGxldCBydWxlRm46IChmaWxlT2JqOiBUaUZpbGVJbmZvLCBwYXJhbXM6IEFycmF5PGFueT4sIGZpbGVRdWV1ZTogQXJyYXk8VGlGaWxlSXRlbT4pID0+IGJvb2xlYW47IC8vIOinhOWImeWHveaVsFxyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGZpbHRlckNvbmZpZy5mbiA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgcnVsZUZuID0gZmlsdGVyQ29uZmlnLmZuO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKFRpVXBsb2FkU2VydmljZS5maWx0ZXJSdWxlc1tmaWx0ZXJOYW1lXSkgeyAvLyDmnKrlrprkuYlmbueahOaDheWGteS4i++8jOS7jum7mOiupOinhOWImeS4reaJvlxyXG4gICAgICAgICAgICAgICAgcnVsZUZuID0gVGlVcGxvYWRTZXJ2aWNlLmZpbHRlclJ1bGVzW2ZpbHRlck5hbWVdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyDosIPnlKjop4TliJnlh73mlbDvvIzliKTmlq3mlofku7bmnInmlYjmgKdcclxuICAgICAgICAgICAgaWYgKCh0eXBlb2YgcnVsZUZuID09PSAnZnVuY3Rpb24nKSAmJlxyXG4gICAgICAgICAgICAgICAgIXJ1bGVGbih0aWZpbGVPYmplY3QsIGZpbHRlckNvbmZpZy5wYXJhbXMsIGZpbGVRdWV1ZSkpIHtcclxuICAgICAgICAgICAgICAgIGludmFsaWRSZXRBcnIucHVzaChmaWx0ZXJOYW1lKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGludmFsaWRSZXRBcnI7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluacquS4iuS8oOaWh+S7tumYn+WIl1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyBnZXROb3RVcGxvYWRlZEl0ZW1zKGZpbGVRdWV1ZTogQXJyYXk8VGlGaWxlSXRlbT4pOiBBcnJheTxUaUZpbGVJdGVtPiB7XHJcbiAgICAgICAgcmV0dXJuIGZpbGVRdWV1ZS5maWx0ZXIoKGl0ZW06IFRpRmlsZUl0ZW0pOiBib29sZWFuID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuICFpdGVtLmlzVXBsb2FkZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluW+heS4iuS8oOaWh+S7tu+8jOivpeaWueazleeUqOS6juaWh+S7tuaJuemHj+S4iuS8oOaXtuiOt+WPluS4iuS8oOaWh+S7tumYn+WIl1xyXG4gICAgICog6L+U5ZueIHtBcnJheX0g6L+U5Zue5b6F5LiK5Lyg5paH5Lu277yM5LiU5paH5Lu26Zif5YiX6L+U5Zue5YC85piv5qC55o2u5paH5Lu254K56YCJ5qyh5bqP5o6S5YiXXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIGdldFJlYWR5SXRlbXMoZmlsZVF1ZXVlOiBBcnJheTxUaUZpbGVJdGVtPik6IEFycmF5PFRpRmlsZUl0ZW0+IHtcclxuICAgICAgICByZXR1cm4gZmlsZVF1ZXVlLmZpbHRlcigoaXRlbTogVGlGaWxlSXRlbSk6IGJvb2xlYW4gPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gaXRlbS5pc1JlYWR5ICYmICFpdGVtLmlzVXBsb2FkaW5nO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnNvcnQoKGl0ZW0xOiBUaUZpbGVJdGVtLCBpdGVtMjogVGlGaWxlSXRlbSk6IG51bWJlciAgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gaXRlbTEuaW5kZXggLSBpdGVtMi5pbmRleDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluS4iuS8oOWksei0peaWh+S7tu+8jOivpeaWueazleeUqOS6juaWh+S7tuaJuemHj+S4iuS8oOaXtuiOt+WPluS4iuS8oOWksei0peaWh+S7tumYn+WIl1xyXG4gICAgICog6L+U5ZueIHtBcnJheX0g6L+U5Zue5LiK5Lyg5aSx6LSl5paH5Lu277yM5LiU5paH5Lu26Zif5YiX6L+U5Zue5YC85piv5qC55o2u5paH5Lu254K56YCJ5qyh5bqP5o6S5YiXXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIGdldEVycm9ySXRlbXMoZmlsZVF1ZXVlOiBBcnJheTxUaUZpbGVJdGVtPik6IEFycmF5PFRpRmlsZUl0ZW0+IHtcclxuICAgICAgICByZXR1cm4gZmlsZVF1ZXVlLmZpbHRlcigoaXRlbTogVGlGaWxlSXRlbSk6IGJvb2xlYW4gPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gaXRlbS5pc0Vycm9yO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnNvcnQoKGl0ZW0xOiBUaUZpbGVJdGVtLCBpdGVtMjogVGlGaWxlSXRlbSk6IG51bWJlciA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBpdGVtMS5pbmRleCAtIGl0ZW0yLmluZGV4O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6YeN5paw5LiK5Lyg5YiX6KGo5Lit5omA5pyJ5YWI5YmN5LiK5Lyg6ZSZ6K+v5paH5Lu2XHJcbiAgICAgKiDov5Tlm54g5pegXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIHJlbG9hZEFsbEVycm9yKGZpbGVRdWV1ZTogQXJyYXk8VGlGaWxlSXRlbT4pOiB2b2lkIHtcclxuICAgICAgICBUaVVwbG9hZFNlcnZpY2UudXBsb2FkSXRlbXMoVGlVcGxvYWRTZXJ2aWNlLmdldEVycm9ySXRlbXMoZmlsZVF1ZXVlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDph43mlrDkuIrkvKDliJfooajkuK3miYDmnInmlofku7ZcclxuICAgICAqIOi/lOWbniDml6BcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVsb2FkQWxsKGZpbGVRdWV1ZTogQXJyYXk8VGlGaWxlSXRlbT4pOiB2b2lkIHtcclxuICAgICAgICBUaVVwbG9hZFNlcnZpY2UudXBsb2FkSXRlbXMoZmlsZVF1ZXVlKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS4iuS8oOWIl+ihqOS4reaJgOacieacquS4iuS8oOi/h+eahOaWh+S7tlxyXG4gICAgICog6L+U5ZueIOaXoFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyB1cGxvYWRBbGwoZmlsZVF1ZXVlOiBBcnJheTxUaUZpbGVJdGVtPik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zOiBBcnJheTxUaUZpbGVJdGVtPiA9IHRoaXMuZ2V0Tm90VXBsb2FkZWRJdGVtcyhmaWxlUXVldWUpXHJcbiAgICAgICAgICAgIC5maWx0ZXIoKGl0ZW06IFRpRmlsZUl0ZW0pOiBib29sZWFuID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuICFpdGVtLmlzVXBsb2FkaW5nO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFRpVXBsb2FkU2VydmljZS51cGxvYWRJdGVtcyhpdGVtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliKTmlq3mmK/lkKbmnInmnKrkuIrkvKDnmoRcclxuICAgICAqIOi/lOWbniBib29sZWFuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIGlzVXBsb2FkZWRBbGwoZmlsZVF1ZXVlOiBBcnJheTxUaUZpbGVJdGVtPik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zOiBBcnJheTxUaUZpbGVJdGVtPiAgPSB0aGlzLmdldE5vdFVwbG9hZGVkSXRlbXMoZmlsZVF1ZXVlKVxyXG4gICAgICAgICAgICAuZmlsdGVyKChpdGVtOiBUaUZpbGVJdGVtKTogYm9vbGVhbiA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiAhaXRlbS5pc1VwbG9hZGluZztcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGl0ZW1zLmxlbmd0aCA9PT0gMDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIoOmZpOaJgOaciemYn+WIl+S4reeahOaWh+S7tlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyByZW1vdmVBbGwoZmlsZVF1ZXVlOiBBcnJheTxUaUZpbGVJdGVtPik6IHZvaWQge1xyXG4gICAgICAgIHdoaWxlIChmaWxlUXVldWUubGVuZ3RoICE9PSAwKSB7XHJcbiAgICAgICAgICAgIGZpbGVRdWV1ZVswXS5yZW1vdmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlj5bmtojmiYDmnInpmJ/liJfkuK3nmoTmlofku7Yo5pyq5LiK5Lyg5ZKM5b6F5LiK5Lyg5paH5Lu2KVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyBjYW5jZWxBbGwoZmlsZVF1ZXVlOiBBcnJheTxUaUZpbGVJdGVtPik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zOiBBcnJheTxUaUZpbGVJdGVtPiAgPSB0aGlzLmdldE5vdFVwbG9hZGVkSXRlbXMoZmlsZVF1ZXVlKTtcclxuICAgICAgICBUaVVwbG9hZFNlcnZpY2UuY2FuY2VsSXRlbXMoaXRlbXMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu65paH5Lu25LiK5Lyg5a6e5L6LXHJcbiAgICAgKi9cclxuICAgIGNyZWF0ZShjb25maWc6IFRpVXBsb2FkQ29uZmlnKTogVGlVcGxvYWRSZWYge1xyXG4gICAgICAgIGNvbnN0IGlzU2luZ2xlRmlsZTogYm9vbGVhbiA9IFRpVXBsb2FkU2VydmljZS5pc1NpbmdsZUZpbGVGbihjb25maWcuZmlsdGVycyk7IC8vIOaWh+S7tuaYr+WQpuS4uuWNleaWh+S7tuiuvue9rlxyXG4gICAgICAgIGNvbnN0IGZpbHRlcnM6IEFycmF5PFRpRmlsdGVyPiA9IFRpVXBsb2FkU2VydmljZS5pbml0RmlsdGVyKGNvbmZpZy5maWx0ZXJzLCBpc1NpbmdsZUZpbGUpOyAvLyDmlofku7bmoKHpqozov4fmu6Top4TliJlcclxuXHJcbiAgICAgICAgbGV0IHVwbG9hZGVyOiBUaVVwbG9hZFJlZjtcclxuICAgICAgICBjb25zdCBmaWxlUXVldWU6IEFycmF5PFRpRmlsZUl0ZW0+ID0gW107IC8vIOaWh+S7tumYn+WIl+WIl+ihqO+8jOS4gOS4quWunuS+i+WvueW6lOS4gOS4quaWh+S7tuWIl+ihqFxyXG4gICAgICAgIGxldCBmaWxlSW5kZXg6IG51bWJlciA9IDA7IC8vIOaWh+S7tuasoeW6j+WumuS5ie+8jOeUqOS9nOaWh+S7tue0ouW8lVxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWwhumAieaLqeeahOaWh+S7tui/m+ihjOacieaViOmqjOivgeWQjuWKoOWFpeWIsOmYn+WIl+S4rSzlpJbpg6josIPnlKjor6Xmlrnms5Xml7Ys6K6k5Li66K+l6Zif5YiX5Lit55qE5paH5Lu25ZKM5b2T5YmNdXBsb2FkZXLnmoTphY3nva7pobnkuIDoh7RcclxuICAgICAgICAgKiAgIGZpbGVzIHtGaWxlTGlzdHxGaWxlSW5wdXR9IOaWh+S7tuWvueixoVxyXG4gICAgICAgICAqIOi/lOWbniB7QXJyYXl9IOW3sua3u+WKoOaWh+S7tuaVsOe7hFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNvbnN0IGFkZFRvUXVldWU6IChmaWxlczogRmlsZUxpc3QgfCBFbGVtZW50KSA9PiBBcnJheTxUaUZpbGVJdGVtPiA9XHJcbiAgICAgICAgICAgIChmaWxlczogRmlsZUxpc3QgfCBFbGVtZW50KTogQXJyYXk8VGlGaWxlSXRlbT4gPT4ge1xyXG4gICAgICAgICAgICAvLyDlvqrnjq/liJfooajmt7vliqDmlofku7ZcclxuICAgICAgICAgICAgY29uc3QgYWRkZWRJdGVtczogQXJyYXk8VGlGaWxlSXRlbT4gPSBbXTsgLy8g55So5LqO6K6w5b2V5pys5qyh6YCJ5oup5paH5Lu25YiX6KGoXHJcbiAgICAgICAgICAgIGlmIChmaWxlcyAmJiAhVXRpbC5pc1VuZGVmaW5lZCgoZmlsZXMgYXMgRmlsZUxpc3QpLmxlbmd0aCkpIHsgLy8gSDXmlrnlvI9cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCAoZmlsZXMgYXMgRmlsZUxpc3QpLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkSXRlbShmaWxlc1tpXSwgYWRkZWRJdGVtcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhZGRJdGVtKGZpbGVzLCBhZGRlZEl0ZW1zKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGFkZGVkSXRlbXM7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBhZGRJdGVtOiAoZmlsZU9ySW5wdXQ6IGFueSwgYWRkZWRJdGVtczogQXJyYXk8YW55PikgPT4gdm9pZCA9XHJcbiAgICAgICAgICAgIChmaWxlT3JJbnB1dDogYW55LCBhZGRlZEl0ZW1zOiBBcnJheTxhbnk+KTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIC8vIOaWh+S7tuWvueixoe+8jOivpeWvueixoeWMheWQq+aWh+S7tueahOWfuuacrOS/oeaBr++8jOe7n+S4gOS6hua1j+iniOWZqOeahOW3ruW8guaAp++8jOS8muWcqOaWh+S7tui/h+a7pOWksei0peWbnuiwg+S4reS9nOS4uuWPguaVsOS8oOmAkue7meWklumDqFxyXG4gICAgICAgICAgICBjb25zdCB0aWZpbGVPYmplY3Q6IFRpRmlsZUluZm8gPSBUaUZpbGVJdGVtVXRpbC5jcmVhdGVGaWxlT2JqZWN0KGZpbGVPcklucHV0KTtcclxuXHJcbiAgICAgICAgICAgIC8vIOagoemqjOWNleS4quaWh+S7tueahOacieaViOaAp++8jOW5tuagueaNruagoemqjOe7k+aenOi/m+ihjOaWh+S7tuaTjeS9nFxyXG4gICAgICAgICAgICBjb25zdCBpbnZhbGlkQXJyOiBBcnJheTxzdHJpbmc+ID0gVGlVcGxvYWRTZXJ2aWNlLmdldEludmFsaWRSdWxlcyh0aWZpbGVPYmplY3QsIGZpbHRlcnMsIGZpbGVRdWV1ZSk7IC8vIOagoemqjOe7k+aenOaVsOe7hO+8jOaVsOe7hOS4reWumuS5ieagoemqjOmUmeivr+inhOWImeeahG5hbWVcclxuICAgICAgICAgICAgbGV0IGlzVmFsaWQ6IGJvb2xlYW4gPSAhaW52YWxpZEFyci5sZW5ndGg7IC8vIOagoemqjOe7k+aenOi/lOWbnuaVsOe7hOS4uuepuuaXtuacieaViFxyXG5cclxuICAgICAgICAgICAgLy8g5Y2V5paH5Lu25oOF5Ya15LiL77yM6ZyA6KaB6KaG55uW5Y6f5pyJ5pyJ5pWI5paH5Lu2XHJcbiAgICAgICAgICAgIGlmIChpc1NpbmdsZUZpbGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChmaWxlUXVldWVbMF0pIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWxlUXVldWVbMF0ucmVtb3ZlKCk7IC8vIOWIoOmZpOWFiOWJjemYn+WIl+S4reeahOaWh+S7tlxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGludmFsaWRBcnIubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHRydWU7IC8vIOe9ruS9jeagoemqjOe7k+aenOWAvFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpc1ZhbGlkKSB7IC8vIOagoemqjOaIkOWKn+aDheWGteS4i++8jOWwhuaWh+S7tuWKoOWFpeWIsOS4iuS8oOmYn+WIl+S4re+8jOW5tuinpuWPkVxyXG4gICAgICAgICAgICAgICAgLy8g5LiK5Lyg5paH5Lu25a+56LGhLOivpeWvueixoeS4reWMheWQq+aWh+S7tuWPiueKtuaAgeS/oeaBr+etiSzlnKjlm57osIPkuK3kvKDpgJJcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVJdGVtOiBUaUZpbGVJdGVtID0gVGlGaWxlSXRlbVV0aWwuY3JlYXRlRmlsZUl0ZW0odGlmaWxlT2JqZWN0LCBmaWxlT3JJbnB1dCxcclxuICAgICAgICAgICAgICAgICAgICBjb25maWcsIHVwbG9hZGVyKTtcclxuICAgICAgICAgICAgICAgIGFkZGVkSXRlbXMucHVzaChmaWxlSXRlbSk7XHJcbiAgICAgICAgICAgICAgICBmaWxlUXVldWUucHVzaChmaWxlSXRlbSk7XHJcbiAgICAgICAgICAgICAgICBmaWxlSXRlbS5pbmRleCA9ICsrZmlsZUluZGV4OyAvLyDmlofku7bluo/liJfmlbDlop7liqDvvIznoa7kv53mlbTkuKrmlofku7bpmJ/liJfkuK3or6XlgLzllK/kuIBcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLm9uQWRkSXRlbVN1Y2Nlc3MgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25maWcub25BZGRJdGVtU3VjY2VzcyhmaWxlSXRlbSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbmZpZy5vbkFkZEl0ZW1GYWlsZWQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIGNvbmZpZy5vbkFkZEl0ZW1GYWlsZWQodGlmaWxlT2JqZWN0LCBpbnZhbGlkQXJyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdXBsb2FkZXIgPSB7XHJcbiAgICAgICAgICAgIHF1ZXVlOiBmaWxlUXVldWUsIC8vIOS4iuS8oOaWh+S7tumYn+WIlyzlj6/or7vlsZ7mgKdcclxuICAgICAgICAgICAgaXNTaW5nbGVGaWxlLCAvLyDmlofku7bmmK/lkKbmnInljZXmlofku7bpgInmi6npmZDliLZcclxuICAgICAgICAgICAgY29uZmlnLCAvLyDmmK/lkKboh6rliqjkuIrkvKDmlofku7ZcclxuICAgICAgICAgICAgX2FkZFRvUXVldWU6IGFkZFRvUXVldWUsIC8vIOaWh+S7tua3u+WKoOaWueazlVxyXG4gICAgICAgICAgICBnZXROb3RVcGxvYWRlZEl0ZW1zKCk6IEFycmF5PFRpRmlsZUl0ZW0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBUaVVwbG9hZFNlcnZpY2UuZ2V0Tm90VXBsb2FkZWRJdGVtcyhmaWxlUXVldWUpO1xyXG4gICAgICAgICAgICB9LCAvLyDmnKrkuIrkvKDlrozmiJDmlofku7bojrflj5ZcclxuICAgICAgICAgICAgZ2V0UmVhZHlJdGVtcygpOiBBcnJheTxUaUZpbGVJdGVtPiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gVGlVcGxvYWRTZXJ2aWNlLmdldFJlYWR5SXRlbXMoZmlsZVF1ZXVlKTtcclxuICAgICAgICAgICAgfSwgLy8g5bey5o+Q5Lqk5LiK5Lyg77yM5L2G6L+Y5pyq5LiK5Lyg5paH5Lu26I635Y+WXHJcbiAgICAgICAgICAgIHVwbG9hZEFsbCgpOiB2b2lkIHtcclxuICAgICAgICAgICAgICAgIFRpVXBsb2FkU2VydmljZS51cGxvYWRBbGwoZmlsZVF1ZXVlKTtcclxuICAgICAgICAgICAgfSwgLy8g5LiK5Lyg6Zif5YiX5Lit5omA5pyJ6L+Y5pyq5omn6KGM6L+H5LiK5Lyg55qE5paH5Lu2XHJcbiAgICAgICAgICAgIGlzVXBsb2FkZWRBbGwoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gVGlVcGxvYWRTZXJ2aWNlLmlzVXBsb2FkZWRBbGwoZmlsZVF1ZXVlKTtcclxuICAgICAgICAgICAgfSwgLy8g5LiK5Lyg6Zif5YiX5Lit5piv5ZCm5pyJ5pyq5LiK5Lyg6L+H55qEXHJcbiAgICAgICAgICAgIHJlbW92ZUFsbCgpOiB2b2lkIHtcclxuICAgICAgICAgICAgICAgIFRpVXBsb2FkU2VydmljZS5yZW1vdmVBbGwoZmlsZVF1ZXVlKTtcclxuICAgICAgICAgICAgfSwgLy8g5Yig6Zmk6Zif5YiX5Lit5omA5pyJ5paH5Lu2XHJcbiAgICAgICAgICAgIGNhbmNlbEFsbCgpOiB2b2lkIHtcclxuICAgICAgICAgICAgICAgIFRpVXBsb2FkU2VydmljZS5jYW5jZWxBbGwoZmlsZVF1ZXVlKTtcclxuICAgICAgICAgICAgfSwgLy8g5Y+W5raI6Zif5YiX5Lit5omA5pyJ5LiK5Lyg5paH5Lu2XHJcbiAgICAgICAgICAgIHJlbG9hZEFsbCgpOiB2b2lkIHtcclxuICAgICAgICAgICAgICAgIFRpVXBsb2FkU2VydmljZS5yZWxvYWRBbGwoZmlsZVF1ZXVlKTtcclxuICAgICAgICAgICAgfSwgLy8g6YeN5paw5LiK5Lyg6Zif5YiX5Lit5omA5pyJ5paH5Lu2XHJcbiAgICAgICAgICAgIHJlbG9hZEFsbEVycm9yKCk6IHZvaWQge1xyXG4gICAgICAgICAgICAgICAgVGlVcGxvYWRTZXJ2aWNlLnJlbG9hZEFsbEVycm9yKGZpbGVRdWV1ZSk7XHJcbiAgICAgICAgICAgIH0sIC8vIOmHjeaWsOS4iuS8oOmYn+WIl+S4reaJgOacieS4iuS8oOmUmeivr+aWh+S7tlxyXG4gICAgICAgICAgICB1cGxvYWRJdGVtczogVGlVcGxvYWRTZXJ2aWNlLnVwbG9hZEl0ZW1zLCAvLyDkuIrkvKDpmJ/liJfkuK3mn5Dlh6Dpobnmlofku7ZcclxuICAgICAgICAgICAgcmVtb3ZlSXRlbXM6IFRpVXBsb2FkU2VydmljZS5yZW1vdmVJdGVtcywgLy8g5Yig6Zmk6Zif5YiX5Lit5p+Q5Yeg6aG55paH5Lu2XHJcbiAgICAgICAgICAgIGNhbmNlbEl0ZW1zOiBUaVVwbG9hZFNlcnZpY2UuY2FuY2VsSXRlbXMgLy8g5Y+W5raI6Zif5YiX5Lit5p+Q5Yeg6aG55paH5Lu2XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHVwbG9hZGVyO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==