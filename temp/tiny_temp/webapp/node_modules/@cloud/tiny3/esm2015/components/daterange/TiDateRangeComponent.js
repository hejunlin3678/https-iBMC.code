import { Component } from '@angular/core';
import { TiDateUtil, TiKeymap, Util } from '../../utils/Util';
import { TiFormComponent } from '../base/TiBaseModule';
import { TiDateBaseComponent } from '../datebase/TiDateBaseModule';
import { TiLocale, TiLocaleFormat } from '../../locale/TiLocaleModule';
/**
 * DateRange日期范围组件
 *
 * DateRange组件提供了一种方便的显示和设置日期范围的方式
 *
 * <example-url>../tiny3demo/#/daterange/daterange-all</example-url>
 */
export class TiDateRangeComponent extends TiDateBaseComponent {
    constructor() {
        super(...arguments);
        /**
         * @ignore
         * 标记date/datetime的类型
         */
        this.isDatetime = false;
        /**
         * @ignore
         * 用于标记是不是range
         */
        this.isRange = true;
        /**
         * @ignore
         * 保存model值
         */
        this.oldModel = {
            begin: null,
            end: null
        };
        /**
         * @ignore
         * placeholder提示文本
         */
        this.placeholder = `${TiLocale.getLocaleWords().tiDate.rangeBeginLabel} ─ ${TiLocale.getLocaleWords().tiDate.rangeEndLabel}`;
    }
    ngOnChanges(changes) {
        // format支持动态变更
        if (changes['format'] && !changes['format'].firstChange) {
            // 新的format是非法时，format值保持之前值不变
            if (!Util.isString(changes['format'].currentValue)) {
                this.format = changes['format'].previousValue;
                return;
            }
            this.formatValue();
        }
        // 验证最大值最小值，为了处理最大值和最小值从合法日期变为undefined 的情景
        if ((changes['max'] && !changes['max'].firstChange) || (changes['min'] && !changes['min'].firstChange)) {
            this.validateMinAndMax(this.config, this.isDatetime);
        }
    }
    ngDoCheck() {
        // 监听value值
        if (!Util.isUndefined(this.model)) {
            if (!this.isValidValue(this.model)) {
                return;
            }
            // 监听model值的变化
            this.setModel(this.isDatetime);
        }
    }
    /**
     * @ignore
     * 将value转换成format接口格式的字符串
     */
    formatValue() {
        if (this.model === null || (this.model.begin === null && this.model.end === null)) {
            this.inputValue = '';
        }
        else {
            const begin = TiLocaleFormat.formatDate(this.model.begin, this.format);
            const end = TiLocaleFormat.formatDate(this.model.end, this.format);
            // 注意：中划线用的是制表符中的中划线，与正常的中线区分开2017-2-12 - 2018-3-20
            this.inputValue = `${begin} ─ ${end}`;
        }
    }
    /**
     * @ignore
     */
    onKeydownFn(event, pos) {
        if (event.keyCode === TiKeymap.KEY_ENTER || event.keyCode === TiKeymap.KEY_NUMPAD_ENTER) {
            this.dateEditBlur(pos);
        }
    }
    /**
     * @ignore
     */
    dateEditBlur(pos) {
        // 输入值超出最大最小 认为非法
        const value = this.datePanel.value;
        if (TiDateUtil.isDate(value.begin) && TiDateUtil.isDate(value.end)) {
            if (TiDateUtil.isBigger(value.begin, value.end)) {
                if (pos === 'begin') {
                    this.datePanel.value.begin = this.oldBeginValue || this.oldModel && this.oldModel.begin;
                }
                else {
                    this.datePanel.value.end = this.oldEndValue || this.oldModel && this.oldModel.end;
                }
            }
            this.oldBeginValue = this.datePanel.value.begin;
            this.oldEndValue = this.datePanel.value.end;
        }
        this.setOkBtnState();
    }
    /**
     * @ignore
     * 确认按钮
     */
    onOkClick() {
        if (this.inValidValue) {
            return;
        }
        if (this.datePanel instanceof Object) {
            // 新旧值不同更新model值
            if (!this.rangeValueIsEqual(this.model, this.datePanel['value'], this.isDatetime)) {
                this.model = {
                    begin: this.datePanel['value'].begin,
                    end: this.datePanel['value'].end
                };
            }
        }
        this.hideDrop();
        this.okClick.emit(this.model);
    }
    /**
     * @ignore
     * 是否为禁用日期
     */
    isDisabledDays(value) {
        let isDisabled = false;
        if (Util.isArray(this.disabledDays) && this.disabledDays.length > 0) {
            this.disabledDays.forEach((item) => {
                if (item.getTime() === value.getTime()) {
                    isDisabled = true;
                }
            });
        }
        return isDisabled;
    }
    /**
     * @ignore
     * model值的合法性判断
     */
    isValidValue(value) {
        if (value === null) {
            return true;
        }
        return this.isValidRange(value) ? true : false;
    }
    // 判断是不是合法范围
    isValidRange(value) {
        if (!(value instanceof Object) || !TiDateUtil.isDate(value.begin) || !TiDateUtil.isDate(value.end)) {
            return false;
        }
        const startDate = new Date(value.begin.getFullYear(), value.begin.getMonth(), value.begin.getDate());
        const endDate = new Date(value.end.getFullYear(), value.end.getMonth(), value.end.getDate());
        return startDate.getTime() <= endDate.getTime() && TiDateUtil.isBetweenMaxAndmin(startDate, this.min, this.max)
            && TiDateUtil.isBetweenMaxAndmin(endDate, this.min, this.max);
    }
    /**
     * @ignore
     * 设置确认按钮的状态
     */
    setOkBtnState() {
        const date = this.datePanel.value;
        let endTime;
        let beginTime;
        if (TiDateUtil.isDate(date.end)) {
            endTime = new Date(date.end.getFullYear(), date.end.getMonth(), date.end.getDate()).getTime();
        }
        if (TiDateUtil.isDate(date.begin)) {
            beginTime = new Date(date.begin.getFullYear(), date.begin.getMonth(), date.begin.getDate()).getTime();
        }
        const isBeginSmallorEqualEnd = this.isAllowBeginEqualEnd ? endTime < beginTime : endTime <= beginTime;
        this.inValidValue = !(date instanceof Object)
            || !TiDateUtil.isDate(date.begin)
            || !TiDateUtil.isDate(date.end)
            || isBeginSmallorEqualEnd;
        if (this.buttonComs) {
            this.setAttr(this.buttonComs.last.nativeElement, 'disabled', this.inValidValue);
            this.setInputStyle(this.inValidValue);
        }
    }
    /**
     * @ignore
     * 配置时间日期面板接口
     */
    setPickerDate() {
        // 做深拷贝的原因：不让model和datePanel组件中value双向绑定，
        // 因为下拉面板中日期变化时，不立即更新到输入框中
        let value;
        if (this.model === null || this.model === undefined) {
            value = {
                begin: null,
                end: null
            };
        }
        else {
            value = {
                begin: this.model.begin,
                end: this.model.end
            };
        }
        this.datePanel = {
            value,
            format: this.format,
            max: this.max,
            min: this.min,
            picker: 'day',
            select: () => {
                const obj = {
                    value: this.datePanel.value[this.focusedPosition],
                    focusedPosition: this.focusedPosition
                };
                this.dayClick.emit(obj);
                // 初始化选择结束之后，如果开始未选择，焦点转移到开始日期编辑框
                if (this.focusedPosition === 'end' && this.datePanel.value.begin === null) {
                    this.focusedPosition = 'begin';
                    this.dateEditComs.first.focus();
                }
                else {
                    if (!this.isEndFixed) {
                        this.focusedPosition = 'end';
                        this.dateEditComs.last.focus();
                    }
                }
                this.setOkBtnState();
            }
        };
        // 如果只显示年
        if (this.format.indexOf('M') === -1 && this.format !== 'mediumDate') {
            this.datePanel['picker'] = 'onlyYear';
        }
        else if (this.format.indexOf('d') === -1) { // 如果只显示年月
            this.datePanel['picker'] = 'onlyYearMonth';
        }
        this.setOkBtnState();
    }
}
TiDateRangeComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-date-range',
                template: "<ti-date-dominator  #dominator\r\n                    [id]=\"appendId('dominator')\"\r\n                    type = \"range\"\r\n                    [format]=\"format\"\r\n                    [disabled]=\"disabled\"\r\n                    [clearable]=\"clearIcon\"\r\n                    [(ngModel)]=\"inputValue\"\r\n                    (clear)=\"onIconClearClick($event)\"\r\n                    (click)=\"onShowClick()\">{{placeholder}}</ti-date-dominator><!-- \u5206\u5272\u7EBF\u662F\u7279\u6B8A\u5B57\u7B26\u5236\u8868\u7B26\uFF0C\u4E0D\u662F\u666E\u901A\u4E2D\u7EBF -->\r\n<ti-drop #drop\r\n    class=\"ti3-date-range-picker\"\r\n    [ngClass]=\"{'ti3-date-range-customize': hasCustomizeTime}\"\r\n    [dominatorElem]=\"dominatorCom.nativeElement\"\r\n    fixMaxHeight=\"true\"\r\n    [panelWidth]=\"daterangePanelWidth\"\r\n    [panelAlign]=\"panelAlign\"\r\n    [browserSpace]=\"browserSpace\"\r\n    [dominatorSpace]='dominatorSpace'\r\n    [determinPositionFn]=\"determinPositionFn\"\r\n    theme='noborder'\r\n    [id]=\"appendId('drop')\">\r\n\r\n   <section class='ti3-date-clear'>\r\n    <section *ngIf='hasCustomizeTime' class='ti3-date-range-customize-container'>\r\n        <ng-container *ngTemplateOutlet=\"customizeTemplate; context:  {$implicit: customizeOptions}\"></ng-container>\r\n    </section>\r\n\r\n    <section style='float: right;'>\r\n        <section class=\"ti3-date-edit-container\">\r\n            <ti-date-edit class='ti3-date-range-edit'\r\n                        [ngClass]=\"{'ti3-date-range-begin-edit': focusedPosition === 'begin'}\"\r\n                        [(ngModel)] = \"datePanel.value.begin\"\r\n                        [min] = \"datePanel.min\"\r\n                        [max] = \"datePanel.max\"\r\n                        (click)=\"dateEditClick('begin')\"\r\n                        [disabled]='isBeginFixed'\r\n                        [disabledDays]='disabledDays'\r\n                        (focus)=\"dateEditFocus('begin')\"\r\n                        (blur)=\"dateEditBlur('begin')\"\r\n                        (keydown)=\"onKeydownFn($event, 'begin')\"\r\n                        [format]=\"datePanel.format\" [id]=\"appendId('begin_edit')\"></ti-date-edit>\r\n                        <span class='ti3-date-range-splitline'> \u2500 </span>\r\n                    <ti-date-edit class='ti3-date-range-edit'\r\n                    [ngClass]=\"{'ti3-date-range-end-edit': focusedPosition === 'end'}\"\r\n                    [(ngModel)] = \"datePanel.value.end\"\r\n                    [min] = \"datePanel.min\"\r\n                    [max] = \"datePanel.max\"\r\n                    [disabledDays]='disabledDays'\r\n                    [disabled]='isEndFixed'\r\n                    (focus)=\"dateEditFocus('end')\"\r\n                    (blur)=\"dateEditBlur('end')\"\r\n                    (keydown)=\"onKeydownFn($event, 'end')\"\r\n                    (click)=\"dateEditClick('end')\"\r\n                    [format]=\"datePanel.format\" [id]=\"appendId('end_edit')\"></ti-date-edit>\r\n                    <!-- \u786E\u8BA4\u6309\u94AE\u7981\u7528\u573A\u666F\u4E0B\uFF0C\u7ED3\u675F\u6846\u8F93\u5165\u4E4B\u540E\u65E0\u6CD5\u76F4\u63A5tab\u5207\u6362\u7126\u70B9\u81F3\u786E\u8BA4\u6309\u94AE\uFF0C\u6545\u6DFB\u52A0\u6B64\u8FC7\u5EA6input -->\r\n                    <input #input type=\"text\" class=\"ti3-tab-input\"/>\r\n        </section>\r\n        <ti-date-panel\r\n            [id]=\"appendId('begin-panel')\"\r\n            [(value)]=\"datePanel.value\"\r\n            [focusedPosition]='focusedPosition'\r\n            [(picker)]=\"datePanel.picker\"\r\n            [isRange]='true'\r\n            [disabledDays]='disabledDays'\r\n            [isBeginFixed]='isBeginFixed'\r\n            [isEndFixed]='isEndFixed'\r\n            (select)='datePanel.select()'\r\n            [min]=\"datePanel.min\"\r\n            [max]=\"datePanel.max\"\r\n            [format]=\"datePanel.format\"\r\n            [nowDateTime]=\"nowDateTime\"></ti-date-panel>\r\n    </section>\r\n   </section>\r\n    <section  class=\"ti3-date-picker-footer-right\">\r\n        <button class=\"ti3-date-picker-footer-btn\"\r\n                        [id]=\"appendId('okBtn')\"\r\n                        type=\"button\"\r\n                        size=\"small\"\r\n                        (click)=\"onOkClick()\"\r\n                        tiButton>{{ 'tiCommon.okBtn' | tiTranslate }}</button>\r\n    </section>\r\n</ti-drop>\r\n<ng-template #customizeTemplate let-options>\r\n    <ul [id]=\"appendId('list')\">\r\n        <li *ngFor='let option of options; index as i;' class='ti3-customize-time-label' (click)='customizeTimeClickFn(option.value)' [id]=\"appendId('label_' + i)\">{{option.label}}</li>\r\n    </ul>\r\n</ng-template>\r\n",
                // tslint:disable-next-line:use-host-property-decorator
                host: {
                    '[class.ti3-date-range-input-container]': 'true',
                    '(blur)': 'hidePanel()'
                },
                providers: [TiFormComponent.getValueAccessor(TiDateRangeComponent)],
                styles: [".ti3-compnent-container-border,:host.ti3-date-range-input-container{-ms-box-sizing:border-box;border:1px solid;border-radius:var(--ti-input-border-radius);box-sizing:border-box;display:inline-block}.ti3-compnent-container-border:not([disabled]),:host.ti3-date-range-input-container:not([disabled]){background-color:var(--ti-input-bg-color);border-color:var(--ti-input-border-color)}.ti3-compnent-container-border:not([disabled]):hover,:host.ti3-date-range-input-container:not([disabled]):hover{border-color:var(--ti-input-border-color-hover)}.ti3-compnent-container-border:not([disabled])[tiFocused],:host.ti3-date-range-input-container:not([disabled])[tiFocused]{border-color:var(--ti-input-border-color-focus)}.ti3-compnent-container-border[disabled],:host.ti3-date-range-input-container[disabled]{background-color:var(--ti-input-bg-color-disabled);border-color:var(--ti-input-border-color-disabled);cursor:not-allowed!important}.ti3-customize-time-label{color:var(--ti-common-color-text-primary);cursor:pointer;font-size:var(--ti-common-font-size-base);line-height:var(--ti-common-line-height-number);margin-bottom:10px}.ti3-customize-time-label:hover{color:var(--ti-common-color-line-active)}.ti3-date-clear{display:flex;*zoom:1}.ti3-date-clear:after{clear:both}.ti3-date-clear:after,.ti3-date-clear:before{content:\"\";display:table}.ti3-datetime-select-btn{color:var(--ti-common-color-text-highlight);cursor:pointer;float:right;line-height:24px;padding-right:var(--ti-common-space-2x)}.ti3-datetime-select-btn-disabled{color:var(--ti-common-color-text-disabled);cursor:not-allowed}.ti3-date-range-splitline{padding:0 6px}.ti3-tab-input{height:0;left:-9999px;position:absolute;top:-9999px;width:0}::ng-deep :root{--ti-date-picker-middle-margin:20px;--ti-date-picker-padding-bottom:12px;--ti-date-picker-padding-horizon:16px}:host.ti3-date-range-input-container{width:240px}.ti3-dropdown-container.ti3-date-range-picker{font-size:var(--ti-datetime-input-font-size);padding:var(--ti-date-picker-padding-bottom) var(--ti-date-picker-padding-horizon);width:calc(var(--ti-datetime-day-width)*7 + var(--ti-date-picker-padding-horizon) + var(--ti-date-picker-middle-margin) + 2px);z-index:var(--ti-datetime-z-index)}.ti3-dropdown-container.ti3-date-range-picker:focus{outline:0}.ti3-date-range-begin-end-text{color:var(--ti-datetime-picker-color);height:var(--ti-datetime-input-font-size);line-height:var(--ti-datetime-input-font-size);margin-top:var(--ti-common-space-10);padding-left:var(--ti-common-space-10)}.ti3-date-range-customize{width:669px!important}.ti3-date-range-edit{display:inline-block;width:248px}::ng-deep .ti3-date-range-begin-edit input[tiText],::ng-deep .ti3-date-range-end-edit input[tiText]{border-color:var(--ti-input-border-color-focus)!important}.ti3-date-range-customize-container{border-right:1px solid var(--ti-common-color-line-dividing);float:left;height:292px;margin-right:var(--ti-common-space-4x);padding-right:var(--ti-common-space-4x);width:80px}::ng-deep :root .ti3-date-picker-footer-right{border-top:1px solid var(--ti-common-color-line-dividing);margin-top:var(--ti-common-space-3x);padding-top:var(--ti-common-space-3x);width:100%}.ti3-date-picker-footer-btn{float:right}"]
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlEYXRlUmFuZ2VDb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueTMvY29tcG9uZW50cy9kYXRlcmFuZ2UvVGlEYXRlUmFuZ2VDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFNBQVMsRUFLWixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkQsT0FBTyxFQUFFLG1CQUFtQixFQUFlLE1BQU0sOEJBQThCLENBQUM7QUFDaEYsT0FBTyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUV2RTs7Ozs7O0dBTUc7QUFhSCxNQUFNLE9BQU8sb0JBQXFCLFNBQVEsbUJBQW1CO0lBWjdEOztRQWtCSTs7O1dBR0c7UUFDSSxlQUFVLEdBQVksS0FBSyxDQUFDO1FBQ25DOzs7V0FHRztRQUNJLFlBQU8sR0FBWSxJQUFJLENBQUM7UUFDL0I7OztXQUdHO1FBQ0ksYUFBUSxHQUFnQjtZQUMzQixLQUFLLEVBQUUsSUFBSTtZQUNYLEdBQUcsRUFBRSxJQUFJO1NBQ1osQ0FBQztRQUNGOzs7V0FHRztRQUNJLGdCQUFXLEdBQVcsR0FBRyxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsTUFBTSxDQUFDLGVBQWUsTUFBTSxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBOE4zSSxDQUFDO0lBM05HLFdBQVcsQ0FBQyxPQUFzQjtRQUM5QixlQUFlO1FBQ2YsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxFQUFFO1lBQ3JELDhCQUE4QjtZQUM5QixJ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QUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDOzs7WUFyUUosU0FBUyxTQUFDO2dCQUNSLFFBQVEsRUFBRSxlQUFlO2dCQUN6Qix1ckpBQStCO2dCQUUvQix1REFBdUQ7Z0JBQ3ZELElBQUksRUFBRTtvQkFDTCx3Q0FBd0MsRUFBRSxNQUFNO29CQUNoRCxRQUFRLEVBQUUsYUFBYTtpQkFDMUI7Z0JBQ0UsU0FBUyxFQUFFLENBQUUsZUFBZSxDQUFDLGdCQUFnQixDQUFDLG9CQUFvQixDQUFDLENBQUM7O2FBQ3RFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIENvbXBvbmVudCxcclxuICAgIEVsZW1lbnRSZWYsXHJcbiAgICBOZ1pvbmUsXHJcbiAgICBSZW5kZXJlcjIsXHJcbiAgICBTaW1wbGVDaGFuZ2VzXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRpRGF0ZVV0aWwsIFRpS2V5bWFwLCBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbmltcG9ydCB7IFRpRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2UvVGlCYXNlTW9kdWxlJztcclxuaW1wb3J0IHsgVGlEYXRlQmFzZUNvbXBvbmVudCwgVGlEYXRlVmFsdWUgfSBmcm9tICcuLi9kYXRlYmFzZS9UaURhdGVCYXNlTW9kdWxlJztcclxuaW1wb3J0IHsgVGlMb2NhbGUsIFRpTG9jYWxlRm9ybWF0IH0gZnJvbSAnLi4vLi4vbG9jYWxlL1RpTG9jYWxlTW9kdWxlJztcclxuXHJcbi8qKlxyXG4gKiBEYXRlUmFuZ2Xml6XmnJ/ojIPlm7Tnu4Tku7ZcclxuICpcclxuICogRGF0ZVJhbmdl57uE5Lu25o+Q5L6b5LqG5LiA56eN5pa55L6/55qE5pi+56S65ZKM6K6+572u5pel5pyf6IyD5Zu055qE5pa55byPXHJcbiAqXHJcbiAqIDxleGFtcGxlLXVybD4uLi90aW55M2RlbW8vIy9kYXRlcmFuZ2UvZGF0ZXJhbmdlLWFsbDwvZXhhbXBsZS11cmw+XHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICAgc2VsZWN0b3I6ICd0aS1kYXRlLXJhbmdlJyxcclxuICAgdGVtcGxhdGVVcmw6ICcuL2RhdGVyYW5nZS5odG1sJyxcclxuICAgc3R5bGVVcmxzOiBbJy4vZGF0ZXJhbmdlLmxlc3MnXSxcclxuICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnVzZS1ob3N0LXByb3BlcnR5LWRlY29yYXRvclxyXG4gICBob3N0OiB7XHJcbiAgICAnW2NsYXNzLnRpMy1kYXRlLXJhbmdlLWlucHV0LWNvbnRhaW5lcl0nOiAndHJ1ZScsXHJcbiAgICAnKGJsdXIpJzogJ2hpZGVQYW5lbCgpJ1xyXG59LFxyXG4gICBwcm92aWRlcnM6IFsgVGlGb3JtQ29tcG9uZW50LmdldFZhbHVlQWNjZXNzb3IoVGlEYXRlUmFuZ2VDb21wb25lbnQpXVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIFRpRGF0ZVJhbmdlQ29tcG9uZW50IGV4dGVuZHMgVGlEYXRlQmFzZUNvbXBvbmVudCB7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaXpeacn+aYvuekuuagvOW8jzogZGF0Zee7hOS7tueahGZvcm1hdOS4unN0cmluZ+exu+Wei1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZm9ybWF0OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOagh+iusGRhdGUvZGF0ZXRpbWXnmoTnsbvlnotcclxuICAgICAqL1xyXG4gICAgcHVibGljIGlzRGF0ZXRpbWU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog55So5LqO5qCH6K6w5piv5LiN5pivcmFuZ2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIGlzUmFuZ2U6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDkv53lrZhtb2RlbOWAvFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb2xkTW9kZWw6IFRpRGF0ZVZhbHVlID0ge1xyXG4gICAgICAgIGJlZ2luOiBudWxsLFxyXG4gICAgICAgIGVuZDogbnVsbFxyXG4gICAgfTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICogcGxhY2Vob2xkZXLmj5DnpLrmlofmnKxcclxuICAgICAqL1xyXG4gICAgcHVibGljIHBsYWNlaG9sZGVyOiBzdHJpbmcgPSBgJHtUaUxvY2FsZS5nZXRMb2NhbGVXb3JkcygpLnRpRGF0ZS5yYW5nZUJlZ2luTGFiZWx9IOKUgCAke1RpTG9jYWxlLmdldExvY2FsZVdvcmRzKCkudGlEYXRlLnJhbmdlRW5kTGFiZWx9YDtcclxuXHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIC8vIGZvcm1hdOaUr+aMgeWKqOaAgeWPmOabtFxyXG4gICAgICAgIGlmIChjaGFuZ2VzWydmb3JtYXQnXSAmJiAhY2hhbmdlc1snZm9ybWF0J10uZmlyc3RDaGFuZ2UpIHtcclxuICAgICAgICAgICAgLy8g5paw55qEZm9ybWF05piv6Z2e5rOV5pe277yMZm9ybWF05YC85L+d5oyB5LmL5YmN5YC85LiN5Y+YXHJcbiAgICAgICAgICAgIGlmICghVXRpbC5pc1N0cmluZyhjaGFuZ2VzWydmb3JtYXQnXS5jdXJyZW50VmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdCA9IGNoYW5nZXNbJ2Zvcm1hdCddLnByZXZpb3VzVmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmZvcm1hdFZhbHVlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDpqozor4HmnIDlpKflgLzmnIDlsI/lgLzvvIzkuLrkuoblpITnkIbmnIDlpKflgLzlkozmnIDlsI/lgLzku47lkIjms5Xml6XmnJ/lj5jkuLp1bmRlZmluZWQg55qE5oOF5pmvXHJcbiAgICAgICAgaWYgKChjaGFuZ2VzWydtYXgnXSAmJiAhY2hhbmdlc1snbWF4J10uZmlyc3RDaGFuZ2UpIHx8IChjaGFuZ2VzWydtaW4nXSAmJiAhY2hhbmdlc1snbWluJ10uZmlyc3RDaGFuZ2UpKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmFsaWRhdGVNaW5BbmRNYXgodGhpcy5jb25maWcsIHRoaXMuaXNEYXRldGltZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nRG9DaGVjaygpOiB2b2lkIHtcclxuICAgICAgICAvLyDnm5HlkKx2YWx1ZeWAvFxyXG4gICAgICAgIGlmICghVXRpbC5pc1VuZGVmaW5lZCh0aGlzLm1vZGVsKSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZFZhbHVlKHRoaXMubW9kZWwpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8g55uR5ZCsbW9kZWzlgLznmoTlj5jljJZcclxuICAgICAgICAgICAgdGhpcy5zZXRNb2RlbCh0aGlzLmlzRGF0ZXRpbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOWwhnZhbHVl6L2s5o2i5oiQZm9ybWF05o6l5Y+j5qC85byP55qE5a2X56ym5LiyXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBmb3JtYXRWYWx1ZSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5tb2RlbCA9PT0gbnVsbCB8fCAodGhpcy5tb2RlbC5iZWdpbiA9PT0gbnVsbCAmJiB0aGlzLm1vZGVsLmVuZCA9PT0gbnVsbCkpIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRWYWx1ZSA9ICcnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJlZ2luOiBzdHJpbmcgPSBUaUxvY2FsZUZvcm1hdC5mb3JtYXREYXRlKHRoaXMubW9kZWwuYmVnaW4sIHRoaXMuZm9ybWF0KTtcclxuICAgICAgICAgICAgY29uc3QgZW5kOiBzdHJpbmcgPSBUaUxvY2FsZUZvcm1hdC5mb3JtYXREYXRlKHRoaXMubW9kZWwuZW5kLCB0aGlzLmZvcm1hdCk7XHJcbiAgICAgICAgICAgIC8vIOazqOaEj++8muS4reWIkue6v+eUqOeahOaYr+WItuihqOespuS4reeahOS4reWIkue6v++8jOS4juato+W4uOeahOS4ree6v+WMuuWIhuW8gDIwMTctMi0xMiAtIDIwMTgtMy0yMFxyXG4gICAgICAgICAgICB0aGlzLmlucHV0VmFsdWUgPSBgJHtiZWdpbn0g4pSAICR7ZW5kfWA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIG9uS2V5ZG93bkZuKGV2ZW50OiBLZXlib2FyZEV2ZW50LCBwb3M6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSBUaUtleW1hcC5LRVlfRU5URVIgIHx8IGV2ZW50LmtleUNvZGUgPT09IFRpS2V5bWFwLktFWV9OVU1QQURfRU5URVIpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRlRWRpdEJsdXIocG9zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgZGF0ZUVkaXRCbHVyKHBvczogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgLy8g6L6T5YWl5YC86LaF5Ye65pyA5aSn5pyA5bCPIOiupOS4uumdnuazlVxyXG4gICAgICAgIGNvbnN0IHZhbHVlOiBhbnkgPSB0aGlzLmRhdGVQYW5lbC52YWx1ZTtcclxuICAgICAgICBpZiAoVGlEYXRlVXRpbC5pc0RhdGUodmFsdWUuYmVnaW4pICYmIFRpRGF0ZVV0aWwuaXNEYXRlKHZhbHVlLmVuZCkpIHtcclxuICAgICAgICAgICAgaWYgKFRpRGF0ZVV0aWwuaXNCaWdnZXIodmFsdWUuYmVnaW4sIHZhbHVlLmVuZCkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChwb3MgPT09ICdiZWdpbicpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGVQYW5lbC52YWx1ZS5iZWdpbiA9IHRoaXMub2xkQmVnaW5WYWx1ZSB8fCB0aGlzLm9sZE1vZGVsICYmIHRoaXMub2xkTW9kZWwuYmVnaW47XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0ZVBhbmVsLnZhbHVlLmVuZCA9IHRoaXMub2xkRW5kVmFsdWUgfHwgdGhpcy5vbGRNb2RlbCAmJiB0aGlzLm9sZE1vZGVsLmVuZDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLm9sZEJlZ2luVmFsdWUgPSB0aGlzLmRhdGVQYW5lbC52YWx1ZS5iZWdpbjtcclxuICAgICAgICAgICAgdGhpcy5vbGRFbmRWYWx1ZSA9IHRoaXMuZGF0ZVBhbmVsLnZhbHVlLmVuZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZXRPa0J0blN0YXRlKCk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOehruiupOaMiemSrlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb25Pa0NsaWNrKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmluVmFsaWRWYWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5kYXRlUGFuZWwgaW5zdGFuY2VvZiBPYmplY3QpIHtcclxuICAgICAgICAgICAgLy8g5paw5pen5YC85LiN5ZCM5pu05pawbW9kZWzlgLxcclxuICAgICAgICAgICAgaWYgKCF0aGlzLnJhbmdlVmFsdWVJc0VxdWFsKHRoaXMubW9kZWwsIHRoaXMuZGF0ZVBhbmVsWyd2YWx1ZSddLCB0aGlzLmlzRGF0ZXRpbWUpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1vZGVsID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGJlZ2luOiB0aGlzLmRhdGVQYW5lbFsndmFsdWUnXS5iZWdpbixcclxuICAgICAgICAgICAgICAgICAgICBlbmQ6IHRoaXMuZGF0ZVBhbmVsWyd2YWx1ZSddLmVuZFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5oaWRlRHJvcCgpO1xyXG5cclxuICAgICAgICB0aGlzLm9rQ2xpY2suZW1pdCh0aGlzLm1vZGVsKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaYr+WQpuS4uuemgeeUqOaXpeacn1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaXNEaXNhYmxlZERheXModmFsdWU6IERhdGUpOiBib29sZWFuIHtcclxuICAgICAgICBsZXQgaXNEaXNhYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgICAgIGlmIChVdGlsLmlzQXJyYXkodGhpcy5kaXNhYmxlZERheXMpICYmIHRoaXMuZGlzYWJsZWREYXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5kaXNhYmxlZERheXMuZm9yRWFjaCgoaXRlbTogRGF0ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0uZ2V0VGltZSgpID09PSB2YWx1ZS5nZXRUaW1lKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc0Rpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaXNEaXNhYmxlZDtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICogbW9kZWzlgLznmoTlkIjms5XmgKfliKTmlq1cclxuICAgICAqL1xyXG4gICAgcHVibGljIGlzVmFsaWRWYWx1ZSh2YWx1ZTogVGlEYXRlVmFsdWUpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5pc1ZhbGlkUmFuZ2UodmFsdWUpID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWIpOaWreaYr+S4jeaYr+WQiOazleiMg+WbtFxyXG4gICAgcHJpdmF0ZSBpc1ZhbGlkUmFuZ2UodmFsdWU6IFRpRGF0ZVZhbHVlKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBPYmplY3QpIHx8ICFUaURhdGVVdGlsLmlzRGF0ZSh2YWx1ZS5iZWdpbikgfHwgIVRpRGF0ZVV0aWwuaXNEYXRlKHZhbHVlLmVuZCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgc3RhcnREYXRlOiBEYXRlID0gbmV3IERhdGUodmFsdWUuYmVnaW4uZ2V0RnVsbFllYXIoKSwgdmFsdWUuYmVnaW4uZ2V0TW9udGgoKSwgdmFsdWUuYmVnaW4uZ2V0RGF0ZSgpKTtcclxuICAgICAgICBjb25zdCBlbmREYXRlOiBEYXRlID0gbmV3IERhdGUodmFsdWUuZW5kLmdldEZ1bGxZZWFyKCksIHZhbHVlLmVuZC5nZXRNb250aCgpLCB2YWx1ZS5lbmQuZ2V0RGF0ZSgpKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHN0YXJ0RGF0ZS5nZXRUaW1lKCkgPD0gZW5kRGF0ZS5nZXRUaW1lKCkgJiYgVGlEYXRlVXRpbC5pc0JldHdlZW5NYXhBbmRtaW4oc3RhcnREYXRlLCB0aGlzLm1pbiwgdGhpcy5tYXgpXHJcbiAgICAgICAgICAgICYmIFRpRGF0ZVV0aWwuaXNCZXR3ZWVuTWF4QW5kbWluKGVuZERhdGUsIHRoaXMubWluLCB0aGlzLm1heCk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOiuvue9ruehruiupOaMiemSrueahOeKtuaAgVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2V0T2tCdG5TdGF0ZSgpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBkYXRlOiBUaURhdGVWYWx1ZSA9IHRoaXMuZGF0ZVBhbmVsLnZhbHVlO1xyXG4gICAgICAgIGxldCBlbmRUaW1lOiBudW1iZXI7XHJcbiAgICAgICAgbGV0IGJlZ2luVGltZTogbnVtYmVyO1xyXG4gICAgICAgIGlmIChUaURhdGVVdGlsLmlzRGF0ZShkYXRlLmVuZCkpIHtcclxuICAgICAgICAgICAgZW5kVGltZSA9IG5ldyBEYXRlKGRhdGUuZW5kLmdldEZ1bGxZZWFyKCksIGRhdGUuZW5kLmdldE1vbnRoKCksIGRhdGUuZW5kLmdldERhdGUoKSkuZ2V0VGltZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoVGlEYXRlVXRpbC5pc0RhdGUoZGF0ZS5iZWdpbikpIHtcclxuICAgICAgICAgICAgYmVnaW5UaW1lID0gbmV3IERhdGUoZGF0ZS5iZWdpbi5nZXRGdWxsWWVhcigpLCBkYXRlLmJlZ2luLmdldE1vbnRoKCksIGRhdGUuYmVnaW4uZ2V0RGF0ZSgpKS5nZXRUaW1lKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGlzQmVnaW5TbWFsbG9yRXF1YWxFbmQ6IGJvb2xlYW4gPSB0aGlzLmlzQWxsb3dCZWdpbkVxdWFsRW5kID8gZW5kVGltZSA8IGJlZ2luVGltZSA6IGVuZFRpbWUgPD0gYmVnaW5UaW1lO1xyXG4gICAgICAgIHRoaXMuaW5WYWxpZFZhbHVlID0gIShkYXRlIGluc3RhbmNlb2YgT2JqZWN0KVxyXG4gICAgICAgICAgICB8fCAhVGlEYXRlVXRpbC5pc0RhdGUoZGF0ZS5iZWdpbilcclxuICAgICAgICAgICAgfHwgIVRpRGF0ZVV0aWwuaXNEYXRlKGRhdGUuZW5kKVxyXG4gICAgICAgICAgICB8fCBpc0JlZ2luU21hbGxvckVxdWFsRW5kO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5idXR0b25Db21zKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0QXR0cih0aGlzLmJ1dHRvbkNvbXMubGFzdC5uYXRpdmVFbGVtZW50LCAnZGlzYWJsZWQnLCB0aGlzLmluVmFsaWRWYWx1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0SW5wdXRTdHlsZSh0aGlzLmluVmFsaWRWYWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog6YWN572u5pe26Ze05pel5pyf6Z2i5p2/5o6l5Y+jXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZXRQaWNrZXJEYXRlKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOWBmua3seaLt+i0neeahOWOn+WboO+8muS4jeiuqW1vZGVs5ZKMZGF0ZVBhbmVs57uE5Lu25LitdmFsdWXlj4zlkJHnu5HlrprvvIxcclxuICAgICAgICAvLyDlm6DkuLrkuIvmi4npnaLmnb/kuK3ml6XmnJ/lj5jljJbml7bvvIzkuI3nq4vljbPmm7TmlrDliLDovpPlhaXmoYbkuK1cclxuICAgICAgICBsZXQgdmFsdWU6IFRpRGF0ZVZhbHVlO1xyXG4gICAgICAgIGlmICh0aGlzLm1vZGVsID09PSBudWxsIHx8IHRoaXMubW9kZWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgdmFsdWUgPSB7XHJcbiAgICAgICAgICAgICAgICBiZWdpbjogbnVsbCxcclxuICAgICAgICAgICAgICAgIGVuZDogbnVsbFxyXG4gICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2YWx1ZSA9IHtcclxuICAgICAgICAgICAgICAgIGJlZ2luOiB0aGlzLm1vZGVsLmJlZ2luLFxyXG4gICAgICAgICAgICAgICAgZW5kOiB0aGlzLm1vZGVsLmVuZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5kYXRlUGFuZWwgPSB7XHJcbiAgICAgICAgICAgIHZhbHVlLFxyXG4gICAgICAgICAgICBmb3JtYXQ6IHRoaXMuZm9ybWF0LFxyXG4gICAgICAgICAgICBtYXg6IHRoaXMubWF4LFxyXG4gICAgICAgICAgICBtaW46IHRoaXMubWluLFxyXG4gICAgICAgICAgICBwaWNrZXI6ICdkYXknLFxyXG4gICAgICAgICAgICBzZWxlY3Q6ICgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9iajogYW55ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLmRhdGVQYW5lbC52YWx1ZVt0aGlzLmZvY3VzZWRQb3NpdGlvbl0sXHJcbiAgICAgICAgICAgICAgICAgICAgZm9jdXNlZFBvc2l0aW9uOiB0aGlzLmZvY3VzZWRQb3NpdGlvblxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF5Q2xpY2suZW1pdChvYmopO1xyXG4gICAgICAgICAgICAgICAgLy8g5Yid5aeL5YyW6YCJ5oup57uT5p2f5LmL5ZCO77yM5aaC5p6c5byA5aeL5pyq6YCJ5oup77yM54Sm54K56L2s56e75Yiw5byA5aeL5pel5pyf57yW6L6R5qGGXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5mb2N1c2VkUG9zaXRpb24gPT09ICdlbmQnICYmIHRoaXMuZGF0ZVBhbmVsLnZhbHVlLmJlZ2luID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb2N1c2VkUG9zaXRpb24gPSAnYmVnaW4nO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0ZUVkaXRDb21zLmZpcnN0LmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VuZEZpeGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNlZFBvc2l0aW9uID0gJ2VuZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0ZUVkaXRDb21zLmxhc3QuZm9jdXMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldE9rQnRuU3RhdGUoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyDlpoLmnpzlj6rmmL7npLrlubRcclxuICAgICAgICBpZiAodGhpcy5mb3JtYXQuaW5kZXhPZignTScpID09PSAtMSAmJiB0aGlzLmZvcm1hdCAhPT0gJ21lZGl1bURhdGUnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0ZVBhbmVsWydwaWNrZXInXSA9ICdvbmx5WWVhcic7XHJcblxyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5mb3JtYXQuaW5kZXhPZignZCcpID09PSAtMSkgeyAgLy8g5aaC5p6c5Y+q5pi+56S65bm05pyIXHJcbiAgICAgICAgICAgIHRoaXMuZGF0ZVBhbmVsWydwaWNrZXInXSA9ICdvbmx5WWVhck1vbnRoJztcclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2V0T2tCdG5TdGF0ZSgpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==