import { Directive, ElementRef, Input, Renderer2 } from '@angular/core';
import { TiUploadUtil } from '../../services/upload/TiUploadUtil';
/**
 * 该指令适用于自定义上传场景，指令定义在input type='file'元素上，传入的是文件上传实例
 * 文件上传实例的生成，请参考[TiUploadService.create]{@link ../injectables/TiUploadService.html#create}
 *
 * 除自定义使用方式外，Tiny还提供了两种已进行设计的上传组件供业务使用，具体见[TiUploadComponent]{@link ../components/TiUploadComponent.html}
 *
 * <example-url>../tiny3demo/#/upload/upload-all</example-url>
 */
export class TiFileSelectDirective {
    constructor(hostElementRef, renderer) {
        this.hostElementRef = hostElementRef;
        this.renderer = renderer;
        this.nativeElement = this.hostElementRef.nativeElement;
        this.fileChangeEvent = this.renderer.listen(this.nativeElement, 'change', () => {
            if (!this.tiFileSelect) { // 配置的上传文件实例不存在情况下，不做后续处理
                return;
            }
            this.onFileChange(this.nativeElement); // 点选文件后的处理
        });
    }
    /**
     * @ignore
     * 选择文件后，根据浏览器差异进行处理
     */
    onFileChange(fileSel) {
        const uploadInst = this.tiFileSelect;
        const files = TiUploadUtil.isHTML5 ? fileSel.files : fileSel; // 获取文件信息
        const addedItems = uploadInst._addToQueue(files); // 文件选择队列
        if (TiUploadUtil.isHTML5) { // H5情况下，重置表单元素值，确保可重复选择文件
            this.nativeElement.value = '';
        }
        else { // 非H5情况下，确保文件下次可继续选择,分两种情况：1.已选文件有效情况下，,重新替换表单元素，确保文件点选元素不会随表单上传消失；
            // 2.文件未加入到队列（文件校验失败情况）情况下，重置点选表单，确保文件可重复选择（校验失败可能是文件队列长度不符，所以为确保用户体验，执行该操作）
            const isRemoveInput = (addedItems.length === 0); // 根据文件是否有效情况确定是否移除input
            this.replaceFileInput(fileSel, isRemoveInput);
        }
        // 自动上传情况下，进行文件上传
        if (uploadInst.config.autoUpload !== false && (addedItems.length !== 0)) {
            uploadInst.uploadItems(addedItems);
        }
    }
    /**
     * @ignore
     * 替换单个文件选择按钮，确保后续文件选择可继续点选
     * 当前文件选择框
     * 文件选择实例对象
     */
    replaceFileInput(fileSel, isRemoveInput) {
        // 清除当前文件输入框选择事件
        this.fileChangeEvent();
        // 新增input,并处理当前input
        const fileSelNew = fileSel.cloneNode(); // 文件元素克隆时,不会复用原有已选文件信息
        if (isRemoveInput) { // 文件选择无效情况下移除input，确保下次可正常选择
            fileSel.parentNode.appendChild(fileSelNew);
            fileSel.remove();
        }
        else {
            fileSel.style.display = 'none'; // 隐藏已选文件，确保点选框页面呈现的唯一性
            fileSel.parentNode.insertBefore(fileSelNew, fileSel.nextSibling); // 点选文件已放入文件队列中,替换新的文件选择按钮，确保下次点选生效
        }
        // 增加当前input事件
        this.fileChangeEvent = this.renderer.listen(fileSelNew, 'change', () => {
            this.onFileChange(fileSelNew);
        });
    }
}
TiFileSelectDirective.decorators = [
    { type: Directive, args: [{
                selector: '[tiFileSelect]'
            },] }
];
TiFileSelectDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
TiFileSelectDirective.propDecorators = {
    tiFileSelect: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlGaWxlU2VsZWN0RGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL2NvbXBvbmVudHMvdXBsb2FkL1RpRmlsZVNlbGVjdERpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXhFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUVsRTs7Ozs7OztHQU9HO0FBSUgsTUFBTSxPQUFPLHFCQUFxQjtJQU85QixZQUFvQixjQUEwQixFQUFVLFFBQW1CO1FBQXZELG1CQUFjLEdBQWQsY0FBYyxDQUFZO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUN2RSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDO1FBQ3ZELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFO1lBQzNFLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUseUJBQXlCO2dCQUMvQyxPQUFPO2FBQ1Y7WUFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFdBQVc7UUFDdEQsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0gsWUFBWSxDQUFDLE9BQVk7UUFDckIsTUFBTSxVQUFVLEdBQVEsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUMxQyxNQUFNLEtBQUssR0FBUSxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTO1FBQzVFLE1BQU0sVUFBVSxHQUFzQixVQUFVLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUztRQUM5RSxJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUUsRUFBRSwwQkFBMEI7WUFDbEQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1NBQ2pDO2FBQU0sRUFBRSxvRUFBb0U7WUFDekUsNEVBQTRFO1lBQzVFLE1BQU0sYUFBYSxHQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLHdCQUF3QjtZQUNsRixJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQ2pEO1FBRUQsaUJBQWlCO1FBQ2pCLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEtBQUssS0FBSyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsRUFBRTtZQUNyRSxVQUFVLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ3RDO0lBQ0wsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsZ0JBQWdCLENBQUMsT0FBWSxFQUFFLGFBQXNCO1FBQ2pELGdCQUFnQjtRQUNoQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFdkIscUJBQXFCO1FBQ3JCLE1BQU0sVUFBVSxHQUFRLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLHVCQUF1QjtRQUNwRSxJQUFJLGFBQWEsRUFBRSxFQUFFLDZCQUE2QjtZQUM5QyxPQUFPLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMzQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDcEI7YUFBTTtZQUNILE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLHVCQUF1QjtZQUN2RCxPQUFPLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsbUNBQW1DO1NBQ3hHO1FBRUQsY0FBYztRQUNkLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUU7WUFDbkUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7OztZQWpFSixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGdCQUFnQjthQUMzQjs7O1lBZG1CLFVBQVU7WUFBUyxTQUFTOzs7MkJBbUIzQyxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbnB1dCwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRpRmlsZUl0ZW0sIFRpVXBsb2FkUmVmIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvdXBsb2FkL1RpRmlsZUludGVyZmFjZSc7XHJcbmltcG9ydCB7IFRpVXBsb2FkVXRpbCB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3VwbG9hZC9UaVVwbG9hZFV0aWwnO1xyXG5cclxuLyoqXHJcbiAqIOivpeaMh+S7pOmAgueUqOS6juiHquWumuS5ieS4iuS8oOWcuuaZr++8jOaMh+S7pOWumuS5ieWcqGlucHV0IHR5cGU9J2ZpbGUn5YWD57Sg5LiK77yM5Lyg5YWl55qE5piv5paH5Lu25LiK5Lyg5a6e5L6LXHJcbiAqIOaWh+S7tuS4iuS8oOWunuS+i+eahOeUn+aIkO+8jOivt+WPguiAg1tUaVVwbG9hZFNlcnZpY2UuY3JlYXRlXXtAbGluayAuLi9pbmplY3RhYmxlcy9UaVVwbG9hZFNlcnZpY2UuaHRtbCNjcmVhdGV9XHJcbiAqXHJcbiAqIOmZpOiHquWumuS5ieS9v+eUqOaWueW8j+Wklu+8jFRpbnnov5jmj5DkvpvkuobkuKTnp43lt7Lov5vooYzorr7orqHnmoTkuIrkvKDnu4Tku7bkvpvkuJrliqHkvb/nlKjvvIzlhbfkvZPop4FbVGlVcGxvYWRDb21wb25lbnRde0BsaW5rIC4uL2NvbXBvbmVudHMvVGlVcGxvYWRDb21wb25lbnQuaHRtbH1cclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnkzZGVtby8jL3VwbG9hZC91cGxvYWQtYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW3RpRmlsZVNlbGVjdF0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUaUZpbGVTZWxlY3REaXJlY3RpdmUge1xyXG4gICAgLyoqXHJcbiAgICAgKiDmlofku7bkuIrkvKDlrp7kvotcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgdGlGaWxlU2VsZWN0OiBUaVVwbG9hZFJlZjtcclxuICAgIHByaXZhdGUgbmF0aXZlRWxlbWVudDogYW55O1xyXG4gICAgcHJpdmF0ZSBmaWxlQ2hhbmdlRXZlbnQ6IGFueTtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaG9zdEVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMikge1xyXG4gICAgICAgIHRoaXMubmF0aXZlRWxlbWVudCA9IHRoaXMuaG9zdEVsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcclxuICAgICAgICB0aGlzLmZpbGVDaGFuZ2VFdmVudCA9IHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMubmF0aXZlRWxlbWVudCwgJ2NoYW5nZScsICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLnRpRmlsZVNlbGVjdCkgeyAvLyDphY3nva7nmoTkuIrkvKDmlofku7blrp7kvovkuI3lrZjlnKjmg4XlhrXkuIvvvIzkuI3lgZrlkI7nu63lpITnkIZcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLm9uRmlsZUNoYW5nZSh0aGlzLm5hdGl2ZUVsZW1lbnQpOyAvLyDngrnpgInmlofku7blkI7nmoTlpITnkIZcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog6YCJ5oup5paH5Lu25ZCO77yM5qC55o2u5rWP6KeI5Zmo5beu5byC6L+b6KGM5aSE55CGXHJcbiAgICAgKi9cclxuICAgIG9uRmlsZUNoYW5nZShmaWxlU2VsOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB1cGxvYWRJbnN0OiBhbnkgPSB0aGlzLnRpRmlsZVNlbGVjdDtcclxuICAgICAgICBjb25zdCBmaWxlczogYW55ID0gVGlVcGxvYWRVdGlsLmlzSFRNTDUgPyBmaWxlU2VsLmZpbGVzIDogZmlsZVNlbDsgLy8g6I635Y+W5paH5Lu25L+h5oGvXHJcbiAgICAgICAgY29uc3QgYWRkZWRJdGVtczogQXJyYXk8VGlGaWxlSXRlbT4gPSB1cGxvYWRJbnN0Ll9hZGRUb1F1ZXVlKGZpbGVzKTsgLy8g5paH5Lu26YCJ5oup6Zif5YiXXHJcbiAgICAgICAgaWYgKFRpVXBsb2FkVXRpbC5pc0hUTUw1KSB7IC8vIEg15oOF5Ya15LiL77yM6YeN572u6KGo5Y2V5YWD57Sg5YC877yM56Gu5L+d5Y+v6YeN5aSN6YCJ5oup5paH5Lu2XHJcbiAgICAgICAgICAgIHRoaXMubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIOmdnkg15oOF5Ya15LiL77yM56Gu5L+d5paH5Lu25LiL5qyh5Y+v57un57ut6YCJ5oupLOWIhuS4pOenjeaDheWGte+8mjEu5bey6YCJ5paH5Lu25pyJ5pWI5oOF5Ya15LiL77yMLOmHjeaWsOabv+aNouihqOWNleWFg+e0oO+8jOehruS/neaWh+S7tueCuemAieWFg+e0oOS4jeS8mumaj+ihqOWNleS4iuS8oOa2iOWkse+8m1xyXG4gICAgICAgICAgICAvLyAyLuaWh+S7tuacquWKoOWFpeWIsOmYn+WIl++8iOaWh+S7tuagoemqjOWksei0peaDheWGte+8ieaDheWGteS4i++8jOmHjee9rueCuemAieihqOWNle+8jOehruS/neaWh+S7tuWPr+mHjeWkjemAieaLqe+8iOagoemqjOWksei0peWPr+iDveaYr+aWh+S7tumYn+WIl+mVv+W6puS4jeespu+8jOaJgOS7peS4uuehruS/neeUqOaIt+S9k+mqjO+8jOaJp+ihjOivpeaTjeS9nO+8iVxyXG4gICAgICAgICAgICBjb25zdCBpc1JlbW92ZUlucHV0OiBib29sZWFuID0gKGFkZGVkSXRlbXMubGVuZ3RoID09PSAwKTsgLy8g5qC55o2u5paH5Lu25piv5ZCm5pyJ5pWI5oOF5Ya156Gu5a6a5piv5ZCm56e76ZmkaW5wdXRcclxuICAgICAgICAgICAgdGhpcy5yZXBsYWNlRmlsZUlucHV0KGZpbGVTZWwsIGlzUmVtb3ZlSW5wdXQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g6Ieq5Yqo5LiK5Lyg5oOF5Ya15LiL77yM6L+b6KGM5paH5Lu25LiK5LygXHJcbiAgICAgICAgaWYgKHVwbG9hZEluc3QuY29uZmlnLmF1dG9VcGxvYWQgIT09IGZhbHNlICYmIChhZGRlZEl0ZW1zLmxlbmd0aCAhPT0gMCkpIHtcclxuICAgICAgICAgICAgdXBsb2FkSW5zdC51cGxvYWRJdGVtcyhhZGRlZEl0ZW1zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDmm7/mjaLljZXkuKrmlofku7bpgInmi6nmjInpkq7vvIznoa7kv53lkI7nu63mlofku7bpgInmi6nlj6/nu6fnu63ngrnpgIlcclxuICAgICAqIOW9k+WJjeaWh+S7tumAieaLqeahhlxyXG4gICAgICog5paH5Lu26YCJ5oup5a6e5L6L5a+56LGhXHJcbiAgICAgKi9cclxuICAgIHJlcGxhY2VGaWxlSW5wdXQoZmlsZVNlbDogYW55LCBpc1JlbW92ZUlucHV0OiBib29sZWFuKTogdm9pZCB7XHJcbiAgICAgICAgLy8g5riF6Zmk5b2T5YmN5paH5Lu26L6T5YWl5qGG6YCJ5oup5LqL5Lu2XHJcbiAgICAgICAgdGhpcy5maWxlQ2hhbmdlRXZlbnQoKTtcclxuXHJcbiAgICAgICAgLy8g5paw5aKeaW5wdXQs5bm25aSE55CG5b2T5YmNaW5wdXRcclxuICAgICAgICBjb25zdCBmaWxlU2VsTmV3OiBhbnkgPSBmaWxlU2VsLmNsb25lTm9kZSgpOyAvLyDmlofku7blhYPntKDlhYvpmobml7Ys5LiN5Lya5aSN55So5Y6f5pyJ5bey6YCJ5paH5Lu25L+h5oGvXHJcbiAgICAgICAgaWYgKGlzUmVtb3ZlSW5wdXQpIHsgLy8g5paH5Lu26YCJ5oup5peg5pWI5oOF5Ya15LiL56e76ZmkaW5wdXTvvIznoa7kv53kuIvmrKHlj6/mraPluLjpgInmi6lcclxuICAgICAgICAgICAgZmlsZVNlbC5wYXJlbnROb2RlLmFwcGVuZENoaWxkKGZpbGVTZWxOZXcpO1xyXG4gICAgICAgICAgICBmaWxlU2VsLnJlbW92ZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpbGVTZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgLy8g6ZqQ6JeP5bey6YCJ5paH5Lu277yM56Gu5L+d54K56YCJ5qGG6aG16Z2i5ZGI546w55qE5ZSv5LiA5oCnXHJcbiAgICAgICAgICAgIGZpbGVTZWwucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZmlsZVNlbE5ldywgZmlsZVNlbC5uZXh0U2libGluZyk7IC8vIOeCuemAieaWh+S7tuW3suaUvuWFpeaWh+S7tumYn+WIl+S4rSzmm7/mjaLmlrDnmoTmlofku7bpgInmi6nmjInpkq7vvIznoa7kv53kuIvmrKHngrnpgInnlJ/mlYhcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOWinuWKoOW9k+WJjWlucHV05LqL5Lu2XHJcbiAgICAgICAgdGhpcy5maWxlQ2hhbmdlRXZlbnQgPSB0aGlzLnJlbmRlcmVyLmxpc3RlbihmaWxlU2VsTmV3LCAnY2hhbmdlJywgKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm9uRmlsZUNoYW5nZShmaWxlU2VsTmV3KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG4iXX0=