import { Component, ElementRef, IterableDiffers, NgZone, Renderer2 } from '@angular/core';
import { TiDropsearchComponent } from '../dropsearch/TiDropsearchModule';
import { TiTableComponent } from './TiTableComponent';
/**
 * @ignore
 * TiColsToggleDrop 控制列动态隐藏/显示的下拉组件
 *
 */
export class TiColsToggleDropComponent extends TiDropsearchComponent {
    constructor(iterableDiffers, elementRef, renderer2, zone, table) {
        super(renderer2, elementRef, zone);
        this.iterableDiffers = iterableDiffers;
        this.table = table;
        this.dominatorSpace = TiColsToggleDropComponent.DOMINATOR_SPACE + 'px';
        this.columns = [];
        this.listLabelKey = 'title';
        this.optionsChangeInner = false;
        this.isDisabledFn = (item) => {
            return item.disabled === true || (item.show === undefined && item !== this.listCom.optionSelectAll);
        };
    }
    static trackByFn(index, item) {
        // 表格记忆show属性也需要跟踪
        return item.title + item.show;
    }
    ngOnInit() {
        super.ngOnInit();
        this.multiple = true; // 设置为多选。
        this.heightExcludeList = this.searchable ? TiColsToggleDropComponent.DROP_VERTICAL_PADDING +
            TiColsToggleDropComponent.SEARCHBOX_AREA_HEIGHT : TiColsToggleDropComponent.DROP_VERTICAL_PADDING;
        this.defaultListMaxHeight = this.searchable ? TiColsToggleDropComponent.LIST_WITH_SEARCHBOX_MAX_HEIGHT :
            TiColsToggleDropComponent.DEFAULT_LIST_MAX_HEIGHT;
        this.searchKeys = ['title'];
        this.columnsDiffer = this.iterableDiffers.find(this.options)
            .create(TiColsToggleDropComponent.trackByFn);
    }
    ngDoCheck() {
        super.ngDoCheck();
        const columnsDiffer = this.columnsDiffer.diff(this.options);
        if (columnsDiffer) {
            if (this.optionsChangeInner) {
                this.optionsChangeInner = false;
            }
            else {
                this.selectedColumns = this.options.filter((column) => {
                    return column.show === true || column.show === undefined;
                });
                this.columns = this.options.concat(); // 强制变化，不然colums.push的列不能出现在列表中，与自定义的noempty有关
            }
            // columns变化需要处理列固定
            if (this.table.fixedColumnInfo.hasFixedColumn) {
                // 需要延迟处理，columns变化时，组件渲染还未完成。
                // 但如果在ngAfterViewChecked处理，太频繁，影响性能。
                setTimeout(() => {
                    // 处理左侧列固定
                    this.table.updateFixedThLeftSubject.next();
                    this.table.updateFixedTdLeftSubject.next();
                    // 处理右侧列固定
                    const scrollLeft = this.table.fixedColumnInfo.container.scrollLeft;
                    const isRightColumnFloat = scrollLeft + this.table.fixedColumnInfo.container.clientWidth < this.table.fixedColumnInfo.container.scrollWidth;
                    this.table.containerScrollXChangeSubject.next({
                        scrollLeft,
                        isRightColumnFloat
                    });
                }, 0);
            }
        }
    }
    onSelect(option) {
        if (option === this.listCom.optionSelectAll) {
            this.options.forEach((item) => {
                if (!this.isDisabledFn(item)) {
                    item.show = this.selectedColumns.includes(item);
                }
            });
        }
        else {
            option.show = this.selectedColumns.includes(option);
        }
        this.optionsChangeInner = true;
        // 需要在父类select.emit之前，更改option内容
        super.onSelect(option);
        // TODO: 没有处理，用户主动改变绑定变量selectedColumns。应该在docheck里监听selectedColumns（this.model）
    }
    // 鼠标点击到搜索框外围的空白，会失焦导致面板关闭
    // 此处做特殊处理,当点击空白时通过阻止默认事件的方式处理
    onMousedownSearchBoxOuter(event) {
        if (event.target.tagName === 'INPUT') {
            return;
        }
        event.preventDefault();
    }
}
TiColsToggleDropComponent.DOMINATOR_SPACE = 4;
TiColsToggleDropComponent.DEFAULT_LIST_MAX_HEIGHT = 30 * 8 + 8;
TiColsToggleDropComponent.LIST_WITH_SEARCHBOX_MAX_HEIGHT = 30 * 7;
TiColsToggleDropComponent.SEARCHBOX_AREA_HEIGHT = 28 + 6 + 4; // 搜索框所占区域高度
TiColsToggleDropComponent.DROP_VERTICAL_PADDING = 4 + 4;
TiColsToggleDropComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-cols-toggle-drop',
                template: "<ti-drop class=\"ti3-cols-toggle-drop\"\r\n         [dominatorElem]=\"dominatorElem\"\r\n         [panelWidth]=\"panelWidth\"\r\n         [dominatorSpace]=\"dominatorSpace\"\r\n         panelAlign=\"right\"\r\n         (mousedown)=\"onMousedownSearchBoxOuter($event)\">\r\n    <div *ngIf=\"searchable\"\r\n         class=\"ti3-cols-toggle-searchbox-wrap\"\r\n         (mousedown)=\"onMousedownSearchBoxOuter($event)\">\r\n        <ti-searchbox-notsearch class=\"ti3-cols-toggle-searchbox\"\r\n                                [(ngModel)]=\"searchWord\"\r\n                                (ngModelChange)=\"searchWordChange($event)\"\r\n                                [id]=\"appendId('searchbox')\"></ti-searchbox-notsearch>\r\n    </div>\r\n    <ti-list [multiple]='multiple'\r\n             [options]='(searchable ? searchResult : columns) | tiColumns'\r\n             [labelKey]='listLabelKey'\r\n             [selectAll]='selectAll'\r\n             [(ngModel)]=\"selectedColumns\"\r\n             (select)=\"onSelect($event)\"\r\n             [isDisabledFn]=\"isDisabledFn\"\r\n             [noDataText]=\"noDataText\"\r\n             [id]=\"appendId('list')\"\r\n             tipPosition=\"left\"\r\n             style=\"display: block;\">\r\n    </ti-list>\r\n</ti-drop>",
                host: {
                    '[class.ti3-cols-toggle-drop-container]': 'true'
                }
            },] }
];
TiColsToggleDropComponent.ctorParameters = () => [
    { type: IterableDiffers },
    { type: ElementRef },
    { type: Renderer2 },
    { type: NgZone },
    { type: TiTableComponent }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlDb2xzVG9nZ2xlRHJvcENvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9jb21wb25lbnRzL3RhYmxlL1RpQ29sc1RvZ2dsZURyb3BDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxVQUFVLEVBR1YsZUFBZSxFQUNmLE1BQU0sRUFDTixTQUFTLEVBQ1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDekUsT0FBTyxFQUFrQixnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXRFOzs7O0dBSUc7QUFRSCxNQUFNLE9BQU8seUJBQTBCLFNBQVEscUJBQXFCO0lBWWhFLFlBQW9CLGVBQWdDLEVBQUUsVUFBc0IsRUFDaEUsU0FBb0IsRUFBRSxJQUFZLEVBQVUsS0FBdUI7UUFDdkUsS0FBSyxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFGdkIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ0ksVUFBSyxHQUFMLEtBQUssQ0FBa0I7UUFQeEUsbUJBQWMsR0FBVyx5QkFBeUIsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBQzFFLFlBQU8sR0FBMEIsRUFBRSxDQUFDO1FBRTNCLGlCQUFZLEdBQVcsT0FBTyxDQUFDO1FBRXZDLHVCQUFrQixHQUFZLEtBQUssQ0FBQztRQXlFckMsaUJBQVksR0FBRyxDQUFDLElBQTBDLEVBQVcsRUFBRTtZQUMxRSxPQUFPLElBQUksQ0FBQyxRQUFRLEtBQUssSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxTQUFTLElBQUksSUFBSSxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDeEcsQ0FBQyxDQUFBO0lBdkVELENBQUM7SUFFTyxNQUFNLENBQUMs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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgQ29tcG9uZW50LFxyXG4gICAgRWxlbWVudFJlZixcclxuICAgIEl0ZXJhYmxlQ2hhbmdlcyxcclxuICAgIEl0ZXJhYmxlRGlmZmVyLFxyXG4gICAgSXRlcmFibGVEaWZmZXJzLFxyXG4gICAgTmdab25lLFxyXG4gICAgUmVuZGVyZXIyXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRpRHJvcHNlYXJjaENvbXBvbmVudCB9IGZyb20gJy4uL2Ryb3BzZWFyY2gvVGlEcm9wc2VhcmNoTW9kdWxlJztcclxuaW1wb3J0IHsgVGlUYWJsZUNvbHVtbnMsIFRpVGFibGVDb21wb25lbnQgfSBmcm9tICcuL1RpVGFibGVDb21wb25lbnQnO1xyXG5cclxuLyoqXHJcbiAqIEBpZ25vcmVcclxuICogVGlDb2xzVG9nZ2xlRHJvcCDmjqfliLbliJfliqjmgIHpmpDol48v5pi+56S655qE5LiL5ouJ57uE5Lu2XHJcbiAqXHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAndGktY29scy10b2dnbGUtZHJvcCcsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vY29scy10b2dnbGUtZHJvcC5odG1sJyxcclxuICAgIGhvc3Q6IHtcclxuICAgICAgICAnW2NsYXNzLnRpMy1jb2xzLXRvZ2dsZS1kcm9wLWNvbnRhaW5lcl0nOiAndHJ1ZSdcclxuICAgIH1cclxufSlcclxuZXhwb3J0IGNsYXNzIFRpQ29sc1RvZ2dsZURyb3BDb21wb25lbnQgZXh0ZW5kcyBUaURyb3BzZWFyY2hDb21wb25lbnQge1xyXG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBET01JTkFUT1JfU1BBQ0U6IG51bWJlciA9IDQ7XHJcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfTElTVF9NQVhfSEVJR0hUOiBudW1iZXIgPSAzMCAqIDggKyA4O1xyXG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBMSVNUX1dJVEhfU0VBUkNIQk9YX01BWF9IRUlHSFQ6IG51bWJlciA9IDMwICogNztcclxuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgU0VBUkNIQk9YX0FSRUFfSEVJR0hUOiBudW1iZXIgPSAyOCArIDYgKyA0OyAvLyDmkJzntKLmoYbmiYDljaDljLrln5/pq5jluqZcclxuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgRFJPUF9WRVJUSUNBTF9QQURESU5HOiBudW1iZXIgPSA0ICsgNDtcclxuICAgIHB1YmxpYyBkb21pbmF0b3JTcGFjZTogc3RyaW5nID0gVGlDb2xzVG9nZ2xlRHJvcENvbXBvbmVudC5ET01JTkFUT1JfU1BBQ0UgKyAncHgnO1xyXG4gICAgcHVibGljIGNvbHVtbnM6IEFycmF5PFRpVGFibGVDb2x1bW5zPiA9IFtdO1xyXG4gICAgcHVibGljIHNlbGVjdGVkQ29sdW1uczogQXJyYXk8VGlUYWJsZUNvbHVtbnM+OyAvLyBUT0RPOiDlj6/ku6XkuI3lrprkuYnmraTlj5jph4/vvIznlKh0aGlzLm1vZGVs5p2l5Luj5pu/XHJcbiAgICBwdWJsaWMgcmVhZG9ubHkgbGlzdExhYmVsS2V5OiBzdHJpbmcgPSAndGl0bGUnO1xyXG4gICAgcHJpdmF0ZSBjb2x1bW5zRGlmZmVyOiBJdGVyYWJsZURpZmZlcjxUaVRhYmxlQ29sdW1ucz47XHJcbiAgICBwcml2YXRlIG9wdGlvbnNDaGFuZ2VJbm5lcjogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpdGVyYWJsZURpZmZlcnM6IEl0ZXJhYmxlRGlmZmVycywgZWxlbWVudFJlZjogRWxlbWVudFJlZixcclxuICAgICAgICAgICAgICAgIHJlbmRlcmVyMjogUmVuZGVyZXIyLCB6b25lOiBOZ1pvbmUsIHByaXZhdGUgdGFibGU6IFRpVGFibGVDb21wb25lbnQpIHtcclxuICAgICAgICAgICAgc3VwZXIocmVuZGVyZXIyLCBlbGVtZW50UmVmLCB6b25lKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyB0cmFja0J5Rm4oaW5kZXg6IG51bWJlciwgaXRlbTogYW55KTogc3RyaW5nIHtcclxuICAgICAgICAvLyDooajmoLzorrDlv4ZzaG935bGe5oCn5Lmf6ZyA6KaB6Lef6LiqXHJcbiAgICAgICAgcmV0dXJuIGl0ZW0udGl0bGUgKyBpdGVtLnNob3c7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgICAgICB0aGlzLm11bHRpcGxlID0gdHJ1ZTsgLy8g6K6+572u5Li65aSa6YCJ44CCXHJcbiAgICAgICAgdGhpcy5oZWlnaHRFeGNsdWRlTGlzdCA9IHRoaXMuc2VhcmNoYWJsZSA/IFRpQ29sc1RvZ2dsZURyb3BDb21wb25lbnQuRFJPUF9WRVJUSUNBTF9QQURESU5HICtcclxuICAgICAgICAgICAgVGlDb2xzVG9nZ2xlRHJvcENvbXBvbmVudC5TRUFSQ0hCT1hfQVJFQV9IRUlHSFQgOiBUaUNvbHNUb2dnbGVEcm9wQ29tcG9uZW50LkRST1BfVkVSVElDQUxfUEFERElORztcclxuICAgICAgICB0aGlzLmRlZmF1bHRMaXN0TWF4SGVpZ2h0ID0gdGhpcy5zZWFyY2hhYmxlID8gVGlDb2xzVG9nZ2xlRHJvcENvbXBvbmVudC5MSVNUX1dJVEhfU0VBUkNIQk9YX01BWF9IRUlHSFQgOlxyXG4gICAgICAgICAgICBUaUNvbHNUb2dnbGVEcm9wQ29tcG9uZW50LkRFRkFVTFRfTElTVF9NQVhfSEVJR0hUO1xyXG4gICAgICAgIHRoaXMuc2VhcmNoS2V5cyA9IFsndGl0bGUnXTtcclxuICAgICAgICB0aGlzLmNvbHVtbnNEaWZmZXIgPSB0aGlzLml0ZXJhYmxlRGlmZmVycy5maW5kKHRoaXMub3B0aW9ucylcclxuICAgICAgICAgICAgLmNyZWF0ZShUaUNvbHNUb2dnbGVEcm9wQ29tcG9uZW50LnRyYWNrQnlGbik7XHJcbiAgICB9XHJcblxyXG4gICAgbmdEb0NoZWNrKCk6IHZvaWQgeyAvLyDliqjmgIHnm5HlkKxjb2x1bW5z55qE5Y+Y5YyWKOS4u+imgeaYr+W8leeUqOS4jeWPmO+8jOWGheWuueWPmOWMlmNvbHVtcy5wdXNo562JKe+8jOaYr+WQpumcgOimgSxub2VtcHR5IOacieW9seWTjSjmlbDmja7lvJXnlKjlj5jkuobmiY3kvJrov5twaXBlKVxyXG4gICAgICAgIHN1cGVyLm5nRG9DaGVjaygpO1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbnNEaWZmZXI6IEl0ZXJhYmxlQ2hhbmdlczxUaVRhYmxlQ29sdW1ucz4gPSB0aGlzLmNvbHVtbnNEaWZmZXIuZGlmZih0aGlzLm9wdGlvbnMpO1xyXG4gICAgICAgIGlmIChjb2x1bW5zRGlmZmVyKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnNDaGFuZ2VJbm5lcikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zQ2hhbmdlSW5uZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRDb2x1bW5zID0gdGhpcy5vcHRpb25zLmZpbHRlcigoY29sdW1uOiB7IHNob3c/OiBib29sZWFuIH0pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29sdW1uLnNob3cgPT09IHRydWUgfHwgY29sdW1uLnNob3cgPT09IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2x1bW5zID0gdGhpcy5vcHRpb25zLmNvbmNhdCgpOyAvLyDlvLrliLblj5jljJbvvIzkuI3nhLZjb2x1bXMucHVzaOeahOWIl+S4jeiDveWHuueOsOWcqOWIl+ihqOS4re+8jOS4juiHquWumuS5ieeahG5vZW1wdHnmnInlhbNcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gY29sdW1uc+WPmOWMlumcgOimgeWkhOeQhuWIl+WbuuWumlxyXG4gICAgICAgICAgICBpZih0aGlzLnRhYmxlLmZpeGVkQ29sdW1uSW5mby5oYXNGaXhlZENvbHVtbikge1xyXG4gICAgICAgICAgICAgICAgLy8g6ZyA6KaB5bu26L+f5aSE55CG77yMY29sdW1uc+WPmOWMluaXtu+8jOe7hOS7tua4suafk+i/mOacquWujOaIkOOAglxyXG4gICAgICAgICAgICAgICAgLy8g5L2G5aaC5p6c5ZyobmdBZnRlclZpZXdDaGVja2Vk5aSE55CG77yM5aSq6aKR57mB77yM5b2x5ZON5oCn6IO944CCXHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDlpITnkIblt6bkvqfliJflm7rlrppcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRhYmxlLnVwZGF0ZUZpeGVkVGhMZWZ0U3ViamVjdC5uZXh0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJsZS51cGRhdGVGaXhlZFRkTGVmdFN1YmplY3QubmV4dCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWkhOeQhuWPs+S+p+WIl+WbuuWumlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjcm9sbExlZnQ6IG51bWJlciA9IHRoaXMudGFibGUuZml4ZWRDb2x1bW5JbmZvLmNvbnRhaW5lci5zY3JvbGxMZWZ0O1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUmlnaHRDb2x1bW5GbG9hdDogYm9vbGVhbiA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbExlZnQgKyB0aGlzLnRhYmxlLmZpeGVkQ29sdW1uSW5mby5jb250YWluZXIuY2xpZW50V2lkdGggPCB0aGlzLnRhYmxlLmZpeGVkQ29sdW1uSW5mby5jb250YWluZXIuc2Nyb2xsV2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJsZS5jb250YWluZXJTY3JvbGxYQ2hhbmdlU3ViamVjdC5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNSaWdodENvbHVtbkZsb2F0XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgb25TZWxlY3Qob3B0aW9uOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICBpZiAob3B0aW9uID09PSB0aGlzLmxpc3RDb20ub3B0aW9uU2VsZWN0QWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5mb3JFYWNoKChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkRm4oaXRlbSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtLnNob3cgPSB0aGlzLnNlbGVjdGVkQ29sdW1ucy5pbmNsdWRlcyhpdGVtKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgb3B0aW9uLnNob3cgPSB0aGlzLnNlbGVjdGVkQ29sdW1ucy5pbmNsdWRlcyhvcHRpb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm9wdGlvbnNDaGFuZ2VJbm5lciA9IHRydWU7XHJcbiAgICAgICAgLy8g6ZyA6KaB5Zyo54i257G7c2VsZWN0LmVtaXTkuYvliY3vvIzmm7TmlLlvcHRpb27lhoXlrrlcclxuICAgICAgICBzdXBlci5vblNlbGVjdChvcHRpb24pO1xyXG4gICAgICAgIC8vIFRPRE86IOayoeacieWkhOeQhu+8jOeUqOaIt+S4u+WKqOaUueWPmOe7keWumuWPmOmHj3NlbGVjdGVkQ29sdW1uc+OAguW6lOivpeWcqGRvY2hlY2vph4znm5HlkKxzZWxlY3RlZENvbHVtbnPvvIh0aGlzLm1vZGVs77yJXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGlzRGlzYWJsZWRGbiA9IChpdGVtOiB7ZGlzYWJsZWQ/OiBib29sZWFuLCBzaG93PzogYm9vbGVhbn0pOiBib29sZWFuID0+IHtcclxuICAgICAgICByZXR1cm4gaXRlbS5kaXNhYmxlZCA9PT0gdHJ1ZSB8fCAoaXRlbS5zaG93ID09PSB1bmRlZmluZWQgJiYgaXRlbSAhPT0gdGhpcy5saXN0Q29tLm9wdGlvblNlbGVjdEFsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6byg5qCH54K55Ye75Yiw5pCc57Si5qGG5aSW5Zu055qE56m655m977yM5Lya5aSx54Sm5a+86Ie06Z2i5p2/5YWz6ZetXHJcbiAgICAvLyDmraTlpITlgZrnibnmrorlpITnkIYs5b2T54K55Ye756m655m95pe26YCa6L+H6Zi75q2i6buY6K6k5LqL5Lu255qE5pa55byP5aSE55CGXHJcbiAgICBwdWJsaWMgb25Nb3VzZWRvd25TZWFyY2hCb3hPdXRlcihldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGlmICgoZXZlbnQudGFyZ2V0IGFzIGFueSkudGFnTmFtZSA9PT0gJ0lOUFVUJykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICB9XHJcbn1cclxuIl19