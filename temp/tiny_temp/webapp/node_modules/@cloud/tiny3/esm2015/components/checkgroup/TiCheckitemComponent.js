import { Component, ElementRef, HostListener, Input, IterableDiffers, Renderer2 } from '@angular/core';
import { TiCheckboxComponent } from '../checkbox/TiCheckboxModule';
import { ObservableMap, ObservableSet, Util } from '../../utils/Util';
/**
 * Checkitem多选选项组件，尽管这是一个组件，使用时像属性指令。
 *
 */
export class TiCheckitemComponent extends TiCheckboxComponent {
    constructor(hostRef, renderer, iterableDiffers) {
        // 是因为group item两个子类都用到differs，所以放在父类这里。
        super(hostRef, renderer);
        this.hostRef = hostRef;
        this.renderer = renderer;
        this.iterableDiffers = iterableDiffers;
        this.globeCheckedMapObserverItemFn = (item, value, isAdd, from) => {
            if (from !== this && item === this.item && isAdd) {
                // 从全局同步过来的，可能是半选
                const lastChecked = this.nativeElement.checked;
                const lastIndeterminate = (this.nativeElement.indeterminate === true) ? true : false; // 将undefined也转为false。
                this.nativeElement.checked = (value === true);
                this.nativeElement.indeterminate = (value === null);
                if (this.nativeElement.checked !== lastChecked || this.nativeElement.indeterminate !== lastIndeterminate) {
                    Util.trigger(this.nativeElement, 'change'); // 必须主动触发change事件，否则ngModel不更新。
                }
            }
        };
    }
    /**
     * @ignore
     * 监听change事件，会多触发一次DoCheck。 //TODO: 不让这条HostListener('change', ['$event'])在文档显示
     * @param checked
     * @returns
     */
    onHostChange(checked) {
        // item checked同步到globeCheckedSet
        if (!this.item) {
            return;
        }
        this.nativeElement.checked ?
            TiCheckitemComponent.globeCheckedMap.set(this.item, true, this) :
            this.nativeElement.indeterminate ?
                TiCheckitemComponent.globeCheckedMap.set(this.item, null, this) :
                TiCheckitemComponent.globeCheckedMap.set(this.item, false, this);
        // item checked同步到beCheckedSet
        if (this.beCheckedSet) {
            const value = this.getValue(this.item);
            this.nativeElement.checked ? this.beCheckedSet.add(value) : this.beCheckedSet.delete(value);
        }
    }
    ngOnInit() {
        super.ngOnInit();
        this.initBeCheckedSet();
        if (!this.item) { // 用户忘了设定，或者继承的子类无需设定
            return;
        }
        this.initGlobeCheckedSetItem();
        this.setCheckedItem();
    }
    ngOnChanges(changes) {
        super.ngOnChanges(changes);
        // 外部直接给item重新赋值了。
        if (changes['item'] && !changes['item'].isFirstChange()) {
            // 删除已使用的静态资源。当然，这里有可能误删除。因为此item还在别处使用。   全选按钮那里，有纠正机制。
            this.deleteGlobeRef(changes['item'].previousValue);
            // 添加新的资源
            this.setCheckedItem();
            // 重新设置disabled
            this.setDisabledStateGlobe();
        }
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        // 删除已使用的静态资源
        this.deleteGlobeRef(this.item);
        // 解除监听
        TiCheckitemComponent.globeCheckedMap.removeObserver(this.globeCheckedMapObserverItemFn);
    }
    // 删除已使用的静态资源
    deleteGlobeRef(item) {
        TiCheckitemComponent.globeCheckedMap.delete(this.item);
        TiCheckitemComponent.globeDisabledSet.delete(this.item);
    }
    ngDoCheck() {
        super.ngDoCheck();
        if (!this.beCheckedSet) {
            return;
        }
        const beCheckedsChanges = this.beCheckedsDiffer.diff(this.beCheckeds);
        if (beCheckedsChanges) { // beCheckeds同步到beCheckedSet
            beCheckedsChanges.forEachAddedItem(record => {
                this.beCheckedSet.add(record.item);
            });
            beCheckedsChanges.forEachRemovedItem(record => {
                this.beCheckedSet.delete(record.item);
            });
        }
    }
    initBeCheckedSet() {
        if (!this.beCheckeds) {
            return;
        }
        this.beCheckedsDiffer = this.iterableDiffers.find(this.beCheckeds).create(null);
        this.beCheckedSet = new ObservableSet(this.beCheckeds); // TODO:写共用的Array/Set转Set
        this.beCheckedSet.addObserver((item, isAdd) => {
            // beCheckedSet的变化同步到beCheckeds
            if (this.beCheckeds instanceof Set) {
                isAdd ? this.beCheckeds.add(item) : this.beCheckeds.delete(item);
            }
            else if (this.beCheckeds instanceof Array) { // TODO:写公用的Array remove函数
                const index = this.beCheckeds.indexOf(item);
                if (isAdd && index === -1) {
                    this.beCheckeds.push(item);
                }
                else if (!isAdd && index !== -1) {
                    this.beCheckeds.splice(index, 1);
                }
            }
            // checkedSet通知到item checked
            this.setCheckedItem();
        });
    }
    /**
     * globeCheckedSet同步到item checked
     */
    initGlobeCheckedSetItem() {
        // 初始化时，不往globeCheckedSet放值，是因为group优先级更高。
        TiCheckitemComponent.globeCheckedMap.addObserver(this.globeCheckedMapObserverItemFn);
    }
    setCheckedItem() {
        if (!this.item) {
            return;
        }
        const lastChecked = this.nativeElement.checked;
        const value = this.getValue(this.item);
        // 如果beCheckeds存在，优先级更高，以beCheckeds为准。
        this.nativeElement.checked = this.beCheckedSet ? this.beCheckedSet.has(value) : TiCheckitemComponent.globeCheckedMap.get(this.item);
        // 这里应该不用考虑半选吧？
        if (this.nativeElement.checked !== lastChecked) {
            Util.trigger(this.nativeElement, 'change'); // 必须主动触发change事件，否则ngModel不更新。
        }
    }
    /**
     * @ignore
     */
    setDisabledState(isDisabled) {
        super.setDisabledState(isDisabled);
        this.setDisabledStateGlobe();
    }
    setDisabledStateGlobe() {
        this.nativeElement.disabled ? TiCheckitemComponent.globeDisabledSet.add(this.item)
            : TiCheckitemComponent.globeDisabledSet.delete(this.item);
    }
    /**
     * 输入：某个数据项
     * 输出：当有valueKey,返回值基于valueKey；当没有valueKey时，返回输入值
     */
    getValue(item) {
        return this.valueKey ? item[this.valueKey] : item;
    }
}
/**
 * @ignore
 * 全局item数据(多个group的item都在这里)
 */
TiCheckitemComponent.globeCheckedMap = new ObservableMap();
/**
 * @ignore
 * 全局灰化禁用数据(多个group的item都在这里)
 */
TiCheckitemComponent.globeDisabledSet = new ObservableSet();
TiCheckitemComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line:component-selector
                selector: '[tiCheckitem]',
                template: "<!--Tiny3\u4F18\u5316\uFF1A\u51CF\u5C11label\u5D4C\u5957\uFF0C\u53BB\u9664\u5185\u5C42label-->\r\n<label #labelRef class='ti3-checkbox' [for]='id'  [id]=\"appendId('checkbox')\">\r\n    <!-- \u517C\u5BB9IE11\u6DFB\u52A0spacebar\u4E8B\u4EF6 -->\r\n    <span #proxyRef class='ti3-checkbox-skin ti3-icon ti3-icon-checkmark' tiOutline\r\n        (keydown.spacebar)=\"onSpaceKeydown($event)\"  (keyup.spacebar)=\"onSpaceKeyup($event)\"\r\n        (keydown.space)=\"onSpaceKeydown($event)\"  (keyup.space)=\"onSpaceKeyup($event)\"></span>\r\n    <span class='ti3-checkbox-label' [id]=\"appendId('label')\">{{label}}</span>\r\n</label>",
                // tslint:disable-next-line:use-host-property-decorator
                host: {
                    'tiCheckbox': '' // 给宿主元素添加tiCheckbox属性，实现定制样式
                },
                styles: [":hostinput[type=checkbox][tiCheckbox]{display:none!important}:hostinput[type=checkbox][tiCheckbox]+.ti3-checkbox{-ms-box-sizing:border-box;-ms-user-select:none;-webkit-user-select:none;box-sizing:border-box;cursor:pointer;display:inline-block;font-weight:400;line-height:1em;margin-bottom:0;user-select:none;vertical-align:middle}:hostinput[type=checkbox][tiCheckbox]+.ti3-checkbox .ti3-checkbox-skin{-ms-box-sizing:border-box;background-color:var(--ti-checkbox-bg-color);border:1px solid var(--ti-checkbox-border-color);border-collapse:separate;border-radius:2px;box-sizing:border-box;color:transparent;display:inline-block;height:var(--ti-checkbox-size);line-height:var(--ti-checkbox-mark-size);margin-bottom:0;margin-right:var(--ti-checkbox-label-right-space);position:relative;text-align:center;transition:background-color .15s,border-color .15s;vertical-align:middle;width:var(--ti-checkbox-size)}:hostinput[type=checkbox][tiCheckbox]+.ti3-checkbox .ti3-checkbox-label{-ms-user-select:none;-webkit-user-select:none;color:var(--ti-checkbox-label-color);display:inline;margin-bottom:0;user-select:none;vertical-align:middle}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):checked+.ti3-checkbox .ti3-checkbox-skin{background-color:var(--ti-checkbox-bg-color-checked);border-color:var(--ti-checkbox-border-color-checked);color:var(--ti-checkbox-label-color-checked)}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):checked+.ti3-checkbox .ti3-checkbox-skin:focus,:hostinput[type=checkbox][tiCheckbox]:not([disabled]):checked+.ti3-checkbox .ti3-checkbox-skin:hover{background-color:var(--ti-checkbox-bg-color-checked-hover);border-color:var(--ti-checkbox-bg-color-checked-hover)}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):checked+.ti3-checkbox .ti3-checkbox-skin:active{background-color:var(--ti-checkbox-bg-color-checked-active);border-color:var(--ti-checkbox-bg-color-checked-active)}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):not(:checked)+.ti3-checkbox .ti3-checkbox-skin:focus,:hostinput[type=checkbox][tiCheckbox]:not([disabled]):not(:checked)+.ti3-checkbox .ti3-checkbox-skin:hover{border-color:var(--ti-checkbox-border-color-hover)}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):not(:checked)+.ti3-checkbox .ti3-checkbox-skin:active{background-color:var(--ti-checkbox-bg-color-unchecked-active);border-color:var(--ti-checkbox-border-color-unchecked-active)}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):indeterminate+.ti3-checkbox .ti3-checkbox-skin{background-color:var(--ti-checkbox-partial-color-checked);border-color:var(--ti-checkbox-partial-color-checked)}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):indeterminate+.ti3-checkbox .ti3-checkbox-skin:before{background-color:var(--ti-checkbox-label-color-checked)}:hostinput[type=checkbox][tiCheckbox]:not([disabled]):indeterminate+.ti3-checkbox .ti3-checkbox-skin:hover{background-color:var(--ti-checkbox-partial-color-checked-hover);border-color:var(--ti-checkbox-partial-color-checked-hover)}:hostinput[type=checkbox][tiCheckbox][disabled]+.ti3-checkbox{cursor:not-allowed}:hostinput[type=checkbox][tiCheckbox][disabled]+.ti3-checkbox .ti3-checkbox-skin{background-color:var(--ti-checkbox-label-color-checked);outline:none}:hostinput[type=checkbox][tiCheckbox][disabled]+.ti3-checkbox .ti3-checkbox-label{color:var(--ti-checkbox-label-color-disabled)}:hostinput[type=checkbox][tiCheckbox][disabled]:checked+.ti3-checkbox .ti3-checkbox-skin{background-color:var(--ti-checkbox-bg-color-disable);border-color:var(--ti-checkbox-border-color-checked-disabled);color:var(--ti-checkbox-mark-color-disabled)}:hostinput[type=checkbox][tiCheckbox][disabled]:not(:checked)+.ti3-checkbox .ti3-checkbox-skin{background-color:var(--ti-checkbox-bg-color-disable);border-color:var(--ti-checkbox-border-color-unchecked-disabled);color:transparent}:hostinput[type=checkbox][tiCheckbox][disabled]:indeterminate+.ti3-checkbox .ti3-checkbox-skin:before{background-color:var(--ti-checkbox-partial-color-checked-disabled)}:hostinput[type=checkbox][tiCheckbox]:checked+.ti3-checkbox .ti3-checkbox-skin:before{-ms-box-sizing:border-box;border-style:solid;border-width:0 2px 2px 0;box-sizing:border-box;content:\" \";display:table;height:9px;left:21%;position:absolute;top:50%;transform:rotate(45deg) translate(-55%,-55%) scale(1);width:7px}:hostinput[type=checkbox][tiCheckbox]:indeterminate+.ti3-checkbox .ti3-checkbox-skin:before{border-radius:1px;content:\"\";height:var(--ti-checkbox-partial-center-size);left:4px;position:absolute;top:4px;width:var(--ti-checkbox-partial-center-size)}@keyframes rect-selectedAnimate{0%{transform:scale(0);transform-origin:center}to{color:var(--ti-checkbox-label-color-checked);transform:scale(1);transform-origin:center}}@keyframes tick-selectedAnimate{0%{transform:rotate(45deg) translate(-55%,-55%) scale(0);transform-origin:center}to{color:var(--ti-checkbox-label-color-checked);transform:rotate(45deg) translate(-55%,-55%) scale(1);transform-origin:center}}input[type=checkbox][tiCheckbox]:not(:disabled):checked+.ti3-checkbox .ti3-icon-checkmark:before{animation:tick-selectedAnimate .2s var(--ti-timing-function-default) forwards}input[type=checkbox][tiCheckbox]:not(:disabled):indeterminate+.ti3-checkbox .ti3-icon-checkmark:before{animation:rect-selectedAnimate .2s var(--ti-timing-function-default) forwards}input[type=checkbox][tiCheckbox]:not(:disabled):checked+.ti3-checkbox .ti3-checkbox-skin:hover{transition:border-color .2s var(--ti-timing-function-default),background-color .2s var(--ti-timing-function-default)}"]
            },] }
];
TiCheckitemComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: IterableDiffers }
];
TiCheckitemComponent.propDecorators = {
    item: [{ type: Input }],
    valueKey: [{ type: Input }],
    beCheckeds: [{ type: Input }],
    onHostChange: [{ type: HostListener, args: ['change', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlDaGVja2l0ZW1Db21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueTMvY29tcG9uZW50cy9jaGVja2dyb3VwL1RpQ2hlY2tpdGVtQ29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQWtCLGVBQWUsRUFDL0UsU0FBUyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUV0RTs7O0dBR0c7QUFXSCxNQUFNLE9BQU8sb0JBQXFCLFNBQVEsbUJBQW1CO0lBMkJ6RCxZQUFzQixPQUFtQixFQUFZLFFBQW1CLEVBQVksZUFBZ0M7UUFDaEgsd0NBQXdDO1FBQ3hDLEtBQUssQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFGUCxZQUFPLEdBQVAsT0FBTyxDQUFZO1FBQVksYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFZLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQW9INUcsa0NBQTZCLEdBQUksQ0FBQyxJQUFTLEVBQUUsS0FBVSxFQUFFLEtBQWMsRUFBRyxJQUFTLEVBQUUsRUFBRTtZQUMzRixJQUFJLElBQUksS0FBSyxJQUFJLElBQUksSUFBSSxLQUFLLElBQUksQ0FBQyxJQUFJLElBQUksS0FBSyxFQUFFO2dCQUM5QyxpQkFBaUI7Z0JBQ2pCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDO2dCQUMvQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFD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R0FBa0IsSUFBSSxhQUFhLEVBQUUsQ0FBQztBQUNuRTs7O0dBR0c7QUFDVyxxQ0FBZ0IsR0FBa0IsSUFBSSxhQUFhLEVBQUUsQ0FBQzs7WUFyQnZFLFNBQVMsU0FBQztnQkFDUCw4Q0FBOEM7Z0JBQzlDLFFBQVEsRUFBRSxlQUFlO2dCQUN6Qixnb0JBQXdDO2dCQUV4Qyx1REFBdUQ7Z0JBQ3ZELElBQUksRUFBRTtvQkFDRixZQUFZLEVBQUUsRUFBRSxDQUFDLDZCQUE2QjtpQkFDakQ7O2FBQ0o7OztZQWxCbUIsVUFBVTtZQUN6QixTQUFTO1lBRHVELGVBQWU7OzttQkFrQy9FLEtBQUs7dUJBS0wsS0FBSzt5QkFJTCxLQUFLOzJCQWFMLFlBQVksU0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIEl0ZXJhYmxlRGlmZmVyLCBJdGVyYWJsZURpZmZlcnMsXHJcbiAgICAgUmVuZGVyZXIyLCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRpQ2hlY2tib3hDb21wb25lbnQgfSBmcm9tICcuLi9jaGVja2JveC9UaUNoZWNrYm94TW9kdWxlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZU1hcCwgT2JzZXJ2YWJsZVNldCwgVXRpbCB9IGZyb20gJy4uLy4uL3V0aWxzL1V0aWwnO1xyXG5cclxuLyoqXHJcbiAqIENoZWNraXRlbeWkmumAiemAiemhuee7hOS7tu+8jOWwveeuoei/meaYr+S4gOS4que7hOS7tu+8jOS9v+eUqOaXtuWDj+WxnuaAp+aMh+S7pOOAglxyXG4gKlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Y29tcG9uZW50LXNlbGVjdG9yXHJcbiAgICBzZWxlY3RvcjogJ1t0aUNoZWNraXRlbV0nLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuLi9jaGVja2JveC9jaGVja2JveC5odG1sJyxcclxuICAgIHN0eWxlVXJsczogWycuLi9jaGVja2JveC9jaGVja2JveC5sZXNzJ10sXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dXNlLWhvc3QtcHJvcGVydHktZGVjb3JhdG9yXHJcbiAgICBob3N0OiB7XHJcbiAgICAgICAgJ3RpQ2hlY2tib3gnOiAnJyAvLyDnu5nlrr/kuLvlhYPntKDmt7vliqB0aUNoZWNrYm945bGe5oCn77yM5a6e546w5a6a5Yi25qC35byPXHJcbiAgICB9XHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUaUNoZWNraXRlbUNvbXBvbmVudCBleHRlbmRzIFRpQ2hlY2tib3hDb21wb25lbnQge1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5YWo5bGAaXRlbeaVsOaNrijlpJrkuKpncm91cOeahGl0ZW3pg73lnKjov5nph4wpXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2xvYmVDaGVja2VkTWFwOiBPYnNlcnZhYmxlTWFwID0gbmV3IE9ic2VydmFibGVNYXAoKTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5YWo5bGA54Gw5YyW56aB55So5pWw5o2uKOWkmuS4qmdyb3Vw55qEaXRlbemDveWcqOi/memHjClcclxuICAgICAqL1xyXG4gICAgcHVibGljIHN0YXRpYyBnbG9iZURpc2FibGVkU2V0OiBPYnNlcnZhYmxlU2V0ID0gbmV3IE9ic2VydmFibGVTZXQoKTtcclxuICAgIC8qKlxyXG4gICAgICog6YCJ5oup5qGGaXRlbeaVsOaNru+8jGl0ZW3lvJXnlKjkuZ/mmK/ouqvku73moIfnpLrjgIJcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgaXRlbTogYW55O1xyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPlrZjlnKh2YWx1ZUtleeaXtu+8jOmAieS4reWAvOWfuuS6jnZhbHVlS2V5XHJcbiAgICAgKiAxMC4wLjTniYjmnKzmlrDlop5cclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgdmFsdWVLZXk6IHN0cmluZztcclxuICAgIC8qKlxyXG4gICAgICog5Y+v6YCJ5bGe5oCn77yM5b2T5rKh5pyJ5YWo6YCJ5oyJ6ZKu77yM5Lmf6KaB6I635b6X5LiA57uE6YCJ5Lit6aG55pe2LCDnlKjmnaXnu5Hlrprlt7LpgInkuK3mlbDmja7pm4bjgIJcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgYmVDaGVja2VkczogU2V0PGFueT58QXJyYXk8YW55PjtcclxuICAgIHByaXZhdGUgYmVDaGVja2VkU2V0OiBPYnNlcnZhYmxlU2V0OyAvLyDnlKjkuo7lrZjlgqjpgInkuK3nmoTmlbDmja7pobnjgILlpoLmnpzmnKrphY3nva52YWx1ZUtlee+8jOWImeWtmOWCqOeahOaYr+aVtOS4quaVsOaNrumhue+8m+WmguaenOaMh+WumnZhbHVlS2V577yM5YiZ5a2Y5YKo55qE5YC85Z+65LqO6YCJ5Lit6aG544CCXHJcbiAgICBwcml2YXRlIGJlQ2hlY2tlZHNEaWZmZXI6IEl0ZXJhYmxlRGlmZmVyPGFueT47XHJcbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaG9zdFJlZjogRWxlbWVudFJlZiwgcHJvdGVjdGVkIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHByb3RlY3RlZCBpdGVyYWJsZURpZmZlcnM6IEl0ZXJhYmxlRGlmZmVycykge1xyXG4gICAgICAgIC8vIOaYr+WboOS4umdyb3VwIGl0ZW3kuKTkuKrlrZDnsbvpg73nlKjliLBkaWZmZXJz77yM5omA5Lul5pS+5Zyo54i257G76L+Z6YeM44CCXHJcbiAgICAgICAgc3VwZXIoaG9zdFJlZiwgcmVuZGVyZXIpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDnm5HlkKxjaGFuZ2Xkuovku7bvvIzkvJrlpJrop6blj5HkuIDmrKFEb0NoZWNr44CCIC8vVE9ETzog5LiN6K6p6L+Z5p2hSG9zdExpc3RlbmVyKCdjaGFuZ2UnLCBbJyRldmVudCddKeWcqOaWh+aho+aYvuekulxyXG4gICAgICogQHBhcmFtIGNoZWNrZWRcclxuICAgICAqIEByZXR1cm5zXHJcbiAgICAgKi9cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2NoYW5nZScsIFsnJGV2ZW50J10pIHB1YmxpYyBvbkhvc3RDaGFuZ2UoY2hlY2tlZDogYW55KTogdm9pZCB7XHJcbiAgICAgICAgLy8gaXRlbSBjaGVja2Vk5ZCM5q2l5YiwZ2xvYmVDaGVja2VkU2V0XHJcbiAgICAgICAgaWYgKCF0aGlzLml0ZW0pIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5uYXRpdmVFbGVtZW50LmNoZWNrZWQgP1xyXG4gICAgICAgICAgICBUaUNoZWNraXRlbUNvbXBvbmVudC5nbG9iZUNoZWNrZWRNYXAuc2V0KHRoaXMuaXRlbSwgdHJ1ZSwgdGhpcykgOlxyXG4gICAgICAgICAgICB0aGlzLm5hdGl2ZUVsZW1lbnQuaW5kZXRlcm1pbmF0ZSA/XHJcbiAgICAgICAgICAgICAgICBUaUNoZWNraXRlbUNvbXBvbmVudC5nbG9iZUNoZWNrZWRNYXAuc2V0KHRoaXMuaXRlbSwgbnVsbCwgdGhpcykgOlxyXG4gICAgICAgICAgICAgICAgVGlDaGVja2l0ZW1Db21wb25lbnQuZ2xvYmVDaGVja2VkTWFwLnNldCh0aGlzLml0ZW0sIGZhbHNlLCB0aGlzKTtcclxuICAgICAgICAvLyBpdGVtIGNoZWNrZWTlkIzmraXliLBiZUNoZWNrZWRTZXRcclxuICAgICAgICBpZiAodGhpcy5iZUNoZWNrZWRTZXQpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWU6IGFueSA9IHRoaXMuZ2V0VmFsdWUodGhpcy5pdGVtKTtcclxuICAgICAgICAgICAgdGhpcy5uYXRpdmVFbGVtZW50LmNoZWNrZWQgPyB0aGlzLmJlQ2hlY2tlZFNldC5hZGQodmFsdWUpIDogdGhpcy5iZUNoZWNrZWRTZXQuZGVsZXRlKHZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgICAgICB0aGlzLmluaXRCZUNoZWNrZWRTZXQoKTtcclxuICAgICAgICBpZiAoIXRoaXMuaXRlbSkgeyAvLyDnlKjmiLflv5jkuoborr7lrprvvIzmiJbogIXnu6fmib/nmoTlrZDnsbvml6DpnIDorr7lrppcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmluaXRHbG9iZUNoZWNrZWRTZXRJdGVtKCk7XHJcbiAgICAgICAgdGhpcy5zZXRDaGVja2VkSXRlbSgpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uQ2hhbmdlcyhjaGFuZ2VzKTtcclxuICAgICAgICAvLyDlpJbpg6jnm7TmjqXnu5lpdGVt6YeN5paw6LWL5YC85LqG44CCXHJcbiAgICAgICAgaWYgKGNoYW5nZXNbJ2l0ZW0nXSAmJiAhY2hhbmdlc1snaXRlbSddLmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICAgICAgICAvLyDliKDpmaTlt7Lkvb/nlKjnmoTpnZnmgIHotYTmupDjgILlvZPnhLbvvIzov5nph4zmnInlj6/og73or6/liKDpmaTjgILlm6DkuLrmraRpdGVt6L+Y5Zyo5Yir5aSE5L2/55So44CCICAg5YWo6YCJ5oyJ6ZKu6YKj6YeM77yM5pyJ57qg5q2j5py65Yi244CCXHJcbiAgICAgICAgICAgIHRoaXMuIGRlbGV0ZUdsb2JlUmVmKGNoYW5nZXNbJ2l0ZW0nXS5wcmV2aW91c1ZhbHVlKTtcclxuICAgICAgICAgICAgLy8g5re75Yqg5paw55qE6LWE5rqQXHJcbiAgICAgICAgICAgIHRoaXMuc2V0Q2hlY2tlZEl0ZW0oKTtcclxuICAgICAgICAgICAgLy8g6YeN5paw6K6+572uZGlzYWJsZWRcclxuICAgICAgICAgICAgdGhpcy5zZXREaXNhYmxlZFN0YXRlR2xvYmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkRlc3Ryb3koKTtcclxuICAgICAgICAvLyDliKDpmaTlt7Lkvb/nlKjnmoTpnZnmgIHotYTmupBcclxuICAgICAgICB0aGlzLiBkZWxldGVHbG9iZVJlZih0aGlzLml0ZW0pO1xyXG4gICAgICAgIC8vIOino+mZpOebkeWQrFxyXG4gICAgICAgIFRpQ2hlY2tpdGVtQ29tcG9uZW50Lmdsb2JlQ2hlY2tlZE1hcC5yZW1vdmVPYnNlcnZlcih0aGlzLmdsb2JlQ2hlY2tlZE1hcE9ic2VydmVySXRlbUZuKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDliKDpmaTlt7Lkvb/nlKjnmoTpnZnmgIHotYTmupBcclxuICAgIHByaXZhdGUgZGVsZXRlR2xvYmVSZWYoaXRlbTogYW55KTogdm9pZCB7XHJcbiAgICAgICAgVGlDaGVja2l0ZW1Db21wb25lbnQuZ2xvYmVDaGVja2VkTWFwLmRlbGV0ZSh0aGlzLml0ZW0pO1xyXG4gICAgICAgIFRpQ2hlY2tpdGVtQ29tcG9uZW50Lmdsb2JlRGlzYWJsZWRTZXQuZGVsZXRlKHRoaXMuaXRlbSk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdEb0NoZWNrKCk6IHZvaWQge1xyXG4gICAgICAgIHN1cGVyLm5nRG9DaGVjaygpO1xyXG4gICAgICAgIGlmICghdGhpcy5iZUNoZWNrZWRTZXQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBiZUNoZWNrZWRzQ2hhbmdlcyA9IHRoaXMuYmVDaGVja2Vkc0RpZmZlci5kaWZmKHRoaXMuYmVDaGVja2Vkcyk7XHJcbiAgICAgICAgaWYgKGJlQ2hlY2tlZHNDaGFuZ2VzKSB7Ly8gYmVDaGVja2Vkc+WQjOatpeWIsGJlQ2hlY2tlZFNldFxyXG4gICAgICAgICAgICBiZUNoZWNrZWRzQ2hhbmdlcy5mb3JFYWNoQWRkZWRJdGVtKFxyXG4gICAgICAgICAgICAgICAgcmVjb3JkID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJlQ2hlY2tlZFNldC5hZGQocmVjb3JkLml0ZW0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBiZUNoZWNrZWRzQ2hhbmdlcy5mb3JFYWNoUmVtb3ZlZEl0ZW0oXHJcbiAgICAgICAgICAgICAgICByZWNvcmQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYmVDaGVja2VkU2V0LmRlbGV0ZShyZWNvcmQuaXRlbSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBpbml0QmVDaGVja2VkU2V0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5iZUNoZWNrZWRzKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5iZUNoZWNrZWRzRGlmZmVyID0gdGhpcy5pdGVyYWJsZURpZmZlcnMuZmluZCh0aGlzLmJlQ2hlY2tlZHMpLmNyZWF0ZShudWxsKTtcclxuICAgICAgICB0aGlzLmJlQ2hlY2tlZFNldCA9IG5ldyBPYnNlcnZhYmxlU2V0KHRoaXMuYmVDaGVja2Vkcyk7IC8vIFRPRE865YaZ5YWx55So55qEQXJyYXkvU2V06L2sU2V0XHJcbiAgICAgICAgdGhpcy5iZUNoZWNrZWRTZXQuYWRkT2JzZXJ2ZXIoXHJcbiAgICAgICAgICAgIChpdGVtOiBhbnksIGlzQWRkOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBiZUNoZWNrZWRTZXTnmoTlj5jljJblkIzmraXliLBiZUNoZWNrZWRzXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZUNoZWNrZWRzIGluc3RhbmNlb2YgU2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNBZGQgPyB0aGlzLmJlQ2hlY2tlZHMuYWRkKGl0ZW0pIDogdGhpcy5iZUNoZWNrZWRzLmRlbGV0ZShpdGVtKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iZUNoZWNrZWRzIGluc3RhbmNlb2YgQXJyYXkpIHsgLy8gVE9ETzrlhpnlhaznlKjnmoRBcnJheSByZW1vdmXlh73mlbBcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleDogbnVtYmVyID0gdGhpcy5iZUNoZWNrZWRzLmluZGV4T2YoaXRlbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQWRkICYmIGluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJlQ2hlY2tlZHMucHVzaChpdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0FkZCAmJiBpbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5iZUNoZWNrZWRzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gY2hlY2tlZFNldOmAmuefpeWIsGl0ZW0gY2hlY2tlZFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRDaGVja2VkSXRlbSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogZ2xvYmVDaGVja2VkU2V05ZCM5q2l5YiwaXRlbSBjaGVja2VkXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgaW5pdEdsb2JlQ2hlY2tlZFNldEl0ZW0oKTogdm9pZCB7XHJcbiAgICAgICAgLy8g5Yid5aeL5YyW5pe277yM5LiN5b6AZ2xvYmVDaGVja2VkU2V05pS+5YC877yM5piv5Zug5Li6Z3JvdXDkvJjlhYjnuqfmm7Tpq5jjgIJcclxuICAgICAgICBUaUNoZWNraXRlbUNvbXBvbmVudC5nbG9iZUNoZWNrZWRNYXAuYWRkT2JzZXJ2ZXIodGhpcy5nbG9iZUNoZWNrZWRNYXBPYnNlcnZlckl0ZW1Gbik7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnbG9iZUNoZWNrZWRNYXBPYnNlcnZlckl0ZW1GbiA9ICAoaXRlbTogYW55LCB2YWx1ZTogYW55LCBpc0FkZDogYm9vbGVhbiAsIGZyb206IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChmcm9tICE9PSB0aGlzICYmIGl0ZW0gPT09IHRoaXMuaXRlbSAmJiBpc0FkZCkge1xyXG4gICAgICAgICAgICAvLyDku47lhajlsYDlkIzmraXov4fmnaXnmoTvvIzlj6/og73mmK/ljYrpgIlcclxuICAgICAgICAgICAgY29uc3QgbGFzdENoZWNrZWQgPSB0aGlzLm5hdGl2ZUVsZW1lbnQuY2hlY2tlZDtcclxuICAgICAgICAgICAgY29uc3QgbGFzdEluZGV0ZXJtaW5hdGUgPSAodGhpcy5uYXRpdmVFbGVtZW50LmluZGV0ZXJtaW5hdGUgPT09IHRydWUpID8gdHJ1ZSA6IGZhbHNlOyAvLyDlsIZ1bmRlZmluZWTkuZ/ovazkuLpmYWxzZeOAglxyXG4gICAgICAgICAgICB0aGlzLm5hdGl2ZUVsZW1lbnQuY2hlY2tlZCA9ICh2YWx1ZSA9PT0gdHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMubmF0aXZlRWxlbWVudC5pbmRldGVybWluYXRlID0gKHZhbHVlID09PSBudWxsKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMubmF0aXZlRWxlbWVudC5jaGVja2VkICE9PSBsYXN0Q2hlY2tlZCB8fCB0aGlzLm5hdGl2ZUVsZW1lbnQuaW5kZXRlcm1pbmF0ZSAhPT0gbGFzdEluZGV0ZXJtaW5hdGUpIHtcclxuICAgICAgICAgICAgICAgIFV0aWwudHJpZ2dlcih0aGlzLm5hdGl2ZUVsZW1lbnQsICdjaGFuZ2UnKTsgLy8g5b+F6aG75Li75Yqo6Kem5Y+RY2hhbmdl5LqL5Lu277yM5ZCm5YiZbmdNb2RlbOS4jeabtOaWsOOAglxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBzZXRDaGVja2VkSXRlbSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXRlbSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGxhc3RDaGVja2VkOiBib29sZWFuID0gdGhpcy5uYXRpdmVFbGVtZW50LmNoZWNrZWQ7XHJcbiAgICAgICAgY29uc3QgdmFsdWU6IGFueSA9IHRoaXMuZ2V0VmFsdWUodGhpcy5pdGVtKTtcclxuICAgICAgICAvLyDlpoLmnpxiZUNoZWNrZWRz5a2Y5Zyo77yM5LyY5YWI57qn5pu06auY77yM5LulYmVDaGVja2Vkc+S4uuWHhuOAglxyXG4gICAgICAgIHRoaXMubmF0aXZlRWxlbWVudC5jaGVja2VkID0gdGhpcy5iZUNoZWNrZWRTZXQgPyB0aGlzLmJlQ2hlY2tlZFNldC5oYXModmFsdWUpIDogVGlDaGVja2l0ZW1Db21wb25lbnQuZ2xvYmVDaGVja2VkTWFwLmdldCh0aGlzLml0ZW0pO1xyXG4gICAgICAgIC8vIOi/memHjOW6lOivpeS4jeeUqOiAg+iZkeWNiumAieWQp++8n1xyXG4gICAgICAgIGlmICh0aGlzLm5hdGl2ZUVsZW1lbnQuY2hlY2tlZCAhPT0gbGFzdENoZWNrZWQpIHtcclxuICAgICAgICAgICAgVXRpbC50cmlnZ2VyKHRoaXMubmF0aXZlRWxlbWVudCwgJ2NoYW5nZScpOyAvLyDlv4XpobvkuLvliqjop6blj5FjaGFuZ2Xkuovku7bvvIzlkKbliJluZ01vZGVs5LiN5pu05paw44CCXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIHNldERpc2FibGVkU3RhdGU/KGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5zZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQpO1xyXG4gICAgICAgIHRoaXMuc2V0RGlzYWJsZWRTdGF0ZUdsb2JlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXREaXNhYmxlZFN0YXRlR2xvYmUoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5uYXRpdmVFbGVtZW50LmRpc2FibGVkID8gVGlDaGVja2l0ZW1Db21wb25lbnQuZ2xvYmVEaXNhYmxlZFNldC5hZGQodGhpcy5pdGVtKVxyXG4gICAgICAgICAgICA6IFRpQ2hlY2tpdGVtQ29tcG9uZW50Lmdsb2JlRGlzYWJsZWRTZXQuZGVsZXRlKHRoaXMuaXRlbSk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOi+k+WFpe+8muafkOS4quaVsOaNrumhuVxyXG4gICAgICog6L6T5Ye677ya5b2T5pyJdmFsdWVLZXks6L+U5Zue5YC85Z+65LqOdmFsdWVLZXnvvJvlvZPmsqHmnIl2YWx1ZUtleeaXtu+8jOi/lOWbnui+k+WFpeWAvFxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgZ2V0VmFsdWUoaXRlbTogYW55KTogYW55IHtcclxuICAgICAgICByZXR1cm4gdGhpcy52YWx1ZUtleSA/IGl0ZW1bdGhpcy52YWx1ZUtleV0gOiBpdGVtO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==