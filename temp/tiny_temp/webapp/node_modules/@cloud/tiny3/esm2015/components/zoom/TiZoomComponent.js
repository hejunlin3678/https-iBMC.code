import { Component, ElementRef, HostListener, Input, Renderer2 } from '@angular/core';
import { TiRenderer } from '../../services/renderer/TiRenderer';
/**
 * @ignore
 *
 * 10.0.3版本增加，暂时不对外开放
 *
 * 该指令可以实现图片放大镜功能，添加tiZoom后会创建放大区域选择器元素（div）和放大结果呈现元素（div）
 *
 * 通过设置放大结果的background-image、background-size和background-position来达到放大效果
 *
 * 10.1.0版本从指令调整为组件形式
 *
 * <example-url>../tiny3demo/#/zoom/zoom-all</example-url>
 */
export class TiZoomComponent {
    constructor(hostRef, renderer, tiRenderer) {
        this.renderer = renderer;
        this.tiRenderer = tiRenderer;
        // 选择遮罩的宽高，默认150px
        this.zoomSelectorLength = 150;
        // 放大展示的宽高，默认300px
        this.zoomViewerLength = 300;
        // 宿主元素的图片路径
        this.imgSrc = '';
        this.hostEle = hostRef.nativeElement;
    }
    ngOnInit() {
        // 设置父元素
        this.setParentEle();
        // 设置放大比例
        this.ratio = this.zoomViewerLength / this.zoomSelectorLength;
    }
    /**
     * @ignore
     * 图片加载成功事件处理
     */
    onHostLoad(event) {
        this.imgSrc = event.target.src;
    }
    /**
     * @ignore
     * 鼠标进入宿主元素，创建放大效果相关元素
     */
    onHostMouseEnter(event) {
        this.createZoomSelector();
        this.createZoomViewer();
        this.reStyleResults(event);
    }
    /**
     * @ignore
     * 鼠标离开宿主元素，移除放大效果相关元素
     */
    onHostMouseLeave(event) {
        // 当鼠标离开宿主元素并且不是进入选择遮罩时，移除选择遮罩和放大结果
        if (event.relatedTarget !== this.zoomSelectorEle) {
            this.removeZoomEle();
        }
    }
    /**
     * 设置父元素
     */
    setParentEle() {
        const parentEle = this.hostEle.parentElement;
        if (parentEle !== null && parentEle.clientWidth !== 0 && parentEle.clientHeight !== 0) {
            if (this.hostEle.offsetParent !== parentEle) {
                // 父元素必须能够定位
                this.renderer.setStyle(parentEle, 'position', 'relative');
            }
            this.parentEle = parentEle;
        }
        else {
            this.parentEle = document.body;
        }
    }
    /**
     * 创建选择遮罩，初始化样式，增加事件监听
     */
    createZoomSelector() {
        this.zoomSelectorEle = this.renderer.createElement('div');
        // 添加样式，tinyplus3的productpreview需要根据分辨率修改元素尺寸
        this.renderer.addClass(this.zoomSelectorEle, 'ti3-img-zoom-selector');
        this.tiRenderer.setStyles(this.zoomSelectorEle, {
            width: this.zoomSelectorLength + 'px',
            height: this.zoomSelectorLength + 'px'
        });
        // 鼠标在选择遮罩上移动时的事件
        this.selectorMouseMoveHandler = this.renderer.listen(this.zoomSelectorEle, 'mousemove', (event) => {
            this.reStyleResults(event);
        });
        // 鼠标离开选择遮罩的事件，销毁遮罩元素和放大结果呈现元素
        this.selectorMouseLeaveHandler = this.renderer.listen(this.zoomSelectorEle, 'mouseleave', (event) => {
            this.renderer.removeChild(this.parentEle, this.zoomSelectorEle);
            this.renderer.removeChild(document.body, this.zoomViewerEle);
            this.zoomSelectorEle = undefined;
            this.zoomViewerEle = undefined;
        });
        this.renderer.appendChild(this.parentEle, this.zoomSelectorEle);
    }
    /**
     * 创建放大结果呈现元素，初始化样式
     */
    createZoomViewer() {
        this.zoomViewerEle = this.renderer.createElement('div');
        const hostEleRect = this.hostEle.getBoundingClientRect();
        const parentEleRect = this.parentEle.getBoundingClientRect();
        // 放大结果元素相对于父元素进行定位
        // left = 父元素宽度 - 边框宽度 + 滚动距离
        let left = this.parentEle.offsetWidth - TiZoomComponent.ZOOM_VIEWER_BORDER_WIDTH + parentEleRect.left + window.pageXOffset;
        // top = 父元素到视口距离 + 滚动距离
        let top = parentEleRect.top + window.pageYOffset;
        // 当父元素为body时，调整为相对于宿主元素定位
        if (this.parentEle === document.body) {
            left = this.hostEle.offsetWidth - TiZoomComponent.ZOOM_VIEWER_BORDER_WIDTH + hostEleRect.left + window.pageXOffset;
            top = hostEleRect.top + window.pageYOffset;
        }
        // 添加样式，tinyplus3的productpreview需要根据分辨率修改元素尺寸
        this.renderer.addClass(this.zoomViewerEle, 'ti3-img-zoom-viewer');
        this.tiRenderer.setStyles(this.zoomViewerEle, {
            left: left + 'px',
            top: top + 'px',
            width: `${this.zoomViewerLength}px`,
            height: `${this.zoomViewerLength}px`,
            background: `url(${this.imgSrc})`,
            'background-size': `${this.hostEle.width * this.ratio}px ${this.hostEle.height * this.ratio}px`
        });
        this.renderer.appendChild(document.body, this.zoomViewerEle);
    }
    // 计算鼠标相对宿主元素的位置
    getCursorPos(mouseEvent) {
        const hostEleRect = this.hostEle.getBoundingClientRect();
        // 考虑滚动情况
        const left = mouseEvent.pageX - hostEleRect.left - window.pageXOffset;
        const top = mouseEvent.pageY - hostEleRect.top - window.pageYOffset;
        return { x: left, y: top };
    }
    /**
     * 计算选择遮罩偏移和放大区域
     */
    reStyleResults(mouseEvent) {
        // 1. 获取计算鼠标相对于宿主元素左上角的位置
        const cursorPos = this.getCursorPos(mouseEvent);
        // 获取遮罩宽度
        const zoomSelectorWidth = this.zoomSelectorEle.offsetWidth;
        // 2. 计算放大结果的位置
        let viewerPosX = cursorPos.x - (zoomSelectorWidth / 2);
        let viewerPosY = cursorPos.y - (zoomSelectorWidth / 2);
        // 3. 调整
        // 3.1 选择遮罩移出宿主元素的右侧
        if (viewerPosX > this.hostEle.offsetWidth - zoomSelectorWidth) {
            viewerPosX = this.hostEle.offsetWidth - zoomSelectorWidth;
        }
        // 3.2 选择遮罩移出宿主元素的左侧
        if (viewerPosX < 0) {
            viewerPosX = 0;
        }
        // 3.3 选择遮罩移出宿主元素的下方
        if (viewerPosY > this.hostEle.offsetHeight - zoomSelectorWidth) {
            viewerPosY = this.hostEle.offsetHeight - zoomSelectorWidth;
        }
        // 3.4 选择遮罩移出宿主元素的上方
        if (viewerPosY < 0) {
            viewerPosY = 0;
        }
        // 4. 设置选择区域偏移，选择区域偏移=放大结果位置 + 宿主元素的偏移
        this.tiRenderer.setStyles(this.zoomSelectorEle, {
            left: `${viewerPosX + this.hostEle.offsetLeft}px`,
            top: `${viewerPosY + this.hostEle.offsetTop}px`
        });
        // 5. 设置放大结果
        this.renderer.setStyle(this.zoomViewerEle, 'background-position', `-${viewerPosX * this.ratio}px -${viewerPosY * this.ratio}px`);
    }
    ngOnDestroy() {
        this.removeZoomEle();
    }
    /**
     * 移除选择遮罩和放大结果元素、解绑相关事件
     */
    removeZoomEle() {
        if (this.zoomSelectorEle !== undefined) {
            this.renderer.removeChild(this.parentEle, this.zoomSelectorEle);
            this.zoomSelectorEle = undefined;
        }
        if (this.zoomViewerEle !== undefined) {
            this.renderer.removeChild(document.body, this.zoomViewerEle);
            this.zoomViewerEle = undefined;
        }
        if (this.selectorMouseMoveHandler) {
            this.selectorMouseMoveHandler();
        }
        if (this.selectorMouseLeaveHandler) {
            this.selectorMouseLeaveHandler();
        }
    }
}
// 放大结果的边框宽度
TiZoomComponent.ZOOM_VIEWER_BORDER_WIDTH = 1;
TiZoomComponent.decorators = [
    { type: Component, args: [{
                // 非img元素，tiZoom指令无效
                selector: 'img[tiZoom]',
                template: '',
                styles: [".ti3-img-zoom-selector{background-color:var(--ti-common-color-icon-hover);cursor:move;display:block;left:0;opacity:.2;position:absolute;top:0}.ti3-img-zoom-viewer{background-repeat:no-repeat!important;border:1px solid var(--ti-common-color-line-dividing);box-sizing:border-box;display:block;position:absolute;top:0}"]
            },] }
];
TiZoomComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: TiRenderer }
];
TiZoomComponent.propDecorators = {
    zoomSelectorLength: [{ type: Input }],
    zoomViewerLength: [{ type: Input }],
    onHostLoad: [{ type: HostListener, args: ['load', ['$event'],] }],
    onHostMouseEnter: [{ type: HostListener, args: ['mouseenter', ['$event'],] }],
    onHostMouseLeave: [{ type: HostListener, args: ['mouseleave', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlab29tQ29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL2NvbXBvbmVudHMvem9vbS9UaVpvb21Db21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBcUIsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pHLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUVoRTs7Ozs7Ozs7Ozs7O0dBWUc7QUFPSCxNQUFNLE9BQU8sZUFBZTtJQWlDeEIsWUFBWSxPQUFtQixFQUFVLFFBQW1CLEVBQVUsVUFBc0I7UUFBbkQsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLGVBQVUsR0FBVixVQUFVLENBQVk7UUE1QjVGLGtCQUFrQjtRQUNULHVCQUFrQixHQUFXLEdBQUcsQ0FBQztRQUUxQyxrQkFBa0I7UUFDVCxxQkFBZ0IsR0FBVyxHQUFHLENBQUM7UUFXeEMsWUFBWTtRQUNKLFdBQU0sR0FBVyxFQUFFLENBQUM7UUFheEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDO0lBQ3pDLENBQUM7SUFFRCxRQUFRO1FBQ0osUUFBUTtRQUNSLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixTQUFTO1FBQ1QsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDO0lBQ2pFLENBQUM7SUFFRDs7O09BR0c7SUFDc0MsVUFBVSxDQUFDLEtBQVU7UUFDMUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7OztPQUdHO0lBQzRDLGdCQUFnQixDQUFDLEtBQVU7UUFDdEUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7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QztZQUNoRSxJQUFJLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQztTQUNwQztRQUNELElBQUksSUFBSSxDQUFDLGFBQWEsS0FBSyxTQUFTLEVBQUU7WUFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDN0QsSUFBSSxDQUFDLGFBQWEsR0FBRyxTQUFTLENBQUM7U0FDbEM7UUFDRCxJQUFJLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUMvQixJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztTQUNuQztRQUNELElBQUksSUFBSSxDQUFDLHlCQUF5QixFQUFFO1lBQ2hDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1NBQ3BDO0lBQ0wsQ0FBQzs7QUEvTkQsWUFBWTtBQUNZLHdDQUF3QixHQUFXLENBQUMsQ0FBQzs7WUFUaEUsU0FBUyxTQUFDO2dCQUNQLG9CQUFvQjtnQkFDcEIsUUFBUSxFQUFFLGFBQWE7Z0JBQ3ZCLFFBQVEsRUFBRSxFQUFFOzthQUVmOzs7WUFyQm1CLFVBQVU7WUFBMEMsU0FBUztZQUN4RSxVQUFVOzs7aUNBMkJkLEtBQUs7K0JBR0wsS0FBSzt5QkF1Q0wsWUFBWSxTQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQzsrQkFRL0IsWUFBWSxTQUFDLFlBQVksRUFBRSxDQUFDLFFBQVEsQ0FBQzsrQkFVckMsWUFBWSxTQUFDLFlBQVksRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgSG9zdExpc3RlbmVyLCBJbnB1dCwgT25EZXN0cm95LCBPbkluaXQsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaVJlbmRlcmVyIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcmVuZGVyZXIvVGlSZW5kZXJlcic7XHJcblxyXG4vKipcclxuICogQGlnbm9yZVxyXG4gKlxyXG4gKiAxMC4wLjPniYjmnKzlop7liqDvvIzmmoLml7bkuI3lr7nlpJblvIDmlL5cclxuICpcclxuICog6K+l5oyH5Luk5Y+v5Lul5a6e546w5Zu+54mH5pS+5aSn6ZWc5Yqf6IO977yM5re75YqgdGlab29t5ZCO5Lya5Yib5bu65pS+5aSn5Yy65Z+f6YCJ5oup5Zmo5YWD57Sg77yIZGl277yJ5ZKM5pS+5aSn57uT5p6c5ZGI546w5YWD57Sg77yIZGl277yJXHJcbiAqXHJcbiAqIOmAmui/h+iuvue9ruaUvuWkp+e7k+aenOeahGJhY2tncm91bmQtaW1hZ2XjgIFiYWNrZ3JvdW5kLXNpemXlkoxiYWNrZ3JvdW5kLXBvc2l0aW9u5p2l6L6+5Yiw5pS+5aSn5pWI5p6cXHJcbiAqXHJcbiAqIDEwLjEuMOeJiOacrOS7juaMh+S7pOiwg+aVtOS4uue7hOS7tuW9ouW8j1xyXG4gKlxyXG4gKiA8ZXhhbXBsZS11cmw+Li4vdGlueTNkZW1vLyMvem9vbS96b29tLWFsbDwvZXhhbXBsZS11cmw+XHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICAgIC8vIOmdnmltZ+WFg+e0oO+8jHRpWm9vbeaMh+S7pOaXoOaViFxyXG4gICAgc2VsZWN0b3I6ICdpbWdbdGlab29tXScsXHJcbiAgICB0ZW1wbGF0ZTogJycsXHJcbiAgICBzdHlsZVVybHM6IFsnLi96b29tLmxlc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgVGlab29tQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICAgIC8vIOaUvuWkp+e7k+aenOeahOi+ueahhuWuveW6plxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgWk9PTV9WSUVXRVJfQk9SREVSX1dJRFRIOiBudW1iZXIgPSAxO1xyXG5cclxuICAgIC8vIOmAieaLqemBrue9qeeahOWuvemrmO+8jOm7mOiupDE1MHB4XHJcbiAgICBASW5wdXQoKSB6b29tU2VsZWN0b3JMZW5ndGg6IG51bWJlciA9IDE1MDtcclxuXHJcbiAgICAvLyDmlL7lpKflsZXnpLrnmoTlrr3pq5jvvIzpu5jorqQzMDBweFxyXG4gICAgQElucHV0KCkgem9vbVZpZXdlckxlbmd0aDogbnVtYmVyID0gMzAwO1xyXG5cclxuICAgIC8vIOavlOS+i1xyXG4gICAgcHJpdmF0ZSByYXRpbzogbnVtYmVyO1xyXG5cclxuICAgIC8vIOWuv+S4u+WFg+e0oFxyXG4gICAgcHJpdmF0ZSBob3N0RWxlOiBhbnk7XHJcblxyXG4gICAgLy8g5a6/5Li75YWD57Sg55qE54i25YWD57SgXHJcbiAgICBwcml2YXRlIHBhcmVudEVsZTogYW55O1xyXG5cclxuICAgIC8vIOWuv+S4u+WFg+e0oOeahOWbvueJh+i3r+W+hFxyXG4gICAgcHJpdmF0ZSBpbWdTcmM6IHN0cmluZyA9ICcnO1xyXG5cclxuICAgIC8vIOaUvuWkp+WMuuWfn+mAieaLqeWZqFxyXG4gICAgcHJpdmF0ZSB6b29tU2VsZWN0b3JFbGU6IGFueTtcclxuXHJcbiAgICAvLyDmlL7lpKfnu5PmnpzlsZXnpLrljLrln59cclxuICAgIHByaXZhdGUgem9vbVZpZXdlckVsZTogYW55O1xyXG5cclxuICAgIC8vIOmAieaLqemBrue9qeebkeWQrOS6i+S7tlxyXG4gICAgcHJpdmF0ZSBzZWxlY3Rvck1vdXNlTW92ZUhhbmRsZXI6ICgpID0+IHZvaWQ7XHJcbiAgICBwcml2YXRlIHNlbGVjdG9yTW91c2VMZWF2ZUhhbmRsZXI6ICgpID0+IHZvaWQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IoaG9zdFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIHRpUmVuZGVyZXI6IFRpUmVuZGVyZXIpIHtcclxuICAgICAgICB0aGlzLmhvc3RFbGUgPSBob3N0UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgLy8g6K6+572u54i25YWD57SgXHJcbiAgICAgICAgdGhpcy5zZXRQYXJlbnRFbGUoKTtcclxuICAgICAgICAvLyDorr7nva7mlL7lpKfmr5TkvotcclxuICAgICAgICB0aGlzLnJhdGlvID0gdGhpcy56b29tVmlld2VyTGVuZ3RoIC8gdGhpcy56b29tU2VsZWN0b3JMZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDlm77niYfliqDovb3miJDlip/kuovku7blpITnkIZcclxuICAgICAqL1xyXG4gICAgQEhvc3RMaXN0ZW5lcignbG9hZCcsIFsnJGV2ZW50J10pIHB1YmxpYyBvbkhvc3RMb2FkKGV2ZW50OiBhbnkpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmltZ1NyYyA9IGV2ZW50LnRhcmdldC5zcmM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDpvKDmoIfov5vlhaXlrr/kuLvlhYPntKDvvIzliJvlu7rmlL7lpKfmlYjmnpznm7jlhbPlhYPntKBcclxuICAgICAqL1xyXG4gICAgQEhvc3RMaXN0ZW5lcignbW91c2VlbnRlcicsIFsnJGV2ZW50J10pIHB1YmxpYyBvbkhvc3RNb3VzZUVudGVyKGV2ZW50OiBhbnkpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZVpvb21TZWxlY3RvcigpO1xyXG4gICAgICAgIHRoaXMuY3JlYXRlWm9vbVZpZXdlcigpO1xyXG4gICAgICAgIHRoaXMucmVTdHlsZVJlc3VsdHMoZXZlbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog6byg5qCH56a75byA5a6/5Li75YWD57Sg77yM56e76Zmk5pS+5aSn5pWI5p6c55u45YWz5YWD57SgXHJcbiAgICAgKi9cclxuICAgIEBIb3N0TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBbJyRldmVudCddKSBwdWJsaWMgb25Ib3N0TW91c2VMZWF2ZShldmVudDogYW55KTogdm9pZCB7XHJcbiAgICAgICAgLy8g5b2T6byg5qCH56a75byA5a6/5Li75YWD57Sg5bm25LiU5LiN5piv6L+b5YWl6YCJ5oup6YGu572p5pe277yM56e76Zmk6YCJ5oup6YGu572p5ZKM5pS+5aSn57uT5p6cXHJcbiAgICAgICAgaWYgKGV2ZW50LnJlbGF0ZWRUYXJnZXQgIT09IHRoaXMuem9vbVNlbGVjdG9yRWxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlWm9vbUVsZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiuvue9rueItuWFg+e0oFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHNldFBhcmVudEVsZSgpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBwYXJlbnRFbGU6IGFueSA9IHRoaXMuaG9zdEVsZS5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgIGlmIChwYXJlbnRFbGUgIT09IG51bGwgJiYgcGFyZW50RWxlLmNsaWVudFdpZHRoICE9PSAwICYmIHBhcmVudEVsZS5jbGllbnRIZWlnaHQgIT09IDApIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaG9zdEVsZS5vZmZzZXRQYXJlbnQgIT09IHBhcmVudEVsZSkge1xyXG4gICAgICAgICAgICAgICAgLy8g54i25YWD57Sg5b+F6aG76IO95aSf5a6a5L2NXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHBhcmVudEVsZSwgJ3Bvc2l0aW9uJywgJ3JlbGF0aXZlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRFbGUgPSBwYXJlbnRFbGU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRFbGUgPSBkb2N1bWVudC5ib2R5O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7uumAieaLqemBrue9qe+8jOWIneWni+WMluagt+W8j++8jOWinuWKoOS6i+S7tuebkeWQrFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGNyZWF0ZVpvb21TZWxlY3RvcigpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnpvb21TZWxlY3RvckVsZSA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcblxyXG4gICAgICAgIC8vIOa3u+WKoOagt+W8j++8jHRpbnlwbHVzM+eahHByb2R1Y3RwcmV2aWV36ZyA6KaB5qC55o2u5YiG6L6o546H5L+u5pS55YWD57Sg5bC65a+4XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLnpvb21TZWxlY3RvckVsZSwgJ3RpMy1pbWctem9vbS1zZWxlY3RvcicpO1xyXG4gICAgICAgIHRoaXMudGlSZW5kZXJlci5zZXRTdHlsZXModGhpcy56b29tU2VsZWN0b3JFbGUsIHtcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMuem9vbVNlbGVjdG9yTGVuZ3RoICsgJ3B4JyxcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLnpvb21TZWxlY3Rvckxlbmd0aCArICdweCdcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8g6byg5qCH5Zyo6YCJ5oup6YGu572p5LiK56e75Yqo5pe255qE5LqL5Lu2XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rvck1vdXNlTW92ZUhhbmRsZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLnpvb21TZWxlY3RvckVsZSwgJ21vdXNlbW92ZScsIChldmVudDogYW55KTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucmVTdHlsZVJlc3VsdHMoZXZlbnQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIOm8oOagh+emu+W8gOmAieaLqemBrue9qeeahOS6i+S7tu+8jOmUgOavgemBrue9qeWFg+e0oOWSjOaUvuWkp+e7k+aenOWRiOeOsOWFg+e0oFxyXG4gICAgICAgIHRoaXMuc2VsZWN0b3JNb3VzZUxlYXZlSGFuZGxlciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuem9vbVNlbGVjdG9yRWxlLCAnbW91c2VsZWF2ZScsIChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMucGFyZW50RWxlLCB0aGlzLnpvb21TZWxlY3RvckVsZSk7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2hpbGQoZG9jdW1lbnQuYm9keSwgdGhpcy56b29tVmlld2VyRWxlKTtcclxuICAgICAgICAgICAgdGhpcy56b29tU2VsZWN0b3JFbGUgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHRoaXMuem9vbVZpZXdlckVsZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLnBhcmVudEVsZSwgdGhpcy56b29tU2VsZWN0b3JFbGUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu65pS+5aSn57uT5p6c5ZGI546w5YWD57Sg77yM5Yid5aeL5YyW5qC35byPXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY3JlYXRlWm9vbVZpZXdlcigpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnpvb21WaWV3ZXJFbGUgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIGNvbnN0IGhvc3RFbGVSZWN0OiBET01SZWN0ID0gdGhpcy5ob3N0RWxlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0IHBhcmVudEVsZVJlY3Q6IERPTVJlY3QgPSB0aGlzLnBhcmVudEVsZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuXHJcbiAgICAgICAgLy8g5pS+5aSn57uT5p6c5YWD57Sg55u45a+55LqO54i25YWD57Sg6L+b6KGM5a6a5L2NXHJcbiAgICAgICAgLy8gbGVmdCA9IOeItuWFg+e0oOWuveW6piAtIOi+ueahhuWuveW6piArIOa7muWKqOi3neemu1xyXG4gICAgICAgIGxldCBsZWZ0OiBudW1iZXIgPSB0aGlzLnBhcmVudEVsZS5vZmZzZXRXaWR0aCAtIFRpWm9vbUNvbXBvbmVudC5aT09NX1ZJRVdFUl9CT1JERVJfV0lEVEggKyBwYXJlbnRFbGVSZWN0LmxlZnQgKyB3aW5kb3cucGFnZVhPZmZzZXQ7XHJcbiAgICAgICAgLy8gdG9wID0g54i25YWD57Sg5Yiw6KeG5Y+j6Led56a7ICsg5rua5Yqo6Led56a7XHJcbiAgICAgICAgbGV0IHRvcDogbnVtYmVyID0gcGFyZW50RWxlUmVjdC50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQ7XHJcbiAgICAgICAgLy8g5b2T54i25YWD57Sg5Li6Ym9keeaXtu+8jOiwg+aVtOS4uuebuOWvueS6juWuv+S4u+WFg+e0oOWumuS9jVxyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudEVsZSA9PT0gZG9jdW1lbnQuYm9keSkge1xyXG4gICAgICAgICAgICBsZWZ0ID0gdGhpcy5ob3N0RWxlLm9mZnNldFdpZHRoIC0gVGlab29tQ29tcG9uZW50LlpPT01fVklFV0VSX0JPUkRFUl9XSURUSCArIGhvc3RFbGVSZWN0LmxlZnQgKyB3aW5kb3cucGFnZVhPZmZzZXQ7XHJcbiAgICAgICAgICAgIHRvcCA9IGhvc3RFbGVSZWN0LnRvcCArIHdpbmRvdy5wYWdlWU9mZnNldDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOa3u+WKoOagt+W8j++8jHRpbnlwbHVzM+eahHByb2R1Y3RwcmV2aWV36ZyA6KaB5qC55o2u5YiG6L6o546H5L+u5pS55YWD57Sg5bC65a+4XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLnpvb21WaWV3ZXJFbGUsICd0aTMtaW1nLXpvb20tdmlld2VyJyk7XHJcbiAgICAgICAgdGhpcy50aVJlbmRlcmVyLnNldFN0eWxlcyh0aGlzLnpvb21WaWV3ZXJFbGUsIHtcclxuICAgICAgICAgICAgbGVmdDogbGVmdCArICdweCcsXHJcbiAgICAgICAgICAgIHRvcDogdG9wICsgJ3B4JyxcclxuICAgICAgICAgICAgd2lkdGg6IGAke3RoaXMuem9vbVZpZXdlckxlbmd0aH1weGAsXHJcbiAgICAgICAgICAgIGhlaWdodDogYCR7dGhpcy56b29tVmlld2VyTGVuZ3RofXB4YCxcclxuICAgICAgICAgICAgYmFja2dyb3VuZDogYHVybCgke3RoaXMuaW1nU3JjfSlgLFxyXG4gICAgICAgICAgICAnYmFja2dyb3VuZC1zaXplJzogYCR7dGhpcy5ob3N0RWxlLndpZHRoICogdGhpcy5yYXRpb31weCAke3RoaXMuaG9zdEVsZS5oZWlnaHQgKiB0aGlzLnJhdGlvfXB4YFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmJvZHksIHRoaXMuem9vbVZpZXdlckVsZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6K6h566X6byg5qCH55u45a+55a6/5Li75YWD57Sg55qE5L2N572uXHJcbiAgICBwcml2YXRlIGdldEN1cnNvclBvcyhtb3VzZUV2ZW50OiBNb3VzZUV2ZW50KTogYW55IHtcclxuICAgICAgICBjb25zdCBob3N0RWxlUmVjdDogRE9NUmVjdCA9IHRoaXMuaG9zdEVsZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICAvLyDogIPomZHmu5rliqjmg4XlhrVcclxuICAgICAgICBjb25zdCBsZWZ0OiBudW1iZXIgPSBtb3VzZUV2ZW50LnBhZ2VYIC0gaG9zdEVsZVJlY3QubGVmdCAtIHdpbmRvdy5wYWdlWE9mZnNldDtcclxuICAgICAgICBjb25zdCB0b3A6IG51bWJlciA9IG1vdXNlRXZlbnQucGFnZVkgLSBob3N0RWxlUmVjdC50b3AgLSB3aW5kb3cucGFnZVlPZmZzZXQ7XHJcblxyXG4gICAgICAgIHJldHVybiB7IHg6IGxlZnQsIHk6IHRvcCB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6K6h566X6YCJ5oup6YGu572p5YGP56e75ZKM5pS+5aSn5Yy65Z+fXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVTdHlsZVJlc3VsdHMobW91c2VFdmVudDogTW91c2VFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIC8vIDEuIOiOt+WPluiuoeeul+m8oOagh+ebuOWvueS6juWuv+S4u+WFg+e0oOW3puS4iuinkueahOS9jee9rlxyXG4gICAgICAgIGNvbnN0IGN1cnNvclBvczogYW55ID0gdGhpcy5nZXRDdXJzb3JQb3MobW91c2VFdmVudCk7XHJcbiAgICAgICAgLy8g6I635Y+W6YGu572p5a695bqmXHJcbiAgICAgICAgY29uc3Qgem9vbVNlbGVjdG9yV2lkdGg6IG51bWJlciA9IHRoaXMuem9vbVNlbGVjdG9yRWxlLm9mZnNldFdpZHRoO1xyXG5cclxuICAgICAgICAvLyAyLiDorqHnrpfmlL7lpKfnu5PmnpznmoTkvY3nva5cclxuICAgICAgICBsZXQgdmlld2VyUG9zWDogbnVtYmVyID0gY3Vyc29yUG9zLnggLSAoem9vbVNlbGVjdG9yV2lkdGggLyAyKTtcclxuICAgICAgICBsZXQgdmlld2VyUG9zWTogbnVtYmVyID0gY3Vyc29yUG9zLnkgLSAoem9vbVNlbGVjdG9yV2lkdGggLyAyKTtcclxuXHJcbiAgICAgICAgLy8gMy4g6LCD5pW0XHJcbiAgICAgICAgLy8gMy4xIOmAieaLqemBrue9qeenu+WHuuWuv+S4u+WFg+e0oOeahOWPs+S+p1xyXG4gICAgICAgIGlmICh2aWV3ZXJQb3NYID4gdGhpcy5ob3N0RWxlLm9mZnNldFdpZHRoIC0gem9vbVNlbGVjdG9yV2lkdGgpIHtcclxuICAgICAgICAgICAgdmlld2VyUG9zWCA9IHRoaXMuaG9zdEVsZS5vZmZzZXRXaWR0aCAtIHpvb21TZWxlY3RvcldpZHRoO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyAzLjIg6YCJ5oup6YGu572p56e75Ye65a6/5Li75YWD57Sg55qE5bem5L6nXHJcbiAgICAgICAgaWYgKHZpZXdlclBvc1ggPCAwKSB7XHJcbiAgICAgICAgICAgIHZpZXdlclBvc1ggPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyAzLjMg6YCJ5oup6YGu572p56e75Ye65a6/5Li75YWD57Sg55qE5LiL5pa5XHJcbiAgICAgICAgaWYgKHZpZXdlclBvc1kgPiB0aGlzLmhvc3RFbGUub2Zmc2V0SGVpZ2h0IC0gem9vbVNlbGVjdG9yV2lkdGgpIHtcclxuICAgICAgICAgICAgdmlld2VyUG9zWSA9IHRoaXMuaG9zdEVsZS5vZmZzZXRIZWlnaHQgLSB6b29tU2VsZWN0b3JXaWR0aDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gMy40IOmAieaLqemBrue9qeenu+WHuuWuv+S4u+WFg+e0oOeahOS4iuaWuVxyXG4gICAgICAgIGlmICh2aWV3ZXJQb3NZIDwgMCkge1xyXG4gICAgICAgICAgICB2aWV3ZXJQb3NZID0gMDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIDQuIOiuvue9rumAieaLqeWMuuWfn+WBj+enu++8jOmAieaLqeWMuuWfn+WBj+enuz3mlL7lpKfnu5PmnpzkvY3nva4gKyDlrr/kuLvlhYPntKDnmoTlgY/np7tcclxuICAgICAgICB0aGlzLnRpUmVuZGVyZXIuc2V0U3R5bGVzKHRoaXMuem9vbVNlbGVjdG9yRWxlLCB7XHJcbiAgICAgICAgICAgIGxlZnQ6IGAke3ZpZXdlclBvc1ggKyB0aGlzLmhvc3RFbGUub2Zmc2V0TGVmdH1weGAsXHJcbiAgICAgICAgICAgIHRvcDogYCR7dmlld2VyUG9zWSArIHRoaXMuaG9zdEVsZS5vZmZzZXRUb3B9cHhgXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIDUuIOiuvue9ruaUvuWkp+e7k+aenFxyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy56b29tVmlld2VyRWxlLCAnYmFja2dyb3VuZC1wb3NpdGlvbicsXHJcbiAgICAgICAgICAgIGAtJHt2aWV3ZXJQb3NYICogdGhpcy5yYXRpb31weCAtJHt2aWV3ZXJQb3NZICogdGhpcy5yYXRpb31weGApO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnJlbW92ZVpvb21FbGUoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOenu+mZpOmAieaLqemBrue9qeWSjOaUvuWkp+e7k+aenOWFg+e0oOOAgeino+e7keebuOWFs+S6i+S7tlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHJlbW92ZVpvb21FbGUoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuem9vbVNlbGVjdG9yRWxlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLnBhcmVudEVsZSwgdGhpcy56b29tU2VsZWN0b3JFbGUpO1xyXG4gICAgICAgICAgICB0aGlzLnpvb21TZWxlY3RvckVsZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuem9vbVZpZXdlckVsZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2hpbGQoZG9jdW1lbnQuYm9keSwgdGhpcy56b29tVmlld2VyRWxlKTtcclxuICAgICAgICAgICAgdGhpcy56b29tVmlld2VyRWxlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zZWxlY3Rvck1vdXNlTW92ZUhhbmRsZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3Rvck1vdXNlTW92ZUhhbmRsZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuc2VsZWN0b3JNb3VzZUxlYXZlSGFuZGxlcikge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdG9yTW91c2VMZWF2ZUhhbmRsZXIoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==