import { Component, ElementRef, HostBinding, Input, Renderer2, ViewChild } from '@angular/core';
import { TiBrowser, TiDateUtil, TiKeymap, Util } from '../../utils/Util';
import { TiLocale, TiLocaleFormat } from '../../locale/TiLocaleModule';
import { TiFormComponent } from '../base/TiBaseModule';
/**
 * @ignore
 */
export class TiDateEditComponent extends TiFormComponent {
    constructor(hostRef, render) {
        super(hostRef, render);
        this.hostRef = hostRef;
        this.render = render;
        /**
         * @ignore
         */
        this.display = 'inline-block';
        this.inputValue = '';
        this.MAX = TiDateUtil.maxDate();
        this.MIN = TiDateUtil.minDate();
    }
    writeValue(value) {
        super.writeValue(value);
        // model为null时，输入框不显示内容
        if (value === null) {
            return;
        }
        // 传入的model值是非日期时，设置为当前日期
        if (!TiDateUtil.isDate(value)) {
            this.model = new Date();
        }
        else if (TiDateUtil.isBigger(value, this.max)) { // 如果大于最大值，设置为最大值
            this.model = this.max;
        }
        else if (TiDateUtil.isSmaller(value, this.min)) { // 小于最小值，设置为最小值
            this.model = this.min;
        }
    }
    // model值变化时的回调: dateedit中inputValue变化时未能及时渲染到页面上
    ngOnModelChange() {
        setTimeout(() => {
            this.formatValue();
        }, 0);
    }
    ngOnInit() {
        super.ngOnInit();
        // 设置聚焦元素为input
        this.setFocusableElems([this.inputRef.nativeElement]);
        // format接口校验:对时间日期进行国际化处理
        this.validateFormat();
        // 最大最小值校验
        this.validateMinAndMax();
        if (!Util.isUndefined(this.format)) {
            this.setPlacehoderText();
        }
        this.oldMinvalue = this.min;
        this.oldMaxvalue = this.max;
    }
    ngOnChanges(changes) {
        // format支持动态变更
        if (changes['format'] && !changes['format'].firstChange) {
            // 新的format是非法时，format值保持之前值不变
            if (!Util.isString(changes['format'].currentValue) && !Util.isString(changes['format'].currentValue.date)) {
                this.format = changes['format'].previousValue;
                return;
            }
            if (!Util.isString(changes['format'].currentValue)) {
                this.format = changes['format'].currentValue.date;
            }
            this.setPlacehoderText();
            this.formatValue();
        }
    }
    /**
     * 不同场景下设置日期输入框placehoder文本
     */
    setPlacehoderText() {
        // 以下是为了处理英文状态下，dateEdit输入时有问题，将其placeholder调整为国际化以后的值
        const englishFormatArr = this.format.match(/M/g);
        // tslint:disable-next-line:newline-per-chained-call
        const formatPureArr = this.format.split(/[-\/\.\_,\s]/).filter(this.filterEmptyFn);
        // 确定其为英文显示月份
        if (Util.isArray(englishFormatArr) && englishFormatArr.length === 3) {
            formatPureArr.length === 3 ? this.placehoderText = 'MM/dd/yyyy' : this.placehoderText = 'MM/yyyy';
        }
        else {
            this.placehoderText = this.format;
        }
    }
    onFocus() {
        // 在输入框聚焦时获取当前合法的model值：
        this.oldModel = this.model;
    }
    onBlur() {
        if (this.oldInputvalue !== this.inputValue) {
            this.handleInputValue();
        }
    }
    onKeydown(event) {
        if (event.keyCode === TiKeymap.KEY_ENTER || event.keyCode === TiKeymap.KEY_NUMPAD_ENTER) {
            this.handleInputValue();
        }
    }
    /**
     * @ignore
     */
    handleInputValue() {
        // blur时拿到输入框的值
        this.inputValue = this.inputRef.nativeElement.value;
        // 校验输入框中值：得到合法的model值
        if (this.inputValue !== '') {
            this.getValidModel();
        }
        else {
            this.model = null; // 当用户输入为空或者为null的情况,model赋值为null
        }
        // 根据model值格式化
        this.formatValue();
        this.oldInputvalue = this.inputValue;
    }
    isValidValue(value) {
        // value值为null时会将输入框清空，是一个合法的value值
        if (value === null) {
            return true;
        }
        // value值为一个Date类型值并且在最大最小值范围内时，是一个合法值
        if (TiDateUtil.isDate(value) &&
            !TiDateUtil.isBigger(value, this.max) && !TiDateUtil.isSmaller(value, this.min)) {
            return true;
        }
        return false;
    }
    /**
     * @ignore
     */
    filterEmptyFn(value) {
        return value !== '';
    }
    // 日期格式校验
    validateFormat() {
        if (Util.isString(this.format) && this.format !== '') {
            return;
        }
        // TODO:如果配置时间日期国际化
        this.format = TiLocale.getLocaleWords().tiLocaleDate['date'];
    }
    // 最大值最小值校验
    validateMinAndMax() {
        // 最大值合法性校验:(时分秒：23:59:59)
        const maxTimeChanged = TiDateUtil.changeMaxTime(this.max);
        this.max = TiDateUtil.isDate(this.max) ? maxTimeChanged : this.MAX;
        // 最小值合法性校验:(时分秒：0:0:0)
        const minTimeChanged = TiDateUtil.changeMinTime(this.min);
        this.min = TiDateUtil.isDate(this.min) ? minTimeChanged : this.MIN;
        // 最大最小值矛盾时，设置为默认值
        if (this.max.getTime() < this.min.getTime()) {
            this.max = this.MAX;
            this.min = this.MIN;
        }
    }
    // 根据model值和format接口，格式化显示时间日期
    formatValue() {
        this.inputValue = (this.model !== null) ? TiLocaleFormat.formatDate(this.model, this.placehoderText) : '';
        this.oldInputvalue = this.inputValue;
    }
    // 校验输入框中的值
    getValidModel() {
        // 支持分隔符:中划线，下划线，点，斜杠
        const reg = new RegExp('[年\\月\\日\\-\\/\\.\\_]');
        const dateArr = this.inputValue.split(reg);
        const formatArr = this.placehoderText.split(reg);
        let dateValue;
        const arr = []; // 保存format格式下年月日的顺序下标；年月日，日月年，月日年，年月。。。
        for (let i = 0; i < formatArr.length; i++) {
            if (formatArr[i].indexOf('y') !== -1) {
                arr[0] = i;
            }
            else if (formatArr[i].indexOf('M') !== -1) {
                arr[1] = i;
            }
            else if (formatArr[i].indexOf('d') !== -1) {
                arr[2] = i;
            }
        }
        // 处理年月情况
        if (arr.length === 2) {
            dateArr[arr[2]] = '1';
        }
        // 浏览器兼容性处理：对于非法日期表现不一致：eg:new Date('2018/13/12'),谷歌和火狐处理为非法日期对象，而IE浏览器会处理为2019/1/12；
        // 获取当前月总天数
        const totalDays = new Date(parseInt(dateArr[arr[0]], 10), parseInt(dateArr[arr[1]], 10), 0).getDate();
        // 将时间日期转换成字符串，原因：2018-3-34 不合法日期，用new Date(2018, 2, 34)生成日期对象，会处理成 ==>2018/4/3
        // 将其转换成字符串形式：new Date('2018/2/34')生成日期对象，处理成 ==>Invalid Date对象
        dateValue = TiBrowser.isIE() && (parseInt(dateArr[arr[1]], 10) > 12 || parseInt(dateArr[arr[2]], 10) > totalDays)
            || (String(new Date(parseInt(dateArr[arr[0]], 10), parseInt(dateArr[arr[1]], 10), parseInt(dateArr[arr[2]], 10))) === 'Invalid Date')
            || dateArr.length > 3 ?
            'Invalid Date' : new Date(`${dateArr[arr[0]]}/${dateArr[arr[1]]}/${dateArr[arr[2]]}`);
        // 1.输入值为不合法日期：2018-3-34;
        // 2.输入值不在最小值最大值范围内;
        // 3.当前输入框中的值，和上次输入框中的值相同时;
        // tslint:disable-next-line:triple-equals
        this.model = String(dateValue) === 'Invalid Date' || !this.isValidValue(dateValue) || this.isDisabledDays(dateValue)
            ? this.oldModel : new Date(TiDateUtil.getDateStr(dateValue));
    }
    /**
     * @ignore
     * 是否为禁用日期
     */
    isDisabledDays(value) {
        let isDisabled = false;
        if (Util.isArray(this.disabledDays) && this.disabledDays.length > 0) {
            this.disabledDays.forEach((item) => {
                if (item.getTime() === value.getTime()) {
                    isDisabled = true;
                }
            });
        }
        return isDisabled;
    }
}
TiDateEditComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-date-edit',
                template: "<input #input\r\n    [placeholder]=\"placehoderText\"\r\n    style=\"width: 100%\"\r\n    type=\"text\"\r\n    maxlength=\"20\"\r\n    [(ngModel)]=\"inputValue\"\r\n    (blur)=\"onBlur()\"\r\n    (focus)=\"onFocus()\"\r\n    [disabled]='disabled'\r\n    (keydown)='onKeydown($event)'\r\n    [id]=\"appendId('input')\"\r\n    tiText>",
                providers: [TiFormComponent.getValueAccessor(TiDateEditComponent)],
                styles: ["::ng-deep :root{--ti-text-clear-width:26px;--ti-text-password-width:36px}:host[tiText]{-ms-box-sizing:border-box;background-color:var(--ti-input-bg-color);border:1px solid var(--ti-input-border-color);border-radius:var(--ti-input-border-radius);box-sizing:border-box;color:var(--ti-input-text-color);flood-color:var(--ti-input-clear-color);font-size:var(--ti-input-font-size);height:var(--ti-input-height);lighting-color:var(--ti-input-clear-color-hover);line-height:normal;outline:none;padding:0 var(--ti-input-padding-horizontal);stop-color:var(--ti-input-clear-color-disabled);vertical-align:middle}:host[tiText].ti3-text-input-show-icon{background-repeat:no-repeat;background-size:16px}:host[tiText].ti3-text-input-show-clear{background-position:center right 5px;padding-right:var(--ti-text-clear-width)!important}:host[tiText].ti3-text-input-show-password{background-position:center right 10px;padding-right:var(--ti-text-password-width)!important}:host[tiText].ti3-text-input-noborder{border:0;box-shadow:none;outline:0}:host[tiText]:not([disabled]):not([noborder]).ti3-text-input-show-icon.ti3-text-clear-active:hover{cursor:pointer}:host[tiText]:not([disabled]):not([noborder]):hover{border:1px solid var(--ti-input-border-color-hover)}:host[tiText]:not([disabled]):not([noborder]):focus{border:1px solid var(--ti-input-border-color-focus)}:host[tiText][disabled]:disabled{background-color:var(--ti-input-bg-color-disabled);border:1px solid var(--ti-input-border-color-disabled);color:var(--ti-input-text-color-disabled);cursor:not-allowed!important}:host[tiText][disabled]:disabled.ti3-text-input-noborder{border:0}.ti3-password-hack-input{height:0;left:-9999px;position:absolute;top:-9999px;width:0}:host[tiText]{transition:border-color .15s}:host[tiText].ti3-text-input-show-icon:focus{transition:transform .15s cubic-bezier(.4,0,.2,1),font-size .15s cubic-bezier(.4,0,.2,1)}:host[tiText]:hover:not(:focus){transition:border-color .2s}"]
            },] }
];
TiDateEditComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
TiDateEditComponent.propDecorators = {
    format: [{ type: Input }],
    min: [{ type: Input }],
    max: [{ type: Input }],
    disabled: [{ type: Input }],
    disabledDays: [{ type: Input }],
    inputRef: [{ type: ViewChild, args: ['input', { static: true },] }],
    display: [{ type: HostBinding, args: ['style.display',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlEYXRlRWRpdENvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9jb21wb25lbnRzL2RhdGVlZGl0L1RpRGF0ZUVkaXRDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxVQUFVLEVBQ1YsV0FBVyxFQUNYLEtBQUssRUFDTCxTQUFTLEVBRVQsU0FBUyxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBaUIsTUFBTSw2QkFBNkIsQ0FBQztBQUN0RixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFdkQ7O0dBRUc7QUFRSCxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsZUFBZTtJQXVCcEQsWUFDYyxPQUFtQixFQUNuQixNQUFpQjtRQUN2QixLQUFLLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRmpCLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFDbkIsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQWhCL0I7O1dBRUc7UUFDMkIsWUFBTyxHQUFXLGNBQWMsQ0FBQztRQU14RCxlQUFVLEdBQVcsRUFBRSxDQUFDO1FBRXhCLFFBQUcsR0FBUyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDakMsUUFBRyxHQUFTLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQU14QyxDQUFDO0lBRUQsVUFBVSxDQUFDLEtBQVc7UUFDbEIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4Qix1QkFBdUI7UUFDdkIsSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE9BQU87U0FDVjtRQUVELHlCQUF5QjtRQUN6QixJQUFJ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LENBQUMsWUFBWSxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2pFLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBVSxFQUFFLEVBQUU7Z0JBQ3JDLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFBRTtvQkFDcEMsVUFBVSxHQUFHLElBQUksQ0FBQztpQkFDckI7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNOO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDdEIsQ0FBQzs7O1lBN1BKLFNBQVMsU0FBQztnQkFDUixRQUFRLEVBQUUsY0FBYztnQkFDeEIsd1ZBQThCO2dCQUU5QixTQUFTLEVBQUUsQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsQ0FBQzs7YUFDcEU7OztZQW5CRyxVQUFVO1lBR1YsU0FBUzs7O3FCQW1CUixLQUFLO2tCQUNMLEtBQUs7a0JBQ0wsS0FBSzt1QkFDTCxLQUFLOzJCQUVMLEtBQUs7dUJBRUwsU0FBUyxTQUFDLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7c0JBSW5DLFdBQVcsU0FBQyxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIENvbXBvbmVudCxcclxuICAgIEVsZW1lbnRSZWYsXHJcbiAgICBIb3N0QmluZGluZyxcclxuICAgIElucHV0LFxyXG4gICAgUmVuZGVyZXIyLFxyXG4gICAgU2ltcGxlQ2hhbmdlcyxcclxuICAgIFZpZXdDaGlsZFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaUJyb3dzZXIsIFRpRGF0ZVV0aWwsIFRpS2V5bWFwLCBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbmltcG9ydCB7IFRpTG9jYWxlLCBUaUxvY2FsZUZvcm1hdCwgVGlMb2NhbGVXb3JkcyB9IGZyb20gJy4uLy4uL2xvY2FsZS9UaUxvY2FsZU1vZHVsZSc7XHJcbmltcG9ydCB7IFRpRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2UvVGlCYXNlTW9kdWxlJztcclxuXHJcbi8qKlxyXG4gKiBAaWdub3JlXHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICAgc2VsZWN0b3I6ICd0aS1kYXRlLWVkaXQnLFxyXG4gICB0ZW1wbGF0ZVVybDogJy4vZGF0ZWVkaXQuaHRtbCcsXHJcbiAgIHN0eWxlVXJsczogWycuLi90ZXh0L3RleHQubGVzcyddLCAvLyDlvJXnlKh0ZXh055qEbGVzc+aWh+S7tlxyXG4gICBwcm92aWRlcnM6IFtUaUZvcm1Db21wb25lbnQuZ2V0VmFsdWVBY2Nlc3NvcihUaURhdGVFZGl0Q29tcG9uZW50KV1cclxufSlcclxuXHJcbmV4cG9ydCBjbGFzcyBUaURhdGVFZGl0Q29tcG9uZW50IGV4dGVuZHMgVGlGb3JtQ29tcG9uZW50IHtcclxuICAgIEBJbnB1dCgpIGZvcm1hdDogc3RyaW5nOyAvLyDorr7nva7ml6XmnJ/mmL7npLrmoLzlvI9cclxuICAgIEBJbnB1dCgpIG1pbjogRGF0ZTsgLy8g6K6+572u5pyA5bCP5pel5pyf5YC8XHJcbiAgICBASW5wdXQoKSBtYXg6IERhdGU7IC8vIOiuvue9ruacgOWkp+aXpeacn+WAvFxyXG4gICAgQElucHV0KCkgZGlzYWJsZWQ6IGJvb2xlYW47IC8vIOaUr+aMgeemgeeUqFxyXG5cclxuICAgIEBJbnB1dCgpIGRpc2FibGVkRGF5czogQXJyYXk8YW55PjtcclxuXHJcbiAgICBAVmlld0NoaWxkKCdpbnB1dCcsIHsgc3RhdGljOiB0cnVlIH0pIGlucHV0UmVmOiBFbGVtZW50UmVmO1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIEBIb3N0QmluZGluZygnc3R5bGUuZGlzcGxheScpIGRpc3BsYXk6IHN0cmluZyA9ICdpbmxpbmUtYmxvY2snO1xyXG5cclxuICAgIHByb3RlY3RlZCBvbGRNaW52YWx1ZTogRGF0ZTtcclxuICAgIHByb3RlY3RlZCBvbGRNYXh2YWx1ZTogRGF0ZTtcclxuICAgIHByaXZhdGUgb2xkTW9kZWw6IERhdGU7XHJcbiAgICBwcml2YXRlIG9sZElucHV0dmFsdWU6IHN0cmluZztcclxuICAgIHB1YmxpYyBpbnB1dFZhbHVlOiBzdHJpbmcgPSAnJztcclxuICAgIHB1YmxpYyBwbGFjZWhvZGVyVGV4dDogc3RyaW5nO1xyXG4gICAgcHVibGljIE1BWDogRGF0ZSA9IFRpRGF0ZVV0aWwubWF4RGF0ZSgpO1xyXG4gICAgcHVibGljIE1JTjogRGF0ZSA9IFRpRGF0ZVV0aWwubWluRGF0ZSgpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByb3RlY3RlZCBob3N0UmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgIHByb3RlY3RlZCByZW5kZXI6IFJlbmRlcmVyMikge1xyXG4gICAgICAgICAgICBzdXBlcihob3N0UmVmLCByZW5kZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHdyaXRlVmFsdWUodmFsdWU6IERhdGUpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci53cml0ZVZhbHVlKHZhbHVlKTtcclxuICAgICAgICAvLyBtb2RlbOS4um51bGzml7bvvIzovpPlhaXmoYbkuI3mmL7npLrlhoXlrrlcclxuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5Lyg5YWl55qEbW9kZWzlgLzmmK/pnZ7ml6XmnJ/ml7bvvIzorr7nva7kuLrlvZPliY3ml6XmnJ9cclxuICAgICAgICBpZiAoIVRpRGF0ZVV0aWwuaXNEYXRlKHZhbHVlKSkge1xyXG4gICAgICAgICAgICB0aGlzLm1vZGVsID0gbmV3IERhdGUoKTtcclxuICAgICAgICB9IGVsc2UgaWYgKFRpRGF0ZVV0aWwuaXNCaWdnZXIodmFsdWUsIHRoaXMubWF4KSkgeyAvLyDlpoLmnpzlpKfkuo7mnIDlpKflgLzvvIzorr7nva7kuLrmnIDlpKflgLxcclxuICAgICAgICAgICAgdGhpcy5tb2RlbCA9IHRoaXMubWF4O1xyXG4gICAgICAgIH0gZWxzZSBpZiAoVGlEYXRlVXRpbC5pc1NtYWxsZXIodmFsdWUsIHRoaXMubWluKSkgeyAvLyDlsI/kuo7mnIDlsI/lgLzvvIzorr7nva7kuLrmnIDlsI/lgLxcclxuICAgICAgICAgICAgdGhpcy5tb2RlbCA9IHRoaXMubWluO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBtb2RlbOWAvOWPmOWMluaXtueahOWbnuiwgzogZGF0ZWVkaXTkuK1pbnB1dFZhbHVl5Y+Y5YyW5pe25pyq6IO95Y+K5pe25riy5p+T5Yiw6aG16Z2i5LiKXHJcbiAgICBuZ09uTW9kZWxDaGFuZ2UoKTogdm9pZCB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybWF0VmFsdWUoKTtcclxuICAgICAgICB9LCAwKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG4gICAgICAgIC8vIOiuvue9ruiBmueEpuWFg+e0oOS4umlucHV0XHJcbiAgICAgICAgdGhpcy5zZXRGb2N1c2FibGVFbGVtcyhbdGhpcy5pbnB1dFJlZi5uYXRpdmVFbGVtZW50XSk7XHJcbiAgICAgICAgLy8gZm9ybWF05o6l5Y+j5qCh6aqMOuWvueaXtumXtOaXpeacn+i/m+ihjOWbvemZheWMluWkhOeQhlxyXG4gICAgICAgIHRoaXMudmFsaWRhdGVGb3JtYXQoKTtcclxuXHJcbiAgICAgICAgLy8g5pyA5aSn5pyA5bCP5YC85qCh6aqMXHJcbiAgICAgICAgdGhpcy52YWxpZGF0ZU1pbkFuZE1heCgpO1xyXG5cclxuICAgICAgICBpZiAoIVV0aWwuaXNVbmRlZmluZWQodGhpcy5mb3JtYXQpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UGxhY2Vob2RlclRleHQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMub2xkTWludmFsdWUgPSB0aGlzLm1pbjtcclxuICAgICAgICB0aGlzLm9sZE1heHZhbHVlID0gdGhpcy5tYXg7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIC8vIGZvcm1hdOaUr+aMgeWKqOaAgeWPmOabtFxyXG4gICAgICAgIGlmIChjaGFuZ2VzWydmb3JtYXQnXSAmJiAhY2hhbmdlc1snZm9ybWF0J10uZmlyc3RDaGFuZ2UpIHtcclxuICAgICAgICAgICAgLy8g5paw55qEZm9ybWF05piv6Z2e5rOV5pe277yMZm9ybWF05YC85L+d5oyB5LmL5YmN5YC85LiN5Y+YXHJcbiAgICAgICAgICAgIGlmICghVXRpbC5pc1N0cmluZyhjaGFuZ2VzWydmb3JtYXQnXS5jdXJyZW50VmFsdWUpICYmICFVdGlsLmlzU3RyaW5nKGNoYW5nZXNbJ2Zvcm1hdCddLmN1cnJlbnRWYWx1ZS5kYXRlKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQgPSBjaGFuZ2VzWydmb3JtYXQnXS5wcmV2aW91c1ZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIVV0aWwuaXNTdHJpbmcoY2hhbmdlc1snZm9ybWF0J10uY3VycmVudFZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQgPSBjaGFuZ2VzWydmb3JtYXQnXS5jdXJyZW50VmFsdWUuZGF0ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldFBsYWNlaG9kZXJUZXh0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybWF0VmFsdWUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOS4jeWQjOWcuuaZr+S4i+iuvue9ruaXpeacn+i+k+WFpeahhnBsYWNlaG9kZXLmlofmnKxcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzZXRQbGFjZWhvZGVyVGV4dCgpOiB2b2lkIHtcclxuICAgICAgICAvLyDku6XkuIvmmK/kuLrkuoblpITnkIboi7HmlofnirbmgIHkuIvvvIxkYXRlRWRpdOi+k+WFpeaXtuaciemXrumimO+8jOWwhuWFtnBsYWNlaG9sZGVy6LCD5pW05Li65Zu96ZmF5YyW5Lul5ZCO55qE5YC8XHJcbiAgICAgICAgY29uc3QgZW5nbGlzaEZvcm1hdEFycjogYW55ID0gdGhpcy5mb3JtYXQubWF0Y2goL00vZyk7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5ld2xpbmUtcGVyLWNoYWluZWQtY2FsbFxyXG4gICAgICAgIGNvbnN0IGZvcm1hdFB1cmVBcnI6IGFueSA9IHRoaXMuZm9ybWF0LnNwbGl0KC9bLVxcL1xcLlxcXyxcXHNdLykuZmlsdGVyKHRoaXMuZmlsdGVyRW1wdHlGbik7XHJcbiAgICAgICAgLy8g56Gu5a6a5YW25Li66Iux5paH5pi+56S65pyI5Lu9XHJcbiAgICAgICAgaWYgKFV0aWwuaXNBcnJheShlbmdsaXNoRm9ybWF0QXJyKSAmJiBlbmdsaXNoRm9ybWF0QXJyLmxlbmd0aCA9PT0gMykge1xyXG4gICAgICAgICAgICBmb3JtYXRQdXJlQXJyLmxlbmd0aCA9PT0gMyA/IHRoaXMucGxhY2Vob2RlclRleHQgPSAnTU0vZGQveXl5eScgOiB0aGlzLnBsYWNlaG9kZXJUZXh0ID0gJ01NL3l5eXknO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucGxhY2Vob2RlclRleHQgPSB0aGlzLmZvcm1hdDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25Gb2N1cygpOiB2b2lkIHtcclxuICAgICAgICAvLyDlnKjovpPlhaXmoYbogZrnhKbml7bojrflj5blvZPliY3lkIjms5XnmoRtb2RlbOWAvO+8mlxyXG4gICAgICAgIHRoaXMub2xkTW9kZWwgPSB0aGlzLm1vZGVsO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQmx1cigpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5vbGRJbnB1dHZhbHVlICE9PSB0aGlzLmlucHV0VmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5oYW5kbGVJbnB1dFZhbHVlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9uS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSBUaUtleW1hcC5LRVlfRU5URVIgIHx8IGV2ZW50LmtleUNvZGUgPT09IFRpS2V5bWFwLktFWV9OVU1QQURfRU5URVIpIHtcclxuICAgICAgICAgICAgdGhpcy5oYW5kbGVJbnB1dFZhbHVlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIGhhbmRsZUlucHV0VmFsdWUoKTogdm9pZCB7XHJcbiAgICAgICAgLy8gYmx1cuaXtuaLv+WIsOi+k+WFpeahhueahOWAvFxyXG4gICAgICAgIHRoaXMuaW5wdXRWYWx1ZSA9IHRoaXMuaW5wdXRSZWYubmF0aXZlRWxlbWVudC52YWx1ZTtcclxuICAgICAgICAvLyDmoKHpqozovpPlhaXmoYbkuK3lgLzvvJrlvpfliLDlkIjms5XnmoRtb2RlbOWAvFxyXG4gICAgICAgIGlmICh0aGlzLmlucHV0VmFsdWUgIT09ICcnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0VmFsaWRNb2RlbCgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubW9kZWwgPSBudWxsOyAvLyDlvZPnlKjmiLfovpPlhaXkuLrnqbrmiJbogIXkuLpudWxs55qE5oOF5Ya1LG1vZGVs6LWL5YC85Li6bnVsbFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5qC55o2ubW9kZWzlgLzmoLzlvI/ljJZcclxuICAgICAgICB0aGlzLmZvcm1hdFZhbHVlKCk7XHJcbiAgICAgICAgdGhpcy5vbGRJbnB1dHZhbHVlID0gdGhpcy5pbnB1dFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGlzVmFsaWRWYWx1ZSh2YWx1ZTogRGF0ZSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIC8vIHZhbHVl5YC85Li6bnVsbOaXtuS8muWwhui+k+WFpeahhua4heepuu+8jOaYr+S4gOS4quWQiOazleeahHZhbHVl5YC8XHJcbiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdmFsdWXlgLzkuLrkuIDkuKpEYXRl57G75Z6L5YC85bm25LiU5Zyo5pyA5aSn5pyA5bCP5YC86IyD5Zu05YaF5pe277yM5piv5LiA5Liq5ZCI5rOV5YC8XHJcbiAgICAgICAgaWYgKFRpRGF0ZVV0aWwuaXNEYXRlKHZhbHVlKSAmJlxyXG4gICAgICAgICAgICAhVGlEYXRlVXRpbC5pc0JpZ2dlcih2YWx1ZSwgdGhpcy5tYXgpICYmICFUaURhdGVVdGlsLmlzU21hbGxlcih2YWx1ZSwgdGhpcy5taW4pKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyAgZmlsdGVyRW1wdHlGbih2YWx1ZTogYW55KTogYW55IHtcclxuICAgICAgICByZXR1cm4gdmFsdWUgIT09ICcnO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOaXpeacn+agvOW8j+agoemqjFxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUZvcm1hdCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAoVXRpbC5pc1N0cmluZyh0aGlzLmZvcm1hdCkgJiYgdGhpcy5mb3JtYXQgIT09ICcnKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gVE9ETzrlpoLmnpzphY3nva7ml7bpl7Tml6XmnJ/lm73pmYXljJZcclxuICAgICAgICB0aGlzLmZvcm1hdCA9IChUaUxvY2FsZS5nZXRMb2NhbGVXb3JkcygpIGFzIFRpTG9jYWxlV29yZHMpLnRpTG9jYWxlRGF0ZVsnZGF0ZSddO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOacgOWkp+WAvOacgOWwj+WAvOagoemqjFxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZU1pbkFuZE1heCgpOiB2b2lkIHtcclxuICAgICAgICAvLyDmnIDlpKflgLzlkIjms5XmgKfmoKHpqow6KOaXtuWIhuenku+8mjIzOjU5OjU5KVxyXG4gICAgICAgIGNvbnN0IG1heFRpbWVDaGFuZ2VkOiBEYXRlID0gVGlEYXRlVXRpbC5jaGFuZ2VNYXhUaW1lKHRoaXMubWF4KTtcclxuICAgICAgICB0aGlzLm1heCA9IFRpRGF0ZVV0aWwuaXNEYXRlKHRoaXMubWF4KSA/IG1heFRpbWVDaGFuZ2VkIDogdGhpcy5NQVg7XHJcblxyXG4gICAgICAgIC8vIOacgOWwj+WAvOWQiOazleaAp+agoemqjDoo5pe25YiG56eS77yaMDowOjApXHJcbiAgICAgICAgY29uc3QgbWluVGltZUNoYW5nZWQ6IERhdGUgPSBUaURhdGVVdGlsLmNoYW5nZU1pblRpbWUodGhpcy5taW4pO1xyXG4gICAgICAgIHRoaXMubWluID0gVGlEYXRlVXRpbC5pc0RhdGUodGhpcy5taW4pID8gbWluVGltZUNoYW5nZWQgOiB0aGlzLk1JTjtcclxuXHJcbiAgICAgICAgLy8g5pyA5aSn5pyA5bCP5YC855+b55u+5pe277yM6K6+572u5Li66buY6K6k5YC8XHJcbiAgICAgICAgaWYgKHRoaXMubWF4LmdldFRpbWUoKSA8IHRoaXMubWluLmdldFRpbWUoKSkge1xyXG4gICAgICAgICAgICB0aGlzLm1heCA9IHRoaXMuTUFYO1xyXG4gICAgICAgICAgICB0aGlzLm1pbiA9IHRoaXMuTUlOO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDmoLnmja5tb2RlbOWAvOWSjGZvcm1hdOaOpeWPo++8jOagvOW8j+WMluaYvuekuuaXtumXtOaXpeacn1xyXG4gICAgcHVibGljIGZvcm1hdFZhbHVlKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaW5wdXRWYWx1ZSA9ICh0aGlzLm1vZGVsICE9PSBudWxsKSA/IFRpTG9jYWxlRm9ybWF0LmZvcm1hdERhdGUodGhpcy5tb2RlbCwgdGhpcy5wbGFjZWhvZGVyVGV4dCkgOiAnJztcclxuICAgICAgICB0aGlzLm9sZElucHV0dmFsdWUgPSB0aGlzLmlucHV0VmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5qCh6aqM6L6T5YWl5qGG5Lit55qE5YC8XHJcbiAgICBwcml2YXRlIGdldFZhbGlkTW9kZWwoKTogdm9pZCB7XHJcbiAgICAgICAgLy8g5pSv5oyB5YiG6ZqU56ymOuS4reWIkue6v++8jOS4i+WIkue6v++8jOeCue+8jOaWnOadoFxyXG4gICAgICAgIGNvbnN0IHJlZzogUmVnRXhwID0gbmV3IFJlZ0V4cCgnW+W5tFxcXFzmnIhcXFxc5pelXFxcXC1cXFxcL1xcXFwuXFxcXF9dJyk7XHJcbiAgICAgICAgY29uc3QgZGF0ZUFycjogQXJyYXk8c3RyaW5nPiA9IHRoaXMuaW5wdXRWYWx1ZS5zcGxpdChyZWcpO1xyXG4gICAgICAgIGNvbnN0IGZvcm1hdEFycjogQXJyYXk8c3RyaW5nPiA9IHRoaXMucGxhY2Vob2RlclRleHQuc3BsaXQocmVnKTtcclxuICAgICAgICBsZXQgZGF0ZVZhbHVlOiBhbnk7XHJcbiAgICAgICAgY29uc3QgYXJyOiBBcnJheTxudW1iZXI+ID0gW107IC8vIOS/neWtmGZvcm1hdOagvOW8j+S4i+W5tOaciOaXpeeahOmhuuW6j+S4i+agh++8m+W5tOaciOaXpe+8jOaXpeaciOW5tO+8jOaciOaXpeW5tO+8jOW5tOaciOOAguOAguOAglxyXG4gICAgICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCBmb3JtYXRBcnIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKGZvcm1hdEFycltpXS5pbmRleE9mKCd5JykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBhcnJbMF0gPSBpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdEFycltpXS5pbmRleE9mKCdNJykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBhcnJbMV0gPSBpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdEFycltpXS5pbmRleE9mKCdkJykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBhcnJbMl0gPSBpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWkhOeQhuW5tOaciOaDheWGtVxyXG4gICAgICAgIGlmIChhcnIubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgIGRhdGVBcnJbYXJyWzJdXSA9ICcxJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOa1j+iniOWZqOWFvOWuueaAp+WkhOeQhu+8muWvueS6jumdnuazleaXpeacn+ihqOeOsOS4jeS4gOiHtO+8mmVnOm5ldyBEYXRlKCcyMDE4LzEzLzEyJyks6LC35q2M5ZKM54Gr54uQ5aSE55CG5Li66Z2e5rOV5pel5pyf5a+56LGh77yM6ICMSUXmtY/op4jlmajkvJrlpITnkIbkuLoyMDE5LzEvMTLvvJtcclxuICAgICAgICAvLyDojrflj5blvZPliY3mnIjmgLvlpKnmlbBcclxuICAgICAgICBjb25zdCB0b3RhbERheXM6IG51bWJlciA9IG5ldyBEYXRlKHBhcnNlSW50KGRhdGVBcnJbYXJyWzBdXSwgMTApLCBwYXJzZUludChkYXRlQXJyW2FyclsxXV0sIDEwKSwgMCkuZ2V0RGF0ZSgpO1xyXG5cclxuICAgICAgICAvLyDlsIbml7bpl7Tml6XmnJ/ovazmjaLmiJDlrZfnrKbkuLLvvIzljp/lm6DvvJoyMDE4LTMtMzQg5LiN5ZCI5rOV5pel5pyf77yM55SobmV3IERhdGUoMjAxOCwgMiwgMzQp55Sf5oiQ5pel5pyf5a+56LGh77yM5Lya5aSE55CG5oiQID09PjIwMTgvNC8zXHJcbiAgICAgICAgLy8g5bCG5YW26L2s5o2i5oiQ5a2X56ym5Liy5b2i5byP77yabmV3IERhdGUoJzIwMTgvMi8zNCcp55Sf5oiQ5pel5pyf5a+56LGh77yM5aSE55CG5oiQID09PkludmFsaWQgRGF0ZeWvueixoVxyXG4gICAgICAgIGRhdGVWYWx1ZSA9IFRpQnJvd3Nlci5pc0lFKCkgJiYgKHBhcnNlSW50KGRhdGVBcnJbYXJyWzFdXSwgMTApID4gMTIgfHwgcGFyc2VJbnQoZGF0ZUFyclthcnJbMl1dLCAxMCkgPiB0b3RhbERheXMpXHJcbiAgICAgICAgICAgfHwgKFN0cmluZyhuZXcgRGF0ZShwYXJzZUludChkYXRlQXJyW2FyclswXV0sIDEwKSwgcGFyc2VJbnQoZGF0ZUFyclthcnJbMV1dLCAxMCksIHBhcnNlSW50KGRhdGVBcnJbYXJyWzJdXSwgMTApKSkgPT09ICdJbnZhbGlkIERhdGUnKVxyXG4gICAgICAgICAgIHx8IGRhdGVBcnIubGVuZ3RoID4gMyA/XHJcbiAgICAgICAgICAgICAgICAgICAgJ0ludmFsaWQgRGF0ZScgOiBuZXcgRGF0ZShgJHtkYXRlQXJyW2FyclswXV19LyR7ZGF0ZUFyclthcnJbMV1dfS8ke2RhdGVBcnJbYXJyWzJdXX1gKTtcclxuXHJcbiAgICAgICAgLy8gMS7ovpPlhaXlgLzkuLrkuI3lkIjms5Xml6XmnJ/vvJoyMDE4LTMtMzQ7XHJcbiAgICAgICAgLy8gMi7ovpPlhaXlgLzkuI3lnKjmnIDlsI/lgLzmnIDlpKflgLzojIPlm7TlhoU7XHJcbiAgICAgICAgLy8gMy7lvZPliY3ovpPlhaXmoYbkuK3nmoTlgLzvvIzlkozkuIrmrKHovpPlhaXmoYbkuK3nmoTlgLznm7jlkIzml7Y7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnRyaXBsZS1lcXVhbHNcclxuICAgICAgICB0aGlzLm1vZGVsID0gU3RyaW5nKGRhdGVWYWx1ZSkgPT09ICdJbnZhbGlkIERhdGUnIHx8ICF0aGlzLmlzVmFsaWRWYWx1ZShkYXRlVmFsdWUpIHx8IHRoaXMuaXNEaXNhYmxlZERheXMoZGF0ZVZhbHVlKVxyXG4gICAgICAgID8gdGhpcy5vbGRNb2RlbCA6IG5ldyBEYXRlKFRpRGF0ZVV0aWwuZ2V0RGF0ZVN0cihkYXRlVmFsdWUpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaYr+WQpuS4uuemgeeUqOaXpeacn1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaXNEaXNhYmxlZERheXModmFsdWU6IERhdGUpOiBib29sZWFuIHtcclxuICAgICAgICBsZXQgaXNEaXNhYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgICAgIGlmIChVdGlsLmlzQXJyYXkodGhpcy5kaXNhYmxlZERheXMpICYmIHRoaXMuZGlzYWJsZWREYXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5kaXNhYmxlZERheXMuZm9yRWFjaCgoaXRlbTogRGF0ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0uZ2V0VGltZSgpID09PSB2YWx1ZS5nZXRUaW1lKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc0Rpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaXNEaXNhYmxlZDtcclxuICAgIH1cclxufVxyXG4iXX0=