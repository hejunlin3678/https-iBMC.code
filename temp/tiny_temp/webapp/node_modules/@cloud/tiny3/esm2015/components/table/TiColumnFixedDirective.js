import { Directive, ElementRef, NgZone, Renderer2, Input } from '@angular/core';
import { TiRenderer } from '../../services/renderer/TiRenderer';
import { TiTableComponent } from './TiTableComponent';
import { TiBrowser } from '../../utils/Util';
/**
 * tiColumnFixed 表格列固定(IE和Edge浏览器不支持)
 *
 * 适用场景：对于列数很多的表格，可以固定前后列，横向滚动查看其它数据。
 *
 * 规范：左侧支持最多3列固定(3列不包含单选/复选框所在列)，右侧支持最多1列固定。横向滚动条贯穿左右，与表格最左和最右对齐。
 * 表格下展场景不需要支持列固定。
 *
 * 9.0.4新增
 */
export class TiColumnFixedDirective {
    constructor(renderer, elementRef, tiRenderer, tableCom, zone) {
        this.renderer = renderer;
        this.tiRenderer = tiRenderer;
        this.tableCom = tableCom;
        this.zone = zone;
        this.columnFixedLeftLast = false;
        this.floatingFixedColumn = false;
        this.firstAfterViewChecked = true;
        this.element = elementRef.nativeElement;
    }
    ngOnInit() {
        // IE 不支持粘性定位position: sticky，使用其他定位方式有闪动，目前无法解决； EDGE 固定列边框不显示， 表头固定时拖动横向滚动条表头横向平移不及时
        this.notSupportBrowser = TiBrowser.isIE() || TiBrowser.isEdge();
        if (this.notSupportBrowser || !this.type) {
            return;
        }
        if (!this.tableCom.fixedColumnInfo.container) {
            const container = this.tiRenderer.findChildrenByClassName(this.tableCom.hostEle, 'ti3-table-container')[0];
            if (!container) {
                return;
            }
            this.tableCom.fixedColumnInfo.container = container;
        }
        this.tableCom.fixedColumnInfo.hasFixedColumn = true;
        this.tagName = this.element.tagName;
        if (this.type === 'right' && this.tagName === 'TH') {
            // 表头固定需要此参数
            this.tableCom.fixedColumnInfo.thFixedRight = this.element;
        }
        this.addBehavior();
    }
    ngAfterViewChecked() {
        if (this.notSupportBrowser || !this.type || !this.firstAfterViewChecked) {
            return;
        }
        this.firstAfterViewChecked = false;
        this.init();
    }
    ngOnDestroy() {
        if (this.containerScrollXChangeSubscription) {
            this.containerScrollXChangeSubscription.unsubscribe();
        }
        if (this.thResizeSubscription) {
            this.thResizeSubscription.unsubscribe();
        }
        if (this.updateFixedThLeftSubscription) {
            this.updateFixedThLeftSubscription.unsubscribe();
        }
        if (this.updateFixedTdLeftSubscription) {
            this.updateFixedTdLeftSubscription.unsubscribe();
        }
    }
    init() {
        if (this.type === 'left') {
            if (this.tagName === 'TH') {
                this.processTh();
            }
            else {
                this.processTd();
            }
        }
        if (this.tagName === 'TH') {
            this.zone.runOutsideAngular(() => {
                // 表头初始时容器的滚动状态还未初始完成
                setTimeout(() => {
                    const scrollLeft = this.tableCom.fixedColumnInfo.container.scrollLeft;
                    const isRightColumnFloat = scrollLeft + this.tableCom.fixedColumnInfo.container.clientWidth < this.tableCom.fixedColumnInfo.container.scrollWidth;
                    this.tableCom.containerScrollXChangeSubject.next({
                        scrollLeft,
                        isRightColumnFloat
                    });
                }, 0);
            });
        }
        else {
            const scrollLeft = this.tableCom.fixedColumnInfo.container.scrollLeft;
            const isRightColumnFloat = scrollLeft + this.tableCom.fixedColumnInfo.container.clientWidth < this.tableCom.fixedColumnInfo.container.scrollWidth;
            this.tableCom.containerScrollXChangeSubject.next({
                scrollLeft,
                isRightColumnFloat
            });
        }
    }
    addBehavior() {
        // 处理左右固定的最后一列是否有阴影(看起来有浮动效果)
        this.containerScrollXChangeSubscription = this.tableCom.containerScrollXChangeSubject.subscribe((scrollInfo) => {
            if (this.type === 'right' && scrollInfo.isRightColumnFloat !== this.floatingFixedColumn) {
                this.processLastFixedColumn(this.element, scrollInfo.isRightColumnFloat);
            }
            if (this.type === 'left' && this.columnFixedLeftLast && (scrollInfo.scrollLeft > 0) !== this.floatingFixedColumn) {
                this.processLastFixedColumn(this.element, scrollInfo.scrollLeft > 0);
            }
        });
        // 处理左侧固定的列的left值(左侧可多列固定)
        if (this.type === 'left' && this.tagName === 'TH') {
            this.thResizeSubscription = this.tableCom.thResizeSubject.subscribe((thResizeInfo) => {
                const th = thResizeInfo.th;
                if (th !== this.element) {
                    return;
                }
                const nextSibling = th.nextElementSibling;
                if (nextSibling && this.tiRenderer.hasClass(nextSibling, 'ti3-table-column-fixed-left')) {
                    const siblings = th.parentElement.children;
                    const index = Array.from(siblings)
                        .indexOf(th);
                    const changeColumnsIndex = [];
                    for (let i = index + 1; i < siblings.length; i++) {
                        if (!siblings[i] || !this.tiRenderer.hasClass(siblings[i], 'ti3-table-column-fixed-left')) {
                            break;
                        }
                        changeColumnsIndex.push(i);
                        this.tableCom.fixedColumnInfo.fixedColumnLeftValues[i] += thResizeInfo.leftEdge;
                        this.renderer.setStyle(siblings[i], 'left', `${this.tableCom.fixedColumnInfo.fixedColumnLeftValues[i]}px`);
                    }
                    const bodyTable = this.tableCom.isFixedHead ? thResizeInfo.resizableOpts.secondTable : thResizeInfo.resizableOpts.table;
                    const trs = Array.from(bodyTable.children[1].children)
                        .filter((tr) => {
                        return this.needFixedColumnTr(tr);
                    });
                    trs.forEach((tr) => {
                        changeColumnsIndex.forEach((columnIndex) => {
                            this.renderer.setStyle(tr.children[columnIndex], 'left', `${this.tableCom.fixedColumnInfo.fixedColumnLeftValues[columnIndex]}px`);
                        });
                    });
                }
            });
            this.updateFixedThLeftSubscription = this.tableCom.updateFixedThLeftSubject.subscribe(() => {
                this.processTh();
            });
        }
        if (this.type === 'left' && this.tagName === 'TD') {
            this.updateFixedTdLeftSubscription = this.tableCom.updateFixedTdLeftSubject.subscribe(() => {
                this.processTd();
            });
        }
    }
    processTd() {
        const siblings = this.element.parentElement.children;
        const index = Array.from(siblings)
            .indexOf(this.element);
        // 进行判空处理，因为有可能是td元素先出现。
        // TODO: 考虑下processTd和processTd是否可以使用相同的处理方式。
        if (this.tableCom.fixedColumnInfo.fixedColumnLeftValues && this.tableCom.fixedColumnInfo.fixedColumnLeftValues.length &&
            this.tableCom.fixedColumnInfo.fixedColumnLeftValues[index] !== this.tdLeft) {
            this.tdLeft = this.tableCom.fixedColumnInfo.fixedColumnLeftValues[index];
            this.renderer.setStyle(this.element, 'left', `${this.tdLeft}px`);
        }
        if (index === this.tableCom.fixedColumnInfo.columnFixedLeftLastIndex) {
            this.columnFixedLeftLast = true;
        }
    }
    processTh() {
        const siblings = this.element.parentElement.children;
        let left = 0;
        this.tableCom.fixedColumnInfo.fixedColumnLeftValues = [];
        // tslint:disable-next-line:prefer-for-of
        for (let i = 0; i < siblings.length; i++) {
            const current = siblings[i];
            if (this.tableCom.fixedColumnInfo.fixedColumnLeftValues[i] !== left) {
                this.tableCom.fixedColumnInfo.fixedColumnLeftValues[i] = left;
                this.renderer.setStyle(current, 'left', `${left}px`);
            }
            // offsetWidth 包括边框
            left += current.offsetWidth;
            const nextSibling = siblings[i + 1];
            if (nextSibling && !this.tiRenderer.hasClass(nextSibling, 'ti3-table-column-fixed-left')) {
                this.columnFixedLeftLast = true;
                this.tableCom.fixedColumnInfo.columnFixedLeftLastIndex = i;
                break;
            }
            else {
                this.columnFixedLeftLast = false;
            }
        }
    }
    processLastFixedColumn(ele, add) {
        if (add) {
            this.floatingFixedColumn = true;
            this.renderer.addClass(ele, 'ti3-table-floating-fixed-column');
        }
        else {
            this.floatingFixedColumn = false;
            this.renderer.removeClass(ele, 'ti3-table-floating-fixed-column');
        }
    }
    needFixedColumnTr(tr) {
        if (!tr) {
            return false;
        }
        const classes = ['ti3-details-tr', 'ti3-table-nodata', 'ti3-table-loadfail',
            'ti3-table-nodata-guide', 'ti3-table-nodata-simple'];
        for (const className of classes) {
            if (this.tiRenderer.hasClass(tr, className)) {
                return false;
            }
        }
        return true;
    }
}
TiColumnFixedDirective.decorators = [
    { type: Directive, args: [{
                // tslint:disable-next-line:component-selector
                selector: 'th[tiColumnFixed], td[tiColumnFixed]',
                host: {
                    '[class.ti3-table-column-fixed-right]': "!notSupportBrowser && type === 'right'",
                    '[class.ti3-table-column-fixed-left]': "!notSupportBrowser && type === 'left'"
                }
            },] }
];
TiColumnFixedDirective.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: TiRenderer },
    { type: TiTableComponent },
    { type: NgZone }
];
TiColumnFixedDirective.propDecorators = {
    type: [{ type: Input, args: ['tiColumnFixed',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlDb2x1bW5GaXhlZERpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9jb21wb25lbnRzL3RhYmxlL1RpQ29sdW1uRml4ZWREaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVILFNBQVMsRUFDVCxVQUFVLEVBQ1YsTUFBTSxFQUdOLFNBQVMsRUFDVCxLQUFLLEVBQ1IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUU3Qzs7Ozs7Ozs7O0dBU0c7QUFTSCxNQUFNLE9BQU8sc0JBQXNCO0lBb0IvQixZQUFvQixRQUFtQixFQUFFLFVBQXNCLEVBQVUsVUFBc0IsRUFDM0UsUUFBMEIsRUFBVSxJQUFZO1FBRGhELGFBQVEsR0FBUixRQUFRLENBQVc7UUFBa0MsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUMzRSxhQUFRLEdBQVIsUUFBUSxDQUFrQjtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7UUFaNUQsd0JBQW1CLEdBQVksS0FBSyxDQUFDO1FBQ3JDLHdCQUFtQixHQUFZLEtBQUssQ0FBQztRQUNyQywwQkFBcUIsR0FBWSxJQUFJLENBQUM7UUFXMUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDO0lBQzVDLENBQUM7SUFFRCxRQUFRO1FBQ0osc0ZBQXNGO1FBQ3RGLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hFLElBQUksSUFBSSxDQUFDLGlCQUFpQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUN0QyxP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SUFBSSxHQUFHLEVBQUU7WUFDTCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxpQ0FBaUMsQ0FBQyxDQUFDO1NBQ2xFO2FBQU07WUFDSCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsS0FBSyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxpQ0FBaUMsQ0FBQyxDQUFDO1NBQ3JFO0lBQ0wsQ0FBQztJQUVPLGlCQUFpQixDQUFDLEVBQU87UUFDN0IsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNMLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsTUFBTSxPQUFPLEdBQWtCLENBQUMsZ0JBQWdCLEVBQUUsa0JBQWtCLEVBQUUsb0JBQW9CO1lBQ3RGLHdCQUF3QixFQUFFLHlCQUF5QixDQUFDLENBQUM7UUFDekQsS0FBSyxNQUFNLFNBQVMsSUFBSSxPQUFPLEVBQUU7WUFDN0IsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLEVBQUU7Z0JBQ3pDLE9BQU8sS0FBSyxDQUFDO2FBQ2hCO1NBQ0o7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzs7WUFqUEosU0FBUyxTQUFDO2dCQUNQLDhDQUE4QztnQkFDOUMsUUFBUSxFQUFFLHNDQUFzQztnQkFDaEQsSUFBSSxFQUFFO29CQUNGLHNDQUFzQyxFQUFFLHdDQUF3QztvQkFDaEYscUNBQXFDLEVBQUUsdUNBQXVDO2lCQUNqRjthQUNKOzs7WUF4QkcsU0FBUztZQUpULFVBQVU7WUFPTCxVQUFVO1lBQ1YsZ0JBQWdCO1lBUHJCLE1BQU07OzttQkFpQ0wsS0FBSyxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgQWZ0ZXJWaWV3Q2hlY2tlZCxcclxuICAgIERpcmVjdGl2ZSxcclxuICAgIEVsZW1lbnRSZWYsXHJcbiAgICBOZ1pvbmUsXHJcbiAgICBPbkluaXQsXHJcbiAgICBPbkRlc3Ryb3ksXHJcbiAgICBSZW5kZXJlcjIsXHJcbiAgICBJbnB1dFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaVJlbmRlcmVyIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcmVuZGVyZXIvVGlSZW5kZXJlcic7XHJcbmltcG9ydCB7IFRpVGFibGVDb21wb25lbnQgfSBmcm9tICcuL1RpVGFibGVDb21wb25lbnQnO1xyXG5pbXBvcnQgeyBUaUJyb3dzZXIgfSBmcm9tICcuLi8uLi91dGlscy9VdGlsJztcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbi8qKlxyXG4gKiB0aUNvbHVtbkZpeGVkIOihqOagvOWIl+WbuuWumihJReWSjEVkZ2XmtY/op4jlmajkuI3mlK/mjIEpXHJcbiAqXHJcbiAqIOmAgueUqOWcuuaZr++8muWvueS6juWIl+aVsOW+iOWkmueahOihqOagvO+8jOWPr+S7peWbuuWumuWJjeWQjuWIl++8jOaoquWQkea7muWKqOafpeeci+WFtuWug+aVsOaNruOAglxyXG4gKlxyXG4gKiDop4TojIPvvJrlt6bkvqfmlK/mjIHmnIDlpJoz5YiX5Zu65a6aKDPliJfkuI3ljIXlkKvljZXpgIkv5aSN6YCJ5qGG5omA5Zyo5YiXKe+8jOWPs+S+p+aUr+aMgeacgOWkmjHliJflm7rlrprjgILmqKrlkJHmu5rliqjmnaHotK/nqb/lt6blj7PvvIzkuI7ooajmoLzmnIDlt6blkozmnIDlj7Plr7npvZDjgIJcclxuICog6KGo5qC85LiL5bGV5Zy65pmv5LiN6ZyA6KaB5pSv5oyB5YiX5Zu65a6a44CCXHJcbiAqXHJcbiAqIDkuMC405paw5aKeXHJcbiAqL1xyXG5ARGlyZWN0aXZlKHtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpjb21wb25lbnQtc2VsZWN0b3JcclxuICAgIHNlbGVjdG9yOiAndGhbdGlDb2x1bW5GaXhlZF0sIHRkW3RpQ29sdW1uRml4ZWRdJyxcclxuICAgIGhvc3Q6IHtcclxuICAgICAgICAnW2NsYXNzLnRpMy10YWJsZS1jb2x1bW4tZml4ZWQtcmlnaHRdJzogXCIhbm90U3VwcG9ydEJyb3dzZXIgJiYgdHlwZSA9PT0gJ3JpZ2h0J1wiLFxyXG4gICAgICAgICdbY2xhc3MudGkzLXRhYmxlLWNvbHVtbi1maXhlZC1sZWZ0XSc6IFwiIW5vdFN1cHBvcnRCcm93c2VyICYmIHR5cGUgPT09ICdsZWZ0J1wiXHJcbiAgICB9XHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUaUNvbHVtbkZpeGVkRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdDaGVja2VkLCBPbkRlc3Ryb3kge1xyXG4gICAgLyoqXHJcbiAgICAgKiB0aUNvbHVtbkZpeGVkIOW8gOWQr+WIl+WbuuWumuWKn+iDve+8m+aOpeWPo+S8oOWFpSBsZWZ0IOS4uuWcqOW3puS+p+WbuuWumizlt6bkvqflj6/ov57nu63lpJrliJflm7rlrprvvIzkuJTlv4Xpobvku47nrKzkuIDliJflvIDlp4vlm7rlrprvvJtcclxuICAgICAqIOaOpeWPo+S8oOWFpSByaWdodCDkuLrlnKjlj7Pkvqflm7rlrprvvIzlj7Pkvqflj6rog73lm7rlrprkuIDliJfvvIzkuJTlv4XpobvmmK/mnIDlkI7kuIDliJc7IOaOpeWPo+S8oOWFpeWFtuS7luWAvOS4jeS8muW8gOWQr+WbuuWumuWKn+iDveOAglxyXG4gICAgICovXHJcbiAgICBASW5wdXQoJ3RpQ29sdW1uRml4ZWQnKSB0eXBlOiAncmlnaHQnIHwgJ2xlZnQnO1xyXG4gICAgcHJpdmF0ZSB0YWdOYW1lOiAnVEgnIHwgJ1REJztcclxuICAgIHByaXZhdGUgdGRMZWZ0OiBudW1iZXI7XHJcbiAgICBwcml2YXRlIGVsZW1lbnQ6IGFueTtcclxuICAgIHByaXZhdGUgY29sdW1uRml4ZWRMZWZ0TGFzdDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBmbG9hdGluZ0ZpeGVkQ29sdW1uOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIGZpcnN0QWZ0ZXJWaWV3Q2hlY2tlZDogYm9vbGVhbiA9IHRydWU7XHJcbiAgICBwcml2YXRlIGNvbnRhaW5lclNjcm9sbFhDaGFuZ2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICAgIHByaXZhdGUgdGhSZXNpemVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICAgIHByaXZhdGUgdXBkYXRlRml4ZWRUaExlZnRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICAgIHByaXZhdGUgdXBkYXRlRml4ZWRUZExlZnRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgbm90U3VwcG9ydEJyb3dzZXI6IGJvb2xlYW47XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgdGlSZW5kZXJlcjogVGlSZW5kZXJlcixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgdGFibGVDb206IFRpVGFibGVDb21wb25lbnQsIHByaXZhdGUgem9uZTogTmdab25lKSB7XHJcbiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgICAgIC8vIElFIOS4jeaUr+aMgeeymOaAp+WumuS9jXBvc2l0aW9uOiBzdGlja3nvvIzkvb/nlKjlhbbku5blrprkvY3mlrnlvI/mnInpl6rliqjvvIznm67liY3ml6Dms5Xop6PlhrPvvJsgRURHRSDlm7rlrprliJfovrnmoYbkuI3mmL7npLrvvIwg6KGo5aS05Zu65a6a5pe25ouW5Yqo5qiq5ZCR5rua5Yqo5p2h6KGo5aS05qiq5ZCR5bmz56e75LiN5Y+K5pe2XHJcbiAgICAgICAgdGhpcy5ub3RTdXBwb3J0QnJvd3NlciA9IFRpQnJvd3Nlci5pc0lFKCkgfHwgVGlCcm93c2VyLmlzRWRnZSgpO1xyXG4gICAgICAgIGlmICh0aGlzLm5vdFN1cHBvcnRCcm93c2VyIHx8ICF0aGlzLnR5cGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5jb250YWluZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyOiBhbnkgPSB0aGlzLnRpUmVuZGVyZXIuZmluZENoaWxkcmVuQnlDbGFzc05hbWUodGhpcy50YWJsZUNvbS5ob3N0RWxlLCAndGkzLXRhYmxlLWNvbnRhaW5lcicpWzBdO1xyXG4gICAgICAgICAgICBpZiAoIWNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudGFibGVDb20uZml4ZWRDb2x1bW5JbmZvLmNvbnRhaW5lciA9IGNvbnRhaW5lcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudGFibGVDb20uZml4ZWRDb2x1bW5JbmZvLmhhc0ZpeGVkQ29sdW1uID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgdGhpcy50YWdOYW1lID0gdGhpcy5lbGVtZW50LnRhZ05hbWU7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnR5cGUgPT09ICdyaWdodCcgJiYgdGhpcy50YWdOYW1lID09PSAnVEgnKSB7XHJcbiAgICAgICAgICAgIC8vIOihqOWktOWbuuWumumcgOimgeatpOWPguaVsFxyXG4gICAgICAgICAgICB0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby50aEZpeGVkUmlnaHQgPSB0aGlzLmVsZW1lbnQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmFkZEJlaGF2aW9yKCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3Q2hlY2tlZCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5ub3RTdXBwb3J0QnJvd3NlciB8fCAhdGhpcy50eXBlIHx8ICF0aGlzLmZpcnN0QWZ0ZXJWaWV3Q2hlY2tlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZpcnN0QWZ0ZXJWaWV3Q2hlY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuaW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbnRhaW5lclNjcm9sbFhDaGFuZ2VTdWJzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5jb250YWluZXJTY3JvbGxYQ2hhbmdlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKClcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMudGhSZXNpemVTdWJzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy50aFJlc2l6ZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZUZpeGVkVGhMZWZ0U3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlRml4ZWRUaExlZnRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy51cGRhdGVGaXhlZFRkTGVmdFN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUZpeGVkVGRMZWZ0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0KCkgOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy50eXBlID09PSAnbGVmdCcpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudGFnTmFtZSA9PT0gJ1RIJykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzVGgoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1RkKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBpZiAodGhpcy50YWdOYW1lID09PSAnVEgnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyDooajlpLTliJ3lp4vml7blrrnlmajnmoTmu5rliqjnirbmgIHov5jmnKrliJ3lp4vlrozmiJBcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNjcm9sbExlZnQ6IG51bWJlciA9IHRoaXMudGFibGVDb20uZml4ZWRDb2x1bW5JbmZvLmNvbnRhaW5lci5zY3JvbGxMZWZ0O1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzUmlnaHRDb2x1bW5GbG9hdDogYm9vbGVhbiA9IHNjcm9sbExlZnQgKyB0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5jb250YWluZXIuY2xpZW50V2lkdGggPCB0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5jb250YWluZXIuc2Nyb2xsV2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJsZUNvbS5jb250YWluZXJTY3JvbGxYQ2hhbmdlU3ViamVjdC5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNSaWdodENvbHVtbkZsb2F0XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3Qgc2Nyb2xsTGVmdDogbnVtYmVyID0gdGhpcy50YWJsZUNvbS5maXhlZENvbHVtbkluZm8uY29udGFpbmVyLnNjcm9sbExlZnQ7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzUmlnaHRDb2x1bW5GbG9hdDogYm9vbGVhbiA9IHNjcm9sbExlZnQgKyB0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5jb250YWluZXIuY2xpZW50V2lkdGggPCB0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5jb250YWluZXIuc2Nyb2xsV2lkdGg7XHJcbiAgICAgICAgICAgIHRoaXMudGFibGVDb20uY29udGFpbmVyU2Nyb2xsWENoYW5nZVN1YmplY3QubmV4dCh7XHJcbiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0LFxyXG4gICAgICAgICAgICAgICAgaXNSaWdodENvbHVtbkZsb2F0XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFkZEJlaGF2aW9yKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOWkhOeQhuW3puWPs+WbuuWumueahOacgOWQjuS4gOWIl+aYr+WQpuaciemYtOW9sSjnnIvotbfmnaXmnInmta7liqjmlYjmnpwpXHJcbiAgICAgICAgdGhpcy5jb250YWluZXJTY3JvbGxYQ2hhbmdlU3Vic2NyaXB0aW9uID0gdGhpcy50YWJsZUNvbS5jb250YWluZXJTY3JvbGxYQ2hhbmdlU3ViamVjdC5zdWJzY3JpYmUoKHNjcm9sbEluZm86IGFueSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ3JpZ2h0JyAmJiBzY3JvbGxJbmZvLmlzUmlnaHRDb2x1bW5GbG9hdCAhPT0gdGhpcy5mbG9hdGluZ0ZpeGVkQ29sdW1uKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NMYXN0Rml4ZWRDb2x1bW4odGhpcy5lbGVtZW50LCBzY3JvbGxJbmZvLmlzUmlnaHRDb2x1bW5GbG9hdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2xlZnQnICYmIHRoaXMuY29sdW1uRml4ZWRMZWZ0TGFzdCAmJiAoc2Nyb2xsSW5mby5zY3JvbGxMZWZ0ID4gMCkgIT09IHRoaXMuZmxvYXRpbmdGaXhlZENvbHVtbikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzTGFzdEZpeGVkQ29sdW1uKHRoaXMuZWxlbWVudCwgc2Nyb2xsSW5mby5zY3JvbGxMZWZ0ID4gMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8g5aSE55CG5bem5L6n5Zu65a6a55qE5YiX55qEbGVmdOWAvCjlt6bkvqflj6/lpJrliJflm7rlrpopXHJcbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2xlZnQnICYmIHRoaXMudGFnTmFtZSA9PT0gJ1RIJykge1xyXG4gICAgICAgICAgICB0aGlzLnRoUmVzaXplU3Vic2NyaXB0aW9uID0gdGhpcy50YWJsZUNvbS50aFJlc2l6ZVN1YmplY3Quc3Vic2NyaWJlKCh0aFJlc2l6ZUluZm86IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGg6IGFueSA9IHRoUmVzaXplSW5mby50aDtcclxuICAgICAgICAgICAgICAgIGlmICh0aCAhPT0gdGhpcy5lbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRTaWJsaW5nOiBhbnkgPSB0aC5uZXh0RWxlbWVudFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICBpZiAobmV4dFNpYmxpbmcgJiYgdGhpcy50aVJlbmRlcmVyLmhhc0NsYXNzKG5leHRTaWJsaW5nLCAndGkzLXRhYmxlLWNvbHVtbi1maXhlZC1sZWZ0JykpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzaWJsaW5nczogYW55ID0gdGgucGFyZW50RWxlbWVudC5jaGlsZHJlbjtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleDogbnVtYmVyID0gQXJyYXkuZnJvbShzaWJsaW5ncylcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmluZGV4T2YodGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5nZUNvbHVtbnNJbmRleDogQXJyYXk8bnVtYmVyPiA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGk6IG51bWJlciA9IGluZGV4ICsgMTsgaSA8IHNpYmxpbmdzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2libGluZ3NbaV0gfHwgIXRoaXMudGlSZW5kZXJlci5oYXNDbGFzcyhzaWJsaW5nc1tpXSwgJ3RpMy10YWJsZS1jb2x1bW4tZml4ZWQtbGVmdCcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VDb2x1bW5zSW5kZXgucHVzaChpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJsZUNvbS5maXhlZENvbHVtbkluZm8uZml4ZWRDb2x1bW5MZWZ0VmFsdWVzW2ldICs9IHRoUmVzaXplSW5mby5sZWZ0RWRnZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShzaWJsaW5nc1tpXSwgJ2xlZnQnLCBgJHt0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5maXhlZENvbHVtbkxlZnRWYWx1ZXNbaV19cHhgKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYm9keVRhYmxlOiBhbnkgPSB0aGlzLnRhYmxlQ29tLmlzRml4ZWRIZWFkID8gdGhSZXNpemVJbmZvLnJlc2l6YWJsZU9wdHMuc2Vjb25kVGFibGUgOiB0aFJlc2l6ZUluZm8ucmVzaXphYmxlT3B0cy50YWJsZTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0cnM6IEFycmF5PGFueT4gPSBBcnJheS5mcm9tKGJvZHlUYWJsZS5jaGlsZHJlblsxXS5jaGlsZHJlbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigodHI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmVlZEZpeGVkQ29sdW1uVHIodHIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB0cnMuZm9yRWFjaCgodHI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VDb2x1bW5zSW5kZXguZm9yRWFjaCgoY29sdW1uSW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0ci5jaGlsZHJlbltjb2x1bW5JbmRleF0sICdsZWZ0JywgYCR7dGhpcy50YWJsZUNvbS5maXhlZENvbHVtbkluZm8uZml4ZWRDb2x1bW5MZWZ0VmFsdWVzW2NvbHVtbkluZGV4XX1weGApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUZpeGVkVGhMZWZ0U3Vic2NyaXB0aW9uID0gdGhpcy50YWJsZUNvbS51cGRhdGVGaXhlZFRoTGVmdFN1YmplY3Quc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1RoKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ2xlZnQnICYmIHRoaXMudGFnTmFtZSA9PT0gJ1REJykge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUZpeGVkVGRMZWZ0U3Vic2NyaXB0aW9uID0gdGhpcy50YWJsZUNvbS51cGRhdGVGaXhlZFRkTGVmdFN1YmplY3Quc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1RkKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NUZCgpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBzaWJsaW5nczogYW55ID0gdGhpcy5lbGVtZW50LnBhcmVudEVsZW1lbnQuY2hpbGRyZW47XHJcbiAgICAgICAgY29uc3QgaW5kZXg6IG51bWJlciA9IEFycmF5LmZyb20oc2libGluZ3MpXHJcbiAgICAgICAgICAgIC5pbmRleE9mKHRoaXMuZWxlbWVudCk7XHJcbiAgICAgICAgLy8g6L+b6KGM5Yik56m65aSE55CG77yM5Zug5Li65pyJ5Y+v6IO95pivdGTlhYPntKDlhYjlh7rnjrDjgIJcclxuICAgICAgICAvLyBUT0RPOiDogIPomZHkuItwcm9jZXNzVGTlkoxwcm9jZXNzVGTmmK/lkKblj6/ku6Xkvb/nlKjnm7jlkIznmoTlpITnkIbmlrnlvI/jgIJcclxuICAgICAgICBpZiAodGhpcy50YWJsZUNvbS5maXhlZENvbHVtbkluZm8uZml4ZWRDb2x1bW5MZWZ0VmFsdWVzICYmIHRoaXMudGFibGVDb20uZml4ZWRDb2x1bW5JbmZvLmZpeGVkQ29sdW1uTGVmdFZhbHVlcy5sZW5ndGggJiZcclxuICAgICAgICAgICAgdGhpcy50YWJsZUNvbS5maXhlZENvbHVtbkluZm8uZml4ZWRDb2x1bW5MZWZ0VmFsdWVzW2luZGV4XSAhPT0gdGhpcy50ZExlZnQpIHtcclxuICAgICAgICAgICAgdGhpcy50ZExlZnQgPSB0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5maXhlZENvbHVtbkxlZnRWYWx1ZXNbaW5kZXhdO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuZWxlbWVudCwgJ2xlZnQnLCBgJHt0aGlzLnRkTGVmdH1weGApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGluZGV4ID09PSB0aGlzLnRhYmxlQ29tLmZpeGVkQ29sdW1uSW5mby5jb2x1bW5GaXhlZExlZnRMYXN0SW5kZXgpIHtcclxuICAgICAgICAgICAgdGhpcy5jb2x1bW5GaXhlZExlZnRMYXN0ID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwcm9jZXNzVGgoKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3Qgc2libGluZ3M6IGFueSA9IHRoaXMuZWxlbWVudC5wYXJlbnRFbGVtZW50LmNoaWxkcmVuO1xyXG4gICAgICAgIGxldCBsZWZ0OiBudW1iZXIgPSAwO1xyXG4gICAgICAgIHRoaXMudGFibGVDb20uZml4ZWRDb2x1bW5JbmZvLmZpeGVkQ29sdW1uTGVmdFZhbHVlcyA9IFtdO1xyXG5cclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJlZmVyLWZvci1vZlxyXG4gICAgICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCBzaWJsaW5ncy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50OiBhbnkgPSBzaWJsaW5nc1tpXTtcclxuICAgICAgICAgICAgaWYgKHRoaXMudGFibGVDb20uZml4ZWRDb2x1bW5JbmZvLmZpeGVkQ29sdW1uTGVmdFZhbHVlc1tpXSAhPT0gbGVmdCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50YWJsZUNvbS5maXhlZENvbHVtbkluZm8uZml4ZWRDb2x1bW5MZWZ0VmFsdWVzW2ldID0gbGVmdDtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoY3VycmVudCwgJ2xlZnQnLCBgJHtsZWZ0fXB4YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gb2Zmc2V0V2lkdGgg5YyF5ous6L655qGGXHJcbiAgICAgICAgICAgIGxlZnQgKz0gY3VycmVudC5vZmZzZXRXaWR0aDtcclxuICAgICAgICAgICAgY29uc3QgbmV4dFNpYmxpbmc6IGFueSA9IHNpYmxpbmdzW2kgKyAxXTtcclxuICAgICAgICAgICAgaWYgKG5leHRTaWJsaW5nICYmICF0aGlzLnRpUmVuZGVyZXIuaGFzQ2xhc3MobmV4dFNpYmxpbmcsICd0aTMtdGFibGUtY29sdW1uLWZpeGVkLWxlZnQnKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2x1bW5GaXhlZExlZnRMYXN0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMudGFibGVDb20uZml4ZWRDb2x1bW5JbmZvLmNvbHVtbkZpeGVkTGVmdExhc3RJbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29sdW1uRml4ZWRMZWZ0TGFzdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcHJvY2Vzc0xhc3RGaXhlZENvbHVtbihlbGU6IGFueSwgYWRkOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGFkZCkge1xyXG4gICAgICAgICAgICB0aGlzLmZsb2F0aW5nRml4ZWRDb2x1bW4gPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKGVsZSwgJ3RpMy10YWJsZS1mbG9hdGluZy1maXhlZC1jb2x1bW4nKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmZsb2F0aW5nRml4ZWRDb2x1bW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyhlbGUsICd0aTMtdGFibGUtZmxvYXRpbmctZml4ZWQtY29sdW1uJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbmVlZEZpeGVkQ29sdW1uVHIodHI6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghdHIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjbGFzc2VzOiBBcnJheTxzdHJpbmc+ID0gWyd0aTMtZGV0YWlscy10cicsICd0aTMtdGFibGUtbm9kYXRhJywgJ3RpMy10YWJsZS1sb2FkZmFpbCcsXHJcbiAgICAgICAgICAgICd0aTMtdGFibGUtbm9kYXRhLWd1aWRlJywgJ3RpMy10YWJsZS1ub2RhdGEtc2ltcGxlJ107XHJcbiAgICAgICAgZm9yIChjb25zdCBjbGFzc05hbWUgb2YgY2xhc3Nlcykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy50aVJlbmRlcmVyLmhhc0NsYXNzKHRyLCBjbGFzc05hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==