import { Component, ContentChild, ElementRef, Input, TemplateRef, ViewChild } from '@angular/core';
import { TiDominatorComponent } from '../dominator/TiDominatorModule';
import { TiFormComponent } from '../base/TiBaseModule';
import { TiDropsearchComponent } from '../dropsearch/TiDropsearchModule';
import { TiKeymap } from '../../utils/Util';
/**
 * TagsInput标签输入组件
 *
 * TagsInput组件主要实现了一个可以输入标签、可以联想选择标签的功能组件。
 *
 * <example-url>../tiny3demo/#/tagsinput/tagsinput-all</example-url>
 */
export class TiTagsInputComponent extends TiFormComponent {
    constructor() {
        super(...arguments);
        /**
         * 设置联想词条列表的数据
         */
        this.suggestions = [];
        /**
         * 设置输入框提示,在设置提示内容，并且无选中项时显示
         */
        this.placeholder = '';
        /**
         * 设置下拉面板的宽度,默认与dominator对齐 'justified' | 'auto'| string
         */
        this.panelWidth = 'justified';
        /**
         * 支持指定属性作为显示文本
         */
        this.labelKey = 'label';
        /**
         * @ignore
         * input输入框的值
         */
        this.inputValue = ''; // 输入框内容
    }
    ngAfterViewInit() {
        super.ngAfterViewInit();
        // 推荐在onInit()时调用setFocusableElems(), 但是ngFor/ngIf中的元素在ngAfterViewInit()才能获取到
        this.setFocusableElems([this.dominatorCom.nativeElement, this.inputRef.nativeElement]);
    }
    /**
     * @ignore
     * 处理select事件
     */
    onSelect(event) {
        this.model.push(event);
        this.model = this.model.concat();
        this.selectDrop.searchResult = this.getSuggestions(this.suggestions, this.model);
        // 清空输入框
        this.inputValue = '';
        // 选中项由一行变为两行时，需要重定位
        setTimeout(() => {
            this.selectDrop.rePosition();
        }, 0);
    }
    /**
     * @ignore
     * 处理点击Dominator事件
     */
    onClickDominator() {
        if (this.disabled) {
            return;
        }
        this.inputRef.nativeElement.focus();
    }
    /**
     * @ignore
     * 点击选中项的叉号:从选中项中移除当前选中项
     */
    onDelete(event) {
        this.inputRef.nativeElement.focus();
        // 选中项由两行变为一行时，需要重定位
        setTimeout(() => {
            this.selectDrop.rePosition();
        }, 0);
        this.selectDrop.searchResult = this.getSuggestions(this.suggestions, event.model);
    }
    /**
     * @ignore
     * 输入框失焦时，面板隐藏，根据文本框内容处理是否添加到选中项
     */
    onInputBlur() {
        this.selectDrop.hide();
        const value = this.inputValue;
        // 清空输入框
        this.inputValue = '';
        // 输入框为空时或者当前输入框内容对应的标签已经在选中列表中了
        if (value.trim() === '' || this.findFirstIndex(this.model, 'label', value) !== -1) {
            return;
        }
        // 将输入框内容添加到选中标签中
        this.addTagToSelected(value);
    }
    /**
     * @ignore
     * 处理input框聚焦事件
     */
    onInputFocus(event) {
        this.selectDrop.searchResult = this.getSuggestions(this.suggestions, this.model);
        // 视图绘制早于变量更新，变量更新后下拉定位不正确， 需要延时处理
        setTimeout(() => {
            this.showSelectDrop();
        }, 0);
    }
    /**
     * @ignore
     * 处理input输入框keyup快捷键功能
     */
    onInputKeyup(event) {
        if (event.keyCode === TiKeymap.KEY_ENTER || event.keyCode === TiKeymap.KEY_NUMPAD_ENTER) {
            this.responseEnter(event);
        }
    }
    /**
     * @ignore
     * 处理input输入框keydown快捷键功能
     * 回删键只能在keydown中处理：因为回删时，在keydown时输入框为当前值，keyup时为删除后的值
     * 比如输入一个字符，回删，获取的应该是回删前的一个字符，而不是没有删除后的
     */
    onInputKeydown(event) {
        if (event.keyCode === TiKeymap.KEY_BACKSPACE) {
            this.responseBackspace(event);
        }
    }
    /**
     * @ignore
     * 输入框内容变化时的处理
     * @param inputValue
     */
    onInputChange(inputValue) {
        // 过滤出匹配项
        this.selectDrop.searchWordChange(inputValue);
        // 从匹配项中移除已选中项
        this.selectDrop.searchResult = this.getSuggestions(this.selectDrop.searchResult, this.model);
        // 当没有匹配项时面板隐藏
        if (this.selectDrop.searchResult.length === 0) {
            this.selectDrop.hide();
        }
    }
    /**
     * 处理input输入框enter键功能
     * @param event
     */
    responseEnter(event) {
        this.selectDrop.hide();
        // 获取输入框的值
        const value = this.inputValue;
        // 清空input框的内容
        this.inputValue = '';
        // 输入框为空时或者当前输入框内容对应的标签已经在选中列表中了
        if (value.trim() === '' || this.findFirstIndex(this.model, 'label', value) !== -1) {
            this.showSelectDrop();
            return;
        }
        // 将输入框内容添加到选中标签中
        this.addTagToSelected(value);
        // 将选中项与下拉选项对比，从下拉选项中提出选中项
        this.selectDrop.searchResult = this.getSuggestions(this.suggestions, this.model);
        this.showSelectDrop();
    }
    /**
     * 处理input输入框回删键功能
     * @param event
     */
    responseBackspace(event) {
        this.selectDrop.hide();
        // 面板关闭时
        if (!this.selectDrop.isShow) {
            this.showSelectDrop();
            // 选中项由两行变为一行时，需要重定位
            setTimeout(() => {
                this.selectDrop.rePosition();
            }, 0);
        }
        const value = this.inputRef.nativeElement.value;
        // 输入框值不为空字符串时
        if (value !== '') {
            return;
        }
        // 获取当前选中项的长度
        const modelLength = this.model.length;
        // 当前已经没有选中项时，不做处理
        if (modelLength === 0) {
            return;
        }
        const lastSelected = this.model[modelLength - 1];
        const index = this.suggestions.indexOf(lastSelected);
        // 从选中项中删除
        this.model.pop();
        this.model = this.model.concat();
        // 将要从选中项删除的最后一项是下拉选项中的一项时，将其添加到现有的下拉选项中;
        // 如果是用户自己创建的，则不放入下拉项中
        if (index !== -1) {
            this.selectDrop.searchResult = this.getSuggestions(this.suggestions, this.model);
        }
    }
    /**
     * 根据数组中属性找是否有匹配项
     * @param arr 需要匹配的数组
     * @param key 需要查找的属性
     * @param value 属性值
     * @returns
     */
    findFirstIndex(arr, key, value) {
        if (!(arr instanceof Array)) {
            return -1;
        }
        for (let i = 0; i < arr.length; i++) {
            if (arr[i][key] === value) {
                return i;
            }
        }
        return -1;
    }
    /**
     * 将输入框内容添加到选中标签中
     * @param inputValue 输入框的内容
     */
    addTagToSelected(inputValue) {
        const index = this.findFirstIndex(this.suggestions, 'label', inputValue);
        const newTag = index === -1 ? { id: inputValue, label: inputValue } : this.suggestions[index];
        this.model.push(newTag);
        this.model = this.model.concat();
    }
    /**
     * 从suggestions中删除选中项
     */
    getSuggestions(suggestions, selected) {
        const newSuggestions = !(suggestions instanceof Array) ? [] : suggestions.concat(); // 使用数组的concat方法，实现深拷贝
        let index;
        for (const select of selected) {
            index = newSuggestions.indexOf(select);
            if (index !== -1) { // 选中项如果在下拉列表中存在，则删除
                newSuggestions.splice(index, 1);
            }
        }
        return newSuggestions;
    }
    /**
     * @ignore
     * 展开面板时设置下拉选中项和hoverOption
     */
    showSelectDrop() {
        // 设置selectDrop的选中项
        this.selectDrop.listCom.model = undefined;
        // 显示下拉面板
        if (this.selectDrop.searchResult.length > 0) {
            this.selectDrop.show();
        }
        // 不设置待选中项
        this.selectDrop.listCom.hoverOption = undefined;
    }
}
TiTagsInputComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-tags-input',
                template: "<ti-dominator\r\n                type=\"tagsinput\"\r\n                multiple=\"true\"\r\n                class=\"ti3-dominator-tagsinput\"\r\n                [id]=\"appendId('dominator')\"\r\n                [(ngModel)]=\"model\"\r\n                [disabled]= \"disabled\"\r\n                (delete)=\"onDelete($event)\"\r\n                (focus)=\"onClickDominator()\"\r\n                (click)=\"onClickDominator()\">\r\n                <ng-template let-item>\r\n                        <ng-container *ngTemplateOutlet=\"commonTemplate; context: {$implicit: item}\">\r\n                        </ng-container>\r\n                </ng-template>\r\n                <input  #input\r\n                        tiText\r\n                        noborder\r\n                        type=\"text\"\r\n                        autocorrect=\"off\"\r\n                        autocapitalize=\"off\"\r\n                        spellcheck=\"false\"\r\n                        [disabled]= \"disabled\"\r\n                        [placeholder]=\"model && model.length === 0 ? placeholder : ''\"\r\n                        [(ngModel)]=\"inputValue\"\r\n                        (ngModelChange)=\"onInputChange($event)\"\r\n                        [ngStyle]=\"{width: (model && model.length === 0) || (inputValue.length > 0) ? '100%' : '21px'}\"\r\n                        (focus)=\"onInputFocus($event)\"\r\n                        (blur)=\"onInputBlur()\"\r\n                        (keyup)=\"onInputKeyup($event)\"\r\n                        (keydown)=\"onInputKeydown($event)\">\r\n</ti-dominator>\r\n<ti-dropsearch\r\n                type=\"suggestion\"\r\n                [id]=\"appendId('droplist')\"\r\n                [labelKey]=\"labelKey\"\r\n                [panelWidth]=\"panelWidth\"\r\n                [options]=\"suggestions\"\r\n                [dominatorElem]=\"dominatorCom.nativeElement\"\r\n                [isShowAfterSelect]=\"true\"\r\n                (select)=\"onSelect($event)\">\r\n                <ng-template let-item let-i=index>\r\n                        <ng-container *ngTemplateOutlet=\"commonTemplate; context: {$implicit: item, index: i}\"></ng-container>\r\n                 </ng-template>\r\n</ti-dropsearch>\r\n\r\n<ng-template #commonTemplate let-item let-i=index>\r\n        <ng-container *ngIf=\"itemTemplate else labelTemplate\">\r\n                <ng-container *ngTemplateOutlet=\"itemTemplate; context: {$implicit: item, index: i}\">\r\n                </ng-container>\r\n        </ng-container>\r\n        <ng-template #labelTemplate><span [title]=\"item[labelKey]\">{{item[labelKey]}}</span></ng-template>\r\n</ng-template>\r\n",
                providers: [TiFormComponent.getValueAccessor(TiTagsInputComponent)],
                styles: [".ti3-compnent-container-border,:host{-ms-box-sizing:border-box;border:1px solid;border-radius:var(--ti-input-border-radius);box-sizing:border-box;display:inline-block}.ti3-compnent-container-border:not([disabled]),:host:not([disabled]){background-color:var(--ti-input-bg-color);border-color:var(--ti-input-border-color)}.ti3-compnent-container-border:not([disabled]):hover,:host:not([disabled]):hover{border-color:var(--ti-input-border-color-hover)}.ti3-compnent-container-border:not([disabled])[tiFocused],:host:not([disabled])[tiFocused]{border-color:var(--ti-input-border-color-focus)}.ti3-compnent-container-border[disabled],:host[disabled]{background-color:var(--ti-input-bg-color-disabled);border-color:var(--ti-input-border-color-disabled);cursor:not-allowed!important}.ti3-dominator-tagsinput input[tiText]{-ms-box-sizing:border-box;background-color:transparent;box-sizing:border-box;color:var(--ti-common-color-text-primary);float:left;height:calc(var(--ti-input-height) - 4px);max-width:160px;padding:0 var(--ti-input-padding-horizontal)}"]
            },] }
];
TiTagsInputComponent.propDecorators = {
    suggestions: [{ type: Input }],
    placeholder: [{ type: Input }],
    panelWidth: [{ type: Input }],
    labelKey: [{ type: Input }],
    inputRef: [{ type: ViewChild, args: ['input', { static: true },] }],
    itemTemplate: [{ type: ContentChild, args: [TemplateRef, /* TODO: add static flag */ { static: true },] }],
    dominatorCom: [{ type: ViewChild, args: [TiDominatorComponent, { static: true },] }],
    selectDrop: [{ type: ViewChild, args: [TiDropsearchComponent, { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlUYWdzSW5wdXRDb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueTMvY29tcG9uZW50cy90YWdzaW5wdXQvVGlUYWdzSW5wdXRDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNELFNBQVMsRUFDVCxZQUFZLEVBQ1osVUFBVSxFQUNWLEtBQUssRUFDTCxXQUFXLEVBQ1gsU0FBUyxFQUNkLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN6RSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDNUM7Ozs7OztHQU1HO0FBUUgsTUFBTSxPQUFPLG9CQUFxQixTQUFRLGVBQWU7SUFQekQ7O1FBUU07O1dBRUc7UUFDTSxnQkFBVyxHQUFlLEVBQUUsQ0FBQztRQUN0Qzs7V0FFRztRQUNNLGdCQUFXLEdBQVcsRUFBRSxDQUFDO1FBQ2xDOztXQUVHO1FBQ00sZUFBVSxHQUFXLFdBQVcsQ0FBQztRQUMxQzs7V0FFRztRQUNNLGFBQVEsR0FBVyxPQUFPLENBQUM7UUFzQnBDOzs7V0FHRztRQUNJLGVBQVUsR0FBVyxFQUFFLENBQUMsQ0FBQyxRQUFRO0lBMlA5QyxDQUFDO0lBelBLLGVBQWU7UUFDVCxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDeEIsNkVBQTZFO1FBQzdFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUM3RixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsUUFBUSxDQUFD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cUJBQXFCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgICAgQ29tcG9uZW50LFxyXG4gICAgICBDb250ZW50Q2hpbGQsXHJcbiAgICAgIEVsZW1lbnRSZWYsXHJcbiAgICAgIElucHV0LFxyXG4gICAgICBUZW1wbGF0ZVJlZixcclxuICAgICAgVmlld0NoaWxkXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRpRG9taW5hdG9yQ29tcG9uZW50IH0gZnJvbSAnLi4vZG9taW5hdG9yL1RpRG9taW5hdG9yTW9kdWxlJztcclxuaW1wb3J0IHsgVGlGb3JtQ29tcG9uZW50IH0gZnJvbSAnLi4vYmFzZS9UaUJhc2VNb2R1bGUnO1xyXG5pbXBvcnQgeyBUaURyb3BzZWFyY2hDb21wb25lbnQgfSBmcm9tICcuLi9kcm9wc2VhcmNoL1RpRHJvcHNlYXJjaE1vZHVsZSc7XHJcbmltcG9ydCB7IFRpS2V5bWFwIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbi8qKlxyXG4gKiBUYWdzSW5wdXTmoIfnrb7ovpPlhaXnu4Tku7ZcclxuICpcclxuICogVGFnc0lucHV057uE5Lu25Li76KaB5a6e546w5LqG5LiA5Liq5Y+v5Lul6L6T5YWl5qCH562+44CB5Y+v5Lul6IGU5oOz6YCJ5oup5qCH562+55qE5Yqf6IO957uE5Lu244CCXHJcbiAqXHJcbiAqIDxleGFtcGxlLXVybD4uLi90aW55M2RlbW8vIy90YWdzaW5wdXQvdGFnc2lucHV0LWFsbDwvZXhhbXBsZS11cmw+XHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICAgICAgc2VsZWN0b3I6ICd0aS10YWdzLWlucHV0JyxcclxuICAgICAgdGVtcGxhdGVVcmw6ICcuL3RhZ3NpbnB1dC5odG1sJyxcclxuICAgICAgc3R5bGVVcmxzOiBbJy4vdGFnc2lucHV0Lmxlc3MnXSxcclxuICAgICAgcHJvdmlkZXJzOiBbVGlGb3JtQ29tcG9uZW50LmdldFZhbHVlQWNjZXNzb3IoVGlUYWdzSW5wdXRDb21wb25lbnQpXVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIFRpVGFnc0lucHV0Q29tcG9uZW50IGV4dGVuZHMgVGlGb3JtQ29tcG9uZW50IHtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIOiuvue9ruiBlOaDs+ivjeadoeWIl+ihqOeahOaVsOaNrlxyXG4gICAgICAgKi9cclxuICAgICAgQElucHV0KCkgc3VnZ2VzdGlvbnM6IEFycmF5PGFueT4gPSBbXTtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIOiuvue9rui+k+WFpeahhuaPkOekuizlnKjorr7nva7mj5DnpLrlhoXlrrnvvIzlubbkuJTml6DpgInkuK3pobnml7bmmL7npLpcclxuICAgICAgICovXHJcbiAgICAgIEBJbnB1dCgpIHBsYWNlaG9sZGVyOiBzdHJpbmcgPSAnJztcclxuICAgICAgLyoqXHJcbiAgICAgICAqIOiuvue9ruS4i+aLiemdouadv+eahOWuveW6pizpu5jorqTkuI5kb21pbmF0b3Llr7npvZAgJ2p1c3RpZmllZCcgfCAnYXV0byd8IHN0cmluZ1xyXG4gICAgICAgKi9cclxuICAgICAgQElucHV0KCkgcGFuZWxXaWR0aDogc3RyaW5nID0gJ2p1c3RpZmllZCc7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiDmlK/mjIHmjIflrprlsZ7mgKfkvZzkuLrmmL7npLrmlofmnKxcclxuICAgICAgICovXHJcbiAgICAgIEBJbnB1dCgpIGxhYmVsS2V5OiBzdHJpbmcgPSAnbGFiZWwnO1xyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIEBpZ25vcmVcclxuICAgICAgICog5YaF6YOo55qEaW5wdXTmoIfnrb5cclxuICAgICAgICovXHJcbiAgICAgIEBWaWV3Q2hpbGQoJ2lucHV0JywgeyBzdGF0aWM6IHRydWUgfSkgcHVibGljIGlucHV0UmVmOiBFbGVtZW50UmVmO1xyXG4gICAgICAvKipcclxuICAgICAgICogQGlnbm9yZVxyXG4gICAgICAgKiDnlKjmiLflhpnnmoRpdGVt5qih5p2/XHJcbiAgICAgICAqL1xyXG4gICAgICBAQ29udGVudENoaWxkKFRlbXBsYXRlUmVmLCAvKiBUT0RPOiBhZGQgc3RhdGljIGZsYWcgKi8geyBzdGF0aWM6IHRydWUgfSkgaXRlbVRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG4gICAgICAvKipcclxuICAgICAgICogQGlnbm9yZVxyXG4gICAgICAgKiDlhoXpg6jmoIfnrb5kb25pbWF0b3Lnu4Tku7ZcclxuICAgICAgICovXHJcbiAgICAgIEBWaWV3Q2hpbGQoVGlEb21pbmF0b3JDb21wb25lbnQsIHsgc3RhdGljOiB0cnVlIH0pIGRvbWluYXRvckNvbTogVGlEb21pbmF0b3JDb21wb25lbnQ7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBAaWdub3JlXHJcbiAgICAgICAqIOWGhemDqOagh+etvnNlbGVjdERyb3Dnu4Tku7ZcclxuICAgICAgICovXHJcbiAgICAgIEBWaWV3Q2hpbGQoVGlEcm9wc2VhcmNoQ29tcG9uZW50LCB7IHN0YXRpYzogdHJ1ZSB9KSBzZWxlY3REcm9wOiBUaURyb3BzZWFyY2hDb21wb25lbnQ7XHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBAaWdub3JlXHJcbiAgICAgICAqIGlucHV06L6T5YWl5qGG55qE5YC8XHJcbiAgICAgICAqL1xyXG4gICAgICBwdWJsaWMgaW5wdXRWYWx1ZTogc3RyaW5nID0gJyc7IC8vIOi+k+WFpeahhuWGheWuuVxyXG5cclxuICAgICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgICAgICAgICBzdXBlci5uZ0FmdGVyVmlld0luaXQoKTtcclxuICAgICAgICAgICAgLy8g5o6o6I2Q5Zyob25Jbml0KCnml7bosIPnlKhzZXRGb2N1c2FibGVFbGVtcygpLCDkvYbmmK9uZ0Zvci9uZ0lm5Lit55qE5YWD57Sg5ZyobmdBZnRlclZpZXdJbml0KCnmiY3og73ojrflj5bliLBcclxuICAgICAgICAgICAgdGhpcy5zZXRGb2N1c2FibGVFbGVtcyhbdGhpcy5kb21pbmF0b3JDb20ubmF0aXZlRWxlbWVudCwgdGhpcy5pbnB1dFJlZi5uYXRpdmVFbGVtZW50XSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBAaWdub3JlXHJcbiAgICAgICAqIOWkhOeQhnNlbGVjdOS6i+S7tlxyXG4gICAgICAgKi9cclxuICAgICAgb25TZWxlY3QoZXZlbnQ6IGFueSk6IHZvaWQge1xyXG4gICAgICAgICAgICB0aGlzLm1vZGVsLnB1c2goZXZlbnQpO1xyXG4gICAgICAgICAgICB0aGlzLm1vZGVsID0gdGhpcy5tb2RlbC5jb25jYXQoKTtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLnNlYXJjaFJlc3VsdCA9IHRoaXMuZ2V0U3VnZ2VzdGlvbnModGhpcy5zdWdnZXN0aW9ucywgdGhpcy5tb2RlbCk7XHJcblxyXG4gICAgICAgICAgICAvLyDmuIXnqbrovpPlhaXmoYZcclxuICAgICAgICAgICAgdGhpcy5pbnB1dFZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIC8vIOmAieS4remhueeUseS4gOihjOWPmOS4uuS4pOihjOaXtu+8jOmcgOimgemHjeWumuS9jVxyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLnJlUG9zaXRpb24oKTtcclxuICAgICAgICAgICAgfSwgMCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBAaWdub3JlXHJcbiAgICAgICAqIOWkhOeQhueCueWHu0RvbWluYXRvcuS6i+S7tlxyXG4gICAgICAgKi9cclxuICAgICAgb25DbGlja0RvbWluYXRvcigpOiB2b2lkIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmlucHV0UmVmLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIEBpZ25vcmVcclxuICAgICAgICog54K55Ye76YCJ5Lit6aG555qE5Y+J5Y+3OuS7jumAieS4remhueS4reenu+mZpOW9k+WJjemAieS4remhuVxyXG4gICAgICAgKi9cclxuICAgICAgb25EZWxldGUoZXZlbnQ6IHsgaXRlbTogYW55OyBtb2RlbDogYW55IH0pOiB2b2lkIHtcclxuICAgICAgICAgICAgdGhpcy5pbnB1dFJlZi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XHJcbiAgICAgICAgICAgIC8vIOmAieS4remhueeUseS4pOihjOWPmOS4uuS4gOihjOaXtu+8jOmcgOimgemHjeWumuS9jVxyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLnJlUG9zaXRpb24oKTtcclxuICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLnNlYXJjaFJlc3VsdCA9IHRoaXMuZ2V0U3VnZ2VzdGlvbnModGhpcy5zdWdnZXN0aW9ucywgZXZlbnQubW9kZWwpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogQGlnbm9yZVxyXG4gICAgICAgKiDovpPlhaXmoYblpLHnhKbml7bvvIzpnaLmnb/pmpDol4/vvIzmoLnmja7mlofmnKzmoYblhoXlrrnlpITnkIbmmK/lkKbmt7vliqDliLDpgInkuK3poblcclxuICAgICAgICovXHJcbiAgICAgIG9uSW5wdXRCbHVyKCk6IHZvaWQge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdERyb3AuaGlkZSgpO1xyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZTogc3RyaW5nID0gdGhpcy5pbnB1dFZhbHVlO1xyXG5cclxuICAgICAgICAgICAgLy8g5riF56m66L6T5YWl5qGGXHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRWYWx1ZSA9ICcnO1xyXG5cclxuICAgICAgICAgICAgLy8g6L6T5YWl5qGG5Li656m65pe25oiW6ICF5b2T5YmN6L6T5YWl5qGG5YaF5a655a+55bqU55qE5qCH562+5bey57uP5Zyo6YCJ5Lit5YiX6KGo5Lit5LqGXHJcbiAgICAgICAgICAgIGlmICh2YWx1ZS50cmltKCkgPT09ICcnIHx8IHRoaXMuZmluZEZpcnN0SW5kZXgodGhpcy5tb2RlbCwgJ2xhYmVsJywgdmFsdWUpICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8g5bCG6L6T5YWl5qGG5YaF5a655re75Yqg5Yiw6YCJ5Lit5qCH562+5LitXHJcbiAgICAgICAgICAgIHRoaXMuYWRkVGFnVG9TZWxlY3RlZCh2YWx1ZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBAaWdub3JlXHJcbiAgICAgICAqIOWkhOeQhmlucHV05qGG6IGa54Sm5LqL5Lu2XHJcbiAgICAgICAqL1xyXG4gICAgICBvbklucHV0Rm9jdXMoZXZlbnQ6IEZvY3VzRXZlbnQpOiB2b2lkIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLnNlYXJjaFJlc3VsdCA9IHRoaXMuZ2V0U3VnZ2VzdGlvbnModGhpcy5zdWdnZXN0aW9ucywgdGhpcy5tb2RlbCk7XHJcbiAgICAgICAgICAgIC8vIOinhuWbvue7mOWItuaXqeS6juWPmOmHj+abtOaWsO+8jOWPmOmHj+abtOaWsOWQjuS4i+aLieWumuS9jeS4jeato+ehru+8jCDpnIDopoHlu7bml7blpITnkIZcclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlbGVjdERyb3AoKTtcclxuICAgICAgICAgICAgfSwgMCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBAaWdub3JlXHJcbiAgICAgICAqIOWkhOeQhmlucHV06L6T5YWl5qGGa2V5dXDlv6vmjbfplK7lip/og71cclxuICAgICAgICovXHJcbiAgICAgIG9uSW5wdXRLZXl1cChldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQua2V5Q29kZSA9PT0gVGlLZXltYXAuS0VZX0VOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09IFRpS2V5bWFwLktFWV9OVU1QQURfRU5URVIpIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5yZXNwb25zZUVudGVyKGV2ZW50KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogQGlnbm9yZVxyXG4gICAgICAgKiDlpITnkIZpbnB1dOi+k+WFpeahhmtleWRvd27lv6vmjbfplK7lip/og71cclxuICAgICAgICog5Zue5Yig6ZSu5Y+q6IO95Zyoa2V5ZG93buS4reWkhOeQhu+8muWboOS4uuWbnuWIoOaXtu+8jOWcqGtleWRvd27ml7bovpPlhaXmoYbkuLrlvZPliY3lgLzvvIxrZXl1cOaXtuS4uuWIoOmZpOWQjueahOWAvFxyXG4gICAgICAgKiDmr5TlpoLovpPlhaXkuIDkuKrlrZfnrKbvvIzlm57liKDvvIzojrflj5bnmoTlupTor6XmmK/lm57liKDliY3nmoTkuIDkuKrlrZfnrKbvvIzogIzkuI3mmK/msqHmnInliKDpmaTlkI7nmoRcclxuICAgICAgICovXHJcbiAgICAgIG9uSW5wdXRLZXlkb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XHJcbiAgICAgICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSBUaUtleW1hcC5LRVlfQkFDS1NQQUNFKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMucmVzcG9uc2VCYWNrc3BhY2UoZXZlbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiBAaWdub3JlXHJcbiAgICAgICAqIOi+k+WFpeahhuWGheWuueWPmOWMluaXtueahOWkhOeQhlxyXG4gICAgICAgKiBAcGFyYW0gaW5wdXRWYWx1ZVxyXG4gICAgICAgKi9cclxuICAgICAgb25JbnB1dENoYW5nZShpbnB1dFZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICAgICAgLy8g6L+H5ruk5Ye65Yy56YWN6aG5XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0RHJvcC5zZWFyY2hXb3JkQ2hhbmdlKGlucHV0VmFsdWUpO1xyXG4gICAgICAgICAgICAvLyDku47ljLnphY3pobnkuK3np7vpmaTlt7LpgInkuK3poblcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLnNlYXJjaFJlc3VsdCA9IHRoaXMuZ2V0U3VnZ2VzdGlvbnModGhpcy5zZWxlY3REcm9wLnNlYXJjaFJlc3VsdCwgdGhpcy5tb2RlbCk7XHJcbiAgICAgICAgICAgIC8vIOW9k+ayoeacieWMuemFjemhueaXtumdouadv+makOiXj1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zZWxlY3REcm9wLnNlYXJjaFJlc3VsdC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICog5aSE55CGaW5wdXTovpPlhaXmoYZlbnRlcumUruWKn+iDvVxyXG4gICAgICAgKiBAcGFyYW0gZXZlbnRcclxuICAgICAgICovXHJcbiAgICAgIHByaXZhdGUgcmVzcG9uc2VFbnRlcihldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdERyb3AuaGlkZSgpO1xyXG4gICAgICAgICAgICAvLyDojrflj5bovpPlhaXmoYbnmoTlgLxcclxuICAgICAgICAgICAgY29uc3QgdmFsdWU6IHN0cmluZyA9IHRoaXMuaW5wdXRWYWx1ZTtcclxuICAgICAgICAgICAgLy8g5riF56m6aW5wdXTmoYbnmoTlhoXlrrlcclxuICAgICAgICAgICAgdGhpcy5pbnB1dFZhbHVlID0gJyc7XHJcblxyXG4gICAgICAgICAgICAvLyDovpPlhaXmoYbkuLrnqbrml7bmiJbogIXlvZPliY3ovpPlhaXmoYblhoXlrrnlr7nlupTnmoTmoIfnrb7lt7Lnu4/lnKjpgInkuK3liJfooajkuK3kuoZcclxuICAgICAgICAgICAgaWYgKHZhbHVlLnRyaW0oKSA9PT0gJycgfHwgdGhpcy5maW5kRmlyc3RJbmRleCh0aGlzLm1vZGVsLCAnbGFiZWwnLCB2YWx1ZSkgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlbGVjdERyb3AoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g5bCG6L6T5YWl5qGG5YaF5a655re75Yqg5Yiw6YCJ5Lit5qCH562+5LitXHJcbiAgICAgICAgICAgIHRoaXMuYWRkVGFnVG9TZWxlY3RlZCh2YWx1ZSk7XHJcbiAgICAgICAgICAgIC8vIOWwhumAieS4remhueS4juS4i+aLiemAiemhueWvueavlO+8jOS7juS4i+aLiemAiemhueS4reaPkOWHuumAieS4remhuVxyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdERyb3Auc2VhcmNoUmVzdWx0ID0gdGhpcy5nZXRTdWdnZXN0aW9ucyh0aGlzLnN1Z2dlc3Rpb25zLCB0aGlzLm1vZGVsKTtcclxuICAgICAgICAgICAgdGhpcy5zaG93U2VsZWN0RHJvcCgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICog5aSE55CGaW5wdXTovpPlhaXmoYblm57liKDplK7lip/og71cclxuICAgICAgICogQHBhcmFtIGV2ZW50XHJcbiAgICAgICAqL1xyXG4gICAgICBwcml2YXRlIHJlc3BvbnNlQmFja3NwYWNlKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0RHJvcC5oaWRlKCk7XHJcbiAgICAgICAgICAgIC8vIOmdouadv+WFs+mXreaXtlxyXG4gICAgICAgICAgICBpZiAoIXRoaXMuc2VsZWN0RHJvcC5pc1Nob3cpIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U2VsZWN0RHJvcCgpO1xyXG4gICAgICAgICAgICAgICAgICAvLyDpgInkuK3pobnnlLHkuKTooYzlj5jkuLrkuIDooYzml7bvvIzpnIDopoHph43lrprkvY1cclxuICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RHJvcC5yZVBvc2l0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgIH0sIDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlOiBzdHJpbmcgPSB0aGlzLmlucHV0UmVmLm5hdGl2ZUVsZW1lbnQudmFsdWU7XHJcbiAgICAgICAgICAgIC8vIOi+k+WFpeahhuWAvOS4jeS4uuepuuWtl+espuS4suaXtlxyXG4gICAgICAgICAgICBpZiAodmFsdWUgIT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g6I635Y+W5b2T5YmN6YCJ5Lit6aG555qE6ZW/5bqmXHJcbiAgICAgICAgICAgIGNvbnN0IG1vZGVsTGVuZ3RoOiBudW1iZXIgPSB0aGlzLm1vZGVsLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgIC8vIOW9k+WJjeW3sue7j+ayoeaciemAieS4remhueaXtu+8jOS4jeWBmuWkhOeQhlxyXG4gICAgICAgICAgICBpZiAobW9kZWxMZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBsYXN0U2VsZWN0ZWQ6IGFueSA9IHRoaXMubW9kZWxbbW9kZWxMZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXg6IG51bWJlciA9IHRoaXMuc3VnZ2VzdGlvbnMuaW5kZXhPZihsYXN0U2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICAvLyDku47pgInkuK3pobnkuK3liKDpmaRcclxuICAgICAgICAgICAgdGhpcy5tb2RlbC5wb3AoKTtcclxuICAgICAgICAgICAgdGhpcy5tb2RlbCA9IHRoaXMubW9kZWwuY29uY2F0KCk7XHJcblxyXG4gICAgICAgICAgICAvLyDlsIbopoHku47pgInkuK3pobnliKDpmaTnmoTmnIDlkI7kuIDpobnmmK/kuIvmi4npgInpobnkuK3nmoTkuIDpobnml7bvvIzlsIblhbbmt7vliqDliLDnjrDmnInnmoTkuIvmi4npgInpobnkuK07XHJcbiAgICAgICAgICAgIC8vIOWmguaenOaYr+eUqOaIt+iHquW3seWIm+W7uueahO+8jOWImeS4jeaUvuWFpeS4i+aLiemhueS4rVxyXG4gICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RHJvcC5zZWFyY2hSZXN1bHQgPSB0aGlzLmdldFN1Z2dlc3Rpb25zKHRoaXMuc3VnZ2VzdGlvbnMsIHRoaXMubW9kZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiDmoLnmja7mlbDnu4TkuK3lsZ7mgKfmib7mmK/lkKbmnInljLnphY3poblcclxuICAgICAgICogQHBhcmFtIGFyciDpnIDopoHljLnphY3nmoTmlbDnu4RcclxuICAgICAgICogQHBhcmFtIGtleSDpnIDopoHmn6Xmib7nmoTlsZ7mgKdcclxuICAgICAgICogQHBhcmFtIHZhbHVlIOWxnuaAp+WAvFxyXG4gICAgICAgKiBAcmV0dXJuc1xyXG4gICAgICAgKi9cclxuICAgICAgcHJpdmF0ZSBmaW5kRmlyc3RJbmRleChhcnI6IGFueSwga2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgICAgICAgICBpZiAoIShhcnIgaW5zdGFuY2VvZiBBcnJheSkpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgIGlmIChhcnJbaV1ba2V5XSA9PT0gdmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICog5bCG6L6T5YWl5qGG5YaF5a655re75Yqg5Yiw6YCJ5Lit5qCH562+5LitXHJcbiAgICAgICAqIEBwYXJhbSBpbnB1dFZhbHVlIOi+k+WFpeahhueahOWGheWuuVxyXG4gICAgICAgKi9cclxuICAgICAgcHJpdmF0ZSBhZGRUYWdUb1NlbGVjdGVkKGlucHV0VmFsdWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgICAgICBjb25zdCBpbmRleDogbnVtYmVyID0gdGhpcy5maW5kRmlyc3RJbmRleCh0aGlzLnN1Z2dlc3Rpb25zLCAnbGFiZWwnLCBpbnB1dFZhbHVlKTtcclxuICAgICAgICAgICAgY29uc3QgbmV3VGFnOiBhbnkgPSBpbmRleCA9PT0gLTEgPyB7IGlkOiBpbnB1dFZhbHVlLCBsYWJlbDogaW5wdXRWYWx1ZSB9IDogdGhpcy5zdWdnZXN0aW9uc1tpbmRleF07XHJcbiAgICAgICAgICAgIHRoaXMubW9kZWwucHVzaChuZXdUYWcpO1xyXG4gICAgICAgICAgICB0aGlzLm1vZGVsID0gdGhpcy5tb2RlbC5jb25jYXQoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLyoqXHJcbiAgICAgICAqIOS7jnN1Z2dlc3Rpb25z5Lit5Yig6Zmk6YCJ5Lit6aG5XHJcbiAgICAgICAqL1xyXG4gICAgICBwcml2YXRlIGdldFN1Z2dlc3Rpb25zKHN1Z2dlc3Rpb25zOiBhbnksIHNlbGVjdGVkOiBhbnkpOiBBcnJheTxhbnk+IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3U3VnZ2VzdGlvbnM6IGFueSA9ICEoc3VnZ2VzdGlvbnMgaW5zdGFuY2VvZiBBcnJheSkgPyBbXSA6IHN1Z2dlc3Rpb25zLmNvbmNhdCgpOyAvLyDkvb/nlKjmlbDnu4TnmoRjb25jYXTmlrnms5XvvIzlrp7njrDmt7Hmi7fotJ1cclxuXHJcbiAgICAgICAgICAgIGxldCBpbmRleDogbnVtYmVyO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNlbGVjdCBvZiBzZWxlY3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICBpbmRleCA9IG5ld1N1Z2dlc3Rpb25zLmluZGV4T2Yoc2VsZWN0KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsgLy8g6YCJ5Lit6aG55aaC5p6c5Zyo5LiL5ouJ5YiX6KGo5Lit5a2Y5Zyo77yM5YiZ5Yig6ZmkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1N1Z2dlc3Rpb25zLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5ld1N1Z2dlc3Rpb25zO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvKipcclxuICAgICAgICogQGlnbm9yZVxyXG4gICAgICAgKiDlsZXlvIDpnaLmnb/ml7borr7nva7kuIvmi4npgInkuK3pobnlkoxob3Zlck9wdGlvblxyXG4gICAgICAgKi9cclxuICAgICAgcHVibGljIHNob3dTZWxlY3REcm9wKCk6IHZvaWQge1xyXG4gICAgICAgICAgICAvLyDorr7nva5zZWxlY3REcm9w55qE6YCJ5Lit6aG5XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0RHJvcC5saXN0Q29tLm1vZGVsID0gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAgICAgLy8g5pi+56S65LiL5ouJ6Z2i5p2/XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdERyb3Auc2VhcmNoUmVzdWx0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3REcm9wLnNob3coKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g5LiN6K6+572u5b6F6YCJ5Lit6aG5XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0RHJvcC5saXN0Q29tLmhvdmVyT3B0aW9uID0gdW5kZWZpbmVkO1xyXG4gICAgICB9XHJcbn1cclxuIl19