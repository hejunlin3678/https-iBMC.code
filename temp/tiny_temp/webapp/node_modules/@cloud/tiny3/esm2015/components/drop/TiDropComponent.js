import { ApplicationRef, Component, ElementRef, Input, Renderer2, TemplateRef, ViewChild } from '@angular/core';
import { TiBrowser, Util } from '../../utils/Util';
import { Position } from '../../utils/Position';
import { TiBaseComponent } from '../base/TiBaseModule';
import { Subject } from 'rxjs';
/**
 * @ignore
 * 纯下拉面板组件，只有面板，没有内容。因为有时朝上弹，dropdown/dropup合称drop
 */
export class TiDropComponent extends TiBaseComponent {
    constructor(hostRef, renderer, applicationRef) {
        super(hostRef, renderer);
        this.hostRef = hostRef;
        this.renderer = renderer;
        this.applicationRef = applicationRef;
        /**
         * 下拉面板的最大显示宽度，该变量与下拉类组件保持一致
         *
         * 1."justified"(默认): 下拉框的宽度与Select组件的宽度保持一致；
         *
         * 2."auto": 下拉框的宽度根据下拉选项的内容自动撑开；
         *
         * 3.表示宽度的字符串: 设置固定的下拉框宽度(不小于Select组件的宽度)。例如："200px"
         */
        this.panelWidth = 'justified'; // 面板宽度
        /**
         * 面板最大高度
         */
        this.panelMaxHeight = '9999px'; // 面板最大高度
        /**
         * 空间不足时，依然保持固定高度。 select search等是可变最大高度，日历是固定最大高度。
         * 再就是上下空间都不足时，日历从下方弹出。
         */
        this.fixMaxHeight = false; // 再就是上下空间都不足时，日历从下方弹出。
        /**
         * 主题样式控制
         */
        this.theme = 'border';
        /**
         * 距离宿主元素距离，像素值
         */
        this.dominatorSpace = TiDropComponent.DOMINATOR_SPACE + 'px';
        /**
         * 距离浏览器上或下边沿的距离，像素值
         */
        this.browserSpace = TiDropComponent.BROWSER_SPACE + 'px';
        /**
         * 在定位基础上的水平方向的偏移，向左偏移为负值，向右偏移为正值，像素值
         */
        this.hOffset = 0;
        /**
         * 面板对齐方式
         */
        this.panelAlign = 'left';
        /**
         * @ignore
         */
        this.dropSubject = new Subject();
        this.posHandles = [];
        // 决定上下位置的函数
        this.defaultDeterminPositionFn = (layout) => {
            const dominatorSpace = parseInt(this.dominatorSpace, 10);
            const browserSpace = parseInt(this.browserSpace, 10);
            const needHeight = layout.targetLayout.height + dominatorSpace + browserSpace;
            if (layout.avilableLayout.bottom >= needHeight) { // 下方空间足够，向下展开
                return this.panelAlign === 'left' ? 'bottom-left' : 'bottom-right';
            }
            else if (layout.avilableLayout.top >= needHeight) { // 上方空间足够，向上展开
                return this.panelAlign === 'left' ? 'top-left' : 'top-right';
            }
            else if (layout.avilableLayout.bottom >= layout.avilableLayout.top) { // 下方空间较大，则向下展开
                // 因为日历组件存在问题，最大高度不压缩，极端情况时会显示在top为负显示不全。所以日历组件尽量向下弹出。
                return this.panelAlign === 'left' ? 'bottom-left' : 'bottom-right';
            }
            return this.panelAlign === 'left' ? 'top-left' : 'top-right'; // 向上展开
        };
    }
    /**
     * 外部接口: 获取当前状态, 只读不写
     */
    get isShow() {
        return this.hostRef.nativeElement.style.display === 'block';
    }
    ngOnDestroy() {
        // 从body上摘除。
        this.renderer.removeChild(this.renderer.parentNode(this.hostRef.nativeElement), this.hostRef.nativeElement);
        this.unlistenPosition();
    }
    /**
     * 切换面板状态：打开/关闭
     */
    toggle() {
        this.isShow ? this.hide() : this.show();
    }
    /**
     * 打开面板
     */
    show() {
        if (this.isShow) {
            return;
        }
        // 挂在body上，极远处
        this.appendToBodyFarAway();
        // 先显示，才能再计算
        this.setShow();
        this.setPanelWidth();
        // 设置位置：居下优先，居上其次
        this.setPosition();
        this.listenPosition();
        this.dropSubject.next(true);
        // const result = this.setPosition();
        // setTimeout(()=>{this.setPosition()},0);
        // 设置MaxHeight //此逻辑已经放入Position
        // this.setPanelMaxHeight(result.avilableHeight);
        // 设置Width。确保在显示之后设置下拉框的宽度，避免滚动条的影响
        // this.setPanelWidth();
    }
    /**
     * 关闭面板
     */
    hide() {
        if (!this.isShow) {
            return;
        }
        this.renderer.setStyle(this.hostRef.nativeElement, 'display', 'none');
        this.unlistenPosition();
    }
    appendToBodyFarAway() {
        // 如果不在body上，那么挂在body上。（逻辑应该移入Position.setPosition吧，因为那位置就是按照body定的，不在body会出错。）
        if (this.renderer.parentNode(this.hostRef.nativeElement) !== document.body) {
            this.renderer.appendChild(document.body, this.hostRef.nativeElement);
            const embeddedViewRef = this.dropTemplateRef.createEmbeddedView(null);
            this.applicationRef.attachView(embeddedViewRef); // 不做此处处理，ng-template中的标签不会解析
            Array.from(embeddedViewRef.rootNodes)
                .forEach((item) => {
                this.renderer.appendChild(this.hostRef.nativeElement, item);
            });
        }
        // 设置在极远处（逻辑应该移入Position.setPosition吧）
        this.renderer.setStyle(this.hostRef.nativeElement, 'left', '-9999px');
        this.renderer.setStyle(this.hostRef.nativeElement, 'top', '-9999px');
        // 更新max-height为默认值panelMaxHeight，因为上次显示可能更改了max-height
        this.renderer.setStyle(this.hostRef.nativeElement, 'max-height', this.panelMaxHeight);
        // 设置width,当出现滚动条时,更新width为默认的panelWidth，避免滚动条宽度的影响
        if (this.panelWidth === 'auto') {
            this.renderer.setStyle(this.hostRef.nativeElement, 'width', this.panelWidth);
        }
    }
    setShow() {
        // 显示才能计算宽度
        this.renderer.setStyle(this.hostRef.nativeElement, 'display', 'block');
    }
    /**
     * 监听位置变化, 并隐藏面板。打开面板时监听，关闭和销毁时取消监听。
     * TODO: 尝试hide改为rePosition
     */
    listenPosition() {
        this.posHandles = Position.addPosChangeEvts(() => {
            this.hide();
        }, this.renderer);
    }
    unlistenPosition() {
        Position.removePosChangeEvts(this.posHandles);
    }
    /**
     * 确定元素的显示样式，包括位置、最大高度、向上或向下
     * @returns 定位结果对象
     */
    setPosition() {
        const dominatorSpace = parseInt(this.dominatorSpace, 10);
        const browserSpace = parseInt(this.browserSpace, 10);
        const determinPositionFn = Util.isFunction(this.determinPositionFn) ? this.determinPositionFn :
            this.defaultDeterminPositionFn;
        // 设置位置
        const result = Position.setPosition({
            targetEle: this.hostRef.nativeElement,
            hostEle: this.dominatorElem,
            // position: undefined, // 可选参数
            hostSpace: dominatorSpace,
            browserSpace,
            fixMaxHeight: this.fixMaxHeight,
            hOffset: this.hOffset,
            determinPositionFn
        });
        return result.hostLayout;
    }
    resetPosition() {
        // 记录上一次dominator left值
        const hostLayout = this.setPosition();
        const dominatorLastLeft = hostLayout && hostLayout.left;
        // 记录当前dominator left值
        const dominatorCurLeft = Position.getHostEleLayout(this.dominatorElem).left;
        // dominator发生水平位移且面板处于打开状态时，需重新定位
        // 主要场景：下拉面板数据量变动引起body出现竖向滚动条，dominator发生水平方向偏移;
        if (dominatorLastLeft !== dominatorCurLeft) {
            if (this.isShow) {
                this.setPosition();
            }
        }
    }
    setPanelWidth() {
        const panelWidthNum = parseInt(this.panelWidth, 10);
        const scrollWidth = this.hostRef.nativeElement.offsetWidth - this.hostRef.nativeElement.clientWidth;
        const dominatorElemWidth = this.dominatorElem.offsetWidth;
        let width;
        if (!isNaN(panelWidthNum)) {
            width = panelWidthNum + 'px';
        }
        else if (this.panelWidth === 'auto') {
            width = 'auto';
            // Fix bug: 非IE下滚动条会覆盖部分内容
            if (!TiBrowser.isIE()) {
                // 需要重置宽度设置，根据下拉面板的真实宽度确定是否需要增加滚动条宽度
                width = null;
                // 有滚动条出现且文本较长时，需要再增加滚动条的宽度，否则内容显示不全
                if (scrollWidth) {
                    width = this.hostRef.nativeElement.offsetWidth + scrollWidth + 'px';
                }
            }
            const minWidth = dominatorElemWidth + 'px';
            this.renderer.setStyle(this.hostRef.nativeElement, 'min-width', minWidth);
        }
        else {
            // 默认宽度设置，包含justified
            width = dominatorElemWidth + 'px';
        }
        // 设置
        this.renderer.setStyle(this.hostRef.nativeElement, 'width', width);
    }
}
/**
 * 设置下拉距离dominator的距离：默认没有间距
 */
TiDropComponent.DOMINATOR_SPACE = 4;
/**
 * 控制下拉框距离浏览器上下边沿的距离为5px，预留一个余量，防止显示不了边框
 */
TiDropComponent.BROWSER_SPACE = 5;
TiDropComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-drop',
                template: "\r\n<ng-template #dropTemplateRef>\r\n    <ng-content></ng-content>\r\n</ng-template>\r\n\r\n",
                host: {
                    '[class.ti3-dropdown-container]': 'true',
                    '[class.ti3-dropdown-container-border]': 'theme ==="border"',
                    '[style.height]': 'panelHeight'
                },
                styles: [":host.ti3-dropdown-container{-ms-box-sizing:border-box;background-color:#fff;box-shadow:var(--ti-common-shadow-2-down);box-sizing:border-box;color:var(--ti-input-text-color);display:none;position:absolute;z-index:1060}:host.ti3-dropdown-container-border{border-radius:var(--ti-input-border-radius)}:host .ti3-drop-cover-line{background:var(--ti-common-color-line-dividing);height:1px;position:absolute}"]
            },] }
];
TiDropComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: ApplicationRef }
];
TiDropComponent.propDecorators = {
    panelWidth: [{ type: Input }],
    panelMaxHeight: [{ type: Input }],
    panelHeight: [{ type: Input }],
    dominatorElem: [{ type: Input }],
    fixMaxHeight: [{ type: Input }],
    theme: [{ type: Input }],
    dominatorSpace: [{ type: Input }],
    browserSpace: [{ type: Input }],
    hOffset: [{ type: Input }],
    determinPositionFn: [{ type: Input }],
    panelAlign: [{ type: Input }],
    dropTemplateRef: [{ type: ViewChild, args: ['dropTemplateRef', { static: true },] }]
};
// offsetWidth属性可以返回对象的padding+border+width属性值之和, 是整数。与jQuery的outerWidth()完全相同，outerWidth(true)带有外边距。
// Element.clientWidth 属性表示元素的内部宽度，以像素计。该属性包括内边距，但不包括垂直滚动条（如果有）、边框和外边距。
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlEcm9wQ29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL2NvbXBvbmVudHMvZHJvcC9UaURyb3BDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFtQixLQUFLLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakksT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsUUFBUSxFQUFrQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hGLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9COzs7R0FHRztBQVdILE1BQU0sT0FBTyxlQUFnQixTQUFRLGVBQWU7SUEyRWhELFlBQXNCLE9BQW1CLEVBQVksUUFBbUIsRUFBVSxjQUE4QjtRQUM1RyxLQUFLLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRFAsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUFZLGFBQVEsR0FBUixRQUFRLENBQVc7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFsRWhIOzs7Ozs7OztXQVFHO1FBQ00sZUFBVSxHQUFXLFdBQVcsQ0FBQyxDQUFDLE9BQU87UUFDbEQ7O1dBRUc7UUFDTSxtQkFBYyxHQUFXLFFBQVEsQ0FBQyxDQUFHLFNBQVM7UUFVdkQ7OztXQUdHO1FBQ00saUJBQVksR0FBWSxLQUFLLENBQUMsQ0FBQyx1QkFBdUI7UUFDL0Q7O1dBRUc7UUFDTSxVQUFLLEdBQTBCLFFBQVEsQ0FBQztRQUNqRDs7V0FFRztRQUNNLG1CQUFjLEdBQVcsZUFBZSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFDekU7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LEdBQVcsQ0FBQyxDQUFDOztZQWxCckQsU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxTQUFTO2dCQUNuQix5R0FBMEI7Z0JBRTFCLElBQUksRUFBRTtvQkFDRixnQ0FBZ0MsRUFBRSxNQUFNO29CQUN4Qyx1Q0FBdUMsRUFBRSxtQkFBbUI7b0JBQzVELGdCQUFnQixFQUFFLGFBQWE7aUJBQ2xDOzthQUNKOzs7WUFuQm1DLFVBQVU7WUFBMEIsU0FBUztZQUF4RSxjQUFjOzs7eUJBc0NsQixLQUFLOzZCQUlMLEtBQUs7MEJBS0wsS0FBSzs0QkFJTCxLQUFLOzJCQUtMLEtBQUs7b0JBSUwsS0FBSzs2QkFJTCxLQUFLOzJCQUlMLEtBQUs7c0JBSUwsS0FBSztpQ0FJTCxLQUFLO3lCQUlMLEtBQUs7OEJBSUwsU0FBUyxTQUFDLGlCQUFpQixFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTs7QUFrTWxELHFHQUFxRztBQUNyRyx1RUFBdUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFbWJlZGRlZFZpZXdSZWYsIElucHV0LCBSZW5kZXJlcjIsIFRlbXBsYXRlUmVmLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVGlCcm93c2VyLCBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbmltcG9ydCB7IFBvc2l0aW9uLCBUaUhvc3RMYXlvdXQsIFRpUG9zaXRpb25SZXN1bHQgfSBmcm9tICcuLi8uLi91dGlscy9Qb3NpdGlvbic7XHJcbmltcG9ydCB7IFRpQmFzZUNvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2UvVGlCYXNlTW9kdWxlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuLyoqXHJcbiAqIEBpZ25vcmVcclxuICog57qv5LiL5ouJ6Z2i5p2/57uE5Lu277yM5Y+q5pyJ6Z2i5p2/77yM5rKh5pyJ5YaF5a6544CC5Zug5Li65pyJ5pe25pyd5LiK5by577yMZHJvcGRvd24vZHJvcHVw5ZCI56ewZHJvcFxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3RpLWRyb3AnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL2Ryb3AuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi9kcm9wLmxlc3MnXSxcclxuICAgIGhvc3Q6IHtcclxuICAgICAgICAnW2NsYXNzLnRpMy1kcm9wZG93bi1jb250YWluZXJdJzogJ3RydWUnLFxyXG4gICAgICAgICdbY2xhc3MudGkzLWRyb3Bkb3duLWNvbnRhaW5lci1ib3JkZXJdJzogJ3RoZW1lID09PVwiYm9yZGVyXCInLFxyXG4gICAgICAgICdbc3R5bGUuaGVpZ2h0XSc6ICdwYW5lbEhlaWdodCdcclxuICAgIH1cclxufSlcclxuZXhwb3J0IGNsYXNzIFRpRHJvcENvbXBvbmVudCBleHRlbmRzIFRpQmFzZUNvbXBvbmVudCB7XHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruS4i+aLiei3neemu2RvbWluYXRvcueahOi3neemu++8mum7mOiupOayoeaciemXtOi3nVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IERPTUlOQVRPUl9TUEFDRTogbnVtYmVyID0gNDtcclxuICAgIC8qKlxyXG4gICAgICog5o6n5Yi25LiL5ouJ5qGG6Led56a75rWP6KeI5Zmo5LiK5LiL6L655rK/55qE6Led56a75Li6NXB477yM6aKE55WZ5LiA5Liq5L2Z6YeP77yM6Ziy5q2i5pi+56S65LiN5LqG6L655qGGXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEJST1dTRVJfU1BBQ0U6IG51bWJlciA9IDU7XHJcbiAgICAvKipcclxuICAgICAqIOS4i+aLiemdouadv+eahOacgOWkp+aYvuekuuWuveW6pu+8jOivpeWPmOmHj+S4juS4i+aLieexu+e7hOS7tuS/neaMgeS4gOiHtFxyXG4gICAgICpcclxuICAgICAqIDEuXCJqdXN0aWZpZWRcIijpu5jorqQpOiDkuIvmi4nmoYbnmoTlrr3luqbkuI5TZWxlY3Tnu4Tku7bnmoTlrr3luqbkv53mjIHkuIDoh7TvvJtcclxuICAgICAqXHJcbiAgICAgKiAyLlwiYXV0b1wiOiDkuIvmi4nmoYbnmoTlrr3luqbmoLnmja7kuIvmi4npgInpobnnmoTlhoXlrrnoh6rliqjmkpHlvIDvvJtcclxuICAgICAqXHJcbiAgICAgKiAzLuihqOekuuWuveW6pueahOWtl+espuS4sjog6K6+572u5Zu65a6a55qE5LiL5ouJ5qGG5a695bqmKOS4jeWwj+S6jlNlbGVjdOe7hOS7tueahOWuveW6pinjgILkvovlpoLvvJpcIjIwMHB4XCJcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgcGFuZWxXaWR0aDogc3RyaW5nID0gJ2p1c3RpZmllZCc7IC8vIOmdouadv+WuveW6plxyXG4gICAgLyoqXHJcbiAgICAgKiDpnaLmnb/mnIDlpKfpq5jluqZcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgcGFuZWxNYXhIZWlnaHQ6IHN0cmluZyA9ICc5OTk5cHgnOyAgIC8vIOmdouadv+acgOWkp+mrmOW6plxyXG4gICAgLyoqXHJcbiAgICAgKiAxMC4wLjTmlrDlop5cclxuICAgICAqIOmdouadv+mrmOW6plxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBwYW5lbEhlaWdodDogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiDlj4LogIPkvY3nva7lhYPntKBcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgZG9taW5hdG9yRWxlbTogYW55OyAvLyDlj4LogIPkvY3nva7lhYPntKBcclxuICAgIC8qKlxyXG4gICAgICog56m66Ze05LiN6Laz5pe277yM5L6d54S25L+d5oyB5Zu65a6a6auY5bqm44CCIHNlbGVjdCBzZWFyY2jnrYnmmK/lj6/lj5jmnIDlpKfpq5jluqbvvIzml6XljobmmK/lm7rlrprmnIDlpKfpq5jluqbjgIJcclxuICAgICAqIOWGjeWwseaYr+S4iuS4i+epuumXtOmDveS4jei2s+aXtu+8jOaXpeWOhuS7juS4i+aWueW8ueWHuuOAglxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBmaXhNYXhIZWlnaHQ6IGJvb2xlYW4gPSBmYWxzZTsgLy8g5YaN5bCx5piv5LiK5LiL56m66Ze06YO95LiN6Laz5pe277yM5pel5Y6G5LuO5LiL5pa55by55Ye644CCXHJcbiAgICAvKipcclxuICAgICAqIOS4u+mimOagt+W8j+aOp+WItlxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSB0aGVtZTogJ2JvcmRlcicgfCAnbm9ib3JkZXInID0gJ2JvcmRlcic7XHJcbiAgICAvKipcclxuICAgICAqIOi3neemu+Wuv+S4u+WFg+e0oOi3neemu++8jOWDj+e0oOWAvFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBkb21pbmF0b3JTcGFjZTogc3RyaW5nID0gVGlEcm9wQ29tcG9uZW50LkRPTUlOQVRPUl9TUEFDRSArICdweCc7XHJcbiAgICAvKipcclxuICAgICAqIOi3neemu+a1j+iniOWZqOS4iuaIluS4i+i+ueayv+eahOi3neemu++8jOWDj+e0oOWAvFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBicm93c2VyU3BhY2U6IHN0cmluZyA9IFRpRHJvcENvbXBvbmVudC5CUk9XU0VSX1NQQUNFICsgJ3B4JztcclxuICAgIC8qKlxyXG4gICAgICog5Zyo5a6a5L2N5Z+656GA5LiK55qE5rC05bmz5pa55ZCR55qE5YGP56e777yM5ZCR5bem5YGP56e75Li66LSf5YC877yM5ZCR5Y+z5YGP56e75Li65q2j5YC877yM5YOP57Sg5YC8XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGhPZmZzZXQ6IG51bWJlciA9IDA7XHJcbiAgICAvKipcclxuICAgICAqIOWHhuWkh+WOu+mZpFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBkZXRlcm1pblBvc2l0aW9uRm46IChsYXlvdXQ6IGFueSkgPT4gc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiDpnaLmnb/lr7npvZDmlrnlvI9cclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgcGFuZWxBbGlnbjogJ2xlZnQnIHwgJ3JpZ2h0JyA9ICdsZWZ0JztcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBAVmlld0NoaWxkKCdkcm9wVGVtcGxhdGVSZWYnLCB7IHN0YXRpYzogdHJ1ZSB9KSBkcm9wVGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBpc1VwOiBCb29sZWFuOyAvLyDpnaLmnb/lsZXlvIDnmoTmlrnlkJFcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZHJvcFN1YmplY3Q6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAgIHByaXZhdGUgcG9zSGFuZGxlczogQXJyYXk8KCkgPT4gdm9pZD4gPSBbXTtcclxuICAgIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBob3N0UmVmOiBFbGVtZW50UmVmLCBwcm90ZWN0ZWQgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBhcHBsaWNhdGlvblJlZjogQXBwbGljYXRpb25SZWYpIHtcclxuICAgICAgICBzdXBlcihob3N0UmVmLCByZW5kZXJlcik7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlpJbpg6jmjqXlj6M6IOiOt+WPluW9k+WJjeeKtuaAgSwg5Y+q6K+75LiN5YaZXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXQgaXNTaG93KCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudC5zdHlsZS5kaXNwbGF5ID09PSAnYmxvY2snO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOS7jmJvZHnkuIrmkZjpmaTjgIJcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMucmVuZGVyZXIucGFyZW50Tm9kZSh0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudCksIHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB0aGlzLnVubGlzdGVuUG9zaXRpb24oKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIh+aNoumdouadv+eKtuaAge+8muaJk+W8gC/lhbPpl61cclxuICAgICAqL1xyXG4gICAgcHVibGljIHRvZ2dsZSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmlzU2hvdyA/IHRoaXMuaGlkZSgpIDogdGhpcy5zaG93KCk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOaJk+W8gOmdouadv1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2hvdygpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5pc1Nob3cpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmjILlnKhib2R55LiK77yM5p6B6L+c5aSEXHJcbiAgICAgICAgdGhpcy5hcHBlbmRUb0JvZHlGYXJBd2F5KCk7XHJcbiAgICAgICAgLy8g5YWI5pi+56S677yM5omN6IO95YaN6K6h566XXHJcbiAgICAgICAgdGhpcy5zZXRTaG93KCk7XHJcbiAgICAgICAgdGhpcy5zZXRQYW5lbFdpZHRoKCk7XHJcbiAgICAgICAgLy8g6K6+572u5L2N572u77ya5bGF5LiL5LyY5YWI77yM5bGF5LiK5YW25qyhXHJcbiAgICAgICAgdGhpcy5zZXRQb3NpdGlvbigpO1xyXG5cclxuICAgICAgICB0aGlzLmxpc3RlblBvc2l0aW9uKCk7XHJcbiAgICAgICAgdGhpcy5kcm9wU3ViamVjdC5uZXh0KHRydWUpO1xyXG4gICAgICAgIC8vIGNvbnN0IHJlc3VsdCA9IHRoaXMuc2V0UG9zaXRpb24oKTtcclxuICAgICAgICAvLyBzZXRUaW1lb3V0KCgpPT57dGhpcy5zZXRQb3NpdGlvbigpfSwwKTtcclxuICAgICAgICAvLyDorr7nva5NYXhIZWlnaHQgLy/mraTpgLvovpHlt7Lnu4/mlL7lhaVQb3NpdGlvblxyXG4gICAgICAgIC8vIHRoaXMuc2V0UGFuZWxNYXhIZWlnaHQocmVzdWx0LmF2aWxhYmxlSGVpZ2h0KTtcclxuXHJcbiAgICAgICAgLy8g6K6+572uV2lkdGjjgILnoa7kv53lnKjmmL7npLrkuYvlkI7orr7nva7kuIvmi4nmoYbnmoTlrr3luqbvvIzpgb/lhY3mu5rliqjmnaHnmoTlvbHlk41cclxuICAgICAgICAvLyB0aGlzLnNldFBhbmVsV2lkdGgoKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5YWz6Zet6Z2i5p2/XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBoaWRlKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5pc1Nob3cpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LCAnZGlzcGxheScsICdub25lJyk7XHJcbiAgICAgICAgdGhpcy51bmxpc3RlblBvc2l0aW9uKCk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGFwcGVuZFRvQm9keUZhckF3YXkoKTogdm9pZCB7XHJcbiAgICAgICAgLy8g5aaC5p6c5LiN5ZyoYm9keeS4iu+8jOmCo+S5iOaMguWcqGJvZHnkuIrjgILvvIjpgLvovpHlupTor6Xnp7vlhaVQb3NpdGlvbi5zZXRQb3NpdGlvbuWQp++8jOWboOS4uumCo+S9jee9ruWwseaYr+aMieeFp2JvZHnlrprnmoTvvIzkuI3lnKhib2R55Lya5Ye66ZSZ44CC77yJXHJcbiAgICAgICAgaWYgKHRoaXMucmVuZGVyZXIucGFyZW50Tm9kZSh0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudCkgIT09IGRvY3VtZW50LmJvZHkpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZChkb2N1bWVudC5ib2R5LCB0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGVtYmVkZGVkVmlld1JlZjogRW1iZWRkZWRWaWV3UmVmPGFueT4gPSB0aGlzLmRyb3BUZW1wbGF0ZVJlZi5jcmVhdGVFbWJlZGRlZFZpZXcobnVsbCk7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwbGljYXRpb25SZWYuYXR0YWNoVmlldyhlbWJlZGRlZFZpZXdSZWYpOyAvLyDkuI3lgZrmraTlpITlpITnkIbvvIxuZy10ZW1wbGF0ZeS4reeahOagh+etvuS4jeS8muino+aekFxyXG4gICAgICAgICAgICBBcnJheS5mcm9tKGVtYmVkZGVkVmlld1JlZi5yb290Tm9kZXMpXHJcbiAgICAgICAgICAgICAgICAuZm9yRWFjaCgoaXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudCwgaXRlbSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6K6+572u5Zyo5p6B6L+c5aSE77yI6YC76L6R5bqU6K+l56e75YWlUG9zaXRpb24uc2V0UG9zaXRpb27lkKfvvIlcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LCAnbGVmdCcsICctOTk5OXB4Jyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudCwgJ3RvcCcsICctOTk5OXB4Jyk7XHJcbiAgICAgICAgLy8g5pu05pawbWF4LWhlaWdodOS4uum7mOiupOWAvHBhbmVsTWF4SGVpZ2h077yM5Zug5Li65LiK5qyh5pi+56S65Y+v6IO95pu05pS55LqGbWF4LWhlaWdodFxyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQsICdtYXgtaGVpZ2h0JywgdGhpcy5wYW5lbE1heEhlaWdodCk7XHJcbiAgICAgICAgLy8g6K6+572ud2lkdGgs5b2T5Ye6546w5rua5Yqo5p2h5pe2LOabtOaWsHdpZHRo5Li66buY6K6k55qEcGFuZWxXaWR0aO+8jOmBv+WFjea7muWKqOadoeWuveW6pueahOW9seWTjVxyXG4gICAgICAgIGlmICh0aGlzLnBhbmVsV2lkdGggPT09ICdhdXRvJykge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LCAnd2lkdGgnLCB0aGlzLnBhbmVsV2lkdGgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgc2V0U2hvdygpOiB2b2lkIHtcclxuICAgICAgICAvLyDmmL7npLrmiY3og73orqHnrpflrr3luqZcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LCAnZGlzcGxheScsICdibG9jaycpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDnm5HlkKzkvY3nva7lj5jljJYsIOW5tumakOiXj+mdouadv+OAguaJk+W8gOmdouadv+aXtuebkeWQrO+8jOWFs+mXreWSjOmUgOavgeaXtuWPlua2iOebkeWQrOOAglxyXG4gICAgICogVE9ETzog5bCd6K+VaGlkZeaUueS4unJlUG9zaXRpb25cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBsaXN0ZW5Qb3NpdGlvbigpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnBvc0hhbmRsZXMgPSBQb3NpdGlvbi5hZGRQb3NDaGFuZ2VFdnRzKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgfSwgdGhpcy5yZW5kZXJlcik7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHVubGlzdGVuUG9zaXRpb24oKTogdm9pZCB7XHJcbiAgICAgICAgUG9zaXRpb24ucmVtb3ZlUG9zQ2hhbmdlRXZ0cyh0aGlzLnBvc0hhbmRsZXMpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDnoa7lrprlhYPntKDnmoTmmL7npLrmoLflvI/vvIzljIXmi6zkvY3nva7jgIHmnIDlpKfpq5jluqbjgIHlkJHkuIrmiJblkJHkuItcclxuICAgICAqIEByZXR1cm5zIOWumuS9jee7k+aenOWvueixoVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2V0UG9zaXRpb24oKTogVGlIb3N0TGF5b3V0IHtcclxuICAgICAgICBjb25zdCBkb21pbmF0b3JTcGFjZTogbnVtYmVyID0gcGFyc2VJbnQodGhpcy5kb21pbmF0b3JTcGFjZSwgMTApO1xyXG4gICAgICAgIGNvbnN0IGJyb3dzZXJTcGFjZTogbnVtYmVyID0gcGFyc2VJbnQodGhpcy5icm93c2VyU3BhY2UsIDEwKTtcclxuICAgICAgICBjb25zdCBkZXRlcm1pblBvc2l0aW9uRm46IChsYXlvdXQ6IGFueSkgPT4gc3RyaW5nID0gVXRpbC5pc0Z1bmN0aW9uKHRoaXMuZGV0ZXJtaW5Qb3NpdGlvbkZuKSA/IHRoaXMuZGV0ZXJtaW5Qb3NpdGlvbkZuIDpcclxuICAgICAgICAgICAgdGhpcy5kZWZhdWx0RGV0ZXJtaW5Qb3NpdGlvbkZuO1xyXG5cclxuICAgICAgICAvLyDorr7nva7kvY3nva5cclxuICAgICAgICBjb25zdCByZXN1bHQ6IFRpUG9zaXRpb25SZXN1bHQgPSBQb3NpdGlvbi5zZXRQb3NpdGlvbih7XHJcbiAgICAgICAgICAgIHRhcmdldEVsZTogdGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQsXHJcbiAgICAgICAgICAgIGhvc3RFbGU6IHRoaXMuZG9taW5hdG9yRWxlbSxcclxuICAgICAgICAgICAgLy8gcG9zaXRpb246IHVuZGVmaW5lZCwgLy8g5Y+v6YCJ5Y+C5pWwXHJcbiAgICAgICAgICAgIGhvc3RTcGFjZTogZG9taW5hdG9yU3BhY2UsXHJcbiAgICAgICAgICAgIGJyb3dzZXJTcGFjZSxcclxuICAgICAgICAgICAgZml4TWF4SGVpZ2h0OiB0aGlzLmZpeE1heEhlaWdodCxcclxuICAgICAgICAgICAgaE9mZnNldDogdGhpcy5oT2Zmc2V0LFxyXG4gICAgICAgICAgICBkZXRlcm1pblBvc2l0aW9uRm5cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5ob3N0TGF5b3V0O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZXNldFBvc2l0aW9uKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOiusOW9leS4iuS4gOasoWRvbWluYXRvciBsZWZ05YC8XHJcbiAgICAgICAgY29uc3QgaG9zdExheW91dDogVGlIb3N0TGF5b3V0ID0gdGhpcy5zZXRQb3NpdGlvbigpO1xyXG4gICAgICAgIGNvbnN0IGRvbWluYXRvckxhc3RMZWZ0OiBudW1iZXIgPSBob3N0TGF5b3V0ICYmIGhvc3RMYXlvdXQubGVmdDtcclxuICAgICAgICAvLyDorrDlvZXlvZPliY1kb21pbmF0b3IgbGVmdOWAvFxyXG4gICAgICAgIGNvbnN0IGRvbWluYXRvckN1ckxlZnQ6IG51bWJlciA9IFBvc2l0aW9uLmdldEhvc3RFbGVMYXlvdXQodGhpcy5kb21pbmF0b3JFbGVtKS5sZWZ0O1xyXG5cclxuICAgICAgICAvLyBkb21pbmF0b3Llj5HnlJ/msLTlubPkvY3np7vkuJTpnaLmnb/lpITkuo7miZPlvIDnirbmgIHml7bvvIzpnIDph43mlrDlrprkvY1cclxuICAgICAgICAvLyDkuLvopoHlnLrmma/vvJrkuIvmi4npnaLmnb/mlbDmja7ph4/lj5jliqjlvJXotbdib2R55Ye6546w56uW5ZCR5rua5Yqo5p2h77yMZG9taW5hdG9y5Y+R55Sf5rC05bmz5pa55ZCR5YGP56e7O1xyXG4gICAgICAgIGlmIChkb21pbmF0b3JMYXN0TGVmdCAhPT0gZG9taW5hdG9yQ3VyTGVmdCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc1Nob3cpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0UG9zaXRpb24oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldFBhbmVsV2lkdGgoKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgcGFuZWxXaWR0aE51bTogbnVtYmVyID0gcGFyc2VJbnQodGhpcy5wYW5lbFdpZHRoLCAxMCk7XHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsV2lkdGg6IG51bWJlciA9IHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoIC0gdGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQuY2xpZW50V2lkdGg7XHJcbiAgICAgICAgY29uc3QgZG9taW5hdG9yRWxlbVdpZHRoOiBudW1iZXIgPSB0aGlzLmRvbWluYXRvckVsZW0ub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgbGV0IHdpZHRoOiBzdHJpbmc7XHJcbiAgICAgICAgaWYgKCFpc05hTihwYW5lbFdpZHRoTnVtKSkge1xyXG4gICAgICAgICAgICB3aWR0aCA9IHBhbmVsV2lkdGhOdW0gKyAncHgnO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5wYW5lbFdpZHRoID09PSAnYXV0bycpIHtcclxuICAgICAgICAgICAgd2lkdGggPSAnYXV0byc7XHJcbiAgICAgICAgICAgIC8vIEZpeCBidWc6IOmdnklF5LiL5rua5Yqo5p2h5Lya6KaG55uW6YOo5YiG5YaF5a65XHJcbiAgICAgICAgICAgIGlmICghVGlCcm93c2VyLmlzSUUoKSkge1xyXG4gICAgICAgICAgICAgICAgLy8g6ZyA6KaB6YeN572u5a695bqm6K6+572u77yM5qC55o2u5LiL5ouJ6Z2i5p2/55qE55yf5a6e5a695bqm56Gu5a6a5piv5ZCm6ZyA6KaB5aKe5Yqg5rua5Yqo5p2h5a695bqmXHJcbiAgICAgICAgICAgICAgICB3aWR0aCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAvLyDmnInmu5rliqjmnaHlh7rnjrDkuJTmlofmnKzovoPplb/ml7bvvIzpnIDopoHlho3lop7liqDmu5rliqjmnaHnmoTlrr3luqbvvIzlkKbliJnlhoXlrrnmmL7npLrkuI3lhahcclxuICAgICAgICAgICAgICAgIGlmIChzY3JvbGxXaWR0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoID0gdGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGggKyBzY3JvbGxXaWR0aCArICdweCc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgbWluV2lkdGg6IHN0cmluZyA9IGRvbWluYXRvckVsZW1XaWR0aCArICdweCc7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQsICdtaW4td2lkdGgnLCBtaW5XaWR0aCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8g6buY6K6k5a695bqm6K6+572u77yM5YyF5ZCranVzdGlmaWVkXHJcbiAgICAgICAgICAgIHdpZHRoID0gZG9taW5hdG9yRWxlbVdpZHRoICsgJ3B4JztcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6K6+572uXHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudCwgJ3dpZHRoJywgd2lkdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWGs+WumuS4iuS4i+S9jee9rueahOWHveaVsFxyXG4gICAgcHJpdmF0ZSBkZWZhdWx0RGV0ZXJtaW5Qb3NpdGlvbkZuOiAobGF5b3V0OiBhbnkpID0+IHN0cmluZyA9IChsYXlvdXQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRvbWluYXRvclNwYWNlOiBudW1iZXIgPSBwYXJzZUludCh0aGlzLmRvbWluYXRvclNwYWNlLCAxMCk7XHJcbiAgICAgICAgY29uc3QgYnJvd3NlclNwYWNlOiBudW1iZXIgPSBwYXJzZUludCh0aGlzLmJyb3dzZXJTcGFjZSwgMTApO1xyXG4gICAgICAgIGNvbnN0IG5lZWRIZWlnaHQ6IG51bWJlciA9IGxheW91dC50YXJnZXRMYXlvdXQuaGVpZ2h0ICsgZG9taW5hdG9yU3BhY2UgKyBicm93c2VyU3BhY2U7XHJcbiAgICAgICAgaWYgKGxheW91dC5hdmlsYWJsZUxheW91dC5ib3R0b20gPj0gbmVlZEhlaWdodCkgeyAvLyDkuIvmlrnnqbrpl7TotrPlpJ/vvIzlkJHkuIvlsZXlvIBcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFuZWxBbGlnbiA9PT0gJ2xlZnQnID8gJ2JvdHRvbS1sZWZ0JyA6ICdib3R0b20tcmlnaHQnO1xyXG4gICAgICAgIH0gZWxzZSBpZiAobGF5b3V0LmF2aWxhYmxlTGF5b3V0LnRvcCA+PSBuZWVkSGVpZ2h0KSB7IC8vIOS4iuaWueepuumXtOi2s+Wkn++8jOWQkeS4iuWxleW8gFxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYW5lbEFsaWduID09PSAnbGVmdCcgPyAndG9wLWxlZnQnIDogJ3RvcC1yaWdodCc7XHJcbiAgICAgICAgfSBlbHNlIGlmIChsYXlvdXQuYXZpbGFibGVMYXlvdXQuYm90dG9tID49IGxheW91dC5hdmlsYWJsZUxheW91dC50b3ApIHsgLy8g5LiL5pa556m66Ze06L6D5aSn77yM5YiZ5ZCR5LiL5bGV5byAXHJcbiAgICAgICAgICAgIC8vIOWboOS4uuaXpeWOhue7hOS7tuWtmOWcqOmXrumimO+8jOacgOWkp+mrmOW6puS4jeWOi+e8qe+8jOaegeerr+aDheWGteaXtuS8muaYvuekuuWcqHRvcOS4uui0n+aYvuekuuS4jeWFqOOAguaJgOS7peaXpeWOhue7hOS7tuWwvemHj+WQkeS4i+W8ueWHuuOAglxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYW5lbEFsaWduID09PSAnbGVmdCcgPyAnYm90dG9tLWxlZnQnIDogJ2JvdHRvbS1yaWdodCc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5wYW5lbEFsaWduID09PSAnbGVmdCcgPyAndG9wLWxlZnQnIDogJ3RvcC1yaWdodCc7IC8vIOWQkeS4iuWxleW8gFxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuLy8gb2Zmc2V0V2lkdGjlsZ7mgKflj6/ku6Xov5Tlm57lr7nosaHnmoRwYWRkaW5nK2JvcmRlcit3aWR0aOWxnuaAp+WAvOS5i+WSjCwg5piv5pW05pWw44CC5LiOalF1ZXJ555qEb3V0ZXJXaWR0aCgp5a6M5YWo55u45ZCM77yMb3V0ZXJXaWR0aCh0cnVlKeW4puacieWklui+uei3neOAglxyXG4vLyBFbGVtZW50LmNsaWVudFdpZHRoIOWxnuaAp+ihqOekuuWFg+e0oOeahOWGhemDqOWuveW6pu+8jOS7peWDj+e0oOiuoeOAguivpeWxnuaAp+WMheaLrOWGhei+uei3ne+8jOS9huS4jeWMheaLrOWeguebtOa7muWKqOadoe+8iOWmguaenOacie+8ieOAgei+ueahhuWSjOWklui+uei3neOAglxyXG4iXX0=