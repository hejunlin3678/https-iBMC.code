import { Component, ElementRef, EventEmitter, Input, IterableDiffers, NgZone, Output, QueryList, Renderer2, ViewChild, ViewChildren } from '@angular/core';
import { Util } from '../../utils/Util';
import { TiBaseComponent } from '../base/TiBaseModule';
/**
 * steps步骤组件
 *
 * 点击可跳转和不可跳转两种方式（默认点击不跳转）
 *
 * <example-url>../tiny3demo/#/steps/steps-all</example-url>
 */
export class TiStepsComponent extends TiBaseComponent {
    constructor(elementRef, renderer2, iterableDiffers, zone) {
        super(elementRef, renderer2);
        this.elementRef = elementRef;
        this.renderer2 = renderer2;
        this.iterableDiffers = iterableDiffers;
        this.zone = zone;
        /**
         * 是否支持点击跳转功能，默认不支持
         */
        this.clickable = false;
        /**
         * 用户可指定要显示的属性值，默认显示label属性
         */
        this.labelKey = 'label';
        /**
         * 宽度是否自动撑满父容器。
         *
         * 不设置时默认各步骤间线宽60px，步骤确定后整体宽度固定；设置为true时，整体宽度会自适应撑满父容器，适用于在弹窗中使用的场景。
         */
        this.adaptive = false;
        /**
         * 当前步骤改变时的事件
         */
        this.activeStepChange = new EventEmitter();
        /**
         * 点击后用户可根据条件判断是否跳转:见测试用例
         */
        this.beforeStep = new EventEmitter();
        this.isInitLabelChange = true;
        this.explainTotalWidth = 0;
        // 设置每个步骤之间的横线的宽度
        this.setLineWidth = (width) => {
            this.explainTotalWidth = Util.isUndefined(width) ? this.getExplainTotalWidth() : width;
            this.lineRef.forEach((stepLine) => {
                this.renderer2.setStyle(stepLine.nativeElement, 'width', `calc((100% - ${this.explainTotalWidth}px) / ${this.steps.length - 1})`);
            });
        };
    }
    ngOnInit() {
        super.ngOnInit();
        if (!this.adaptive) {
            return;
        }
        // this.trackByLabelFn监听对象：可以深度监听
        this.stepsDiffer = this.iterableDiffers.find(this.steps)
            .create(this.trackByLabelFn);
        // 修复错误：ERROR ReferenceError: window is not defined
        if (typeof window === 'undefined') {
            return;
        }
        this.zone.runOutsideAngular(() => {
            this.windowResizeListener = this.renderer2.listen(window, 'resize', this.setLineWidth);
        });
    }
    ngDoCheck() {
        if (this.adaptive) {
            // 处理增删步骤
            const stepsDiffer = this.stepsDiffer.diff(this.steps);
            if (stepsDiffer) {
                this.labelChange = true;
            }
        }
    }
    ngAfterViewChecked() {
        // 需要判断当label变化时才计算线长
        if (this.adaptive && this.labelChange) {
            this.labelChange = false;
            this.setLineWidth();
            // 初始时在前几次的 ngAfterViewChecked 中计算文本宽度，生产环境清缓存场景下计算有点不准确(时机有点早)，但在初始时的后几次ngAfterViewChecked中计算的文本宽度是准确的。
            // TODO: 是否有更合适的时机计算(已验证使用MutationObserver也解决不了，在ngAfterViewChecked中加setTimeout(0)也解决不了)
            if (this.isInitLabelChange) {
                setTimeout(() => {
                    const explainTotalWidth = this.getExplainTotalWidth();
                    if (explainTotalWidth !== this.explainTotalWidth) {
                        this.setLineWidth(explainTotalWidth);
                    }
                }, 50); // 50ms是经验值
                this.isInitLabelChange = false;
            }
        }
    }
    ngOnDestroy() {
        if (this.windowResizeListener) {
            this.windowResizeListener();
        }
    }
    /**
     * @ignore
     * 每步的点击事件处理
     */
    onClick(step) {
        // 不支持点击跳转和当前项灰化时，不处理
        if (!this.clickable || step.disabled || this.activeStep === step) {
            return;
        }
        // 未定义beforeStep事件，直接跳转，定义beforeStep事件将当前点击项索引传出
        if (this.beforeStep.observers.length === 0) {
            this.activeStep = step;
            this.activeStepChange.emit(this.activeStep);
        }
        else {
            this.beforeStep.emit(step);
        }
    }
    getExplainTotalWidth() {
        let explainTotalWidth = 0;
        if (!Util.isUndefined(this.explainRef)) {
            this.explainRef.forEach((step) => {
                // 计算每步选择框和文字的总长度
                explainTotalWidth += step.nativeElement.offsetWidth;
            });
        }
        return explainTotalWidth;
    }
    /**
     * @ignore
     * Diff监听steps中label值的改变
     */
    trackByLabelFn(index, item) {
        return item.label;
    }
    /**
     * @ignore
     * ngFor 使用
     */
    trackByIndexFn(index) {
        return index;
    }
    /**
     * @ignore
     * 判断当前项的状态
     */
    getStepState(index) {
        const activedIndex = this.steps.indexOf(this.activeStep);
        if (index < activedIndex) {
            return 'complete';
        }
        else if (index === activedIndex) {
            return 'active';
        }
        else {
            return 'uncomplete';
        }
    }
}
TiStepsComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-steps',
                template: "<ul class=\"ti3-steps\" #stepRef [id]=\"appendId('list')\">\r\n    <ng-container *ngFor=\"let step of steps; let i=index; trackBy: trackByIndexFn\">\r\n        <li class=\"ti3-steps-line\" #line *ngIf=\"i > 0\"\r\n            [ngClass]=\"{'ti3-steps-complete': getStepState(i) === 'complete',\r\n                    'ti3-steps-active':getStepState(i) === 'active',\r\n                    'ti3-steps-uncomplete': getStepState(i) === 'uncomplete' && clickable && !step.disabled}\">\r\n        </li>\r\n\r\n        <li [id]=\"appendId(i)\" class=\"ti3-steps-explain\" #explain\r\n            [ngClass]=\"{'ti3-steps-complete': getStepState(i) === 'complete',\r\n                    'ti3-steps-active':getStepState(i) === 'active',\r\n                    'ti3-steps-disabled': getStepState(i) === 'uncomplete' && (step.disabled || !clickable),\r\n                    'ti3-steps-uncomplete': getStepState(i) === 'uncomplete' && clickable && !step.disabled,\r\n                    'ti3-steps-explain-clickable': clickable && !step.disabled}\"\r\n            (click)=\"onClick(step)\"\r\n            (keydown.enter)=\"onClick(step)\"\r\n            tiOutline\r\n            [attr.tabindex]=\"clickable && !step.disabled ? 0 : -1\">\r\n            <div class=\"ti3-steps-box\">\r\n                <div class=\"ti3-steps-box-number\">{{i + 1}}</div>\r\n            </div>\r\n            <div class=\"ti3-steps-text\" [ngStyle]=\"{'max-width': maxWidth}\" [id]=\"appendId('i_label')\"\r\n                tiOverflow [textContent]=\"step[labelKey]\" [maxLine]=\"2\">{{step[labelKey]}}</div>\r\n        </li>\r\n    </ng-container>\r\n</ul>\r\n\r\n",
                styles: ["::ng-deep :root{--ti-steps-box-border-width:1px;--ti-steps-box-size:20px;--ti-steps-line-height:1px;--ti-steps-line-width:60px;--ti-steps-transition-time:300ms}:host{display:block}.ti3-steps{padding:var(--ti-common-space-3x) 0;white-space:nowrap}.ti3-steps .ti3-steps-explain{display:inline-block;vertical-align:top}.ti3-steps .ti3-steps-explain .ti3-steps-box{-ms-box-sizing:border-box;border:var(--ti-steps-box-border-width) solid;border-radius:50%;box-sizing:border-box;display:inline-block;font-size:var(--ti-steps-number-font-size);height:var(--ti-steps-box-size);margin-left:var(--ti-common-space-2x);position:relative;width:var(--ti-steps-box-size)}.ti3-steps .ti3-steps-explain .ti3-steps-box:before{background-color:var(--ti-steps-box-bg-color-highlight);border-radius:50%;content:\"\";display:inline-block;height:var(--ti-steps-box-size);opacity:0;position:absolute;right:calc(-1*var(--ti-steps-box-border-width));top:calc(-1*var(--ti-steps-box-border-width));width:var(--ti-steps-box-size)}.ti3-steps .ti3-steps-explain .ti3-steps-box .ti3-steps-box-number{height:100%;line-height:calc(var(--ti-steps-box-size) - var(--ti-steps-box-border-width)*2 - 1px);position:absolute;text-align:center;width:100%}.ti3-steps .ti3-steps-explain .ti3-steps-text{display:inline-block;line-height:var(--ti-steps-box-size);margin:0 var(--ti-common-space-2x) 0 var(--ti-common-space-base);max-width:150px;vertical-align:top;white-space:normal;word-break:break-word}.ti3-steps li:first-child.ti3-steps-explain .ti3-steps-box{margin-left:0}.ti3-steps li:last-child.ti3-steps-explain .ti3-steps-text{margin-right:0}.ti3-steps .ti3-steps-explain-clickable{cursor:pointer}.ti3-steps .ti3-steps-line{background-color:var(--ti-steps-line-color);display:inline-block;font-size:0;height:var(--ti-steps-line-height);line-height:0;margin-top:calc((var(--ti-steps-box-size) - var(--ti-steps-line-height))/2);min-width:20px;vertical-align:top;width:var(--ti-steps-line-width)}.ti3-steps .ti3-steps-line:before{background-color:var(--ti-steps-line-color-highlight);content:\" \";display:inline-block;height:100%;width:0}.ti3-steps .ti3-steps-uncomplete.ti3-steps-line:before{transition:width var(--ti-steps-transition-time);width:0}.ti3-steps .ti3-steps-uncomplete.ti3-steps-explain .ti3-steps-box{border-color:var(--ti-steps-box-uncomplete);color:var(--ti-steps-box-uncomplete)}.ti3-steps .ti3-steps-uncomplete.ti3-steps-explain .ti3-steps-box:before{opacity:0;transform:scale(0);transition:transform var(--ti-steps-transition-time),opacity var(--ti-steps-transition-time)}.ti3-steps .ti3-steps-uncomplete.ti3-steps-explain .ti3-steps-text{-webkit-background-clip:text;background-image:linear-gradient(var(--ti-steps-text-highlight),var(--ti-steps-text-highlight));background-image:-ms-linear-gradient(top,transparent,transparent);background-repeat:no-repeat;background-size:0 100%;color:var(--ti-steps-text-uncomplete);transition:background-size var(--ti-steps-transition-time),color var(--ti-steps-transition-time)}.ti3-steps .ti3-steps-complete.ti3-steps-line:before{transition:width var(--ti-steps-transition-time);width:100%}.ti3-steps .ti3-steps-complete.ti3-steps-explain .ti3-steps-box{border-color:var(--ti-steps-box-highlight);color:var(--ti-steps-box-highlight)}.ti3-steps .ti3-steps-complete.ti3-steps-explain .ti3-steps-box:before{opacity:0;transform:scale(0);transition:transform var(--ti-steps-transition-time),opacity var(--ti-steps-transition-time)}.ti3-steps .ti3-steps-complete.ti3-steps-explain .ti3-steps-text{color:var(--ti-steps-text-highlight)}.ti3-steps .ti3-steps-active.ti3-steps-line:before{transition:width var(--ti-steps-transition-time);width:100%}.ti3-steps .ti3-steps-active.ti3-steps-explain .ti3-steps-box{border-color:var(--ti-steps-box-highlight);color:var(--ti-steps-box-number-active)}.ti3-steps .ti3-steps-active.ti3-steps-explain .ti3-steps-box:before{opacity:1;transform:scale(1);transition:transform var(--ti-steps-transition-time),opacity var(--ti-steps-transition-time)}.ti3-steps .ti3-steps-active.ti3-steps-explain .ti3-steps-text{-webkit-background-clip:text;background-image:linear-gradient(var(--ti-steps-text-highlight),var(--ti-steps-text-highlight));background-image:-ms-linear-gradient(top,transparent,transparent);background-repeat:no-repeat;background-size:100% 100%;color:var(--ti-steps-text-highlight);transition:background-size var(--ti-steps-transition-time),color var(--ti-steps-transition-time)}.ti3-steps .ti3-steps-disabled.ti3-steps-explain .ti3-steps-box{border-color:var(--ti-steps-box-disabled);color:var(--ti-steps-box-disabled)}.ti3-steps .ti3-steps-disabled.ti3-steps-explain .ti3-steps-box:before{display:none!important}.ti3-steps .ti3-steps-disabled.ti3-steps-explain .ti3-steps-text{color:var(--ti-steps-text-disabled);cursor:not-allowed}"]
            },] }
];
TiStepsComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: IterableDiffers },
    { type: NgZone }
];
TiStepsComponent.propDecorators = {
    steps: [{ type: Input }],
    clickable: [{ type: Input }],
    maxWidth: [{ type: Input }],
    labelKey: [{ type: Input }],
    activeStep: [{ type: Input }],
    adaptive: [{ type: Input }],
    activeStepChange: [{ type: Output }],
    beforeStep: [{ type: Output }],
    stepsRef: [{ type: ViewChild, args: ['stepRef',] }],
    lineRef: [{ type: ViewChildren, args: ['line',] }],
    explainRef: [{ type: ViewChildren, args: ['explain',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlTdGVwc0NvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9jb21wb25lbnRzL3N0ZXBzL1RpU3RlcHNDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFDTCxlQUFlLEVBQ2YsTUFBTSxFQUNOLE1BQU0sRUFDTixTQUFTLEVBQ1QsU0FBUyxFQUNULFNBQVMsRUFDVCxZQUFZLEVBQ2YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUV2RDs7Ozs7O0dBTUc7QUFPSCxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsZUFBZTtJQTJEakQsWUFBc0IsVUFBc0IsRUFDdEIsU0FBb0IsRUFDdEIsZUFBZ0MsRUFDaEMsSUFBWTtRQUNwQixLQUFLLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBSm5CLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUN0QixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsU0FBSSxHQUFKLElBQUksQ0FBUTtRQWxEaEM7O1dBRUc7UUFDTSxjQUFTLEdBQVksS0FBSyxDQUFDO1FBS3BDOztXQUVHO1FBQ00sYUFBUSxHQUFXLE9BQU8sQ0FBQztRQUtwQzs7OztXQUlHO1FBQ00sYUFBUSxHQUFZLEtBQUssQ0FBQztRQUNuQzs7V0FFRztRQUNnQixxQkFBZ0IsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNqRjs7V0FFRztRQUNnQixlQUFVLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFlbkUsc0JBQWlCLEdBQVksSUFBSSxDQUFDO1FBQ2xDLHNCQUFpQixHQUFXLENBQUMsQ0FBQztRQWdGdEMsaUJBQWlCO1FBQ1YsaUJBQVksR0FBRyxDQUFDLEtBQWMsRUFBUSxFQUFFO1lBQzNDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQ3ZGLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBb0IsRUFBRSxFQUFFO2dCQUMxQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLE9BQU8sRUFDbkQsZ0JBQWdCLElBQUksQ0FBQyxpQkFBaUIsU0FBUyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2pGLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFBO0lBaEZELENBQUM7SUFFRCxRQUFRO1FBQ0osS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2hCLE9BQU87U0FDVjtRQUNELGlDQUFpQztRQUNqQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNwRSxtREFBbUQ7UUFDbkQsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUU7WUFDL0IsT0FBTztTQUNWO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7WUFDN0IsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzNGLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFNBQVM7UUFDTCxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDZixTQUFTO1lBQ1QsTUFBTSxXQUFXLEdBQVEsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNELElBQUksV0FBVyxFQUFFO2dCQUNiLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2FBQzNCO1NBQ0o7SUFDTCxDQUFDO0lBRUQsa0JBQWtCO1FBQ2QscUJBQXFCO1FBQ3JCLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ25DLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNwQix3R0FBd0c7WUFDeEcsd0ZBQXdGO1lBQ3hGLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO2dCQUN4QixVQUFVLENBQUMsR0FBRyxFQUFFO29CQUNaLE1BQU0saUJBQWlCLEdBQVcsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7b0JBQzlELElBQUksaUJBQWlCLEtBQUssSUFBSSxDQUFDLGlCQUFpQixFQUFFO3dCQUM5QyxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFpQixDQUFDLENBQUM7cUJBQ3hDO2dCQUNMLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVc7Z0JBQ25CLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7YUFDbEM7U0FDSjtJQUNMLENBQUM7SUFFRCxXQUFXO1FBQ1AsSUFBSSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDM0IsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7U0FDL0I7SUFDTCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksT0FBTyxDQUFDLElBQVM7UUFDcEIscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxJQUFJLEVBQUU7WUFDOUQsT0FBTztTQUNWO1FBRUQsZ0RBQWdEO1FBQ2hELElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN4QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztZQUN2QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMvQzthQUFNO1lBQ0gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDOUI7SUFDTCxDQUFDO0lBV08sb0JBQW9CO1FBQ3hCLElBQUksaUJBQWlCLEdBQVcsQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNwQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQWdCLEVBQUUsRUFBRTtnQkFDekMsaUJBQWlCO2dCQUNqQixpQkFBaUIsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQztZQUN4RCxDQUFDLENBQUMsQ0FBQztTQUNOO1FBRUQsT0FBTyxpQkFBaUIsQ0FBQztJQUM3QixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksY0FBYyxDQUFDLEtBQWEsRUFBRSxJQUFTO1FBQzFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksY0FBYyxDQUFDLEtBQWE7UUFDL0IsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVEOzs7T0FHRztJQUNJLFlBQVksQ0FBQyxLQUFhO1FBQzdCLE1BQU0sWUFBWSxHQUFXLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNqRSxJQUFJLEtBQUssR0FBRyxZQUFZLEVBQUU7WUFDdEIsT0FBTyxVQUFVLENBQUM7U0FDckI7YUFBTSxJQUFJLEtBQUssS0FBSyxZQUFZLEVBQUU7WUFDL0IsT0FBTyxRQUFRLENBQUM7U0FDbkI7YUFBTTtZQUNILE9BQU8sWUFBWSxDQUFDO1NBQ3ZCO0lBQ0wsQ0FBQzs7O1lBak1KLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsVUFBVTtnQkFDcEIsK21EQUEyQjs7YUFFOUI7OztZQXpCRyxVQUFVO1lBT1YsU0FBUztZQUpULGVBQWU7WUFDZixNQUFNOzs7b0JBa0NMLEtBQUs7d0JBSUwsS0FBSzt1QkFJTCxLQUFLO3VCQUlMLEtBQUs7eUJBSUwsS0FBSzt1QkFNTCxLQUFLOytCQUlMLE1BQU07eUJBSU4sTUFBTTt1QkFJTixTQUFTLFNBQUMsU0FBUztzQkFJbkIsWUFBWSxTQUFDLE1BQU07eUJBSW5CLFlBQVksU0FBQyxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIENvbXBvbmVudCxcclxuICAgIEVsZW1lbnRSZWYsXHJcbiAgICBFdmVudEVtaXR0ZXIsXHJcbiAgICBJbnB1dCxcclxuICAgIEl0ZXJhYmxlRGlmZmVycyxcclxuICAgIE5nWm9uZSxcclxuICAgIE91dHB1dCxcclxuICAgIFF1ZXJ5TGlzdCxcclxuICAgIFJlbmRlcmVyMixcclxuICAgIFZpZXdDaGlsZCxcclxuICAgIFZpZXdDaGlsZHJlblxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbmltcG9ydCB7IFRpQmFzZUNvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2UvVGlCYXNlTW9kdWxlJztcclxuXHJcbi8qKlxyXG4gKiBzdGVwc+atpemqpOe7hOS7tlxyXG4gKlxyXG4gKiDngrnlh7vlj6/ot7PovazlkozkuI3lj6/ot7PovazkuKTnp43mlrnlvI/vvIjpu5jorqTngrnlh7vkuI3ot7PovazvvIlcclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnkzZGVtby8jL3N0ZXBzL3N0ZXBzLWFsbDwvZXhhbXBsZS11cmw+XHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAndGktc3RlcHMnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL3N0ZXBzLmh0bWwnLFxyXG4gICAgc3R5bGVVcmxzOiBbJy4vc3RlcHMubGVzcyddXHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgVGlTdGVwc0NvbXBvbmVudCBleHRlbmRzIFRpQmFzZUNvbXBvbmVudCB7XHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruatpemqpOe7hOS7tueahOavj+S4gOatpeWGheWuueOAglxyXG4gICAgICog5pWw57uE55qE5q+P5Liq5YWD57Sg6YO95piv5LiA5Liq5a+56LGh77yM5a+55bqU5q+P5Liq5q2l6aqk55qE5LiA6aG544CC6L+Z5Liq5a+56LGh5pyJMuS4quWPr+mAieWxnuaAp++8mlxyXG4gICAgICpcclxuICAgICAqIDEuc3RlcHNbaV0ubGFiZWzvvIjnsbvlnovvvJpTdHJpbmc7IOiuvue9ruavj+S4quatpemqpOWvueW6lOeahOaWh+acrO+8ieOAgu+8iOmdnuW/hemAie+8iVxyXG4gICAgICpcclxuICAgICAqIDIuc3RlcHNbaV0uZGlzYWJsZWTvvIjnsbvlnovvvJpCb29sZWFuOyDmjqfliLbmraXpqqTmmK/lkKbngbDljJYsIOW9k2NsaWNrYWJsZeS4unRydWXml7bmiY3nlJ/mlYjvvInjgILvvIjpnZ7lv4XpgInvvIlcclxuICAgICAqXHJcbiAgICAgKiAzLuWPr+aJqeWxleWFtuS7luWxnuaAp1xyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBzdGVwczogQXJyYXk8YW55PjtcclxuICAgIC8qKlxyXG4gICAgICog5piv5ZCm5pSv5oyB54K55Ye76Lez6L2s5Yqf6IO977yM6buY6K6k5LiN5pSv5oyBXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGNsaWNrYWJsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgLyoqXHJcbiAgICAgKiDmr4/kuKrmraXpqqTnmoTmlofmnKzmnIDlpKflrr3luqZcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgbWF4V2lkdGg6IHN0cmluZztcclxuICAgIC8qKlxyXG4gICAgICog55So5oi35Y+v5oyH5a6a6KaB5pi+56S655qE5bGe5oCn5YC877yM6buY6K6k5pi+56S6bGFiZWzlsZ7mgKdcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgbGFiZWxLZXk6IHN0cmluZyA9ICdsYWJlbCc7XHJcbiAgICAvKipcclxuICAgICAqIOaMh+WumuW9k+WJjeatpemqpFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBhY3RpdmVTdGVwOiBhbnk7XHJcbiAgICAvKipcclxuICAgICAqIOWuveW6puaYr+WQpuiHquWKqOaSkea7oeeItuWuueWZqOOAglxyXG4gICAgICpcclxuICAgICAqIOS4jeiuvue9ruaXtum7mOiupOWQhOatpemqpOmXtOe6v+WuvTYwcHjvvIzmraXpqqTnoa7lrprlkI7mlbTkvZPlrr3luqblm7rlrprvvJvorr7nva7kuLp0cnVl5pe277yM5pW05L2T5a695bqm5Lya6Ieq6YCC5bqU5pKR5ruh54i25a655Zmo77yM6YCC55So5LqO5Zyo5by556qX5Lit5L2/55So55qE5Zy65pmv44CCXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGFkYXB0aXZlOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICAvKipcclxuICAgICAqIOW9k+WJjeatpemqpOaUueWPmOaXtueahOS6i+S7tlxyXG4gICAgICovXHJcbiAgICBAT3V0cHV0KCkgcmVhZG9ubHkgYWN0aXZlU3RlcENoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICAgIC8qKlxyXG4gICAgICog54K55Ye75ZCO55So5oi35Y+v5qC55o2u5p2h5Lu25Yik5pat5piv5ZCm6Lez6L2sOuingea1i+ivleeUqOS+i1xyXG4gICAgICovXHJcbiAgICBAT3V0cHV0KCkgcmVhZG9ubHkgYmVmb3JlU3RlcDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBAVmlld0NoaWxkKCdzdGVwUmVmJykgc3RlcHNSZWY6IEVsZW1lbnRSZWY7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgQFZpZXdDaGlsZHJlbignbGluZScpIGxpbmVSZWY6IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPjtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBAVmlld0NoaWxkcmVuKCdleHBsYWluJykgZXhwbGFpblJlZjogUXVlcnlMaXN0PEVsZW1lbnRSZWY+O1xyXG4gICAgcHJpdmF0ZSBsYWJlbENoYW5nZTogYm9vbGVhbjsgLy8g5qCH5b+X5paH5pys6ZW/5bqm5piv5ZCm5Y+Y5YyW77yM5LuO6ICM6YeN5paw6K6h566X57q/6ZW/XHJcbiAgICBwcml2YXRlIHN0ZXBzRGlmZmVyOiBhbnk7XHJcbiAgICBwcml2YXRlIGlzSW5pdExhYmVsQ2hhbmdlOiBib29sZWFuID0gdHJ1ZTtcclxuICAgIHByaXZhdGUgZXhwbGFpblRvdGFsV2lkdGg6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIHdpbmRvd1Jlc2l6ZUxpc3RlbmVyOiAoKSA9PiB2b2lkO1xyXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgcmVuZGVyZXIyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGl0ZXJhYmxlRGlmZmVyczogSXRlcmFibGVEaWZmZXJzLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUpIHtcclxuICAgICAgICAgICAgICAgIHN1cGVyKGVsZW1lbnRSZWYsIHJlbmRlcmVyMik7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgICAgICBpZiAoIXRoaXMuYWRhcHRpdmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyB0aGlzLnRyYWNrQnlMYWJlbEZu55uR5ZCs5a+56LGh77ya5Y+v5Lul5rex5bqm55uR5ZCsXHJcbiAgICAgICAgdGhpcy5zdGVwc0RpZmZlciA9IHRoaXMuaXRlcmFibGVEaWZmZXJzLmZpbmQodGhpcy5zdGVwcylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY3JlYXRlKHRoaXMudHJhY2tCeUxhYmVsRm4pO1xyXG4gICAgICAgIC8vIOS/ruWkjemUmeivr++8mkVSUk9SIFJlZmVyZW5jZUVycm9yOiB3aW5kb3cgaXMgbm90IGRlZmluZWRcclxuICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyID0gdGhpcy5yZW5kZXJlcjIubGlzdGVuKHdpbmRvdywgJ3Jlc2l6ZScsIHRoaXMuc2V0TGluZVdpZHRoKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBuZ0RvQ2hlY2soKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuYWRhcHRpdmUpIHtcclxuICAgICAgICAgICAgLy8g5aSE55CG5aKe5Yig5q2l6aqkXHJcbiAgICAgICAgICAgIGNvbnN0IHN0ZXBzRGlmZmVyOiBhbnkgPSB0aGlzLnN0ZXBzRGlmZmVyLmRpZmYodGhpcy5zdGVwcyk7XHJcbiAgICAgICAgICAgIGlmIChzdGVwc0RpZmZlcikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sYWJlbENoYW5nZSA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdDaGVja2VkKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOmcgOimgeWIpOaWreW9k2xhYmVs5Y+Y5YyW5pe25omN6K6h566X57q/6ZW/XHJcbiAgICAgICAgaWYgKHRoaXMuYWRhcHRpdmUgJiYgdGhpcy5sYWJlbENoYW5nZSkge1xyXG4gICAgICAgICAgICB0aGlzLmxhYmVsQ2hhbmdlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0TGluZVdpZHRoKCk7XHJcbiAgICAgICAgICAgIC8vIOWIneWni+aXtuWcqOWJjeWHoOasoeeahCBuZ0FmdGVyVmlld0NoZWNrZWQg5Lit6K6h566X5paH5pys5a695bqm77yM55Sf5Lqn546v5aKD5riF57yT5a2Y5Zy65pmv5LiL6K6h566X5pyJ54K55LiN5YeG56GuKOaXtuacuuacieeCueaXqSnvvIzkvYblnKjliJ3lp4vml7bnmoTlkI7lh6DmrKFuZ0FmdGVyVmlld0NoZWNrZWTkuK3orqHnrpfnmoTmlofmnKzlrr3luqbmmK/lh4bnoa7nmoTjgIJcclxuICAgICAgICAgICAgLy8gVE9ETzog5piv5ZCm5pyJ5pu05ZCI6YCC55qE5pe25py66K6h566XKOW3sumqjOivgeS9v+eUqE11dGF0aW9uT2JzZXJ2ZXLkuZ/op6PlhrPkuI3kuobvvIzlnKhuZ0FmdGVyVmlld0NoZWNrZWTkuK3liqBzZXRUaW1lb3V0KDAp5Lmf6Kej5Yaz5LiN5LqGKVxyXG4gICAgICAgICAgICBpZiAodGhpcy5pc0luaXRMYWJlbENoYW5nZSkge1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhwbGFpblRvdGFsV2lkdGg6IG51bWJlciA9IHRoaXMuZ2V0RXhwbGFpblRvdGFsV2lkdGgoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXhwbGFpblRvdGFsV2lkdGggIT09IHRoaXMuZXhwbGFpblRvdGFsV2lkdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRMaW5lV2lkdGgoZXhwbGFpblRvdGFsV2lkdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIDUwKTsgLy8gNTBtc+aYr+e7j+mqjOWAvFxyXG4gICAgICAgICAgICAgICAgdGhpcy5pc0luaXRMYWJlbENoYW5nZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMud2luZG93UmVzaXplTGlzdGVuZXIoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDmr4/mraXnmoTngrnlh7vkuovku7blpITnkIZcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9uQ2xpY2soc3RlcDogYW55KTogdm9pZCB7XHJcbiAgICAgICAgLy8g5LiN5pSv5oyB54K55Ye76Lez6L2s5ZKM5b2T5YmN6aG554Gw5YyW5pe277yM5LiN5aSE55CGXHJcbiAgICAgICAgaWYgKCF0aGlzLmNsaWNrYWJsZSB8fCBzdGVwLmRpc2FibGVkIHx8IHRoaXMuYWN0aXZlU3RlcCA9PT0gc3RlcCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDmnKrlrprkuYliZWZvcmVTdGVw5LqL5Lu277yM55u05o6l6Lez6L2s77yM5a6a5LmJYmVmb3JlU3RlcOS6i+S7tuWwhuW9k+WJjeeCueWHu+mhuee0ouW8leS8oOWHulxyXG4gICAgICAgIGlmICh0aGlzLmJlZm9yZVN0ZXAub2JzZXJ2ZXJzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZVN0ZXAgPSBzdGVwO1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZVN0ZXBDaGFuZ2UuZW1pdCh0aGlzLmFjdGl2ZVN0ZXApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuYmVmb3JlU3RlcC5lbWl0KHN0ZXApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDorr7nva7mr4/kuKrmraXpqqTkuYvpl7TnmoTmqKrnur/nmoTlrr3luqZcclxuICAgIHB1YmxpYyBzZXRMaW5lV2lkdGggPSAod2lkdGg/OiBudW1iZXIpOiB2b2lkID0+IHtcclxuICAgICAgICB0aGlzLmV4cGxhaW5Ub3RhbFdpZHRoID0gVXRpbC5pc1VuZGVmaW5lZCh3aWR0aCkgPyB0aGlzLmdldEV4cGxhaW5Ub3RhbFdpZHRoKCkgOiB3aWR0aDtcclxuICAgICAgICB0aGlzLmxpbmVSZWYuZm9yRWFjaCgoc3RlcExpbmU6IEVsZW1lbnRSZWYpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlcjIuc2V0U3R5bGUoc3RlcExpbmUubmF0aXZlRWxlbWVudCwgJ3dpZHRoJyxcclxuICAgICAgICAgICAgICAgIGBjYWxjKCgxMDAlIC0gJHt0aGlzLmV4cGxhaW5Ub3RhbFdpZHRofXB4KSAvICR7dGhpcy5zdGVwcy5sZW5ndGggLSAxfSlgKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEV4cGxhaW5Ub3RhbFdpZHRoKCk6IG51bWJlciB7XHJcbiAgICAgICAgbGV0IGV4cGxhaW5Ub3RhbFdpZHRoOiBudW1iZXIgPSAwO1xyXG4gICAgICAgIGlmICghVXRpbC5pc1VuZGVmaW5lZCh0aGlzLmV4cGxhaW5SZWYpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXhwbGFpblJlZi5mb3JFYWNoKChzdGVwOiBFbGVtZW50UmVmKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyDorqHnrpfmr4/mraXpgInmi6nmoYblkozmloflrZfnmoTmgLvplb/luqZcclxuICAgICAgICAgICAgICAgIGV4cGxhaW5Ub3RhbFdpZHRoICs9IHN0ZXAubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZXhwbGFpblRvdGFsV2lkdGg7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiBEaWZm55uR5ZCsc3RlcHPkuK1sYWJlbOWAvOeahOaUueWPmFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgdHJhY2tCeUxhYmVsRm4oaW5kZXg6IG51bWJlciwgaXRlbTogYW55KTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gaXRlbS5sYWJlbDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIG5nRm9yIOS9v+eUqFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgdHJhY2tCeUluZGV4Rm4oaW5kZXg6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIGluZGV4O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5Yik5pat5b2T5YmN6aG555qE54q25oCBXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXRTdGVwU3RhdGUoaW5kZXg6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgYWN0aXZlZEluZGV4OiBudW1iZXIgPSB0aGlzLnN0ZXBzLmluZGV4T2YodGhpcy5hY3RpdmVTdGVwKTtcclxuICAgICAgICBpZiAoaW5kZXggPCBhY3RpdmVkSW5kZXgpIHtcclxuICAgICAgICAgICAgcmV0dXJuICdjb21wbGV0ZSc7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpbmRleCA9PT0gYWN0aXZlZEluZGV4KSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnYWN0aXZlJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gJ3VuY29tcGxldGUnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=