import { Component, ContentChild, ElementRef, EventEmitter, Input, IterableDiffers, KeyValueDiffers, Output, Renderer2, TemplateRef, ViewChild } from '@angular/core';
import { TiFormComponent } from '../base/TiBaseModule';
import { TiMenuComponent } from '../menu/TiMenuModule';
import { TiLocale } from '../../locale/TiLocaleModule';
// 空间设置规则：
// 可显示项目数（children项目必须出现在“更多”），最大显示数目，空间宽度。
// 更多”里面至少两个选项
// 如果只有一个带children项目那么直接用menu。
/**
 * ActionMenu菜单按钮组件
 *
 * ActionMenu组件主要是一组操作按钮。当按钮数量太多导致预留空间大小无法显示所有按钮时，自动将超出部分的按钮放置在一个menu组件下拉中。
 *
 * 使用该组件，用户只需关注操作项配置，无需关注操作项显示不足的情况。
 *
 * 注意：ExpressionChangedAfterItHasBeenCheckedError: Expression has changed after it was checked.（本组件在调试环境报此错误，不必理会。生产环境不报错，功能也不受影响。）
 *
 * <example-url>../tiny3demo/#/actionmenu/actionmenu-all</example-url>
 */
export class TiActionmenuComponent extends TiFormComponent {
    constructor(hostRef, renderer, iterableDiffers, keyValueDiffers) {
        super(hostRef, renderer);
        this.hostRef = hostRef;
        this.renderer = renderer;
        this.iterableDiffers = iterableDiffers;
        this.keyValueDiffers = keyValueDiffers;
        /**
         * 下拉面板最大宽度，超过时换行，对所有子菜单都生效。
         */
        this.panelMaxWidth = '130px';
        /**
         * 下拉面板最大高度度，超过时出现竖向滚动条，对所有子菜单都生效。
         */
        this.panelMaxHeight = '9999px';
        /**
         * 数据中要显示字符串的key
         */
        this.labelKey = 'label';
        /**
         * 用户点击选中菜单项事件
         */
        // tslint:disable-next-line:no-output-named-after-standard-event
        this.select = new EventEmitter();
        /* Menu参数透传end */
        /**
         * 外部容器宽度
         */
        this.maxWidth = '250px';
        /**
         * 各item的间距
         */
        this.space = '10px';
        // 分割线为divider，分割字符叫做separator（比如分割ip里的点）
        /**
         * 各item之间是否展示分割线
         *
         * 3.1.3新增
         */
        this.showDivider = true;
        /**
         * 最大显示个数, 包含下拉菜单
         */
        this.maxShowNum = 4;
        /**
         * @ignore
         * 下拉菜单绑定的选项数据
         */
        this.panelItems = [];
        /**
         * @ignore
         * 各item之间间隔的一半距离
         */
        this.halfSpace = '';
        this.needInitItems = false;
        const localeWords = TiLocale.getLocaleWords();
        this.moreText = localeWords.tiActionmenu.more;
        this.menuText = localeWords.tiActionmenu.operation;
    }
    // 纠正 IE下同一行两个元素 offsetTop 值可能存在的一些(目前测试到有1px)的误差
    static isEqualOffsetTop(elem1, elem2) {
        return Math.abs(elem1.offsetTop - elem2.offsetTop) <= 2;
    }
    /**
     * @ignore
     *  选中菜单内选项
     * @param item 菜单项数据
     */
    onSelect(item) {
        if (!item.disabled) {
            this.select.emit(item);
        }
    }
    ngOnInit() {
        super.ngOnInit();
        this.panelItems = this.items;
        this.halfSpace = Number.parseInt(this.space, 10) / 2 + 'px';
    }
    ngDoCheck() {
        if (this.data) {
            if (!this.dataDiffer) { // 首次docheck是ngOnInit()之后
                this.dataDiffer = this.keyValueDiffers.find(this.data)
                    .create();
            }
            const dataChanges = this.dataDiffer.diff(this.data);
            if (dataChanges) { // 根据data初始化items. 注意：第一次diff会走入changes
                this.items = this.dataToItemsFn(this.data);
            }
        }
        if (this.items) {
            if (!this.itemsDiffer) {
                this.itemsDiffer = this.iterableDiffers.find(this.items)
                    .create();
                this.needInitItems = true;
            }
            const itemsChanges = this.itemsDiffer.diff(this.items);
            // 注意：如果有数据，那么第一次diff会就走入changes。如果是空数据，第一次diff结果是null，不会进入changes。
            if (itemsChanges) { // 如果items改变，则重新初始化。
                this.needInitItems = true;
            }
        }
    }
    /**
     * 兼容旧版：
     * 10.0.3 版本之前只能内嵌一个模板，无命名。
     * 新版可以内嵌两个模板，示例书写要求都命名（#item，#tip）。
     * 但需要兼容旧版无命名测试用例。
     */
    // tslint:disable-next-line: use-life-cycle-interface
    ngAfterContentInit() {
        super.ngAfterContentInit();
        // 如果 item 模板为空 && 存在第一个模板，那么把第一个出现的 “非 #tip 标签” 的模板作为 item 模板
        if (!this.itemTemplate && this.firstTemplate
            && (this.firstTemplate.elementRef.nativeElement !== (this.tipTemplate && this.tipTemplate.elementRef.nativeElement))) {
            this.itemTemplate = this.firstTemplate;
        }
    }
    ngAfterViewChecked() {
        if (this.needInitItems) {
            this.initItems();
        }
        super.ngAfterViewChecked(); // 内部执行了autofocus
    }
    /**
     * 计算那些item应该显示在外部，移除不该显示的item，调整pannel上显示的item项，调整menu显示的文字。
     */
    initItems() {
        this.needInitItems = false;
        const itemElems = this.hostRef.nativeElement.getElementsByClassName('ti3-action-menu-item');
        const dividingElems = this.hostRef.nativeElement.getElementsByClassName('ti3-action-menu-divider');
        const menuElem = this.menuCom.nativeElement;
        const moreTextElem = this.hostRef.nativeElement.getElementsByClassName('tiMoreText')[0];
        const menuTextElem = this.hostRef.nativeElement.getElementsByClassName('tiMenuText')[0];
        // 情况一：items为空
        if (!this.items || this.items.length === 0) {
            this.setDisplay(menuElem, false);
            return;
        }
        else {
            this.setDisplay(menuElem, true);
        }
        // 注意: itemElems不是数组，并且数据更新时，取到的length不对。所以，得使用items的length
        let firstChildrenIndex = -1; // 第一个含有子项目的索引
        // 这个for循环，做了两件事：找含有子项目，重置item可见。
        for (let i = 0; i < this.items.length; i++) {
            if (this.items[i].hasOwnProperty('children')) {
                firstChildrenIndex = i; // 找到第一个含有子项目的索引
                // break;
            }
            this.setDisplay(itemElems[i], true); // 因为动态修改item，所以第二次进入时需要重置item可见。
        }
        // 情况二：不显示menu  //条件：没有超过最大显示个数，且最后一个项目也在第一行, 且没有子项
        if (this.items.length <= this.maxShowNum
            && TiActionmenuComponent.isEqualOffsetTop(itemElems[this.items.length - 1], itemElems[0])
            && firstChildrenIndex === -1) {
            for (let i = 0; i < this.items.length; i++) {
                this.setAttr(itemElems[i], 'disabled', this.items[i].disabled);
            }
            this.setDisplay(menuElem, false);
            // 设置可聚焦元素
            const focusItems = [];
            for (let i = 0; i < this.items.length; i++) {
                focusItems.push(itemElems[i]);
            }
            this.setFocusableElems(focusItems);
            return;
        }
        // 情况三：显示Menu，显示数目条件：有子项目的一定在菜单内/倒数第二个一定在菜单内/最大显示个数（含menu）。3值取最小。
        if (firstChildrenIndex === -1) {
            firstChildrenIndex = this.items.length; // firstChild给一个超越数组大小的索引，方便下面计算
        }
        let outShowNum = (this.items.length - 2) < (this.maxShowNum - 1) ? (this.items.length - 2) :
            (this.maxShowNum - 1) < (firstChildrenIndex + 1) ? (this.maxShowNum - 1) : (firstChildrenIndex + 1);
        for (let i = this.items.length - 1; i >= 0; i--) {
            if (i > outShowNum - 1) { // 本项属于超出的数目，先删除掉
                //  TODO: remove和style哪个效率高？
                this.setDisplay(itemElems[i], false);
                if (dividingElems[i]) {
                    this.setDisplay(dividingElems[i], false);
                }
            }
            else if (!TiActionmenuComponent.isEqualOffsetTop(menuElem, itemElems[0])) { // 菜单没有在第一行，删除本项
                this.setDisplay(itemElems[i], false);
                if (dividingElems[i]) {
                    this.setDisplay(dividingElems[i], false);
                }
                outShowNum--;
            }
            else {
                this.setAttr(itemElems[i], 'disabled', this.items[i].disabled);
            }
        }
        // 设置菜单显示文字，设置可聚焦元素
        if (outShowNum === 0) { // 立即生效，否则根据模板变量生效慢
            this.renderer.setStyle(menuElem, 'margin-left', '0px');
            this.setDisplay(moreTextElem, false);
            this.setDisplay(menuTextElem, true);
            // 设置可聚焦元素
            this.setFocusableElems(this.menuCom.getFocusableElems());
        }
        else {
            this.setDisplay(moreTextElem, true);
            this.setDisplay(menuTextElem, false);
            // 设置可聚焦元素
            const focusItems = [];
            for (let i = 0; i < outShowNum; i++) {
                focusItems.push(itemElems[i]);
            }
            this.setFocusableElems(focusItems.concat(this.menuCom.getFocusableElems()));
        }
        /**
         * 此句改变了模板变量，需要强制刷新
         * 这里引起ng-serve环境报错ExpressionChangedAfterItHasBeenCheckedError, 所以用Promise延时
         */
        Promise.resolve().then(() => {
            this.panelItems = this.items.slice(outShowNum, this.items.length);
        });
    }
    /**
     * 设置显示/隐藏样式，比ngIf更及时生效。
     * @param elem HTML元素
     * @param isShow 是否显示
     */
    setDisplay(elem, isShow) {
        this.renderer.setStyle(elem, 'display', isShow ? 'inline-block' : 'none');
    }
    /**
     * @ignore
     * ngFor遍历的 trackBy函数，防止数据更新导致所有DOM重新渲染。TODO：这里是否该使用trackBy?
     * @param index 索引
     * @param item 数据
     * @returns 索引
     */
    trackByFn(index, item) {
        return index;
    }
}
TiActionmenuComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-actionmenu',
                template: "<ng-container *ngFor=\"let item of items; let i = index; let first = first; let last = last; trackBy: trackByFn\">\r\n    <a href=\"javascript:void(0)\"\r\n        oncontextmenu=\"return false\"\r\n        class=\"ti3-action-menu-item\"\r\n        [ngStyle]=\"{ 'margin-left': first ? 'none' : halfSpace, 'margin-right': last ? 'none' : halfSpace}\"\r\n        (click)=\"onSelect(item)\"\r\n        [tiPopconfirm]=\"item.popConfig&&!item.disabled ? item.popConfig : {}\"\r\n        [id]=\"appendId('item'+i)\">\r\n        <section [tiTip]='tipTemplate ? tipTemplate : item.tip' [tiTipContext]='item' [tiTipPosition]='item.tipPosition'\r\n                 >\r\n                <ng-container *ngIf=\"itemTemplate else labelTemplate\">\r\n                        <ng-container *ngTemplateOutlet=\"itemTemplate; context: {$implicit: item,index: i}\">\r\n                        </ng-container>\r\n                </ng-container>\r\n                <ng-template #labelTemplate>{{item[labelKey]}}</ng-template>\r\n        </section>\r\n    </a>\r\n    <span class=\"ti3-action-menu-divider\" *ngIf=\"showDivider && !last\"></span>\r\n</ng-container>\r\n<ti-menu\r\npanelAlign=\"right\"\r\n[panelMaxWidth]=\"panelMaxWidth\"\r\n[panelMaxHeight]=\"panelMaxHeight\"\r\n[labelKey]=\"labelKey\"\r\n[items]=\"panelItems\"\r\n(select)=\"onSelect($event)\"\r\n[ngStyle]=\"{'margin-left': halfSpace}\"\r\nstyle=\"display: none\"\r\n[id]=\"appendId('menu')\">\r\n<section class=\"tiMoreText\" style=\"display:inline-block\">{{moreText}}</section>\r\n<section class=\"tiMenuText\" style=\"display:none\">{{menuText}}</section>\r\n<ng-template #item let-item let-i=index>\r\n        <ng-container *ngIf=\"itemTemplate else labelTemplate\">\r\n                <ng-container *ngTemplateOutlet=\"itemTemplate; context: {$implicit: item,index: i}\">\r\n                </ng-container>\r\n        </ng-container>\r\n        <ng-template #labelTemplate>{{item[labelKey]}}</ng-template>\r\n</ng-template>\r\n<ng-template #tip let-item=\"context\" *ngIf=\"tipTemplate\">\r\n        <ng-container *ngTemplateOutlet=\"tipTemplate; context: {context: item}\">\r\n        </ng-container>\r\n</ng-template>\r\n</ti-menu>\r\n\r\n",
                host: {
                    '[style.max-width]': 'maxWidth'
                },
                styles: [":host{display:inline-block}.ti3-action-menu-item{-ms-user-select:none;-webkit-user-select:none;color:var(--ti-actionmenu-item-text-color);cursor:pointer;display:inline-block;text-decoration:none;user-select:none}.ti3-action-menu-item:hover{color:var(--ti-actionmenu-item-text-color-hover);text-decoration:none}.ti3-action-menu-item[disabled]{cursor:not-allowed;outline:none!important;text-decoration:none}.ti3-action-menu-item[disabled] *{color:var(--ti-actionmenu-item-text-color-disabled)!important}a.ti3-action-menu-item:active,a.ti3-action-menu-item:focus{color:var(--ti-actionmenu-item-text-color-active)}.ti3-action-menu-divider{background:var(--ti-actionmenu-divider-color);display:inline-block;height:12px;position:relative;top:2px;width:1px}"]
            },] }
];
TiActionmenuComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: IterableDiffers },
    { type: KeyValueDiffers }
];
TiActionmenuComponent.propDecorators = {
    items: [{ type: Input }],
    panelMaxWidth: [{ type: Input }],
    panelMaxHeight: [{ type: Input }],
    labelKey: [{ type: Input }],
    select: [{ type: Output }],
    maxWidth: [{ type: Input }],
    space: [{ type: Input }],
    showDivider: [{ type: Input }],
    maxShowNum: [{ type: Input }],
    moreText: [{ type: Input }],
    menuText: [{ type: Input }],
    data: [{ type: Input }],
    dataToItemsFn: [{ type: Input }],
    firstTemplate: [{ type: ContentChild, args: [TemplateRef, /* TODO: add static flag */ { static: true },] }],
    itemTemplate: [{ type: ContentChild, args: ['item', /* TODO: add static flag */ { static: true },] }],
    tipTemplate: [{ type: ContentChild, args: ['tip', /* TODO: add static flag */ { static: true },] }],
    menuCom: [{ type: ViewChild, args: [TiMenuComponent, { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlBY3Rpb25tZW51Q29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL2NvbXBvbmVudHMvYWN0aW9ubWVudS9UaUFjdGlvbm1lbnVDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxZQUFZLEVBQ1osVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBR0wsZUFBZSxFQUdmLGVBQWUsRUFDZixNQUFNLEVBQ04sU0FBUyxFQUNULFdBQVcsRUFDWCxTQUFTLEVBQ1osTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsUUFBUSxFQUFpQixNQUFNLDZCQUE2QixDQUFDO0FBaUJ0RSxVQUFVO0FBQ1YsMkNBQTJDO0FBQzNDLGNBQWM7QUFDZCw4QkFBOEI7QUFFOUI7Ozs7Ozs7Ozs7R0FVRztBQVNILE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxlQUFlO0lBNEZ0RCxZQUFzQixPQUFtQixFQUFZLFFBQW1CLEVBQ3BELGVBQWdDLEVBQVUsZUFBZ0M7UUFDMUYsS0FBSyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUZQLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFBWSxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ3BELG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQXZGOUY7O1dBRUc7UUFDTSxrQkFBYSxHQUFXLE9BQU8sQ0FBQztRQUN6Qzs7V0FFRztRQUNNLG1CQUFjLEdBQVcsUUFBUSxDQUFDO1FBQzNDOztXQUVHO1FBQ00sYUFBUSxHQUFXLE9BQU8sQ0FBQztRQUNwQzs7V0FFRztRQUNILGdFQUFnRTtRQUM3QyxXQUFNLEdBQW1D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bEMsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQzs7O1lBclNKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsZUFBZTtnQkFDekIsZ3FFQUFnQztnQkFFaEMsSUFBSSxFQUFFO29CQUNGLG1CQUFtQixFQUFFLFVBQVU7aUJBQ2xDOzthQUNKOzs7WUF4REcsVUFBVTtZQVVWLFNBQVM7WUFMVCxlQUFlO1lBR2YsZUFBZTs7O29CQXNEZCxLQUFLOzRCQUlMLEtBQUs7NkJBSUwsS0FBSzt1QkFJTCxLQUFLO3FCQUtMLE1BQU07dUJBTU4sS0FBSztvQkFJTCxLQUFLOzBCQU9MLEtBQUs7eUJBSUwsS0FBSzt1QkFNTCxLQUFLO3VCQU1MLEtBQUs7bUJBSUwsS0FBSzs0QkFJTCxLQUFLOzRCQU1MLFlBQVksU0FBQyxXQUFXLEVBQUUsMkJBQTJCLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzJCQUN0RSxZQUFZLFNBQUMsTUFBTSxFQUFFLDJCQUEyQixDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTswQkFDakUsWUFBWSxTQUFDLEtBQUssRUFBRSwyQkFBMkIsQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7c0JBS2hFLFNBQVMsU0FBQyxlQUFlLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIENvbXBvbmVudCxcclxuICAgIENvbnRlbnRDaGlsZCxcclxuICAgIEVsZW1lbnRSZWYsXHJcbiAgICBFdmVudEVtaXR0ZXIsXHJcbiAgICBJbnB1dCxcclxuICAgIEl0ZXJhYmxlQ2hhbmdlcyxcclxuICAgIEl0ZXJhYmxlRGlmZmVyLFxyXG4gICAgSXRlcmFibGVEaWZmZXJzLFxyXG4gICAgS2V5VmFsdWVDaGFuZ2VzLFxyXG4gICAgS2V5VmFsdWVEaWZmZXIsXHJcbiAgICBLZXlWYWx1ZURpZmZlcnMsXHJcbiAgICBPdXRwdXQsXHJcbiAgICBSZW5kZXJlcjIsXHJcbiAgICBUZW1wbGF0ZVJlZixcclxuICAgIFZpZXdDaGlsZFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaUZvcm1Db21wb25lbnQgfSBmcm9tICcuLi9iYXNlL1RpQmFzZU1vZHVsZSc7XHJcbmltcG9ydCB7IFRpTWVudUNvbXBvbmVudCwgVGlNZW51SXRlbSB9IGZyb20gJy4uL21lbnUvVGlNZW51TW9kdWxlJztcclxuaW1wb3J0IHsgVGlMb2NhbGUsIFRpTG9jYWxlV29yZHMgfSBmcm9tICcuLi8uLi9sb2NhbGUvVGlMb2NhbGVNb2R1bGUnO1xyXG5pbXBvcnQgeyBUaVBvcGNvbmZpcm1Db25maWcgfSBmcm9tICcuLi8uLi9kaXJlY3RpdmVzL3BvcGNvbmZpcm0vVGlQb3Bjb25maXJtRGlyZWN0aXZlJztcclxuXHJcbi8qKlxyXG4gKiAxMC4wLjMvOS4wLjfniYjmnKzmlrDlop7or6XmjqXlj6NcclxuICpcclxuICog5Zyo5q2k5LmL5YmN54mI5pys5Y+v55u05o6l5L2/55SoYFRpTWVudUl0ZW1g5o6l5Y+jXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFRpQWN0aW9ubWVudUl0ZW0gZXh0ZW5kcyBUaU1lbnVJdGVtIHtcclxuICAgIC8qKlxyXG4gICAgICog5rCU5rOh56Gu6K6k5qGG6YWN572u77yM5YW35L2T5Y+v5Y+C6ICDdGlQb3Bjb25maXJt5oyH5LukXHJcbiAgICAgKlxyXG4gICAgICog5ZyoYWN0aW9ubWVudeS4re+8jOWPquacieaatOmcsuWcqOabtOWkmuaMiemSruWklumDqO+8jOebtOaOpeaYvuekuuWcqOmhtemdouS4reeahOiPnOWNlemhue+8jOmFjee9ruWQjuS8muaYvuekuuehruiupOahhlxyXG4gICAgICovXHJcbiAgICBwb3BDb25maWc/OiBUaVBvcGNvbmZpcm1Db25maWc7XHJcbn1cclxuXHJcbi8vIOepuumXtOiuvue9ruinhOWIme+8mlxyXG4vLyDlj6/mmL7npLrpobnnm67mlbDvvIhjaGlsZHJlbumhueebruW/hemhu+WHuueOsOWcqOKAnOabtOWkmuKAne+8ie+8jOacgOWkp+aYvuekuuaVsOebru+8jOepuumXtOWuveW6puOAglxyXG4vLyDmm7TlpJrigJ3ph4zpnaLoh7PlsJHkuKTkuKrpgInpoblcclxuLy8g5aaC5p6c5Y+q5pyJ5LiA5Liq5bimY2hpbGRyZW7pobnnm67pgqPkuYjnm7TmjqXnlKhtZW5144CCXHJcblxyXG4vKipcclxuICogQWN0aW9uTWVudeiPnOWNleaMiemSrue7hOS7tlxyXG4gKlxyXG4gKiBBY3Rpb25NZW5157uE5Lu25Li76KaB5piv5LiA57uE5pON5L2c5oyJ6ZKu44CC5b2T5oyJ6ZKu5pWw6YeP5aSq5aSa5a+86Ie06aKE55WZ56m66Ze05aSn5bCP5peg5rOV5pi+56S65omA5pyJ5oyJ6ZKu5pe277yM6Ieq5Yqo5bCG6LaF5Ye66YOo5YiG55qE5oyJ6ZKu5pS+572u5Zyo5LiA5LiqbWVudee7hOS7tuS4i+aLieS4reOAglxyXG4gKlxyXG4gKiDkvb/nlKjor6Xnu4Tku7bvvIznlKjmiLflj6rpnIDlhbPms6jmk43kvZzpobnphY3nva7vvIzml6DpnIDlhbPms6jmk43kvZzpobnmmL7npLrkuI3otrPnmoTmg4XlhrXjgIJcclxuICpcclxuICog5rOo5oSP77yaRXhwcmVzc2lvbkNoYW5nZWRBZnRlckl0SGFzQmVlbkNoZWNrZWRFcnJvcjogRXhwcmVzc2lvbiBoYXMgY2hhbmdlZCBhZnRlciBpdCB3YXMgY2hlY2tlZC7vvIjmnKznu4Tku7blnKjosIPor5Xnjq/looPmiqXmraTplJnor6/vvIzkuI3lv4XnkIbkvJrjgILnlJ/kuqfnjq/looPkuI3miqXplJnvvIzlip/og73kuZ/kuI3lj5flvbHlk43jgILvvIlcclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnkzZGVtby8jL2FjdGlvbm1lbnUvYWN0aW9ubWVudS1hbGw8L2V4YW1wbGUtdXJsPlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3RpLWFjdGlvbm1lbnUnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL2FjdGlvbm1lbnUuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi9hY3Rpb25tZW51Lmxlc3MnXSxcclxuICAgIGhvc3Q6IHtcclxuICAgICAgICAnW3N0eWxlLm1heC13aWR0aF0nOiAnbWF4V2lkdGgnXHJcbiAgICB9XHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUaUFjdGlvbm1lbnVDb21wb25lbnQgZXh0ZW5kcyBUaUZvcm1Db21wb25lbnQgeyAgLy8g5pys5bqU57un5om/6IeqQmFzZUNvbXDvvIzkvYbmmK/mg7PopoFB5qCH562+54Sm54K55Yqf6IO9XHJcbiAgICAvKiBNZW515Y+C5pWw6YCP5Lygc3RhcnQgKi9cclxuICAgIC8qKlxyXG4gICAgICog6YCJ6aG55pWw5o2u6ZuGXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGl0ZW1zOiBBcnJheTxUaUFjdGlvbm1lbnVJdGVtPjtcclxuICAgIC8qKlxyXG4gICAgICog5LiL5ouJ6Z2i5p2/5pyA5aSn5a695bqm77yM6LaF6L+H5pe25o2i6KGM77yM5a+55omA5pyJ5a2Q6I+c5Y2V6YO955Sf5pWI44CCXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIHBhbmVsTWF4V2lkdGg6IHN0cmluZyA9ICcxMzBweCc7XHJcbiAgICAvKipcclxuICAgICAqIOS4i+aLiemdouadv+acgOWkp+mrmOW6puW6pu+8jOi2hei/h+aXtuWHuueOsOerluWQkea7muWKqOadoe+8jOWvueaJgOacieWtkOiPnOWNlemDveeUn+aViOOAglxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBwYW5lbE1heEhlaWdodDogc3RyaW5nID0gJzk5OTlweCc7XHJcbiAgICAvKipcclxuICAgICAqIOaVsOaNruS4reimgeaYvuekuuWtl+espuS4sueahGtleVxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBsYWJlbEtleTogc3RyaW5nID0gJ2xhYmVsJztcclxuICAgIC8qKlxyXG4gICAgICog55So5oi354K55Ye76YCJ5Lit6I+c5Y2V6aG55LqL5Lu2XHJcbiAgICAgKi9cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vdXRwdXQtbmFtZWQtYWZ0ZXItc3RhbmRhcmQtZXZlbnRcclxuICAgIEBPdXRwdXQoKSByZWFkb25seSBzZWxlY3Q6IEV2ZW50RW1pdHRlcjxUaUFjdGlvbm1lbnVJdGVtPiA9IG5ldyBFdmVudEVtaXR0ZXI8VGlBY3Rpb25tZW51SXRlbT4oKTtcclxuICAgIC8qIE1lbnXlj4LmlbDpgI/kvKBlbmQgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWklumDqOWuueWZqOWuveW6plxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBtYXhXaWR0aDogc3RyaW5nID0gJzI1MHB4JztcclxuICAgIC8qKlxyXG4gICAgICog5ZCEaXRlbeeahOmXtOi3nVxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBzcGFjZTogc3RyaW5nID0gJzEwcHgnO1xyXG4gICAgLy8g5YiG5Ymy57q/5Li6ZGl2aWRlcu+8jOWIhuWJsuWtl+espuWPq+WBmnNlcGFyYXRvcu+8iOavlOWmguWIhuWJsmlw6YeM55qE54K577yJXHJcbiAgICAvKipcclxuICAgICAqIOWQhGl0ZW3kuYvpl7TmmK/lkKblsZXnpLrliIblibLnur9cclxuICAgICAqXHJcbiAgICAgKiAzLjEuM+aWsOWinlxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBzaG93RGl2aWRlcjogYm9vbGVhbiA9IHRydWU7XHJcbiAgICAvKipcclxuICAgICAqIOacgOWkp+aYvuekuuS4quaVsCwg5YyF5ZCr5LiL5ouJ6I+c5Y2VXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIG1heFNob3dOdW06IG51bWJlciA9IDQ7XHJcbiAgICAvKipcclxuICAgICAqIOS4i+aLieiPnOWNleS4iuaWueaYvuekuuaWh+acrFxyXG4gICAgICpcclxuICAgICAqIOe8uuecgeWAvCA6IOabtOWkmi9tb3Jl77yI5Zu96ZmF5YyW77yJXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIG1vcmVUZXh0OiBzdHJpbmc7IC8vID0gJ+abtOWkmic7XHJcbiAgICAvKipcclxuICAgICAqIOWPquaYvuekuuabtOWkmumhueS4i+aLieiPnOWNleaXtu+8jOS4i+aLieiPnOWNleS4iuaWueaYvuekuuaWh+acrFxyXG4gICAgICpcclxuICAgICAqIOe8uuecgeWAvCA6IOaTjeS9nC9vcGVyYXRpb27vvIjlm73pmYXljJbvvIlcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgbWVudVRleHQ6IHN0cmluZzsgLy8gPSAn5pON5L2cJztcclxuICAgIC8qKlxyXG4gICAgICog5bi45bi457uR5a6a6KGo5qC85pys6KGM5pWw5o2u44CCXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGRhdGE6IGFueTtcclxuICAgIC8qKlxyXG4gICAgICog6KGo5qC85pys6KGMZGF0YeaVsOaNru+8jOi9rOWMluS4uml0ZW1z5pWw5o2u44CC57G75Z6L77yaKGRhdGE6IGFueSkgPT4gQXJyYXk8TWVudUl0ZW0+XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGRhdGFUb0l0ZW1zRm46IChkYXRhOiBhbnkpID0+IEFycmF5PFRpQWN0aW9ubWVudUl0ZW0+O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog55So5oi35YaZ55qE6Ieq5a6a5LmJ5qih5p2/XHJcbiAgICAgKi9cclxuICAgIEBDb250ZW50Q2hpbGQoVGVtcGxhdGVSZWYsIC8qIFRPRE86IGFkZCBzdGF0aWMgZmxhZyAqLyB7IHN0YXRpYzogdHJ1ZSB9KSBmaXJzdFRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG4gICAgQENvbnRlbnRDaGlsZCgnaXRlbScsIC8qIFRPRE86IGFkZCBzdGF0aWMgZmxhZyAqLyB7IHN0YXRpYzogdHJ1ZSB9KSBpdGVtVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT47IC8vIOiHquWumuS5iSBpdGVtIOaooeadv1xyXG4gICAgQENvbnRlbnRDaGlsZCgndGlwJywgLyogVE9ETzogYWRkIHN0YXRpYyBmbGFnICovIHsgc3RhdGljOiB0cnVlIH0pIHRpcFRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+OyAvLyDoh6rlrprkuYkgdGlwIOaooeadv1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBAVmlld0NoaWxkKFRpTWVudUNvbXBvbmVudCwgeyBzdGF0aWM6IHRydWUgfSkgbWVudUNvbTogVGlNZW51Q29tcG9uZW50O1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDkuIvmi4noj5zljZXnu5HlrprnmoTpgInpobnmlbDmja5cclxuICAgICAqL1xyXG4gICAgcHVibGljIHBhbmVsSXRlbXM6IEFycmF5PFRpQWN0aW9ubWVudUl0ZW0+ID0gW107XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOWQhGl0ZW3kuYvpl7Tpl7TpmpTnmoTkuIDljYrot53nprtcclxuICAgICAqL1xyXG4gICAgcHVibGljIGhhbGZTcGFjZTogc3RyaW5nID0gJyc7XHJcblxyXG4gICAgcHJpdmF0ZSBpdGVtc0RpZmZlcjogSXRlcmFibGVEaWZmZXI8VGlBY3Rpb25tZW51SXRlbT47XHJcbiAgICBwcml2YXRlIGRhdGFEaWZmZXI6IEtleVZhbHVlRGlmZmVyPGFueSwgYW55PjtcclxuICAgIHByaXZhdGUgbmVlZEluaXRJdGVtczogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBob3N0UmVmOiBFbGVtZW50UmVmLCBwcm90ZWN0ZWQgcmVuZGVyZXI6IFJlbmRlcmVyMixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgaXRlcmFibGVEaWZmZXJzOiBJdGVyYWJsZURpZmZlcnMsIHByaXZhdGUga2V5VmFsdWVEaWZmZXJzOiBLZXlWYWx1ZURpZmZlcnMpIHtcclxuICAgICAgICBzdXBlcihob3N0UmVmLCByZW5kZXJlcik7XHJcbiAgICAgICAgY29uc3QgbG9jYWxlV29yZHM6IFRpTG9jYWxlV29yZHMgPSBUaUxvY2FsZS5nZXRMb2NhbGVXb3JkcygpO1xyXG4gICAgICAgIHRoaXMubW9yZVRleHQgPSBsb2NhbGVXb3Jkcy50aUFjdGlvbm1lbnUubW9yZTtcclxuICAgICAgICB0aGlzLm1lbnVUZXh0ID0gbG9jYWxlV29yZHMudGlBY3Rpb25tZW51Lm9wZXJhdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICAvLyDnuqDmraMgSUXkuIvlkIzkuIDooYzkuKTkuKrlhYPntKAgb2Zmc2V0VG9wIOWAvOWPr+iDveWtmOWcqOeahOS4gOS6myjnm67liY3mtYvor5XliLDmnIkxcHgp55qE6K+v5beuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBpc0VxdWFsT2Zmc2V0VG9wKGVsZW0xOiBhbnksIGVsZW0yOiBhbnkpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gTWF0aC5hYnMoKGVsZW0xIGFzIEhUTUxFbGVtZW50KS5vZmZzZXRUb3AgLSAoZWxlbTIgYXMgSFRNTEVsZW1lbnQpLm9mZnNldFRvcCkgPD0gMjtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqICDpgInkuK3oj5zljZXlhoXpgInpoblcclxuICAgICAqIEBwYXJhbSBpdGVtIOiPnOWNlemhueaVsOaNrlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb25TZWxlY3QoaXRlbTogVGlBY3Rpb25tZW51SXRlbSk6IHZvaWQge1xyXG4gICAgICAgIGlmICghaXRlbS5kaXNhYmxlZCkge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdC5lbWl0KGl0ZW0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG4gICAgICAgIHRoaXMucGFuZWxJdGVtcyA9IHRoaXMuaXRlbXM7XHJcbiAgICAgICAgdGhpcy5oYWxmU3BhY2UgPSBOdW1iZXIucGFyc2VJbnQodGhpcy5zcGFjZSwgMTApIC8gMiArICdweCc7XHJcbiAgICB9XHJcbiAgICBuZ0RvQ2hlY2soKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGF0YSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZGF0YURpZmZlcikgeyAvLyDpppbmrKFkb2NoZWNr5pivbmdPbkluaXQoKeS5i+WQjlxyXG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhRGlmZmVyID0gdGhpcy5rZXlWYWx1ZURpZmZlcnMuZmluZCh0aGlzLmRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgLmNyZWF0ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFDaGFuZ2VzOiBLZXlWYWx1ZUNoYW5nZXM8YW55LCBhbnk+IHwgbnVsbCA9IHRoaXMuZGF0YURpZmZlci5kaWZmKHRoaXMuZGF0YSk7XHJcbiAgICAgICAgICAgIGlmIChkYXRhQ2hhbmdlcykgeyAvLyDmoLnmja5kYXRh5Yid5aeL5YyWaXRlbXMuIOazqOaEj++8muesrOS4gOasoWRpZmbkvJrotbDlhaVjaGFuZ2VzXHJcbiAgICAgICAgICAgICAgICB0aGlzLml0ZW1zID0gdGhpcy5kYXRhVG9JdGVtc0ZuKHRoaXMuZGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuaXRlbXMpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLml0ZW1zRGlmZmVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLml0ZW1zRGlmZmVyID0gdGhpcy5pdGVyYWJsZURpZmZlcnMuZmluZCh0aGlzLml0ZW1zKVxyXG4gICAgICAgICAgICAgICAgICAgIC5jcmVhdGUoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubmVlZEluaXRJdGVtcyA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgaXRlbXNDaGFuZ2VzOiBJdGVyYWJsZUNoYW5nZXM8VGlBY3Rpb25tZW51SXRlbT4gfCBudWxsID0gdGhpcy5pdGVtc0RpZmZlci5kaWZmKHRoaXMuaXRlbXMpO1xyXG4gICAgICAgICAgICAvLyDms6jmhI/vvJrlpoLmnpzmnInmlbDmja7vvIzpgqPkuYjnrKzkuIDmrKFkaWZm5Lya5bCx6LWw5YWlY2hhbmdlc+OAguWmguaenOaYr+epuuaVsOaNru+8jOesrOS4gOasoWRpZmbnu5PmnpzmmK9udWxs77yM5LiN5Lya6L+b5YWlY2hhbmdlc+OAglxyXG4gICAgICAgICAgICBpZiAoaXRlbXNDaGFuZ2VzKSB7IC8vIOWmguaenGl0ZW1z5pS55Y+Y77yM5YiZ6YeN5paw5Yid5aeL5YyW44CCXHJcbiAgICAgICAgICAgICAgICB0aGlzLm5lZWRJbml0SXRlbXMgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDlhbzlrrnml6fniYjvvJpcclxuICAgICAqIDEwLjAuMyDniYjmnKzkuYvliY3lj6rog73lhoXltYzkuIDkuKrmqKHmnb/vvIzml6Dlkb3lkI3jgIJcclxuICAgICAqIOaWsOeJiOWPr+S7peWGheW1jOS4pOS4quaooeadv++8jOekuuS+i+S5puWGmeimgeaxgumDveWRveWQje+8iCNpdGVt77yMI3RpcO+8ieOAglxyXG4gICAgICog5L2G6ZyA6KaB5YW85a655pen54mI5peg5ZG95ZCN5rWL6K+V55So5L6L44CCXHJcbiAgICAgKi9cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdXNlLWxpZmUtY3ljbGUtaW50ZXJmYWNlXHJcbiAgICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgICBzdXBlci5uZ0FmdGVyQ29udGVudEluaXQoKTtcclxuICAgICAgICAgIC8vIOWmguaenCBpdGVtIOaooeadv+S4uuepuiAmJiDlrZjlnKjnrKzkuIDkuKrmqKHmnb/vvIzpgqPkuYjmiornrKzkuIDkuKrlh7rnjrDnmoQg4oCc6Z2eICN0aXAg5qCH562+4oCdIOeahOaooeadv+S9nOS4uiBpdGVtIOaooeadv1xyXG4gICAgICAgICAgaWYgKCF0aGlzLml0ZW1UZW1wbGF0ZSAmJiB0aGlzLmZpcnN0VGVtcGxhdGVcclxuICAgICAgICAgICAgICAmJiAodGhpcy5maXJzdFRlbXBsYXRlLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCAhPT0gKHRoaXMudGlwVGVtcGxhdGUgJiYgdGhpcy50aXBUZW1wbGF0ZS5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtVGVtcGxhdGUgPSB0aGlzLmZpcnN0VGVtcGxhdGU7XHJcbiAgICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBuZ0FmdGVyVmlld0NoZWNrZWQoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMubmVlZEluaXRJdGVtcykge1xyXG4gICAgICAgICAgICB0aGlzLmluaXRJdGVtcygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzdXBlci5uZ0FmdGVyVmlld0NoZWNrZWQoKTsgLy8g5YaF6YOo5omn6KGM5LqGYXV0b2ZvY3VzXHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOiuoeeul+mCo+S6m2l0ZW3lupTor6XmmL7npLrlnKjlpJbpg6jvvIznp7vpmaTkuI3or6XmmL7npLrnmoRpdGVt77yM6LCD5pW0cGFubmVs5LiK5pi+56S655qEaXRlbemhue+8jOiwg+aVtG1lbnXmmL7npLrnmoTmloflrZfjgIJcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBpbml0SXRlbXMoKTogdm9pZCB7XHJcblxyXG4gICAgICAgIHRoaXMubmVlZEluaXRJdGVtcyA9IGZhbHNlO1xyXG5cclxuICAgICAgICBjb25zdCBpdGVtRWxlbXM6IEhUTUxDb2xsZWN0aW9uID0gdGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgndGkzLWFjdGlvbi1tZW51LWl0ZW0nKTtcclxuICAgICAgICBjb25zdCBkaXZpZGluZ0VsZW1zOiBIVE1MQ29sbGVjdGlvbiA9IHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3RpMy1hY3Rpb24tbWVudS1kaXZpZGVyJyk7XHJcbiAgICAgICAgY29uc3QgbWVudUVsZW06IEhUTUxFbGVtZW50ID0gdGhpcy5tZW51Q29tLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgY29uc3QgbW9yZVRleHRFbGVtOiBIVE1MRWxlbWVudCA9IHRoaXMuaG9zdFJlZi5uYXRpdmVFbGVtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3RpTW9yZVRleHQnKVswXTtcclxuICAgICAgICBjb25zdCBtZW51VGV4dEVsZW06IEhUTUxFbGVtZW50ID0gdGhpcy5ob3N0UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgndGlNZW51VGV4dCcpWzBdO1xyXG4gICAgICAgIC8vIOaDheWGteS4gO+8mml0ZW1z5Li656m6XHJcbiAgICAgICAgaWYgKCF0aGlzLml0ZW1zIHx8IHRoaXMuaXRlbXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGlzcGxheShtZW51RWxlbSwgZmFsc2UpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGlzcGxheShtZW51RWxlbSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOazqOaEjzogaXRlbUVsZW1z5LiN5piv5pWw57uE77yM5bm25LiU5pWw5o2u5pu05paw5pe277yM5Y+W5Yiw55qEbGVuZ3Ro5LiN5a+544CC5omA5Lul77yM5b6X5L2/55SoaXRlbXPnmoRsZW5ndGhcclxuICAgICAgICBsZXQgZmlyc3RDaGlsZHJlbkluZGV4OiBudW1iZXIgPSAtMTsgLy8g56ys5LiA5Liq5ZCr5pyJ5a2Q6aG555uu55qE57Si5byVXHJcbiAgICAgICAgLy8g6L+Z5LiqZm9y5b6q546v77yM5YGa5LqG5Lik5Lu25LqL77ya5om+5ZCr5pyJ5a2Q6aG555uu77yM6YeN572uaXRlbeWPr+ingeOAglxyXG4gICAgICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLml0ZW1zW2ldLmhhc093blByb3BlcnR5KCdjaGlsZHJlbicpKSB7XHJcbiAgICAgICAgICAgICAgICBmaXJzdENoaWxkcmVuSW5kZXggPSBpOyAvLyDmib7liLDnrKzkuIDkuKrlkKvmnInlrZDpobnnm67nmoTntKLlvJVcclxuICAgICAgICAgICAgICAgIC8vIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGlzcGxheShpdGVtRWxlbXNbaV0sIHRydWUpOyAvLyDlm6DkuLrliqjmgIHkv67mlLlpdGVt77yM5omA5Lul56ys5LqM5qyh6L+b5YWl5pe26ZyA6KaB6YeN572uaXRlbeWPr+ingeOAglxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5oOF5Ya15LqM77ya5LiN5pi+56S6bWVudSAgLy/mnaHku7bvvJrmsqHmnInotoXov4fmnIDlpKfmmL7npLrkuKrmlbDvvIzkuJTmnIDlkI7kuIDkuKrpobnnm67kuZ/lnKjnrKzkuIDooYwsIOS4lOayoeacieWtkOmhuVxyXG4gICAgICAgIGlmICh0aGlzLml0ZW1zLmxlbmd0aCA8PSB0aGlzLm1heFNob3dOdW1cclxuICAgICAgICAgICAgJiYgVGlBY3Rpb25tZW51Q29tcG9uZW50LmlzRXF1YWxPZmZzZXRUb3AoaXRlbUVsZW1zW3RoaXMuaXRlbXMubGVuZ3RoIC0gMV0sIGl0ZW1FbGVtc1swXSlcclxuICAgICAgICAgICAgJiYgZmlyc3RDaGlsZHJlbkluZGV4ID09PSAtMSkge1xyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgaTogbnVtYmVyID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cihpdGVtRWxlbXNbaV0sICdkaXNhYmxlZCcsIHRoaXMuaXRlbXNbaV0uZGlzYWJsZWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGlzcGxheShtZW51RWxlbSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAvLyDorr7nva7lj6/ogZrnhKblhYPntKBcclxuICAgICAgICAgICAgY29uc3QgZm9jdXNJdGVtczogQXJyYXk8YW55PiA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgdGhpcy5pdGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgZm9jdXNJdGVtcy5wdXNoKGl0ZW1FbGVtc1tpXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zZXRGb2N1c2FibGVFbGVtcyhmb2N1c0l0ZW1zKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5oOF5Ya15LiJ77ya5pi+56S6TWVude+8jOaYvuekuuaVsOebruadoeS7tu+8muacieWtkOmhueebrueahOS4gOWumuWcqOiPnOWNleWGhS/lgJLmlbDnrKzkuozkuKrkuIDlrprlnKjoj5zljZXlhoUv5pyA5aSn5pi+56S65Liq5pWw77yI5ZCrbWVude+8ieOAgjPlgLzlj5bmnIDlsI/jgIJcclxuICAgICAgICBpZiAoZmlyc3RDaGlsZHJlbkluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICBmaXJzdENoaWxkcmVuSW5kZXggPSB0aGlzLml0ZW1zLmxlbmd0aDsgLy8gZmlyc3RDaGlsZOe7meS4gOS4qui2hei2iuaVsOe7hOWkp+Wwj+eahOe0ouW8le+8jOaWueS+v+S4i+mdouiuoeeul1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgb3V0U2hvd051bTogbnVtYmVyID0gKHRoaXMuaXRlbXMubGVuZ3RoIC0gMikgPCAodGhpcy5tYXhTaG93TnVtIC0gMSkgPyAodGhpcy5pdGVtcy5sZW5ndGggLSAyKSA6XHJcbiAgICAgICAgICAgICh0aGlzLm1heFNob3dOdW0gLSAxKSA8IChmaXJzdENoaWxkcmVuSW5kZXggKyAxKSA/ICh0aGlzLm1heFNob3dOdW0gLSAxKSA6IChmaXJzdENoaWxkcmVuSW5kZXggKyAxKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaTogbnVtYmVyID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgICAgICAgICBpZiAoaSA+IG91dFNob3dOdW0gLSAxKSB7IC8vIOacrOmhueWxnuS6jui2heWHuueahOaVsOebru+8jOWFiOWIoOmZpOaOiVxyXG4gICAgICAgICAgICAgICAgLy8gIFRPRE86IHJlbW92ZeWSjHN0eWxl5ZOq5Liq5pWI546H6auY77yfXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldERpc3BsYXkoaXRlbUVsZW1zW2ldLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGl2aWRpbmdFbGVtc1tpXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGlzcGxheShkaXZpZGluZ0VsZW1zW2ldLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIVRpQWN0aW9ubWVudUNvbXBvbmVudC5pc0VxdWFsT2Zmc2V0VG9wKG1lbnVFbGVtLCBpdGVtRWxlbXNbMF0pKSB7IC8vIOiPnOWNleayoeacieWcqOesrOS4gOihjO+8jOWIoOmZpOacrOmhuVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREaXNwbGF5KGl0ZW1FbGVtc1tpXSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRpdmlkaW5nRWxlbXNbaV0pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERpc3BsYXkoZGl2aWRpbmdFbGVtc1tpXSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgb3V0U2hvd051bS0tO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyKGl0ZW1FbGVtc1tpXSwgJ2Rpc2FibGVkJywgdGhpcy5pdGVtc1tpXS5kaXNhYmxlZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOiuvue9ruiPnOWNleaYvuekuuaWh+Wtl++8jOiuvue9ruWPr+iBmueEpuWFg+e0oFxyXG4gICAgICAgIGlmIChvdXRTaG93TnVtID09PSAwKSB7IC8vIOeri+WNs+eUn+aViO+8jOWQpuWImeagueaNruaooeadv+WPmOmHj+eUn+aViOaFolxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKG1lbnVFbGVtLCAnbWFyZ2luLWxlZnQnLCAnMHB4Jyk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGlzcGxheShtb3JlVGV4dEVsZW0sIGZhbHNlKTtcclxuICAgICAgICAgICAgdGhpcy5zZXREaXNwbGF5KG1lbnVUZXh0RWxlbSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIC8vIOiuvue9ruWPr+iBmueEpuWFg+e0oFxyXG4gICAgICAgICAgICB0aGlzLnNldEZvY3VzYWJsZUVsZW1zKHRoaXMubWVudUNvbS5nZXRGb2N1c2FibGVFbGVtcygpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNldERpc3BsYXkobW9yZVRleHRFbGVtLCB0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5zZXREaXNwbGF5KG1lbnVUZXh0RWxlbSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAvLyDorr7nva7lj6/ogZrnhKblhYPntKBcclxuICAgICAgICAgICAgY29uc3QgZm9jdXNJdGVtczogQXJyYXk8YW55PiA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgb3V0U2hvd051bTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBmb2N1c0l0ZW1zLnB1c2goaXRlbUVsZW1zW2ldKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldEZvY3VzYWJsZUVsZW1zKGZvY3VzSXRlbXMuY29uY2F0KHRoaXMubWVudUNvbS5nZXRGb2N1c2FibGVFbGVtcygpKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmraTlj6XmlLnlj5jkuobmqKHmnb/lj5jph4/vvIzpnIDopoHlvLrliLbliLfmlrBcclxuICAgICAgICAgKiDov5nph4zlvJXotbduZy1zZXJ2ZeeOr+Wig+aKpemUmUV4cHJlc3Npb25DaGFuZ2VkQWZ0ZXJJdEhhc0JlZW5DaGVja2VkRXJyb3IsIOaJgOS7peeUqFByb21pc2Xlu7bml7ZcclxuICAgICAgICAgKi9cclxuICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5wYW5lbEl0ZW1zID0gdGhpcy5pdGVtcy5zbGljZShvdXRTaG93TnVtLCB0aGlzLml0ZW1zLmxlbmd0aCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7mmL7npLov6ZqQ6JeP5qC35byP77yM5q+UbmdJZuabtOWPiuaXtueUn+aViOOAglxyXG4gICAgICogQHBhcmFtIGVsZW0gSFRNTOWFg+e0oFxyXG4gICAgICogQHBhcmFtIGlzU2hvdyDmmK/lkKbmmL7npLpcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzZXREaXNwbGF5KGVsZW06IGFueSwgaXNTaG93OiBib29sZWFuKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShlbGVtLCAnZGlzcGxheScsIGlzU2hvdyA/ICdpbmxpbmUtYmxvY2snIDogJ25vbmUnKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIG5nRm9y6YGN5Y6G55qEIHRyYWNrQnnlh73mlbDvvIzpmLLmraLmlbDmja7mm7TmlrDlr7zoh7TmiYDmnIlET03ph43mlrDmuLLmn5PjgIJUT0RP77ya6L+Z6YeM5piv5ZCm6K+l5L2/55SodHJhY2tCeT9cclxuICAgICAqIEBwYXJhbSBpbmRleCDntKLlvJVcclxuICAgICAqIEBwYXJhbSBpdGVtIOaVsOaNrlxyXG4gICAgICogQHJldHVybnMg57Si5byVXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyB0cmFja0J5Rm4oaW5kZXg6IGFueSwgaXRlbTogYW55KTogYW55IHtcclxuICAgICAgICByZXR1cm4gaW5kZXg7XHJcbiAgICB9XHJcbn1cclxuIl19