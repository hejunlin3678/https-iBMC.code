import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { TiFormComponent } from '../base/TiBaseModule';
import { TiDroplistComponent } from '../droplist/TiDroplistModule';
import { debounceTime, switchMap } from 'rxjs/operators';
import { TiTextComponent } from '../text/TiTextModule';
import { empty, Subject } from 'rxjs';
import { Util } from '../../utils/Util';
/**
 * 自动补全输入框组件
 *
 * <example-url>../tiny3demo/#/autocomplete/autocomplete-all</example-url>
 */
export class TiAutocompleteComponent extends TiFormComponent {
    constructor() {
        super(...arguments);
        /**
         * 预留提示文本
         */
        this.placeholder = '';
        /**
         * 是否开启清空输入框内容的功能
         *
         * 10.1.0/9.1.0版本之后默认不开启，在此之前版本默认开启
         */
        this.clearable = false;
        /**
         * 1."justified"(默认): 下拉框的宽度与输入框的宽度保持一致；
         *
         * 2."auto": 下拉框的宽度根据下拉项的内容自动撑开；
         *
         * 3.表示宽度的字符串: 设置固定的下拉框宽度(不小于输入框的宽度)。例如："200px"。
         */
        this.panelWidth = 'justified';
        /**
         * 指定下拉建议项中显示的文本对应的字段关键字
         */
        this.labelKey = 'label';
        /**
         * 10.0.1版本新增
         *
         * 下拉建议项
         */
        this.options = [];
        /**
         * 10.0.2版本新增
         *
         * 下拉建议项文字超长显示...，hover时tip弹出方向
         */
        this.tipPosition = 'right';
        /**
         * suggest事件，当聚焦或值改变时触发事件，为开发者提供设置建议项的时机。
         *
         * 参数：组件实例
         */
        this.suggest = new EventEmitter();
        /**
         * clear事件，点击清除按钮时触发
         *
         * 10.0.2版本新增(tiAutocomplete组件)
         *
         * 3.0.6版本新增(tiSearchbox组件)
         *
         */
        this.clear = new EventEmitter();
        /**
         * @ignore
         *
         */
        this.suggestions = [];
        /**
         * @ignore
         * 是否聚焦的标志位
         */
        this.isFocused = false;
        /**
         * 最后一次下拉建议项
         */
        this.lastSuggestions = [];
        /**
         * @ignore
         */
        this.inputChangeObserve = new Subject();
        // 内部公共方法集合--end
    }
    ngOnInit() {
        super.ngOnInit();
        this.setFocusableElems([this.textComp.nativeElement]);
        this.createInputChangeObserve();
        if (this.clearable) {
            this.renderer.setAttribute(this.textComp.nativeElement, 'clearable', '');
        }
    }
    ngOnDestroy() {
        // 修正SSR报错：TypeError: Cannot read property 'unsubscribe' of undefined
        this.inputChangeSub && this.inputChangeSub.unsubscribe();
    }
    // 组件交互方法集合--start
    /**
     * @ignore
     * 输入框中内容改变事件
     */
    onInputChange(value) {
        if (this.disabled || !this.isFocused) {
            return;
        }
        this.inputChangeObserve.next(value);
    }
    /**
     * @ignore
     * 两种情况下触发
     * 1.在suggestion面板展开的情况下，通过hover选中一项，然后按下enter
     * 2.在suggestion面板展开的情况下，通过鼠标点击选中一项
     */
    onDroplistChange(value) {
        if (value) {
            this.model = value[this.labelKey] || value.label;
        }
    }
    /**
     * @ignore
     */
    onFocus() {
        if (this.disabled) {
            return;
        }
        this.isFocused = true;
        if (this.isInputClear()) { // 如果是点击清除按钮，值会改变，那么就会在onInputChange中处理
            return;
        }
        this.showSuggestions();
    }
    /**
     * @ignore
     */
    onBlur() {
        this.dropListComp && this.dropListComp.hide();
        this.isFocused = false;
    }
    /**
     * @ignore
     *
     * 避免滚动页面下拉框隐藏之后组件仍聚焦时再次点击，下拉框无法展开
     *
     * mousedown在focus事件之前执行
     */
    onInputMousedown() {
        if (this.disabled || !this.isFocused || this.isInputClear()) { // 如果是点击清除按钮，值会改变，那么就会在onInputChange中处理
            return;
        }
        this.showSuggestions();
    }
    /**
     * @ignore
     * 点击叉号时触发
     *
     */
    onClear(event) {
        this.clear.emit(event);
    }
    // 组件交互方法集合--end
    // 内部公共方法集合--start
    /**
     * @description: 创建inputValue的observable，确保收集2ms内的数据后再更新下拉
     *  触发该observable时，使用next方法
     */
    createInputChangeObserve() {
        this.inputChangeSub = this.inputChangeObserve
            .pipe(debounceTime(200), // 200ms延迟执行，解决请求太频繁问题
        // TODO: 在点击清除按钮或者快捷键删除时数据不准确，可能导致在这些操作时触发不了下面的逻辑
        // distinctUntilChanged(),避免前后两次相同数据重复处理，只有上次数据和200ms后的数据不相等时才触发后续动作。
        switchMap(// TODO: 这个switchMap有可能没有生效。测试用例增加，switchMap
        (value) => {
            if (this.isFocused) {
                if (this.suggest.observers.length === 0) {
                    this.lastSuggestions = this.suggestions;
                    this.suggestions = this.filter(value);
                    if (this.suggestions.length > 0) {
                        this.show();
                    }
                    else {
                        this.dropListComp && this.dropListComp.hide();
                    }
                }
                else {
                    this.suggest.emit(this);
                }
            }
            return empty();
        }))
            .subscribe();
    }
    /**
     * 设置下拉建议项数据
     *
     * @param value 下拉建议项数组
     */
    setSuggestions(value) {
        this.lastSuggestions = this.suggestions;
        this.suggestions = value;
        if (this.suggestions.length > 0) {
            this.show();
        }
        else {
            this.dropListComp.hide();
        }
    }
    filter(searchWord) {
        if (this.options && this.options.length >= 0) {
            // 搜索结果临时值。结果默认值，是原数据
            let searchResult = this.options;
            // 如果搜索词存在
            if (!Util.isEmptyString(searchWord)) {
                // 在集合中搜索
                searchResult = searchResult.filter((option) => {
                    return option[this.labelKey].toLowerCase()
                        .indexOf(searchWord.toLowerCase()) >= 0;
                });
            }
            return searchResult;
        }
        return [];
    }
    show() {
        if (this.dropListComp.isShow) {
            // 搜索时，按需重新定位
            if (this.lastSuggestions.length !== this.suggestions.length) {
                setTimeout(() => {
                    this.dropListComp.rePosition(true);
                }, 0);
            }
        }
        else {
            // 数据更新后，未及时通知到droplist，初始化时按照默认值[]绘制视图，需延时处理
            setTimeout(() => {
                this.dropListComp.show();
                this.selected = undefined; // 为了去掉选中样式
                this.dropListComp.listCom.hoverOption = undefined; // 去掉hoverOption
            }, 0);
        }
    }
    isInputClear() {
        return this.textComp.isShowClear && this.textComp.isClearActive;
    }
    showSuggestions() {
        if (this.suggest.observers.length === 0) {
            this.lastSuggestions = this.suggestions;
            this.suggestions = this.filter(this.model);
            if (this.suggestions.length > 0) {
                this.show();
            }
        }
        else {
            this.suggest.emit(this);
        }
    }
}
TiAutocompleteComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-autocomplete',
                template: "<input #input tiText\r\n        class=\"ti3-autocomplete-input\"\r\n        [disabled]=\"disabled\"\r\n        spellcheck=false\r\n        [(ngModel)] = \"model\"\r\n        [placeholder]=\"placeholder\"\r\n        (ngModelChange)=\"onInputChange($event)\"\r\n        [maxlength]=\"maxlength\"\r\n        [id]=\"appendId('input')\"\r\n        (mousedown)=\"onInputMousedown()\"\r\n        (clear)=\"onClear($event)\">\r\n<ti-droplist #droplist\r\n              [dominatorElem]=\"nativeElement\"\r\n              [options]=\"suggestions\"\r\n              [(ngModel)]=\"selected\"\r\n              [labelKey]=\"labelKey\"\r\n              [panelMaxHeight]=\"panelMaxHeight\"\r\n              [panelWidth]=\"panelWidth\"\r\n              [tipPosition]=\"tipPosition\"\r\n              (ngModelChange)=\"onDroplistChange($event)\"\r\n              [id]=\"appendId('droplist')\">\r\n</ti-droplist>",
                providers: [TiFormComponent.getValueAccessor(TiAutocompleteComponent)],
                host: {
                    '[class.ti3-autocomplete-container]': 'true',
                    '(blur)': 'onBlur()',
                    '(focus)': 'onFocus()'
                },
                styles: [":host.ti3-autocomplete-container{background-color:var(--ti-common-color-bg-white-normal);border:1px solid var(--ti-input-border-color);border-radius:var(--ti-common-border-radius-normal);display:inline-block;vertical-align:middle}:host.ti3-autocomplete-container:hover{border-color:var(--ti-input-border-color-hover)}:host.ti3-autocomplete-container[tifocused]{border-color:var(--ti-input-border-color-focus)}:host.ti3-autocomplete-container[disabled]{border-color:var(--ti-input-border-color-disabled)}:host.ti3-autocomplete-container[disabled] .ti3-autocomplete-input{background-color:var(--ti-input-bg-color-disabled)}:host.ti3-autocomplete-container .ti3-autocomplete-input{background-color:transparent;border:none!important;width:100%}"]
            },] }
];
TiAutocompleteComponent.propDecorators = {
    placeholder: [{ type: Input }],
    clearable: [{ type: Input }],
    maxlength: [{ type: Input }],
    panelWidth: [{ type: Input }],
    panelMaxHeight: [{ type: Input }],
    labelKey: [{ type: Input }],
    options: [{ type: Input }],
    tipPosition: [{ type: Input }],
    suggest: [{ type: Output }],
    clear: [{ type: Output }],
    textComp: [{ type: ViewChild, args: ['input', { static: true },] }],
    dropListComp: [{ type: ViewChild, args: ['droplist', { static: false },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlBdXRvY29tcGxldGVDb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueTMvY29tcG9uZW50cy9hdXRvY29tcGxldGUvVGlBdXRvY29tcGxldGVDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ25FLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHeEM7Ozs7R0FJRztBQVlILE1BQU0sT0FBTyx1QkFBd0IsU0FBUSxlQUFlO0lBWDVEOztRQVlJOztXQUVHO1FBQ00sZ0JBQVcsR0FBVyxFQUFFLENBQUM7UUFDbEM7Ozs7V0FJRztRQUNNLGNBQVMsR0FBWSxLQUFLLENBQUM7UUFLcEM7Ozs7OztXQU1HO1FBQ00sZUFBVSxHQUFXLFdBQVcsQ0FBQztRQUsxQzs7V0FFRztRQUNNLGFBQVEsR0FBVyxPQUFPLENBQUM7UUFDcEM7Ozs7V0FJRztRQUNNLFlBQU8sR0FBZSxFQUFFLENBQUM7UUFDbEM7Ozs7V0FJRztRQUNNLGdCQUFXLEdBQW1CLE9BQU8sQ0FBQztRQUMvQzs7OztXQUlHO1FBQ2dCLFlBQU8sR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN4RTs7Ozs7OztXQU9HO1FB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QztJQUVPLGVBQWU7UUFDbkIsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUN4QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM3QixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDZjtTQUNKO2FBQU07WUFDSCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMzQjtJQUNMLENBQUM7OztZQTlSSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGlCQUFpQjtnQkFDM0IseTRCQUFrQztnQkFFbEMsU0FBUyxFQUFFLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLHVCQUF1QixDQUFDLENBQUM7Z0JBQ3RFLElBQUksRUFBRTtvQkFDRixvQ0FBb0MsRUFBRSxNQUFNO29CQUM1QyxRQUFRLEVBQUUsVUFBVTtvQkFDcEIsU0FBUyxFQUFFLFdBQVc7aUJBQ3pCOzthQUNKOzs7MEJBS0ksS0FBSzt3QkFNTCxLQUFLO3dCQUlMLEtBQUs7eUJBUUwsS0FBSzs2QkFJTCxLQUFLO3VCQUlMLEtBQUs7c0JBTUwsS0FBSzswQkFNTCxLQUFLO3NCQU1MLE1BQU07b0JBU04sTUFBTTt1QkF3Qk4sU0FBUyxTQUFDLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7MkJBSW5DLFNBQVMsU0FBQyxVQUFVLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaUZvcm1Db21wb25lbnQgfSBmcm9tICcuLi9iYXNlL1RpQmFzZU1vZHVsZSc7XHJcbmltcG9ydCB7IFRpRHJvcGxpc3RDb21wb25lbnQgfSBmcm9tICcuLi9kcm9wbGlzdC9UaURyb3BsaXN0TW9kdWxlJztcclxuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFRpVGV4dENvbXBvbmVudCB9IGZyb20gJy4uL3RleHQvVGlUZXh0TW9kdWxlJztcclxuaW1wb3J0IHsgZW1wdHksIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbmltcG9ydCB7IFRpUG9zaXRpb25UeXBlIH0gZnJvbSAnLi4vLi4vdXRpbHMvUG9zaXRpb24nO1xyXG5cclxuLyoqXHJcbiAqIOiHquWKqOihpeWFqOi+k+WFpeahhue7hOS7tlxyXG4gKlxyXG4gKiA8ZXhhbXBsZS11cmw+Li4vdGlueTNkZW1vLyMvYXV0b2NvbXBsZXRlL2F1dG9jb21wbGV0ZS1hbGw8L2V4YW1wbGUtdXJsPlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3RpLWF1dG9jb21wbGV0ZScsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXV0b2NvbXBsZXRlLmh0bWwnLFxyXG4gICAgc3R5bGVVcmxzOiBbJy4vYXV0b2NvbXBsZXRlLmxlc3MnXSxcclxuICAgIHByb3ZpZGVyczogW1RpRm9ybUNvbXBvbmVudC5nZXRWYWx1ZUFjY2Vzc29yKFRpQXV0b2NvbXBsZXRlQ29tcG9uZW50KV0sXHJcbiAgICBob3N0OiB7XHJcbiAgICAgICAgJ1tjbGFzcy50aTMtYXV0b2NvbXBsZXRlLWNvbnRhaW5lcl0nOiAndHJ1ZScsXHJcbiAgICAgICAgJyhibHVyKSc6ICdvbkJsdXIoKScsXHJcbiAgICAgICAgJyhmb2N1cyknOiAnb25Gb2N1cygpJ1xyXG4gICAgfVxyXG59KVxyXG5leHBvcnQgY2xhc3MgVGlBdXRvY29tcGxldGVDb21wb25lbnQgZXh0ZW5kcyBUaUZvcm1Db21wb25lbnQge1xyXG4gICAgLyoqXHJcbiAgICAgKiDpooTnlZnmj5DnpLrmlofmnKxcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgcGxhY2Vob2xkZXI6IHN0cmluZyA9ICcnO1xyXG4gICAgLyoqXHJcbiAgICAgKiDmmK/lkKblvIDlkK/muIXnqbrovpPlhaXmoYblhoXlrrnnmoTlip/og71cclxuICAgICAqXHJcbiAgICAgKiAxMC4xLjAvOS4xLjDniYjmnKzkuYvlkI7pu5jorqTkuI3lvIDlkK/vvIzlnKjmraTkuYvliY3niYjmnKzpu5jorqTlvIDlkK9cclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgY2xlYXJhYmxlOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICAvKipcclxuICAgICAqIOaWh+acrOacgOWkp+aYvuekuumVv+W6plxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBtYXhsZW5ndGg6IG51bWJlcjtcclxuICAgIC8qKlxyXG4gICAgICogMS5cImp1c3RpZmllZFwiKOm7mOiupCk6IOS4i+aLieahhueahOWuveW6puS4jui+k+WFpeahhueahOWuveW6puS/neaMgeS4gOiHtO+8m1xyXG4gICAgICpcclxuICAgICAqIDIuXCJhdXRvXCI6IOS4i+aLieahhueahOWuveW6puagueaNruS4i+aLiemhueeahOWGheWuueiHquWKqOaSkeW8gO+8m1xyXG4gICAgICpcclxuICAgICAqIDMu6KGo56S65a695bqm55qE5a2X56ym5LiyOiDorr7nva7lm7rlrprnmoTkuIvmi4nmoYblrr3luqYo5LiN5bCP5LqO6L6T5YWl5qGG55qE5a695bqmKeOAguS+i+Wmgu+8mlwiMjAwcHhcIuOAglxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBwYW5lbFdpZHRoOiBzdHJpbmcgPSAnanVzdGlmaWVkJztcclxuICAgIC8qKlxyXG4gICAgICog6Z2i5p2/5pyA5aSn6auY5bqmXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIHBhbmVsTWF4SGVpZ2h0OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIOaMh+WumuS4i+aLieW7uuiurumhueS4reaYvuekuueahOaWh+acrOWvueW6lOeahOWtl+auteWFs+mUruWtl1xyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBsYWJlbEtleTogc3RyaW5nID0gJ2xhYmVsJztcclxuICAgIC8qKlxyXG4gICAgICogMTAuMC4x54mI5pys5paw5aKeXHJcbiAgICAgKlxyXG4gICAgICog5LiL5ouJ5bu66K6u6aG5XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIG9wdGlvbnM6IEFycmF5PGFueT4gPSBbXTtcclxuICAgIC8qKlxyXG4gICAgICogMTAuMC4y54mI5pys5paw5aKeXHJcbiAgICAgKlxyXG4gICAgICog5LiL5ouJ5bu66K6u6aG55paH5a2X6LaF6ZW/5pi+56S6Li4u77yMaG92ZXLml7Z0aXDlvLnlh7rmlrnlkJFcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgdGlwUG9zaXRpb246IFRpUG9zaXRpb25UeXBlID0gJ3JpZ2h0JztcclxuICAgIC8qKlxyXG4gICAgICogc3VnZ2VzdOS6i+S7tu+8jOW9k+iBmueEpuaIluWAvOaUueWPmOaXtuinpuWPkeS6i+S7tu+8jOS4uuW8gOWPkeiAheaPkOS+m+iuvue9ruW7uuiurumhueeahOaXtuacuuOAglxyXG4gICAgICpcclxuICAgICAqIOWPguaVsO+8mue7hOS7tuWunuS+i1xyXG4gICAgICovXHJcbiAgICBAT3V0cHV0KCkgcmVhZG9ubHkgc3VnZ2VzdDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICAgIC8qKlxyXG4gICAgICogY2xlYXLkuovku7bvvIzngrnlh7vmuIXpmaTmjInpkq7ml7bop6blj5FcclxuICAgICAqXHJcbiAgICAgKiAxMC4wLjLniYjmnKzmlrDlop4odGlBdXRvY29tcGxldGXnu4Tku7YpXHJcbiAgICAgKlxyXG4gICAgICogMy4wLjbniYjmnKzmlrDlop4odGlTZWFyY2hib3jnu4Tku7YpXHJcbiAgICAgKlxyXG4gICAgICovXHJcbiAgICBAT3V0cHV0KCkgcmVhZG9ubHkgY2xlYXI6IEV2ZW50RW1pdHRlcjxNb3VzZUV2ZW50PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICogZHJvcGxpc3TpgInpobnlgLxcclxuICAgICAqL1xyXG4gICAgcHVibGljIHNlbGVjdGVkOiBhbnk7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdWdnZXN0aW9uczogQXJyYXk8YW55PiA9IFtdO1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDmmK/lkKbogZrnhKbnmoTmoIflv5fkvY1cclxuICAgICAqL1xyXG4gICAgcHVibGljIGlzRm9jdXNlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgLyoqXHJcbiAgICAgKiDmnIDlkI7kuIDmrKHkuIvmi4nlu7rorq7poblcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBsYXN0U3VnZ2VzdGlvbnM6IEFycmF5PGFueT4gPSBbXTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgQFZpZXdDaGlsZCgnaW5wdXQnLCB7IHN0YXRpYzogdHJ1ZSB9KSB0ZXh0Q29tcDogVGlUZXh0Q29tcG9uZW50O1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIEBWaWV3Q2hpbGQoJ2Ryb3BsaXN0JywgeyBzdGF0aWM6IGZhbHNlIH0pIGRyb3BMaXN0Q29tcDogVGlEcm9wbGlzdENvbXBvbmVudDtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaW5wdXRDaGFuZ2VPYnNlcnZlOiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdCgpO1xyXG4gICAgcHJpdmF0ZSBpbnB1dENoYW5nZVN1YjogU3Vic2NyaXB0aW9uO1xyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgICAgICB0aGlzLnNldEZvY3VzYWJsZUVsZW1zKFt0aGlzLnRleHRDb21wLm5hdGl2ZUVsZW1lbnRdKTtcclxuICAgICAgICB0aGlzLmNyZWF0ZUlucHV0Q2hhbmdlT2JzZXJ2ZSgpO1xyXG4gICAgICAgIGlmICh0aGlzLmNsZWFyYWJsZSkge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0aGlzLnRleHRDb21wLm5hdGl2ZUVsZW1lbnQsICdjbGVhcmFibGUnLCAnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOS/ruato1NTUuaKpemUme+8mlR5cGVFcnJvcjogQ2Fubm90IHJlYWQgcHJvcGVydHkgJ3Vuc3Vic2NyaWJlJyBvZiB1bmRlZmluZWRcclxuICAgICAgICB0aGlzLmlucHV0Q2hhbmdlU3ViICYmIHRoaXMuaW5wdXRDaGFuZ2VTdWIudW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDnu4Tku7bkuqTkupLmlrnms5Xpm4blkIgtLXN0YXJ0XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOi+k+WFpeahhuS4reWGheWuueaUueWPmOS6i+S7tlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb25JbnB1dENoYW5nZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQgfHwgIXRoaXMuaXNGb2N1c2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5wdXRDaGFuZ2VPYnNlcnZlLm5leHQodmFsdWUpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDkuKTnp43mg4XlhrXkuIvop6blj5FcclxuICAgICAqIDEu5Zyoc3VnZ2VzdGlvbumdouadv+WxleW8gOeahOaDheWGteS4i++8jOmAmui/h2hvdmVy6YCJ5Lit5LiA6aG577yM54S25ZCO5oyJ5LiLZW50ZXJcclxuICAgICAqIDIu5Zyoc3VnZ2VzdGlvbumdouadv+WxleW8gOeahOaDheWGteS4i++8jOmAmui/h+m8oOagh+eCueWHu+mAieS4reS4gOmhuVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb25Ecm9wbGlzdENoYW5nZSh2YWx1ZTogeyBsYWJlbD86IHN0cmluZyB9KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubW9kZWwgPSB2YWx1ZVt0aGlzLmxhYmVsS2V5XSB8fCB2YWx1ZS5sYWJlbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9uRm9jdXMoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlzRm9jdXNlZCA9IHRydWU7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNJbnB1dENsZWFyKCkpIHsgLy8g5aaC5p6c5piv54K55Ye75riF6Zmk5oyJ6ZKu77yM5YC85Lya5pS55Y+Y77yM6YKj5LmI5bCx5Lya5Zyob25JbnB1dENoYW5nZeS4reWkhOeQhlxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnNob3dTdWdnZXN0aW9ucygpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBvbkJsdXIoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5kcm9wTGlzdENvbXAgJiYgdGhpcy5kcm9wTGlzdENvbXAuaGlkZSgpO1xyXG4gICAgICAgIHRoaXMuaXNGb2N1c2VkID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqXHJcbiAgICAgKiDpgb/lhY3mu5rliqjpobXpnaLkuIvmi4nmoYbpmpDol4/kuYvlkI7nu4Tku7bku43ogZrnhKbml7blho3mrKHngrnlh7vvvIzkuIvmi4nmoYbml6Dms5XlsZXlvIBcclxuICAgICAqXHJcbiAgICAgKiBtb3VzZWRvd27lnKhmb2N1c+S6i+S7tuS5i+WJjeaJp+ihjFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb25JbnB1dE1vdXNlZG93bigpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5kaXNhYmxlZCB8fCAhdGhpcy5pc0ZvY3VzZWQgfHwgdGhpcy5pc0lucHV0Q2xlYXIoKSkgeyAvLyDlpoLmnpzmmK/ngrnlh7vmuIXpmaTmjInpkq7vvIzlgLzkvJrmlLnlj5jvvIzpgqPkuYjlsLHkvJrlnKhvbklucHV0Q2hhbmdl5Lit5aSE55CGXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc2hvd1N1Z2dlc3Rpb25zKCk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOeCueWHu+WPieWPt+aXtuinpuWPkVxyXG4gICAgICpcclxuICAgICAqL1xyXG4gICAgb25DbGVhcihldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuY2xlYXIuZW1pdChldmVudCk7XHJcbiAgICB9XHJcbiAgICAvLyDnu4Tku7bkuqTkupLmlrnms5Xpm4blkIgtLWVuZFxyXG5cclxuICAgIC8vIOWGhemDqOWFrOWFseaWueazlembhuWQiC0tc3RhcnRcclxuICAgIC8qKlxyXG4gICAgICogQGRlc2NyaXB0aW9uOiDliJvlu7ppbnB1dFZhbHVl55qEb2JzZXJ2YWJsZe+8jOehruS/neaUtumbhjJtc+WGheeahOaVsOaNruWQjuWGjeabtOaWsOS4i+aLiVxyXG4gICAgICogIOinpuWPkeivpW9ic2VydmFibGXml7bvvIzkvb/nlKhuZXh05pa55rOVXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY3JlYXRlSW5wdXRDaGFuZ2VPYnNlcnZlKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaW5wdXRDaGFuZ2VTdWIgPSB0aGlzLmlucHV0Q2hhbmdlT2JzZXJ2ZVxyXG4gICAgICAgICAgICAucGlwZShcclxuICAgICAgICAgICAgICAgIGRlYm91bmNlVGltZSgyMDApLCAvLyAyMDBtc+W7tui/n+aJp+ihjO+8jOino+WGs+ivt+axguWkqumikee5gemXrumimFxyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzog5Zyo54K55Ye75riF6Zmk5oyJ6ZKu5oiW6ICF5b+r5o236ZSu5Yig6Zmk5pe25pWw5o2u5LiN5YeG56Gu77yM5Y+v6IO95a+86Ie05Zyo6L+Z5Lqb5pON5L2c5pe26Kem5Y+R5LiN5LqG5LiL6Z2i55qE6YC76L6RXHJcbiAgICAgICAgICAgICAgICAvLyBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLOmBv+WFjeWJjeWQjuS4pOasoeebuOWQjOaVsOaNrumHjeWkjeWkhOeQhu+8jOWPquacieS4iuasoeaVsOaNruWSjDIwMG1z5ZCO55qE5pWw5o2u5LiN55u4562J5pe25omN6Kem5Y+R5ZCO57ut5Yqo5L2c44CCXHJcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoLy8gVE9ETzog6L+Z5Liqc3dpdGNoTWFw5pyJ5Y+v6IO95rKh5pyJ55Sf5pWI44CC5rWL6K+V55So5L6L5aKe5Yqg77yMc3dpdGNoTWFwXHJcbiAgICAgICAgICAgICAgICAgICAgKHZhbHVlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNGb2N1c2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdWdnZXN0Lm9ic2VydmVycy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RTdWdnZXN0aW9ucyA9IHRoaXMuc3VnZ2VzdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWdnZXN0aW9ucyA9IHRoaXMuZmlsdGVyKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zdWdnZXN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcExpc3RDb21wICYmIHRoaXMuZHJvcExpc3RDb21wLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3VnZ2VzdC5lbWl0KHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruS4i+aLieW7uuiurumhueaVsOaNrlxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSB2YWx1ZSDkuIvmi4nlu7rorq7pobnmlbDnu4RcclxuICAgICAqL1xyXG4gICAgcHVibGljIHNldFN1Z2dlc3Rpb25zKHZhbHVlOiBBcnJheTxhbnk+KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5sYXN0U3VnZ2VzdGlvbnMgPSB0aGlzLnN1Z2dlc3Rpb25zO1xyXG4gICAgICAgIHRoaXMuc3VnZ2VzdGlvbnMgPSB2YWx1ZTtcclxuICAgICAgICBpZiAodGhpcy5zdWdnZXN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvdygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZHJvcExpc3RDb21wLmhpZGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmaWx0ZXIoc2VhcmNoV29yZDogc3RyaW5nKTogQXJyYXk8YW55PiB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnMubGVuZ3RoID49IDApIHtcclxuICAgICAgICAgICAgLy8g5pCc57Si57uT5p6c5Li05pe25YC844CC57uT5p6c6buY6K6k5YC877yM5piv5Y6f5pWw5o2uXHJcbiAgICAgICAgICAgIGxldCBzZWFyY2hSZXN1bHQ6IEFycmF5PGFueT4gPSB0aGlzLm9wdGlvbnM7XHJcbiAgICAgICAgICAgIC8vIOWmguaenOaQnOe0ouivjeWtmOWcqFxyXG4gICAgICAgICAgICBpZiAoIVV0aWwuaXNFbXB0eVN0cmluZyhzZWFyY2hXb3JkKSkge1xyXG4gICAgICAgICAgICAgICAgLy8g5Zyo6ZuG5ZCI5Lit5pCc57SiXHJcbiAgICAgICAgICAgICAgICBzZWFyY2hSZXN1bHQgPSBzZWFyY2hSZXN1bHQuZmlsdGVyKChvcHRpb246IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25bdGhpcy5sYWJlbEtleV0udG9Mb3dlckNhc2UoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuaW5kZXhPZihzZWFyY2hXb3JkLnRvTG93ZXJDYXNlKCkpID49IDA7XHJcblxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBzZWFyY2hSZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzaG93KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmRyb3BMaXN0Q29tcC5pc1Nob3cpIHtcclxuICAgICAgICAgICAgLy8g5pCc57Si5pe277yM5oyJ6ZyA6YeN5paw5a6a5L2NXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxhc3RTdWdnZXN0aW9ucy5sZW5ndGggIT09IHRoaXMuc3VnZ2VzdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3BMaXN0Q29tcC5yZVBvc2l0aW9uKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfSwgMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgLy8g5pWw5o2u5pu05paw5ZCO77yM5pyq5Y+K5pe26YCa55+l5YiwZHJvcGxpc3TvvIzliJ3lp4vljJbml7bmjInnhafpu5jorqTlgLxbXee7mOWItuinhuWbvu+8jOmcgOW7tuaXtuWkhOeQhlxyXG4gICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgdGhpcy5kcm9wTGlzdENvbXAuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB1bmRlZmluZWQ7IC8vIOS4uuS6huWOu+aOiemAieS4reagt+W8j1xyXG4gICAgICAgICAgICAgICAgIHRoaXMuZHJvcExpc3RDb21wLmxpc3RDb20uaG92ZXJPcHRpb24gPSB1bmRlZmluZWQ7IC8vIOWOu+aOiWhvdmVyT3B0aW9uXHJcbiAgICAgICAgfSwgMCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNJbnB1dENsZWFyKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRleHRDb21wLmlzU2hvd0NsZWFyICYmIHRoaXMudGV4dENvbXAuaXNDbGVhckFjdGl2ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNob3dTdWdnZXN0aW9ucygpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5zdWdnZXN0Lm9ic2VydmVycy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5sYXN0U3VnZ2VzdGlvbnMgPSB0aGlzLnN1Z2dlc3Rpb25zO1xyXG4gICAgICAgICAgICB0aGlzLnN1Z2dlc3Rpb25zID0gdGhpcy5maWx0ZXIodGhpcy5tb2RlbCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnN1Z2dlc3Rpb25zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zdWdnZXN0LmVtaXQodGhpcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8g5YaF6YOo5YWs5YWx5pa55rOV6ZuG5ZCILS1lbmRcclxufVxyXG4iXX0=