import { Component, ContentChild, ElementRef, EventEmitter, Input, NgZone, Output, Renderer2, TemplateRef, ViewChild } from '@angular/core';
import { TiFormComponent } from '../base/TiBaseModule';
import { TiDropComponent } from '../drop/TiDropModule';
import { TiListComponent } from '../list/TiListModule';
import { TiKeymap } from '../../utils/Util';
/**
 * @ignore
 * 下拉面板带有数组列表组件，用于aucomplete等。它有子类TiDropsearchComponent
 */
export class TiDroplistComponent extends TiFormComponent {
    constructor(render, hostRef, zone) {
        super(hostRef, render);
        this.render = render;
        this.zone = zone;
        /**
         * 默认高度8条 DEFAULT_LIST_MAX_HEIGHT
         */
        this.defaultListMaxHeight = 30 * 8 + 8;
        /**
         * 面板中，除去list外，其它元素的占位高度
         */
        this.heightExcludeList = 2;
        /**
         * drop面板自定义底部高度
         */
        this.footerHeight = 0;
        /**
         * 是否多选
         */
        this.multiple = false;
        /**
         * 下拉面板的最大显示宽度，该变量与下拉类组件保持一致
         *
         * 1."justified"(默认): 下拉框的宽度与Select组件的宽度保持一致；
         *
         * 2."auto": 下拉框的宽度根据下拉选项的内容自动撑开；
         *
         * 3.表示宽度的字符串: 设置固定的下拉框宽度(不小于Select组件的宽度)。例如："200px"
         */
        this.panelWidth = 'justified';
        this.labelKey = 'label';
        this.noDataText = '...';
        this.tipPosition = 'right';
        this.dominatorSpace = TiDropComponent.DOMINATOR_SPACE + 'px'; // 10.0.1新增
        this.panelAlign = 'left'; // 10.0.1新增
        /**
         * 内部接口，用作suggestion时type传入suggestion，默认值default
         */
        this.type = 'default';
        /**
         * 大小样式，default/small. 默认值default
         */
        this.size = 'default';
        /**
         * 选中选项后面板是否保持显示， 默认值false
         */
        this.isShowAfterSelect = false;
        /**
         * 选中事件，向外通知option数据
         */
        // tslint:disable-next-line:no-output-named-after-standard-event
        this.select = new EventEmitter();
        /**
         * 储存donimator bottom旧值
         */
        this.dominatorLastBottom = undefined;
        /**
         * 储存donimator left旧值
         */
        this.dominatorLastLeft = undefined;
    }
    ngOnInit() {
        super.ngOnInit();
        // 初始设置list高度
        this.initListMaxHeight();
        this.listenKeydown(this.dominatorElem);
    }
    ngOnChanges(changes) {
        super.ngOnChanges(changes);
        // dominatorElem 改变后重新添加监听
        if (changes['dominatorElem'] && !changes['dominatorElem'].firstChange) {
            this.unlistenKendown();
            this.listenKeydown(this.dominatorElem);
        }
    }
    ngOnDestroy() {
        super.ngOnDestroy();
        // 解除按键监听
        this.unlistenKendown();
        // 解除IE滚动条Bug的监听
        this.listCom.unlistenIESrollbarBug();
    }
    /**
     * 当做生命周期用吧，监听模型值变化。包括writeValue和this.model=赋值 这两个时刻。
     * @param model ngModel值
     */
    ngOnModelChange(model) {
        super.ngOnModelChange(model);
        if (!this.multiple || !this.dominatorElem) { // 多选才会有dominator行高切换
            return;
        }
        if (this.dominatorLastBottom === undefined && this.dominatorElem) { // 第一次只记录位置，不走进重定位逻辑
            // 修复SSR错误：ERROR TypeError: this.dominatorElem.getBoundingClientRect is not a function
            if (typeof this.dominatorElem.getBoundingClientRect === 'function') {
                this.dominatorLastBottom = this.dominatorElem.getBoundingClientRect().bottom;
                this.dominatorLastLeft = this.dominatorElem.getBoundingClientRect().left;
            }
            return;
        }
        this.zone.runOutsideAngular(() => {
            setTimeout(() => {
                if (!this.dominatorElem) {
                    return;
                }
                // ngModel更新（点击checkbox，或者点击叉叉号）后，dominator有可能一行/两行变换，所以更新下拉面板位置。
                // 甚至donimator本身位置也会变动。（比如测试用例中元素变动，引起donimator本身变动 ???）
                if (this.dominatorLastBottom !== this.dominatorElem.getBoundingClientRect().bottom ||
                    this.dominatorLastLeft !== this.dominatorElem.getBoundingClientRect().left) {
                    if (this.dropCom.isShow) {
                        // 仅当高度变化时，重定位。
                        this.rePosition();
                    }
                    this.dominatorLastBottom = this.dominatorElem.getBoundingClientRect().bottom;
                    this.dominatorLastLeft = this.dominatorElem.getBoundingClientRect().left;
                }
            }, 0);
        });
    }
    /**
     *  监听keydown
     * @param focusElem 焦点元素
     */
    listenKeydown(focusElem) {
        if (!focusElem) {
            return;
        }
        this.unlistenKeydownFn = this.renderer.listen(focusElem, 'keydown', (event) => {
            if (!this.isShow) {
                return;
            }
            // 10.0.2删除 KEY_SPACE 空格快捷键的响应
            switch (event.keyCode) {
                case TiKeymap.KEY_ESCAPE: // Esc键，仅可关闭
                case TiKeymap.KEY_TAB: // Tab键，仅可关闭
                    event.preventDefault(); // 阻止触发blurFn
                    this.hide();
                    break;
                case TiKeymap.KEY_ARROW_UP: // 向上箭头，上移选项
                case TiKeymap.KEY_ARROW_DOWN: // 向下箭头，下移选项
                case TiKeymap.KEY_ENTER: // ENTER键 相当于click
                case TiKeymap.KEY_NUMPAD_ENTER: // ENTER键(苹果数字小键盘)
                    this.listCom.onKeydown(event);
                    break;
                default:
                    break;
            }
            // 如果droplist响应了按键，那么就不再冒泡。
            event.stopPropagation();
        });
    }
    unlistenKendown() {
        if (this.unlistenKeydownFn) {
            this.unlistenKeydownFn();
        }
    }
    /**
     * 外部接口: 获取当前状态, 只读不写
     */
    get isShow() {
        return this.dropCom.isShow;
    }
    /**
     * 打开面板
     */
    show() {
        if (!this.isShow) {
            // 打开面板
            // 每次打开面板前需要重置list的高度确保drop高度不受其影响
            this.initListMaxHeight();
            // 打开面板
            this.dropCom.show();
            // 根据drop的最大高度设置list的最大高度
            this.restyleListMaxHeight();
            this.listCom.scrollToSelected();
            // IE滚动条Bug的监听
            this.listCom.listenIESrollbarBug();
        }
    }
    /**
     * 关闭面板的处理
     */
    hide() {
        // this.listCom.hide(); // 隐藏时list也需要做处理：清除当前hover项状态
        if (this.isShow) {
            this.dropCom.hide(); // 关闭面板
            // 解除IE滚动条Bug的监听
            this.listCom.unlistenIESrollbarBug();
        }
    }
    /**
     * 重新设置元素位置
     */
    rePosition(optionsChange) {
        if (optionsChange) {
            this.dropCom.resetPosition();
        }
        else {
            this.dropCom.setPosition();
        }
        this.restyleListMaxHeight();
    }
    /**
     * 根据drop的压缩情况，设置list的max-height
     */
    restyleListMaxHeight() {
        // 计算自定义底部的高度
        if (this.footerElemRef && this.footerElemRef.nativeElement) {
            let rect = this.footerElemRef.nativeElement.getBoundingClientRect();
            if (rect.height) {
                this.footerHeight = rect.height;
            }
        }
        // 如果drop被压缩，则根据drop最大高度设置当前list最大高度。
        const dropCurMaxHeight = parseInt(this.dropCom.nativeElement.style.maxHeight, 10);
        let dropMaxHeightAdapted = this.dropMaxHeight + this.footerHeight;
        if (!isNaN(dropCurMaxHeight) && dropCurMaxHeight < dropMaxHeightAdapted) {
            dropMaxHeightAdapted = dropCurMaxHeight;
            const computedListMaxHeight = dropMaxHeightAdapted - this.heightExcludeList - this.footerHeight;
            // 设置list max-height
            this.renderer.setStyle(this.listCom.nativeElement, 'max-height', computedListMaxHeight + 'px');
        }
    }
    // 初始化list最大高度
    initListMaxHeight() {
        this.dropMaxHeight = this.panelMaxHeight ? parseInt(this.panelMaxHeight, 10) :
            this.defaultListMaxHeight + this.heightExcludeList;
        this.renderer.setStyle(this.listCom.nativeElement, 'max-height', (this.dropMaxHeight - this.heightExcludeList) + 'px');
    }
    // 鼠标或enter点击选项后，组件隐藏
    onSelect(option) {
        this.select.emit(option);
        // nextlevel只用在省市区regionselect组件场景，选中省、市级别面板不关闭
        if (!this.isShowAfterSelect && !this.multiple && !option.nextLevel) {
            this.hide();
        }
    }
}
/**
 * 带搜索框情况下需要去除的高度
 */
// tslint:disable-next-line:binary-expression-operand-order
TiDroplistComponent.SEARCHBOX_EXCLUDE_HEIGHT = 28; // 下拉框中的搜索框的高度
TiDroplistComponent.decorators = [
    { type: Component, args: [{
                selector: 'ti-droplist',
                template: "<ti-drop [dominatorElem]=\"dominatorElem\"\r\n    [dominatorSpace]=\"dominatorSpace\"\r\n    [panelAlign]='panelAlign'\r\n    [panelWidth]='panelWidth' [class.ti3-select-small]=\"size === 'small'\">\r\n    <ti-list [multiple]=\"multiple\"\r\n        [options]=\"options\"\r\n        [(ngModel)]=\"model\"\r\n        style=\"display:block;\"\r\n        (select)=\"onSelect($event)\"\r\n        [id]=\"appendId('list')\"\r\n        [tipPosition]=\"tipPosition\"\r\n        [noDataText]=\"noDataText\">\r\n        <ng-template let-item let-i=index>\r\n                <ng-container *ngIf=\"itemTemplate else listLabelTemplate\">\r\n                        <ng-container *ngTemplateOutlet=\"itemTemplate; context: {$implicit: item,index: i}\">\r\n                        </ng-container>\r\n                </ng-container>\r\n                <ng-template #listLabelTemplate><span [title]=\"item[labelKey]\">{{item[labelKey]}}</span></ng-template>\r\n        </ng-template>\r\n    </ti-list>\r\n</ti-drop>",
                providers: [TiFormComponent.getValueAccessor(TiDroplistComponent)]
            },] }
];
TiDroplistComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: NgZone }
];
TiDroplistComponent.propDecorators = {
    dominatorElem: [{ type: Input }],
    multiple: [{ type: Input }],
    panelWidth: [{ type: Input }],
    panelMaxHeight: [{ type: Input }],
    options: [{ type: Input }],
    labelKey: [{ type: Input }],
    noDataText: [{ type: Input }],
    tipPosition: [{ type: Input }],
    dominatorSpace: [{ type: Input }],
    panelAlign: [{ type: Input }],
    type: [{ type: Input }],
    size: [{ type: Input }],
    isShowAfterSelect: [{ type: Input }],
    select: [{ type: Output }],
    dropCom: [{ type: ViewChild, args: [TiDropComponent, { static: true },] }],
    listCom: [{ type: ViewChild, args: [TiListComponent, { static: true },] }],
    footerElemRef: [{ type: ViewChild, args: ['footer', { static: false },] }],
    itemTemplate: [{ type: ContentChild, args: [TemplateRef, /* TODO: add static flag */ { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlEcm9wbGlzdENvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9jb21wb25lbnRzL2Ryb3BsaXN0L1RpRHJvcGxpc3RDb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBZ0IsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQzNGLFNBQVMsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUM1RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN2RCxPQUFPLEVBQWEsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHdkQ7OztHQUdHO0FBTUgsTUFBTSxPQUFPLG1CQUFvQixTQUFRLGVBQWU7SUF1RnBELFlBQXNCLE1BQWlCLEVBQUUsT0FBbUIsRUFBVSxJQUFZO1FBQzlFLEtBQUssQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFETCxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQStCLFNBQUksR0FBSixJQUFJLENBQVE7UUFoRmxGOztXQUVHO1FBQ08seUJBQW9CLEdBQVcsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDcEQ7O1dBRUc7UUFDTyxzQkFBaUIsR0FBVyxDQUFDLENBQUM7UUFLeEM7O1dBRUc7UUFDTSxpQkFBWSxHQUFXLENBQUMsQ0FBQztRQUtsQzs7V0FFRztRQUNNLGFBQVEsR0FBWSxLQUFLLENBQUM7UUFDbkM7Ozs7Ozs7O1dBUUc7UUFDTSxlQUFVLEdBQWtDLFdBQVcsQ0FBQztRQU14RCxhQUFRLEdBQVcsT0FBTyxDQUFDO1FB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LFNBQVMsU0FBQyxlQUFlLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzRCQUMzQyxTQUFTLFNBQUMsUUFBUSxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTsyQkFJckMsWUFBWSxTQUFDLFdBQVcsRUFBRSwyQkFBMkIsQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENvbnRlbnRDaGlsZCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIElucHV0LCBOZ1pvbmUsIE91dHB1dCxcclxuICAgIFJlbmRlcmVyMiwgVGVtcGxhdGVSZWYsIFZpZXdDaGlsZCwgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaUZvcm1Db21wb25lbnQgfSBmcm9tICcuLi9iYXNlL1RpQmFzZU1vZHVsZSc7XHJcbmltcG9ydCB7IFRpRHJvcENvbXBvbmVudCB9IGZyb20gJy4uL2Ryb3AvVGlEcm9wTW9kdWxlJztcclxuaW1wb3J0IHsgVGlMaXN0Q29tcG9uZW50IH0gZnJvbSAnLi4vbGlzdC9UaUxpc3RNb2R1bGUnO1xyXG5pbXBvcnQgeyBUaUJyb3dzZXIsIFRpS2V5bWFwIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbmltcG9ydCB7IFBvc2l0aW9uLCBUaVBvc2l0aW9uVHlwZSB9IGZyb20gJy4uLy4uL3V0aWxzL1Bvc2l0aW9uJztcclxuXHJcbi8qKlxyXG4gKiBAaWdub3JlXHJcbiAqIOS4i+aLiemdouadv+W4puacieaVsOe7hOWIl+ihqOe7hOS7tu+8jOeUqOS6jmF1Y29tcGxldGXnrYnjgILlroPmnInlrZDnsbtUaURyb3BzZWFyY2hDb21wb25lbnRcclxuICovXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICd0aS1kcm9wbGlzdCcsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vZHJvcGxpc3QuaHRtbCcsXHJcbiAgICBwcm92aWRlcnM6IFtUaUZvcm1Db21wb25lbnQuZ2V0VmFsdWVBY2Nlc3NvcihUaURyb3BsaXN0Q29tcG9uZW50KV1cclxufSlcclxuZXhwb3J0IGNsYXNzIFRpRHJvcGxpc3RDb21wb25lbnQgZXh0ZW5kcyBUaUZvcm1Db21wb25lbnQge1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5bim5pCc57Si5qGG5oOF5Ya15LiL6ZyA6KaB5Y676Zmk55qE6auY5bqmXHJcbiAgICAgKi9cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpiaW5hcnktZXhwcmVzc2lvbi1vcGVyYW5kLW9yZGVyXHJcbiAgICBwcm90ZWN0ZWQgc3RhdGljIHJlYWRvbmx5IFNFQVJDSEJPWF9FWENMVURFX0hFSUdIVDogbnVtYmVyID0gMjg7IC8vIOS4i+aLieahhuS4reeahOaQnOe0ouahhueahOmrmOW6plxyXG4gICAgLyoqXHJcbiAgICAgKiDpu5jorqTpq5jluqY45p2hIERFRkFVTFRfTElTVF9NQVhfSEVJR0hUXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBkZWZhdWx0TGlzdE1heEhlaWdodDogbnVtYmVyID0gMzAgKiA4ICsgODtcclxuICAgIC8qKlxyXG4gICAgICog6Z2i5p2/5Lit77yM6Zmk5Y67bGlzdOWklu+8jOWFtuWug+WFg+e0oOeahOWNoOS9jemrmOW6plxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgaGVpZ2h0RXhjbHVkZUxpc3Q6IG51bWJlciA9IDI7XHJcbiAgICAvKipcclxuICAgICAqIGRyb3DpnaLmnb/mnIDlpKfpq5jluqZcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBkcm9wTWF4SGVpZ2h0OiBudW1iZXI7XHJcbiAgICAvKipcclxuICAgICAqIGRyb3DpnaLmnb/oh6rlrprkuYnlupXpg6jpq5jluqZcclxuICAgICAqL1xyXG4gICAgIHByaXZhdGUgZm9vdGVySGVpZ2h0OiBudW1iZXIgPSAwO1xyXG4gICAgLyoqXHJcbiAgICAgKiBkcm9wbGlzdOS+nemZhOeahOWFg+e0oO+8jOmcgOimgeS9v+eUqOivpeWFg+e0oOi/m+ihjGRyb3BsaXN055qE5a6a5L2N5aSE55CGXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGRvbWluYXRvckVsZW06IEhUTUxFbGVtZW50O1xyXG4gICAgLyoqXHJcbiAgICAgKiDmmK/lkKblpJrpgIlcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgbXVsdGlwbGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIC8qKlxyXG4gICAgICog5LiL5ouJ6Z2i5p2/55qE5pyA5aSn5pi+56S65a695bqm77yM6K+l5Y+Y6YeP5LiO5LiL5ouJ57G757uE5Lu25L+d5oyB5LiA6Ie0XHJcbiAgICAgKlxyXG4gICAgICogMS5cImp1c3RpZmllZFwiKOm7mOiupCk6IOS4i+aLieahhueahOWuveW6puS4jlNlbGVjdOe7hOS7tueahOWuveW6puS/neaMgeS4gOiHtO+8m1xyXG4gICAgICpcclxuICAgICAqIDIuXCJhdXRvXCI6IOS4i+aLieahhueahOWuveW6puagueaNruS4i+aLiemAiemhueeahOWGheWuueiHquWKqOaSkeW8gO+8m1xyXG4gICAgICpcclxuICAgICAqIDMu6KGo56S65a695bqm55qE5a2X56ym5LiyOiDorr7nva7lm7rlrprnmoTkuIvmi4nmoYblrr3luqYo5LiN5bCP5LqOU2VsZWN057uE5Lu255qE5a695bqmKeOAguS+i+Wmgu+8mlwiMjAwcHhcIlxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBwYW5lbFdpZHRoOiAnanVzdGlmaWVkJyB8ICdhdXRvJyB8IHN0cmluZyA9ICdqdXN0aWZpZWQnO1xyXG4gICAgLyoqXHJcbiAgICAgKiDkuIvmi4npnaLmnb/nmoTmnIDlpKfmmL7npLrpq5jluqbvvIzmuqLlh7rml7bliJnlh7rmu5rliqjmnaEs6K+l5Y+Y6YeP5ZCN5LiO5LiL5ouJ57G757uE5Lu25L+d5oyB5LiA6Ie0XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIHBhbmVsTWF4SGVpZ2h0OiBzdHJpbmc7XHJcbiAgICBASW5wdXQoKSBvcHRpb25zOiBBcnJheTxhbnk+O1xyXG4gICAgQElucHV0KCkgbGFiZWxLZXk6IHN0cmluZyA9ICdsYWJlbCc7XHJcbiAgICBASW5wdXQoKSBub0RhdGFUZXh0OiBzdHJpbmcgPSAnLi4uJztcclxuICAgIEBJbnB1dCgpIHRpcFBvc2l0aW9uOiBUaVBvc2l0aW9uVHlwZSA9ICdyaWdodCc7XHJcbiAgICBASW5wdXQoKSBkb21pbmF0b3JTcGFjZTogc3RyaW5nID0gVGlEcm9wQ29tcG9uZW50LkRPTUlOQVRPUl9TUEFDRSArICdweCc7IC8vIDEwLjAuMeaWsOWinlxyXG4gICAgQElucHV0KCkgcGFuZWxBbGlnbjogJ2xlZnQnfCdyaWdodCcgPSAnbGVmdCc7IC8vIDEwLjAuMeaWsOWinlxyXG4gICAgLyoqXHJcbiAgICAgKiDlhoXpg6jmjqXlj6PvvIznlKjkvZxzdWdnZXN0aW9u5pe2dHlwZeS8oOWFpXN1Z2dlc3Rpb27vvIzpu5jorqTlgLxkZWZhdWx0XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIHR5cGU6ICdkZWZhdWx0JyB8ICdzdWdnZXN0aW9uJyA9ICdkZWZhdWx0JztcclxuICAgIC8qKlxyXG4gICAgICog5aSn5bCP5qC35byP77yMZGVmYXVsdC9zbWFsbC4g6buY6K6k5YC8ZGVmYXVsdFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBzaXplOiAnZGVmYXVsdCcgfCAnc21hbGwnID0gJ2RlZmF1bHQnO1xyXG4gICAgLyoqXHJcbiAgICAgKiDpgInkuK3pgInpobnlkI7pnaLmnb/mmK/lkKbkv53mjIHmmL7npLrvvIwg6buY6K6k5YC8ZmFsc2VcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgaXNTaG93QWZ0ZXJTZWxlY3Q6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOmAieS4reS6i+S7tu+8jOWQkeWklumAmuefpW9wdGlvbuaVsOaNrlxyXG4gICAgICovXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tb3V0cHV0LW5hbWVkLWFmdGVyLXN0YW5kYXJkLWV2ZW50XHJcbiAgICBAT3V0cHV0KCkgcmVhZG9ubHkgc2VsZWN0OiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICAgIEBWaWV3Q2hpbGQoVGlEcm9wQ29tcG9uZW50LCB7IHN0YXRpYzogdHJ1ZSB9KSBkcm9wQ29tOiBUaURyb3BDb21wb25lbnQ7XHJcbiAgICBAVmlld0NoaWxkKFRpTGlzdENvbXBvbmVudCwgeyBzdGF0aWM6IHRydWUgfSkgbGlzdENvbTogVGlMaXN0Q29tcG9uZW50O1xyXG4gICAgQFZpZXdDaGlsZCgnZm9vdGVyJywgeyBzdGF0aWM6IGZhbHNlIH0pIGZvb3RlckVsZW1SZWY6IEVsZW1lbnRSZWY7XHJcbiAgICAvKipcclxuICAgICAqIOiHquWumuS5iWxpc3TkuK3nmoRpdGVt55qE5qih5p2/XHJcbiAgICAgKi9cclxuICAgIEBDb250ZW50Q2hpbGQoVGVtcGxhdGVSZWYsIC8qIFRPRE86IGFkZCBzdGF0aWMgZmxhZyAqLyB7IHN0YXRpYzogdHJ1ZSB9KSBpdGVtVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT47XHJcbiAgICAvKipcclxuICAgICAqIOWCqOWtmGRvbmltYXRvciBib3R0b23ml6flgLxcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBkb21pbmF0b3JMYXN0Qm90dG9tOiBudW1iZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAvKipcclxuICAgICAqIOWCqOWtmGRvbmltYXRvciBsZWZ05pen5YC8XHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgZG9taW5hdG9yTGFzdExlZnQ6IG51bWJlciA9IHVuZGVmaW5lZDtcclxuXHJcbiAgICBwcml2YXRlIHVubGlzdGVuS2V5ZG93bkZuOiAoKSA9PiB2b2lkO1xyXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIHJlbmRlcjogUmVuZGVyZXIyLCBob3N0UmVmOiBFbGVtZW50UmVmLCBwcml2YXRlIHpvbmU6IE5nWm9uZSkge1xyXG4gICAgICAgIHN1cGVyKGhvc3RSZWYsIHJlbmRlcik7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgc3VwZXIubmdPbkluaXQoKTtcclxuICAgICAgICAvLyDliJ3lp4vorr7nva5saXN06auY5bqmXHJcbiAgICAgICAgdGhpcy5pbml0TGlzdE1heEhlaWdodCgpO1xyXG4gICAgICAgIHRoaXMubGlzdGVuS2V5ZG93bih0aGlzLmRvbWluYXRvckVsZW0pO1xyXG4gICAgfVxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIHN1cGVyLm5nT25DaGFuZ2VzKGNoYW5nZXMpO1xyXG4gICAgICAgIC8vIGRvbWluYXRvckVsZW0g5pS55Y+Y5ZCO6YeN5paw5re75Yqg55uR5ZCsXHJcbiAgICAgICAgaWYgKGNoYW5nZXNbJ2RvbWluYXRvckVsZW0nXSAmJiAhY2hhbmdlc1snZG9taW5hdG9yRWxlbSddLmZpcnN0Q2hhbmdlKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5saXN0ZW5LZW5kb3duKCk7XHJcbiAgICAgICAgICAgIHRoaXMubGlzdGVuS2V5ZG93bih0aGlzLmRvbWluYXRvckVsZW0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uRGVzdHJveSgpO1xyXG4gICAgICAgIC8vIOino+mZpOaMiemUruebkeWQrFxyXG4gICAgICAgIHRoaXMudW5saXN0ZW5LZW5kb3duKCk7XHJcbiAgICAgICAgLy8g6Kej6ZmkSUXmu5rliqjmnaFCdWfnmoTnm5HlkKxcclxuICAgICAgICB0aGlzLmxpc3RDb20udW5saXN0ZW5JRVNyb2xsYmFyQnVnKCk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOW9k+WBmueUn+WRveWRqOacn+eUqOWQp++8jOebkeWQrOaooeWei+WAvOWPmOWMluOAguWMheaLrHdyaXRlVmFsdWXlkox0aGlzLm1vZGVsPei1i+WAvCDov5nkuKTkuKrml7bliLvjgIJcclxuICAgICAqIEBwYXJhbSBtb2RlbCBuZ01vZGVs5YC8XHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBuZ09uTW9kZWxDaGFuZ2UobW9kZWw6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIHN1cGVyLm5nT25Nb2RlbENoYW5nZShtb2RlbCk7XHJcbiAgICAgICAgaWYgKCF0aGlzLm11bHRpcGxlIHx8ICF0aGlzLmRvbWluYXRvckVsZW0pIHsgIC8vIOWkmumAieaJjeS8muaciWRvbWluYXRvcuihjOmrmOWIh+aNolxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmRvbWluYXRvckxhc3RCb3R0b20gPT09IHVuZGVmaW5lZCAmJiB0aGlzLmRvbWluYXRvckVsZW0pIHsgLy8g56ys5LiA5qyh5Y+q6K6w5b2V5L2N572u77yM5LiN6LWw6L+b6YeN5a6a5L2N6YC76L6RXHJcbiAgICAgICAgICAgIC8vIOS/ruWkjVNTUumUmeivr++8mkVSUk9SIFR5cGVFcnJvcjogdGhpcy5kb21pbmF0b3JFbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBub3QgYSBmdW5jdGlvblxyXG4gICAgICAgICAgICBpZih0eXBlb2YgdGhpcy5kb21pbmF0b3JFbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCA9PT0gJ2Z1bmN0aW9uJyl7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRvbWluYXRvckxhc3RCb3R0b20gPSB0aGlzLmRvbWluYXRvckVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kb21pbmF0b3JMYXN0TGVmdCA9IHRoaXMuZG9taW5hdG9yRWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgLy8gVE9ET++8mui/memHjHNldFRpbWVvdXTog73lkKbljrvpmaTvvJ9cclxuICAgICAgICAgICAgICAgIGlmKCF0aGlzLmRvbWluYXRvckVsZW0pe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIG5nTW9kZWzmm7TmlrDvvIjngrnlh7tjaGVja2JveO+8jOaIluiAheeCueWHu+WPieWPieWPt++8ieWQju+8jGRvbWluYXRvcuacieWPr+iDveS4gOihjC/kuKTooYzlj5jmjaLvvIzmiYDku6Xmm7TmlrDkuIvmi4npnaLmnb/kvY3nva7jgIJcclxuICAgICAgICAgICAgICAgIC8vIOeUmuiHs2RvbmltYXRvcuacrOi6q+S9jee9ruS5n+S8muWPmOWKqOOAgu+8iOavlOWmgua1i+ivleeUqOS+i+S4reWFg+e0oOWPmOWKqO+8jOW8lei1t2RvbmltYXRvcuacrOi6q+WPmOWKqCA/Pz/vvIlcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmRvbWluYXRvckxhc3RCb3R0b20gIT09IHRoaXMuZG9taW5hdG9yRWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b20gfHxcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbWluYXRvckxhc3RMZWZ0ICE9PSB0aGlzLmRvbWluYXRvckVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyb3BDb20uaXNTaG93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOS7heW9k+mrmOW6puWPmOWMluaXtu+8jOmHjeWumuS9jeOAglxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlUG9zaXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb21pbmF0b3JMYXN0Qm90dG9tID0gdGhpcy5kb21pbmF0b3JFbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbWluYXRvckxhc3RMZWZ0ID0gdGhpcy5kb21pbmF0b3JFbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogIOebkeWQrGtleWRvd25cclxuICAgICAqIEBwYXJhbSBmb2N1c0VsZW0g54Sm54K55YWD57SgXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBsaXN0ZW5LZXlkb3duKGZvY3VzRWxlbTogSFRNTEVsZW1lbnQpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIWZvY3VzRWxlbSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudW5saXN0ZW5LZXlkb3duRm4gPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbihmb2N1c0VsZW0sICdrZXlkb3duJyxcclxuICAgICAgICAgICAgKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNTaG93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gMTAuMC4y5Yig6ZmkIEtFWV9TUEFDRSDnqbrmoLzlv6vmjbfplK7nmoTlk43lupRcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnQua2V5Q29kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgVGlLZXltYXAuS0VZX0VTQ0FQRTogLy8gRXNj6ZSu77yM5LuF5Y+v5YWz6ZetXHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBUaUtleW1hcC5LRVlfVEFCOiAvLyBUYWLplK7vvIzku4Xlj6/lhbPpl61cclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8g6Zi75q2i6Kem5Y+RYmx1ckZuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIFRpS2V5bWFwLktFWV9BUlJPV19VUDogLy8g5ZCR5LiK566t5aS077yM5LiK56e76YCJ6aG5XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBUaUtleW1hcC5LRVlfQVJST1dfRE9XTjogLy8g5ZCR5LiL566t5aS077yM5LiL56e76YCJ6aG5XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBUaUtleW1hcC5LRVlfRU5URVI6IC8vIEVOVEVS6ZSuIOebuOW9k+S6jmNsaWNrXHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBUaUtleW1hcC5LRVlfTlVNUEFEX0VOVEVSOiAvLyBFTlRFUumUrijoi7nmnpzmlbDlrZflsI/plK7nm5gpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdENvbS5vbktleWRvd24oZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIOWmguaenGRyb3BsaXN05ZON5bqU5LqG5oyJ6ZSu77yM6YKj5LmI5bCx5LiN5YaN5YaS5rOh44CCXHJcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcbiAgICBwcm90ZWN0ZWQgdW5saXN0ZW5LZW5kb3duKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnVubGlzdGVuS2V5ZG93bkZuKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5saXN0ZW5LZXlkb3duRm4oKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOWklumDqOaOpeWPozog6I635Y+W5b2T5YmN54q25oCBLCDlj6ror7vkuI3lhplcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldCBpc1Nob3coKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZHJvcENvbS5pc1Nob3c7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmiZPlvIDpnaLmnb9cclxuICAgICAqL1xyXG4gICAgcHVibGljIHNob3coKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzU2hvdykge1xyXG4gICAgICAgICAgICAvLyDmiZPlvIDpnaLmnb9cclxuICAgICAgICAgICAgLy8g5q+P5qyh5omT5byA6Z2i5p2/5YmN6ZyA6KaB6YeN572ubGlzdOeahOmrmOW6puehruS/nWRyb3Dpq5jluqbkuI3lj5flhbblvbHlk41cclxuICAgICAgICAgICAgdGhpcy5pbml0TGlzdE1heEhlaWdodCgpO1xyXG4gICAgICAgICAgICAvLyDmiZPlvIDpnaLmnb9cclxuICAgICAgICAgICAgdGhpcy5kcm9wQ29tLnNob3coKTtcclxuICAgICAgICAgICAgLy8g5qC55o2uZHJvcOeahOacgOWkp+mrmOW6puiuvue9rmxpc3TnmoTmnIDlpKfpq5jluqZcclxuICAgICAgICAgICAgdGhpcy5yZXN0eWxlTGlzdE1heEhlaWdodCgpO1xyXG4gICAgICAgICAgICB0aGlzLmxpc3RDb20uc2Nyb2xsVG9TZWxlY3RlZCgpO1xyXG4gICAgICAgICAgICAvLyBJRea7muWKqOadoUJ1Z+eahOebkeWQrFxyXG4gICAgICAgICAgICB0aGlzLmxpc3RDb20ubGlzdGVuSUVTcm9sbGJhckJ1ZygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5YWz6Zet6Z2i5p2/55qE5aSE55CGXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBoaWRlKCk6IHZvaWQge1xyXG4gICAgICAgIC8vIHRoaXMubGlzdENvbS5oaWRlKCk7IC8vIOmakOiXj+aXtmxpc3TkuZ/pnIDopoHlgZrlpITnkIbvvJrmuIXpmaTlvZPliY1ob3ZlcumhueeKtuaAgVxyXG4gICAgICAgIGlmICh0aGlzLmlzU2hvdykge1xyXG4gICAgICAgICAgICB0aGlzLmRyb3BDb20uaGlkZSgpOyAvLyDlhbPpl63pnaLmnb9cclxuICAgICAgICAgICAgLy8g6Kej6ZmkSUXmu5rliqjmnaFCdWfnmoTnm5HlkKxcclxuICAgICAgICAgICAgdGhpcy5saXN0Q29tLnVubGlzdGVuSUVTcm9sbGJhckJ1ZygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog6YeN5paw6K6+572u5YWD57Sg5L2N572uXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyByZVBvc2l0aW9uKG9wdGlvbnNDaGFuZ2U/OiBib29sZWFuKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKG9wdGlvbnNDaGFuZ2UpIHtcclxuICAgICAgICAgICAgdGhpcy5kcm9wQ29tLnJlc2V0UG9zaXRpb24oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmRyb3BDb20uc2V0UG9zaXRpb24oKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucmVzdHlsZUxpc3RNYXhIZWlnaHQoKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5qC55o2uZHJvcOeahOWOi+e8qeaDheWGte+8jOiuvue9rmxpc3TnmoRtYXgtaGVpZ2h0XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyByZXN0eWxlTGlzdE1heEhlaWdodCgpOiB2b2lkIHtcclxuICAgICAgICAvLyDorqHnrpfoh6rlrprkuYnlupXpg6jnmoTpq5jluqZcclxuICAgICAgICBpZiAodGhpcy5mb290ZXJFbGVtUmVmICYmIHRoaXMuZm9vdGVyRWxlbVJlZi5uYXRpdmVFbGVtZW50KSB7XHJcbiAgICAgICAgICAgIGxldCByZWN0OiBhbnkgPSB0aGlzLmZvb3RlckVsZW1SZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICAgICAgaWYgKHJlY3QuaGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZvb3RlckhlaWdodCA9IHJlY3QuaGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWmguaenGRyb3DooqvljovnvKnvvIzliJnmoLnmja5kcm9w5pyA5aSn6auY5bqm6K6+572u5b2T5YmNbGlzdOacgOWkp+mrmOW6puOAglxyXG4gICAgICAgIGNvbnN0IGRyb3BDdXJNYXhIZWlnaHQ6IG51bWJlciA9IHBhcnNlSW50KHRoaXMuZHJvcENvbS5uYXRpdmVFbGVtZW50LnN0eWxlLm1heEhlaWdodCwgMTApO1xyXG4gICAgICAgIGxldCBkcm9wTWF4SGVpZ2h0QWRhcHRlZDogbnVtYmVyID0gdGhpcy5kcm9wTWF4SGVpZ2h0ICsgdGhpcy5mb290ZXJIZWlnaHQ7XHJcbiAgICAgICAgaWYgKCFpc05hTihkcm9wQ3VyTWF4SGVpZ2h0KSAmJiBkcm9wQ3VyTWF4SGVpZ2h0IDwgZHJvcE1heEhlaWdodEFkYXB0ZWQpIHtcclxuICAgICAgICAgICAgZHJvcE1heEhlaWdodEFkYXB0ZWQgPSBkcm9wQ3VyTWF4SGVpZ2h0O1xyXG4gICAgICAgICAgICBjb25zdCBjb21wdXRlZExpc3RNYXhIZWlnaHQ6IG51bWJlciA9IGRyb3BNYXhIZWlnaHRBZGFwdGVkIC0gdGhpcy5oZWlnaHRFeGNsdWRlTGlzdCAtIHRoaXMuZm9vdGVySGVpZ2h0O1xyXG4gICAgICAgICAgICAvLyDorr7nva5saXN0IG1heC1oZWlnaHRcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmxpc3RDb20ubmF0aXZlRWxlbWVudCwgJ21heC1oZWlnaHQnLCBjb21wdXRlZExpc3RNYXhIZWlnaHQgKyAncHgnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyDliJ3lp4vljJZsaXN05pyA5aSn6auY5bqmXHJcbiAgICBwcml2YXRlIGluaXRMaXN0TWF4SGVpZ2h0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZHJvcE1heEhlaWdodCA9IHRoaXMucGFuZWxNYXhIZWlnaHQgPyBwYXJzZUludCh0aGlzLnBhbmVsTWF4SGVpZ2h0LCAxMCkgOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0TGlzdE1heEhlaWdodCArIHRoaXMuaGVpZ2h0RXhjbHVkZUxpc3Q7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmxpc3RDb20ubmF0aXZlRWxlbWVudCwgJ21heC1oZWlnaHQnLCAodGhpcy5kcm9wTWF4SGVpZ2h0IC0gdGhpcy5oZWlnaHRFeGNsdWRlTGlzdCkgKyAncHgnKTtcclxuICAgIH1cclxuICAgIC8vIOm8oOagh+aIlmVudGVy54K55Ye76YCJ6aG55ZCO77yM57uE5Lu26ZqQ6JePXHJcbiAgICBwdWJsaWMgb25TZWxlY3Qob3B0aW9uOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnNlbGVjdC5lbWl0KG9wdGlvbik7XHJcbiAgICAgICAgLy8gbmV4dGxldmVs5Y+q55So5Zyo55yB5biC5Yy6cmVnaW9uc2VsZWN057uE5Lu25Zy65pmv77yM6YCJ5Lit55yB44CB5biC57qn5Yir6Z2i5p2/5LiN5YWz6ZetXHJcbiAgICAgICAgaWYgKCF0aGlzLmlzU2hvd0FmdGVyU2VsZWN0ICYmICF0aGlzLm11bHRpcGxlICYmICFvcHRpb24ubmV4dExldmVsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=