import { Directive, ElementRef, EventEmitter, Input, NgZone, Output, Renderer2 } from '@angular/core';
import { TiTipService } from '../../services/tip/TiTipService';
import { Util, TiBrowser } from '../../utils/Util';
/**
 * 多行文本超出情况下文本处理出...并tip提示
 *
 */
export class TiOverflowMaxlineDirective {
    constructor(hostRef, renderer2, tipService, zone) {
        this.hostRef = hostRef;
        this.renderer2 = renderer2;
        this.tipService = tipService;
        this.zone = zone;
        /**
         * 文本最大行数，默认3行
         */
        this.maxLine = 3;
        /**
         * 配置文本过长时显示的tip的最大宽度。
         *
         * 3.0.9新增
         */
        this.tiTipMaxWidth = '276px';
        /**
         * 图标提示
         */
        this.iconTip = '';
        /**
         * @ignore
         * 文本被截断之后的末尾填充符号
         */
        this.character = '...'; // 暂不开放
        /**
         * @ignore
         * 图标是否可以聚焦，默认不可聚焦。
         */
        this.iconFocusable = false;
        /**
         * @ignore
         * 图标是否灰化，默认不灰化
         */
        this.iconDisabled = false;
        /**
         * @ignore
         * 文本被截断之后末尾图标点击事件
         */
        this.iconClick = new EventEmitter();
        this.shaveTextFn = () => {
            let fontHtml;
            if (Util.isEmptyString(this.iconName)) {
                fontHtml = '';
            }
            else {
                // 此处添加属性tiOverflowEndicon为了适配在plus3中定义末尾图标的样式
                // 在labelEditor组件中，需要可以聚焦。
                fontHtml = this.iconFocusable ? `<span style="display:inline-block;width:16px;line-height: 1"
                tabindex="${this.iconDisabled ? -1 : 0}" tiOverflowEndicon  class="ti3-icon-${this.iconName} ti3-icon"></span>`
                    : `<span style="display:inline-block;width:16px;line-height: 1"
                tiOverflowEndicon class="ti3-icon-${this.iconName} ti3-icon"></span>`;
            }
            // 修复SSR错误：ERROR ReferenceError: getComputedStyle is not defined
            if (typeof getComputedStyle === 'undefined') {
                return;
            }
            const lineHeight = parseFloat(getComputedStyle(this.nativeElement)
                .getPropertyValue('line-height'));
            const multiLineHeight = lineHeight * this.maxLine;
            this.nativeElement.textContent = this.text;
            // 如果该元素为inline元素时，宽度不生效会导致元素出...样式不生效，因此此处做处理
            if (getComputedStyle(this.nativeElement).display === 'inline') {
                this.renderer2.setStyle(this.nativeElement, 'display', 'inline-block');
            }
            this.nativeElement.insertAdjacentHTML('beforeend', fontHtml);
            if (this.text.length < 2 || this.nativeElement.offsetHeight <= multiLineHeight) {
                this.setEvents();
                this.isShave = false;
                return;
            }
            let charHtml = this.character;
            charHtml = charHtml.concat(fontHtml);
            // 以下使用二分算法计算文本截取位置
            let max = this.text.length - 1;
            let min = 0;
            let middle;
            while (min < max) {
                middle = (min + max + 1) / 2;
                this.nativeElement.textContent = this.text.slice(0, middle);
                this.nativeElement.insertAdjacentHTML('beforeend', charHtml);
                if (this.nativeElement.offsetHeight > multiLineHeight + 1) {
                    max = middle - 1; // 截取的内容少
                }
                else {
                    min = middle; // 截取的内容多
                }
            }
            this.nativeElement.textContent = this.text.slice(0, max);
            this.nativeElement.insertAdjacentHTML('beforeend', charHtml);
            this.setEvents();
            this.isShave = true;
        };
        this.nativeElement = this.hostRef.nativeElement;
    }
    ngOnChanges(changes) {
        this.text = this.textContent || this.nativeElement.innerHTML;
        if ((changes.maxLine && !changes.maxLine.firstChange)
            || (changes.textContent && !changes.textContent.firstChange)) {
            this.shaveTextFn();
        }
        if (this.iconFocusable && changes.iconDisabled && !changes.iconDisabled.firstChange) {
            const spanEle = this.nativeElement.querySelector('span[tiOverflowEndicon]');
            if (spanEle) {
                this.renderer2.setAttribute(spanEle, 'tabindex', this.iconDisabled ? '-1' : '0');
            }
        }
    }
    // tip配置
    ngAfterViewInit() {
        this.text = this.textContent || this.nativeElement.innerHTML; // 视图初始化完成后获取宿主元素文本
        if (TiBrowser.isIE()) {
            setTimeout(() => {
                this.shaveTextFn(); // IE下需延时处理，否则初始化获取到 offsetHeight 值与谷歌有差异
            }, 0);
        }
        else {
            this.shaveTextFn();
        }
        this.renderer2.listen(this.nativeElement, 'mouseenter', () => {
            if (this.isShave) {
                this.tipContent = this.tiTipContent || this.text;
                if (!this.tipInstance) {
                    this.tipInstance = this.tipService.create(this.nativeElement, {
                        position: this.tiTipPosition || 'right',
                        maxWidth: this.tiTipMaxWidth,
                        trigger: 'mouse'
                    });
                    this.tipInstance.show(this.tipContent);
                }
                else {
                    this.tipInstance.show(this.tipContent);
                }
            }
        });
        this.renderer2.listen(this.nativeElement, 'mouseleave', () => {
            if (this.tipInstance) {
                this.tipInstance.hide();
            }
        });
        // 修复SSR错误：ERROR ReferenceError: window is not defined
        if (typeof window === 'undefined') {
            return;
        }
        this.zone.runOutsideAngular(() => {
            this.windowResizeListener = this.renderer2.listen(window, 'resize', this.shaveTextFn);
        });
    }
    ngAfterContentChecked() {
        if (!this.nativeElement.children || this.nativeElement.children.length < 1) {
            return;
        }
        // 解绑原有监听
        if (this.listenFns) {
            this.listenFns.forEach((fn) => fn());
        }
        this.listenFns = new Array();
        this.listenFns.push(this.renderer2.listen(this.nativeElement.children[0], 'click', () => {
            this.iconClick.emit();
            if (this.icontipInstance) {
                this.icontipInstance.hide();
            }
        }));
        this.listenFns.push(this.renderer2.listen(this.nativeElement.children[0], 'mouseenter', () => {
            if (this.tipInstance) {
                this.tipInstance.hide();
            }
            this.icontipInstance = this.tipService.create(this.nativeElement.children[0], {
                position: 'top',
                maxWidth: this.tiTipMaxWidth,
                trigger: 'mouse'
            });
            this.icontipInstance.show(this.iconTip);
        }));
        this.listenFns.push(this.renderer2.listen(this.nativeElement.children[0], 'mouseleave', () => {
            if (this.tipInstance) {
                this.tipInstance.show(this.tipContent);
            }
            if (this.icontipInstance) {
                this.icontipInstance.hide();
            }
        }));
    }
    ngOnDestroy() {
        if (this.windowResizeListener) {
            this.windowResizeListener();
        }
        if (this.listenFns) {
            this.listenFns.forEach((fn) => fn());
        }
    }
    setEvents() {
        if (this.iconFocusable) {
            const clickIconEle = this.nativeElement.querySelector('span[tiOverflowEndicon]');
            if (!clickIconEle) {
                return;
            }
            this.zone.runOutsideAngular(() => {
                this.renderer2.listen(clickIconEle, 'mousedown', () => {
                    this.renderer2.setStyle(clickIconEle, 'outline', 'none');
                });
                this.renderer2.listen(clickIconEle, 'blur', () => {
                    this.renderer2.setStyle(clickIconEle, 'outline', '');
                });
            });
        }
    }
}
TiOverflowMaxlineDirective.decorators = [
    { type: Directive, args: [{
                selector: '[tiOverflow][maxLine]'
            },] }
];
TiOverflowMaxlineDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: TiTipService },
    { type: NgZone }
];
TiOverflowMaxlineDirective.propDecorators = {
    maxLine: [{ type: Input }],
    tiTipMaxWidth: [{ type: Input }],
    tiTipPosition: [{ type: Input }],
    tiTipContent: [{ type: Input }],
    iconName: [{ type: Input }],
    iconTip: [{ type: Input }],
    textContent: [{ type: Input }],
    character: [{ type: Input }],
    iconFocusable: [{ type: Input }],
    iconDisabled: [{ type: Input }],
    iconClick: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlPdmVyZmxvd01heGxpbmVEaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9AY2xvdWQvdGlueTMvZGlyZWN0aXZlcy9vdmVyZmxvdy9UaU92ZXJmbG93TWF4bGluZURpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBR0gsU0FBUyxFQUNULFVBQVUsRUFDVixZQUFZLEVBQ1osS0FBSyxFQUNMLE1BQU0sRUFHTixNQUFNLEVBQ04sU0FBUyxFQUVaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUUvRCxPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBR25EOzs7R0FHRztBQUtILE1BQU0sT0FBTywwQkFBMEI7SUFFbkMsWUFDWSxPQUFtQixFQUNuQixTQUFvQixFQUNwQixVQUF3QixFQUN4QixJQUFZO1FBSFosWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUNuQixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLGVBQVUsR0FBVixVQUFVLENBQWM7UUFDeEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUd4Qjs7V0FFRztRQUNNLFlBQU8sR0FBVyxDQUFDLENBQUM7UUFDN0I7Ozs7V0FJRztRQUNNLGtCQUFhLEdBQVcsT0FBTyxDQUFDO1FBY3pDOztXQUVHO1FBQ00sWUFBTyxHQUFXLEVBQUUsQ0FBQztRQUs5Qjs7O1dBR0c7UUFDTSxjQUFTLEdBQVcsS0FBSyxDQUFDLENBQUMsT0FBTztRQUMzQzs7O1dBR0c7UUFDTSxrQkFBYSxHQUFZLEtBQUssQ0FBQztRQUN4Qzs7O1dBR0c7UUFDTSxpQkFBWSxHQUFZLEtBQUssQ0FBQztRQUN2Qzs7O1dBR0c7UUFDZ0IsY0FBUyxHQUF3QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBVS9ELGdCQUFXLEdBQUcsR0FBUyxFQUFFO1lBQzdCLElBQUks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QUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ3BEO0lBQ0wsQ0FBQztJQUVNLFNBQVM7UUFDWixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDcEIsTUFBTSxZQUFZLEdBQWdCLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLHlCQUF5QixDQUFDLENBQUM7WUFDOUYsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDZixPQUFPO2FBQ1Y7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQVMsRUFBRTtnQkFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxHQUFTLEVBQUU7b0JBQ3hELElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7Z0JBQzdELENBQUMsQ0FBQyxDQUFDO2dCQUNILElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxNQUFNLEVBQUUsR0FBUyxFQUFFO29CQUNuRCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUN6RCxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDOzs7WUEvT0osU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSx1QkFBdUI7YUFDcEM7OztZQXJCRyxVQUFVO1lBT1YsU0FBUztZQUdKLFlBQVk7WUFQakIsTUFBTTs7O3NCQWdDTCxLQUFLOzRCQU1MLEtBQUs7NEJBSUwsS0FBSzsyQkFJTCxLQUFLO3VCQUtMLEtBQUs7c0JBSUwsS0FBSzswQkFJTCxLQUFLO3dCQUtMLEtBQUs7NEJBS0wsS0FBSzsyQkFLTCxLQUFLO3dCQUtMLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgQWZ0ZXJDb250ZW50Q2hlY2tlZCxcclxuICAgIEFmdGVyVmlld0luaXQsXHJcbiAgICBEaXJlY3RpdmUsXHJcbiAgICBFbGVtZW50UmVmLFxyXG4gICAgRXZlbnRFbWl0dGVyLFxyXG4gICAgSW5wdXQsXHJcbiAgICBOZ1pvbmUsXHJcbiAgICBPbkNoYW5nZXMsXHJcbiAgICBPbkRlc3Ryb3ksXHJcbiAgICBPdXRwdXQsXHJcbiAgICBSZW5kZXJlcjIsXHJcbiAgICBTaW1wbGVDaGFuZ2VzXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRpVGlwU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RpcC9UaVRpcFNlcnZpY2UnO1xyXG5pbXBvcnQgeyBUaVRpcFJlZiB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RpcC9UaVRpcEludGVyZmFjZSc7XHJcbmltcG9ydCB7IFV0aWwsIFRpQnJvd3NlciB9IGZyb20gJy4uLy4uL3V0aWxzL1V0aWwnO1xyXG5pbXBvcnQgeyBUaVBvc2l0aW9uVHlwZSB9IGZyb20gJy4uLy4uL3V0aWxzL1Bvc2l0aW9uJztcclxuXHJcbi8qKlxyXG4gKiDlpJrooYzmlofmnKzotoXlh7rmg4XlhrXkuIvmlofmnKzlpITnkIblh7ouLi7lubZ0aXDmj5DnpLpcclxuICpcclxuICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbdGlPdmVyZmxvd11bbWF4TGluZV0nXHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgVGlPdmVyZmxvd01heGxpbmVEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBBZnRlckNvbnRlbnRDaGVja2VkLCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcbiAgICBwdWJsaWMgbmF0aXZlRWxlbWVudDogYW55O1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBob3N0UmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgIHByaXZhdGUgcmVuZGVyZXIyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgcHJpdmF0ZSB0aXBTZXJ2aWNlOiBUaVRpcFNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUpIHtcclxuICAgICAgICB0aGlzLm5hdGl2ZUVsZW1lbnQgPSB0aGlzLmhvc3RSZWYubmF0aXZlRWxlbWVudDtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5paH5pys5pyA5aSn6KGM5pWw77yM6buY6K6kM+ihjFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBtYXhMaW5lOiBudW1iZXIgPSAzO1xyXG4gICAgLyoqXHJcbiAgICAgKiDphY3nva7mlofmnKzov4fplb/ml7bmmL7npLrnmoR0aXDnmoTmnIDlpKflrr3luqbjgIJcclxuICAgICAqXHJcbiAgICAgKiAzLjAuOeaWsOWinlxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSB0aVRpcE1heFdpZHRoOiBzdHJpbmcgPSAnMjc2cHgnO1xyXG4gICAgLyoqXHJcbiAgICAgKiDmlofmnKzooqvmiKrmlq3kuYvlkI7nmoR0aXDmlrnlkJFcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgdGlUaXBQb3NpdGlvbjogVGlQb3NpdGlvblR5cGU7XHJcbiAgICAvKipcclxuICAgICAqIOaWh+acrOiiq+aIquaWreS5i+WQjueahHRpcOWGheWuuVxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSB0aVRpcENvbnRlbnQ6IHN0cmluZztcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5paH5pys6KKr5oiq5pat5LmL5ZCO5pyr5bC+5Zu+5qCH5bGV56S6XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGljb25OYW1lOiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIOWbvuagh+aPkOekulxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBpY29uVGlwOiBzdHJpbmcgPSAnJztcclxuICAgIC8qKlxyXG4gICAgICog5a6/5Li75paH5pysXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIHRleHRDb250ZW50OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaWh+acrOiiq+aIquaWreS5i+WQjueahOacq+WwvuWhq+WFheespuWPt1xyXG4gICAgICovXHJcbiAgICBASW5wdXQoKSBjaGFyYWN0ZXI6IHN0cmluZyA9ICcuLi4nOyAvLyDmmoLkuI3lvIDmlL5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5Zu+5qCH5piv5ZCm5Y+v5Lul6IGa54Sm77yM6buY6K6k5LiN5Y+v6IGa54Sm44CCXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGljb25Gb2N1c2FibGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5Zu+5qCH5piv5ZCm54Gw5YyW77yM6buY6K6k5LiN54Gw5YyWXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGljb25EaXNhYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDmlofmnKzooqvmiKrmlq3kuYvlkI7mnKvlsL7lm77moIfngrnlh7vkuovku7ZcclxuICAgICAqL1xyXG4gICAgQE91dHB1dCgpIHJlYWRvbmx5IGljb25DbGljazogRXZlbnRFbWl0dGVyPEV2ZW50PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuICAgIHByaXZhdGUgdGV4dDogc3RyaW5nOyAvLyDlrr/kuLvlhYPntKDmlofmnKxcclxuICAgIHByaXZhdGUgaXNTaGF2ZTogYm9vbGVhbjsgLy8g5piv5ZCm5bey57uP5oiq5Y+WXHJcbiAgICBwcml2YXRlIHRpcEluc3RhbmNlOiBUaVRpcFJlZjsgIC8vIHRpcOWunuS+i1xyXG4gICAgcHJpdmF0ZSBpY29udGlwSW5zdGFuY2U6IFRpVGlwUmVmOyAgLy8gaWNvbnRpcOWunuS+i1xyXG5cclxuICAgIHByaXZhdGUgbGlzdGVuRm5zOiBBcnJheTwoKSA9PiB2b2lkPjsgLy8g55uR5ZCs5LqL5Lu2XHJcbiAgICBwcml2YXRlIHdpbmRvd1Jlc2l6ZUxpc3RlbmVyOiAoKSA9PiB2b2lkO1xyXG4gICAgcHJpdmF0ZSB0aXBDb250ZW50OiBzdHJpbmc7IC8vIOacgOe7iOWxleekuueahHRpcOWGheWuuVxyXG5cclxuICAgIHByaXZhdGUgc2hhdmVUZXh0Rm4gPSAoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgbGV0IGZvbnRIdG1sOiBzdHJpbmc7XHJcbiAgICAgICAgaWYgKFV0aWwuaXNFbXB0eVN0cmluZyh0aGlzLmljb25OYW1lKSkge1xyXG4gICAgICAgICAgICBmb250SHRtbCA9ICcnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOatpOWkhOa3u+WKoOWxnuaAp3RpT3ZlcmZsb3dFbmRpY29u5Li65LqG6YCC6YWN5ZyocGx1czPkuK3lrprkuYnmnKvlsL7lm77moIfnmoTmoLflvI9cclxuICAgICAgICAgICAgLy8g5ZyobGFiZWxFZGl0b3Lnu4Tku7bkuK3vvIzpnIDopoHlj6/ku6XogZrnhKbjgIJcclxuICAgICAgICAgICAgZm9udEh0bWwgPSB0aGlzLmljb25Gb2N1c2FibGUgPyBgPHNwYW4gc3R5bGU9XCJkaXNwbGF5OmlubGluZS1ibG9jazt3aWR0aDoxNnB4O2xpbmUtaGVpZ2h0OiAxXCJcclxuICAgICAgICAgICAgICAgIHRhYmluZGV4PVwiJHt0aGlzLmljb25EaXNhYmxlZCA/IC0xIDogMH1cIiB0aU92ZXJmbG93RW5kaWNvbiAgY2xhc3M9XCJ0aTMtaWNvbi0ke3RoaXMuaWNvbk5hbWV9IHRpMy1pY29uXCI+PC9zcGFuPmBcclxuICAgICAgICAgICAgICAgIDogYDxzcGFuIHN0eWxlPVwiZGlzcGxheTppbmxpbmUtYmxvY2s7d2lkdGg6MTZweDtsaW5lLWhlaWdodDogMVwiXHJcbiAgICAgICAgICAgICAgICB0aU92ZXJmbG93RW5kaWNvbiBjbGFzcz1cInRpMy1pY29uLSR7dGhpcy5pY29uTmFtZX0gdGkzLWljb25cIj48L3NwYW4+YDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5L+u5aSNU1NS6ZSZ6K+v77yaRVJST1IgUmVmZXJlbmNlRXJyb3I6IGdldENvbXB1dGVkU3R5bGUgaXMgbm90IGRlZmluZWRcclxuICAgICAgICBpZiAodHlwZW9mIGdldENvbXB1dGVkU3R5bGUgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbGluZUhlaWdodDogbnVtYmVyID0gcGFyc2VGbG9hdChnZXRDb21wdXRlZFN0eWxlKHRoaXMubmF0aXZlRWxlbWVudClcclxuICAgICAgICAgICAgLmdldFByb3BlcnR5VmFsdWUoJ2xpbmUtaGVpZ2h0JykpO1xyXG4gICAgICAgIGNvbnN0IG11bHRpTGluZUhlaWdodDogbnVtYmVyID0gbGluZUhlaWdodCAqIHRoaXMubWF4TGluZTtcclxuICAgICAgICB0aGlzLm5hdGl2ZUVsZW1lbnQudGV4dENvbnRlbnQgPSB0aGlzLnRleHQ7XHJcbiAgICAgICAgLy8g5aaC5p6c6K+l5YWD57Sg5Li6aW5saW5l5YWD57Sg5pe277yM5a695bqm5LiN55Sf5pWI5Lya5a+86Ie05YWD57Sg5Ye6Li4u5qC35byP5LiN55Sf5pWI77yM5Zug5q2k5q2k5aSE5YGa5aSE55CGXHJcbiAgICAgICAgaWYgKGdldENvbXB1dGVkU3R5bGUodGhpcy5uYXRpdmVFbGVtZW50KS5kaXNwbGF5ID09PSAnaW5saW5lJykge1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyMi5zZXRTdHlsZSh0aGlzLm5hdGl2ZUVsZW1lbnQsICdkaXNwbGF5JywgJ2lubGluZS1ibG9jaycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm5hdGl2ZUVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCdiZWZvcmVlbmQnLCBmb250SHRtbCk7XHJcbiAgICAgICAgaWYgKHRoaXMudGV4dC5sZW5ndGggPCAyIHx8IHRoaXMubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQgPD0gbXVsdGlMaW5lSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RXZlbnRzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuaXNTaGF2ZSA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgY2hhckh0bWw6IHN0cmluZyA9IHRoaXMuY2hhcmFjdGVyO1xyXG4gICAgICAgIGNoYXJIdG1sID0gY2hhckh0bWwuY29uY2F0KGZvbnRIdG1sKTtcclxuICAgICAgICAvLyDku6XkuIvkvb/nlKjkuozliIbnrpfms5XorqHnrpfmlofmnKzmiKrlj5bkvY3nva5cclxuICAgICAgICBsZXQgbWF4OiBudW1iZXIgPSB0aGlzLnRleHQubGVuZ3RoIC0gMTtcclxuICAgICAgICBsZXQgbWluOiBudW1iZXIgPSAwO1xyXG4gICAgICAgIGxldCBtaWRkbGU6IG51bWJlcjtcclxuICAgICAgICB3aGlsZSAobWluIDwgbWF4KSB7XHJcbiAgICAgICAgICAgIG1pZGRsZSA9IChtaW4gKyBtYXggKyAxKSAvIDI7XHJcbiAgICAgICAgICAgIHRoaXMubmF0aXZlRWxlbWVudC50ZXh0Q29udGVudCA9IHRoaXMudGV4dC5zbGljZSgwLCBtaWRkbGUpO1xyXG4gICAgICAgICAgICB0aGlzLm5hdGl2ZUVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCdiZWZvcmVlbmQnLCBjaGFySHRtbCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0ID4gbXVsdGlMaW5lSGVpZ2h0ICsgMSkge1xyXG4gICAgICAgICAgICAgICAgbWF4ID0gbWlkZGxlIC0gMTsgLy8g5oiq5Y+W55qE5YaF5a655bCRXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBtaW4gPSBtaWRkbGU7IC8vIOaIquWPlueahOWGheWuueWkmlxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubmF0aXZlRWxlbWVudC50ZXh0Q29udGVudCA9IHRoaXMudGV4dC5zbGljZSgwLCBtYXgpO1xyXG4gICAgICAgIHRoaXMubmF0aXZlRWxlbWVudC5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWVuZCcsIGNoYXJIdG1sKTtcclxuICAgICAgICB0aGlzLnNldEV2ZW50cygpO1xyXG4gICAgICAgIHRoaXMuaXNTaGF2ZSA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMudGV4dCA9IHRoaXMudGV4dENvbnRlbnQgfHwgdGhpcy5uYXRpdmVFbGVtZW50LmlubmVySFRNTDtcclxuICAgICAgICBpZiAoKGNoYW5nZXMubWF4TGluZSAmJiAhY2hhbmdlcy5tYXhMaW5lLmZpcnN0Q2hhbmdlKVxyXG4gICAgICAgICAgICB8fCAoY2hhbmdlcy50ZXh0Q29udGVudCAmJiAhY2hhbmdlcy50ZXh0Q29udGVudC5maXJzdENoYW5nZSkpIHtcclxuICAgICAgICAgICAgdGhpcy5zaGF2ZVRleHRGbigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaWNvbkZvY3VzYWJsZSAmJiBjaGFuZ2VzLmljb25EaXNhYmxlZCAmJiAhY2hhbmdlcy5pY29uRGlzYWJsZWQuZmlyc3RDaGFuZ2UpIHtcclxuICAgICAgICAgICAgY29uc3Qgc3BhbkVsZTogSFRNTEVsZW1lbnQgPSB0aGlzLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3Rvcignc3Bhblt0aU92ZXJmbG93RW5kaWNvbl0nKTtcclxuICAgICAgICAgICAgaWYgKHNwYW5FbGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIyLnNldEF0dHJpYnV0ZShzcGFuRWxlLCAndGFiaW5kZXgnLCB0aGlzLmljb25EaXNhYmxlZCA/ICctMScgOiAnMCcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gdGlw6YWN572uXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy50ZXh0ID0gdGhpcy50ZXh0Q29udGVudCB8fCB0aGlzLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MOyAvLyDop4blm77liJ3lp4vljJblrozmiJDlkI7ojrflj5blrr/kuLvlhYPntKDmlofmnKxcclxuICAgICAgICBpZiAoVGlCcm93c2VyLmlzSUUoKSkge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hhdmVUZXh0Rm4oKTsgLy8gSUXkuIvpnIDlu7bml7blpITnkIbvvIzlkKbliJnliJ3lp4vljJbojrflj5bliLAgb2Zmc2V0SGVpZ2h0IOWAvOS4juiwt+atjOacieW3ruW8glxyXG4gICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNoYXZlVGV4dEZuKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucmVuZGVyZXIyLmxpc3Rlbih0aGlzLm5hdGl2ZUVsZW1lbnQsICdtb3VzZWVudGVyJywgKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc1NoYXZlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRpcENvbnRlbnQgPSB0aGlzLnRpVGlwQ29udGVudCB8fCB0aGlzLnRleHQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudGlwSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRpcEluc3RhbmNlID0gdGhpcy50aXBTZXJ2aWNlLmNyZWF0ZSh0aGlzLm5hdGl2ZUVsZW1lbnQsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHRoaXMudGlUaXBQb3NpdGlvbiB8fCAncmlnaHQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhXaWR0aDogdGhpcy50aVRpcE1heFdpZHRoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyOiAnbW91c2UnXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50aXBJbnN0YW5jZS5zaG93KHRoaXMudGlwQ29udGVudCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGlwSW5zdGFuY2Uuc2hvdyh0aGlzLnRpcENvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlcjIubGlzdGVuKHRoaXMubmF0aXZlRWxlbWVudCwgJ21vdXNlbGVhdmUnLCAoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnRpcEluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRpcEluc3RhbmNlLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIOS/ruWkjVNTUumUmeivr++8mkVSUk9SIFJlZmVyZW5jZUVycm9yOiB3aW5kb3cgaXMgbm90IGRlZmluZWRcclxuICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyID0gdGhpcy5yZW5kZXJlcjIubGlzdGVuKHdpbmRvdywgJ3Jlc2l6ZScsIHRoaXMuc2hhdmVUZXh0Rm4pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJDb250ZW50Q2hlY2tlZCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIXRoaXMubmF0aXZlRWxlbWVudC5jaGlsZHJlbiB8fCB0aGlzLm5hdGl2ZUVsZW1lbnQuY2hpbGRyZW4ubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgICAvLyDop6Pnu5Hljp/mnInnm5HlkKxcclxuICAgICAgICBpZiAodGhpcy5saXN0ZW5GbnMpIHtcclxuICAgICAgICAgICAgdGhpcy5saXN0ZW5GbnMuZm9yRWFjaCgoZm46ICgpID0+IHZvaWQpID0+IGZuKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxpc3RlbkZucyA9IG5ldyBBcnJheTxhbnk+KCk7XHJcbiAgICAgICAgdGhpcy5saXN0ZW5GbnMucHVzaCh0aGlzLnJlbmRlcmVyMi5saXN0ZW4odGhpcy5uYXRpdmVFbGVtZW50LmNoaWxkcmVuWzBdLCAnY2xpY2snLCAoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaWNvbkNsaWNrLmVtaXQoKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaWNvbnRpcEluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmljb250aXBJbnN0YW5jZS5oaWRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgdGhpcy5saXN0ZW5GbnMucHVzaCh0aGlzLnJlbmRlcmVyMi5saXN0ZW4odGhpcy5uYXRpdmVFbGVtZW50LmNoaWxkcmVuWzBdLCAnbW91c2VlbnRlcicsICgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudGlwSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGlwSW5zdGFuY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaWNvbnRpcEluc3RhbmNlID0gdGhpcy50aXBTZXJ2aWNlLmNyZWF0ZSh0aGlzLm5hdGl2ZUVsZW1lbnQuY2hpbGRyZW5bMF0sIHtcclxuICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAndG9wJyxcclxuICAgICAgICAgICAgICAgIG1heFdpZHRoOiB0aGlzLnRpVGlwTWF4V2lkdGgsXHJcbiAgICAgICAgICAgICAgICB0cmlnZ2VyOiAnbW91c2UnXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmljb250aXBJbnN0YW5jZS5zaG93KHRoaXMuaWNvblRpcCk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHRoaXMubGlzdGVuRm5zLnB1c2godGhpcy5yZW5kZXJlcjIubGlzdGVuKHRoaXMubmF0aXZlRWxlbWVudC5jaGlsZHJlblswXSwgJ21vdXNlbGVhdmUnLCAoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnRpcEluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRpcEluc3RhbmNlLnNob3codGhpcy50aXBDb250ZW50KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5pY29udGlwSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaWNvbnRpcEluc3RhbmNlLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy53aW5kb3dSZXNpemVMaXN0ZW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmxpc3RlbkZucykge1xyXG4gICAgICAgICAgICB0aGlzLmxpc3RlbkZucy5mb3JFYWNoKChmbjogKCkgPT4gdm9pZCkgPT4gZm4oKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXRFdmVudHMoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuaWNvbkZvY3VzYWJsZSkge1xyXG4gICAgICAgICAgICBjb25zdCBjbGlja0ljb25FbGU6IEhUTUxFbGVtZW50ID0gdGhpcy5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NwYW5bdGlPdmVyZmxvd0VuZGljb25dJyk7XHJcbiAgICAgICAgICAgIGlmICghY2xpY2tJY29uRWxlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIyLmxpc3RlbihjbGlja0ljb25FbGUsICdtb3VzZWRvd24nLCAoKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlcjIuc2V0U3R5bGUoY2xpY2tJY29uRWxlLCAnb3V0bGluZScsICdub25lJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIyLmxpc3RlbihjbGlja0ljb25FbGUsICdibHVyJywgKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIyLnNldFN0eWxlKGNsaWNrSWNvbkVsZSwgJ291dGxpbmUnLCAnJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==