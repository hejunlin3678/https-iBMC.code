import { DefaultValueAccessor, NG_VALUE_ACCESSOR } from '@angular/forms';
import { Directive, ElementRef, forwardRef, Input, Renderer2, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { TiLocaleFormat } from '../../locale/TiLocaleModule';
import { Util } from '../../utils/Util';
/**
 * TiNumber 数字输入框指令
 *
 * 该指令主要作用于输入框上，限制只能输入数字。用户可以通过设置 数字保留精度、是否国际化 来设置数字显示格式
 *
 * 输入框处于焦点状态时，输入框中数字标准化显示。失去焦点时，根据用户配置是否支持国际化进行格式化显示
 *
 * 目前JS可以解析的范围是[-2^53, 2^53]，即16位数字。当超过16位整数时，此时数字范围已经超过JS解析方位，不能精确表示。
 *
 * <example-url>../tiny3demo/#/inputnumber/inputnumber-all</example-url>
 */
// The default ControlValueAccessor for writing a value and listening to changes on input elements.
// The accessor is used by the FormControlDirective, FormControlName, and NgModel directives.
export class TiInputNumberDirective extends DefaultValueAccessor {
    constructor(renderer, elementRef, document) {
        super(renderer, elementRef, true);
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.document = document;
        /**
         * 设置数据是否支持国际化显示，默认支持国际化
         */
        this.localeable = true;
        this.numberFormat = '1.0-3';
        this.oldInputValue = ''; // 没有千位分隔符的input中的值
        this.element = this.elementRef.nativeElement;
    }
    ngOnInit() {
        if (!TiLocaleFormat.isInvalidFormat(this.format)) {
            const precision = parseInt(this.format.slice(1), 10);
            // tslint:disable-next-line:prefer-template
            this.numberFormat = '1.' + precision + '-' + precision;
        }
    }
    // 检测当前值是否合法 如果合法 返回true；否则返回false.
    isValidInput(value) {
        const decimalSep = this.localeable ? TiLocaleFormat.getNumberSymbol('Decimal') : '.'; // 当前局点小数点的形式
        let regex; // regex是正则表达式，不明其类型，所以
        if (decimalSep === ',') {
            regex = /^\-{0,1}\d{0,},{0,1}\d{0,}$/;
        }
        else if (decimalSep === '.') {
            regex = /^\-{0,1}\d{0,}\.{0,1}\d{0,}$/;
        }
        return regex.test(value);
    }
    /**
     * 功能描述：当该值合法，直接返回. 如果不合法，则返回之前保存的有效值。
     * @memberOf TiInputNumberDirective
     */
    getCorrectValue(value) {
        if (!this.isValidInput(value)) {
            return this.oldInputValue;
        }
        return value;
    }
    // 根据精度和是否支持国际化，格式化数字
    formatValue(value) {
        if (Number.isNaN(value)) {
            return;
        }
        // https://angular.cn/api/common/DecimalPipe
        // digitsInfo: {minIntegerDigits}.{minFractionDigits}-{maxFractionDigits}
        // minIntegerDigits: 小数点前最小位数 默认为1
        // minFractionDigits: 小数点后最小位数 默认0
        // maxFractionDigits: 小数点后最大位数 默认3
        // tslint:disable-next-line:prefer-template
        const localeValue = TiLocaleFormat.formatNumber(value, this.numberFormat);
        if (this.localeable) {
            return this.document.activeElement === this.element ? TiLocaleFormat.deleteGroupSep(localeValue) : localeValue;
        }
        else { // 不支持国际化时，也可利用TiLocaleFormat.formatNumber精度处理能力
            return TiLocaleFormat.parseNumber(localeValue).toString();
        }
    }
    // 将国际化数字转换为标准化数字
    parseValue(value) {
        return this.localeable ? TiLocaleFormat.parseNumber(value) : parseFloat(value);
    }
    // 将国际化数字的千位分隔符去掉(输入框聚焦状态需要)
    deleteGroupSepValue(formatValue) {
        return this.localeable ? TiLocaleFormat.deleteGroupSep(formatValue) : formatValue;
    }
    /**
     * @ignore
     * 实现继承来自父类的方法
     * Sets the "value" property on the input element.
     * model->view
     */
    writeValue(value) {
        // writeValue()方法会执行两遍。第一遍为null, 第二遍为用户配置的数据。
        if (value === null) {
            return;
        }
        // 由于10.0.0及之前版本中开发者只能给ngModel传入空字符串时才能清空值，但是该组件ngModel应该是传入number类型，所以要清空时应该设置undefined。
        // 10.0.1版本开始进行纠正，为了兼容旧版本，设置空字符串时也能清空。
        if (value === undefined || value === '') {
            super.writeValue('');
            this.oldInputValue = '';
            this.oldModel = undefined;
            return;
        }
        let normalValue;
        if (Number.isNaN(parseFloat(value))) {
            if (this.oldModel === undefined) {
                super.writeValue('');
                this.oldInputValue = '';
            }
            else {
                const formatValue = this.formatValue(this.oldModel);
                super.writeValue(formatValue);
                this.oldInputValue = this.deleteGroupSepValue(formatValue);
            }
            normalValue = this.oldModel;
        }
        else {
            const formatValue = this.formatValue(value);
            super.writeValue(formatValue);
            this.oldInputValue = this.deleteGroupSepValue(formatValue);
            normalValue = this.parseValue(formatValue);
        }
        if (normalValue !== value) {
            if (Util.isUndefined(this.onChangeFn)) {
                // 在reactive-form中使用，初始化赋值调用writeValue时，
                // 此时registerOnChange还未被调用，onChangeFn还未被赋值，
                // 所以要使用setTimeout等onChangeFn被赋值后再调用
                setTimeout(() => {
                    this.changeModel(normalValue);
                }, 0);
            }
            else {
                this.changeModel(normalValue);
            }
        }
        else {
            this.oldModel = normalValue;
        }
    }
    /**
     * @ignore
     * Registers a function called when the control value changes
     * @param fn The callback function
     * 注册当控件接收到change事件之后，调用的函数fn
     * viewValue和model value值的同步
     */
    registerOnChange(fn) {
        this.onChangeFn = fn;
    }
    /**
     * @ignore
     * view -> model
     * 非法字符不能输入。如果是合法则更新，如果是非法，则设置为oldInputValue...
     */
    handleInput(value) {
        // IE9 cut delete backspace下支持这三种方式引起的改变。
        // text组件针对这三种方式做了兼容性处理，并且触发input事件
        // 所以 inputnumber无需再做兼容性处理
        this.parser(value);
    }
    parser(value) {
        const validationValue = this.getCorrectValue(value);
        if (!this.isValidInput(value)) {
            let cursorPos = this.element.selectionStart;
            const diff = value.length - validationValue.length;
            cursorPos = cursorPos - diff;
            this.renderer.setProperty(this.element, 'value', this.oldInputValue); // Sets the "value" property on the input element.
            this.element.setSelectionRange(cursorPos, cursorPos);
        }
        else {
            this.oldInputValue = validationValue;
            const parseValue = this.parseValue(validationValue);
            this.changeModel(Number.isNaN(parseValue) ? undefined : parseValue);
        }
    }
    /**
     * @ignore
     * 得到焦点数据标准化处理
     * @memberOf TiInputNumberDirective
     * renderer.setProperty: Implement this callback to set the value of a property of an element in the DOM.
     */
    focusFn() {
        if (this.element.value === '') {
            return;
        }
        // 为了得到各个浏览器下正确的光标位置，所以添加延时处理
        if (this.localeable) {
            setTimeout(() => {
                const start = this.element.selectionStart;
                const end = this.element.selectionEnd;
                if (end - start === this.element.value.length) {
                    this.renderer.setProperty(this.element, 'value', TiLocaleFormat.deleteGroupSep(this.element.value));
                    this.element.setSelectionRange(0, this.element.value.length);
                }
                else {
                    const groupSep = TiLocaleFormat.getNumberSymbol('Group');
                    const old = this.element.value;
                    const sub = old.substr(0, start);
                    const groupSepNum = sub.split(groupSep).length - 1;
                    this.renderer.setProperty(this.element, 'value', TiLocaleFormat.deleteGroupSep(this.element.value));
                    this.element.setSelectionRange(start - groupSepNum, start - groupSepNum);
                }
            }, 0);
        }
    }
    /**
     * @ignore
     * 失去焦点数字国际化处理
     * @memberOf TiInputNumberDirective
     */
    blurFn() {
        const value = this.parseValue(this.element.value);
        if (Number.isNaN(value)) {
            this.renderer.setProperty(this.element, 'value', '');
            this.oldInputValue = '';
            return;
        }
        const formatValue = this.formatValue(value);
        this.renderer.setProperty(this.element, 'value', formatValue);
        this.oldInputValue = this.deleteGroupSepValue(formatValue);
        const normalValue = this.parseValue(formatValue);
        if (value !== normalValue) {
            this.changeModel(normalValue);
        }
    }
    changeModel(model) {
        if (model !== this.oldModel) {
            this.onChangeFn(model);
            this.oldModel = model;
        }
    }
}
TiInputNumberDirective.decorators = [
    { type: Directive, args: [{
                // 指令元数据
                selector: '[tiNumber]',
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        // tslint:disable-next-line:no-forward-ref
                        useExisting: forwardRef(() => TiInputNumberDirective),
                        multi: true
                    }
                ],
                host: {
                    '(input)': 'handleInput($event.target.value)',
                    '(focus)': 'focusFn();',
                    '(blur)': 'blurFn()'
                }
            },] }
];
TiInputNumberDirective.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
TiInputNumberDirective.propDecorators = {
    localeable: [{ type: Input }],
    format: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlJbnB1dE51bWJlckRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9kaXJlY3RpdmVzL2lucHV0bnVtYmVyL1RpSW5wdXROdW1iZXJEaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLG9CQUFvQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekUsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDN0QsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDOzs7Ozs7Ozs7O0dBVUc7QUFrQkgsbUdBQW1HO0FBQ25HLDZGQUE2RjtBQUM3RixNQUFNLE9BQU8sc0JBQXVCLFNBQVEsb0JBQW9CO0lBZ0I1RCxZQUFvQixRQUFtQixFQUFVLFVBQXNCLEVBQTRCLFFBQVE7UUFDdkcsS0FBSyxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFEbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBNEIsYUFBUSxHQUFSLFFBQVEsQ0FBQTtRQWYzRzs7V0FFRztRQUNNLGVBQVUsR0FBWSxJQUFJLENBQUM7UUFPNUIsaUJBQVksR0FBVyxPQUFPLENBQUM7UUFDL0Isa0JBQWEsR0FBVyxFQUFFLENBQUMsQ0FBQyxtQkFBbUI7UUFNbkQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztJQUNqRCxDQUFDO0lBRUQsUUFBUTtRQUNKLElBQUksQ0FB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QVcsQ0FBQyxDQUFDO1NBQ2pDO0lBQ0wsQ0FBQztJQUVPLFdBQVcsQ0FBQyxLQUFhO1FBQzdCLElBQUksS0FBSyxLQUFLLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztTQUN6QjtJQUNMLENBQUM7OztZQXRQSixTQUFTLFNBQUU7Z0JBQ1IsUUFBUTtnQkFDUixRQUFRLEVBQUUsWUFBWTtnQkFDdEIsU0FBUyxFQUFFO29CQUNQO3dCQUNJLE9BQU8sRUFBRSxpQkFBaUI7d0JBQzFCLDBDQUEwQzt3QkFDMUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQzt3QkFDckQsS0FBSyxFQUFFLElBQUk7cUJBQ2Q7aUJBQ0o7Z0JBQ0QsSUFBSSxFQUFFO29CQUNGLFNBQVMsRUFBRSxrQ0FBa0M7b0JBQzdDLFNBQVMsRUFBRSxZQUFZO29CQUN2QixRQUFRLEVBQUUsVUFBVTtpQkFDdkI7YUFDSjs7O1lBaENrRCxTQUFTO1lBQXhDLFVBQVU7NENBbURnRCxNQUFNLFNBQUMsUUFBUTs7O3lCQVp4RixLQUFLO3FCQU1MLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEZWZhdWx0VmFsdWVBY2Nlc3NvciwgTkdfVkFMVUVfQUNDRVNTT1IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgZm9yd2FyZFJlZiwgSW5wdXQsIFJlbmRlcmVyMiwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuXHJcbmltcG9ydCB7IFRpTG9jYWxlRm9ybWF0IH0gZnJvbSAnLi4vLi4vbG9jYWxlL1RpTG9jYWxlTW9kdWxlJztcclxuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uLy4uL3V0aWxzL1V0aWwnO1xyXG4vKipcclxuICogVGlOdW1iZXIg5pWw5a2X6L6T5YWl5qGG5oyH5LukXHJcbiAqXHJcbiAqIOivpeaMh+S7pOS4u+imgeS9nOeUqOS6jui+k+WFpeahhuS4iu+8jOmZkOWItuWPquiDvei+k+WFpeaVsOWtl+OAgueUqOaIt+WPr+S7pemAmui/h+iuvue9riDmlbDlrZfkv53nlZnnsr7luqbjgIHmmK/lkKblm73pmYXljJYg5p2l6K6+572u5pWw5a2X5pi+56S65qC85byPXHJcbiAqXHJcbiAqIOi+k+WFpeahhuWkhOS6jueEpueCueeKtuaAgeaXtu+8jOi+k+WFpeahhuS4reaVsOWtl+agh+WHhuWMluaYvuekuuOAguWkseWOu+eEpueCueaXtu+8jOagueaNrueUqOaIt+mFjee9ruaYr+WQpuaUr+aMgeWbvemZheWMlui/m+ihjOagvOW8j+WMluaYvuekulxyXG4gKlxyXG4gKiDnm67liY1KU+WPr+S7peino+aekOeahOiMg+WbtOaYr1stMl41MywgMl41M13vvIzljbMxNuS9jeaVsOWtl+OAguW9k+i2hei/hzE25L2N5pW05pWw5pe277yM5q2k5pe25pWw5a2X6IyD5Zu05bey57uP6LaF6L+HSlPop6PmnpDmlrnkvY3vvIzkuI3og73nsr7noa7ooajnpLrjgIJcclxuICpcclxuICogPGV4YW1wbGUtdXJsPi4uL3RpbnkzZGVtby8jL2lucHV0bnVtYmVyL2lucHV0bnVtYmVyLWFsbDwvZXhhbXBsZS11cmw+XHJcbiAqL1xyXG5ARGlyZWN0aXZlICh7XHJcbiAgICAvLyDmjIfku6TlhYPmlbDmja5cclxuICAgIHNlbGVjdG9yOiAnW3RpTnVtYmVyXScsXHJcbiAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLFxyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZm9yd2FyZC1yZWZcclxuICAgICAgICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gVGlJbnB1dE51bWJlckRpcmVjdGl2ZSksXHJcbiAgICAgICAgICAgIG11bHRpOiB0cnVlXHJcbiAgICAgICAgfVxyXG4gICAgXSxcclxuICAgIGhvc3Q6IHtcclxuICAgICAgICAnKGlucHV0KSc6ICdoYW5kbGVJbnB1dCgkZXZlbnQudGFyZ2V0LnZhbHVlKScsXHJcbiAgICAgICAgJyhmb2N1cyknOiAnZm9jdXNGbigpOycsXHJcbiAgICAgICAgJyhibHVyKSc6ICdibHVyRm4oKSdcclxuICAgIH1cclxufSlcclxuLy8gVGhlIGRlZmF1bHQgQ29udHJvbFZhbHVlQWNjZXNzb3IgZm9yIHdyaXRpbmcgYSB2YWx1ZSBhbmQgbGlzdGVuaW5nIHRvIGNoYW5nZXMgb24gaW5wdXQgZWxlbWVudHMuXHJcbi8vIFRoZSBhY2Nlc3NvciBpcyB1c2VkIGJ5IHRoZSBGb3JtQ29udHJvbERpcmVjdGl2ZSwgRm9ybUNvbnRyb2xOYW1lLCBhbmQgTmdNb2RlbCBkaXJlY3RpdmVzLlxyXG5leHBvcnQgY2xhc3MgVGlJbnB1dE51bWJlckRpcmVjdGl2ZSBleHRlbmRzIERlZmF1bHRWYWx1ZUFjY2Vzc29yIHtcclxuICAgIC8qKlxyXG4gICAgICog6K6+572u5pWw5o2u5piv5ZCm5pSv5oyB5Zu96ZmF5YyW5pi+56S677yM6buY6K6k5pSv5oyB5Zu96ZmF5YyWXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGxvY2FsZWFibGU6IGJvb2xlYW4gPSB0cnVlO1xyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7mlbDlrZfnsr7luqbjgILkvb/nlKhuKyflsI/mlbDkv53nlZnkvY3mlbAn5b2i5byP6KGo56S677yM5L6L5aaC77yaJ240Jyzku6Pooajkv53nlZk05L2N5bCP5pWw44CCXHJcbiAgICAgKlxyXG4gICAgICog5LiN6K6+572u5pe277yM6IeqMTAuMC4x54mI5pys6LW35bCP5pWw54K55ZCO6buY6K6k5pyA5bCR5L+d55WZMOS9je+8jOacgOWkmuS/neeVmTPkvY3vvJsxMC4wLjDlj4rkuYvliY3niYjmnKzpu5jorqTkv53nlZkz5L2N44CCXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dCgpIGZvcm1hdDogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBudW1iZXJGb3JtYXQ6IHN0cmluZyA9ICcxLjAtMyc7XHJcbiAgICBwcml2YXRlIG9sZElucHV0VmFsdWU6IHN0cmluZyA9ICcnOyAvLyDmsqHmnInljYPkvY3liIbpmpTnrKbnmoRpbnB1dOS4reeahOWAvFxyXG4gICAgcHJpdmF0ZSBvbkNoYW5nZUZuOiAoXzogYW55KSA9PiB2b2lkO1xyXG4gICAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgcHJpdmF0ZSBvbGRNb2RlbDogbnVtYmVyO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQpIHtcclxuICAgICAgICBzdXBlcihyZW5kZXJlciwgZWxlbWVudFJlZiwgdHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5lbGVtZW50ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCFUaUxvY2FsZUZvcm1hdC5pc0ludmFsaWRGb3JtYXQodGhpcy5mb3JtYXQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByZWNpc2lvbjogbnVtYmVyID0gcGFyc2VJbnQodGhpcy5mb3JtYXQuc2xpY2UoMSksIDEwKTtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci10ZW1wbGF0ZVxyXG4gICAgICAgICAgICB0aGlzLm51bWJlckZvcm1hdCA9ICcxLicgKyBwcmVjaXNpb24gKyAnLScgKyBwcmVjaXNpb247XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOajgOa1i+W9k+WJjeWAvOaYr+WQpuWQiOazlSDlpoLmnpzlkIjms5Ug6L+U5ZuedHJ1Ze+8m+WQpuWImei/lOWbnmZhbHNlLlxyXG4gICAgcHJpdmF0ZSBpc1ZhbGlkSW5wdXQodmFsdWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IGRlY2ltYWxTZXA6IHN0cmluZyA9IHRoaXMubG9jYWxlYWJsZSA/IFRpTG9jYWxlRm9ybWF0LmdldE51bWJlclN5bWJvbCgnRGVjaW1hbCcpIDogJy4nOyAvLyDlvZPliY3lsYDngrnlsI/mlbDngrnnmoTlvaLlvI9cclxuICAgICAgICBsZXQgcmVnZXg6IGFueTsgLy8gcmVnZXjmmK/mraPliJnooajovr7lvI/vvIzkuI3mmI7lhbbnsbvlnovvvIzmiYDku6VcclxuICAgICAgICBpZiAoZGVjaW1hbFNlcCA9PT0gJywnKSB7XHJcbiAgICAgICAgICAgIHJlZ2V4ID0gL15cXC17MCwxfVxcZHswLH0sezAsMX1cXGR7MCx9JC87XHJcbiAgICAgICAgfSBlbHNlIGlmIChkZWNpbWFsU2VwID09PSAnLicpIHtcclxuICAgICAgICAgICAgcmVnZXggPSAvXlxcLXswLDF9XFxkezAsfVxcLnswLDF9XFxkezAsfSQvO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJlZ2V4LnRlc3QodmFsdWUpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDlip/og73mj4/ov7DvvJrlvZPor6XlgLzlkIjms5XvvIznm7TmjqXov5Tlm54uIOWmguaenOS4jeWQiOazle+8jOWImei/lOWbnuS5i+WJjeS/neWtmOeahOacieaViOWAvOOAglxyXG4gICAgICogQG1lbWJlck9mIFRpSW5wdXROdW1iZXJEaXJlY3RpdmVcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBnZXRDb3JyZWN0VmFsdWUodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzVmFsaWRJbnB1dCh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub2xkSW5wdXRWYWx1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuICAgIC8vIOagueaNrueyvuW6puWSjOaYr+WQpuaUr+aMgeWbvemZheWMlu+8jOagvOW8j+WMluaVsOWtl1xyXG4gICAgcHJpdmF0ZSAgZm9ybWF0VmFsdWUodmFsdWU6IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKE51bWJlci5pc05hTih2YWx1ZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBodHRwczovL2FuZ3VsYXIuY24vYXBpL2NvbW1vbi9EZWNpbWFsUGlwZVxyXG4gICAgICAgIC8vIGRpZ2l0c0luZm86IHttaW5JbnRlZ2VyRGlnaXRzfS57bWluRnJhY3Rpb25EaWdpdHN9LXttYXhGcmFjdGlvbkRpZ2l0c31cclxuICAgICAgICAvLyBtaW5JbnRlZ2VyRGlnaXRzOiDlsI/mlbDngrnliY3mnIDlsI/kvY3mlbAg6buY6K6k5Li6MVxyXG4gICAgICAgIC8vIG1pbkZyYWN0aW9uRGlnaXRzOiDlsI/mlbDngrnlkI7mnIDlsI/kvY3mlbAg6buY6K6kMFxyXG4gICAgICAgIC8vIG1heEZyYWN0aW9uRGlnaXRzOiDlsI/mlbDngrnlkI7mnIDlpKfkvY3mlbAg6buY6K6kM1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcmVmZXItdGVtcGxhdGVcclxuICAgICAgICBjb25zdCBsb2NhbGVWYWx1ZTogc3RyaW5nID0gVGlMb2NhbGVGb3JtYXQuZm9ybWF0TnVtYmVyKHZhbHVlLCB0aGlzLm51bWJlckZvcm1hdCk7XHJcbiAgICAgICAgaWYgKHRoaXMubG9jYWxlYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSB0aGlzLmVsZW1lbnQgPyBUaUxvY2FsZUZvcm1hdC5kZWxldGVHcm91cFNlcChsb2NhbGVWYWx1ZSkgOiBsb2NhbGVWYWx1ZTtcclxuICAgICAgICB9IGVsc2UgeyAvLyDkuI3mlK/mjIHlm73pmYXljJbml7bvvIzkuZ/lj6/liKnnlKhUaUxvY2FsZUZvcm1hdC5mb3JtYXROdW1iZXLnsr7luqblpITnkIbog73liptcclxuICAgICAgICAgICAgcmV0dXJuIFRpTG9jYWxlRm9ybWF0LnBhcnNlTnVtYmVyKGxvY2FsZVZhbHVlKS50b1N0cmluZygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIOWwhuWbvemZheWMluaVsOWtl+i9rOaNouS4uuagh+WHhuWMluaVsOWtl1xyXG4gICAgcHJpdmF0ZSBwYXJzZVZhbHVlKHZhbHVlOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsZWFibGUgPyBUaUxvY2FsZUZvcm1hdC5wYXJzZU51bWJlcih2YWx1ZSkgOiBwYXJzZUZsb2F0KHZhbHVlKTtcclxuICAgIH1cclxuICAgIC8vIOWwhuWbvemZheWMluaVsOWtl+eahOWNg+S9jeWIhumalOespuWOu+aOiSjovpPlhaXmoYbogZrnhKbnirbmgIHpnIDopoEpXHJcbiAgICBwcml2YXRlIGRlbGV0ZUdyb3VwU2VwVmFsdWUoZm9ybWF0VmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlYWJsZSA/IFRpTG9jYWxlRm9ybWF0LmRlbGV0ZUdyb3VwU2VwKGZvcm1hdFZhbHVlKSA6IGZvcm1hdFZhbHVlO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiDlrp7njrDnu6fmib/mnaXoh6rniLbnsbvnmoTmlrnms5VcclxuICAgICAqIFNldHMgdGhlIFwidmFsdWVcIiBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC5cclxuICAgICAqIG1vZGVsLT52aWV3XHJcbiAgICAgKi9cclxuICAgICB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICAvLyB3cml0ZVZhbHVlKCnmlrnms5XkvJrmiafooYzkuKTpgY3jgILnrKzkuIDpgY3kuLpudWxsLCDnrKzkuozpgY3kuLrnlKjmiLfphY3nva7nmoTmlbDmja7jgIJcclxuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g55Sx5LqOMTAuMC4w5Y+K5LmL5YmN54mI5pys5Lit5byA5Y+R6ICF5Y+q6IO957uZbmdNb2RlbOS8oOWFpeepuuWtl+espuS4suaXtuaJjeiDvea4heepuuWAvO+8jOS9huaYr+ivpee7hOS7tm5nTW9kZWzlupTor6XmmK/kvKDlhaVudW1iZXLnsbvlnovvvIzmiYDku6XopoHmuIXnqbrml7blupTor6Xorr7nva51bmRlZmluZWTjgIJcclxuICAgICAgICAvLyAxMC4wLjHniYjmnKzlvIDlp4vov5vooYznuqDmraPvvIzkuLrkuoblhbzlrrnml6fniYjmnKzvvIzorr7nva7nqbrlrZfnrKbkuLLml7bkuZ/og73muIXnqbrjgIJcclxuICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gJycpIHtcclxuICAgICAgICAgICAgc3VwZXIud3JpdGVWYWx1ZSgnJyk7XHJcbiAgICAgICAgICAgIHRoaXMub2xkSW5wdXRWYWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICB0aGlzLm9sZE1vZGVsID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbm9ybWFsVmFsdWU6IG51bWJlcjtcclxuICAgICAgICBpZiAoTnVtYmVyLmlzTmFOKHBhcnNlRmxvYXQodmFsdWUpKSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5vbGRNb2RlbCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBzdXBlci53cml0ZVZhbHVlKCcnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMub2xkSW5wdXRWYWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZm9ybWF0VmFsdWU6IHN0cmluZyA9IHRoaXMuZm9ybWF0VmFsdWUodGhpcy5vbGRNb2RlbCk7XHJcbiAgICAgICAgICAgICAgICBzdXBlci53cml0ZVZhbHVlKGZvcm1hdFZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMub2xkSW5wdXRWYWx1ZSA9IHRoaXMuZGVsZXRlR3JvdXBTZXBWYWx1ZShmb3JtYXRWYWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbm9ybWFsVmFsdWUgPSB0aGlzLm9sZE1vZGVsO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm1hdFZhbHVlOiBzdHJpbmcgPSB0aGlzLmZvcm1hdFZhbHVlKHZhbHVlKTtcclxuICAgICAgICAgICAgc3VwZXIud3JpdGVWYWx1ZShmb3JtYXRWYWx1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMub2xkSW5wdXRWYWx1ZSA9IHRoaXMuZGVsZXRlR3JvdXBTZXBWYWx1ZShmb3JtYXRWYWx1ZSk7XHJcbiAgICAgICAgICAgIG5vcm1hbFZhbHVlID0gdGhpcy5wYXJzZVZhbHVlKGZvcm1hdFZhbHVlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChub3JtYWxWYWx1ZSAhPT0gdmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKFV0aWwuaXNVbmRlZmluZWQodGhpcy5vbkNoYW5nZUZuKSkge1xyXG4gICAgICAgICAgICAgICAgLy8g5ZyocmVhY3RpdmUtZm9ybeS4reS9v+eUqO+8jOWIneWni+WMlui1i+WAvOiwg+eUqHdyaXRlVmFsdWXml7bvvIxcclxuICAgICAgICAgICAgICAgIC8vIOatpOaXtnJlZ2lzdGVyT25DaGFuZ2Xov5jmnKrooqvosIPnlKjvvIxvbkNoYW5nZUZu6L+Y5pyq6KKr6LWL5YC877yMXHJcbiAgICAgICAgICAgICAgICAvLyDmiYDku6XopoHkvb/nlKhzZXRUaW1lb3V0562Jb25DaGFuZ2VGbuiiq+i1i+WAvOWQjuWGjeiwg+eUqFxyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VNb2RlbChub3JtYWxWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlTW9kZWwobm9ybWFsVmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5vbGRNb2RlbCA9IG5vcm1hbFZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICogUmVnaXN0ZXJzIGEgZnVuY3Rpb24gY2FsbGVkIHdoZW4gdGhlIGNvbnRyb2wgdmFsdWUgY2hhbmdlc1xyXG4gICAgICogQHBhcmFtIGZuIFRoZSBjYWxsYmFjayBmdW5jdGlvblxyXG4gICAgICog5rOo5YaM5b2T5o6n5Lu25o6l5pS25YiwY2hhbmdl5LqL5Lu25LmL5ZCO77yM6LCD55So55qE5Ye95pWwZm5cclxuICAgICAqIHZpZXdWYWx1ZeWSjG1vZGVsIHZhbHVl5YC855qE5ZCM5q2lXHJcbiAgICAgKi9cclxuICAgIHJlZ2lzdGVyT25DaGFuZ2UoZm46ICh2YWx1ZTogYW55KSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5vbkNoYW5nZUZuID0gZm47XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKiB2aWV3IC0+IG1vZGVsXHJcbiAgICAgKiDpnZ7ms5XlrZfnrKbkuI3og73ovpPlhaXjgILlpoLmnpzmmK/lkIjms5XliJnmm7TmlrDvvIzlpoLmnpzmmK/pnZ7ms5XvvIzliJnorr7nva7kuLpvbGRJbnB1dFZhbHVlLi4uXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBoYW5kbGVJbnB1dCh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgLy8gSUU5IGN1dCBkZWxldGUgYmFja3NwYWNl5LiL5pSv5oyB6L+Z5LiJ56eN5pa55byP5byV6LW355qE5pS55Y+Y44CCXHJcbiAgICAgICAgLy8gdGV4dOe7hOS7tumSiOWvuei/meS4ieenjeaWueW8j+WBmuS6huWFvOWuueaAp+WkhOeQhu+8jOW5tuS4lOinpuWPkWlucHV05LqL5Lu2XHJcbiAgICAgICAgLy8g5omA5LulIGlucHV0bnVtYmVy5peg6ZyA5YaN5YGa5YW85a655oCn5aSE55CGXHJcbiAgICAgICAgdGhpcy5wYXJzZXIodmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcGFyc2VyKHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB2YWxpZGF0aW9uVmFsdWU6IHN0cmluZyA9IHRoaXMuZ2V0Q29ycmVjdFZhbHVlKHZhbHVlKTtcclxuICAgICAgICBpZiAoIXRoaXMuaXNWYWxpZElucHV0KHZhbHVlKSkge1xyXG4gICAgICAgICAgICBsZXQgY3Vyc29yUG9zOiBudW1iZXIgPSB0aGlzLmVsZW1lbnQuc2VsZWN0aW9uU3RhcnQ7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpZmY6IG51bWJlciA9IHZhbHVlLmxlbmd0aCAtIHZhbGlkYXRpb25WYWx1ZS5sZW5ndGg7XHJcbiAgICAgICAgICAgIGN1cnNvclBvcyA9IGN1cnNvclBvcyAtIGRpZmY7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50LCAndmFsdWUnLCB0aGlzLm9sZElucHV0VmFsdWUpOyAvLyBTZXRzIHRoZSBcInZhbHVlXCIgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuXHJcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRTZWxlY3Rpb25SYW5nZShjdXJzb3JQb3MsIGN1cnNvclBvcyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5vbGRJbnB1dFZhbHVlID0gdmFsaWRhdGlvblZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJzZVZhbHVlOiBudW1iZXIgPSB0aGlzLnBhcnNlVmFsdWUodmFsaWRhdGlvblZhbHVlKTtcclxuICAgICAgICAgICAgdGhpcy5jaGFuZ2VNb2RlbChOdW1iZXIuaXNOYU4ocGFyc2VWYWx1ZSkgPyB1bmRlZmluZWQgOnBhcnNlVmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOW+l+WIsOeEpueCueaVsOaNruagh+WHhuWMluWkhOeQhlxyXG4gICAgICogQG1lbWJlck9mIFRpSW5wdXROdW1iZXJEaXJlY3RpdmVcclxuICAgICAqIHJlbmRlcmVyLnNldFByb3BlcnR5OiBJbXBsZW1lbnQgdGhpcyBjYWxsYmFjayB0byBzZXQgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHkgb2YgYW4gZWxlbWVudCBpbiB0aGUgRE9NLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZm9jdXNGbigpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5lbGVtZW50LnZhbHVlID09PSAnJykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOS4uuS6huW+l+WIsOWQhOS4qua1j+iniOWZqOS4i+ato+ehrueahOWFieagh+S9jee9ru+8jOaJgOS7pea3u+WKoOW7tuaXtuWkhOeQhlxyXG4gICAgICAgIGlmICh0aGlzLmxvY2FsZWFibGUpIHtcclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFydDogbnVtYmVyID0gdGhpcy5lbGVtZW50LnNlbGVjdGlvblN0YXJ0O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZW5kOiBudW1iZXIgPSB0aGlzLmVsZW1lbnQuc2VsZWN0aW9uRW5kO1xyXG4gICAgICAgICAgICAgICAgaWYgKGVuZCAtIHN0YXJ0ID09PSB0aGlzLmVsZW1lbnQudmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmVsZW1lbnQsICd2YWx1ZScsIFRpTG9jYWxlRm9ybWF0LmRlbGV0ZUdyb3VwU2VwKHRoaXMuZWxlbWVudC52YWx1ZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRTZWxlY3Rpb25SYW5nZSgwLCB0aGlzLmVsZW1lbnQudmFsdWUubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBTZXA6IHN0cmluZyA9IFRpTG9jYWxlRm9ybWF0LmdldE51bWJlclN5bWJvbCgnR3JvdXAnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGQ6IHN0cmluZyA9IHRoaXMuZWxlbWVudC52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWI6IHN0cmluZyA9IG9sZC5zdWJzdHIoMCwgc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwU2VwTnVtOiBudW1iZXIgPSBzdWIuc3BsaXQoZ3JvdXBTZXApLmxlbmd0aCAtIDE7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50LCAndmFsdWUnLCBUaUxvY2FsZUZvcm1hdC5kZWxldGVHcm91cFNlcCh0aGlzLmVsZW1lbnQudmFsdWUpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0U2VsZWN0aW9uUmFuZ2Uoc3RhcnQgLSBncm91cFNlcE51bSwgc3RhcnQgLSBncm91cFNlcE51bSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOWkseWOu+eEpueCueaVsOWtl+WbvemZheWMluWkhOeQhlxyXG4gICAgICogQG1lbWJlck9mIFRpSW5wdXROdW1iZXJEaXJlY3RpdmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGJsdXJGbigpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB2YWx1ZTogbnVtYmVyID0gdGhpcy5wYXJzZVZhbHVlKHRoaXMuZWxlbWVudC52YWx1ZSk7XHJcbiAgICAgICAgaWYgKE51bWJlci5pc05hTih2YWx1ZSkpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmVsZW1lbnQsICd2YWx1ZScsICcnKTtcclxuICAgICAgICAgICAgdGhpcy5vbGRJbnB1dFZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZm9ybWF0VmFsdWU6IHN0cmluZyA9IHRoaXMuZm9ybWF0VmFsdWUodmFsdWUpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50LCAndmFsdWUnLCBmb3JtYXRWYWx1ZSk7XHJcbiAgICAgICAgdGhpcy5vbGRJbnB1dFZhbHVlID0gdGhpcy5kZWxldGVHcm91cFNlcFZhbHVlKGZvcm1hdFZhbHVlKTtcclxuICAgICAgICBjb25zdCBub3JtYWxWYWx1ZTogbnVtYmVyID0gdGhpcy5wYXJzZVZhbHVlKGZvcm1hdFZhbHVlKTtcclxuICAgICAgICBpZiAodmFsdWUgIT09IG5vcm1hbFZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlTW9kZWwobm9ybWFsVmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoYW5nZU1vZGVsKG1vZGVsOiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICBpZiAobW9kZWwgIT09IHRoaXMub2xkTW9kZWwpIHtcclxuICAgICAgICAgICAgdGhpcy5vbkNoYW5nZUZuKG1vZGVsKTtcclxuICAgICAgICAgICAgdGhpcy5vbGRNb2RlbCA9IG1vZGVsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=