import { Directive, ElementRef, forwardRef, Input, Renderer2 } from '@angular/core';
import { DefaultValueAccessor, NG_VALUE_ACCESSOR } from '@angular/forms';
import { TiBrowser, Util } from '../../utils/Util';
/**
 * TiMask 格式化数字指令
 *
 * 该指令主要用于输入框中，限制用户只能输入数字，可以通过设置tiMask属性接口设置其数字的格式：身份证，手机号码等形式输入。
 *
 * 输入框中呈现的是格式化后的数字，但是通过ngModel取得的值为纯数字的值，如输入框中呈现的值为'123 456 789'，通过ngModel取得的值为'123456789'
 *
 * <example-url>../tiny3demo/#/maskinput/maskinput-all</example-url>
 */
export class TiMaskDirective extends DefaultValueAccessor {
    constructor(renderer, elementRef) {
        // super中第三个参数是DefaultValueAccessor中对文本段落(例如中文)输入的处理的一个标志位,
        // 表示是否为非安卓系统，在PC端此参数为true。后续如果要处理移动端，则可能需要动态根据此参数对
        // 文本段落(例如中文)输入做处理。
        super(renderer, elementRef, true);
        this.renderer = renderer;
        this.elementRef = elementRef;
        /**
         * 设置其数字的格式：身份证，手机号码等形式输入，例如手机号格式：'000 0000 0000'，
         * 其中 '0' 代表数字。
         */
        this.format = '000 0000 0000';
        this.composing = false; // 是否正在拼写拼音
        this.element = this.elementRef.nativeElement;
    }
    // 获取在format范围内的有效字符串
    static getClearValue(value, format) {
        const formatNumLen = format.replace(/[^0]/g, '').length;
        let clearValue = value.replace(/\D/g, '');
        clearValue = clearValue.slice(0, formatNumLen);
        return clearValue;
    }
    static formatValue(value, format) {
        if (!value) {
            return '';
        }
        const clearValue = TiMaskDirective.getClearValue(value, format);
        const clearValueLen = clearValue.length; // value长度
        let valueCharPosOffset = 0; // value字符位置增量
        let valueCharPos; // 循环中的value字符位置
        let newValue = '';
        let formatChar;
        for (let i = 0, len = format.length; i < len; i++) {
            valueCharPos = i - valueCharPosOffset;
            if (valueCharPos >= clearValueLen) { // value内容循环完成情况下,不进行处理
                break;
            }
            formatChar = format[i];
            if (formatChar === TiMaskDirective.NUM_SIGN) { // format字符为数字情况下的处理
                newValue += clearValue[valueCharPos];
            }
            else {
                // format字符非数字情况下的处理,此时value字段中增加format字符
                valueCharPosOffset++;
                newValue += formatChar;
            }
        }
        return newValue;
    }
    // model => view
    /**
     * @ignore
     */
    writeValue(value) {
        // 使用ngModel时，初始赋值第一次传入的value为null
        if (value === null) {
            return;
        }
        // format modelValue
        const formatValue = TiMaskDirective.formatValue(value, this.format);
        // Write formatted modelValue to view
        super.writeValue(formatValue);
        // 格式化后也需要通知修改模型值
        this.modelValue = this.getAntiFormatValue(formatValue);
        if (this.modelValue !== value) {
            if (Util.isUndefined(this.onChangeFn)) {
                // 在reactive-form中使用，初始化赋值调用writeValue时，
                // 此时registerOnChange还未被调用，onChangeFn还未被赋值，
                // 所以要使用setTimeout等onChangeFn被赋值后再调用
                setTimeout(() => {
                    this.onChangeFn(this.modelValue);
                }, 0);
            }
            else {
                this.onChangeFn(this.modelValue);
            }
        }
    }
    /**
     * @ignore
     */
    registerOnChange(fn) { this.onChangeFn = fn; }
    /**
     * @ignore
     * view => model
     */
    handleInput(value) {
        if (!this.composing) {
            // 在parser()中对view值进行格式化处理，再重写view的值；
            this.parser(value);
        }
    }
    /**
     * @ignore
     * 中文输入之前(在输入拼音前)
     */
    handleCompositionStart() {
        // 在IE和FF下中文输入法下，输入拼音时不会触发input事件，
        // 但是在Chrome下，输入拼音时会触发input事件，所以针对Chrome要做特殊处理，
        // 使其在输入拼音时不做格式化处理
        if (TiBrowser.isChrome()) {
            this.composing = true;
        }
    }
    /**
     * @ignore
     * 文本段完成输入或取消输入
     */
    handleCompositionEnd(value) {
        if (TiBrowser.isChrome()) {
            this.composing = false;
            // 在Chrome下compositionend比input执行滞后，
            this.parser(value);
        }
    }
    /**
     * @ignore
     */
    blur() {
        // 此处的onTouched继承于DefaultValueAccessor
        this.onTouched();
    }
    parser(value) {
        const formattedValue = TiMaskDirective.formatValue(value, this.format);
        this.setCtxPos(value, this.format);
        const ctxPos = this.ctxPos;
        // 设置viewValue及光标位置
        if (value !== formattedValue) {
            this.renderer.setProperty(this.element, 'value', formattedValue);
            // 设置光标位置：value非法及输入数字后需要变换位置情况下，需要设置光标位置
            if (this.element === document.activeElement) {
                this.element.setSelectionRange(ctxPos, ctxPos);
            }
        }
        const modelValue = this.getAntiFormatValue(formattedValue);
        if (modelValue !== this.modelValue) {
            this.onChangeFn(modelValue);
            this.modelValue = modelValue;
        }
    }
    // 获取反格式化后的value
    getAntiFormatValue(formattedValue) {
        return formattedValue.replace(/\D/g, '');
    }
    setCtxPos(value, format) {
        // 元素有光标情况下，设置元素光标位置
        this.initCtxPos();
        if (!value) {
            return;
        }
        // value非空情况下的处理
        this.valueCharPosOffset = 0; // value字符位置增量
        const ctxPos = this.ctxPos; // 初始化ctxPos，后续循环中会以此为光标位置作为对比值
        for (let i = 0, len = format.length; i < len; i++) {
            if (i - this.valueCharPosOffset >= value.length) { // value字符循环完成情况下,不进行后续处理
                break;
            }
            this.setCharPos(i, value, format, ctxPos);
        }
    }
    setCharPos(pos, value, format, ctxPos) {
        const valueCharPos = pos - this.valueCharPosOffset; // 循环中的value字符位置
        const valueChar = value[valueCharPos]; // 当前value字符
        const formatChar = format[pos]; // 当前format字符
        if (formatChar === TiMaskDirective.NUM_SIGN) { // format为数字情况下的处理
            this.setPosWithNum(value, valueChar, valueCharPos, ctxPos);
        }
        else { // format非数字情况处理
            this.setPosWithoutNum(valueChar, valueCharPos, formatChar, ctxPos);
        }
    }
    setPosWithNum(value, valueChar, valueCharPos, ctxPos) {
        if (valueChar.match(/\d/)) { // value字符相匹配情况下,不做处理
            return;
        }
        // value字符不匹配情况下,光标前移，直到找到下一个数字为止
        let valueCharNew;
        for (let j = valueCharPos, valueLen = value.length; j < valueLen; j++) {
            valueCharNew = value[j];
            if (valueCharNew.match(/\d/)) { // 找到value字符为数字的情况下，结束循环
                return;
            }
            // 找到value字符非数字情况下，过滤掉该字符，光标前移，value偏移量后移，下次循环跳过该字符的检索
            if (ctxPos && ctxPos >= j + 1) {
                this.ctxPos--;
            }
            this.valueCharPosOffset--;
        }
    }
    setPosWithoutNum(valueChar, valueCharPos, formatChar, ctxPos) {
        // value为数字情况下,value偏移量前移,确保下次循环依然为该value字符
        if (valueChar.match(/\d/)) {
            this.valueCharPosOffset++;
            if (ctxPos && ctxPos >= valueCharPos + 1) {
                this.ctxPos++;
            }
            return;
        }
        // value非数字且不匹配format字符情况下,过滤掉该字符,下次继续循环下个value字符
        if ((valueChar !== formatChar) &&
            (ctxPos && ctxPos >= valueCharPos + 1)) {
            this.ctxPos--;
        }
    }
    initCtxPos() {
        let ctxPositon;
        if (this.element === document.activeElement) {
            ctxPositon = this.element.selectionStart;
        }
        this.ctxPos = ctxPositon;
    }
}
TiMaskDirective.NUM_SIGN = '0';
TiMaskDirective.decorators = [
    { type: Directive, args: [{
                selector: '[tiMask]',
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        // tslint:disable-next-line:no-forward-ref
                        useExisting: forwardRef(() => TiMaskDirective),
                        multi: true
                    }
                ],
                host: {
                    '(input)': 'handleInput($event.target.value)',
                    '(compositionstart)': 'handleCompositionStart()',
                    '(compositionend)': 'handleCompositionEnd($event.target.value)',
                    '(blur)': 'blur()'
                }
            },] }
];
TiMaskDirective.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef }
];
TiMaskDirective.propDecorators = {
    format: [{ type: Input, args: ['tiMask',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlNYXNrRGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL2RpcmVjdGl2ZXMvbWFza2lucHV0L1RpTWFza0RpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixVQUFVLEVBQ1YsS0FBSyxFQUNMLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ25EOzs7Ozs7OztHQVFHO0FBa0JILE1BQU0sT0FBTyxlQUFnQixTQUFRLG9CQUFvQjtJQWFyRCxZQUFvQixRQUFtQixFQUFVLFVBQXNCO1FBQy9ELDJEQUEyRDtRQUMzRCxtREFBbUQ7UUFDbkQsbUJBQW1CO1FBQ25CLEtBQUssQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSnRCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBWHZFOzs7V0FHRztRQUNjLFdBQU0sR0FBVyxlQUFlLENBQUM7UUFJMUMsY0FBUyxHQUFZLEtBQUssQ0FBQyxDQUFDLFdBQVc7UUFRdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztJQUNyRCxDQUFDO0lBRUQscUJBQXFCO0lBQ2IsTUFBTSxDQUFDLGFBQWEsQ0FBQyxLQUFVLEVBQUUsTUFBYztRQUNuRCxNQUFNLFlBQVksR0FBVyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDaEUsSUFBSSxVQUFVLEdBQVEsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDL0MsVUFBVSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRS9DLE9BQU8sVUFBVSxDQUFDO0lBQ3RCLENBQUM7SUFFTyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQVUsRUFBRSxNQUFjO1FBQ2pELElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDUixPQUFPLEVBQUUsQ0FBQztTQUNiO1FBQ0QsTUFBTSxVQUFVLEdBQVEsZUFBZSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDckUsTUFBTSxhQUFhLEdBQVcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVU7UUFDM0QsSUFBSSxrQkFBa0IsR0FBVyxDQUFDLENBQUMsQ0FBQyxjQUFjO1FBQ2xELElBQUksWUFBb0IsQ0FBQyxDQUFDLGdCQUFnQjtRQUMxQyxJQUFJLFFBQVEsR0FBUSxFQUFFLENBQUM7UUFDdkIsSUFBSSxVQUFrQixDQUFDO1FBQ3ZCLEtBQUssSUFBSSxDQUFDLEdBQVcsQ0FBQyxFQUFFLEdBQUcsR0FBVyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0QsWUFBWSxHQUFHLENBQUMsR0FBRyxrQkFBa0IsQ0FBQztZQUN0QyxJQUFJLFlBQVksSUFBSSxhQUFhLEVBQUUsRUFBRSx1QkFBdUI7Z0JBQ3hELE1BQU07YUFDVDtZQUNELFVBQVUsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsSUFBSSxVQUFVLEtBQUssZUFBZSxDQUFDLFFBQVEsRUFBRSxFQUFFLG9CQUFvQjtnQkFDL0QsUUFBUSxJQUFJLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUN4QztpQkFBTTtnQkFDSCx5Q0FBeUM7Z0JBQ3pDLGtCQUFrQixFQUFFLENBQUM7Z0JBQ3JCLFFBQVEsSUFBSSxVQUFVLENBQUM7YUFDMUI7U0FDSjtRQUVELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxnQkFBZ0I7SUFDaEI7O09BRUc7SUFDSCxVQUFVLENBQUMsS0FBVTtRQUNqQixrQ0FBa0M7UUFDbEMsSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFO1lBQ2hCLE9BQU87U0FDVjtRQUNELG9CQUFvQjtRQUNwQixNQUFNLFdBQVcsR0FBUSxlQUFlLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekUscUNBQXFDO1FBQ3JDLEtBQUssQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDOUIsaUJBQWlCO1FBQ2pCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3ZELElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxLQUFLLEVBQUU7WUFDM0IsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRTtnQkFDbkMsd0NBQXdDO2dCQUN4QywyQ0FBMkM7Z0JBQzNDLG9DQUFvQztnQkFDcEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtvQkFDWixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDckMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ1Q7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDcEM7U0FDSjtJQUNMLENBQUM7SUFDRDs7T0FFRztJQUNILGdCQUFnQixDQUFDLEVBQXdCLElBQVUsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRTFFOzs7T0FHRztJQUNJLFdBQVcsQ0FBQyxLQUFVO1FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2pCLHFDQUFxQztZQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3RCO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNJLHNCQUFzQjtRQUN6QixrQ0FBa0M7UUFDbEMsK0NBQStDO1FBQy9DLGtCQUFrQjtRQUNsQixJQUFJLFNBQVMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUN0QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztTQUN6QjtJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSSxvQkFBb0IsQ0FBQyxLQUFVO1FBQ2xDLElBQUksU0FBUyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1lBQ3ZCLG9DQUFvQztZQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3JCO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ksSUFBSTtRQUNQLHNDQUFzQztRQUN0QyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVPLE1BQU0sQ0FBQyxLQUFVO1FBQ3JCLE1BQU0sY0FBYyxHQUFRLGVBQWUsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1RSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkMsTUFBTSxNQUFNLEdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUVuQyxtQkFBbUI7UUFDbkIsSUFBSSxLQUFLLEtBQUssY0FBYyxFQUFFO1lBQzFCLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBQ2pFLHlDQUF5QztZQUN6QyxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssUUFBUSxDQUFDLGFBQWEsRUFBRTtnQkFDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDbEQ7U0FDSjtRQUNELE1BQU0sVUFBVSxHQUFRLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNoRSxJQUFJLFVBQVUsS0FBSyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2hDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7U0FDaEM7SUFDTCxDQUFDO0lBRUQsZ0JBQWdCO0lBQ1Isa0JBQWtCLENBQUMsY0FBbUI7UUFDMUMsT0FBTyxjQUFjLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRU8sU0FBUyxDQUFDLEtBQVUsRUFBRSxNQUFjO1FBQ3hDLG9CQUFvQjtRQUNwQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFbEIsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNSLE9BQU87U0FDVjtRQUVELGdCQUFnQjtRQUNoQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDLENBQUMsY0FBYztRQUMzQyxNQUFNLE1BQU0sR0FBVyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsK0JBQStCO1FBQ25FLEtBQUssSUFBSSxDQUFDLEdBQVcsQ0FBQyxFQUFFLEdBQUcsR0FBVyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0QsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSx5QkFBeUI7Z0JBQ3hFLE1BQU07YUFDVDtZQUNELElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDN0M7SUFDTCxDQUFDO0lBRU8sVUFBVSxDQUFDLEdBQVcsRUFBRSxLQUFVLEVBQUUsTUFBYyxFQUFFLE1BQWM7UUFDdEUsTUFBTSxZQUFZLEdBQVcsR0FBRyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLGdCQUFnQjtRQUM1RSxNQUFNLFNBQVMsR0FBUSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZO1FBQ3hELE1BQU0sVUFBVSxHQUFXLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLGFBQWE7UUFDckQsSUFBSSxVQUFVLEtBQUssZUFBZSxDQUFDLFFBQVEsRUFBRSxFQUFFLGtCQUFrQjtZQUM3RCxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQzlEO2FBQU0sRUFBRSxnQkFBZ0I7WUFDckIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3RFO0lBQ0wsQ0FBQztJQUVPLGFBQWEsQ0FBQyxLQUFVLEVBQUUsU0FBYyxFQUFFLFlBQW9CLEVBQUUsTUFBYztRQUNsRixJQUFJLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxxQkFBcUI7WUFDOUMsT0FBTztTQUNWO1FBRUQsaUNBQWlDO1FBQ2pDLElBQUksWUFBaUIsQ0FBQztRQUN0QixLQUFLLElBQUksQ0FBQyxHQUFXLFlBQVksRUFBRSxRQUFRLEdBQVcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ25GLFlBQVksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsd0JBQXdCO2dCQUNwRCxPQUFPO2FBQ1Y7WUFFRCxzREFBc0Q7WUFDdEQsSUFBSSxNQUFNLElBQUksTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzNCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUNqQjtZQUNELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1NBQzdCO0lBQ0wsQ0FBQztJQUVPLGdCQUFnQixDQUFDLFNBQWMsRUFBRSxZQUFvQixFQUFFLFVBQWtCLEVBQUUsTUFBYztRQUM3RiwyQ0FBMkM7UUFDM0MsSUFBSSxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQzFCLElBQUksTUFBTSxJQUFJLE1BQU0sSUFBSSxZQUFZLEdBQUcsQ0FBQyxFQUFFO2dCQUN0QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDakI7WUFFRCxPQUFPO1NBQ1Y7UUFFRCxpREFBaUQ7UUFDakQsSUFBSSxDQUFDLFNBQVMsS0FBSyxVQUFVLENBQUM7WUFDMUIsQ0FBQyxNQUFNLElBQUksTUFBTSxJQUFJLFlBQVksR0FBRyxDQUFDLENBQUMsRUFBRTtZQUN4QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDakI7SUFDTCxDQUFDO0lBRU8sVUFBVTtRQUNkLElBQUksVUFBa0IsQ0FBQztRQUN2QixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssUUFBUSxDQUFDLGFBQWEsRUFBRTtZQUN6QyxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7U0FDNUM7UUFDRCxJQUFJLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQztJQUM3QixDQUFDOztBQTFPdUIsd0JBQVEsR0FBVyxHQUFHLENBQUM7O1lBbEJsRCxTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLFVBQVU7Z0JBQ3BCLFNBQVMsRUFBRTtvQkFDUDt3QkFDSSxPQUFPLEVBQUUsaUJBQWlCO3dCQUMxQiwwQ0FBMEM7d0JBQzFDLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsZUFBZSxDQUFDO3dCQUM5QyxLQUFLLEVBQUUsSUFBSTtxQkFDZDtpQkFDSjtnQkFDRCxJQUFJLEVBQUU7b0JBQ0YsU0FBUyxFQUFFLGtDQUFrQztvQkFDN0Msb0JBQW9CLEVBQUUsMEJBQTBCO29CQUNoRCxrQkFBa0IsRUFBRSwyQ0FBMkM7b0JBQy9ELFFBQVEsRUFBRSxRQUFRO2lCQUNyQjthQUNKOzs7WUE3QkMsU0FBUztZQUhULFVBQVU7OztxQkF1Q1AsS0FBSyxTQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBFbGVtZW50UmVmLFxyXG4gIGZvcndhcmRSZWYsXHJcbiAgSW5wdXQsXHJcbiAgUmVuZGVyZXIyXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERlZmF1bHRWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgVGlCcm93c2VyLCBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbHMvVXRpbCc7XHJcbi8qKlxyXG4gKiBUaU1hc2sg5qC85byP5YyW5pWw5a2X5oyH5LukXHJcbiAqXHJcbiAqIOivpeaMh+S7pOS4u+imgeeUqOS6jui+k+WFpeahhuS4re+8jOmZkOWItueUqOaIt+WPquiDvei+k+WFpeaVsOWtl++8jOWPr+S7pemAmui/h+iuvue9rnRpTWFza+WxnuaAp+aOpeWPo+iuvue9ruWFtuaVsOWtl+eahOagvOW8j++8mui6q+S7veivge+8jOaJi+acuuWPt+eggeetieW9ouW8j+i+k+WFpeOAglxyXG4gKlxyXG4gKiDovpPlhaXmoYbkuK3lkYjnjrDnmoTmmK/moLzlvI/ljJblkI7nmoTmlbDlrZfvvIzkvYbmmK/pgJrov4duZ01vZGVs5Y+W5b6X55qE5YC85Li657qv5pWw5a2X55qE5YC877yM5aaC6L6T5YWl5qGG5Lit5ZGI546w55qE5YC85Li6JzEyMyA0NTYgNzg5J++8jOmAmui/h25nTW9kZWzlj5blvpfnmoTlgLzkuLonMTIzNDU2Nzg5J1xyXG4gKlxyXG4gKiA8ZXhhbXBsZS11cmw+Li4vdGlueTNkZW1vLyMvbWFza2lucHV0L21hc2tpbnB1dC1hbGw8L2V4YW1wbGUtdXJsPlxyXG4gKi9cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1t0aU1hc2tdJyxcclxuICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgIHsvLyBNQVNLX0lOUFVUX1ZBTFVFX0FDQ0VTU09SLCDljp/mnKzmmK/lpJbpg6jlj5jph4/miJbogIVzdGF0aWPlj5jph4/vvIxsaWLnvJbor5HkuI3pgJrov4dcclxuICAgICAgICAgICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mb3J3YXJkLXJlZlxyXG4gICAgICAgICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBUaU1hc2tEaXJlY3RpdmUpLFxyXG4gICAgICAgICAgICBtdWx0aTogdHJ1ZVxyXG4gICAgICAgIH1cclxuICAgIF0sXHJcbiAgICBob3N0OiB7XHJcbiAgICAgICAgJyhpbnB1dCknOiAnaGFuZGxlSW5wdXQoJGV2ZW50LnRhcmdldC52YWx1ZSknLFxyXG4gICAgICAgICcoY29tcG9zaXRpb25zdGFydCknOiAnaGFuZGxlQ29tcG9zaXRpb25TdGFydCgpJyxcclxuICAgICAgICAnKGNvbXBvc2l0aW9uZW5kKSc6ICdoYW5kbGVDb21wb3NpdGlvbkVuZCgkZXZlbnQudGFyZ2V0LnZhbHVlKScsXHJcbiAgICAgICAgJyhibHVyKSc6ICdibHVyKCknXHJcbiAgICB9XHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUaU1hc2tEaXJlY3RpdmUgZXh0ZW5kcyBEZWZhdWx0VmFsdWVBY2Nlc3NvciAge1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgTlVNX1NJR046IHN0cmluZyA9ICcwJztcclxuICAgIC8qKlxyXG4gICAgICog6K6+572u5YW25pWw5a2X55qE5qC85byP77ya6Lqr5Lu96K+B77yM5omL5py65Y+356CB562J5b2i5byP6L6T5YWl77yM5L6L5aaC5omL5py65Y+35qC85byP77yaJzAwMCAwMDAwIDAwMDAn77yMXHJcbiAgICAgKiDlhbbkuK0gJzAnIOS7o+ihqOaVsOWtl+OAglxyXG4gICAgICovXHJcbiAgICBASW5wdXQoJ3RpTWFzaycpIGZvcm1hdDogc3RyaW5nID0gJzAwMCAwMDAwIDAwMDAnO1xyXG4gICAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgcHJpdmF0ZSBjdHhQb3M6IGFueTtcclxuICAgIHByaXZhdGUgdmFsdWVDaGFyUG9zT2Zmc2V0OiBhbnk7XHJcbiAgICBwcml2YXRlIGNvbXBvc2luZzogYm9vbGVhbiA9IGZhbHNlOyAvLyDmmK/lkKbmraPlnKjmi7zlhpnmi7zpn7NcclxuICAgIHByaXZhdGUgb25DaGFuZ2VGbjogRnVuY3Rpb247IC8vIOmcgOimgeWcqHJlZ2lzdGVyT25DaGFuZ2XkuK3ms6jlhozvvIznlKjkuo7mlLnlj5jmqKHlnovlgLzml7bosIPnlKhcclxuICAgIHByaXZhdGUgbW9kZWxWYWx1ZTogYW55O1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYpIHtcclxuICAgICAgICAgICAgLy8gc3VwZXLkuK3nrKzkuInkuKrlj4LmlbDmmK9EZWZhdWx0VmFsdWVBY2Nlc3NvcuS4reWvueaWh+acrOauteiQvSjkvovlpoLkuK3mlocp6L6T5YWl55qE5aSE55CG55qE5LiA5Liq5qCH5b+X5L2NLFxyXG4gICAgICAgICAgICAvLyDooajnpLrmmK/lkKbkuLrpnZ7lronljZPns7vnu5/vvIzlnKhQQ+err+atpOWPguaVsOS4unRydWXjgILlkI7nu63lpoLmnpzopoHlpITnkIbnp7vliqjnq6/vvIzliJnlj6/og73pnIDopoHliqjmgIHmoLnmja7mraTlj4LmlbDlr7lcclxuICAgICAgICAgICAgLy8g5paH5pys5q616JC9KOS+i+WmguS4reaWhynovpPlhaXlgZrlpITnkIbjgIJcclxuICAgICAgICAgICAgc3VwZXIocmVuZGVyZXIsIGVsZW1lbnRSZWYsIHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5blnKhmb3JtYXTojIPlm7TlhoXnmoTmnInmlYjlrZfnrKbkuLJcclxuICAgIHByaXZhdGUgc3RhdGljIGdldENsZWFyVmFsdWUodmFsdWU6IGFueSwgZm9ybWF0OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBmb3JtYXROdW1MZW46IG51bWJlciA9IGZvcm1hdC5yZXBsYWNlKC9bXjBdL2csICcnKS5sZW5ndGg7XHJcbiAgICAgICAgbGV0IGNsZWFyVmFsdWU6IGFueSA9IHZhbHVlLnJlcGxhY2UoL1xcRC9nLCAnJyk7XHJcbiAgICAgICAgY2xlYXJWYWx1ZSA9IGNsZWFyVmFsdWUuc2xpY2UoMCwgZm9ybWF0TnVtTGVuKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGNsZWFyVmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZm9ybWF0VmFsdWUodmFsdWU6IGFueSwgZm9ybWF0OiBzdHJpbmcpOiBhbnkge1xyXG4gICAgICAgIGlmICghdmFsdWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjbGVhclZhbHVlOiBhbnkgPSBUaU1hc2tEaXJlY3RpdmUuZ2V0Q2xlYXJWYWx1ZSh2YWx1ZSwgZm9ybWF0KTtcclxuICAgICAgICBjb25zdCBjbGVhclZhbHVlTGVuOiBudW1iZXIgPSBjbGVhclZhbHVlLmxlbmd0aDsgLy8gdmFsdWXplb/luqZcclxuICAgICAgICBsZXQgdmFsdWVDaGFyUG9zT2Zmc2V0OiBudW1iZXIgPSAwOyAvLyB2YWx1ZeWtl+espuS9jee9ruWinumHj1xyXG4gICAgICAgIGxldCB2YWx1ZUNoYXJQb3M6IG51bWJlcjsgLy8g5b6q546v5Lit55qEdmFsdWXlrZfnrKbkvY3nva5cclxuICAgICAgICBsZXQgbmV3VmFsdWU6IGFueSA9ICcnO1xyXG4gICAgICAgIGxldCBmb3JtYXRDaGFyOiBzdHJpbmc7XHJcbiAgICAgICAgZm9yIChsZXQgaTogbnVtYmVyID0gMCwgbGVuOiBudW1iZXIgPSBmb3JtYXQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgdmFsdWVDaGFyUG9zID0gaSAtIHZhbHVlQ2hhclBvc09mZnNldDtcclxuICAgICAgICAgICAgaWYgKHZhbHVlQ2hhclBvcyA+PSBjbGVhclZhbHVlTGVuKSB7IC8vIHZhbHVl5YaF5a655b6q546v5a6M5oiQ5oOF5Ya15LiLLOS4jei/m+ihjOWkhOeQhlxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9ybWF0Q2hhciA9IGZvcm1hdFtpXTtcclxuICAgICAgICAgICAgaWYgKGZvcm1hdENoYXIgPT09IFRpTWFza0RpcmVjdGl2ZS5OVU1fU0lHTikgeyAvLyBmb3JtYXTlrZfnrKbkuLrmlbDlrZfmg4XlhrXkuIvnmoTlpITnkIZcclxuICAgICAgICAgICAgICAgIG5ld1ZhbHVlICs9IGNsZWFyVmFsdWVbdmFsdWVDaGFyUG9zXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIGZvcm1hdOWtl+espumdnuaVsOWtl+aDheWGteS4i+eahOWkhOeQhizmraTml7Z2YWx1ZeWtl+auteS4reWinuWKoGZvcm1hdOWtl+esplxyXG4gICAgICAgICAgICAgICAgdmFsdWVDaGFyUG9zT2Zmc2V0Kys7XHJcbiAgICAgICAgICAgICAgICBuZXdWYWx1ZSArPSBmb3JtYXRDaGFyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3VmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbW9kZWwgPT4gdmlld1xyXG4gICAgLyoqXHJcbiAgICAgKiBAaWdub3JlXHJcbiAgICAgKi9cclxuICAgIHdyaXRlVmFsdWUodmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIC8vIOS9v+eUqG5nTW9kZWzml7bvvIzliJ3lp4votYvlgLznrKzkuIDmrKHkvKDlhaXnmoR2YWx1ZeS4um51bGxcclxuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBmb3JtYXQgbW9kZWxWYWx1ZVxyXG4gICAgICAgIGNvbnN0IGZvcm1hdFZhbHVlOiBhbnkgPSBUaU1hc2tEaXJlY3RpdmUuZm9ybWF0VmFsdWUodmFsdWUsIHRoaXMuZm9ybWF0KTtcclxuICAgICAgICAvLyBXcml0ZSBmb3JtYXR0ZWQgbW9kZWxWYWx1ZSB0byB2aWV3XHJcbiAgICAgICAgc3VwZXIud3JpdGVWYWx1ZShmb3JtYXRWYWx1ZSk7XHJcbiAgICAgICAgLy8g5qC85byP5YyW5ZCO5Lmf6ZyA6KaB6YCa55+l5L+u5pS55qih5Z6L5YC8XHJcbiAgICAgICAgdGhpcy5tb2RlbFZhbHVlID0gdGhpcy5nZXRBbnRpRm9ybWF0VmFsdWUoZm9ybWF0VmFsdWUpO1xyXG4gICAgICAgIGlmICh0aGlzLm1vZGVsVmFsdWUgIT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmIChVdGlsLmlzVW5kZWZpbmVkKHRoaXMub25DaGFuZ2VGbikpIHtcclxuICAgICAgICAgICAgICAgIC8vIOWcqHJlYWN0aXZlLWZvcm3kuK3kvb/nlKjvvIzliJ3lp4vljJbotYvlgLzosIPnlKh3cml0ZVZhbHVl5pe277yMXHJcbiAgICAgICAgICAgICAgICAvLyDmraTml7ZyZWdpc3Rlck9uQ2hhbmdl6L+Y5pyq6KKr6LCD55So77yMb25DaGFuZ2VGbui/mOacquiiq+i1i+WAvO+8jFxyXG4gICAgICAgICAgICAgICAgLy8g5omA5Lul6KaB5L2/55Soc2V0VGltZW91dOetiW9uQ2hhbmdlRm7ooqvotYvlgLzlkI7lho3osIPnlKhcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2VGbih0aGlzLm1vZGVsVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfSwgMCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ2hhbmdlRm4odGhpcy5tb2RlbFZhbHVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAodmFsdWU6IGFueSkgPT4gdm9pZCk6IHZvaWQgeyB0aGlzLm9uQ2hhbmdlRm4gPSBmbjsgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICogdmlldyA9PiBtb2RlbFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaGFuZGxlSW5wdXQodmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5jb21wb3NpbmcpIHtcclxuICAgICAgICAgICAgLy8g5ZyocGFyc2VyKCnkuK3lr7l2aWV35YC86L+b6KGM5qC85byP5YyW5aSE55CG77yM5YaN6YeN5YaZdmlld+eahOWAvO+8m1xyXG4gICAgICAgICAgICB0aGlzLnBhcnNlcih2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICog5Lit5paH6L6T5YWl5LmL5YmNKOWcqOi+k+WFpeaLvOmfs+WJjSlcclxuICAgICAqL1xyXG4gICAgcHVibGljIGhhbmRsZUNvbXBvc2l0aW9uU3RhcnQoKTogdm9pZCB7XHJcbiAgICAgICAgLy8g5ZyoSUXlkoxGRuS4i+S4reaWh+i+k+WFpeazleS4i++8jOi+k+WFpeaLvOmfs+aXtuS4jeS8muinpuWPkWlucHV05LqL5Lu277yMXHJcbiAgICAgICAgLy8g5L2G5piv5ZyoQ2hyb21l5LiL77yM6L6T5YWl5ou86Z+z5pe25Lya6Kem5Y+RaW5wdXTkuovku7bvvIzmiYDku6Xpkojlr7lDaHJvbWXopoHlgZrnibnmrorlpITnkIbvvIxcclxuICAgICAgICAvLyDkvb/lhbblnKjovpPlhaXmi7zpn7Pml7bkuI3lgZrmoLzlvI/ljJblpITnkIZcclxuICAgICAgICBpZiAoVGlCcm93c2VyLmlzQ2hyb21lKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5jb21wb3NpbmcgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqIOaWh+acrOauteWujOaIkOi+k+WFpeaIluWPlua2iOi+k+WFpVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaGFuZGxlQ29tcG9zaXRpb25FbmQodmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChUaUJyb3dzZXIuaXNDaHJvbWUoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbXBvc2luZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAvLyDlnKhDaHJvbWXkuItjb21wb3NpdGlvbmVuZOavlGlucHV05omn6KGM5rue5ZCO77yMXHJcbiAgICAgICAgICAgdGhpcy5wYXJzZXIodmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBpZ25vcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGJsdXIoKTogdm9pZCB7XHJcbiAgICAgICAgLy8g5q2k5aSE55qEb25Ub3VjaGVk57un5om/5LqORGVmYXVsdFZhbHVlQWNjZXNzb3JcclxuICAgICAgICB0aGlzLm9uVG91Y2hlZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcGFyc2VyKHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBmb3JtYXR0ZWRWYWx1ZTogYW55ID0gVGlNYXNrRGlyZWN0aXZlLmZvcm1hdFZhbHVlKHZhbHVlLCB0aGlzLmZvcm1hdCk7XHJcbiAgICAgICAgdGhpcy5zZXRDdHhQb3ModmFsdWUsIHRoaXMuZm9ybWF0KTtcclxuICAgICAgICBjb25zdCBjdHhQb3M6IG51bWJlciA9IHRoaXMuY3R4UG9zO1xyXG5cclxuICAgICAgICAvLyDorr7nva52aWV3VmFsdWXlj4rlhYnmoIfkvY3nva5cclxuICAgICAgICBpZiAodmFsdWUgIT09IGZvcm1hdHRlZFZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50LCAndmFsdWUnLCBmb3JtYXR0ZWRWYWx1ZSk7XHJcbiAgICAgICAgICAgIC8vIOiuvue9ruWFieagh+S9jee9ru+8mnZhbHVl6Z2e5rOV5Y+K6L6T5YWl5pWw5a2X5ZCO6ZyA6KaB5Y+Y5o2i5L2N572u5oOF5Ya15LiL77yM6ZyA6KaB6K6+572u5YWJ5qCH5L2N572uXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnQgPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRTZWxlY3Rpb25SYW5nZShjdHhQb3MsIGN0eFBvcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbW9kZWxWYWx1ZTogYW55ID0gdGhpcy5nZXRBbnRpRm9ybWF0VmFsdWUoZm9ybWF0dGVkVmFsdWUpO1xyXG4gICAgICAgIGlmIChtb2RlbFZhbHVlICE9PSB0aGlzLm1vZGVsVmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5vbkNoYW5nZUZuKG1vZGVsVmFsdWUpO1xyXG4gICAgICAgICAgICB0aGlzLm1vZGVsVmFsdWUgPSBtb2RlbFZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5blj43moLzlvI/ljJblkI7nmoR2YWx1ZVxyXG4gICAgcHJpdmF0ZSBnZXRBbnRpRm9ybWF0VmFsdWUoZm9ybWF0dGVkVmFsdWU6IGFueSk6IGFueSB7XHJcbiAgICAgICAgcmV0dXJuIGZvcm1hdHRlZFZhbHVlLnJlcGxhY2UoL1xcRC9nLCAnJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRDdHhQb3ModmFsdWU6IGFueSwgZm9ybWF0OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICAvLyDlhYPntKDmnInlhYnmoIfmg4XlhrXkuIvvvIzorr7nva7lhYPntKDlhYnmoIfkvY3nva5cclxuICAgICAgICB0aGlzLmluaXRDdHhQb3MoKTtcclxuXHJcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB2YWx1ZemdnuepuuaDheWGteS4i+eahOWkhOeQhlxyXG4gICAgICAgIHRoaXMudmFsdWVDaGFyUG9zT2Zmc2V0ID0gMDsgLy8gdmFsdWXlrZfnrKbkvY3nva7lop7ph49cclxuICAgICAgICBjb25zdCBjdHhQb3M6IG51bWJlciA9IHRoaXMuY3R4UG9zOyAvLyDliJ3lp4vljJZjdHhQb3PvvIzlkI7nu63lvqrnjq/kuK3kvJrku6XmraTkuLrlhYnmoIfkvY3nva7kvZzkuLrlr7nmr5TlgLxcclxuICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSAwLCBsZW46IG51bWJlciA9IGZvcm1hdC5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xyXG4gICAgICAgICAgICBpZiAoaSAtIHRoaXMudmFsdWVDaGFyUG9zT2Zmc2V0ID49IHZhbHVlLmxlbmd0aCkgeyAvLyB2YWx1ZeWtl+espuW+queOr+WujOaIkOaDheWGteS4iyzkuI3ov5vooYzlkI7nu63lpITnkIZcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0Q2hhclBvcyhpLCB2YWx1ZSwgZm9ybWF0LCBjdHhQb3MpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldENoYXJQb3MocG9zOiBudW1iZXIsIHZhbHVlOiBhbnksIGZvcm1hdDogc3RyaW5nLCBjdHhQb3M6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlQ2hhclBvczogbnVtYmVyID0gcG9zIC0gdGhpcy52YWx1ZUNoYXJQb3NPZmZzZXQ7IC8vIOW+queOr+S4reeahHZhbHVl5a2X56ym5L2N572uXHJcbiAgICAgICAgY29uc3QgdmFsdWVDaGFyOiBhbnkgPSB2YWx1ZVt2YWx1ZUNoYXJQb3NdOyAvLyDlvZPliY12YWx1ZeWtl+esplxyXG4gICAgICAgIGNvbnN0IGZvcm1hdENoYXI6IHN0cmluZyA9IGZvcm1hdFtwb3NdOyAvLyDlvZPliY1mb3JtYXTlrZfnrKZcclxuICAgICAgICBpZiAoZm9ybWF0Q2hhciA9PT0gVGlNYXNrRGlyZWN0aXZlLk5VTV9TSUdOKSB7IC8vIGZvcm1hdOS4uuaVsOWtl+aDheWGteS4i+eahOWkhOeQhlxyXG4gICAgICAgICAgICB0aGlzLnNldFBvc1dpdGhOdW0odmFsdWUsIHZhbHVlQ2hhciwgdmFsdWVDaGFyUG9zLCBjdHhQb3MpO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIGZvcm1hdOmdnuaVsOWtl+aDheWGteWkhOeQhlxyXG4gICAgICAgICAgICB0aGlzLnNldFBvc1dpdGhvdXROdW0odmFsdWVDaGFyLCB2YWx1ZUNoYXJQb3MsIGZvcm1hdENoYXIsIGN0eFBvcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0UG9zV2l0aE51bSh2YWx1ZTogYW55LCB2YWx1ZUNoYXI6IGFueSwgdmFsdWVDaGFyUG9zOiBudW1iZXIsIGN0eFBvczogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHZhbHVlQ2hhci5tYXRjaCgvXFxkLykpIHsgLy8gdmFsdWXlrZfnrKbnm7jljLnphY3mg4XlhrXkuIss5LiN5YGa5aSE55CGXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHZhbHVl5a2X56ym5LiN5Yy56YWN5oOF5Ya15LiLLOWFieagh+WJjeenu++8jOebtOWIsOaJvuWIsOS4i+S4gOS4quaVsOWtl+S4uuatolxyXG4gICAgICAgIGxldCB2YWx1ZUNoYXJOZXc6IGFueTtcclxuICAgICAgICBmb3IgKGxldCBqOiBudW1iZXIgPSB2YWx1ZUNoYXJQb3MsIHZhbHVlTGVuOiBudW1iZXIgPSB2YWx1ZS5sZW5ndGg7IGogPCB2YWx1ZUxlbjsgaisrKSB7XHJcbiAgICAgICAgICAgIHZhbHVlQ2hhck5ldyA9IHZhbHVlW2pdO1xyXG4gICAgICAgICAgICBpZiAodmFsdWVDaGFyTmV3Lm1hdGNoKC9cXGQvKSkgeyAvLyDmib7liLB2YWx1ZeWtl+espuS4uuaVsOWtl+eahOaDheWGteS4i++8jOe7k+adn+W+queOr1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyDmib7liLB2YWx1ZeWtl+espumdnuaVsOWtl+aDheWGteS4i++8jOi/h+a7pOaOieivpeWtl+espu+8jOWFieagh+WJjeenu++8jHZhbHVl5YGP56e76YeP5ZCO56e777yM5LiL5qyh5b6q546v6Lez6L+H6K+l5a2X56ym55qE5qOA57SiXHJcbiAgICAgICAgICAgIGlmIChjdHhQb3MgJiYgY3R4UG9zID49IGogKyAxKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN0eFBvcy0tO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudmFsdWVDaGFyUG9zT2Zmc2V0LS07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0UG9zV2l0aG91dE51bSh2YWx1ZUNoYXI6IGFueSwgdmFsdWVDaGFyUG9zOiBudW1iZXIsIGZvcm1hdENoYXI6IHN0cmluZywgY3R4UG9zOiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICAvLyB2YWx1ZeS4uuaVsOWtl+aDheWGteS4iyx2YWx1ZeWBj+enu+mHj+WJjeenuyznoa7kv53kuIvmrKHlvqrnjq/kvp3nhLbkuLror6V2YWx1ZeWtl+esplxyXG4gICAgICAgIGlmICh2YWx1ZUNoYXIubWF0Y2goL1xcZC8pKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmFsdWVDaGFyUG9zT2Zmc2V0Kys7XHJcbiAgICAgICAgICAgIGlmIChjdHhQb3MgJiYgY3R4UG9zID49IHZhbHVlQ2hhclBvcyArIDEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3R4UG9zKys7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHZhbHVl6Z2e5pWw5a2X5LiU5LiN5Yy56YWNZm9ybWF05a2X56ym5oOF5Ya15LiLLOi/h+a7pOaOieivpeWtl+espizkuIvmrKHnu6fnu63lvqrnjq/kuIvkuKp2YWx1ZeWtl+esplxyXG4gICAgICAgIGlmICgodmFsdWVDaGFyICE9PSBmb3JtYXRDaGFyKSAmJlxyXG4gICAgICAgICAgICAoY3R4UG9zICYmIGN0eFBvcyA+PSB2YWx1ZUNoYXJQb3MgKyAxKSkge1xyXG4gICAgICAgICAgICB0aGlzLmN0eFBvcy0tO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluaXRDdHhQb3MoKTogdm9pZCB7XHJcbiAgICAgICAgbGV0IGN0eFBvc2l0b246IG51bWJlcjtcclxuICAgICAgICBpZiAodGhpcy5lbGVtZW50ID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7XHJcbiAgICAgICAgICAgIGN0eFBvc2l0b24gPSB0aGlzLmVsZW1lbnQuc2VsZWN0aW9uU3RhcnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY3R4UG9zID0gY3R4UG9zaXRvbjtcclxuICAgIH1cclxufVxyXG4iXX0=