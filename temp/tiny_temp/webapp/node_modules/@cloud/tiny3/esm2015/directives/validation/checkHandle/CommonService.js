import { Injectable, Renderer2 } from '@angular/core';
import { TiLocale } from '../../../locale/TiLocaleModule';
import { TiRenderer } from '../../../services/renderer/TiRenderer';
import { TiPopupService } from '../../../services/popup/TiPopupService';
import { Util } from '../../../utils/Util';
import { TiTipService } from '../../../services/tip/TiTipService';
import { TiValidationDefaultConfig } from '../TiValidationConfig';
import { TiErrorMsgComponent } from '../TiErrorMsgComponent';
import { CommonServiceModule } from './CommonServiceModule';
import * as i0 from "@angular/core";
import * as i1 from "../../../services/renderer/TiRenderer";
import * as i2 from "../../../services/tip/TiTipService";
import * as i3 from "../../../services/popup/TiPopupService";
import * as i4 from "./CommonServiceModule";
/**
 * @ignore
 */
export class CommonService {
    constructor(_renderer, _tiRenderer, _tipService, _tiPopupService) {
        this._renderer = _renderer;
        this._tiRenderer = _tiRenderer;
        this._tipService = _tipService;
        this._tiPopupService = _tiPopupService;
    }
    // 获取错误信息源字串
    static _getSourceStr(ruleKey, ruleErrors, validationConf, isAsync) {
        // 优先使用tiValidation中的规则项配置errorMsg
        const errMsgConf = validationConf && validationConf.errorMessage;
        if (!Util.isUndefined(errMsgConf) && Util.isString(errMsgConf[ruleKey])) {
            return errMsgConf[ruleKey];
        }
        if (typeof ruleErrors === 'object') {
            // 获取自定义校验规则中的 tiErrorMsg
            if (!isAsync && Util.isString(ruleErrors.tiErrorMessage)) {
                return ruleErrors.tiErrorMessage;
            }
            // 获取自定义异步校验规则中的 tiAsyncErrorMessage
            if (isAsync && Util.isString(ruleErrors.tiAsyncErrorMessage)) {
                return ruleErrors.tiAsyncErrorMessage;
            }
        }
        // 获取到的tiValidation errorMsg无效情况下,使用默认规则提示
        return TiLocale.getLocaleWords().tiValid.errorMsg[ruleKey] || '';
    }
    // 获取错误提示字符串，思路是：
    // 1.先获取错误信息源字串（可能带params标识{0}/{1}等）;
    // 2.将获取的源字串中的参数替换为真实数据
    static _getErrorStr(errors, validationConf, isAsync) {
        const ruleKey = Object.keys(errors)[0];
        const ruleErrors = errors[ruleKey];
        const msgStr = CommonService._getSourceStr(ruleKey, ruleErrors, validationConf, isAsync);
        // 获取错误信息参数,无参数情况下,不需做格式匹配直接返回
        // errors格式示例：{required:true,{'maxlength': {'requiredLength': maxLength, 'actualLength': length}}}
        if ((typeof ruleErrors) !== 'object') {
            return msgStr;
        }
        const params = Object.values(ruleErrors); // 此处对错误信息定义有要求：要求错误返回对象与词条中的参数次序与一致
        return Util.formatEntry(msgStr, params);
    }
    isFocused(ele) {
        return ele.nativeElement.attributes.tiFocused !== undefined;
    }
    // 获取密码校验中校验规则信息
    getMsg(ruleKey, params) {
        const messageStr = TiLocale.getLocaleWords().tiValid.message[ruleKey];
        return Util.formatEntry(messageStr, params);
    }
    // 获取错误提示信息DOM文本，此处TiErrorMsgComponent组件处理的不仅是提示信息，还包括错误时的组件边框变红样式加载
    getErrorMsg(errors, validationConf, isAppendBody = false, isAsync) {
        const errorMsg = CommonService._getErrorStr(errors, validationConf, isAsync);
        if (!errorMsg) {
            return null;
        }
        const errorMsgComponentRef = this._tiPopupService.createCompoentRef({
            componentType: TiErrorMsgComponent,
            context: {
                errorMessage: errorMsg,
                isAppendBody
            }
        });
        return errorMsgComponentRef.location.nativeElement;
    }
    // 调用ti-Tip组件生成Tip提示,该公共方法中同时传递了tip的位置信息等
    generateTip(ele, tipContent, validationConf, context) {
        const tipInstance = this._tipService.create(ele.nativeElement, {
            position: validationConf.tipPosition || TiValidationDefaultConfig.tipPosition,
            maxWidth: validationConf.tipMaxWidth
        });
        tipInstance.show(tipContent, context);
        ele.nativeElement.tiValidTip = tipInstance;
        return tipInstance;
    }
    // 销毁Tip提示
    destroyTip(ele) {
        const tipEle = ele.nativeElement.tiValidTip;
        if (!Util.isUndefined(tipEle)) {
            tipEle.hide();
        }
    }
    // 根据errors结果生成可占位的错误提示信息(blurCheck和pwdCheck中使用)
    addValidMsg(ele, validationConf, formControl, isAsync) {
        const errors = formControl.control.errors;
        // 校验正确情况下不做处理
        if (errors === null) {
            return;
        }
        const errorDom = this.getErrorMsg(errors, validationConf, true, isAsync);
        if (errorDom === null || errorDom.childNodes.length === 0) {
            return;
        }
        // 添加错误信息
        if (validationConf && validationConf.errorMessageWrapper) {
            this._renderer.appendChild(validationConf.errorMessageWrapper, errorDom);
        }
        else if (ele.nativeElement.hasAttribute('tiTextarea')) {
            this._tiRenderer.insertAfter(errorDom, this._renderer.parentNode(ele.nativeElement));
        }
        else {
            this._tiRenderer.insertAfter(errorDom, ele.nativeElement);
        }
        ele.nativeElement.tiErrorMessage = errorDom;
    }
    // 销毁可占位的错误提示信息(blurCheck和pwdCheck中使用)
    clearValidMsg(ele) {
        const errMsgDom = ele.nativeElement.tiErrorMessage;
        if (!Util.isUndefined(errMsgDom)) {
            this._renderer.removeChild(errMsgDom.parentNode, errMsgDom);
        }
    }
}
CommonService.ɵprov = i0.ɵɵdefineInjectable({ factory: function CommonService_Factory() { return new CommonService(i0.ɵɵinject(i0.Renderer2), i0.ɵɵinject(i1.TiRenderer), i0.ɵɵinject(i2.TiTipService), i0.ɵɵinject(i3.TiPopupService)); }, token: CommonService, providedIn: i4.CommonServiceModule });
CommonService.decorators = [
    { type: Injectable, args: [{
                providedIn: CommonServiceModule
            },] }
];
CommonService.ctorParameters = () => [
    { type: Renderer2 },
    { type: TiRenderer },
    { type: TiTipService },
    { type: TiPopupService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tbW9uU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL0BjbG91ZC90aW55My9kaXJlY3RpdmVzL3ZhbGlkYXRpb24vY2hlY2tIYW5kbGUvQ29tbW9uU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQTRCLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEYsT0FBTyxFQUFFLFFBQVEsRUFBaUIsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN6RSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDbkUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFbEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFbEUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFHN0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7OztBQUU1RDs7R0FFRztBQUlILE1BQU0sT0FBTyxhQUFhO0lBQ3RCLFlBQW9CLFNBQW9CLEVBQ3BCLFdBQXVCLEVBQ3ZCLFdBQXlCLEVBQ3pCLGVBQW9EO1FBSHBELGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFDdkIsZ0JBQVcsR0FBWCxXQUFXLENBQWM7UUFDekIsb0JBQWUsR0FBZixlQUFlLENBQXFDO0lBQ3hFLENBQUM7SUFFRCxZQUFZO0lBQ0osTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFlLEVBQUUsVUFBZSxFQUFFLGNBQWtDLEVBQUUsT0FBZ0I7UUFDL0csa0NBQWtDO1FBQ2xDLE1BQU0sVUFBVSxHQUFRLGNBQWMs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QixFQUFFO1lBQ3RELElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUM1RTthQUFNLElBQUksR0FBRyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDckQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1NBQ3hGO2FBQU07WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsR0FBRyxDQUFDLGFBQWEsQ0FBQyxjQUFjLEdBQUcsUUFBUSxDQUFDO0lBQ2hELENBQUM7SUFDRCxzQ0FBc0M7SUFDL0IsYUFBYSxDQUFDLEdBQWU7UUFDaEMsTUFBTSxTQUFTLEdBQVMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUM7UUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUMvRDtJQUNMLENBQUM7Ozs7WUF6SEosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxtQkFBbUI7YUFDbEM7OztZQW5COEMsU0FBUztZQUUvQyxVQUFVO1lBR1YsWUFBWTtZQUZaLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYsIEVsZW1lbnRSZWYsIEluamVjdGFibGUsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUaUxvY2FsZSwgVGlMb2NhbGVXb3JkcyB9IGZyb20gJy4uLy4uLy4uL2xvY2FsZS9UaUxvY2FsZU1vZHVsZSc7XHJcbmltcG9ydCB7IFRpUmVuZGVyZXIgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9yZW5kZXJlci9UaVJlbmRlcmVyJztcclxuaW1wb3J0IHsgVGlQb3B1cFNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9wb3B1cC9UaVBvcHVwU2VydmljZSc7XHJcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi8uLi91dGlscy9VdGlsJztcclxuaW1wb3J0IHsgVGlUaXBTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvdGlwL1RpVGlwU2VydmljZSc7XHJcbmltcG9ydCB7IFRpVGlwUmVmIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvdGlwL1RpVGlwSW50ZXJmYWNlJztcclxuaW1wb3J0IHsgVGlWYWxpZGF0aW9uRGVmYXVsdENvbmZpZyB9IGZyb20gJy4uL1RpVmFsaWRhdGlvbkNvbmZpZyc7XHJcbmltcG9ydCB7IFRpVmFsaWRhdGlvbkNvbmZpZyB9IGZyb20gJy4uL1RpVmFsaWRhdGlvbkludGVyZmFjZSc7XHJcbmltcG9ydCB7IFRpRXJyb3JNc2dDb21wb25lbnQgfSBmcm9tICcuLi9UaUVycm9yTXNnQ29tcG9uZW50JztcclxuLyogdHNsaW50OmRpc2FibGU6bm8taW1wbGljaXQtZGVwZW5kZW5jaWVzICovXHJcbmltcG9ydCB7IE5nQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgQ29tbW9uU2VydmljZU1vZHVsZSB9IGZyb20gJy4vQ29tbW9uU2VydmljZU1vZHVsZSc7XHJcblxyXG4vKipcclxuICogQGlnbm9yZVxyXG4gKi9cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogQ29tbW9uU2VydmljZU1vZHVsZVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ29tbW9uU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9yZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBfdGlSZW5kZXJlcjogVGlSZW5kZXJlcixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgX3RpcFNlcnZpY2U6IFRpVGlwU2VydmljZSxcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgX3RpUG9wdXBTZXJ2aWNlOiBUaVBvcHVwU2VydmljZTxUaUVycm9yTXNnQ29tcG9uZW50Pikge1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOiOt+WPlumUmeivr+S/oeaBr+a6kOWtl+S4slxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldFNvdXJjZVN0cihydWxlS2V5OiBzdHJpbmcsIHJ1bGVFcnJvcnM6IGFueSwgdmFsaWRhdGlvbkNvbmY6IFRpVmFsaWRhdGlvbkNvbmZpZywgaXNBc3luYzogYm9vbGVhbik6IHN0cmluZyB7XHJcbiAgICAgICAgLy8g5LyY5YWI5L2/55SodGlWYWxpZGF0aW9u5Lit55qE6KeE5YiZ6aG56YWN572uZXJyb3JNc2dcclxuICAgICAgICBjb25zdCBlcnJNc2dDb25mOiBhbnkgPSB2YWxpZGF0aW9uQ29uZiAmJiB2YWxpZGF0aW9uQ29uZi5lcnJvck1lc3NhZ2U7XHJcbiAgICAgICAgaWYgKCFVdGlsLmlzVW5kZWZpbmVkKGVyck1zZ0NvbmYpICYmIFV0aWwuaXNTdHJpbmcoZXJyTXNnQ29uZltydWxlS2V5XSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGVyck1zZ0NvbmZbcnVsZUtleV07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZW9mIHJ1bGVFcnJvcnMgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIC8vIOiOt+WPluiHquWumuS5ieagoemqjOinhOWImeS4reeahCB0aUVycm9yTXNnXHJcbiAgICAgICAgICAgIGlmICghaXNBc3luYyAmJiBVdGlsLmlzU3RyaW5nKHJ1bGVFcnJvcnMudGlFcnJvck1lc3NhZ2UpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcnVsZUVycm9ycy50aUVycm9yTWVzc2FnZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g6I635Y+W6Ieq5a6a5LmJ5byC5q2l5qCh6aqM6KeE5YiZ5Lit55qEIHRpQXN5bmNFcnJvck1lc3NhZ2VcclxuICAgICAgICAgICAgaWYgKGlzQXN5bmMgJiYgVXRpbC5pc1N0cmluZyhydWxlRXJyb3JzLnRpQXN5bmNFcnJvck1lc3NhZ2UpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcnVsZUVycm9ycy50aUFzeW5jRXJyb3JNZXNzYWdlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDojrflj5bliLDnmoR0aVZhbGlkYXRpb24gZXJyb3JNc2fml6DmlYjmg4XlhrXkuIss5L2/55So6buY6K6k6KeE5YiZ5o+Q56S6XHJcbiAgICAgICAgcmV0dXJuIChUaUxvY2FsZS5nZXRMb2NhbGVXb3JkcygpIGFzIFRpTG9jYWxlV29yZHMpLnRpVmFsaWQuZXJyb3JNc2dbcnVsZUtleV0gfHwgJyc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W6ZSZ6K+v5o+Q56S65a2X56ym5Liy77yM5oCd6Lev5piv77yaXHJcbiAgICAvLyAxLuWFiOiOt+WPlumUmeivr+S/oeaBr+a6kOWtl+S4su+8iOWPr+iDveW4pnBhcmFtc+agh+ivhnswfS97MX3nrYnvvIk7XHJcbiAgICAvLyAyLuWwhuiOt+WPlueahOa6kOWtl+S4suS4reeahOWPguaVsOabv+aNouS4uuecn+WunuaVsOaNrlxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldEVycm9yU3RyKGVycm9yczogVmFsaWRhdGlvbkVycm9ycywgdmFsaWRhdGlvbkNvbmY6IFRpVmFsaWRhdGlvbkNvbmZpZywgaXNBc3luYzogYm9vbGVhbik6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgcnVsZUtleTogc3RyaW5nID0gT2JqZWN0LmtleXMoZXJyb3JzKVswXTtcclxuICAgICAgICBjb25zdCBydWxlRXJyb3JzOiBhbnkgPSBlcnJvcnNbcnVsZUtleV07XHJcbiAgICAgICAgY29uc3QgbXNnU3RyOiBzdHJpbmcgPSBDb21tb25TZXJ2aWNlLl9nZXRTb3VyY2VTdHIocnVsZUtleSwgcnVsZUVycm9ycywgdmFsaWRhdGlvbkNvbmYsIGlzQXN5bmMpO1xyXG4gICAgICAgIC8vIOiOt+WPlumUmeivr+S/oeaBr+WPguaVsCzml6Dlj4LmlbDmg4XlhrXkuIss5LiN6ZyA5YGa5qC85byP5Yy56YWN55u05o6l6L+U5ZueXHJcbiAgICAgICAgLy8gZXJyb3Jz5qC85byP56S65L6L77yae3JlcXVpcmVkOnRydWUseydtYXhsZW5ndGgnOiB7J3JlcXVpcmVkTGVuZ3RoJzogbWF4TGVuZ3RoLCAnYWN0dWFsTGVuZ3RoJzogbGVuZ3RofX19XHJcbiAgICAgICAgaWYgKCh0eXBlb2YgcnVsZUVycm9ycykgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBtc2dTdHI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBhcmFtczogQXJyYXk8c3RyaW5nPiA9IE9iamVjdC52YWx1ZXMocnVsZUVycm9ycyk7IC8vIOatpOWkhOWvuemUmeivr+S/oeaBr+WumuS5ieacieimgeaxgu+8muimgeaxgumUmeivr+i/lOWbnuWvueixoeS4juivjeadoeS4reeahOWPguaVsOasoeW6j+S4juS4gOiHtFxyXG5cclxuICAgICAgICByZXR1cm4gVXRpbC5mb3JtYXRFbnRyeShtc2dTdHIsIHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgaXNGb2N1c2VkKGVsZTogYW55KTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGVsZS5uYXRpdmVFbGVtZW50LmF0dHJpYnV0ZXMudGlGb2N1c2VkICE9PSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICAvLyDojrflj5blr4bnoIHmoKHpqozkuK3moKHpqozop4TliJnkv6Hmga9cclxuICAgIHB1YmxpYyBnZXRNc2cocnVsZUtleTogc3RyaW5nLCBwYXJhbXM6IGFueSk6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgbWVzc2FnZVN0cjogc3RyaW5nID0gKFRpTG9jYWxlLmdldExvY2FsZVdvcmRzKCkgYXMgVGlMb2NhbGVXb3JkcykudGlWYWxpZC5tZXNzYWdlW3J1bGVLZXldO1xyXG5cclxuICAgICAgICByZXR1cm4gVXRpbC5mb3JtYXRFbnRyeShtZXNzYWdlU3RyLCBwYXJhbXMpO1xyXG4gICAgfVxyXG4gICAgLy8g6I635Y+W6ZSZ6K+v5o+Q56S65L+h5oGvRE9N5paH5pys77yM5q2k5aSEVGlFcnJvck1zZ0NvbXBvbmVudOe7hOS7tuWkhOeQhueahOS4jeS7heaYr+aPkOekuuS/oeaBr++8jOi/mOWMheaLrOmUmeivr+aXtueahOe7hOS7tui+ueahhuWPmOe6ouagt+W8j+WKoOi9vVxyXG4gICAgcHVibGljIGdldEVycm9yTXNnKGVycm9yczogVmFsaWRhdGlvbkVycm9ycywgdmFsaWRhdGlvbkNvbmY6IFRpVmFsaWRhdGlvbkNvbmZpZywgaXNBcHBlbmRCb2R5OiBib29sZWFuID0gZmFsc2UsIGlzQXN5bmM/OiBib29sZWFuKTogRWxlbWVudCB7XHJcbiAgICAgICAgY29uc3QgZXJyb3JNc2c6IHN0cmluZyA9IENvbW1vblNlcnZpY2UuX2dldEVycm9yU3RyKGVycm9ycywgdmFsaWRhdGlvbkNvbmYsIGlzQXN5bmMpO1xyXG4gICAgICAgIGlmICghZXJyb3JNc2cpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGVycm9yTXNnQ29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8YW55PiA9IHRoaXMuX3RpUG9wdXBTZXJ2aWNlLmNyZWF0ZUNvbXBvZW50UmVmKHtcclxuICAgICAgICAgICAgY29tcG9uZW50VHlwZTogVGlFcnJvck1zZ0NvbXBvbmVudCxcclxuICAgICAgICAgICAgY29udGV4dDoge1xyXG4gICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvck1zZyxcclxuICAgICAgICAgICAgICAgIGlzQXBwZW5kQm9keVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBlcnJvck1zZ0NvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOiwg+eUqHRpLVRpcOe7hOS7tueUn+aIkFRpcOaPkOekuizor6XlhazlhbHmlrnms5XkuK3lkIzml7bkvKDpgJLkuoZ0aXDnmoTkvY3nva7kv6Hmga/nrYlcclxuICAgIHB1YmxpYyBnZW5lcmF0ZVRpcChlbGU6IEVsZW1lbnRSZWYsIHRpcENvbnRlbnQ6IHN0cmluZywgdmFsaWRhdGlvbkNvbmY6IFRpVmFsaWRhdGlvbkNvbmZpZywgY29udGV4dD86IGFueSk6IFRpVGlwUmVmIHtcclxuICAgICAgICBjb25zdCB0aXBJbnN0YW5jZTogVGlUaXBSZWYgPSB0aGlzLl90aXBTZXJ2aWNlLmNyZWF0ZShlbGUubmF0aXZlRWxlbWVudCwge1xyXG4gICAgICAgICAgICBwb3NpdGlvbjogdmFsaWRhdGlvbkNvbmYudGlwUG9zaXRpb24gfHwgVGlWYWxpZGF0aW9uRGVmYXVsdENvbmZpZy50aXBQb3NpdGlvbixcclxuICAgICAgICAgICAgbWF4V2lkdGg6IHZhbGlkYXRpb25Db25mLnRpcE1heFdpZHRoXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGlwSW5zdGFuY2Uuc2hvdyh0aXBDb250ZW50LCBjb250ZXh0KTtcclxuICAgICAgICBlbGUubmF0aXZlRWxlbWVudC50aVZhbGlkVGlwID0gdGlwSW5zdGFuY2U7XHJcblxyXG4gICAgICAgIHJldHVybiB0aXBJbnN0YW5jZTtcclxuICAgIH1cclxuICAgIC8vIOmUgOavgVRpcOaPkOekulxyXG4gICAgcHVibGljIGRlc3Ryb3lUaXAoZWxlOiBFbGVtZW50UmVmKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgdGlwRWxlOiBUaVRpcFJlZiA9IGVsZS5uYXRpdmVFbGVtZW50LnRpVmFsaWRUaXA7XHJcbiAgICAgICAgaWYgKCFVdGlsLmlzVW5kZWZpbmVkKHRpcEVsZSkpIHtcclxuICAgICAgICAgICAgdGlwRWxlLmhpZGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyDmoLnmja5lcnJvcnPnu5PmnpznlJ/miJDlj6/ljaDkvY3nmoTplJnor6/mj5DnpLrkv6Hmga8oYmx1ckNoZWNr5ZKMcHdkQ2hlY2vkuK3kvb/nlKgpXHJcbiAgICBwdWJsaWMgYWRkVmFsaWRNc2coZWxlOiBFbGVtZW50UmVmLCB2YWxpZGF0aW9uQ29uZjogVGlWYWxpZGF0aW9uQ29uZmlnLCBmb3JtQ29udHJvbDogTmdDb250cm9sLCBpc0FzeW5jPzogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGVycm9yczogVmFsaWRhdGlvbkVycm9ycyA9IGZvcm1Db250cm9sLmNvbnRyb2wuZXJyb3JzO1xyXG4gICAgICAgIC8vIOagoemqjOato+ehruaDheWGteS4i+S4jeWBmuWkhOeQhlxyXG4gICAgICAgIGlmIChlcnJvcnMgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBlcnJvckRvbTogRWxlbWVudCA9IHRoaXMuZ2V0RXJyb3JNc2coZXJyb3JzLCB2YWxpZGF0aW9uQ29uZiwgdHJ1ZSwgaXNBc3luYyk7XHJcbiAgICAgICAgaWYgKGVycm9yRG9tID09PSBudWxsIHx8IGVycm9yRG9tLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5re75Yqg6ZSZ6K+v5L+h5oGvXHJcbiAgICAgICAgaWYgKHZhbGlkYXRpb25Db25mICYmIHZhbGlkYXRpb25Db25mLmVycm9yTWVzc2FnZVdyYXBwZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIuYXBwZW5kQ2hpbGQodmFsaWRhdGlvbkNvbmYuZXJyb3JNZXNzYWdlV3JhcHBlciwgZXJyb3JEb20pO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZWxlLm5hdGl2ZUVsZW1lbnQuaGFzQXR0cmlidXRlKCd0aVRleHRhcmVhJykpIHtcclxuICAgICAgICAgICAgdGhpcy5fdGlSZW5kZXJlci5pbnNlcnRBZnRlcihlcnJvckRvbSwgdGhpcy5fcmVuZGVyZXIucGFyZW50Tm9kZShlbGUubmF0aXZlRWxlbWVudCkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3RpUmVuZGVyZXIuaW5zZXJ0QWZ0ZXIoZXJyb3JEb20sIGVsZS5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxlLm5hdGl2ZUVsZW1lbnQudGlFcnJvck1lc3NhZ2UgPSBlcnJvckRvbTtcclxuICAgIH1cclxuICAgIC8vIOmUgOavgeWPr+WNoOS9jeeahOmUmeivr+aPkOekuuS/oeaBryhibHVyQ2hlY2vlkoxwd2RDaGVja+S4reS9v+eUqClcclxuICAgIHB1YmxpYyBjbGVhclZhbGlkTXNnKGVsZTogRWxlbWVudFJlZik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGVyck1zZ0RvbTogYW55ICA9IGVsZS5uYXRpdmVFbGVtZW50LnRpRXJyb3JNZXNzYWdlO1xyXG4gICAgICAgIGlmICghVXRpbC5pc1VuZGVmaW5lZChlcnJNc2dEb20pKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNoaWxkKGVyck1zZ0RvbS5wYXJlbnROb2RlLCBlcnJNc2dEb20pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=