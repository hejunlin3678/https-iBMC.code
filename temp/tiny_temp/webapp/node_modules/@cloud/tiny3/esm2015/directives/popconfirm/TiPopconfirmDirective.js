import { Directive, ElementRef, Input, NgZone, Renderer2, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { TiTipService } from '../../services/tip/TiTipService';
import { TiTipDirective } from '../../directives/tip/TiTipDirective';
import { TiPopconfirmComponent } from './TiPopconfirmComponent';
import { Util, TiKeymap } from '../../utils/Util';
/**
 * TiPopconfirm 气泡确认框指令
 *
 * 一般用于操作执行后对用户业务不会有严重影响的轻量级场景。
 *
 * 10.0.3/9.0.7版本新增
 *
 * <example-url>../tiny3demo/#/popconfirm/popconfirm-all</example-url>
 */
export class TiPopconfirmDirective extends TiTipDirective {
    constructor(tiTipService, hostEleRef, zone, render, document) {
        super(tiTipService, hostEleRef);
        this.tiTipService = tiTipService;
        this.hostEleRef = hostEleRef;
        this.zone = zone;
        this.render = render;
        this.document = document;
        this.popoverComponentRef = null;
        // 可聚焦元素
        this.focusableElementsString = `a[href], area[href], input:not([disabled]):not([tabindex=\'-1\']),
     button:not([disabled]):not([tabindex=\'-1\']),select:not([disabled]):not([tabindex=\'-1\']),
     textarea:not([disabled]):not([tabindex=\'-1\']),
     iframe, object, embed, *[tabindex]:not([tabindex=\'-1\']), *[contenteditable=true]`;
        /**
         * tip组件配置
         */
        this.tipConfig = {
            trigger: 'manual',
            theme: 'white'
        };
    }
    ngOnInit() {
        if (!this.tiPopconfirm || !this.tiPopconfirm.content) {
            return;
        }
        this.hostElement = this.hostEleRef.nativeElement;
        // 创建实例
        this.tipInstance = this.tiTipService.create(this.hostElement, Object.assign(Object.assign({}, this.tipConfig), { position: this.tiPopconfirm.position, registerVisibilityChangeEvent: false }));
        this.addClickEvent();
    }
    ngOnDestroy() {
        if (this.tipInstance) {
            super.ngOnDestroy();
        }
        if (this.unlistenClick) {
            this.unlistenClick();
        }
        if (this.unListenDocumentKeydown) {
            this.unListenDocumentKeydown();
        }
    }
    addClickEvent() {
        this.zone.runOutsideAngular(() => {
            this.unlistenClick = this.render.listen(this.document, 'click', (event) => {
                if (this.hostElement.contains(event.target) && !this.popoverComponentRef) {
                    this.showPopandFocus();
                    return;
                }
                const tipElement = this.popoverComponentRef && this.popoverComponentRef.location.nativeElement;
                if (!(tipElement && tipElement.contains(event.target))) {
                    this.zone.run(() => {
                        this.hide();
                    });
                    this.popoverComponentRef = null;
                }
            });
            this.unListenDocumentKeydown = this.render.listen(document, 'keydown', (event) => {
                switch (event.which) {
                    case TiKeymap.KEY_TAB: // tab键用于处理在提示框内循环获取焦点
                        this.clickTab(event);
                        break;
                    case TiKeymap.KEY_ENTER:
                        if (this.hostElement.contains(event.target) && !this.popoverComponentRef) {
                            this.showPopandFocus();
                        }
                        break;
                    default:
                        break;
                }
            });
        });
    }
    clickTab(event) {
        const dialogModalEle = document.querySelector('.ti3-popconfirm-container');
        const focusableElements = dialogModalEle === null || dialogModalEle === void 0 ? void 0 : dialogModalEle.querySelectorAll(this.focusableElementsString);
        Util.focusInDialogOnTabchange(event, focusableElements);
    }
    /**
     * 打开气泡组件，并且把焦点转移到提示框内部，为后续把焦点限制在提示框内做准备。
     * @private
     */
    showPopandFocus() {
        this.zone.run(() => {
            this.popoverComponentRef = this.show();
            const popContainerEle = document.querySelector('.ti3-popconfirm-container');
            if (popContainerEle) {
                popContainerEle.focus();
            }
        });
    }
    /**
     * 显示气泡确认框
     * @ignore
     */
    show() {
        if (!this.tipInstance) {
            return;
        }
        const destroyPopover = (result) => {
            this.hide();
            if (result && Util.isFunction(this.tiPopconfirm.close)) {
                this.tiPopconfirm.close(this.data);
            }
            else if (!result && Util.isFunction(this.tiPopconfirm.dismiss)) {
                this.tiPopconfirm.dismiss(this.data);
            }
        };
        return this.tipInstance.show(TiPopconfirmComponent, {
            id: this.tiPopconfirm.id,
            config: this.tiPopconfirm,
            destroyPopover
        });
    }
}
TiPopconfirmDirective.decorators = [
    { type: Directive, args: [{
                selector: '[tiPopconfirm]'
            },] }
];
TiPopconfirmDirective.ctorParameters = () => [
    { type: TiTipService },
    { type: ElementRef },
    { type: NgZone },
    { type: Renderer2 },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
TiPopconfirmDirective.propDecorators = {
    tiPopconfirm: [{ type: Input }],
    data: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGlQb3Bjb25maXJtRGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vQGNsb3VkL3RpbnkzL2RpcmVjdGl2ZXMvcG9wY29uZmlybS9UaVBvcGNvbmZpcm1EaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFnQixTQUFTLEVBQUUsVUFBVSxFQUFnQixLQUFLLEVBQUUsTUFBTSxFQUFxQixTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZJLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUkzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDL0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUEwQ2xEOzs7Ozs7OztHQVFHO0FBSUgsTUFBTSxPQUFPLHFCQUFzQixTQUFRLGNBQWM7SUFvQnJELFlBQW9CLFlBQTBCLEVBQVUsVUFBc0IsRUFBVSxJQUFZLEVBQVUsTUFBaUIsRUFDekYsUUFBUTtRQUMxQyxLQUFLLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRmhCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ3pGLGFBQVEsR0FBUixRQUFRLENBQUE7UUFSdEMsd0JBQW1CLEdBQXNCLElBQUksQ0FBQztRQUVyRCxRQUFRO1FBQ0EsNEJBQXVCLEdBQVc7Ozt3RkFHeUMsQ0FBQztRQUtyRjs7V0FFRztRQUNLLGNBQVMsR0FBUTtZQUNyQixPQUFPLEVBQUUsUUFBUTtZ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QUM7UUFFRixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQ2hELEVBQUUsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDeEIsTUFBTSxFQUFFLElBQUksQ0FBQyxZQUFZO1lBQ3pCLGNBQWM7U0FDakIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7O1lBNUlKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsZ0JBQWdCO2FBQzdCOzs7WUF4RFEsWUFBWTtZQUxhLFVBQVU7WUFBdUIsTUFBTTtZQUFxQixTQUFTOzRDQW1GdEYsTUFBTSxTQUFDLFFBQVE7OzsyQkFqQjNCLEtBQUs7bUJBTUwsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBIb3N0TGlzdGVuZXIsIElucHV0LCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBSZW5kZXJlcjIsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcblxyXG5pbXBvcnQgeyBUaVBvc2l0aW9uVHlwZSB9IGZyb20gJy4uLy4uL3V0aWxzL1Bvc2l0aW9uJztcclxuaW1wb3J0IHsgVGlUaXBSZWYgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90aXAvVGlUaXBJbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBUaVRpcFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90aXAvVGlUaXBTZXJ2aWNlJztcclxuaW1wb3J0IHsgVGlUaXBEaXJlY3RpdmUgfSBmcm9tICcuLi8uLi9kaXJlY3RpdmVzL3RpcC9UaVRpcERpcmVjdGl2ZSc7XHJcbmltcG9ydCB7IFRpUG9wY29uZmlybUNvbXBvbmVudCB9IGZyb20gJy4vVGlQb3Bjb25maXJtQ29tcG9uZW50JztcclxuaW1wb3J0IHsgVXRpbCwgVGlLZXltYXAgfSBmcm9tICcuLi8uLi91dGlscy9VdGlsJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVGlQb3Bjb25maXJtQ29uZmlnIHtcclxuICAgIC8qKlxyXG4gICAgICog6K6+572u56Gu6K6k5qGGaWRcclxuICAgICAqL1xyXG4gICAgaWQ/OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruehruiupOahhuaPj+i/sOS/oeaBr1xyXG4gICAgICovXHJcbiAgICBjb250ZW50OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIOiHquWumuS5ieaYr+aMiemSruaWh+acrFxyXG4gICAgICovXHJcbiAgICB5ZXNUZXh0Pzogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiDoh6rlrprkuYnlkKbmjInpkq7mlofmnKxcclxuICAgICAqL1xyXG4gICAgbm9UZXh0Pzogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7mmK/mjInpkq7kuLrlvLrosIPmjInpkq5cclxuICAgICAqL1xyXG4gICAgeWVzUHJpbWFyeT86IGJvb2xlYW47XHJcbiAgICAvKipcclxuICAgICAqIOiuvue9ruehruiupOahhuW8ueWHuuaWueWQkVxyXG4gICAgICovXHJcbiAgICBwb3NpdGlvbj86IFRpUG9zaXRpb25UeXBlO1xyXG4gICAgLyoqXHJcbiAgICAgKiDop6blj5En5pivJ+aMiemSruS6i+S7tlxyXG4gICAgICovXHJcbiAgICBjbG9zZT8oZGF0YT86IGFueSk6IHZvaWQ7XHJcbiAgICAvKipcclxuICAgICAqIOinpuWPkSflkKYn5oyJ6ZKu5LqL5Lu2XHJcbiAgICAgKi9cclxuICAgIGRpc21pc3M/KGRhdGE/OiBhbnkpOiB2b2lkO1xyXG4gICAgLyoqXHJcbiAgICAgKiDlhYHorrjmnInlpJrkvZnnmoTlsZ7mgKflrZfmrrVcclxuICAgICAqL1xyXG4gICAgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnk7XHJcblxyXG59XHJcblxyXG4vKipcclxuICogVGlQb3Bjb25maXJtIOawlOazoeehruiupOahhuaMh+S7pFxyXG4gKlxyXG4gKiDkuIDoiKznlKjkuo7mk43kvZzmiafooYzlkI7lr7nnlKjmiLfkuJrliqHkuI3kvJrmnInkuKXph43lvbHlk43nmoTovbvph4/nuqflnLrmma/jgIJcclxuICpcclxuICogMTAuMC4zLzkuMC4354mI5pys5paw5aKeXHJcbiAqXHJcbiAqIDxleGFtcGxlLXVybD4uLi90aW55M2RlbW8vIy9wb3Bjb25maXJtL3BvcGNvbmZpcm0tYWxsPC9leGFtcGxlLXVybD5cclxuICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbdGlQb3Bjb25maXJtXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIFRpUG9wY29uZmlybURpcmVjdGl2ZSBleHRlbmRzIFRpVGlwRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gICAgLyoqXHJcbiAgICAgKiDmsJTms6Hnoa7orqTmoYbphY3nva7lr7nosaFcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgdGlQb3Bjb25maXJtOiBUaVBvcGNvbmZpcm1Db25maWc7XHJcbiAgICAvKipcclxuICAgICAqIDEwLjEuMeaWsOWinlxyXG4gICAgICpcclxuICAgICAqIOaVsOaNruaOpeWPo++8jCDluLjluLjnu5HlrprooajmoLzmnKzooYzmlbDmja7jgIJcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgZGF0YTogYW55O1xyXG4gICAgcHJvdGVjdGVkIHRpcEluc3RhbmNlOiBUaVRpcFJlZjtcclxuICAgIHByaXZhdGUgaG9zdEVsZW1lbnQ6IGFueTtcclxuICAgIHByaXZhdGUgcG9wb3ZlckNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPGFueT4gPSBudWxsO1xyXG4gICAgcHJpdmF0ZSB1bmxpc3RlbkNsaWNrOiAoKSA9PiB2b2lkO1xyXG4gICAgIC8vIOWPr+iBmueEpuWFg+e0oFxyXG4gICAgIHByaXZhdGUgZm9jdXNhYmxlRWxlbWVudHNTdHJpbmc6IHN0cmluZyA9IGBhW2hyZWZdLCBhcmVhW2hyZWZdLCBpbnB1dDpub3QoW2Rpc2FibGVkXSk6bm90KFt0YWJpbmRleD1cXCctMVxcJ10pLFxyXG4gICAgIGJ1dHRvbjpub3QoW2Rpc2FibGVkXSk6bm90KFt0YWJpbmRleD1cXCctMVxcJ10pLHNlbGVjdDpub3QoW2Rpc2FibGVkXSk6bm90KFt0YWJpbmRleD1cXCctMVxcJ10pLFxyXG4gICAgIHRleHRhcmVhOm5vdChbZGlzYWJsZWRdKTpub3QoW3RhYmluZGV4PVxcJy0xXFwnXSksXHJcbiAgICAgaWZyYW1lLCBvYmplY3QsIGVtYmVkLCAqW3RhYmluZGV4XTpub3QoW3RhYmluZGV4PVxcJy0xXFwnXSksICpbY29udGVudGVkaXRhYmxlPXRydWVdYDtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdGlUaXBTZXJ2aWNlOiBUaVRpcFNlcnZpY2UsIHByaXZhdGUgaG9zdEVsZVJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvY3VtZW50KSB7XHJcbiAgICAgICAgc3VwZXIodGlUaXBTZXJ2aWNlLCBob3N0RWxlUmVmKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogdGlw57uE5Lu26YWN572uXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgdGlwQ29uZmlnOiBhbnkgPSB7XHJcbiAgICAgICAgdHJpZ2dlcjogJ21hbnVhbCcsXHJcbiAgICAgICAgdGhlbWU6ICd3aGl0ZSdcclxuICAgIH07XHJcbiAgICBwcml2YXRlIHVuTGlzdGVuRG9jdW1lbnRLZXlkb3duOiAoKSA9PiB2b2lkO1xyXG5cclxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy50aVBvcGNvbmZpcm0gfHwgIXRoaXMudGlQb3Bjb25maXJtLmNvbnRlbnQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmhvc3RFbGVtZW50ID0gdGhpcy5ob3N0RWxlUmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgLy8g5Yib5bu65a6e5L6LXHJcbiAgICAgICAgdGhpcy50aXBJbnN0YW5jZSA9IHRoaXMudGlUaXBTZXJ2aWNlLmNyZWF0ZSh0aGlzLmhvc3RFbGVtZW50LCB7XHJcbiAgICAgICAgICAgIC4uLnRoaXMudGlwQ29uZmlnLFxyXG4gICAgICAgICAgICBwb3NpdGlvbjogdGhpcy50aVBvcGNvbmZpcm0ucG9zaXRpb24sXHJcbiAgICAgICAgICAgIHJlZ2lzdGVyVmlzaWJpbGl0eUNoYW5nZUV2ZW50OiBmYWxzZVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmFkZENsaWNrRXZlbnQoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy50aXBJbnN0YW5jZSkge1xyXG4gICAgICAgICAgICBzdXBlci5uZ09uRGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy51bmxpc3RlbkNsaWNrKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5saXN0ZW5DbGljaygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy51bkxpc3RlbkRvY3VtZW50S2V5ZG93bikge1xyXG4gICAgICAgICAgICB0aGlzLnVuTGlzdGVuRG9jdW1lbnRLZXlkb3duKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFkZENsaWNrRXZlbnQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy51bmxpc3RlbkNsaWNrID0gdGhpcy5yZW5kZXIubGlzdGVuKHRoaXMuZG9jdW1lbnQsICdjbGljaycsIChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaG9zdEVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0KSAmJiAhdGhpcy5wb3BvdmVyQ29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93UG9wYW5kRm9jdXMoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3QgdGlwRWxlbWVudDogYW55ID0gdGhpcy5wb3BvdmVyQ29tcG9uZW50UmVmICYmIHRoaXMucG9wb3ZlckNvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgaWYgKCEodGlwRWxlbWVudCAmJiB0aXBFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wb3ZlckNvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy51bkxpc3RlbkRvY3VtZW50S2V5ZG93biA9IHRoaXMucmVuZGVyLmxpc3Rlbihkb2N1bWVudCwgJ2tleWRvd24nLCAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnQud2hpY2gpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIFRpS2V5bWFwLktFWV9UQUI6IC8vIHRhYumUrueUqOS6juWkhOeQhuWcqOaPkOekuuahhuWGheW+queOr+iOt+WPlueEpueCuVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsaWNrVGFiKGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBUaUtleW1hcC5LRVlfRU5URVI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmhvc3RFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgJiYgIXRoaXMucG9wb3ZlckNvbXBvbmVudFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93UG9wYW5kRm9jdXMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbGlja1RhYihldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGRpYWxvZ01vZGFsRWxlOiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50aTMtcG9wY29uZmlybS1jb250YWluZXInKTtcclxuICAgICAgICBjb25zdCBmb2N1c2FibGVFbGVtZW50czogTm9kZUxpc3QgPSBkaWFsb2dNb2RhbEVsZT8ucXVlcnlTZWxlY3RvckFsbCh0aGlzLmZvY3VzYWJsZUVsZW1lbnRzU3RyaW5nKTtcclxuICAgICAgICBVdGlsLmZvY3VzSW5EaWFsb2dPblRhYmNoYW5nZShldmVudCwgZm9jdXNhYmxlRWxlbWVudHMpO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDmiZPlvIDmsJTms6Hnu4Tku7bvvIzlubbkuJTmiornhKbngrnovaznp7vliLDmj5DnpLrmoYblhoXpg6jvvIzkuLrlkI7nu63miornhKbngrnpmZDliLblnKjmj5DnpLrmoYblhoXlgZrlh4blpIfjgIJcclxuICAgICAqIEBwcml2YXRlXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc2hvd1BvcGFuZEZvY3VzKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnBvcG92ZXJDb21wb25lbnRSZWYgPSB0aGlzLnNob3coKTtcclxuICAgICAgICAgICAgY29uc3QgcG9wQ29udGFpbmVyRWxlOiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50aTMtcG9wY29uZmlybS1jb250YWluZXInKTtcclxuICAgICAgICAgICAgaWYgKHBvcENvbnRhaW5lckVsZSkge1xyXG4gICAgICAgICAgICAgICAgcG9wQ29udGFpbmVyRWxlLmZvY3VzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOaYvuekuuawlOazoeehruiupOahhlxyXG4gICAgICogQGlnbm9yZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2hvdygpOiBDb21wb25lbnRSZWY8YW55PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRpcEluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGVzdHJveVBvcG92ZXI6IChyZXN1bHQ/OiBib29sZWFuKSA9PiB2b2lkID0gKHJlc3VsdD86IGJvb2xlYW4pOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgVXRpbC5pc0Z1bmN0aW9uKHRoaXMudGlQb3Bjb25maXJtLmNsb3NlKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50aVBvcGNvbmZpcm0uY2xvc2UodGhpcy5kYXRhKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghcmVzdWx0ICYmIFV0aWwuaXNGdW5jdGlvbih0aGlzLnRpUG9wY29uZmlybS5kaXNtaXNzKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50aVBvcGNvbmZpcm0uZGlzbWlzcyh0aGlzLmRhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMudGlwSW5zdGFuY2Uuc2hvdyhUaVBvcGNvbmZpcm1Db21wb25lbnQsIHtcclxuICAgICAgICAgICAgaWQ6IHRoaXMudGlQb3Bjb25maXJtLmlkLFxyXG4gICAgICAgICAgICBjb25maWc6IHRoaXMudGlQb3Bjb25maXJtLFxyXG4gICAgICAgICAgICBkZXN0cm95UG9wb3ZlclxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==