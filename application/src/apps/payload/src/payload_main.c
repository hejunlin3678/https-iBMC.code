
#include <time.h>
#include <stdio.h>
#include <stdbool.h>
#include "pme/pme.h"
#include "pme_app/pme_app.h"
#include "pme_app/uip/ipmc_public.h"
#include "payload_hs.h"
#include "payload_pwr.h"
#include "payload_com.h"
#include "payload_ipmi.h"
#include "wdt2.h"
#include "wdt2_dump.h"
#include "wdt2_ipmi.h"
#include "payload_storage.h"


LOCAL gint32 reboot_request_process(REBOOT_CTRL ctrl)
{
    dal_common_reboot_request_process(ctrl);

    return RET_OK;
}


LOCAL gint32 add_object_callback(const gchar *class_name, OBJ_HANDLE object_handle)
{
    if (NULL == class_name) {
        return RET_ERR;
    }

    if (RET_OK == strcmp(class_name, CLASS_HOTSWAP)) {
        (void)update_hotswap_fix_flag();
    }

    return RET_OK;
}


LOCAL gint32 add_object_complete_callback(guint32 position)
{
    return RET_OK;
}


LOCAL gint32 del_object_callback(const gchar *class_name, OBJ_HANDLE object_handle)
{
    if (strcmp(class_name, CLASS_HOTSWAP) == RET_OK) {
        (void)update_hotswap_fix_flag();
    }

    return 0;
}


LOCAL gint32 del_object_complete_callback(guint32 position)
{
    return RET_OK;
}


BEGIN_MODULE_DECLARATION(PAYLOAD_MODULE_NAME)


DECLARATION_CLASS(CLASS_HOTSWAP)
DECLARATION_CLASS(CLASS_FRUPAYLOAD)
DECLARATION_CLASS(CLASS_PAYLOAD)
DECLARATION_CLASS(CLASS_WATCHDOG)
DECLARATION_CLASS(CLASS_NAME_STOR_PAYLOAD)


DECLARATION_CLASS(CLASS_POWER_ON_CRITERIA)

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_PWR_ON, pp_method_pwr_on_ext)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_PWR_OFF, pp_method_pwr_off)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_FORCE_PWR_OFF, pp_method_force_pwr_off)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_PWR_CYCLE, pp_method_pwr_cycle)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_HARD_RESET, pp_method_pwr_hard_reset)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_HARD_RESET_WITH_PARA, pp_method_pwr_hard_reset)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_DIAG_INTR, pp_method_chassis_diag_interrupt)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SOFT_PWR_OFF, pp_method_soft_off)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_REST_POLICY, pp_method_set_pwr_restore_policy)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_POWER_ON_STRATEGY_EXCEPTIONS,
    pp_method_set_power_on_strategy_exceptions)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_EXE_PWR_REST_POLICY, pp_method_exe_pwr_restore_policy)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_PS_ON_LOCK_CLEAR, pp_method_poweronlock_clear)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_CYCLE_INTER, pp_method_set_pwr_cycle_interval)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_OFF_TM, pp_method_set_pwr_off_timeout)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_OFF_TM_EN, pp_method_set_pwr_off_timeout_en)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_POWERSTATE_AFTER_BMC_RESET, pp_set_powerstate_after_bmc_reset)

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_HOST_START, pp_set_host_start)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_BTN_LOCK, pp_set_pwr_button_lock)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_GET_PWR_BTN_LOCK, pp_get_pwr_button_lock)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_CTRL, pp_method_set_pwr_ctrl)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_FRU_ACTIVE, pp_method_fru_active)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_LEVEL, pp_method_set_pwr_level)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_FORBID_POWERON_FLAG, pp_method_set_forbid_poweron_flag)

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_BOARD_POWERDROP_FLAG, pp_method_set_board_powerdrop_flag)

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_PAYLOAD_CLEAR_RESTART_VALUE, pp_method_clear_restart_value)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_DELAY_MODE, pp_method_set_pwrdelay_mode)
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_PWR_DELAY_COUNT, pp_method_set_pwrdelay_count)

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_DFT_RESET_OS_TEST, pp_method_dft_reset_os);

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_THERMAL_TRIP_POWERPOLICY, pp_method_set_thermal_trip_power_policy);
DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_SET_THERMAL_TRIP_TIMEDELAY, pp_method_set_thermal_trip_time_delay);

DECLARATION_CLASS_METHOD(CLASS_FRUPAYLOAD, METHOD_POWER_CYCLE, pp_method_power_cycle)
DECLARATION_CLASS_METHOD(CLASS_FRUPAYLOAD, METHOD_COLD_RESET, pp_method_cold_reset)
DECLARATION_CLASS_METHOD(CLASS_FRUPAYLOAD, METHOD_WARM_RESET, pp_method_warm_reset)
DECLARATION_CLASS_METHOD(CLASS_FRUPAYLOAD, METHOD_FRU_DIAG_INTR, pp_method_fru_diag_interrupt)
DECLARATION_CLASS_METHOD(CLASS_FRUPAYLOAD, METHOD_GRACE_REBOOT, pp_method_graceful_reboot)
DECLARATION_CLASS_METHOD(CLASS_FRUPAYLOAD, METHOD_FRU_CONTROL, pp_method_fru_control)
DECLARATION_CLASS_METHOD(CLASS_NAME_STOR_PAYLOAD, METHOD_HANDLE_BIOS_PWROFF_CMD, pp_bios_pwroff_handler)
DECLARATION_CLASS_METHOD(CLASS_NAME_STOR_PAYLOAD, METHOD_GET_PWROFF_FLAG, pp_method_get_pwroff_flag)

DECLARATION_CLASS_METHOD(CLASS_WATCHDOG, METHOD_SET_WATCHDOG, wdt_set_timer_method)

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_PAYLOAD_AC_CYCLE, pp_method_ac_cycle)

DECLARATION_CLASS_METHOD(CLASS_PAYLOAD, METHOD_PAYLOAD_PWR_RESTORE_DONE_FLAG, pwr_restore_action_done_method)


DECLARATION_REBOOT_PROCESS(reboot_request_process)


ON_ADD_OBJECT(add_object_callback)

ON_ADD_OBJECT_COMPLETE(add_object_complete_callback)

ON_DEL_OBJECT(del_object_callback)
ON_DEL_OBJECT_COMPLETE(del_object_complete_callback)


// ON_DUMP(bmc_dump_info)


ON_CLASS_PROPERTY_EVENT(CLASS_NAME_PERIPHERAL_COMPOSITION, PROPERTY_PERIPHERAL_COMPOSITION_TOPO_CFG_STATUS,
    config_composition_forbid_power_on_status, NULL)
ON_CLASS_PROPERTY_EVENT(CLASS_CHASSISPAYLOAD, PROPERTY_PAYLOAD_CHASSPWR_STATE, set_chassis_last_power_event, NULL)

ON_CLASS_PROPERTY_EVENT(CLASS_CHASSISPAYLOAD, PROPERTY_PAYLOAD_ACPI_STATUS, pp_apci_status_change_proc, NULL)


ON_CLASS_PROPERTY_EVENT(CLASS_WATCHDOG, PROPERTY_IS_IPC_COMM_NORMAL, set_ipc_check_value, NULL)

END_MODULE_DECLARATION()


BEGIN_IPMI_COMMAND()
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x0A, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_POWERMGNT, 4,
    4, pp_ipmi_cmd_set_fru_activation_policy, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x0B, "", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY, 2, 2,
    pp_ipmi_cmd_get_fru_activation_policy, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_INTERAL_COMMAND, "data[3]=6Bh,data[4]=00h",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_BASICSETTING, 0x07, 0x07,
    pp_ipmi_cmd_set_watch_dog_status, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x0C, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_POWERMGNT, 3,
    3, pp_ipmi_cmd_set_fru_activation, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x06, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_POWERMGNT,
    1, 1, pp_ipmi_cmd_set_pwr_restore_policy, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x0B, "", RMCP_ADMIN | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_POWERMGNT, 1,
    1, pp_ipmi_cmd_set_pwr_cycle_interval, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x07, "", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY, 0, 0,
    pp_ipmi_cmd_get_sys_restart_cause, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x92, "data[3]=11h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY,
    5, 5, pp_ipmi_oem_get_sys_restart_cause, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x02, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_POWERMGNT,
    1, 1, pp_ipmi_cmd_chassis_ctrl, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x04, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_POWERMGNT, 3,
    3, pp_ipmi_cmd_fru_ctrl, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x08, "data[0]=62h", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_POWERMGNT, 3, 3, pp_ipmi_cmd_set_power_off_timeout, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x08, "data[0]=65h", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_POWERMGNT, 9, 9, pp_ipmi_cmd_set_power_on_delay, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x09, "data[0]=62h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 3, 3, pp_ipmi_cmd_get_power_off_timeout, NULL)
ADD_IPMI_COMMAND_V2(NETFN_CHASSIS_REQ, 0x09, "data[0]=65h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 3, 3, pp_ipmi_cmd_get_power_on_delay, NULL)
// wdt2
ADD_IPMI_COMMAND_V2(NETFN_APP_REQ, 0x22, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_POWERMGNT, 0, 0,
    wdt_ipmi_reset_timer, NULL)
ADD_IPMI_COMMAND_V2(NETFN_APP_REQ, 0x24, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_POWERMGNT, 6, 6,
    wdt_ipmi_set_timer, NULL)
ADD_IPMI_COMMAND_V2(NETFN_APP_REQ, 0x25, "", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY, 0, 0,
    wdt_ipmi_get_timer, NULL)

ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x11, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_POWERMGNT, 4,
    4, pp_set_power_level, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x12, "", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY, 3, 3,
    pp_get_power_level, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PANGEA_OEM, 0x4b, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 6, 6, handle_sys_power_off_ipmi, NULL)


ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x97, "data[3]=15h", RMCP_USER | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_POWERMGNT, 5, 5, ipmi_set_aclost_status, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x97, "data[3]=16h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY,
    4, 4, ipmi_get_aclost_status, NULL)


ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_INTERAL_COMMAND, "data[3]=5ah,data[4]=0ah,data[5]=00h", RMCP_OPERATOR |
    IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_POWERMGNT, 0x0b, 0x0b, ipmi_cmd_set_pwrbutton_shield_state, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_INTERAL_COMMAND, "data[3]=5bh,data[4]=0ah,data[5]=00h", RMCP_USER |
    IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY, 0x0a, 0x0a, ipmi_cmd_get_pwrbutton_shield_state, NULL)

ADD_IPMI_COMMAND_V2(NETFN_PANGEA_OEM, 0x6b, "data[1]=02h,data[2]=00h", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_BASICSETTING, 0x06, 0x06, ipmi_set_board_mode, NULL)
END_IPMI_COMMAND()


BEGIN_DEUBG_COMMAND()
ADD_DEBUG_COMMAND("hsdump", hs_dump_cmd, "", "Usage: hsdump\nDump hotswap info.\n")
ADD_DEBUG_COMMAND("ppdump", pp_dump_cmd, "", "Usage: ppdump\nDump payload power info.\n")
ADD_DEBUG_COMMAND("wdump", wdt_dump_info, "", "Usage: wdump\nDump ipmi watchdog2 info.\n")
ADD_DEBUG_COMMAND("debug_ipc", set_ipc_debug_flag, "y",
    "Usage: debug_ipc <0 | 1>\n0:Set the IPC channel to normal\n1:Set the IPC chananel to abnormal\n")
END_DEBUG_COMMAND()


BEGIN_MODULE_MAIN()
#ifdef ITEST
iTest_Init(argc, argv);
#endif

MODULE_ORDER_INIT(1, payload_init)
MODULE_START(payload_start)
#ifdef ITEST
start_tshell_main(argc, argv);
#endif
END_MODULE_MAIN()
