
#include "pme/pme.h"
#include "pme_app/pme_app.h"
#include "pme_app/uip/ipmc_public.h"
#include "module_mgnt.h"
#include "msg_handle.h"
#include "intf/dump.h"
#include "intf/adapter.h"
#include "intf/event.h"
#include "intf/ipmi.h"
#include "pme_app/uip/ipmc_public.h"
#include "intf/oem_ipmi.h"
#include "media/port_rate.h"



BEGIN_MODULE_DECLARATION(FRU_DATA_APP_NAME)

DECLARATION_CLASS(CLASS_FRU)
DECLARATION_CLASS(CLASS_FRUDEV)
DECLARATION_CLASS(CLASS_ELABEL)
DECLARATION_CLASS(CLASS_FRU_STATICS)
DECLARATION_CLASS(CLASS_CHIP_SUBCLASS_EEPROM)
DECLARATION_CLASS(CLASS_COMPONENT)
DECLARATION_CLASS(CLASS_PCIE_ROOT_PORT_MAP)
DECLARATION_CLASS(CLASS_NAME_RAW_EEPROM_DEV)
DECLARATION_CLASS(CLASS_CAFE_DEV)
DECLARATION_CLASS(CLASS_SHARE_FRUDEV)
DECLARATION_CLASS(CLASS_DOUBLE_EEPROM_FRUDEV)


DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_FRU_SET_MEZZ_MACADDR, method_fru_set_mezzcard_macaddr)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_UPDATE_FRU_ELABEL_INFO, method_fru_elabel_syn_elable)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_FRU_INIT_FRU_INFO_FROM_MCU, method_fru_init_from_mcu)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_UPDATE_FRU_PCB_VERSION, method_ocp_fru_set_pcb_ver)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_E2PSTATUS_SYNC, property_sync_common_handler)
DECLARATION_CLASS_METHOD(CLASS_FRU_STATICS, METHOD_SET_VERSION_CHANGE, method_set_ver_change)
DECLARATION_CLASS_METHOD(CLASS_FRU_STATICS, METHOD_FRU_UPDATE_MAINBOARD_SLOT_ID, method_update_mainboard_fru_slot_id)
DECLARATION_CLASS_METHOD(CLASS_COMPONENT, METHOD_COMPONENT_SET_HEALTH, method_component_set_health)
DECLARATION_CLASS_METHOD(CLASS_COMPONENT, METHOD_COMPONENT_UPDATE_DEVICENAME, method_update_comp_dev_name)
DECLARATION_CLASS_METHOD(CLASS_ELABEL, METHOD_SET_PRODUCT_ASSETTAG, method_elabel_set_product_assettag)
DECLARATION_CLASS_METHOD(CLASS_CAFE_DEV, METHOD_CAFEDEV_READ_CAFE_RECORD, method_read_cafe_record)
DECLARATION_CLASS_METHOD(CLASS_CAFE_DEV, METHOD_CAFEDEV_WRITE_CAFE_RECORD, method_write_cafe_record)
DECLARATION_CLASS_METHOD(CLASS_ELABEL, METHOD_ELABEL_PROPERTY_SYNC, method_elabel_property_sync)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_FRU_SET_EEPROM_DATA, method_fru_set_eeprom_data)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_FRU_GET_EEPROM_DATA, method_fru_get_eeprom_data)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_FRU_SET_EEPROM_RAW_DATA, method_fru_set_eeprom_raw_data)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_SET_CANBUS_DEV_EEPROM_DATA, method_set_canbus_dev_eeprom_data)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_GET_CANBUS_DEV_EEPROM_DATA, method_get_canbus_dev_eeprom_data)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_FRU_STOP_SHARED_CPLD_SCAN, method_fru_stop_shared_cpld_scan)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_STOP_EEP_ROUTINE, method_set_eep_stop_routine_flag)
DECLARATION_CLASS_METHOD(CLASS_FRU, METHOD_FRU_SET_CPLD_STATUS_FAIL, method_set_cpld_status_to_fail)
DECLARATION_CLASS_METHOD(CLASS_CHIP_SUBCLASS_EEPROM, METHOD_SET_EEPROM_STATUS, method_set_eeprom_status)
DECLARATION_CLASS_METHOD(CLASS_CHIP_SUBCLASS_EEPROM, METHOD_EEP_SYNC_TEMPORARY, property_sync_save_temporary_handler)



DECLARATION_REBOOT_PROCESS(reboot_request_process)


ON_ADD_OBJECT(add_object_callback)
ON_ADD_OBJECT_COMPLETE(add_object_complete_callback)

ON_DEL_OBJECT(del_object_callback)
ON_DEL_OBJECT_COMPLETE(del_object_complete_callback)


ON_DUMP(dump_frudata_info)

ON_CLASS_PROPERTY_EVENT(CLASS_PERIPHERAL_ELABEL, PROPERTY_ELABEL_PRODUCT_SN, event_renew_product_sn_elabel, NULL)
ON_CLASS_PROPERTY_EVENT(CLASS_PERIPHERAL_ELABEL, PROPERTY_ELABEL_PRODUCT_ASSET_TAG, event_renew_product_assettag_elabel,
    NULL)
ON_CLASS_PROPERTY_EVENT(CLASS_NAME_IPMBADDR, IPMBADDR_PROPERTY_SA, event_update_fru_ipmbaddr, NULL)
ON_CLASS_PROPERTY_EVENT(CLASS_SDR_DEV, PROPERTY_SDR_TYPE12_RECID, event_update_fru_locator_record_id, NULL)
ON_CLASS_PROPERTY_EVENT(CLASS_HDD_NAME, PROPERTY_HDD_ID, event_update_hdd_component, NULL)
ON_CLASS_PROPERTY_EVENT(ASM_CLASS_NAME, PROPERTY_ASM_AS_STATUS, event_process_as_status_change, NULL)
ON_CLASS_PROPERTY_EVENT(CLASS_CHASSISPAYLOAD, PROPERTY_PAYLOAD_CHASSPWR_STATE, payload_set_eeprom_key_info, NULL)

END_MODULE_DECLARATION()


BEGIN_IPMI_COMMAND()
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x94, "data[3]=1Ch", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_READONLY,
    0x07, 0x07, ipmi_get_blade_info_parameters, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x94, "data[3]=1Dh", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_BASICSETTING, 0xFF, 0x08, ipmi_set_blade_info_parameters, NULL)
ADD_IPMI_COMMAND_V2(NETFN_STORAGE_REQ, IPMI_READ_FRU_DATA, "", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x04, 0x04, ipmi_read_frudata, NULL)
ADD_IPMI_COMMAND_V2(NETFN_STORAGE_REQ, IPMI_WRITE_FRU_DATA, "", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_BASICSETTING, 0xff, 0x07, ipmi_write_frudata, NULL)
ADD_IPMI_COMMAND_V2(NETFN_STORAGE_REQ, IPMI_GET_FRU_INVENTORY_AREA_INFO, "", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x01, 0x01, ipmi_get_fru_inventory, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=03h", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_BASICSETTING, 0x03, 0x03, ipmi_dft_clear_elabel, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=04h", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_BASICSETTING, 0xff, 0x06, ipmi_dft_write_elabel, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_INTERAL_COMMAND, "data[3]=3bh", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x0b, 0x0b, ipmi_oem_get_fruid_info, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_INTERAL_COMMAND, "data[3]=6dh", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x1e, 0x1a, ipmi_oem_get_fruid_info_from_uid, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=05h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x06, 0x06, ipmi_dft_read_elabel, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=06h", RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID,
    PROPERTY_USERROLE_BASICSETTING, 0x03, 0x03, ipmi_dft_update_elabel, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x94, "data[3]=30h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x08, 0x08, ipmi_get_shelf_info, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x94, "data[3]=31h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x49, 0x09, ipmi_set_shelf_info, NULL)


ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x90, "data[0]=67h,data[1]=01h,data[2]=00h,data[4]=0dh",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_BASICSETTING, 0x09, 0x09, dft_get_huawei_formate_elabel,
    NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=21h,data[1]=4h",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_BASICSETTING, 0x03, 0x03, ipmi_dft_custom, NULL)

ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=59h,data[1]=4h",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_BASICSETTING, 0x04, 0x04, ipmi_get_dft_custom_cmd, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=3fh", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x20, 0x03, ipmi_dft_get_component_pos, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, 0x91, "data[3]=12h,data[5]=03h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x06, 0x06, ipmi_dft_get_comp_present, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x10, "data[0]=00h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x02, 0x02, ipmi_compute_power_properties, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x01, "data[0]=00h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x05, 0x01, ipmi_get_addr_info, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x0d, "data[0]=00h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x02, 0x02, ipmi_get_device_locator_record_id, NULL)
ADD_IPMI_COMMAND_V2(NETFN_PICMG_REQ, 0x1e, "data[0]=00h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x02, 0x02, ipmi_fru_control_capabilities, NULL)
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_INTERAL_COMMAND, "data[3]=27h", RMCP_USER | IPMI_SYS_LOCKDOWN_ALLOW,
    PROPERTY_USERROLE_READONLY, 0x09, 0x09, ipmi_get_device_info, NULL)

ADD_IPMI_COMMAND_V2(NETFN_PANGEA_OEM, 0xbb, "data[1]=02h,data[2]=00h,data[4]=59h",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_BASICSETTING, 0xff, 0x04, ipmi_get_board_port_speed,
    NULL)
ADD_IPMI_COMMAND_V2(NETFN_PANGEA_OEM, 0xbc, "data[1]=02h,data[2]=00h,data[4]=59h",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_BASICSETTING, 0xff, 0x04, ipmi_set_board_port_speed,
    NULL)
#ifdef DFT_ENABLED

ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=21h,data[1]=0Ah",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_BASICSETTING, 0x09, 0x04, ipmi_cmd_set_scan_status,
    NULL)

ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_DFT_COMMAND, "data[0]=59h,data[1]=0Ah",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_FORBID, PROPERTY_USERROLE_BASICSETTING, 0x09, 0x03, ipmi_cmd_get_scan_status,
    NULL)
#endif
ADD_IPMI_COMMAND_V2(NETFN_OEM_REQ, IPMI_OEM_INTERAL_COMMAND, "data[3]=3Ch,data[4]=10h,data[5]=25h",
    RMCP_OPERATOR | IPMI_SYS_LOCKDOWN_ALLOW, PROPERTY_USERROLE_BASICSETTING, 14, 14, ipmi_set_k_device_type, NULL)
END_IPMI_COMMAND()


BEGIN_DEUBG_COMMAND()
// ADD_DEBUG_COMMAND("test1", NULL, "test1 command description")
// ADD_DEBUG_COMMAND("test2", test2_cmd, "test2 command description")
END_DEBUG_COMMAND()


BEGIN_MODULE_MAIN()
#ifdef ITEST
iTest_Init(argc, argv);
#endif

MODULE_INIT(frudata_init)
MODULE_START(frudata_start)
#ifdef ITEST
start_tshell_main(argc, argv);
#endif
END_MODULE_MAIN()
